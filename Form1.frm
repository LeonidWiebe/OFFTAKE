VERSION 5.00
Object = "{0AFE7BE0-11B7-4A3E-978D-D4501E9A57FE}#1.0#0"; "c1sizer.ocx"
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{BF706EDD-8D7E-45A0-8135-775F7AA536A3}#1.1#0"; "Rein2D.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "Mscomctl.ocx"
Begin VB.Form F1 
   Caption         =   "Offtake II"
   ClientHeight    =   10830
   ClientLeft      =   5865
   ClientTop       =   3855
   ClientWidth     =   18000
   FillColor       =   &H8000000F&
   Icon            =   "Form1.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   10830
   ScaleWidth      =   18000
   Begin MSComctlLib.ImageList ImageList5 
      Left            =   3360
      Top             =   10440
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   22
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":030A
            Key             =   "project"
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":0BE4
            Key             =   "building"
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":3E36
            Key             =   "folder"
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":7088
            Key             =   "island1"
         EndProperty
         BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":73DA
            Key             =   "block1"
         EndProperty
         BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":76F4
            Key             =   "island"
         EndProperty
         BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":A946
            Key             =   "block"
         EndProperty
         BeginProperty ListImage8 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":DB98
            Key             =   "folder_open"
         EndProperty
         BeginProperty ListImage9 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":E132
            Key             =   "room"
         EndProperty
         BeginProperty ListImage10 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":E6CC
            Key             =   "room_level"
         EndProperty
         BeginProperty ListImage11 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":EC66
            Key             =   "room_folder"
         EndProperty
         BeginProperty ListImage12 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":11EB8
            Key             =   "aecosim"
         EndProperty
         BeginProperty ListImage13 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1220A
            Key             =   "aecosim_model"
         EndProperty
         BeginProperty ListImage14 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1255C
            Key             =   "empty"
         EndProperty
         BeginProperty ListImage15 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":12AAE
            Key             =   "noelem"
         EndProperty
         BeginProperty ListImage16 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":12DC8
            Key             =   "elem_1"
         EndProperty
         BeginProperty ListImage17 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":130E2
            Key             =   "exelem"
         EndProperty
         BeginProperty ListImage18 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":133FC
            Key             =   "folder_out"
         EndProperty
         BeginProperty ListImage19 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":13996
            Key             =   "folder_inc"
         EndProperty
         BeginProperty ListImage20 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":13F30
            Key             =   "elem_out"
         EndProperty
         BeginProperty ListImage21 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1424A
            Key             =   "elem_0"
         EndProperty
         BeginProperty ListImage22 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":14564
            Key             =   "elem_inc"
         EndProperty
      EndProperty
   End
   Begin C1SizerLibCtl.C1Elastic elMain 
      Height          =   10290
      Left            =   0
      TabIndex        =   2
      TabStop         =   0   'False
      Top             =   0
      Width           =   18000
      _cx             =   31750
      _cy             =   18150
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   204
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Enabled         =   -1  'True
      Appearance      =   4
      MousePointer    =   0
      Version         =   801
      BackColor       =   -2147483633
      ForeColor       =   -2147483630
      FloodColor      =   6553600
      ForeColorDisabled=   -2147483631
      Caption         =   ""
      Align           =   5
      AutoSizeChildren=   2
      BorderWidth     =   6
      ChildSpacing    =   4
      Splitter        =   -1  'True
      FloodDirection  =   0
      FloodPercent    =   0
      CaptionPos      =   1
      WordWrap        =   -1  'True
      MaxChildSize    =   0
      MinChildSize    =   0
      TagWidth        =   0
      TagPosition     =   0
      Style           =   0
      TagSplit        =   2
      PicturePos      =   4
      CaptionStyle    =   0
      ResizeFonts     =   0   'False
      GridRows        =   0
      GridCols        =   0
      Frame           =   3
      FrameStyle      =   0
      FrameWidth      =   1
      FrameColor      =   -2147483628
      FrameShadow     =   -2147483632
      FloodStyle      =   1
      _GridInfo       =   ""
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   9
      Begin C1SizerLibCtl.C1Elastic elExt 
         Height          =   10110
         Left            =   13365
         TabIndex        =   14
         TabStop         =   0   'False
         Top             =   90
         Width           =   4545
         _cx             =   8017
         _cy             =   17833
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   204
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Enabled         =   -1  'True
         Appearance      =   5
         MousePointer    =   0
         Version         =   801
         BackColor       =   -2147483633
         ForeColor       =   -2147483630
         FloodColor      =   6553600
         ForeColorDisabled=   -2147483631
         Caption         =   ""
         Align           =   0
         AutoSizeChildren=   3
         BorderWidth     =   6
         ChildSpacing    =   4
         Splitter        =   -1  'True
         FloodDirection  =   0
         FloodPercent    =   0
         CaptionPos      =   1
         WordWrap        =   -1  'True
         MaxChildSize    =   0
         MinChildSize    =   0
         TagWidth        =   0
         TagPosition     =   0
         Style           =   0
         TagSplit        =   2
         PicturePos      =   4
         CaptionStyle    =   0
         ResizeFonts     =   0   'False
         GridRows        =   0
         GridCols        =   0
         Frame           =   3
         FrameStyle      =   0
         FrameWidth      =   1
         FrameColor      =   -2147483628
         FrameShadow     =   -2147483632
         FloodStyle      =   1
         _GridInfo       =   ""
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   9
         Begin C1SizerLibCtl.C1Elastic Picture1 
            Height          =   4935
            Left            =   90
            TabIndex        =   89
            TabStop         =   0   'False
            Top             =   5085
            Width           =   4365
            _cx             =   7699
            _cy             =   8705
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   204
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Enabled         =   -1  'True
            Appearance      =   4
            MousePointer    =   0
            Version         =   801
            BackColor       =   -2147483633
            ForeColor       =   -2147483630
            FloodColor      =   6553600
            ForeColorDisabled=   -2147483631
            Caption         =   ""
            Align           =   0
            AutoSizeChildren=   0
            BorderWidth     =   6
            ChildSpacing    =   4
            Splitter        =   0   'False
            FloodDirection  =   0
            FloodPercent    =   0
            CaptionPos      =   1
            WordWrap        =   -1  'True
            MaxChildSize    =   0
            MinChildSize    =   0
            TagWidth        =   0
            TagPosition     =   0
            Style           =   0
            TagSplit        =   2
            PicturePos      =   4
            CaptionStyle    =   0
            ResizeFonts     =   0   'False
            GridRows        =   0
            GridCols        =   0
            Frame           =   3
            FrameStyle      =   0
            FrameWidth      =   1
            FrameColor      =   -2147483628
            FrameShadow     =   -2147483632
            FloodStyle      =   1
            _GridInfo       =   ""
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   9
            Begin VSFlex8Ctl.VSFlexGrid fgCatFiles 
               Height          =   4455
               Left            =   1800
               TabIndex        =   90
               Top             =   2400
               Visible         =   0   'False
               Width           =   5400
               _cx             =   9525
               _cy             =   7858
               Appearance      =   1
               BorderStyle     =   1
               Enabled         =   -1  'True
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               MousePointer    =   0
               BackColor       =   -2147483643
               ForeColor       =   -2147483640
               BackColorFixed  =   -2147483633
               ForeColorFixed  =   -2147483630
               BackColorSel    =   -2147483635
               ForeColorSel    =   -2147483634
               BackColorBkg    =   -2147483636
               BackColorAlternate=   -2147483643
               GridColor       =   -2147483633
               GridColorFixed  =   -2147483632
               TreeColor       =   -2147483632
               FloodColor      =   192
               SheetBorder     =   -2147483642
               FocusRect       =   0
               HighLight       =   1
               AllowSelection  =   -1  'True
               AllowBigSelection=   -1  'True
               AllowUserResizing=   0
               SelectionMode   =   3
               GridLines       =   1
               GridLinesFixed  =   2
               GridLineWidth   =   1
               Rows            =   1
               Cols            =   6
               FixedRows       =   1
               FixedCols       =   0
               RowHeightMin    =   0
               RowHeightMax    =   0
               ColWidthMin     =   0
               ColWidthMax     =   0
               ExtendLastCol   =   -1  'True
               FormatString    =   ""
               ScrollTrack     =   -1  'True
               ScrollBars      =   2
               ScrollTips      =   -1  'True
               MergeCells      =   3
               MergeCompare    =   0
               AutoResize      =   -1  'True
               AutoSizeMode    =   0
               AutoSearch      =   0
               AutoSearchDelay =   2
               MultiTotals     =   -1  'True
               SubtotalPosition=   1
               OutlineBar      =   0
               OutlineCol      =   0
               Ellipsis        =   0
               ExplorerBar     =   0
               PicturesOver    =   0   'False
               FillStyle       =   0
               RightToLeft     =   0   'False
               PictureType     =   0
               TabBehavior     =   0
               OwnerDraw       =   0
               Editable        =   0
               ShowComboButton =   1
               WordWrap        =   -1  'True
               TextStyle       =   0
               TextStyleFixed  =   0
               OleDragMode     =   0
               OleDropMode     =   1
               DataMode        =   0
               VirtualData     =   -1  'True
               DataMember      =   ""
               ComboSearch     =   3
               AutoSizeMouse   =   -1  'True
               FrozenRows      =   0
               FrozenCols      =   0
               AllowUserFreezing=   0
               BackColorFrozen =   0
               ForeColorFrozen =   0
               WallPaperAlignment=   9
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   24
            End
         End
         Begin VSFlex8Ctl.VSFlexGrid fgOps 
            Height          =   4935
            Left            =   90
            TabIndex        =   43
            Top             =   90
            Width           =   4365
            _cx             =   7699
            _cy             =   8705
            Appearance      =   2
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   204
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483635
            ForeColorSel    =   -2147483634
            BackColorBkg    =   -2147483633
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483633
            FocusRect       =   0
            HighLight       =   0
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   0
            Cols            =   10
            FixedRows       =   0
            FixedCols       =   0
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   -1  'True
            FormatString    =   ""
            ScrollTrack     =   -1  'True
            ScrollBars      =   2
            ScrollTips      =   -1  'True
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   1
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
            Begin VB.Timer Timer3 
               Interval        =   2000
               Left            =   600
               Top             =   9000
            End
         End
      End
      Begin C1SizerLibCtl.C1Elastic elTabs 
         Height          =   10110
         Left            =   3675
         TabIndex        =   4
         TabStop         =   0   'False
         Top             =   90
         Width           =   9630
         _cx             =   16986
         _cy             =   17833
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   204
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Enabled         =   -1  'True
         Appearance      =   5
         MousePointer    =   0
         Version         =   801
         BackColor       =   -2147483633
         ForeColor       =   -2147483630
         FloodColor      =   6553600
         ForeColorDisabled=   -2147483631
         Caption         =   ""
         Align           =   0
         AutoSizeChildren=   1
         BorderWidth     =   6
         ChildSpacing    =   4
         Splitter        =   -1  'True
         FloodDirection  =   0
         FloodPercent    =   0
         CaptionPos      =   1
         WordWrap        =   -1  'True
         MaxChildSize    =   0
         MinChildSize    =   0
         TagWidth        =   0
         TagPosition     =   0
         Style           =   0
         TagSplit        =   2
         PicturePos      =   4
         CaptionStyle    =   0
         ResizeFonts     =   0   'False
         GridRows        =   0
         GridCols        =   0
         Frame           =   1
         FrameStyle      =   0
         FrameWidth      =   1
         FrameColor      =   -2147483628
         FrameShadow     =   -2147483632
         FloodStyle      =   1
         _GridInfo       =   ""
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   9
         Begin C1SizerLibCtl.C1Tab ctabMain 
            Height          =   9930
            Left            =   90
            TabIndex        =   5
            Top             =   90
            Width           =   9450
            _cx             =   16669
            _cy             =   17515
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   204
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Enabled         =   -1  'True
            Appearance      =   2
            MousePointer    =   0
            Version         =   801
            BackColor       =   -2147483633
            ForeColor       =   -2147483630
            FrontTabColor   =   -2147483633
            BackTabColor    =   -2147483633
            TabOutlineColor =   0
            FrontTabForeColor=   -2147483630
            Caption         =   "Каталоги|Изделия|Арматура|Спецификация|Выборка|Стандарты|Управление|Wise"
            Align           =   0
            CurrTab         =   0
            FirstTab        =   0
            Style           =   4
            Position        =   0
            AutoSwitch      =   -1  'True
            AutoScroll      =   0   'False
            TabPreview      =   0   'False
            ShowFocusRect   =   0   'False
            TabsPerPage     =   0
            BorderWidth     =   0
            BoldCurrent     =   -1  'True
            DogEars         =   0   'False
            MultiRow        =   0   'False
            MultiRowOffset  =   200
            CaptionStyle    =   3
            TabHeight       =   0
            TabCaptionPos   =   4
            TabPicturePos   =   0
            CaptionEmpty    =   ""
            Separators      =   -1  'True
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   37
            Begin C1SizerLibCtl.C1Elastic C1Elastic5 
               Height          =   9555
               Left            =   11895
               TabIndex        =   75
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   4
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   -1  'True
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic6 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   77
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   5
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   2
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   -1  'True
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Tab tbSimData 
                     Height          =   8325
                     Left            =   4350
                     TabIndex        =   79
                     Top             =   90
                     Width           =   4740
                     _cx             =   8361
                     _cy             =   14684
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   2
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FrontTabColor   =   -2147483633
                     BackTabColor    =   -2147483633
                     TabOutlineColor =   0
                     FrontTabForeColor=   -2147483630
                     Caption         =   "Файлы|Содержимое|Объемы|Содержимое2|Содержимое3|Содержимое4|Содержимое5|Содержимое6"
                     Align           =   0
                     CurrTab         =   1
                     FirstTab        =   0
                     Style           =   3
                     Position        =   0
                     AutoSwitch      =   -1  'True
                     AutoScroll      =   -1  'True
                     TabPreview      =   -1  'True
                     ShowFocusRect   =   -1  'True
                     TabsPerPage     =   0
                     BorderWidth     =   0
                     BoldCurrent     =   -1  'True
                     DogEars         =   -1  'True
                     MultiRow        =   0   'False
                     MultiRowOffset  =   200
                     CaptionStyle    =   0
                     TabHeight       =   0
                     TabCaptionPos   =   4
                     TabPicturePos   =   0
                     CaptionEmpty    =   ""
                     Separators      =   0   'False
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   37
                     Begin VSFlex8Ctl.VSFlexGrid fgSim 
                        Height          =   7950
                        Left            =   45
                        TabIndex        =   81
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   1
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   1
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin MSComctlLib.ListView lvWise 
                        Height          =   7950
                        Left            =   -5295
                        TabIndex        =   80
                        Top             =   330
                        Width           =   4650
                        _ExtentX        =   8202
                        _ExtentY        =   14023
                        View            =   3
                        LabelEdit       =   1
                        LabelWrap       =   -1  'True
                        HideSelection   =   -1  'True
                        Checkboxes      =   -1  'True
                        GridLines       =   -1  'True
                        _Version        =   393217
                        ForeColor       =   -2147483640
                        BackColor       =   -2147483643
                        BorderStyle     =   1
                        Appearance      =   1
                        NumItems        =   3
                        BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
                           Text            =   "Name"
                           Object.Width           =   2540
                        EndProperty
                        BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
                           SubItemIndex    =   1
                           Object.Width           =   2540
                        EndProperty
                        BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
                           SubItemIndex    =   2
                           Object.Width           =   2540
                        EndProperty
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSimVol 
                        Height          =   7950
                        Left            =   5385
                        TabIndex        =   82
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   0   'False
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   0
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSim2 
                        Height          =   7950
                        Left            =   5685
                        TabIndex        =   83
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   1
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   1
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSim3 
                        Height          =   7950
                        Left            =   5985
                        TabIndex        =   84
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSim4 
                        Height          =   7950
                        Left            =   6285
                        TabIndex        =   85
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSim5 
                        Height          =   7950
                        Left            =   6585
                        TabIndex        =   86
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSim6 
                        Height          =   7950
                        Left            =   6885
                        TabIndex        =   87
                        Top             =   330
                        Width           =   4650
                        _cx             =   8202
                        _cy             =   14023
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   3
                        ScrollTips      =   -1  'True
                        MergeCells      =   4
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                  End
                  Begin MSComctlLib.TreeView tvWise 
                     Height          =   8325
                     Left            =   90
                     TabIndex        =   78
                     Top             =   90
                     Width           =   4200
                     _ExtentX        =   7408
                     _ExtentY        =   14684
                     _Version        =   393217
                     HideSelection   =   0   'False
                     Indentation     =   529
                     LabelEdit       =   1
                     LineStyle       =   1
                     Style           =   7
                     ImageList       =   "ImageList5"
                     Appearance      =   1
                  End
               End
               Begin MSComctlLib.Toolbar tbWise 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   76
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   1879
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   12
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Перегруз"
                        Key             =   "Reload"
                        Object.ToolTipText     =   "Перезагрузка данных PW"
                        ImageIndex      =   30
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   5
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                              Key             =   "pwsrv"
                              Text            =   "PW SRV"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                              Key             =   "pwcon"
                              Text            =   "PW CONNECT"
                           EndProperty
                           BeginProperty ButtonMenu3 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                           EndProperty
                           BeginProperty ButtonMenu4 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                           EndProperty
                           BeginProperty ButtonMenu5 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Отмеченные"
                        Key             =   "ListChecked"
                        Object.ToolTipText     =   "Загружать только отмеченные документы PW"
                        ImageIndex      =   28
                        Style           =   1
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Редакт."
                        Key             =   "CanChange"
                        Object.ToolTipText     =   "Возможна правка"
                        ImageIndex      =   12
                        Style           =   1
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Object.Visible         =   0   'False
                        Caption         =   "Navis"
                        Key             =   "OpenModel"
                        ImageIndex      =   43
                        Style           =   1
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Excel"
                        Key             =   "Excel"
                        ImageIndex      =   26
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   3
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "ExcelSave"
                              Text            =   "Сохранить в файл"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Enabled         =   0   'False
                              Key             =   "ExcelOpen"
                              Text            =   "Открыть файл"
                           EndProperty
                           BeginProperty ButtonMenu3 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Enabled         =   0   'False
                              Key             =   "ExcelLoad"
                              Text            =   "Внести данные файла в базу"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button8 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Word"
                        Key             =   "Word"
                        Object.ToolTipText     =   "Экспорт в Word"
                        ImageIndex      =   41
                     EndProperty
                     BeginProperty Button9 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Микрик"
                        Key             =   "Micro"
                        Object.ToolTipText     =   "отрисовка в MS или AECOsim"
                        ImageIndex      =   21
                     EndProperty
                     BeginProperty Button10 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button11 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Обновить"
                        Key             =   "Update"
                        Object.ToolTipText     =   "Обновить отмеченные"
                        ImageIndex      =   42
                     EndProperty
                     BeginProperty Button12 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic C1Elastic13 
               Height          =   9555
               Left            =   11595
               TabIndex        =   56
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic14 
                  Height          =   8955
                  Left            =   90
                  TabIndex        =   58
                  TabStop         =   0   'False
                  Top             =   90
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15796
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   5
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   2
                  BorderWidth     =   1
                  ChildSpacing    =   4
                  Splitter        =   -1  'True
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Elastic C1Elastic16 
                     Height          =   8925
                     Left            =   4410
                     TabIndex        =   60
                     TabStop         =   0   'False
                     Top             =   15
                     Width           =   4755
                     _cx             =   8387
                     _cy             =   15743
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   1
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin VSFlex8Ctl.VSFlexGrid fgCmd 
                        Height          =   8265
                        Index           =   1
                        Left            =   15
                        TabIndex        =   66
                        Top             =   645
                        Width           =   4725
                        _cx             =   100212878
                        _cy             =   100219123
                        Appearance      =   2
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   12582912
                        ForeColor       =   16777088
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   12582912
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   2
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   3
                        GridLines       =   0
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   50
                        Cols            =   6
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   2
                        ScrollTips      =   -1  'True
                        MergeCells      =   0
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   1
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   0
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VB.ComboBox cmbCmd 
                        Height          =   315
                        Index           =   1
                        Left            =   15
                        Style           =   2  'Dropdown List
                        TabIndex        =   62
                        Top             =   15
                        Width           =   4725
                     End
                     Begin VB.Label lblCmd 
                        AutoSize        =   -1  'True
                        Height          =   195
                        Index           =   1
                        Left            =   15
                        TabIndex        =   64
                        Top             =   390
                        Width           =   4725
                     End
                  End
                  Begin C1SizerLibCtl.C1Elastic C1Elastic15 
                     Height          =   8925
                     Left            =   15
                     TabIndex        =   59
                     TabStop         =   0   'False
                     Top             =   15
                     Width           =   4335
                     _cx             =   7646
                     _cy             =   15743
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   1
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin VSFlex8Ctl.VSFlexGrid fgCmd 
                        Height          =   8265
                        Index           =   0
                        Left            =   15
                        TabIndex        =   65
                        Top             =   645
                        Width           =   4305
                        _cx             =   7594
                        _cy             =   14579
                        Appearance      =   2
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   12582912
                        ForeColor       =   16777088
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   12582912
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   1
                        HighLight       =   2
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   3
                        GridLines       =   0
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   50
                        Cols            =   6
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   2
                        ScrollTips      =   -1  'True
                        MergeCells      =   3
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   1
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   0
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                     Begin VB.ComboBox cmbCmd 
                        Height          =   315
                        Index           =   0
                        Left            =   15
                        Style           =   2  'Dropdown List
                        TabIndex        =   61
                        Top             =   15
                        Width           =   4305
                     End
                     Begin VB.Label lblCmd 
                        AutoSize        =   -1  'True
                        Height          =   195
                        Index           =   0
                        Left            =   15
                        TabIndex        =   63
                        Top             =   390
                        Width           =   4305
                     End
                  End
               End
               Begin MSComctlLib.Toolbar tbCmd 
                  Height          =   360
                  Left            =   90
                  TabIndex        =   57
                  Top             =   9105
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   635
                  ButtonWidth     =   2328
                  ButtonHeight    =   582
                  Appearance      =   1
                  Style           =   1
                  TextAlignment   =   1
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   2
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Копировать"
                        Key             =   "copy"
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Удалить"
                        Key             =   "del"
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic C1Elastic7 
               Height          =   9555
               Left            =   11295
               TabIndex        =   36
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic8 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   37
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   2
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   -1  'True
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Elastic C1Elastic10 
                     Height          =   8325
                     Left            =   90
                     TabIndex        =   38
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   3030
                     _cx             =   5345
                     _cy             =   14684
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   1
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin MSComctlLib.TreeView tvSrtm 
                        Height          =   8145
                        Left            =   90
                        TabIndex        =   39
                        Top             =   90
                        Width           =   2850
                        _ExtentX        =   5027
                        _ExtentY        =   14367
                        _Version        =   393217
                        HideSelection   =   0   'False
                        Indentation     =   529
                        LabelEdit       =   1
                        LineStyle       =   1
                        Style           =   7
                        Appearance      =   1
                     End
                  End
                  Begin C1SizerLibCtl.C1Elastic elFgSrtm 
                     Height          =   8325
                     Left            =   3180
                     TabIndex        =   40
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   5910
                     _cx             =   10425
                     _cy             =   14684
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin C1SizerLibCtl.C1Tab ctabSrtm 
                        Height          =   5415
                        Left            =   90
                        TabIndex        =   51
                        Top             =   2820
                        Width           =   5730
                        _cx             =   10107
                        _cy             =   9551
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   -1  'True
                        Appearance      =   2
                        MousePointer    =   0
                        Version         =   801
                        BackColor       =   -2147483633
                        ForeColor       =   -2147483630
                        FrontTabColor   =   -2147483633
                        BackTabColor    =   -2147483633
                        TabOutlineColor =   -2147483632
                        FrontTabForeColor=   -2147483630
                        Caption         =   "Позиции сортамента|Материалы|Наборы определений"
                        Align           =   0
                        CurrTab         =   0
                        FirstTab        =   0
                        Style           =   5
                        Position        =   0
                        AutoSwitch      =   -1  'True
                        AutoScroll      =   -1  'True
                        TabPreview      =   -1  'True
                        ShowFocusRect   =   -1  'True
                        TabsPerPage     =   0
                        BorderWidth     =   0
                        BoldCurrent     =   0   'False
                        DogEars         =   0   'False
                        MultiRow        =   0   'False
                        MultiRowOffset  =   200
                        CaptionStyle    =   0
                        TabHeight       =   0
                        TabCaptionPos   =   4
                        TabPicturePos   =   0
                        CaptionEmpty    =   ""
                        Separators      =   0   'False
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   37
                        Begin VSFlex8Ctl.VSFlexGrid fgSrtmPos 
                           Height          =   5010
                           Left            =   45
                           TabIndex        =   52
                           Top             =   360
                           Width           =   5640
                           _cx             =   9948
                           _cy             =   8837
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   3
                           HighLight       =   1
                           AllowSelection  =   0   'False
                           AllowBigSelection=   0   'False
                           AllowUserResizing=   1
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   3
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   0
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   1
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgSrtmMat 
                           Height          =   5010
                           Left            =   6375
                           TabIndex        =   53
                           Top             =   360
                           Width           =   5640
                           _cx             =   9948
                           _cy             =   8837
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   3
                           HighLight       =   1
                           AllowSelection  =   0   'False
                           AllowBigSelection=   0   'False
                           AllowUserResizing=   0
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   3
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   0
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   1
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgPDSet 
                           Height          =   5010
                           Left            =   6675
                           TabIndex        =   68
                           Top             =   360
                           Width           =   5640
                           _cx             =   9948
                           _cy             =   8837
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   3
                           HighLight       =   0
                           AllowSelection  =   0   'False
                           AllowBigSelection=   0   'False
                           AllowUserResizing=   0
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   3
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   0
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   1
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgSrtm 
                        Height          =   2670
                        Left            =   90
                        TabIndex        =   41
                        Top             =   90
                        Width           =   5730
                        _cx             =   94709627
                        _cy             =   94704230
                        Appearance      =   1
                        BorderStyle     =   0
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483633
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483633
                        FocusRect       =   3
                        HighLight       =   0
                        AllowSelection  =   0   'False
                        AllowBigSelection=   0   'False
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   2
                        FixedRows       =   1
                        FixedCols       =   1
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   1500
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   2
                        ScrollTips      =   -1  'True
                        MergeCells      =   0
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   1
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   -1  'True
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                  End
               End
               Begin MSComctlLib.Toolbar tbSrtm 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   42
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   2037
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   5
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Перегрузить"
                        Key             =   "Reload"
                        Object.ToolTipText     =   "Перегрузить дерево"
                        ImageIndex      =   30
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   1
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "LoadSrtm"
                              Text            =   "Перезагрузить данные сортамента"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Типы позиций"
                        Key             =   "NewPosdef"
                        Object.ToolTipText     =   "Типы позиций - редактирование"
                        ImageIndex      =   10
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Стандарты"
                        Key             =   "Stds"
                        Object.ToolTipText     =   "Стандарты - редактирование и добавление к типу позиций"
                        ImageIndex      =   7
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Материалы"
                        Key             =   "Mats"
                        Object.ToolTipText     =   "Материалы - редактирование и добавление"
                        ImageIndex      =   33
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Object.Visible         =   0   'False
                        Caption         =   "Комплекты"
                        Key             =   "Docsets"
                        Object.ToolTipText     =   "Комплекты документации"
                        ImageIndex      =   19
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic elOfftake 
               Height          =   9555
               Left            =   10995
               TabIndex        =   11
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic11 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   13
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   1
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   0   'False
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin VSFlex8Ctl.VSFlexGrid fgOfftake 
                     Height          =   8325
                     Left            =   90
                     TabIndex        =   15
                     Top             =   90
                     Width           =   9000
                     _cx             =   15875
                     _cy             =   14684
                     Appearance      =   1
                     BorderStyle     =   1
                     Enabled         =   -1  'True
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MousePointer    =   0
                     BackColor       =   -2147483643
                     ForeColor       =   -2147483640
                     BackColorFixed  =   -2147483633
                     ForeColorFixed  =   -2147483630
                     BackColorSel    =   -2147483635
                     ForeColorSel    =   -2147483634
                     BackColorBkg    =   -2147483636
                     BackColorAlternate=   -2147483643
                     GridColor       =   -2147483633
                     GridColorFixed  =   -2147483632
                     TreeColor       =   -2147483632
                     FloodColor      =   192
                     SheetBorder     =   -2147483642
                     FocusRect       =   0
                     HighLight       =   1
                     AllowSelection  =   0   'False
                     AllowBigSelection=   0   'False
                     AllowUserResizing=   0
                     SelectionMode   =   0
                     GridLines       =   2
                     GridLinesFixed  =   2
                     GridLineWidth   =   1
                     Rows            =   1
                     Cols            =   11
                     FixedRows       =   1
                     FixedCols       =   1
                     RowHeightMin    =   0
                     RowHeightMax    =   0
                     ColWidthMin     =   0
                     ColWidthMax     =   0
                     ExtendLastCol   =   -1  'True
                     FormatString    =   ""
                     ScrollTrack     =   -1  'True
                     ScrollBars      =   2
                     ScrollTips      =   -1  'True
                     MergeCells      =   1
                     MergeCompare    =   0
                     AutoResize      =   -1  'True
                     AutoSizeMode    =   0
                     AutoSearch      =   0
                     AutoSearchDelay =   2
                     MultiTotals     =   -1  'True
                     SubtotalPosition=   0
                     OutlineBar      =   0
                     OutlineCol      =   0
                     Ellipsis        =   0
                     ExplorerBar     =   0
                     PicturesOver    =   0   'False
                     FillStyle       =   0
                     RightToLeft     =   0   'False
                     PictureType     =   0
                     TabBehavior     =   0
                     OwnerDraw       =   0
                     Editable        =   0
                     ShowComboButton =   1
                     WordWrap        =   0   'False
                     TextStyle       =   0
                     TextStyleFixed  =   0
                     OleDragMode     =   0
                     OleDropMode     =   0
                     DataMode        =   0
                     VirtualData     =   -1  'True
                     DataMember      =   ""
                     ComboSearch     =   3
                     AutoSizeMouse   =   -1  'True
                     FrozenRows      =   0
                     FrozenCols      =   0
                     AllowUserFreezing=   0
                     BackColorFrozen =   0
                     ForeColorFrozen =   0
                     WallPaperAlignment=   9
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   24
                  End
               End
               Begin MSComctlLib.Toolbar tbOfftake 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   12
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   1640
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   8
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Расчёт"
                        Key             =   "Offtake"
                        Object.ToolTipText     =   "Пересчитать таблицу выборки"
                        ImageIndex      =   13
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   2
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "Offt_st"
                              Text            =   "Стандартно"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "Offt_in"
                              Text            =   "Объединить по первому столбцу"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "В.О.Р."
                        Key             =   "OfftVed"
                        ImageIndex      =   32
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   2
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "NoPass"
                              Text            =   "Без учета пассивности (для проверки массы)"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                              Key             =   "setNew"
                              Text            =   "по новому"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Бетон"
                        Key             =   "Beton"
                        ImageIndex      =   33
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   1
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "InclChildren"
                              Text            =   "С учетом подкаталогов"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Отрисовка"
                        Key             =   "Draw"
                        Object.ToolTipText     =   "Отрисовка в MicroStation"
                        ImageIndex      =   21
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   2
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "Draw_st"
                              Text            =   "Общая"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "Draw_in"
                              Text            =   "Разделенная"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Полная"
                        Key             =   "Nulls"
                        Object.ToolTipText     =   "Отображать позиции с нулевой массой"
                        ImageIndex      =   38
                        Style           =   1
                        Value           =   1
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Печать"
                        Key             =   "Print"
                        Object.ToolTipText     =   "Печать таблицы выборки"
                        ImageIndex      =   14
                     EndProperty
                     BeginProperty Button8 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Сохранить"
                        Key             =   "Excel"
                        ImageIndex      =   26
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic elSpec 
               Height          =   9555
               Left            =   10695
               TabIndex        =   10
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic1 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   17
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   3
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   0   'False
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin VSFlex8Ctl.VSFlexGrid fgSpec 
                     Height          =   8325
                     Left            =   90
                     TabIndex        =   18
                     Top             =   90
                     Width           =   9000
                     _cx             =   15875
                     _cy             =   14684
                     Appearance      =   1
                     BorderStyle     =   1
                     Enabled         =   -1  'True
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MousePointer    =   0
                     BackColor       =   -2147483643
                     ForeColor       =   -2147483640
                     BackColorFixed  =   -2147483633
                     ForeColorFixed  =   -2147483630
                     BackColorSel    =   -2147483635
                     ForeColorSel    =   -2147483634
                     BackColorBkg    =   -2147483636
                     BackColorAlternate=   -2147483643
                     GridColor       =   -2147483633
                     GridColorFixed  =   -2147483632
                     TreeColor       =   -2147483632
                     FloodColor      =   192
                     SheetBorder     =   -2147483642
                     FocusRect       =   0
                     HighLight       =   1
                     AllowSelection  =   -1  'True
                     AllowBigSelection=   -1  'True
                     AllowUserResizing=   0
                     SelectionMode   =   0
                     GridLines       =   1
                     GridLinesFixed  =   2
                     GridLineWidth   =   1
                     Rows            =   1
                     Cols            =   10
                     FixedRows       =   1
                     FixedCols       =   0
                     RowHeightMin    =   0
                     RowHeightMax    =   0
                     ColWidthMin     =   0
                     ColWidthMax     =   0
                     ExtendLastCol   =   -1  'True
                     FormatString    =   ""
                     ScrollTrack     =   -1  'True
                     ScrollBars      =   2
                     ScrollTips      =   -1  'True
                     MergeCells      =   0
                     MergeCompare    =   0
                     AutoResize      =   -1  'True
                     AutoSizeMode    =   0
                     AutoSearch      =   0
                     AutoSearchDelay =   2
                     MultiTotals     =   -1  'True
                     SubtotalPosition=   0
                     OutlineBar      =   0
                     OutlineCol      =   0
                     Ellipsis        =   0
                     ExplorerBar     =   0
                     PicturesOver    =   0   'False
                     FillStyle       =   0
                     RightToLeft     =   0   'False
                     PictureType     =   0
                     TabBehavior     =   0
                     OwnerDraw       =   0
                     Editable        =   0
                     ShowComboButton =   1
                     WordWrap        =   0   'False
                     TextStyle       =   0
                     TextStyleFixed  =   0
                     OleDragMode     =   0
                     OleDropMode     =   0
                     DataMode        =   0
                     VirtualData     =   -1  'True
                     DataMember      =   ""
                     ComboSearch     =   3
                     AutoSizeMouse   =   -1  'True
                     FrozenRows      =   0
                     FrozenCols      =   0
                     AllowUserFreezing=   0
                     BackColorFrozen =   0
                     ForeColorFrozen =   0
                     WallPaperAlignment=   9
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   24
                  End
               End
               Begin MSComctlLib.Toolbar tbSpec 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   16
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   1640
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   7
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Расчет"
                        Key             =   "refresh"
                        Object.ToolTipText     =   "Печать таблицы спецификации"
                        ImageIndex      =   5
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   1
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "all_emb"
                              Text            =   "Все закладные изделия"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Отрисовка"
                        Key             =   "Draw"
                        ImageIndex      =   21
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Печать"
                        Key             =   "Print"
                        ImageIndex      =   14
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Сохранить"
                        Key             =   "Excel"
                        ImageIndex      =   26
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Проверять"
                        Key             =   "Check"
                        Object.ToolTipText     =   "Проверять массу при расчете"
                        ImageIndex      =   39
                        Style           =   1
                        Object.Width           =   1e-4
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic elSrtm 
               Height          =   9555
               Left            =   10395
               TabIndex        =   9
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic2 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   26
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   4
                  BorderWidth     =   5
                  ChildSpacing    =   4
                  Splitter        =   0   'False
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   0
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Elastic C1Elastic9 
                     Height          =   8085
                     Left            =   75
                     TabIndex        =   47
                     TabStop         =   0   'False
                     Top             =   345
                     Width           =   9030
                     _cx             =   15928
                     _cy             =   14261
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   0
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   1
                     ChildSpacing    =   4
                     Splitter        =   -1  'True
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin C1SizerLibCtl.C1Elastic elBar 
                        Height          =   1515
                        Left            =   15
                        TabIndex        =   49
                        TabStop         =   0   'False
                        Top             =   6555
                        Width           =   9000
                        _cx             =   15875
                        _cy             =   2672
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   -1  'True
                        Appearance      =   5
                        MousePointer    =   0
                        Version         =   801
                        BackColor       =   -2147483633
                        ForeColor       =   -2147483630
                        FloodColor      =   6553600
                        ForeColorDisabled=   -2147483631
                        Caption         =   ""
                        Align           =   0
                        AutoSizeChildren=   2
                        BorderWidth     =   1
                        ChildSpacing    =   4
                        Splitter        =   -1  'True
                        FloodDirection  =   0
                        FloodPercent    =   0
                        CaptionPos      =   1
                        WordWrap        =   -1  'True
                        MaxChildSize    =   0
                        MinChildSize    =   0
                        TagWidth        =   0
                        TagPosition     =   0
                        Style           =   0
                        TagSplit        =   2
                        PicturePos      =   4
                        CaptionStyle    =   0
                        ResizeFonts     =   0   'False
                        GridRows        =   0
                        GridCols        =   0
                        Frame           =   3
                        FrameStyle      =   0
                        FrameWidth      =   1
                        FrameColor      =   -2147483628
                        FrameShadow     =   -2147483632
                        FloodStyle      =   1
                        _GridInfo       =   ""
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   9
                        Begin Rein2D_prj.Rein2d Arm_2D1 
                           Height          =   1485
                           Left            =   15
                           TabIndex        =   67
                           Top             =   15
                           Width           =   8970
                           _ExtentX        =   15822
                           _ExtentY        =   2619
                        End
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgCatParts 
                        Height          =   6480
                        Left            =   15
                        TabIndex        =   48
                        Top             =   15
                        Width           =   9000
                        _cx             =   15875
                        _cy             =   11430
                        Appearance      =   1
                        BorderStyle     =   1
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   16777215
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483636
                        BackColorAlternate=   16777215
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483642
                        FocusRect       =   5
                        HighLight       =   1
                        AllowSelection  =   0   'False
                        AllowBigSelection=   0   'False
                        AllowUserResizing=   1
                        SelectionMode   =   1
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   17
                        FixedRows       =   1
                        FixedCols       =   0
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   2
                        ScrollTips      =   -1  'True
                        MergeCells      =   0
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   1
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   1
                        ShowComboButton =   1
                        WordWrap        =   0   'False
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   0
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                        Begin VB.Timer Timer2 
                           Enabled         =   0   'False
                           Interval        =   7000
                           Left            =   1440
                           Top             =   1560
                        End
                        Begin VB.Label lblCatName 
                           Caption         =   "Label1"
                           Height          =   375
                           Left            =   4320
                           TabIndex        =   50
                           Top             =   1440
                           Visible         =   0   'False
                           Width           =   2415
                        End
                     End
                  End
                  Begin VB.Label lblCurCatName 
                     Caption         =   "Название каталога"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   210
                     Index           =   1
                     Left            =   75
                     TabIndex        =   44
                     Top             =   75
                     Width           =   9030
                  End
               End
               Begin MSComctlLib.Toolbar tbRein 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   25
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   1614
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   11
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "В список"
                        Key             =   "InList"
                        Object.ToolTipText     =   "Добавить текущий каталог в список"
                        ImageIndex      =   25
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Перегруз"
                        Key             =   "Reload"
                        Object.ToolTipText     =   "Перезагрузить данные каталога"
                        ImageIndex      =   30
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Пустая"
                        Key             =   "posok_clear"
                        Object.ToolTipText     =   "Создать пустую позицию"
                        ImageIndex      =   35
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Запомнить"
                        Key             =   "defaultpos"
                        Object.ToolTipText     =   "Запомнить параметры текущей позиции для новых"
                        ImageIndex      =   3
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Позиция"
                        Key             =   "posok"
                        Object.ToolTipText     =   "Создать позицию или применить текущие данные к позиции"
                        ImageIndex      =   28
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Сдвигать"
                        Key             =   "posok_shift"
                        Object.ToolTipText     =   "Включить смещение номеров позиций при вставке или удалении"
                        ImageIndex      =   34
                        Style           =   1
                     EndProperty
                     BeginProperty Button8 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button9 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Микрик"
                        Key             =   "Draw"
                        Object.ToolTipText     =   "Отрисовка спецификации в MicroStation"
                        ImageIndex      =   21
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   5
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "spec"
                              Text            =   "Спецификация"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "ved"
                              Text            =   "Ведомость деталей"
                           EndProperty
                           BeginProperty ButtonMenu3 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "sketch"
                              Text            =   "Эскиз позиции"
                           EndProperty
                           BeginProperty ButtonMenu4 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "ku"
                              Text            =   "-"
                           EndProperty
                           BeginProperty ButtonMenu5 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "specimp"
                              Text            =   "Импорт"
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button10 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Печать"
                        Key             =   "Print"
                        Object.ToolTipText     =   "Печать списка арматуры на принтере"
                        ImageIndex      =   14
                     EndProperty
                     BeginProperty Button11 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Excel"
                        Key             =   "Excel"
                        Object.ToolTipText     =   "Сохранить список арматуры в Excel"
                        ImageIndex      =   26
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   3
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "ExcelSave"
                              Text            =   "Сохранить"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                           EndProperty
                           BeginProperty ButtonMenu3 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                              Text            =   "1"
                           EndProperty
                        EndProperty
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
            Begin C1SizerLibCtl.C1Elastic elEmbParts 
               Height          =   9555
               Left            =   10095
               TabIndex        =   8
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic3 
                  Height          =   8220
                  Left            =   90
                  TabIndex        =   23
                  TabStop         =   0   'False
                  Top             =   1245
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   14499
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   2
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   -1  'True
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Elastic elTvParts 
                     Height          =   8040
                     Left            =   90
                     TabIndex        =   27
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   3390
                     _cx             =   5980
                     _cy             =   14182
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   1
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin VB.FileListBox lstPics 
                        Height          =   1650
                        Left            =   1320
                        TabIndex        =   55
                        Top             =   3720
                        Visible         =   0   'False
                        Width           =   1215
                     End
                     Begin MSComctlLib.TreeView tvParts 
                        DragIcon        =   "Form1.frx":1487E
                        Height          =   7860
                        Left            =   90
                        TabIndex        =   28
                        Top             =   90
                        Width           =   3210
                        _ExtentX        =   5662
                        _ExtentY        =   13864
                        _Version        =   393217
                        HideSelection   =   0   'False
                        Indentation     =   529
                        LabelEdit       =   1
                        LineStyle       =   1
                        Style           =   7
                        Checkboxes      =   -1  'True
                        HotTracking     =   -1  'True
                        ImageList       =   "ImageList2"
                        Appearance      =   1
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                  End
                  Begin C1SizerLibCtl.C1Elastic elFgPart 
                     Height          =   8040
                     Left            =   3540
                     TabIndex        =   24
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   5550
                     _cx             =   9790
                     _cy             =   14182
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin C1SizerLibCtl.C1Elastic elFgPosGrid 
                        Height          =   5895
                        Left            =   90
                        TabIndex        =   33
                        TabStop         =   0   'False
                        Top             =   2055
                        Width           =   5370
                        _cx             =   9472
                        _cy             =   10398
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   -1  'True
                        Appearance      =   0
                        MousePointer    =   0
                        Version         =   801
                        BackColor       =   -2147483633
                        ForeColor       =   -2147483630
                        FloodColor      =   6553600
                        ForeColorDisabled=   -2147483631
                        Caption         =   ""
                        Align           =   0
                        AutoSizeChildren=   3
                        BorderWidth     =   1
                        ChildSpacing    =   4
                        Splitter        =   0   'False
                        FloodDirection  =   0
                        FloodPercent    =   0
                        CaptionPos      =   1
                        WordWrap        =   -1  'True
                        MaxChildSize    =   0
                        MinChildSize    =   0
                        TagWidth        =   0
                        TagPosition     =   0
                        Style           =   0
                        TagSplit        =   2
                        PicturePos      =   4
                        CaptionStyle    =   0
                        ResizeFonts     =   0   'False
                        GridRows        =   0
                        GridCols        =   0
                        Frame           =   3
                        FrameStyle      =   0
                        FrameWidth      =   1
                        FrameColor      =   -2147483628
                        FrameShadow     =   -2147483632
                        FloodStyle      =   1
                        _GridInfo       =   ""
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   9
                        Begin VSFlex8Ctl.VSFlexGrid fgPositions 
                           Height          =   5865
                           Left            =   15
                           TabIndex        =   35
                           Top             =   15
                           Width           =   5340
                           _cx             =   9419
                           _cy             =   10345
                           Appearance      =   2
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483633
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   3
                           HighLight       =   0
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   5
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   2
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   2
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                           Begin VB.Timer Timer1 
                              Interval        =   10000
                              Left            =   3720
                              Top             =   1200
                           End
                        End
                     End
                     Begin C1SizerLibCtl.C1Elastic elFgPartGrid 
                        Height          =   1905
                        Left            =   90
                        TabIndex        =   32
                        TabStop         =   0   'False
                        Top             =   90
                        Width           =   5370
                        _cx             =   9472
                        _cy             =   3360
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   -1  'True
                        Appearance      =   0
                        MousePointer    =   0
                        Version         =   801
                        BackColor       =   -2147483633
                        ForeColor       =   -2147483630
                        FloodColor      =   6553600
                        ForeColorDisabled=   -2147483631
                        Caption         =   ""
                        Align           =   0
                        AutoSizeChildren=   3
                        BorderWidth     =   1
                        ChildSpacing    =   4
                        Splitter        =   0   'False
                        FloodDirection  =   0
                        FloodPercent    =   0
                        CaptionPos      =   1
                        WordWrap        =   -1  'True
                        MaxChildSize    =   0
                        MinChildSize    =   0
                        TagWidth        =   0
                        TagPosition     =   0
                        Style           =   0
                        TagSplit        =   2
                        PicturePos      =   4
                        CaptionStyle    =   0
                        ResizeFonts     =   0   'False
                        GridRows        =   0
                        GridCols        =   0
                        Frame           =   3
                        FrameStyle      =   0
                        FrameWidth      =   0
                        FrameColor      =   -2147483628
                        FrameShadow     =   -2147483632
                        FloodStyle      =   1
                        _GridInfo       =   ""
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   9
                        Begin VSFlex8Ctl.VSFlexGrid fgPart 
                           Height          =   1875
                           Left            =   15
                           TabIndex        =   34
                           Top             =   15
                           Width           =   5340
                           _cx             =   67970251
                           _cy             =   67964139
                           Appearance      =   2
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483633
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483633
                           FocusRect       =   3
                           HighLight       =   0
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   0
                           Cols            =   7
                           FixedRows       =   0
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   2
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                           Begin MSComctlLib.Slider sldRound 
                              Height          =   225
                              Left            =   0
                              TabIndex        =   54
                              Top             =   1680
                              Width           =   1455
                              _ExtentX        =   2566
                              _ExtentY        =   397
                              _Version        =   393216
                              LargeChange     =   1
                              Min             =   -5
                              Max             =   5
                           End
                        End
                     End
                  End
               End
               Begin MSComctlLib.Toolbar tbPart 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   22
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   1482
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   11
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Создать"
                        Key             =   "NewPart"
                        Object.ToolTipText     =   "Создать новое изделие"
                        ImageIndex      =   1
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "В список"
                        Key             =   "InList"
                        Object.ToolTipText     =   "Добавить выделенные изделия в список"
                        ImageIndex      =   25
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "Позиция"
                        Key             =   "AddPos"
                        Object.ToolTipText     =   "Добавить позицию в изделие"
                        ImageIndex      =   8
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Спе...ция"
                        Key             =   "Draw"
                        Object.ToolTipText     =   "Отрисовка спецификации для содержимого изделия"
                        ImageIndex      =   21
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Перегруз"
                        Key             =   "Reload"
                        Object.ToolTipText     =   "Перегрузить дерево"
                        ImageIndex      =   30
                        Style           =   5
                        BeginProperty ButtonMenus {66833FEC-8583-11D1-B16A-00C0F0283628} 
                           NumButtonMenus  =   10
                           BeginProperty ButtonMenu1 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Object.Visible         =   0   'False
                              Key             =   "user"
                              Object.Tag             =   "2"
                              Text            =   "Пользователь"
                           EndProperty
                           BeginProperty ButtonMenu2 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "simple"
                              Object.Tag             =   "0"
                              Text            =   "Просто (без подразделов)"
                           EndProperty
                           BeginProperty ButtonMenu3 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "type"
                              Object.Tag             =   "1"
                              Text            =   "Тип изделия"
                           EndProperty
                           BeginProperty ButtonMenu4 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "sign"
                              Object.Tag             =   "3"
                              Text            =   "Обозначение"
                           EndProperty
                           BeginProperty ButtonMenu5 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "signsheet"
                              Object.Tag             =   "4"
                              Text            =   "Обозначение, лист"
                           EndProperty
                           BeginProperty ButtonMenu6 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "stat"
                              Object.Tag             =   "5"
                              Text            =   "Статус"
                           EndProperty
                           BeginProperty ButtonMenu7 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "partlist"
                              Object.Tag             =   "6"
                              Text            =   "Ведомость"
                           EndProperty
                           BeginProperty ButtonMenu8 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "drawings"
                              Object.Tag             =   "7"
                              Text            =   "Комплект"
                           EndProperty
                           BeginProperty ButtonMenu9 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "kks"
                              Object.Tag             =   "8"
                              Text            =   "KKS"
                           EndProperty
                           BeginProperty ButtonMenu10 {66833FEE-8583-11D1-B16A-00C0F0283628} 
                              Key             =   "filter"
                              Text            =   "Фильтр..."
                           EndProperty
                        EndProperty
                     EndProperty
                     BeginProperty Button8 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Корзина"
                        Key             =   "ShowDeleted"
                        Object.ToolTipText     =   "Показать удаленные изделия"
                        ImageIndex      =   17
                        Style           =   1
                     EndProperty
                     BeginProperty Button9 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Style           =   3
                     EndProperty
                     BeginProperty Button10 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Object.Visible         =   0   'False
                        Caption         =   "Правка"
                        Key             =   "EditPart"
                        Object.ToolTipText     =   "Включить режим редактирования"
                        ImageIndex      =   2
                        Style           =   1
                     EndProperty
                     BeginProperty Button11 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Свойства"
                        Key             =   "Collapsed"
                        Object.ToolTipText     =   "Показывать свойства позиций"
                        ImageIndex      =   4
                        Style           =   1
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
               Begin VB.Label lblCurCatName 
                  Caption         =   "Название каталога"
                  BeginProperty Font 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Height          =   225
                  Index           =   0
                  Left            =   90
                  TabIndex        =   45
                  Top             =   960
                  Width           =   9180
               End
            End
            Begin C1SizerLibCtl.C1Elastic elCats 
               Height          =   9555
               Left            =   45
               TabIndex        =   7
               TabStop         =   0   'False
               Top             =   330
               Width           =   9360
               _cx             =   16510
               _cy             =   16854
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   204
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Enabled         =   -1  'True
               Appearance      =   5
               MousePointer    =   0
               Version         =   801
               BackColor       =   -2147483633
               ForeColor       =   -2147483630
               FloodColor      =   6553600
               ForeColorDisabled=   -2147483631
               Caption         =   ""
               Align           =   0
               AutoSizeChildren=   4
               BorderWidth     =   6
               ChildSpacing    =   4
               Splitter        =   0   'False
               FloodDirection  =   0
               FloodPercent    =   0
               CaptionPos      =   1
               WordWrap        =   -1  'True
               MaxChildSize    =   0
               MinChildSize    =   0
               TagWidth        =   0
               TagPosition     =   0
               Style           =   0
               TagSplit        =   2
               PicturePos      =   4
               CaptionStyle    =   0
               ResizeFonts     =   0   'False
               GridRows        =   0
               GridCols        =   0
               Frame           =   3
               FrameStyle      =   0
               FrameWidth      =   1
               FrameColor      =   -2147483628
               FrameShadow     =   -2147483632
               FloodStyle      =   1
               _GridInfo       =   ""
               AccessibleName  =   ""
               AccessibleDescription=   ""
               AccessibleValue =   ""
               AccessibleRole  =   9
               Begin C1SizerLibCtl.C1Elastic C1Elastic4 
                  Height          =   8505
                  Left            =   90
                  TabIndex        =   20
                  TabStop         =   0   'False
                  Top             =   960
                  Width           =   9180
                  _cx             =   16193
                  _cy             =   15002
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   204
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Enabled         =   -1  'True
                  Appearance      =   4
                  MousePointer    =   0
                  Version         =   801
                  BackColor       =   -2147483633
                  ForeColor       =   -2147483630
                  FloodColor      =   6553600
                  ForeColorDisabled=   -2147483631
                  Caption         =   ""
                  Align           =   0
                  AutoSizeChildren=   2
                  BorderWidth     =   6
                  ChildSpacing    =   4
                  Splitter        =   -1  'True
                  FloodDirection  =   0
                  FloodPercent    =   0
                  CaptionPos      =   1
                  WordWrap        =   -1  'True
                  MaxChildSize    =   0
                  MinChildSize    =   0
                  TagWidth        =   0
                  TagPosition     =   0
                  Style           =   0
                  TagSplit        =   2
                  PicturePos      =   4
                  CaptionStyle    =   0
                  ResizeFonts     =   0   'False
                  GridRows        =   0
                  GridCols        =   0
                  Frame           =   3
                  FrameStyle      =   0
                  FrameWidth      =   1
                  FrameColor      =   -2147483628
                  FrameShadow     =   -2147483632
                  FloodStyle      =   1
                  _GridInfo       =   ""
                  AccessibleName  =   ""
                  AccessibleDescription=   ""
                  AccessibleValue =   ""
                  AccessibleRole  =   9
                  Begin C1SizerLibCtl.C1Elastic elCatsTree 
                     Height          =   8325
                     Left            =   90
                     TabIndex        =   29
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   3270
                     _cx             =   5768
                     _cy             =   14684
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   1
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin MSComctlLib.TreeView tvCats 
                        DragIcon        =   "Form1.frx":14CC0
                        Height          =   8145
                        Left            =   90
                        TabIndex        =   30
                        Top             =   90
                        Width           =   3090
                        _ExtentX        =   5450
                        _ExtentY        =   14367
                        _Version        =   393217
                        HideSelection   =   0   'False
                        Indentation     =   529
                        LabelEdit       =   1
                        LineStyle       =   1
                        PathSeparator   =   " - "
                        Style           =   7
                        ImageList       =   "ImageList2"
                        Appearance      =   1
                     End
                  End
                  Begin C1SizerLibCtl.C1Elastic elCatsInf 
                     Height          =   8325
                     Left            =   3420
                     TabIndex        =   21
                     TabStop         =   0   'False
                     Top             =   90
                     Width           =   5670
                     _cx             =   10001
                     _cy             =   14684
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   204
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   -1  'True
                     Appearance      =   4
                     MousePointer    =   0
                     Version         =   801
                     BackColor       =   -2147483633
                     ForeColor       =   -2147483630
                     FloodColor      =   6553600
                     ForeColorDisabled=   -2147483631
                     Caption         =   ""
                     Align           =   0
                     AutoSizeChildren=   4
                     BorderWidth     =   6
                     ChildSpacing    =   4
                     Splitter        =   0   'False
                     FloodDirection  =   0
                     FloodPercent    =   0
                     CaptionPos      =   1
                     WordWrap        =   -1  'True
                     MaxChildSize    =   0
                     MinChildSize    =   0
                     TagWidth        =   0
                     TagPosition     =   0
                     Style           =   0
                     TagSplit        =   2
                     PicturePos      =   4
                     CaptionStyle    =   0
                     ResizeFonts     =   0   'False
                     GridRows        =   0
                     GridCols        =   0
                     Frame           =   3
                     FrameStyle      =   0
                     FrameWidth      =   1
                     FrameColor      =   -2147483628
                     FrameShadow     =   -2147483632
                     FloodStyle      =   1
                     _GridInfo       =   ""
                     AccessibleName  =   ""
                     AccessibleDescription=   ""
                     AccessibleValue =   ""
                     AccessibleRole  =   9
                     Begin C1SizerLibCtl.C1Tab ctabCat 
                        Height          =   4860
                        Left            =   90
                        TabIndex        =   69
                        Top             =   3375
                        Width           =   5490
                        _cx             =   9684
                        _cy             =   8572
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   -1  'True
                        Appearance      =   2
                        MousePointer    =   0
                        Version         =   801
                        BackColor       =   -2147483633
                        ForeColor       =   -2147483630
                        FrontTabColor   =   -2147483633
                        BackTabColor    =   -2147483633
                        TabOutlineColor =   -2147483632
                        FrontTabForeColor=   -2147483630
                        Caption         =   "Содержимое|Спецификация|Выборка|Позиции|Модель"
                        Align           =   0
                        CurrTab         =   0
                        FirstTab        =   0
                        Style           =   5
                        Position        =   0
                        AutoSwitch      =   -1  'True
                        AutoScroll      =   -1  'True
                        TabPreview      =   -1  'True
                        ShowFocusRect   =   -1  'True
                        TabsPerPage     =   0
                        BorderWidth     =   0
                        BoldCurrent     =   0   'False
                        DogEars         =   -1  'True
                        MultiRow        =   0   'False
                        MultiRowOffset  =   200
                        CaptionStyle    =   0
                        TabHeight       =   0
                        TabCaptionPos   =   4
                        TabPicturePos   =   0
                        CaptionEmpty    =   ""
                        Separators      =   0   'False
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   37
                        Begin VSFlex8Ctl.VSFlexGrid fgCatTree 
                           Height          =   4455
                           Left            =   45
                           TabIndex        =   70
                           Top             =   360
                           Width           =   5400
                           _cx             =   9525
                           _cy             =   7858
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   0
                           HighLight       =   1
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   3
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   6
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   3
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   0
                           ShowComboButton =   1
                           WordWrap        =   -1  'True
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgCatSpec 
                           Height          =   4455
                           Left            =   6135
                           TabIndex        =   71
                           Top             =   360
                           Width           =   5400
                           _cx             =   9525
                           _cy             =   7858
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   0
                           HighLight       =   1
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   3
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   6
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   3
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   0
                           ShowComboButton =   1
                           WordWrap        =   -1  'True
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgCatOfft 
                           Height          =   4455
                           Left            =   6435
                           TabIndex        =   72
                           Top             =   360
                           Width           =   5400
                           _cx             =   9525
                           _cy             =   7858
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   0
                           HighLight       =   1
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   3
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   6
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   3
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   2
                           ShowComboButton =   1
                           WordWrap        =   -1  'True
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgCatPos 
                           Height          =   4455
                           Left            =   6735
                           TabIndex        =   73
                           Top             =   360
                           Width           =   5400
                           _cx             =   9525
                           _cy             =   7858
                           Appearance      =   2
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483633
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   3
                           HighLight       =   0
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   0
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   5
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   2
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   2
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   0
                           ShowComboButton =   1
                           WordWrap        =   0   'False
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   0
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                        Begin VSFlex8Ctl.VSFlexGrid fgPartsModel 
                           Height          =   4455
                           Left            =   7035
                           TabIndex        =   74
                           Top             =   360
                           Width           =   5400
                           _cx             =   9525
                           _cy             =   7858
                           Appearance      =   1
                           BorderStyle     =   1
                           Enabled         =   -1  'True
                           BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                              Name            =   "MS Sans Serif"
                              Size            =   8.25
                              Charset         =   204
                              Weight          =   400
                              Underline       =   0   'False
                              Italic          =   0   'False
                              Strikethrough   =   0   'False
                           EndProperty
                           MousePointer    =   0
                           BackColor       =   -2147483643
                           ForeColor       =   -2147483640
                           BackColorFixed  =   -2147483633
                           ForeColorFixed  =   -2147483630
                           BackColorSel    =   -2147483635
                           ForeColorSel    =   -2147483634
                           BackColorBkg    =   -2147483636
                           BackColorAlternate=   -2147483643
                           GridColor       =   -2147483633
                           GridColorFixed  =   -2147483632
                           TreeColor       =   -2147483632
                           FloodColor      =   192
                           SheetBorder     =   -2147483642
                           FocusRect       =   0
                           HighLight       =   1
                           AllowSelection  =   -1  'True
                           AllowBigSelection=   -1  'True
                           AllowUserResizing=   0
                           SelectionMode   =   3
                           GridLines       =   1
                           GridLinesFixed  =   2
                           GridLineWidth   =   1
                           Rows            =   1
                           Cols            =   6
                           FixedRows       =   1
                           FixedCols       =   0
                           RowHeightMin    =   0
                           RowHeightMax    =   0
                           ColWidthMin     =   0
                           ColWidthMax     =   0
                           ExtendLastCol   =   -1  'True
                           FormatString    =   ""
                           ScrollTrack     =   -1  'True
                           ScrollBars      =   2
                           ScrollTips      =   -1  'True
                           MergeCells      =   3
                           MergeCompare    =   0
                           AutoResize      =   -1  'True
                           AutoSizeMode    =   0
                           AutoSearch      =   0
                           AutoSearchDelay =   2
                           MultiTotals     =   -1  'True
                           SubtotalPosition=   1
                           OutlineBar      =   0
                           OutlineCol      =   0
                           Ellipsis        =   0
                           ExplorerBar     =   0
                           PicturesOver    =   0   'False
                           FillStyle       =   0
                           RightToLeft     =   0   'False
                           PictureType     =   0
                           TabBehavior     =   0
                           OwnerDraw       =   0
                           Editable        =   0
                           ShowComboButton =   1
                           WordWrap        =   -1  'True
                           TextStyle       =   0
                           TextStyleFixed  =   0
                           OleDragMode     =   0
                           OleDropMode     =   1
                           DataMode        =   0
                           VirtualData     =   -1  'True
                           DataMember      =   ""
                           ComboSearch     =   3
                           AutoSizeMouse   =   -1  'True
                           FrozenRows      =   0
                           FrozenCols      =   0
                           AllowUserFreezing=   0
                           BackColorFrozen =   0
                           ForeColorFrozen =   0
                           WallPaperAlignment=   9
                           AccessibleName  =   ""
                           AccessibleDescription=   ""
                           AccessibleValue =   ""
                           AccessibleRole  =   24
                        End
                     End
                     Begin VSFlex8Ctl.VSFlexGrid fgCats 
                        Height          =   3225
                        Left            =   90
                        TabIndex        =   31
                        Top             =   90
                        Width           =   5490
                        _cx             =   76948948
                        _cy             =   76944953
                        Appearance      =   1
                        BorderStyle     =   0
                        Enabled         =   -1  'True
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   204
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MousePointer    =   0
                        BackColor       =   -2147483643
                        ForeColor       =   -2147483640
                        BackColorFixed  =   -2147483633
                        ForeColorFixed  =   -2147483630
                        BackColorSel    =   -2147483635
                        ForeColorSel    =   -2147483634
                        BackColorBkg    =   -2147483633
                        BackColorAlternate=   -2147483643
                        GridColor       =   -2147483633
                        GridColorFixed  =   -2147483632
                        TreeColor       =   -2147483632
                        FloodColor      =   192
                        SheetBorder     =   -2147483633
                        FocusRect       =   3
                        HighLight       =   0
                        AllowSelection  =   -1  'True
                        AllowBigSelection=   -1  'True
                        AllowUserResizing=   1
                        SelectionMode   =   0
                        GridLines       =   1
                        GridLinesFixed  =   2
                        GridLineWidth   =   1
                        Rows            =   1
                        Cols            =   7
                        FixedRows       =   1
                        FixedCols       =   1
                        RowHeightMin    =   0
                        RowHeightMax    =   0
                        ColWidthMin     =   0
                        ColWidthMax     =   0
                        ExtendLastCol   =   -1  'True
                        FormatString    =   ""
                        ScrollTrack     =   -1  'True
                        ScrollBars      =   2
                        ScrollTips      =   -1  'True
                        MergeCells      =   0
                        MergeCompare    =   0
                        AutoResize      =   -1  'True
                        AutoSizeMode    =   0
                        AutoSearch      =   0
                        AutoSearchDelay =   2
                        MultiTotals     =   -1  'True
                        SubtotalPosition=   1
                        OutlineBar      =   0
                        OutlineCol      =   0
                        Ellipsis        =   0
                        ExplorerBar     =   0
                        PicturesOver    =   0   'False
                        FillStyle       =   0
                        RightToLeft     =   0   'False
                        PictureType     =   0
                        TabBehavior     =   0
                        OwnerDraw       =   0
                        Editable        =   2
                        ShowComboButton =   1
                        WordWrap        =   -1  'True
                        TextStyle       =   0
                        TextStyleFixed  =   0
                        OleDragMode     =   0
                        OleDropMode     =   0
                        DataMode        =   0
                        VirtualData     =   -1  'True
                        DataMember      =   ""
                        ComboSearch     =   3
                        AutoSizeMouse   =   -1  'True
                        FrozenRows      =   0
                        FrozenCols      =   0
                        AllowUserFreezing=   0
                        BackColorFrozen =   0
                        ForeColorFrozen =   0
                        WallPaperAlignment=   9
                        AccessibleName  =   ""
                        AccessibleDescription=   ""
                        AccessibleValue =   ""
                        AccessibleRole  =   24
                     End
                  End
               End
               Begin MSComctlLib.Toolbar tbCats 
                  Height          =   810
                  Left            =   90
                  TabIndex        =   19
                  Top             =   90
                  Width           =   9180
                  _ExtentX        =   16193
                  _ExtentY        =   1429
                  ButtonWidth     =   2090
                  ButtonHeight    =   1376
                  AllowCustomize  =   0   'False
                  Wrappable       =   0   'False
                  Appearance      =   1
                  Style           =   1
                  ImageList       =   "ImageList3"
                  _Version        =   393216
                  BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
                     NumButtons      =   7
                     BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Новый проект"
                        Key             =   "newproject"
                        Object.ToolTipText     =   "Создать новый проект"
                        ImageIndex      =   29
                     EndProperty
                     BeginProperty Button2 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Enabled         =   0   'False
                        Caption         =   "В список"
                        Key             =   "InList"
                        Object.ToolTipText     =   "Добавить каталог в список"
                        ImageIndex      =   25
                     EndProperty
                     BeginProperty Button3 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Перегрузить"
                        Key             =   "reload"
                        Object.ToolTipText     =   "Перезагрузить дерево"
                        ImageIndex      =   30
                     EndProperty
                     BeginProperty Button4 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Все"
                        Key             =   "LoadAll"
                        ImageIndex      =   19
                        Style           =   1
                     EndProperty
                     BeginProperty Button5 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Поиск"
                        Key             =   "Search"
                        ImageIndex      =   37
                     EndProperty
                     BeginProperty Button6 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Caption         =   "Кат"
                        Key             =   "FindCat"
                        ImageIndex      =   36
                     EndProperty
                     BeginProperty Button7 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                        Object.Visible         =   0   'False
                        Caption         =   "Функции"
                        Key             =   "UseFunc"
                        ImageIndex      =   15
                        Style           =   1
                     EndProperty
                  EndProperty
                  BorderStyle     =   1
               End
            End
         End
      End
      Begin C1SizerLibCtl.C1Elastic elList 
         Height          =   10110
         Left            =   90
         TabIndex        =   3
         TabStop         =   0   'False
         Top             =   90
         Width           =   3525
         _cx             =   6218
         _cy             =   17833
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   204
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Enabled         =   -1  'True
         Appearance      =   5
         MousePointer    =   0
         Version         =   801
         BackColor       =   -2147483633
         ForeColor       =   -2147483630
         FloodColor      =   6553600
         ForeColorDisabled=   -2147483631
         Caption         =   ""
         Align           =   0
         AutoSizeChildren=   4
         BorderWidth     =   6
         ChildSpacing    =   4
         Splitter        =   0   'False
         FloodDirection  =   0
         FloodPercent    =   0
         CaptionPos      =   1
         WordWrap        =   -1  'True
         MaxChildSize    =   0
         MinChildSize    =   0
         TagWidth        =   0
         TagPosition     =   0
         Style           =   0
         TagSplit        =   2
         PicturePos      =   4
         CaptionStyle    =   0
         ResizeFonts     =   0   'False
         GridRows        =   0
         GridCols        =   0
         Frame           =   4
         FrameStyle      =   0
         FrameWidth      =   1
         FrameColor      =   -2147483628
         FrameShadow     =   -2147483632
         FloodStyle      =   1
         _GridInfo       =   ""
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   9
         Begin VSFlex8Ctl.VSFlexGrid fgList 
            Height          =   9645
            Left            =   90
            TabIndex        =   6
            Top             =   375
            Width           =   3345
            _cx             =   74127116
            _cy             =   74138229
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   204
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483635
            ForeColorSel    =   -2147483634
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   5
            HighLight       =   1
            AllowSelection  =   0   'False
            AllowBigSelection=   0   'False
            AllowUserResizing=   1
            SelectionMode   =   1
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   1
            Cols            =   10
            FixedRows       =   1
            FixedCols       =   4
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   -1  'True
            FormatString    =   ""
            ScrollTrack     =   -1  'True
            ScrollBars      =   2
            ScrollTips      =   -1  'True
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   2
            ShowComboButton =   1
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   1
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   2
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
         End
         Begin VB.Label lblListName 
            AutoSize        =   -1  'True
            Caption         =   "Наименование списка"
            Height          =   225
            Left            =   90
            TabIndex        =   46
            Top             =   90
            Width           =   3345
         End
      End
   End
   Begin MSComctlLib.ImageList ImageList1 
      Left            =   9120
      Top             =   5280
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   32
      ImageHeight     =   32
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   14
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":15102
            Key             =   ""
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":159DC
            Key             =   ""
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":162B6
            Key             =   ""
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":16B90
            Key             =   ""
         EndProperty
         BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1746A
            Key             =   ""
         EndProperty
         BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":17D44
            Key             =   ""
         EndProperty
         BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1861E
            Key             =   ""
         EndProperty
         BeginProperty ListImage8 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":18EF8
            Key             =   ""
         EndProperty
         BeginProperty ListImage9 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":197D2
            Key             =   ""
         EndProperty
         BeginProperty ListImage10 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1A0AC
            Key             =   ""
         EndProperty
         BeginProperty ListImage11 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1A986
            Key             =   ""
         EndProperty
         BeginProperty ListImage12 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1B260
            Key             =   ""
         EndProperty
         BeginProperty ListImage13 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1BB3A
            Key             =   ""
         EndProperty
         BeginProperty ListImage14 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1C414
            Key             =   ""
         EndProperty
      EndProperty
   End
   Begin MSComctlLib.ImageList ImageList3 
      Left            =   8520
      Top             =   5280
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   32
      ImageHeight     =   32
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   43
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1CCEE
            Key             =   ""
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1D5C8
            Key             =   ""
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1DEA2
            Key             =   ""
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1E77C
            Key             =   ""
         EndProperty
         BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1F056
            Key             =   ""
         EndProperty
         BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":1FD30
            Key             =   ""
         EndProperty
         BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":2060A
            Key             =   ""
         EndProperty
         BeginProperty ListImage8 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":212E4
            Key             =   ""
         EndProperty
         BeginProperty ListImage9 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":21BBE
            Key             =   ""
         EndProperty
         BeginProperty ListImage10 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":22498
            Key             =   ""
         EndProperty
         BeginProperty ListImage11 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":22D72
            Key             =   ""
         EndProperty
         BeginProperty ListImage12 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":2364C
            Key             =   ""
         EndProperty
         BeginProperty ListImage13 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":24326
            Key             =   ""
         EndProperty
         BeginProperty ListImage14 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":25000
            Key             =   ""
         EndProperty
         BeginProperty ListImage15 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":258DA
            Key             =   ""
         EndProperty
         BeginProperty ListImage16 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":25BF4
            Key             =   ""
         EndProperty
         BeginProperty ListImage17 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":25F0E
            Key             =   ""
         EndProperty
         BeginProperty ListImage18 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":26760
            Key             =   ""
         EndProperty
         BeginProperty ListImage19 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":26FB2
            Key             =   ""
         EndProperty
         BeginProperty ListImage20 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":2788C
            Key             =   ""
         EndProperty
         BeginProperty ListImage21 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":27CD3
            Key             =   ""
         EndProperty
         BeginProperty ListImage22 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":285AD
            Key             =   ""
         EndProperty
         BeginProperty ListImage23 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":2EE0F
            Key             =   ""
         EndProperty
         BeginProperty ListImage24 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":2F261
            Key             =   ""
         EndProperty
         BeginProperty ListImage25 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":35AC3
            Key             =   ""
         EndProperty
         BeginProperty ListImage26 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":36715
            Key             =   ""
         EndProperty
         BeginProperty ListImage27 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":37A1F
            Key             =   ""
         EndProperty
         BeginProperty ListImage28 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":3E281
            Key             =   ""
         EndProperty
         BeginProperty ListImage29 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":3E59B
            Key             =   ""
         EndProperty
         BeginProperty ListImage30 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":3EE75
            Key             =   ""
         EndProperty
         BeginProperty ListImage31 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":3FAC7
            Key             =   ""
         EndProperty
         BeginProperty ListImage32 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":40719
            Key             =   ""
         EndProperty
         BeginProperty ListImage33 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":40A33
            Key             =   ""
         EndProperty
         BeginProperty ListImage34 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":40D4D
            Key             =   ""
         EndProperty
         BeginProperty ListImage35 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4199F
            Key             =   ""
         EndProperty
         BeginProperty ListImage36 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":425F1
            Key             =   ""
         EndProperty
         BeginProperty ListImage37 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":43243
            Key             =   ""
         EndProperty
         BeginProperty ListImage38 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":43B1D
            Key             =   ""
         EndProperty
         BeginProperty ListImage39 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4476F
            Key             =   ""
         EndProperty
         BeginProperty ListImage40 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":44A89
            Key             =   ""
         EndProperty
         BeginProperty ListImage41 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":45363
            Key             =   ""
         EndProperty
         BeginProperty ListImage42 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":45FB5
            Key             =   ""
         EndProperty
         BeginProperty ListImage43 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":46C07
            Key             =   ""
         EndProperty
      EndProperty
   End
   Begin MSComctlLib.StatusBar SB 
      Align           =   2  'Align Bottom
      Height          =   285
      Left            =   0
      TabIndex        =   0
      Top             =   10545
      Width           =   18000
      _ExtentX        =   31750
      _ExtentY        =   503
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   13
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   1
            AutoSize        =   2
            Enabled         =   0   'False
            Object.Width           =   926
            MinWidth        =   917
            TextSave        =   "CAPS"
         EndProperty
         BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   6
            AutoSize        =   2
            Object.Width           =   1773
            MinWidth        =   1764
            TextSave        =   "11.10.2024"
         EndProperty
         BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   5
            AutoSize        =   2
            Object.Width           =   1244
            MinWidth        =   1235
            TextSave        =   "14:59"
         EndProperty
         BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            AutoSize        =   2
            Key             =   "srv"
            Object.ToolTipText     =   "Подключенный сервер базы данных"
         EndProperty
         BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            AutoSize        =   2
            Object.Width           =   529
            MinWidth        =   529
            Key             =   "prov"
            Object.ToolTipText     =   "Используемый драйвер передачи данных"
         EndProperty
         BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            AutoSize        =   1
            Object.Width           =   17226
            MinWidth        =   2
            Key             =   "status"
         EndProperty
         BeginProperty Panel7 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            Object.Width           =   529
            MinWidth        =   529
            Key             =   "arm"
         EndProperty
         BeginProperty Panel8 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   882
            MinWidth        =   882
            Key             =   "listmass"
            Object.ToolTipText     =   "Общая масса стали в списке"
         EndProperty
         BeginProperty Panel9 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   882
            MinWidth        =   882
            Key             =   "reinmass"
            Object.ToolTipText     =   "Общая масса арматуры"
         EndProperty
         BeginProperty Panel10 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   882
            MinWidth        =   882
            Key             =   "specmass"
            Object.ToolTipText     =   "Общая масса стали в спецификации изделий"
         EndProperty
         BeginProperty Panel11 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   882
            MinWidth        =   882
            Key             =   "offtmass"
            Object.ToolTipText     =   "Общая масса стали в выборке"
         EndProperty
         BeginProperty Panel12 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            AutoSize        =   2
            Object.Width           =   1773
            MinWidth        =   1764
            Key             =   "partqty"
            Object.ToolTipText     =   "Количество изделий для копирования"
         EndProperty
         BeginProperty Panel13 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            AutoSize        =   2
            Object.Width           =   926
            MinWidth        =   176
            Text            =   "docs  "
            TextSave        =   "docs  "
            Key             =   "queue"
            Object.ToolTipText     =   "Количество документов в очереди (щелкните для обновления)"
         EndProperty
      EndProperty
   End
   Begin MSComctlLib.ProgressBar PB 
      Align           =   2  'Align Bottom
      Height          =   255
      Left            =   0
      TabIndex        =   1
      Top             =   10290
      Width           =   18000
      _ExtentX        =   31750
      _ExtentY        =   450
      _Version        =   393216
      Appearance      =   1
      Min             =   1e-4
   End
   Begin MSComctlLib.ImageList ImageList2 
      Left            =   0
      Top             =   0
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   42
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":46F21
            Key             =   "catalog"
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":47D73
            Key             =   "block"
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4808D
            Key             =   "building"
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":48967
            Key             =   "project"
         EndProperty
         BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":49241
            Key             =   "part0"
         EndProperty
         BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4AF4B
            Key             =   "type"
         EndProperty
         BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4BD9D
            Key             =   "reincat"
         EndProperty
         BeginProperty ListImage8 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4CBEF
            Key             =   "sheet"
         EndProperty
         BeginProperty ListImage9 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4DAC9
            Key             =   "descr"
         EndProperty
         BeginProperty ListImage10 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":4E91B
            Key             =   "part1"
         EndProperty
         BeginProperty ListImage11 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":50625
            Key             =   "part_tmp"
         EndProperty
         BeginProperty ListImage12 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5232F
            Key             =   "part2"
         EndProperty
         BeginProperty ListImage13 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":54039
            Key             =   "link"
         EndProperty
         BeginProperty ListImage14 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":55D43
            Key             =   "part3"
         EndProperty
         BeginProperty ListImage15 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":57A4D
            Key             =   "catlist"
         EndProperty
         BeginProperty ListImage16 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":59757
            Key             =   "catlist_def"
         EndProperty
         BeginProperty ListImage17 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5B461
            Key             =   "catalog_locked"
         EndProperty
         BeginProperty ListImage18 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5C2B3
            Key             =   "reincat_locked"
         EndProperty
         BeginProperty ListImage19 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5D105
            Key             =   "stat"
         EndProperty
         BeginProperty ListImage20 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5D557
            Key             =   "attach"
         EndProperty
         BeginProperty ListImage21 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5D8A9
            Key             =   "gal1"
         EndProperty
         BeginProperty ListImage22 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5DBFB
            Key             =   "reincat_open_st3"
         EndProperty
         BeginProperty ListImage23 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5EA4D
            Key             =   "catalog_closed_st0"
         EndProperty
         BeginProperty ListImage24 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":5F89F
            Key             =   "catalog_closed_st1"
         EndProperty
         BeginProperty ListImage25 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":606F1
            Key             =   "catalog_closed_st2"
         EndProperty
         BeginProperty ListImage26 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":61543
            Key             =   "catalog_closed_st3"
         EndProperty
         BeginProperty ListImage27 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":62395
            Key             =   "catalog_open_st0"
         EndProperty
         BeginProperty ListImage28 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":631E7
            Key             =   "catalog_open_st1"
         EndProperty
         BeginProperty ListImage29 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":64039
            Key             =   "catalog_open_st2"
         EndProperty
         BeginProperty ListImage30 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":64E8B
            Key             =   "catalog_open_st3"
         EndProperty
         BeginProperty ListImage31 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":65CDD
            Key             =   "reincat_closed_st0"
         EndProperty
         BeginProperty ListImage32 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":66B2F
            Key             =   "reincat_closed_st1"
         EndProperty
         BeginProperty ListImage33 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":67981
            Key             =   "reincat_closed_st2"
         EndProperty
         BeginProperty ListImage34 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":687D3
            Key             =   "reincat_closed_st3"
         EndProperty
         BeginProperty ListImage35 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":69625
            Key             =   "reincat_open_st0"
         EndProperty
         BeginProperty ListImage36 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6A477
            Key             =   "reincat_open_st1"
         EndProperty
         BeginProperty ListImage37 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6B2C9
            Key             =   "reincat_open_st2"
         EndProperty
         BeginProperty ListImage38 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6C11B
            Key             =   "pwfolder"
         EndProperty
         BeginProperty ListImage39 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6C46D
            Key             =   "pwmod"
         EndProperty
         BeginProperty ListImage40 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6C787
            Key             =   "pwset"
         EndProperty
         BeginProperty ListImage41 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6CAA1
            Key             =   "pwcat"
         EndProperty
         BeginProperty ListImage42 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6CDBB
            Key             =   "pwfld"
         EndProperty
      EndProperty
   End
   Begin MSComctlLib.ImageList ImageList4 
      Left            =   0
      Top             =   0
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   32
      ImageHeight     =   32
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   7
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6D355
            Key             =   "copyleft"
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6DFA7
            Key             =   "copyright"
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6EBF9
            Key             =   "moveleft"
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":6F84B
            Key             =   "moveright"
         EndProperty
         BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":7049D
            Key             =   "replaceleft"
         EndProperty
         BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":710EF
            Key             =   "replaceright"
         EndProperty
         BeginProperty ListImage7 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "Form1.frx":71D41
            Key             =   "reload"
         EndProperty
      EndProperty
   End
   Begin VSFlex8Ctl.VSFlexGrid fgExcel 
      Height          =   7815
      Left            =   0
      TabIndex        =   88
      Top             =   0
      Visible         =   0   'False
      Width           =   3735
      _cx             =   6588
      _cy             =   13785
      Appearance      =   1
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   204
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483642
      FocusRect       =   1
      HighLight       =   1
      AllowSelection  =   -1  'True
      AllowBigSelection=   -1  'True
      AllowUserResizing=   0
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   50
      Cols            =   10
      FixedRows       =   1
      FixedCols       =   0
      RowHeightMin    =   0
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   ""
      ScrollTrack     =   0   'False
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   0
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
   Begin VB.Menu mnuList 
      Caption         =   "Список"
      Begin VB.Menu mnuListGoHome 
         Caption         =   "Скрыть"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuListSep3 
         Caption         =   "-"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuListCreate 
         Caption         =   "Создать"
         Enabled         =   0   'False
         Visible         =   0   'False
      End
      Begin VB.Menu mnuListClear 
         Caption         =   "Очистить"
      End
      Begin VB.Menu mnuListSort 
         Caption         =   "Выполнить сортировку"
      End
      Begin VB.Menu mnuListCopy 
         Caption         =   "Копировать список в буфер"
      End
      Begin VB.Menu mnuListLoadFromModelTags 
         Caption         =   "Загрузить из файла модели (MicroStation)"
      End
      Begin VB.Menu mnuListSaveExcel 
         Caption         =   "Сохранить в файл Excel"
      End
      Begin VB.Menu mnuListDelMarkedRows 
         Caption         =   "Удалить помеченные строки"
      End
      Begin VB.Menu mnuListReplaceFromCurCat 
         Caption         =   "Исправить для текущего каталога"
      End
      Begin VB.Menu mnuListSep1 
         Caption         =   "-"
      End
      Begin VB.Menu mnuListSync 
         Caption         =   "Загружать синхронно"
         Begin VB.Menu mnuListSyncLoad 
            Caption         =   "Каталог по списку"
         End
         Begin VB.Menu mnuListSyncList 
            Caption         =   "Главный список по каталогу"
         End
      End
      Begin VB.Menu mnuListSortAuto 
         Caption         =   "Сортировать при добавлении"
      End
      Begin VB.Menu mnuListSep2 
         Caption         =   "-"
      End
      Begin VB.Menu mnuListExit 
         Caption         =   "Выход"
      End
   End
   Begin VB.Menu mnuPref 
      Caption         =   "Настройки"
      Begin VB.Menu mnuPrefCatDelConfirm 
         Caption         =   "Подтверждать удаление объектов"
      End
      Begin VB.Menu mnuPrefLoadListByView 
         Caption         =   "Загрузка списка через представление"
      End
      Begin VB.Menu mnuPrefPdSortByUse 
         Caption         =   "Сортировка определений по использованию"
      End
      Begin VB.Menu mnuPrefShowGridIcons 
         Caption         =   "Отображать значки таблиц"
      End
      Begin VB.Menu mnuPrefSep44 
         Caption         =   "-"
      End
      Begin VB.Menu mnuPrefLap 
         Caption         =   "Рассчитывать нахлёст арматуры"
      End
      Begin VB.Menu mnuPrefSep1 
         Caption         =   "-"
      End
      Begin VB.Menu mnuPrefPDSet 
         Caption         =   "Наборы определений"
         Begin VB.Menu mnuPrefPosdefSet 
            Caption         =   "стандартный"
            Index           =   0
         End
         Begin VB.Menu mnuPrefPosdefSet 
            Caption         =   ""
            Index           =   1
            Visible         =   0   'False
         End
         Begin VB.Menu mnuPrefPosdefSet 
            Caption         =   ""
            Index           =   2
            Visible         =   0   'False
         End
         Begin VB.Menu mnuPrefPosdefSet 
            Caption         =   ""
            Index           =   3
            Visible         =   0   'False
         End
         Begin VB.Menu mnuPrefPosdefSet 
            Caption         =   ""
            Index           =   4
            Visible         =   0   'False
         End
      End
      Begin VB.Menu mnuPrefRound03 
         Caption         =   "Округление значений..."
      End
      Begin VB.Menu mnuPrefUseRein 
         Caption         =   "Эскизы арматуры в MicroStation..."
      End
      Begin VB.Menu mnuPrefLoadPics 
         Caption         =   "Загрузка PDF файлов..."
      End
      Begin VB.Menu mnuPrefConnect 
         Caption         =   "База данных..."
      End
   End
   Begin VB.Menu mnuView 
      Caption         =   "Вид"
      Begin VB.Menu mnuViewOnTop 
         Caption         =   "Всегда сверху"
      End
      Begin VB.Menu mnuViewCats 
         Caption         =   "Загружаемые каталоги"
         Begin VB.Menu mnuViewCatsStat 
            Caption         =   "Разработка"
            Index           =   0
         End
         Begin VB.Menu mnuViewCatsStat 
            Caption         =   "Проверено"
            Index           =   1
         End
         Begin VB.Menu mnuViewCatsStat 
            Caption         =   "Выпущено"
            Index           =   2
         End
         Begin VB.Menu mnuViewCatsStat 
            Caption         =   "Не используется"
            Index           =   3
         End
      End
      Begin VB.Menu mnuViewShowPart 
         Caption         =   "Показывать изображение изделия"
      End
   End
   Begin VB.Menu mnuCatsTree 
      Caption         =   "Каталоги"
      Visible         =   0   'False
      Begin VB.Menu mnuCatsTreeReload 
         Caption         =   "Обновить"
      End
      Begin VB.Menu mnuCatsTreeAccess 
         Caption         =   "Доступ..."
      End
      Begin VB.Menu mnuCatsTreeUnif 
         Caption         =   "Унифицированный"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreePassive 
         Caption         =   "Пассивный расчет выборки"
      End
      Begin VB.Menu mnuCatsTreeUserSpec 
         Caption         =   "Спецификация"
         Begin VB.Menu mnuCatsTreeUserSpecVal 
            Caption         =   "По умолчанию"
            Index           =   0
         End
      End
      Begin VB.Menu mnuCatsTreeTest 
         Caption         =   "Тестовый"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeSep2 
         Caption         =   "-"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeLoad 
         Caption         =   "Загрузить как изделия"
      End
      Begin VB.Menu mnuCatsTreeReinLoad 
         Caption         =   "Загрузить как арматуру"
      End
      Begin VB.Menu mnuCatsTreeSetList 
         Caption         =   "Назначить главным (по умолчанию)"
      End
      Begin VB.Menu mnuCatsTreeBindDgn 
         Caption         =   "Назначить файлу модели"
      End
      Begin VB.Menu mnuCatsTreeBeton 
         Caption         =   "Бетон..."
      End
      Begin VB.Menu mnuCatsTreeSep100 
         Caption         =   "-"
      End
      Begin VB.Menu mnuCatsTreeCopy 
         Caption         =   "Копировать в буфер"
      End
      Begin VB.Menu mnuCatsTreePaste 
         Caption         =   "Создать копию из буфера"
      End
      Begin VB.Menu mnuCatsTreeCopyHere 
         Caption         =   "Создать копию"
      End
      Begin VB.Menu mnuCatsTreeSep10 
         Caption         =   "-"
      End
      Begin VB.Menu mnuCatsTreeRenameItem 
         Caption         =   "Переименовать"
      End
      Begin VB.Menu mnuCatsTreeDeleteItem 
         Caption         =   "Удалить"
      End
      Begin VB.Menu mnuCatsTreeSep1 
         Caption         =   "-"
      End
      Begin VB.Menu mnuCatsTreeCreateBlock 
         Caption         =   "Новый блок"
      End
      Begin VB.Menu mnuCatsTreeCreateBuilding 
         Caption         =   "Добавить здание"
         WindowList      =   -1  'True
         Begin VB.Menu mnuCatsTreeCreateBuilding0 
            Caption         =   "пример"
            Index           =   0
         End
      End
      Begin VB.Menu mnuCatsTreeCreateCatalog 
         Caption         =   "Создать каталог изделий"
      End
      Begin VB.Menu mnuCatsTreeCreateReinCat 
         Caption         =   "Создать каталог арматуры"
      End
      Begin VB.Menu mnuCatsTreeCreateList 
         Caption         =   "Создать список"
      End
      Begin VB.Menu mnuCatsTreeUpdateCatlist 
         Caption         =   "Занести в список подкаталоги"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeGetIds 
         Caption         =   "IDs в буфер"
      End
      Begin VB.Menu mnuCatsTreeSep3 
         Caption         =   "-"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeDocSet 
         Caption         =   "Документы..."
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeCmdLeft 
         Caption         =   "На левую панель"
         Enabled         =   0   'False
         Visible         =   0   'False
      End
      Begin VB.Menu mnuCatsTreeCmdRight 
         Caption         =   "На правую панель"
         Enabled         =   0   'False
         Visible         =   0   'False
      End
   End
   Begin VB.Menu mnuReinGrid 
      Caption         =   "Арматура"
      Visible         =   0   'False
      Begin VB.Menu mnuReinGridLap 
         Caption         =   "Рассчитывать нахлёст"
      End
      Begin VB.Menu mnuReinGridCont 
         Caption         =   "Основной сегмент переменной длины"
      End
      Begin VB.Menu mnuReinGridProps 
         Caption         =   "Дополнительные свойства..."
         Visible         =   0   'False
      End
      Begin VB.Menu mnuReinGridBlock 
         Caption         =   "Блокировать для обновления из модели"
      End
      Begin VB.Menu mnuReinGridPasteLengths 
         Caption         =   "Вставить данные из буфера"
         Visible         =   0   'False
         Begin VB.Menu mnuReinGridPasteLengths1 
            Caption         =   "L="
            Index           =   0
         End
      End
      Begin VB.Menu mnuReinGridSep2 
         Caption         =   "-"
      End
      Begin VB.Menu mnuReinGridDrawSketch 
         Caption         =   "Разместить эскиз"
      End
      Begin VB.Menu mnuReinGridSep1 
         Caption         =   "-"
      End
      Begin VB.Menu mnuReinGridSetUnavailable 
         Caption         =   "Отсутствует"
      End
      Begin VB.Menu mnuReinGridDelete 
         Caption         =   "Удалить"
      End
   End
   Begin VB.Menu mnuPartsTree 
      Caption         =   "Детали"
      Visible         =   0   'False
      Begin VB.Menu mnuPartsTreeNoParent 
         Caption         =   "Убрать зависимость"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuPartsTreeGoLink 
         Caption         =   "Перейти по ссылке"
      End
      Begin VB.Menu mnuPartsTreeCopyHere 
         Caption         =   "Копировать здесь"
      End
      Begin VB.Menu mnuPartsTreeCopy 
         Caption         =   "Копировать"
      End
      Begin VB.Menu mnuPartsTreeRestore 
         Caption         =   "Восстановить"
      End
      Begin VB.Menu mnuPartsTreeErase 
         Caption         =   "Стереть"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuPartsTreeEraseAll 
         Caption         =   "Стереть все (очистить корзину)"
      End
      Begin VB.Menu mnuPartsTreeDeleteChecked 
         Caption         =   "Удалить отмеченные"
      End
      Begin VB.Menu mnuPartsTreeDelete 
         Caption         =   "Удалить"
      End
      Begin VB.Menu mnuPartsTreeSep1 
         Caption         =   "-"
      End
      Begin VB.Menu mnuPartsTreeStatus 
         Caption         =   "Установить статус"
         Begin VB.Menu mnuPartsTreeStatusVal 
            Caption         =   "Разработка"
            Index           =   0
         End
         Begin VB.Menu mnuPartsTreeStatusVal 
            Caption         =   "Проверено"
            Index           =   1
         End
         Begin VB.Menu mnuPartsTreeStatusVal 
            Caption         =   "Выпущено"
            Index           =   2
         End
         Begin VB.Menu mnuPartsTreeStatusVal 
            Caption         =   "Не используется"
            Index           =   3
         End
      End
      Begin VB.Menu mnuPartsTreeDocSet 
         Caption         =   "Документы..."
      End
      Begin VB.Menu mnuPartsTreeFile 
         Caption         =   "Загрузить изображение"
      End
      Begin VB.Menu mnuPartsTreePart 
         Caption         =   "Изд."
      End
   End
   Begin VB.Menu mnuPositions 
      Caption         =   "Позиции"
      Visible         =   0   'False
      Begin VB.Menu mnuPositionsMC 
         Caption         =   "пример"
         Index           =   0
      End
   End
   Begin VB.Menu mnuCatParts 
      Caption         =   "Изделия каталога"
      Visible         =   0   'False
      Begin VB.Menu mnuCatPartsOpen 
         Caption         =   "Открыть"
      End
      Begin VB.Menu mnuCatPartsCopy 
         Caption         =   "Копировать"
      End
      Begin VB.Menu mnuCatPartsLinks 
         Caption         =   "Вставить (ссылка)"
      End
      Begin VB.Menu mnuCatPartsPaste 
         Caption         =   "Создать копию"
      End
   End
   Begin VB.Menu mnuHelp 
      Caption         =   "Помощь"
      Begin VB.Menu mnuHelpAbout 
         Caption         =   "О программе..."
      End
      Begin VB.Menu mnuHelpNew 
         Caption         =   "Что нового?..."
      End
      Begin VB.Menu mnuHelpVideo 
         Caption         =   "Обучающее видео..."
      End
      Begin VB.Menu mnuHelpUpdateSim 
         Caption         =   "Обновить AECOsim..."
      End
   End
   Begin VB.Menu mnuListRows 
      Caption         =   "СписокКонтекст"
      Visible         =   0   'False
      Begin VB.Menu mnuListRowsDelete 
         Caption         =   "Удалить отмеченные"
      End
      Begin VB.Menu mnuListRowsGo 
         Caption         =   "Перейти к изделию"
      End
      Begin VB.Menu mnuListRowsBack 
         Caption         =   "Назад"
      End
      Begin VB.Menu mnuListRowsFwd 
         Caption         =   "Вперед"
      End
   End
   Begin VB.Menu mnuCatFiles 
      Caption         =   "ФайлыКонтекст"
      Visible         =   0   'False
      Begin VB.Menu mnuCatFilesOpenFile 
         Caption         =   "Открыть файл"
      End
      Begin VB.Menu mnuCatFilesOpenDir 
         Caption         =   "Открыть папку"
      End
   End
   Begin VB.Menu mnuReinCat 
      Caption         =   "Арм.каталог"
      Visible         =   0   'False
      Begin VB.Menu mnuReinCatApply 
         Caption         =   "Применить ко всем позициям"
      End
   End
   Begin VB.Menu mnuLabel 
      Caption         =   "Лабел"
      Visible         =   0   'False
      Begin VB.Menu mnuLabelCopy 
         Caption         =   "Копировать путь каталога"
      End
      Begin VB.Menu mnuLabelCat 
         Caption         =   ""
         Index           =   0
         Visible         =   0   'False
      End
   End
   Begin VB.Menu mnuPart 
      Caption         =   "ИздАтрКонтекст"
      Visible         =   0   'False
      Begin VB.Menu mnuPartApply 
         Caption         =   "Применить к выделенным"
      End
   End
   Begin VB.Menu mnuOfftMass 
      Caption         =   "mnuOfftMass"
      Visible         =   0   'False
      Begin VB.Menu mnuOfftMassLevel 
         Caption         =   ""
         Index           =   0
      End
   End
   Begin VB.Menu mnuSimData 
      Caption         =   "СимДатаКонтекст"
      Visible         =   0   'False
      Begin VB.Menu mnuSimDataCodes 
         Caption         =   "Зафиксировать"
      End
   End
   Begin VB.Menu mnuSimFiles 
      Caption         =   "СимФайлы"
      Visible         =   0   'False
      Begin VB.Menu mnuSimFilesReprocess 
         Caption         =   "Перезапуск обработки файла"
      End
      Begin VB.Menu mnuSimFilesLinks 
         Caption         =   "Ссылки..."
      End
   End
   Begin VB.Menu mnuWiseTree 
      Caption         =   "Wise"
      Visible         =   0   'False
      Begin VB.Menu mnuWiseTreeOpenBld 
         Caption         =   "Модель строительной части"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuWiseTreeOpenTech 
         Caption         =   "Модель с технологией"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuWiseTreeNodeReload 
         Caption         =   "Обновить"
         Visible         =   0   'False
      End
      Begin VB.Menu mnuWiseTreeCmdInc 
         Caption         =   "Включить"
      End
      Begin VB.Menu mnuWiseTreeCmdOut 
         Caption         =   "Исключить"
      End
      Begin VB.Menu mnuWiseTreeCmdBack 
         Caption         =   "Вернуть"
      End
      Begin VB.Menu mnuWiseTreeSearch 
         Caption         =   "Поиск..."
      End
   End
   Begin VB.Menu mnuCatsTreePW 
      Caption         =   "Каталоги PW"
      Visible         =   0   'False
      Begin VB.Menu mnuCatsTreePWEmb 
         Caption         =   "Каталог изделий"
      End
      Begin VB.Menu mnuCatsTreePWArm 
         Caption         =   "Каталог арматуры"
      End
   End
End
Attribute VB_Name = "F1"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

'Dim WithEvents Arm_2D1 As Rein2D_prj.Rein2d

Dim strTreeCatsLabelBeforeEdit As String

Dim iLoadedMenuBuildings As Integer

Dim iListRemPos As Integer
Dim arListRem() As Long

Dim iCatRemPos As Integer
Dim iCatRemMenu As Integer
Dim colCatRem As New Collection

Public iImportLeftLevel As Integer
Public iImportRightLevel As Integer

Public curPart As clsPart
Public curPos As clsPos ' for rein grid

Public curSrtmPos As clsSrtm
Public curMatPos As clsMat
Public curPosdef As clsPD
Public curStdPd As clsStdPd

Public lngCheckedPartID As Long
Public bChecking As Boolean

Public offts As New Collection

Public curRoom As clsRoom

Public spec As clsSG


Private dDragX As Double
Private dDragY As Double


Public bListSelecting As Boolean

Private nChecked As Node
Private bShift As Boolean
Private bCheck As Boolean
Private bCtrl As Boolean

Private bWise As Boolean

Private arCopyParts() As Long
Private iCopyPartsCount As Long

Private bListDrag As Boolean

Private bReinGridLeftRight As Boolean

Dim WithEvents RSSev As ADODB.Recordset
Attribute RSSev.VB_VarHelpID = -1

Public dOfftVal As Double


Private arSketchRow(1 To 2) As Long

Private lngCmdCatIDs(1 To 2) As Long

Dim tt As CBalloonToolTip

Dim pos(1) As clsPos

Private sCmdPath(0 To 1) As String
'Private sCmdDisp(0 To 1) As String

Public iLastOfftMode As Integer


Private iCurOfft As Integer

Public fgSimCrntGlob As VSFlexGrid


'/******************************************************************************
Private Function loadArm() As Boolean
'/******************************************************************************

    On Error GoTo loadArm_ERR

'    Set Arm_2D1 = Controls.Add("Rein2D_prj.Rein2d", "Rein2d", Me.elBar)

    Arm_2D1.Visible = True

    Arm_2D1.setAngleRound 0, 10, 0
    Arm_2D1.setArcRound -1, CLng(rndGlobal.iArmArcSnap), CLng(rndGlobal.iArmArc)
    Arm_2D1.setLineRound -1, CLng(rndGlobal.iArmSegmSnap), CLng(rndGlobal.iArmSegm)
    
    

    loadArm = True

Exit Function

loadArm_ERR:
    Me.SB.Panels("status").text = err.Description

End Function



Private Sub C1Elastic14_ResizeChildren()

        C1Elastic15.width = C1Elastic14.width / 2
        C1Elastic14.AutoSizeChildren = azUnevenHorz



End Sub


Private Sub C1Elastic9_ResizeChildren()

    If fgCatParts.height > C1Elastic9.height / 10 * 9 Then fgCatParts.height = C1Elastic9.height / 10 * 9
    C1Elastic9.AutoSizeChildren = azUnevenVert


End Sub


Private Sub cmbCmd_Click(Index As Integer)
    Call loadCmd(Index)

End Sub

Private Sub elBar_ResizeChildren()

    elBar.AutoSizeChildren = azUnevenHorz
    
End Sub



Public Sub elFgPosGrid_ResizeChildren()

       fgPositions.ColHidden(4) = True
       fgPositions.ColWidth(0) = elFgPosGrid.width / 10 * 6
       fgPositions.ColWidth(1) = elFgPosGrid.width / 10
       fgPositions.ColWidth(2) = elFgPosGrid.width / 10 * 1.2
       fgPositions.ColWidth(3) = elFgPosGrid.width / 10
       

End Sub



'/******************************************************************************
Public Sub fgCatPartsSetRowData(Row As Long, p As clsPos, bSumChanged As Boolean, bUpdateComMass As Boolean)
'/******************************************************************************
    
    On Error GoTo fgCatPartsSetRowData_ERR
    
    Dim bLap As Boolean
    Dim dPosLength As Double
    Dim sPosLength As String
    
    With fgCatParts
        
        
        .TextMatrix(Row, .ColIndex("num")) = p.parentPart.partName
        
        dPosLength = p.getPosLength(p.bCalcLap, bLap)
        If p.getPosLength(p.bCalcLap, bLap) = 0# Then sPosLength = "" Else sPosLength = dPosLength
        .TextMatrix(Row, .ColIndex("length")) = sPosLength
        .Cell(flexcpFontUnderline, Row, .ColIndex("length")) = bLap
        
        .TextMatrix(Row, .ColIndex("posdef")) = p.POS_PD_NAME '2
        .TextMatrix(Row, .ColIndex("std")) = p.POS_STD_FULLNUMBER '3
        .TextMatrix(Row, .ColIndex("srtm")) = p.POS_SRTM.srtmName '4
        .TextMatrix(Row, .ColIndex("qty")) = Round(p.posQty, 3) '6
        .TextMatrix(Row, .ColIndex("masslength")) = p.POS_MASS_SRTM ' ?'7
        .TextMatrix(Row, .ColIndex("umass")) = p.POS_UMASS '8
        .TextMatrix(Row, .ColIndex("cmass")) = p.POS_CMASS '9
        .TextMatrix(Row, .ColIndex("mat")) = p.POS_MAT.matName '10
        .TextMatrix(Row, .ColIndex("sketch")) = p.bSketch
        
        
        If p.bIsReinDefault Then
            .TextMatrix(Row, .ColIndex("umass")) = ""
            .TextMatrix(Row, .ColIndex("cmass")) = ""
            .Cell(flexcpBackColor, Row, 0, Row, .cols - 1) = lngNewRowColor
        Else
        
            .Cell(flexcpBackColor, Row, 0, Row, .cols - 1) = lngRowWinColor
            
            If p.bUMCalc Then
                .Cell(flexcpBackColor, Row, .ColIndex("umass")) = lngRowColor
            Else
                .Cell(flexcpBackColor, Row, .ColIndex("umass")) = lngGrey
            End If
            
            If p.bCMCalc Then
                .Cell(flexcpBackColor, Row, .ColIndex("cmass")) = lngRowColor
            Else
                .Cell(flexcpBackColor, Row, .ColIndex("cmass")) = lngGrey
            End If
            
        End If
        
        
        
        
        .Cell(flexcpForeColor, Row, .ColIndex("masslength")) = lngDarkGrey
        
        
        .TextMatrix(Row, .ColIndex("objID")) = objs("position")
        .TextMatrix(Row, .ColIndex("ID")) = p.posID
        .TextMatrix(Row, .ColIndex("stdID")) = p.POS_STD.stdID
        .TextMatrix(Row, .ColIndex("posdefID")) = p.POS_PD.pdID
        .TextMatrix(Row, .ColIndex("stdpdID")) = p.POS_STDPD.stdpdID
        .TextMatrix(Row, .ColIndex("srtmID")) = p.POS_SRTM.srtmID
        .TextMatrix(Row, .ColIndex("matID")) = p.POS_MAT.matID
        .TextMatrix(Row, .ColIndex("mcID")) = p.POS_MCALC.mcID
        .TextMatrix(Row, .ColIndex("partID")) = p.getPartID
        .TextMatrix(Row, .ColIndex("numDigits")) = p.numDigits
        .TextMatrix(Row, .ColIndex("roundshift")) = p.parentPart.iRoundLocalShift
        .TextMatrix(Row, .ColIndex("roundsaved")) = p.parentPart.bRoundDefined
        
        
        If bUpdateComMass Then
            updateComMassRows
        Else
            If p.bMustUpdate Or (p.bCMCalc And Not dblCmp(p.posCMass, getDbl(p.POS_CMASS), 3)) Then
                .Cell(flexcpBackColor, Row, 0, Row, .cols - 1) = lngLightRed
                .RowData(Row) = "проблема: несоответствие масс по расчету и в базе данных, требуется обновление массы (каталог блокирован для редактирования?)"
            End If
        End If
        
        If bFormGridsIcons Then
        If p.bNotOnly Then
            .Cell(flexcpPicture, Row, .ColIndex("num")) = ImageList2.ListImages("attach").ExtractIcon
        End If
        End If
        
        If Len(Trim(p.posNote)) > 0 Then
            .RowData(Row) = Trim(p.posNote)
        End If
        
        
        If p.bDups Then
            .Cell(flexcpBackColor, Row, .ColIndex("num")) = lngLightRed
            .RowData(Row) = "проблема: дублирование изделий, решение: загрузите каталог 'как изделия' и удалите дублирующиеся позиции"
'            .Cell(flexcpBackColor, Row, 0, Row, .cols - 1) = lngLightRed
        End If
        
'        .Cell(flexcpTextStyle, Row, 0, Row, .cols - 1) = 4
        
        
    End With
    
    
    If bSumChanged Then calcReinGridSum
    

    
    
    Exit Sub
    
fgCatPartsSetRowData_ERR:
    SB.Panels("status").text = "fgCatPartsSetRowData() - " & err.Description
    
End Sub

Private Sub elList_ResizeChildren()
    fgList.ColWidthMax = fgList.width * 0.75

End Sub

Private Sub elTvParts_DragOver(source As Control, X As Single, Y As Single, State As Integer)

Set tvParts.DropHighlight = Nothing


End Sub


'/******************************************************************************
Public Function getReinPos(Row As Long, ByRef pos As clsPos, Optional strWhere As String = "", Optional bMsgbOx As Boolean = True) As Boolean
'/******************************************************************************
    
    On Error GoTo getReinPos_ERR
    
    If Row < 1 Then Exit Function
    
    If Row > colRein2.Count Then Exit Function
    
    Set pos = colRein2(Row)
    
    If Len(strWhere) > 0 Then ' check
        
        Dim posID As Long
        Dim partID As Long
        
        partID = Val(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("partID")))
        posID = Val(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("ID")))
        
        If pos.getPartID <> partID Then
            err.Raise 100, , strWhere & " - getReinPos() - partID wrong"
        End If
        
        If pos.posID <> posID Then
            err.Raise 100, , strWhere & " - getReinPos() - posID wrong"
        End If
        
    End If
    
    If pos.posNumber = 0 Then pos.posNumber = 1
    
    getReinPos = True
    
    
    Exit Function
    
getReinPos_ERR:
    SB.Panels("status").text = err.Description
    If bMsgbOx Then MsgBox err.Description, vbCritical, ""
    getReinPos = False
    
End Function


'/******************************************************************************
Private Sub fgCatFiles_DblClick()
'/******************************************************************************

    On Error GoTo fgCatFiles_DblClick_ERR



    If fgCatFiles.Row < 1 Then Exit Sub

    ShellExecute 0, "open", fgCatFiles.TextMatrix(fgCatFiles.Row, 1), "", "", 1


'    Dim ar() As String
'    Dim strDir As String
'    ar = Split(fgCatFiles.TextMatrix(fgCatFiles.Row, 1), "\")
'    strDir = Replace(fgCatFiles.TextMatrix(fgCatFiles.Row, 1), "\" & ar(UBound(ar)), "")
'
'    Dim sh As New Shell
'    sh.Explore strDir
'    Set sh = Nothing

Exit Sub

fgCatFiles_DblClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatFiles_DblClick - Error"

End Sub

'/******************************************************************************
Private Sub fgCatFiles_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************

    On Error GoTo fgCatFiles_KeyDown_ERR

    
    If Not checkCatPerm(lngCurCatTreeSelectedID) Then Exit Sub
    If Not checkGroupPerm(0, "catlist", operModify) Then Exit Sub
    
    Dim sIDs As String
    
    Dim i As Long
    
    If KeyCode = 46 And Shift = 1 And fgCatFiles.Rows > 1 Then
        
        For i = 1 To fgCatFiles.Rows - 1
            If fgCatFiles.IsSelected(i) And Val(fgCatFiles.TextMatrix(i, 3)) = 0 Then
                If Len(sIDs) > 0 Then sIDs = sIDs & ","
                sIDs = sIDs & Val(fgCatFiles.TextMatrix(i, 0))
            End If
        Next i
        
        If Len(sIDs) = 0 Then Exit Sub
        
        Dim iRecordsAffected As Integer
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        cmd.CommandText = "delete from [filestable] where fileID in (" & sIDs & ")"
        cmd.Execute iRecordsAffected
        Set cmd = Nothing
        
        If iRecordsAffected > 0 Then
            For i = 1 To fgCatFiles.Rows - 1
                If i >= fgCatFiles.Rows Then Exit For
                If fgCatFiles.IsSelected(i) And Val(fgCatFiles.TextMatrix(i, 3)) = 0 Then fgCatFiles.RemoveItem i: i = i - 1
            Next i
        End If
        
        If iRecordsAffected > 0 Then writeOperationS operModify, "catalog", lngCurCatTreeSelectedID, "удаление файлов (" & iRecordsAffected & " шт.)"

        
        
    End If
    
    
Exit Sub

fgCatFiles_KeyDown_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatFiles_KeyDown - Error"

End Sub

Private Sub fgCatFiles_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)


On Error Resume Next

'    If fgCatFiles.Row < 1 Then Exit Sub

    If fgCatFiles.MouseRow < 0 Then Exit Sub
    If fgCatFiles.MouseCol < 0 Then Exit Sub


    If Button = 2 Then
        fgCatFiles.Select fgCatFiles.MouseRow, fgCatFiles.MouseCol
        PopupMenu mnuCatFiles, , , , mnuCatFilesOpenFile
    End If


End Sub

Private Sub fgCatFiles_OLEDragDrop(Data As VSFlex8Ctl.VSDataObject, Effect As Long, ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    
    Dim i As Integer
    Dim j As Integer
    Dim bEx As Boolean
    Dim fileID As Long
    
    If Not checkCatPerm(lngCurCatTreeSelectedID) Then Exit Sub
    If Not checkGroupPerm(0, "catlist", operModify) Then Exit Sub
    
    Dim ct As clsCat
    Set ct = cCats(CStr(lngCurCatTreeSelectedID))
    
    If ct.iStatus <> pstRazrabotka Then Exit Sub
    
    Dim cnt As Integer
    
    Dim ar() As String
    
    For i = 0 To Data.FileCount - 1
    
        ar = Split(Data.Files(i), "\")
        
        bEx = False
        
        For j = 1 To fgCatFiles.Rows - 1
            If LCase(fgCatFiles.TextMatrix(j, 1)) = LCase(Data.Files(i)) Then
                bEx = True
                Exit For
            End If
        Next j
        
        If Not bEx And (LCase(right(Data.Files(i), 4)) = ".dgn" Or LCase(right(Data.Files(i), 4)) = ".csv") Then
        
            fileID = insertDataInBase(cn_data, "filestable", "fileFullPath", Data.Files(i), "catID", lngCurCatTreeSelectedID)
            If fileID > 0 Then
                fgCatFiles.AddItem fileID & vbTab & Data.Files(i) & vbTab & ar(UBound(ar))
                cnt = cnt + 1
            End If
        End If
        
    Next i
    
    fgCatFiles.AutoSize 0, fgCatFiles.cols - 1
    
    fgCatFiles.ColHidden(0) = True
    fgCatFiles.ColHidden(1) = True
    
    If cnt > 0 Then writeOperationS operModify, "catalog", ct.catID, "добавление файлов (" & cnt & " шт.)"
    
    
End Sub

'/******************************************************************************
Public Sub fgCatParts_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgCatParts_AfterEdit_ERR

    
    Dim posID As Long
    Dim stdID As Long
    Dim posdefID As Long
    Dim stdposdefID As Long
    Dim srtmID As Long
    Dim matID As Long
    
    
    Dim mcName As String
    Dim dLength As Double
    Dim dQty As Double
    Dim dUMass As Double
    Dim dCMass As Double
    
'    Debug.Print "fgCatParts_AfterEdit", fgCatParts.Row, fgCatParts.MouseRow
    
    If Not getReinPos(Row, curPos, "fgCatParts_AfterEdit") Then Exit Sub
    

    
    With fgCatParts
        
        
        
        If Col = .ColIndex("posdef") Then
            
            If curPos.POS_PD.pdID = Val(.ComboData(.ComboIndex)) Then Exit Sub
            posdefID = Val(.ComboData(.ComboIndex))
            
            curPos.setPosdefID posdefID
            
            fgCatPartsSetRowData Row, curPos, True, True
            
            Exit Sub
            
        ElseIf Col = .ColIndex("std") Then
            
            If curPos.POS_STD.stdID = Val(.ComboData(.ComboIndex)) Then Exit Sub
            stdID = Val(.ComboData(.ComboIndex))
            
            curPos.setStandard stdID
            
            fgCatPartsSetRowData Row, curPos, True, True
            
            Exit Sub
            
        ElseIf Col = .ColIndex("srtm") Then
            
            If curPos.POS_SRTM.srtmID = Val(.ComboData(.ComboIndex)) Then Exit Sub
            srtmID = Val(.ComboData(.ComboIndex))
            
            curPos.setSrtm srtmID, False, True
            
'            If Not Arm_2D1 Is Nothing Then
            armUpdateSketch Arm_2D1, curPos
            
        ElseIf Col = .ColIndex("mat") Then
            
            If curPos.POS_MAT.matID = Val(.ComboData(.ComboIndex)) Then Exit Sub
            matID = Val(.ComboData(.ComboIndex))
            
            curPos.setMaterial matID, False
            
        ElseIf Col = .ColIndex("length") Then
            
            Dim prop As clsProp
            Dim bLap As Boolean
            
            dLength = getDbl(.TextMatrix(Row, .ColIndex("length")))
            
            If curPos.pos_props.existsProperty("length") Then
                Set prop = curPos.pos_props("length")
                prop.setValue dLength
                Set prop = Nothing
            Else
                dLength = 0#
            End If
            
            If dLength = 0 Then
                .TextMatrix(Row, .ColIndex("length")) = ""
'                .TextMatrix(Row, .ColIndex("sketch")) = False
            Else
                .TextMatrix(Row, .ColIndex("length")) = curPos.getPosLength(curPos.bCalcLap, bLap)
                .Cell(flexcpFontUnderline, Row, .ColIndex("length")) = bLap
            End If
            
'            If Not Arm_2D1 Is Nothing Then
            armUpdateSketch Arm_2D1, curPos
            
        ElseIf Col = .ColIndex("qty") Then
            
            dQty = getDbl(.TextMatrix(Row, .ColIndex("qty")))
            .TextMatrix(Row, .ColIndex("qty")) = dQty
            curPos.posQty = dQty
            
        ElseIf Col = .ColIndex("umass") Then
            
            dUMass = getDbl(.TextMatrix(Row, .ColIndex("umass")))
            If dUMass <= 0 Then
                .Cell(flexcpBackColor, Row, .ColIndex("umass"), Row, .ColIndex("umass")) = lngRowColor
                curPos.bUMCalc = True
            Else
                .Cell(flexcpBackColor, Row, .ColIndex("umass"), Row, .ColIndex("umass")) = lngGrey
                curPos.bUMCalc = False
                curPos.posUMass = dUMass
            End If
            
        ElseIf Col = .ColIndex("cmass") Then
            
            dCMass = getDbl(.TextMatrix(Row, .ColIndex("cmass")))
            If dCMass <= 0 Then
                .Cell(flexcpBackColor, Row, .ColIndex("cmass"), Row, .ColIndex("cmass")) = lngRowColor
                curPos.bCMCalc = True
            Else
                .Cell(flexcpBackColor, Row, .ColIndex("cmass"), Row, .ColIndex("cmass")) = lngGrey
                curPos.bCMCalc = False
                curPos.posCMass = dCMass
            End If
            
        ElseIf Col = .ColIndex("sketch") Then
        
            Exit Sub
'
'            If fgCatParts.Row <> fgCatParts.MouseRow Then
'                .TextMatrix(Row, .ColIndex("sketch")) = curPos.bSketch
'                Exit Sub
'            End If
'
'            If Not getReinPos(.Row, curPos, "fgCatParts_AfterEdit (sketch)") Then Exit Sub
'            curPos.bSketch = getBool(.TextMatrix(Row, .ColIndex("sketch")))
'
'            If curPos.bSketch Then
'                If Not Arm_2D1 Is Nothing Then Arm_2D1.setEnabled
'            Else
'                If Not Arm_2D1 Is Nothing Then Arm_2D1.setDisabled
'            End If
'
'            If Not Arm_2D1 Is Nothing Then armUpdateSketch Arm_2D1, curPos
                


        End If
        
        
        
        curPos.savePos
        
        fgCatPartsSetRowData Row, curPos, True, True

        
        If curPos.bIsReinDefault Then
            setReinDefaultPos True, curPos.parentPart.catID, True
        End If
        
        

        
    End With
    
Exit Sub

fgCatParts_AfterEdit_ERR:
    Me.SB.Panels("status").text = "fgCatParts_AfterEdit - Error - [" & err.Number & "] - " & err.Description

End Sub


'/******************************************************************************
Private Sub fgCatParts_AfterMoveRow(ByVal Row As Long, Position As Long)
'/******************************************************************************

    On Error GoTo fgCatParts_AfterMoveRow_ERR


    
    
    
    Dim p As clsPos
    If Not getReinPos(Row, p) Then Exit Sub
    
    colRein2.Remove Row
    
    colRein2.Add p, , Position
    
    fgCatPartsUpdatePosNumbersAll
    
    If p.posID > 0 Then writeOperationS operModify, p.POS_SRC_TABLE, p.posID, "перемещение с позиции " & Row & " на " & Position
    
    
Exit Sub

fgCatParts_AfterMoveRow_ERR:
    Me.SB.Panels("status").text = "fgCatParts_AfterMoveRow - Error - [" & err.Number & "] - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgCatParts_AfterSelChange(ByVal OldRowSel As Long, ByVal OldColSel As Long, ByVal NewRowSel As Long, ByVal NewColSel As Long)
'/******************************************************************************

    On Error GoTo fgCatParts_AfterSelChange_ERR
    
'    Debug.Print "fgCatParts_AfterSelChange", fgCatParts.Row, fgCatParts.MouseRow

    
    If Not getReinPos(NewRowSel, curPos, "fgCatParts_AfterSelChange") Then Exit Sub

'    If Not Arm_2D1 Is Nothing Then
        Arm_2D1.Clear
'        If curPos.bSketch Then
'            Arm_2D1.setEnabled
'        Else
'            Arm_2D1.setDisabled
'        End If
        armUpdateSketch Arm_2D1, curPos
'    End If


    If curPos.posID > 0 Then loadLog curPos.POS_SRC_TABLE, curPos.posID
    
    If curPos.POS_PD.pdID = 13 Then
        calcMufts
    End If
    
    checkReinButtons NewRowSel, curPos
    
    If Len(Trim(CStr(fgCatParts.RowData(NewRowSel)))) > 0 Then
        fgCatParts.ToolTipText = CStr(fgCatParts.RowData(NewRowSel))
    Else
        fgCatParts.ToolTipText = ""
    End If



Exit Sub

fgCatParts_AfterSelChange_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatParts_AfterSelChange - Error"

End Sub


'/******************************************************************************
Public Sub checkReinButtons(Row As Long, p As clsPos)
'/******************************************************************************
    
    On Error GoTo checkReinButtons_ERR
    
    
    
    
    tbRein.Buttons("defaultpos").Enabled = Not bCatIsBlocked And Not p.bIsReinDefault And p.POS_SRTM.srtmID > 0
    tbRein.Buttons("posok_clear").Enabled = Not bCatIsBlocked And Not p.bIsReinDefault
    tbRein.Buttons("posok").Enabled = Not bCatIsBlocked And (p.POS_SRTM.srtmID = 0 Or p.bIsReinDefault Or Me.tbRein.Buttons("posok_shift").Value = tbrPressed)
    tbRein.Buttons("InList").Enabled = Not bCatIsBlocked And checkGroupPerm(usrCurrent.groupID, "catlist", operModify)
    tbRein.Buttons("Draw").Enabled = Not bCatIsBlocked
    
    
    Exit Sub
    
checkReinButtons_ERR:
    '    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "checkReinButtons - Error"
    
End Sub


'/******************************************************************************
Private Sub fgCatParts_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgCatParts_BeforeEdit_ERR

    
    Dim mcID As Long
    
    
    If bCatIsBlocked Then Cancel = True: Exit Sub
    
'    Debug.Print "fgCatParts_BeforeEdit", fgCatParts.Row, fgCatParts.MouseRow
    
    
    If Not getReinPos(Row, curPos, "fgCatParts_BeforeEdit", False) Then Exit Sub
    
    With fgCatParts
        
        If Col = .ColIndex("length") Then
            If curPos.POS_MCALC.mcID = 1 Then Cancel = True
            If curPos.POS_MCALC.mcID = 5 Then Cancel = True
            If curPos.POS_SRTM.srtmID = 0 Then Cancel = True
'            If curPos.posID = 0 Then Cancel = True
        ElseIf Col = .ColIndex("umass") Then
            If curPos.POS_SRTM.srtmID = 0 Then Cancel = True
            If curPos.posID = 0 Then Cancel = True
        ElseIf Col = .ColIndex("cmass") Then
            If curPos.POS_SRTM.srtmID = 0 Then Cancel = True
            If curPos.posID = 0 Then Cancel = True
        ElseIf Col = .ColIndex("masslength") Then
            Cancel = True
        ElseIf Col = .ColIndex("num") Then
            Cancel = True
        ElseIf Col >= .ColIndex("std") And curPos.POS_PD.pdID = 0 Then
            Cancel = True
        ElseIf Col >= .ColIndex("srtm") And curPos.POS_STDPD.stdpdID = 0 Then
            Cancel = True
        ElseIf Col = .ColIndex("sketch") Then
'            If fgCatParts.Row <> fgCatParts.MouseRow Then Cancel = True
'            fgCatParts.Row = fgCatParts.MouseRow
            If curPos.POS_SRTM.srtmID = 0 Then Cancel = True
            If curPos.posID = 0 Then Cancel = True
        End If
        
        .ComboList = ""
        
        If Cancel Then Exit Sub
        
        Dim RS As New ADODB.Recordset
        Dim strSQL As String
        
        
        If Not curPos Is Nothing Then
            
            If Col = .ColIndex("posdef") Then
                RS.Open "select * from view_posdef where posdefUsing = 1 and isRein = 1", cn_srtm, adOpenForwardOnly, adLockReadOnly
                .ComboList = .BuildComboList(RS, "posdefName", "posdefID")
                RS.Close
            ElseIf Col = .ColIndex("std") And curPos.POS_PD.pdID > 0 Then
                RS.Open "select * from view_r_standard_posdef_srtm_using where posdefID = " & curPos.getPosdefID & " and stdUsing = 1", cn_srtm, adOpenForwardOnly, adLockReadOnly
                .ComboList = .BuildComboList(RS, "stdFullNumber", "stdID")
                RS.Close
            ElseIf Col = .ColIndex("srtm") And curPos.getStandardID > 0 Then
                strSQL = "select srtmID, srtmName from view_r_sortament_property_3 where stdposdefID = " & curPos.POS_STDPD.stdpdID & " and srtmUsing = 1"
                If Len(curPos.POS_PD.strSort) > 0 Then strSQL = strSQL & " order by " & curPos.POS_PD.strSort
                RS.Open strSQL, cn_srtm, adOpenForwardOnly, adLockReadOnly
                .ComboList = .BuildComboList(RS, "srtmName", "srtmID")
                RS.Close
            ElseIf Col = .ColIndex("mat") And curPos.POS_STDPD.stdpdID > 0 Then
            
                RS.Open "select * from view_r_stdpd_material where stdpdID = " & curPos.POS_STDPD.stdpdID & " order by matSortNumber", cn_srtm, adOpenStatic, adLockReadOnly
                
                If RS.EOF Then
                    RS.NextRecordset
                    RS.Open "select * from view_r_posdef_material where posdefID = " & curPos.getPosdefID & " and matUsing = 1 order by matSortNumber", cn_srtm, adOpenForwardOnly, adLockReadOnly
                End If
                       
                If RS.EOF Then
                    Cancel = True
                Else
                    .ComboList = "#0;" & vbTab & "не определён|" & .BuildComboList(RS, "matName,stdFullNumber", "matID") '"#0;|" &
                End If
                        
                RS.Close
                
            End If
            
        End If
        
        Set RS = Nothing
        
        
        If Col = .ColIndex("posdef") And (Len(.ComboList) = 0) Then
            Cancel = True
        ElseIf Col = .ColIndex("std") And (Len(.ComboList) = 0) Then
            Cancel = True
        ElseIf Col = .ColIndex("srtm") And (Len(.ComboList) = 0) Then
            Cancel = True
        ElseIf Col = .ColIndex("mat") And (Len(.ComboList) = 0) Then
            Cancel = True
        End If
        
    End With
    
Exit Sub

fgCatParts_BeforeEdit_ERR:
    Cancel = True
    Me.SB.Panels("status").text = "fgCatParts_BeforeEdit - Error - [" & err.Number & "] - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgCatParts_BeforeMouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgCatParts_BeforeMouseDown_ERR

'    Debug.Print "fgCatParts_BeforeMouseDown", fgCatParts.Row, fgCatParts.MouseRow

    If bCatIsBlocked Then Exit Sub
    

    If Button = 1 And Shift = 1 Then
    
        If fgCatParts.MouseRow < 1 Then Exit Sub
    
        Dim p As clsPos
        If Not getReinPos(fgCatParts.MouseRow, p, "fgCatParts_BeforeMouseDown") Then Exit Sub
    
        If p.bIsReinDefault Then Exit Sub
        
        Cancel = True
        
        fgCatParts.Select fgCatParts.MouseRow, fgCatParts.Col
        
        fgCatParts.DragRow fgCatParts.MouseRow
        
    End If

Exit Sub

fgCatParts_BeforeMouseDown_ERR:
    Me.SB.Panels("status").text = "fgCatParts_BeforeMouseDown - Error - [" & err.Number & "] - " & err.Description

End Sub

Private Sub fgCatParts_BeforeSelChange(ByVal OldRowSel As Long, ByVal OldColSel As Long, ByVal NewRowSel As Long, ByVal NewColSel As Long, Cancel As Boolean)
    
'    Debug.Print "fgCatParts_BeforeSelChange", fgCatParts.Row, fgCatParts.MouseRow
    
    Cancel = bReinGridLeftRight
    bReinGridLeftRight = False
    
    
End Sub

'/******************************************************************************
Private Sub fgCatParts_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************
    
    On Error GoTo fgCatParts_KeyDown_ERR
    
'    Debug.Print "fgCatParts_KeyDown", fgCatParts.Row, fgCatParts.MouseRow
    
    Dim v As Long
    Dim dLength As Double
    
    If bCatIsBlocked Then Exit Sub
    
    Dim Row As Long
    Dim Col As Long
    Row = fgCatParts.Row
    Col = fgCatParts.Col
    
    
    If Not getReinPos(Row, curPos, "fgCatParts_KeyDown") Then Exit Sub
    
    With fgCatParts
        
        
        If KeyCode = 46 And Shift = 1 Then
            
            If Me.tbRein.Buttons("posok_shift").Value = tbrPressed Then
                mnuReinGridDelete_Click
            Else
                mnuReinGridSetUnavailable_Click
            End If
            
        ElseIf KeyCode = 39 And Shift = 1 Then ' right
            
            bReinGridLeftRight = True
            
            curPos.numDigits = curPos.numDigits + 1
            
            curPos.savePos
            
            fgCatPartsSetRowData Row, curPos, True, True
            
            
        ElseIf KeyCode = 37 And Shift = 1 Then ' left
            
            bReinGridLeftRight = True
            
            v = curPos.numDigits - 1
            
            If v < 0 Then Exit Sub
            
            curPos.numDigits = v
            
            curPos.savePos
            
            fgCatPartsSetRowData Row, curPos, True, True
            
            
        ElseIf KeyCode = 13 Then  ' enter
            
            If Col = fgCatParts.ColIndex("sketch") Then
                
                If Not getReinPos(Row, curPos, "fgCatParts_MouseDown (sketch)") Then Exit Sub
                
                If curPos.partID = 0 Then Exit Sub
                
                curPos.bSketch = Not getBool(fgCatParts.TextMatrix(Row, Col))
                
'                If curPos.bSketch Then
'                    If Not Arm_2D1 Is Nothing Then Arm_2D1.setEnabled
'                Else
'                    If Not Arm_2D1 Is Nothing Then Arm_2D1.setDisabled
'                End If
                
'                If Not Arm_2D1 Is Nothing Then
                armUpdateSketch Arm_2D1, curPos
                
                curPos.savePos
                
            End If
            
            
        Else
            '                        Debug.Print KeyCode
        End If
        
        
        
    End With
    
    Exit Sub
    
fgCatParts_KeyDown_ERR:
    bReinGridLeftRight = False
    Me.SB.Panels("status").text = "fgCatParts_KeyDown - Error - [" & err.Number & "] - " & err.Description
    
End Sub

'/******************************************************************************
Private Sub fgCatParts_KeyPress(KeyAscii As Integer)
'/******************************************************************************

    On Error GoTo fgCatParts_KeyPress_ERR


'    Debug.Print "fgCatParts_KeyPress", fgCatParts.Row, fgCatParts.MouseRow

    If bCatIsBlocked Then Exit Sub
    
    Dim Row As Long
    Row = fgCatParts.Row
    
    If Not getReinPos(Row, curPos, "fgCatParts_KeyPress") Then Exit Sub
    
    If curPos.posID = 0 Then Exit Sub
    If curPos.POS_SRTM.srtmID = 0 Then Exit Sub
    
    Dim bLap As Boolean
    
    Dim p As POINTAPI
    
'    If fgCatParts.Col = fgCatParts.ColIndex("length") Or fgCatParts.Col = fgCatParts.ColIndex("qty") Then
    If fgCatParts.Col = fgCatParts.ColIndex("length") Then
        
        Call ClientToScreen(fgCatParts.hwnd, p)
        
        If KeyAscii = 43 Or KeyAscii = 45 Or KeyAscii = 42 Or KeyAscii = 47 Then
            
            Load frmCalc
            frmCalc.nd = curPos.numDigits
            Set frmCalc.FG = Me.fgCatParts
            frmCalc.Row = fgCatParts.Row
            frmCalc.Col = fgCatParts.Col
            
            frmCalc.Text1.text = curPos.getPosLength(False, bLap)
            frmCalc.Text1.text = Replace(frmCalc.Text1.text, ",", ".")
            
            frmCalc.Text2.text = curPos.POS_LAP.lapValue
            
            frmCalc.Move p.X * Screen.TwipsPerPixelX + fgCatParts.Cell(flexcpLeft, fgCatParts.Row, fgCatParts.Col), p.Y * Screen.TwipsPerPixelY + fgCatParts.Cell(flexcpTop, fgCatParts.Row, fgCatParts.Col)
            
            
            If KeyAscii = 43 Then  ' +
                frmCalc.Text1.text = frmCalc.Text1.text & "+"
            ElseIf KeyAscii = 45 Then  ' -
                frmCalc.Text1.text = frmCalc.Text1.text & "-"
            ElseIf KeyAscii = 42 Then  ' *
                frmCalc.Text1.text = frmCalc.Text1.text & "*"
            ElseIf KeyAscii = 47 Then  ' /
                frmCalc.Text1.text = frmCalc.Text1.text & "/"
            End If
            
            KeyAscii = 0
            frmCalc.Text1.SelStart = Len(frmCalc.Text1.text)
            frmCalc.Show 0, Me
            
        End If
    End If
    
Exit Sub

fgCatParts_KeyPress_ERR:
    KeyAscii = 0
    Me.SB.Panels("status").text = "fgCatParts_KeyPress - Error - [" & err.Number & "] - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgCatParts_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgCatParts_MouseDown_ERR

'    Debug.Print "fgCatParts_MouseDown", fgCatParts.Row, fgCatParts.MouseRow
    
    If bCatIsBlocked Then Exit Sub
    
    Dim i As Integer
    Dim Row As Long
    Dim Col As Long
    Row = fgCatParts.MouseRow
    Col = fgCatParts.MouseCol
    
    If Not getReinPos(Row, curPos, "fgCatParts_MouseDown") Then Exit Sub
    
        
        
    If Button = 1 And Shift = 0 Then
    
        If Col = fgCatParts.ColIndex("sketch") Then
        
            If Not getReinPos(Row, curPos, "fgCatParts_MouseDown (sketch)") Then Exit Sub
            
            If curPos.partID = 0 Then Exit Sub
            
            curPos.bSketch = getBool(fgCatParts.TextMatrix(Row, Col))

'            If curPos.bSketch Then
'                If Not Arm_2D1 Is Nothing Then Arm_2D1.setEnabled
'            Else
'                If Not Arm_2D1 Is Nothing Then Arm_2D1.setDisabled
'            End If

'            If Not Arm_2D1 Is Nothing Then
            armUpdateSketch Arm_2D1, curPos
            
            curPos.savePos
            
        End If
    
    ElseIf Button = 1 And Shift = 2 Then
    
        updateSketchPositions fgCatParts.MouseRow, curPos.bSketch
    
    ElseIf Button = 2 Then
        
        
       
        fgCatParts.Row = fgCatParts.MouseRow
        fgCatParts.Col = fgCatParts.MouseCol
        
        If Not getReinPos(fgCatParts.Row, curPos, "fgCatParts_MouseDown (button=2)") Then Exit Sub
        
        mnuReinGridSetUnavailable.Enabled = CBool(curPos.posID)
        mnuReinGridDelete.Enabled = Not curPos.bIsReinDefault And tbRein.Buttons("posok_shift").Value = tbrPressed
        mnuReinGridDrawSketch.Visible = curPos.bSketch
        mnuReinGridDrawSketch.Enabled = CBool(curPos.pointsSkch.Count > 0)
        
        mnuReinGridLap.Enabled = CBool(curPos.POS_LAP.lapValue) And CBool(curPos.posID > 0)
        If mnuReinGridLap.Enabled = False Then
            mnuReinGridLap.Caption = "Нахлёст не используется"
            mnuReinGridLap.Checked = False
        Else
            mnuReinGridLap.Caption = "Считать нахлёст"
            mnuReinGridLap.Checked = curPos.bCalcLap
        End If
        
        mnuReinGridCont.Enabled = curPos.bSketch
        mnuReinGridCont.Checked = selectLongFromBase(cn_data, "r_part_reinpoints", "isCont", "partID", curPos.getPartID, "isMain", CLng(1))
        
        mnuReinGridBlock.Checked = curPos.parentPart.bBlockUpdate
        
'        mnuReinGridPasteLengths.Visible = CBool(fgCatParts.MouseCol = fgCatParts.ColIndex("length"))
'        If mnuReinGridPasteLengths.Visible Then
'            Dim str As String
'            str = GetUnicodeText
'            If InStr(str, "L=") Then
'                mnuReinGridPasteLengths.Enabled = True
'                Dim ar() As String
'                ar = Split(str, vbNewLine)
'                For I = 0 To UBound(ar)
'                    If I = 0 Then
'                        mnuReinGridPasteLengths1(0).Caption = ar(0)
'                    ElseIf Len(Trim(ar(I))) > 0 Then
'                        Load mnuReinGridPasteLengths1(I)
'                        mnuReinGridPasteLengths1(I).Caption = ar(I)
'                    End If
'                Next
'            Else
'                mnuReinGridPasteLengths.Enabled = False
'            End If
'        End If
        
        PopupMenu mnuReinGrid
        
    End If
    
    
    
Exit Sub

fgCatParts_MouseDown_ERR:
    Me.SB.Panels("status").text = "fgCatParts_MouseDown - Error - [" & err.Number & "] - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgCatParts_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgCatParts_StartEdit_ERR

'Debug.Print "fgCatParts_StartEdit", fgCatParts.Row, fgCatParts.MouseRow


    Dim bLap As Boolean
    
    
    If Not getReinPos(Row, curPos, "fgCatParts_StartEdit") Then Exit Sub
    
    With fgCatParts
        
        If Col = .ColIndex("length") Then
        
            .TextMatrix(Row, Col) = curPos.getPosLength(False, bLap)
            .Cell(flexcpFontUnderline, Row, Col) = False
            
        End If
    End With

Exit Sub

fgCatParts_StartEdit_ERR:
    Cancel = True
    Me.SB.Panels("status").text = "fgCatParts_StartEdit - Error - [" & err.Number & "] - " & err.Description

End Sub

Private Sub fgCatPos_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
Cancel = True
End Sub

Private Sub fgCatPos_KeyDown(KeyCode As Integer, Shift As Integer)


    Dim iRecordsAffected As Integer
    Dim r As Long
    r = fgCatPos.Row
    Dim ind As Integer
    Dim bUpd As Boolean
    
    
    Dim catID As Long
    
    catID = Val(fgCatTree.Tag)
    
    
    
    
    If fgCatPos.RowHeight(r) = 480 Then
    
        Dim posID As Long
        posID = Val(fgCatPos.TextMatrix(r, 4))
        If posID = 0 Then Exit Sub
        
        If KeyCode = 46 And Shift = 1 Then
            
            If Not checkCatPerm(catID) Then
                Exit Sub
            End If
            
            Dim cmd As New ADODB.Command
            cmd.ActiveConnection = cn_data
            cmd.CommandText = "DELETE FROM [catpos] WHERE posID = " & posID & ";"
            cmd.Execute iRecordsAffected
            
            If iRecordsAffected = 1 Then
                
                Do While Val(fgCatPos.TextMatrix(r, 4)) = posID
                    fgCatPos.RemoveItem r
                    If fgCatPos.Rows = 1 Then Exit Do
                Loop
                
                Call writeOperationS(operDelete, "catalog", catID, "удаление позиции")
                
            Else
                MsgBox "   Ошибка при удалении   ", vbCritical, "Ошибка"
            End If
            
           
            
        Else
        End If
    End If



End Sub


Private Sub fgCats_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'
    
    On Error GoTo m1
    Dim RS As New ADODB.Recordset
    
    Dim ID As Long
    Dim typeID As Long
    Dim st As pst
    Dim ct As clsCat
        
    If fgCats.TextMatrix(Row, 2) = "i_project" And fgCats.TextMatrix(Row, 5) = "typeID" And Col = 1 Then
        
        ID = Val(fgCats.TextMatrix(Row, 4))
        typeID = Val(fgCats.ComboData(fgCats.ComboIndex))
        
        RS.Open "select typeID from i_project where projectID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        If Not RS.EOF Then
            RS.MoveFirst
            RS.fields("typeID").Value = typeID
            RS.Update
            fgCats.TextMatrix(Row, 6) = typeID
        End If
        RS.Close
        Call writeOperationS(operModify, "project", ID, "тип " & fgCats.TextMatrix(Row, 1))
        
    ElseIf fgCats.TextMatrix(Row, 2) = "i_project" And fgCats.TextMatrix(Row, 5) = "projectCode" And Col = 1 Then
    
        ID = Val(fgCats.TextMatrix(Row, 4))
    
        If updateTableInBase(cn_data, "i_project", "projectCode", Trim(fgCats.TextMatrix(Row, 1)), "projectID", ID) Then
            Call writeOperationS(operModify, "project", ID, "код " & Trim(fgCats.TextMatrix(Row, 1)))
        End If
    
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catTypeID" And Col = 1 Then
        
        ID = Val(fgCats.TextMatrix(Row, 4))
        
        Set ct = cCats(CStr(ID))
        
        typeID = Val(fgCats.ComboData(fgCats.ComboIndex))
        
        If typeID <> ct.catTypeID Then
        
            If updateTableInBase(cn_data, "i_catalog", "catTypeID", typeID, "catID", ID) Then
            
                ct.loadCatByID Nothing, ID
            
                fgCats.TextMatrix(Row, 6) = ct.catTypeID
                
                If Not tvCats.SelectedItem Is Nothing Then
                    tvCats.SelectedItem.Image = ct.getTreeNodeImage
                End If
                
                Call writeOperationS(operModify, "catalog", ID, "тип " & ct.catTypeName)
            
            End If
        
        End If
        
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catdefID" And Col = 1 Then
    
        ID = Val(fgCats.TextMatrix(Row, 4))
        
        Set ct = cCats(CStr(ID))
        
        typeID = Val(fgCats.ComboData(fgCats.ComboIndex))
        
        If typeID <> ct.catdefID Then
        
            If updateTableInBase(cn_data, "i_catalog", "catdefID", typeID, "catID", ID) Then
            
                ct.loadCatByID Nothing, ID
            
                fgCats.TextMatrix(Row, 6) = ct.catdefID
                
                fgCatAddDocSetRow ct, fgCats, Row + 1, True
                
'                If Not tvCats.SelectedItem Is Nothing Then
'                    tvCats.SelectedItem.Image = ct.getTreeNodeImage
'                End If
                
                Call writeOperationS(operModify, "catalog", ID, "содержимое " & ct.CAT_CATDEF.CD_NAME)
            
            End If
        
        End If
    
    
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catStatus" And Col = 1 Then
    
        ID = Val(fgCats.TextMatrix(Row, 4))
        
        Set ct = cCats(CStr(ID))
        
        st = Val(fgCats.ComboData(fgCats.ComboIndex))

        If st <> ct.iStatus Then

            If checkGroupPerm(usrCurrent.groupID, "catalog", operModify) = False And st = pstArchive Then
                If MsgBox("   Если установлен статус 'Выпущено', то изменить его сможет только Администратор. Уверены?   ", vbYesNo, "Предупреждение") = vbNo Then
                
                   fgCats.TextMatrix(Row, 1) = stts(ct.iStatus)
                   fgCats.TextMatrix(Row, 6) = ct.iStatus
                
                    Exit Sub
                End If
            End If
            
            If st = pstArchive Then
                saveDgnFiles ct.catID
            End If

            If updateTableInBase(cn_data, "i_catalog", "catStatus", st, "catID", ID) Then
            
                Dim dsID As Long
                
                Call writeOperationS(operModify, "catalog", ID, "статус " & stts(st))
                
'                If st = pstArchive Then
'                    Dim str As String
'                    str = ct.CAT_DS_NUM
'                    If Len(str) > 0 Then
'                        dsID = selectLongFromBase(cn_data, "docset", "dsID", "dsNumber", str)
'                        If dsID = 0 Then
'                            dsID = insertDataInBase(cn_data, "docset", "dsNumber", str, "dsTypeID", dstype.dsDrawings, "projectID", ct.getProjectIDfromDB)
'                            Call writeOperationS(operCreate, "docset", dsID)
'                        End If
'
'                        If updateTableInBase(cn_data, "i_catalog", "dsDrawingsID", dsID, "catID", ID) Then
'                        End If
'                    End If
'
'                End If
'
                ct.loadCatByID Nothing, ID

                fgCats.TextMatrix(Row, 6) = ct.iStatus

                If Not tvCats.SelectedItem Is Nothing Then
                    tvCats.SelectedItem.Image = ct.getTreeNodeImage
                End If

                If st = pstArchive And dsID > 0 Then
                    Call writeOperationS(operModify, "catalog", ID, "комплект " & ct.getDocSetNumber)
                    If fgCats.TextMatrix(Row + 1, 5) = "catNum" Then fgCats.TextMatrix(Row + 1, 1) = ct.getDocSetNumber
                End If
                

            End If

        End If
    
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catNum" And Col = 1 Then
    
        Dim dsn As Integer
        Dim dsl As Integer
        
        Dim ar() As String
        
        ID = Val(fgCats.TextMatrix(Row, 4))
        
        ar = Split(fgCats.TextMatrix(Row, 1), "-")
        
        If ar(0) = "&&" Then
            dsl = -1
        Else
            dsl = Val(ar(0))
        End If
        
        
        dsn = Val(ar(1))
        
        Set ct = cCats(CStr(ID))
        
        If updateTableInBase(cn_data, "i_catalog", "dsLev", CInt(dsl), "catID", ID) Then ct.catDocSetLev = dsl
        If updateTableInBase(cn_data, "i_catalog", "dsNum", CInt(dsn), "catID", ID) Then ct.catDocSetNum = dsn
        
        Call writeOperationS(operModify, "catalog", ID, "установка уровня-номера " & ct.CAT_DS_NUM_Lite)
        
    
    ElseIf fgCats.TextMatrix(Row, 2) = "docset" And fgCats.TextMatrix(Row, 5) = "docsetLevel" And Col = 1 Then
    
        Dim lv As Integer
        Dim ds As clsDocSet
        lv = Val(fgCats.ComboData(fgCats.ComboIndex))
        If lv = 2 Then lv = -1
        ID = Val(fgCats.TextMatrix(Row, 4))
        
        'Set ds = globDocSets(CStr(ID))
    
        'If updateTableInBase(cn_data, "docset", "dsLevel", lv, "dsID", ID) Then
        '    ds.docsetLevel = lv
        '    Call writeOperationS(operModify, "catalog", lngCurCatTreeSelectedID, "установка уровня " & getLevSign(lv, "Не определено"))
        'End If
    
    Else
        
    End If
    
    Set RS = Nothing
    
    
    Exit Sub
    
m1:
    Set RS = Nothing
    
    
    
End Sub



Private Sub fgCats_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)

    If Col <> 1 Then Cancel = True: Exit Sub
    
    Dim ct As clsCat
    If fgCats.TextMatrix(Row, 2) = "i_catalog" Then Set ct = cCats(fgCats.TextMatrix(Row, 4))


    If fgCats.TextMatrix(Row, 2) = "i_project" And (fgCats.TextMatrix(Row, 5) = "typeID" Or fgCats.TextMatrix(Row, 5) = "projectCode") And Col = 1 Then
        Cancel = Not checkGroupPerm(usrCurrent.groupID, "project", operModify)
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catTypeID" And Col = 1 Then
        Cancel = (ct.objID <> objs("catalog") And Not checkGroupPerm(usrCurrent.groupID, "catalog", operModify)) Or ct.iStatus = pstArchive Or ct.iStatus = pstUstar
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catStatus" And Col = 1 Then
        Dim relID As Long
        Dim catID As Long
        catID = Val(fgCats.TextMatrix(Row, 4))
        relID = selectLongFromBase(cn_data, "r_usr_catalog", "relID", "usrID", usrCurrent.usrID, "catID", catID)
        
        Dim bUser As Boolean
        Dim bAdm As Boolean
        
        bUser = (relID > 0)
        bAdm = checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
        
        If bUser And (cCats(CStr(catID)).iStatus = pstProvereno Or cCats(CStr(catID)).iStatus = pstRazrabotka) Then
            'Cancel=False
        ElseIf bAdm Then
            'Cancel=False
        Else
            Cancel = True
        End If
        
        
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catNum" And Col = 1 Then
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catdefID" And Col = 1 Then
'        Cancel = Not checkGroupPerm(usrCurrent.groupID, "catalog", operModify) Or ct.iStatus = pstArchive Or ct.iStatus = pstUstar
        Cancel = ct.iStatus = pstProvereno Or ct.iStatus = pstArchive Or ct.iStatus = pstUstar
    ElseIf fgCats.TextMatrix(Row, 2) = "docset" And Col = 1 Then
        Set ct = cCats(CStr(lngCurCatTreeSelectedID))
        Cancel = Not checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
    Else
        Cancel = True
    End If
    
    
    Dim RS As New ADODB.Recordset
    
    fgCats.ComboList = ""


    If fgCats.TextMatrix(Row, 2) = "i_project" And fgCats.TextMatrix(Row, 5) = "typeID" And Col = 1 Then
        RS.Open "select * from view_type_object where objID = " & objs("project"), cn_srtm, adOpenForwardOnly, adLockReadOnly
        fgCats.ComboList = fgCats.BuildComboList(RS, "typeName", "typeID")
        RS.Close
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catTypeID" And Col = 1 Then
        RS.Open "select * from cattype", cn_srtm, adOpenForwardOnly, adLockReadOnly
        fgCats.ComboList = fgCats.BuildComboList(RS, "catTypeName", "catTypeID")
        RS.Close
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catStatus" And Col = 1 Then
        Set ct = cCats(fgCats.TextMatrix(Row, 4))
        If ct.catDocSetNum = 0 Then
            fgCats.ComboList = "#0;" & stts(0) & "|#1;" & stts(1) '& "|#2;" & stts(2) & "|#3;" & stts(3)
        Else
            fgCats.ComboList = "#0;" & stts(0) & "|#1;" & stts(1) & "|#2;" & stts(2) & "|#3;" & stts(3)
        End If
    ElseIf fgCats.TextMatrix(Row, 2) = "i_catalog" And fgCats.TextMatrix(Row, 5) = "catdefID" And Col = 1 Then
    
'        Dim strSQL As String
'        strSQL = "select catdefName + ' (комплект)' as cdName, catdefID from catdef where isDocSet = 1 order by catdefName"
'        strSQL = strSQL & " UNION "
'        strSQL = strSQL & "select catdefName + ' (изделие)' as cdName, catdefID from catdef where isDocSet = 0 order by catdefName"
'        RS.Open strSQL, cn_srtm, adOpenForwardOnly, adLockReadOnly
'        fgCats.ComboList = fgCats.BuildComboList(RS, "cdName", "catdefID")
'        RS.Close
    
        Dim cd As clsCatDef
        For Each cd In globCatDefs
            If Len(fgCats.ComboList) > 0 Then fgCats.ComboList = fgCats.ComboList & "|"
            If cd.bIsDocSet And cd.cdID > 0 Then fgCats.ComboList = fgCats.ComboList & "#" & cd.cdID & ";" & cd.CD_NAME
        Next cd
        For Each cd In globCatDefs
            If Len(fgCats.ComboList) > 0 Then fgCats.ComboList = fgCats.ComboList & "|"
            If Not cd.bIsDocSet And cd.cdID > 0 Then fgCats.ComboList = fgCats.ComboList & "#" & cd.cdID & ";" & cd.CD_NAME
        Next cd
    ElseIf fgCats.TextMatrix(Row, 2) = "docset" And fgCats.TextMatrix(Row, 5) = "docsetLevel" And Col = 1 Then
        fgCats.ComboList = "#0;" & getLevSign(0) & "|#1;" & getLevSign(1) & "|#2;" & getLevSign(2) & ""
    End If
    
    Set RS = Nothing

'    Debug.Print "== " & fgCats.ComboList & " =="

End Sub



Private Sub fgCats_CellButtonClick(ByVal Row As Long, ByVal Col As Long)

' later

'    Load frmCatName
'    frmCatName.Show 1, Me


End Sub


'/******************************************************************************
Private Sub fgCmdRowEnter(Index As Integer, Row As Long)
'/******************************************************************************

    On Error GoTo fgCmdRowEnter_ERR

    Dim objID As Long
    Dim objectID As Long
    Dim objIDts As Long
    Dim objectIDts As Long
'    Dim sDispName As String
    
    objID = Val(fgCmd(Index).TextMatrix(Row, 0))
    objectID = Val(fgCmd(Index).TextMatrix(Row, 1))
'    sDispName = fgCmd(Index).TextMatrix(Row, 2)
    
    If objID = 0 Then
    
        Dim ar() As String
        Dim ars() As String
        Dim ar2() As String
'        Dim ard() As String
        
        ar = Split(sCmdPath(Index), "|")
'        ard = Split(sCmdDisp(Index), " \ ")
        
        ars = Split(ar(UBound(ar)), ":")
        ar2 = Split(ar(UBound(ar) - 1), ":")
        
        If Len(ar(UBound(ar) - 1)) = 0 Then
            objID = 0
            objectID = 0
'            sDispName = ""
        Else
            objID = Val(ar2(0))
            objectID = Val(ar2(1))
'            sDispName = ard(UBound(ard) - 1)
        End If
        
        objIDts = Val(ars(0))
        objectIDts = Val(ars(1))
        
        sCmdPath(Index) = ""
'        sCmdDisp(Index) = ""
        
        Dim i As Integer
        If UBound(ar) > 2 Then
            For i = 0 To UBound(ar) - 2
                If Len(ar(i)) > 0 Then sCmdPath(Index) = sCmdPath(Index) & "|"
                sCmdPath(Index) = sCmdPath(Index) & ar(i)
'                If Len(ard(I)) > 0 Then sCmdDisp(Index) = sCmdDisp(Index) & " \ "
'                sCmdDisp(Index) = sCmdDisp(Index) & ard(I)
            Next i
        End If
    
    End If

    
    
    loadCmd Index, objID, objectID, objIDts, objectIDts
    
    

Exit Sub

fgCmdRowEnter_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCmdRowEnter - Error"

End Sub


'/******************************************************************************
Public Function checkCatCopy(Index As Integer, Row As Long) As Boolean
'/******************************************************************************

    On Error GoTo checkCatCopy_ERR
    
    Dim indexSrc As Integer
    Dim indexDst As Integer
    Dim objIDsrcCont As Long
    Dim objIDdstCont As Long
    
    Dim objIDsrc As Long
    
    indexSrc = Index
    indexDst = Abs(CInt(Not CBool(Index)))
    
    objIDsrc = Val(fgCmd(indexSrc).TextMatrix(Row, 0))
    
    
    Dim ar() As String
    Dim ars() As String
    
    ar = Split(sCmdPath(indexSrc), "|")
    If UBound(ar) >= 0 Then
        ars = Split(ar(UBound(ar)), ":")
        If UBound(ars) >= 0 Then
            objIDsrcCont = Val(ars(0))
        End If
    End If
    
    ar = Split(sCmdPath(indexDst), "|")
    If UBound(ar) >= 0 Then
        ars = Split(ar(UBound(ar)), ":")
        If UBound(ars) >= 0 Then
            objIDdstCont = Val(ars(0))
        End If
    End If
    
    ' каталог можно копировать только в проект, блок, здание(, каталог?)
    ' изделие можно копировать только в каталог
    checkCatCopy = (CBool(objIDsrc = objs("catalog") And (objIDdstCont = objs("project") Or objIDdstCont = objs("block") Or objIDdstCont = objs("building"))) Or _
                    CBool(objIDsrc = objs("part") And (objIDdstCont = objs("catalog"))))

Exit Function

checkCatCopy_ERR:
checkCatCopy = False

End Function


'/******************************************************************************
Private Sub fgCats_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgCats_MouseDown_ERR


    
    If fgCats.MouseRow <= 0 Then Exit Sub
    
    If fgCats.TextMatrix(fgCats.MouseRow, 2) = "i_catalog" And fgCats.TextMatrix(fgCats.MouseRow, 5) = "catdefID" And fgCats.MouseCol = 1 Then
        If Button = 2 Then
        
            Dim catID As Long
            
            catID = Val(fgCats.TextMatrix(fgCats.MouseRow, 4))
        
            Dim ct As New clsCat
            
            If ct.loadCatByID(Nothing, catID) Then
                If cattypes(ct.catTypeID).ctEnum = ctRein And ct.CAT_CATDEF.partdefID > 0 Then
                    
                    Dim pd As clsPartDef
                    Set pd = globPartDefs(CStr(ct.CAT_CATDEF.partdefID))
                    
                    mnuReinCatApply.Caption = "Изменить все позиции на '" & pd.partdefName & "'"
                    mnuReinCatApply.Tag = catID
                    PopupMenu mnuReinCat
                End If
            End If
        End If
    End If
    
    
    
    
Exit Sub

fgCats_MouseDown_ERR:
    F1.SB.Panels("status").text = "fgCats_MouseDown" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgCmd_AfterSelChange(Index As Integer, ByVal OldRowSel As Long, ByVal OldColSel As Long, ByVal NewRowSel As Long, ByVal NewColSel As Long)
'/******************************************************************************

    On Error GoTo fgCmd_AfterSelChange_ERR



    Me.tbCmd.Buttons("copy").Enabled = checkCatCopy(Index, NewRowSel)

Exit Sub

fgCmd_AfterSelChange_ERR:
Me.tbCmd.Buttons("copy").Enabled = False

End Sub

'/******************************************************************************
Private Sub fgCmd_DblClick(Index As Integer)
'/******************************************************************************

    
    fgCmdRowEnter Index, fgCmd(Index).Row



End Sub

Private Sub fgCmd_GotFocus(Index As Integer)

    Me.tbCmd.Buttons("copy").Enabled = checkCatCopy(Index, fgCmd(Index).Row)


End Sub

Private Sub fgCmd_KeyPress(Index As Integer, KeyAscii As Integer)


    If KeyAscii = 13 Then fgCmdRowEnter Index, fgCmd(Index).Row


End Sub

Private Sub fgCmd_LostFocus(Index As Integer)

Me.tbCmd.Buttons("copy").Enabled = False

End Sub



Private Sub fgList_AfterDataRefresh()

    Dim i As Integer
    
    
    
    
    For i = 1 To fgList.cols - 1
        
        If LCase(right(fgList.TextMatrix(0, i), 2)) = "id" Then
            fgList.ColHidden(i) = True
        End If
        
'        If fgList.ColKey(I) = "" Then
'        fgList.ColKey(I) = fgList.TextMatrix(0, I)
'        End If
        
        fgList.ColIndent(i) = 50
        
    Next i
    
    
    fgList.ColDataType(fgList.ColIndex("m")) = flexDTBoolean
    

'    fgList.ColAlignment(0) = flexAlignLeftCenter

    fgList.TextMatrix(0, fgList.ColIndex("partQty")) = "Количество"
    fgList.TextMatrix(0, fgList.ColIndex("partName")) = "Наименование"

'    fgList.AutoSize 0, 0
'    fgList.AutoSize 2, 2
    
    
    DoListDepsUpdate
    
    
    


End Sub



'/******************************************************************************
Private Sub fgList_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgList_AfterEdit_ERR

    
    
    Dim v As Double
    Dim bRes As Boolean
    Dim bRound As Boolean
    Dim m As Double
    
    If Row < 1 Then Exit Sub
    
    If lngCurCatListID = 0 Then Exit Sub
    
    
    If fgList.Col = fgList.ColIndex("Количество") Then
        
        Dim ID As Long
        Dim partdefID As Long
        
        v = getDbl(fgList.TextMatrix(Row, fgList.ColIndex("Количество")))
        
        partdefID = fgList.TextMatrix(Row, fgList.ColIndex("partdefID"))
        
        bRound = Not getBool(fgList.TextMatrix(Row, fgList.ColIndex("partMainPosEP")))
        
        If partdefID > 0 And globPartDefs(CStr(partdefID)).bUsePositions Then bRound = False
        
        If bRound Then v = roundShaman(v, 0, , 0)
        
        ID = fgList.TextMatrix(Row, fgList.ColIndex("relID"))
        bRes = updateTableInBase(cn_data, "r_catlist_part", "partQty", v, "relID", ID)
        
        
        
        
        
        If Not bRes Then
            SB.Panels("status").text = "Ошибка при внесении данных в базу"
        Else
            fgList.Cell(flexcpFontBold, Row, 0, Row, 0) = True
            fgList.TextMatrix(Row, fgList.ColIndex("Количество")) = v
            
        End If
        
        Dim i As Integer
        
        
        
        
        For i = 1 To fgList.Rows - 1
            
            If CBool(fgList.TextMatrix(i, fgList.ColIndex("m"))) = True Then
                
                ID = fgList.TextMatrix(i, fgList.ColIndex("relID"))
                bRes = updateTableInBase(cn_data, "r_catlist_part", "partQty", v, "relID", ID)
                
                If Not bRes Then
                    SB.Panels("status").text = "Ошибка при внесении данных в базу"
                Else
                    fgList.TextMatrix(i, fgList.ColIndex("Количество")) = v
                    fgList.Cell(flexcpFontBold, i, 0, i, 0) = True
                    
                End If
                
            End If
            
        Next i
        
        If bRes Then Call writeOperationS(operModify, "catlist", lngCurCatListID, _
            "изменение количества " & fgList.TextMatrix(Row, fgList.ColIndex("Наименование")) & " на " & v)
        
        DoListDepsUpdate
        
        
    ElseIf fgList.Col = fgList.ColIndex("m") Then
        bListSelecting = CBool(fgList.TextMatrix(Row, Col) = -1)
    End If
    
    
    
    
    
    
    
    
Exit Sub

fgList_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgList_AfterEdit - Error"

End Sub


Sub DoListDepsUpdate()

    fgSpec.Rows = 1
    fgOfftake.Rows = 1
    
    updateStatusListMass
    
    Me.SB.Panels("specmass").text = "Спецификация: - "
    Me.SB.Panels("offtmass").text = "Выборка: - "
    
    Me.SB.Panels("specmass").AutoSize = sbrContents
    Me.SB.Panels("offtmass").AutoSize = sbrContents

End Sub


Private Sub fgList_AfterMoveRow(ByVal Row As Long, Position As Long)
    
    Dim A1 As Integer
    Dim A2 As Integer
    Dim i As Integer
    Dim bRes As Boolean
    Dim ID As Long
    
    
    If lngCurCatListID = 0 Then Exit Sub

    
    For i = 1 To fgList.Rows - 1
    
        fgList.TextMatrix(i, 0) = i
        fgList.TextMatrix(i, fgList.ColIndex("partSortID")) = i
        
        ID = fgList.TextMatrix(i, fgList.ColIndex("relID"))
        bRes = updateTableInBase(cn_data, "r_catlist_part", "partSortID", i, "relID", ID)
        
    Next i
    
    If bRes Then Call writeOperationS(operModify, "catlist", lngCurCatListID, "перемещение строки " & Row & " -> " & Position)
    
    DoListDepsUpdate
    
End Sub

'/******************************************************************************
Private Sub fgList_AfterSelChange(ByVal OldRowSel As Long, ByVal OldColSel As Long, ByVal NewRowSel As Long, ByVal NewColSel As Long)
'/******************************************************************************

    On Error GoTo fgList_AfterSelChange_ERR

    

    
    
    
Exit Sub

fgList_AfterSelChange_ERR:
    fgList.ToolTipText = ""

End Sub

Private Sub fgList_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)

    If lngCurCatListID = 0 Then Cancel = True: Exit Sub
    If bCatListIsBlocked Then Cancel = True: Exit Sub
    If checkGroupPerm(usrCurrent.groupID, "catlist", operModify) = False Then Cancel = True: Exit Sub

    If Col = fgList.ColIndex("Количество") Then
    
'        If Me.fgList.TextMatrix(Row, fgList.ColIndex("objID")) = objs("part") And cattypes(Val(Me.fgList.TextMatrix(Row, fgList.ColIndex("catTypeID")))).ctEnum = ctRein Then
'            Cancel = True
'        End If
    
    
    ElseIf Col = fgList.ColIndex("m") Then
         ' всегда можно править
    Else
        Cancel = True
    End If



End Sub

Private Sub fgList_BeforeMouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single, Cancel As Boolean)
    
    
    If lngCurCatListID = 0 Then Cancel = True: Exit Sub
    
    If Button = 1 And Shift = 1 And Not bCatListIsBlocked Then
        
        Cancel = True
        
        fgList.Select fgList.MouseRow, fgList.Col
        
        fgList.DragRow fgList.MouseRow
        
    ElseIf Button = 2 Then
        
    End If
    
    
End Sub


'/******************************************************************************
Public Sub goToPartFromList(objID As Long, objectID As Long, Optional catIDtoLoad As Long = 0)
'/******************************************************************************

    On Error GoTo goToPartFromList_ERR

    Dim i As Integer
    
    
    If objID = 0 Then Exit Sub
    If objectID = 0 Then Exit Sub
        
    
    
    
    Dim nd As Node
    Dim ndprnt As Node
    Dim iLev As Integer
    Dim strKey As String
    
    
    If objID = objs("part") Then
    
        loadCatalog catIDtoLoad, False, objectID, True, False  ' каталог не перегружаем, выделяем изделие что в списке, активируем вкладку, не перегружаем список
        
    ElseIf objID = objs("catalog") Then
    
        strKey = "catalog" & objectID
        
        Set nd = tvGetTreeNode(tvCats, strKey)
        
        If nd Is Nothing Then
            iLev = tvGetParentNode(tvCats, ndprnt, objs("catalog"), objectID)
        End If
        
    ElseIf objID = objs("catlist") Then
    
        strKey = "catlist" & objectID
        
        Set nd = tvGetTreeNode(tvCats, strKey)
        
        If nd Is Nothing Then
            iLev = tvGetParentNode(tvCats, ndprnt, objs("catlist"), objectID)
        End If
        
    End If
    
    
    '==========
    
    If Len(strKey) > 0 Then
    
        If iLev > 0 And Not ndprnt Is Nothing Then
            For i = iLev To 1 Step -1
                Set ndprnt = tvGetTreeNode(tvCats, arTreeLev(i))
                If ndprnt Is Nothing Then
                    Exit For
                Else
                    ndprnt.Expanded = True
                End If
            Next i
        End If
        
        Set nd = tvGetTreeNode(tvCats, strKey)
        
        If Not nd Is Nothing Then
            nd.Selected = True
            nd.EnsureVisible
            If Me.tvCats.Nodes.Count > 0 Then Me.ctabMain.CurrTab = 0
        Else
            F1.SB.Panels("status").text = "Не можно находить такого"
        End If
        
    End If
    
    

    


Exit Sub

goToPartFromList_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "goToPartFromList - Error"

End Sub



'/******************************************************************************
Private Sub fgList_DblClick()
'/******************************************************************************
    
    On Error GoTo fgList_DblClick_ERR
    
    If fgList.Col <> fgList.ColIndex("Наименование") Then Exit Sub
    
    goToPartFromList Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID"))), Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("partID"))), Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("catID")))
    
    
    Exit Sub
    
fgList_DblClick_ERR:
    '    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgList_DblClick - Error"
    SB.Panels("status").text = err.Description
    
End Sub

Private Sub fgList_DragDrop(source As Control, X As Single, Y As Single)
    
    If bCatListIsBlocked Then Exit Sub
    
    If lngCurCatListID = 0 Then Exit Sub
    
    If source.Name = "tvParts" Then
        
        Dim t As TreeView
        Dim n As Node
        Dim ID As Long
        Dim objID As Long
        
        Set t = source
        Set n = t.SelectedItem
        
        
        If LCase(left(n.KEY, Len("part"))) = "part" Then
            ID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
            objID = objs("part")
        ElseIf n.KEY = "root" Then
            ID = lngCurCatID
            objID = objs("catalog")
        Else
            Exit Sub
        End If
        
        Dim RS As New ADODB.Recordset
        
        RS.Open "select * from r_catlist_part where catlistID = " & lngCurCatListID & " and partID = " & ID & " and objID = " & objID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If RS.EOF Then
            
            RS.AddNew
            RS.fields("catlistID").Value = lngCurCatListID
            RS.fields("partID").Value = ID
            RS.fields("partQty").Value = 1
            RS.fields("objID").Value = objID
            RS.Update
            Call writeOperationS(operModify, "catlist", lngCurCatListID, "добавлено изделие " & n.text)
            
        Else
            
            '                RS.MoveFirst
            '                RS.Fields("partQty").Value = RS.Fields("partQty").Value + 1
            '                RS.Update
            '                Call writeOperationS(operModify, "catlist", lngCurCatListID, "изменено количество " & n.text & " (+1)")
            
            
        End If
        
        
        
        If mnuListSortAuto.Checked Then sortListInBaseProc
        
        loadListGrid lngCurCatListID
        
        
        '        fgList.AddItem vbTab & vbTab & t.SelectedItem.Text
        
        
        DoListDepsUpdate
        
        
        
    End If
    
    
End Sub


'/******************************************************************************
Private Sub deleteMarkedListRows(Optional bOnlyMarked As Boolean = False)
'/******************************************************************************

    On Error GoTo deleteListRows_ERR

    Dim i As Long
    Dim ID As Long
    Dim sIDs As String
    Dim qty As Long
    
    Dim iRecordsAffected As Integer
    
    
    For i = 1 To fgList.Rows - 1
        
        If CBool(fgList.TextMatrix(i, fgList.ColIndex("m"))) = True Then
            
            ID = fgList.TextMatrix(i, fgList.ColIndex("relID"))
            
            If Len(sIDs) > 0 Then sIDs = sIDs & ","
            sIDs = sIDs & ID
            qty = qty + 1
            
        End If
        
        
    Next i
    
    
    If qty = 0 And bOnlyMarked Then Exit Sub
    
    
    If Len(sIDs) = 0 Then
        If fgList.Row < 1 Then Exit Sub
        sIDs = CStr(fgList.TextMatrix(fgList.Row, fgList.ColIndex("relID")))
        qty = -1
    End If


    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandText = "delete from [r_catlist_part] where relID in (" & sIDs & ")"
    cmd.Execute iRecordsAffected
    Set cmd = Nothing
    
    If iRecordsAffected = qty Then
    
        For i = 1 To fgList.Rows - 1
            
            If i = fgList.Rows Then Exit For
            
            If CBool(fgList.TextMatrix(i, fgList.ColIndex("m"))) = True Then
                
'                Debug.Print fgList.TextMatrix(I, fgList.ColIndex("Наименование"))
                
                fgList.RemoveItem i
                i = i - 1
                
            End If
            
            
        Next i
    ElseIf iRecordsAffected = -qty Then
    
        fgList.RemoveItem fgList.Row
    
    Else
        err.Raise 100, , "Ошибка при удалении"
    End If
    


Exit Sub

deleteListRows_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "deleteListRows - Error"

End Sub




'/******************************************************************************
Private Sub fgList_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************

    On Error GoTo fgList_KeyDown_ERR

    
    
    If bCatListIsBlocked Then Exit Sub
    
    If lngCurCatListID = 0 Then Exit Sub
    
    If KeyCode = 46 Then
        
        deleteMarkedListRows
        
        DoListDepsUpdate
        
        
    ElseIf KeyCode = 37 And Shift = 1 Then ' left
    
        mnuListRowsBack_Click
    
    
    ElseIf KeyCode = 39 And Shift = 1 Then ' right
    
        mnuListRowsFwd_Click
    
        
    Else
    End If
    
    
    
Exit Sub

fgList_KeyDown_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgList_KeyDown - Error"

End Sub


'/******************************************************************************
Private Sub fgList_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgList_MouseDown_ERR

    
    If lngCurCatListID = 0 Then Exit Sub
    
    Dim strCatPath As String
    
    If Button = 2 Then
        
        fgList.Row = fgList.MouseRow
        
        If fgList.MouseCol = fgList.ColIndex("p") Then
        
            Set tt = New CBalloonToolTip
            tt.Icon = TTNoIcon
            tt.Title = ""
            tt.PopupOnDemand = False
            'tt.ForeColor = vbBlue
            tt.Style = TTBalloon
            tt.TipText = "принадлежность проекту списка"
            tt.VisibleTime = 3000
            tt.DelayTime = 3000
            tt.CreateToolTip Me.hwnd
            tt.Show
            Timer2.Enabled = False
            Timer2.Enabled = True
        
        ElseIf fgList.MouseCol = fgList.ColIndex("b") Then
        
            Set tt = New CBalloonToolTip
            tt.Icon = TTNoIcon
            tt.Title = ""
            tt.PopupOnDemand = False
            'tt.ForeColor = vbBlue
            tt.Style = TTBalloon
            tt.TipText = "принадлежность блоку списка"
            tt.VisibleTime = 3000
            tt.DelayTime = 3000
            tt.CreateToolTip Me.hwnd
            tt.Show
            Timer2.Enabled = False
            Timer2.Enabled = True
        
        ElseIf fgList.MouseCol = fgList.ColIndex("c") Then
        
            Set tt = New CBalloonToolTip
            tt.Icon = TTNoIcon
            tt.Title = ""
            tt.PopupOnDemand = False
            'tt.ForeColor = vbBlue
            tt.Style = TTBalloon
            tt.TipText = "принадлежность каталогу списка"
            tt.VisibleTime = 3000
            tt.DelayTime = 3000
            tt.CreateToolTip Me.hwnd
            tt.Show
            Timer2.Enabled = False
            Timer2.Enabled = True
        
        ElseIf fgList.MouseCol <= fgList.ColIndex("m") Then
        
            mnuListRowsDelete.Enabled = True
        
            If bCatListIsBlocked Then mnuListRowsDelete.Enabled = False
            If lngCurCatListID = 0 Then mnuListRowsDelete.Enabled = False
        
        
            Dim i As Long
            Dim qty As Long
            For i = 1 To fgList.Rows - 1
                If CBool(fgList.TextMatrix(i, fgList.ColIndex("m"))) = True Then
                    qty = qty + 1
                End If
            Next i
        
            If qty > 1 Then
                mnuListRowsDelete.Caption = "Удалить из списка (" & qty & ")"
            Else
                mnuListRowsDelete.Caption = "Удалить строку из списка"
            End If
            
            mnuListRowsBack.Enabled = iListRemPos > 1
            mnuListRowsFwd.Enabled = iListRemPos < UBound(arListRem)
            
        
            PopupMenu mnuListRows
        
        Else
            
            Dim objID  As Long
            Dim objectID As Long
            objID = Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID")))
            objectID = Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("partID")))
            
            Dim cmd As New ADODB.Command
            cmd.ActiveConnection = cn_data
            cmd.CommandType = adCmdStoredProc
            cmd.CommandText = "getPath2"
            cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
            cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objID)
            cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , objectID)
            cmd.Parameters.Append cmd.CreateParameter("nameshort", adInteger, adParamInput, , 30)
            cmd.Execute
            
            strCatPath = cmd.Parameters("ret") & ""
            
            Set tt = New CBalloonToolTip
            tt.Icon = TTNoIcon
            If fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID")) = objs("part") Then
                tt.Title = "изделие " & fgList.TextMatrix(fgList.Row, fgList.ColIndex("Наименование"))
            ElseIf fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID")) = objs("catalog") Then
                tt.Title = "каталог " & fgList.TextMatrix(fgList.Row, fgList.ColIndex("Наименование"))
            ElseIf fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID")) = objs("catlist") Then
                tt.Title = "список " & fgList.TextMatrix(fgList.Row, fgList.ColIndex("Наименование"))
            Else
                tt.Title = fgList.TextMatrix(fgList.Row, fgList.ColIndex("Наименование"))
            End If
            tt.PopupOnDemand = False
            'tt.ForeColor = vbBlue
            tt.Style = TTStandard
            tt.TipText = Replace(strCatPath, " - ", vbNewLine)
            tt.VisibleTime = 3000
            tt.DelayTime = 3000
            tt.CreateToolTip Me.hwnd
            tt.Show
            Timer2.Enabled = False
            Timer2.Enabled = True
            
        End If
        
    End If
    
    
    
Exit Sub

fgList_MouseDown_ERR:
    F1.SB.Panels("status").text = "fgList_MouseDown" & "() - " & err.Description

End Sub

Private Sub fgList_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)

    If fgList.MouseRow = -1 Then Exit Sub
    If fgList.MouseCol = -1 Then Exit Sub
    
    If lngCurCatListID = 0 Then Exit Sub
    
    If bCatListIsBlocked Then Exit Sub

    If Button = 1 And fgList.MouseCol = fgList.ColIndex("m") Then
    
        fgList.TextMatrix(fgList.MouseRow, fgList.MouseCol) = bListSelecting
    
    ElseIf Button = 0 And fgList.MouseCol = fgList.ColIndex("Наименование") Then
        Me.fgList.MousePointer = flexHand
    Else
        Me.fgList.MousePointer = flexDefault
    
    End If


End Sub

'/******************************************************************************
Private Sub fgOfftake_DblClick()
'/******************************************************************************
    
    On Error GoTo fgOfftake_DblClick_ERR
    
'    If usrCurrent.pdsID > 0 Then Exit Sub
    
    Dim r As Long
    Dim sKey As String
    Dim mc As Boolean
    Dim srtmID As Long
    Dim ou As clsOU
    Dim cl As New Collection
    Dim ind As Integer
    
    Dim strID As String
    
    If lngCurCatListID = 0 Then Exit Sub
    
    
'    If iCurOfft > 0 Or usrCurrent.pdsID > 0 Then
        goCheckList iCurOfft
        Exit Sub
'    End If
    
    ' далее идет устаревшая часть функции
    ' =============================================
    
    r = fgOfftake.Row
    
    
    sKey = fgOfftake.TextMatrix(r, fgOfftake.ColIndex("key"))
    srtmID = Val(fgOfftake.TextMatrix(r, fgOfftake.ColIndex("srtmID")))
    mc = CBool(fgOfftake.TextMatrix(r, fgOfftake.ColIndex("mc")))
    ind = Val(fgOfftake.TextMatrix(r, fgOfftake.ColIndex("offt")))
    
    
    If srtmID = 0 Then Exit Sub
    
    
    Set ou = offts(ind)(sKey)
    

    
    
    Dim strSQL As String
    
    strSQL = "select distinct * from view_clist_callback_all where catlistID = " & lngCurCatListID & " and srtmID = " & srtmID
    strID = "relID"
    
    If ou.pos.POS_MAT.matID = 0 Then
        strSQL = strSQL & " and (matID is null or matID = 0)"
    Else
        strSQL = strSQL & " and matID = " & ou.pos.POS_MAT.matID
    End If
    
    
'    partdefs(ou.pos.parentPart.partdefID).
    
    If ou.pos.parentPart.partdefID = 0 Then
        strSQL = strSQL & " and (partdefID is null or partdefID = 0)"
    Else
        strSQL = strSQL & " and partdefID = " & ou.pos.parentPart.partdefID
    End If
    
    
    
    Dim RS As New ADODB.Recordset
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        
        RS.MoveFirst
        Do
            
            
            cl.Add RS.fields(strID).Value, CStr(RS.fields(strID).Value)
            
            RS.MoveNext
        Loop Until RS.EOF
        
        
        
    End If
    
    
    RS.Close
    Set RS = Nothing
    
    
    Dim i As Integer
    Dim j As Integer
    
    For i = 1 To Me.fgList.Rows - 1
        
        fgList.Cell(flexcpFontBold, i, 2) = False
        
    Next i
    
    If cl.Count = 0 Then Exit Sub
    
    
    For i = 1 To Me.fgList.Rows - 1
        For j = 1 To cl.Count
            
            If fgList.TextMatrix(i, fgList.ColIndex(strID)) = cl(j) Then
                fgList.Cell(flexcpFontBold, i, 2) = True
            End If
            
        Next j
    Next i
    
    
    
    
    Exit Sub
    
fgOfftake_DblClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgOfftake_DblClick - Error"
    
End Sub

Private Sub fgOfftake_KeyDown(KeyCode As Integer, Shift As Integer)

    If KeyCode = 83 Then Me.fgOfftake.SaveGrid App.path & "\offt.grid", flexFileAll

End Sub

Private Sub fgOfftake_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)


'    If Me.tbOfftake.Buttons("Nulls").Value = tbrPressed Then Exit Sub
'
'    If Button = 2 Then
'
'        PopupMenu mnuOfftMass
'
'    End If


End Sub

'/******************************************************************************
Private Sub fgPart_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgPart_AfterEdit_ERR

    
    Dim RS As New ADODB.Recordset
    
    Dim ID As Long
    Dim ar() As String
    Dim str As String
    
    If fgPart.TextMatrix(Row, 0) = "Характеристика" And Col = 1 Then
        
        ID = Val(fgPart.ComboData(fgPart.ComboIndex))
        curPart.savePartDef ID
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Тип" And Col = 1 Then
        
        ID = Val(fgPart.ComboData(fgPart.ComboIndex))
        curPart.savePartType ID
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Обозначение" And Col = 1 Then
    
        ar = Split(fgPart.TextMatrix(Row, 1), vbNewLine)
        
        If Len(Trim(fgPart.TextMatrix(Row, 1))) = 0 Then
            str = ""
        Else
            str = ar(0)
        End If
        
        curPart.DESCR = str
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Наименование" And Col = 1 Then
    
        curPart.saveName fgPart.TextMatrix(Row, 1)
        
        tvParts.SelectedItem.text = curPart.getNodeName
        fgPart.TextMatrix(Row, 1) = curPart.partName
        
        checkCatParts
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Лист" And Col = 1 Then
    
        curPart.SHEET = fgPart.TextMatrix(Row, 1)
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Версия" And Col = 1 Then
    
        curPart.saveVERS fgPart.TextMatrix(Row, 1)
        tvParts.SelectedItem.text = curPart.getNodeName
        fgPart.TextMatrix(Row, 1) = curPart.partVers
        
        checkCatParts
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Статус" And Col = 1 Then
    
        Dim s As String
        ID = Val(fgPart.ComboData(fgPart.ComboIndex))
        
        curPart.updateMassesInBase True
        
        
        If updateTableInBase(cn_data, "part", "partStatusID", ID, "partID", curPart.partID) Then
            Call updateTableInBase(cn_data, "part", "usrID", usrCurrent.usrID, "partID", curPart.partID)
            Call writeOperationS(operModify, "part", curPart.partID, "установка статуса " & stts(ID))
            tvParts.SelectedItem.Image = "part" & ID
        End If
        
        If checkPart(curPart, operModify) Then
            fgPart.TextMatrix(fgPart.Rows - 1, 1) = ""
            Me.sldRound.Enabled = True
        Else
            fgPart.TextMatrix(fgPart.Rows - 1, 1) = "блокировано"
            Me.sldRound.Enabled = False
        End If
        
        
    Else
        
    End If
    
    
    
Exit Sub

fgPart_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgPart_AfterEdit - Error"

End Sub

'/******************************************************************************
Private Sub fgPart_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgPart_BeforeEdit_ERR

    Dim RS As ADODB.Recordset
    
    fgPart.ComboList = ""
    
    Dim i As Integer
    
    fgPart.ComboList = ""
    
'    Dim RS As New ADODB.Recordset

    If Val(fgPart.Tag) = objs("catalog") Then Cancel = True: Exit Sub
    
    If fgPart.TextMatrix(Row, 0) = "Наименование" And Col = 1 Then
    
        Cancel = Not checkPart(curPart, operModify, False) ' link may be edited
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Характеристика" And Col = 1 Then
        
        If Not checkPart(curPart, operModify) Then Cancel = True: Exit Sub
        
'        fgPart.ComboList = "#0;"
        
        Dim pd As clsPartDef
        
        If usrCurrent.pdsID = 0 Then
        
            For Each pd In globPartDefs
                If pd.pdpdsID = 0 Then
                    If Len(fgPart.ComboList) > 0 Then fgPart.ComboList = fgPart.ComboList & "|"
                    fgPart.ComboList = fgPart.ComboList & "#" & pd.partdefID & ";" & pd.partdefName
                End If
            Next pd
            
        Else
            Set RS = New ADODB.Recordset
            RS.Open "select * from view_r_pdset_partdef where pdsID = " & usrCurrent.pdsID, cn_srtm, adOpenForwardOnly, adLockReadOnly
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                    If Len(fgPart.ComboList) > 0 Then fgPart.ComboList = fgPart.ComboList & "|"
                    If Not IsNull(RS.fields("relNameAlt").Value) Then
                        fgPart.ComboList = fgPart.ComboList & "#" & RS.fields("partdefID").Value & ";" & RS.fields("relNameAlt").Value
                    Else
                        fgPart.ComboList = fgPart.ComboList & "#" & RS.fields("partdefID").Value & ";" & RS.fields("partdefName").Value
                    End If
                    RS.MoveNext
                Loop Until RS.EOF
            End If
            RS.Close
            Set RS = Nothing
        End If
        
            
'        RS.Open "select * from partdef", cn_srtm, adOpenForwardOnly, adLockReadOnly
'        fgPart.ComboList = fgPart.BuildComboList(RS, "partdefName", "partdefID")
'        RS.Close
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Тип" And Col = 1 Then
        
        If Not checkPart(curPart, operModify) Then Cancel = True: Exit Sub
            
        Dim pt As clsPartType
        
        If usrCurrent.pdsID = 0 Then
        
            For Each pt In globPartTypes
                If pt.ptpdsID = 0 Then
                    If Len(fgPart.ComboList) > 0 Then fgPart.ComboList = fgPart.ComboList & "|"
                    fgPart.ComboList = fgPart.ComboList & "#" & pt.ptID & ";" & pt.ptName
                End If
            Next pt
            
            If globPartTypes.Count = 0 Then Cancel = True
            
        Else
            Set RS = New ADODB.Recordset
            RS.Open "select * from view_r_pdset_parttype where pdsID = " & usrCurrent.pdsID & " order by sortID", cn_srtm, adOpenForwardOnly, adLockReadOnly
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                    If Len(fgPart.ComboList) > 0 Then fgPart.ComboList = fgPart.ComboList & "|"
                    If Not IsNull(RS.fields("relNameAlt").Value) Then
                        fgPart.ComboList = fgPart.ComboList & "#" & RS.fields("ptID").Value & ";" & RS.fields("relNameAlt").Value
                    Else
                        fgPart.ComboList = fgPart.ComboList & "#" & RS.fields("ptID").Value & ";" & RS.fields("typeName").Value
                    End If
                    RS.MoveNext
                Loop Until RS.EOF
            Else
                Cancel = True
            End If
            RS.Close
            Set RS = Nothing
        End If
        
        
        
        
'        Dim c As New Collection
'
'        Dim ptt As clsPartType
'        For Each ptt In globPartTypes
'            If ptt.specID = usrCurrent.specID Then
'                Dim pt As New clsObj
'                pt.objName = ptt.ptID & ";" & ptt.ptName
'                pt.KEY = ptt.sortKey
'                c.Add pt, pt.KEY
'                Set pt = Nothing
'            End If
'        Next ptt
'
'        Set c = sortCollection(c)
'
'        For I = 1 To c.Count
'            If Len(fgPart.ComboList) > 0 Then fgPart.ComboList = fgPart.ComboList & "|"
'            fgPart.ComboList = fgPart.ComboList & "#" & c(I).objName
'        Next I
            
'        RS.Open "select * from parttype where specID = " & usrCurrent.specID, cn_srtm, adOpenForwardOnly, adLockReadOnly
'        fgPart.ComboList = fgPart.BuildComboList(RS, "typeName", "typeID")
'        RS.Close
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Обозначение" And Col = 1 Then
    
        If Len(curPart.PART_CAT.CAT_DS_NUM) > 0 Then
            Cancel = True
        'ElseIf curPart.PART_CAT.bUnif Or Len(curPart.PART_DESCR) > 0 Then
        Else
'            Cancel = True
            Cancel = Not checkPart(curPart, operModify)
        End If
        
    ElseIf fgPart.TextMatrix(Row, 0) = "KKS" And Col = 1 Then
                
        If curPart.partdefID = 4 Then
        fgPart.ComboList = "..."
        End If
            
    ElseIf fgPart.TextMatrix(Row, 0) = "Статус" And Col = 1 Then
        
        If Not checkPart(curPart, operOverStatus) Then Cancel = True: Exit Sub
        
        fgPart.ComboList = "#0;" & stts(0) & "|#1;" & stts(1) & "|#2;" & stts(2) & "|#3;" & stts(3)
    
    ElseIf fgPart.TextMatrix(Row, 0) = "Ведомость" And Col = 1 Then
        fgPart.ComboList = "..."
        Cancel = Not checkPart(curPart, operModify)
    ElseIf fgPart.TextMatrix(Row, 0) = "Комплект" And Col = 1 Then
        fgPart.ComboList = "..."
        Cancel = Not checkPart(curPart, operModify)
    Else
        Cancel = Not checkPart(curPart, operModify)
    End If
    
'    Set RS = Nothing
    
Exit Sub

fgPart_BeforeEdit_ERR:
    Cancel = True

End Sub

Private Sub fgPart_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)

    If NewCol < 1 Then Cancel = True
    
    
    If NewRow = fgPart.Rows - 1 Then Cancel = True

End Sub




'/******************************************************************************
Private Sub fgPart_CellButtonClick(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgPart_CellButtonClick_ERR


    Dim i As Integer
    
    Me.MousePointer = 11

    If fgPart.TextMatrix(Row, 0) = "KKS" And Col = 1 Then
    
        Dim frmkks As New frmPartKks
        
        
        If curPart.partDocSetDrawingsID < 0 Then ' iRows
            frmkks.iRows = -curPart.partDocSetDrawingsID
        Else
            frmkks.iRows = 15
        End If
        
        If curPart.partDocSetPartListID < 0 Then ' iCols
            frmkks.iCols = -(curPart.partDocSetPartListID - 1)
        Else
            frmkks.iCols = 1
        End If
        
        
        
        frmkks.txtRows.text = frmkks.iRows
        frmkks.txtCols.text = frmkks.iCols
        
        frmkks.sKksDiv = globPartDefs(CStr(curPart.partdefID)).partdefKksDiv
        
        
        For i = 0 To 9
            frmkks.setGrid frmkks.fgKKS(i), frmkks.chkKks(i), i
            frmkks.loadKksGrid i
        Next i
        
        
        
'        If curPart.partDocSetPartListID < 0 Then ' iGridMaxIndex
'            Dim iCols As Integer
'            iCols = -curPart.partDocSetPartListID
'            If iCols > 9 Then iCols = 9
'        End If
        
        frmkks.width = (frmkks.fgKKS(0).width + 50) * frmkks.iCols + 150 + 1700
        
        frmkks.height = frmkks.fgKKS(0).top + frmkks.fgKKS(0).height + 500
        If frmkks.height < 4600 Then frmkks.height = 4600
        
        frmkks.Show 1, Me
        
        fgPart.TextMatrix(Row, 1) = (-curPart.partDocSetDrawingsID * (-curPart.partDocSetPartListID + 1))
    
    
    Else
        Dim frm As New frmDocSet
        Dim ds As clsDocSet
        
        frm.setIDs curPart.partDocSetPartListID, curPart.partDocSetDrawingsID
        frm.Show 1, Me
        
        
        
        
        
        If frm.bOk Then
        
            Dim cmd As New ADODB.Command
            Dim iRecordsAffected As Integer
            cmd.ActiveConnection = cn_data

            If frm.iPartListID >= 0 Then
                cmd.CommandText = "update [part] set [dsPartListID] = " & frm.iPartListID & " where partID = " & curPart.partID
                cmd.Execute iRecordsAffected
                curPart.partDocSetPartListID = frm.iPartListID
            End If

            If frm.iDrawingsID >= 0 Then
                cmd.CommandText = "update [part] set [dsDrawingsID] = " & frm.iDrawingsID & " where partID = " & curPart.partID
                cmd.Execute iRecordsAffected
                curPart.partDocSetDrawingsID = frm.iDrawingsID
            End If

            curPart.updatePartGrids False
        
            Set frm = Nothing
            Exit Sub
        Else
            Set frm = Nothing
        End If
    End If

    Me.MousePointer = 0


Exit Sub

fgPart_CellButtonClick_ERR:
    Me.MousePointer = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgPart_CellButtonClick - Error"

End Sub

Private Sub fgPart_KeyDown(KeyCode As Integer, Shift As Integer)
    
    
    If curPart Is Nothing Then Exit Sub
    
    If Not checkPart(curPart, operModify) Then
        fgPart.ComboList = ""
        Exit Sub
    End If
    
    
    If KeyCode = 46 Then
        
        
        If fgPart.TextMatrix(fgPart.Row, 0) = "Обозначение" And fgPart.Col = 1 Then
            curPart.DESCR = ""
            fgPart.TextMatrix(fgPart.Row, 1) = ""
        ElseIf fgPart.TextMatrix(fgPart.Row, 0) = "Лист" And fgPart.Col = 1 Then
            curPart.SHEET = ""
            fgPart.TextMatrix(fgPart.Row, 1) = ""
        ElseIf fgPart.TextMatrix(fgPart.Row, 0) = "Версия" And fgPart.Col = 1 Then
            curPart.saveVERS ""
            tvParts.SelectedItem.text = curPart.getNodeName
            fgPart.TextMatrix(fgPart.Row, 1) = curPart.partVers
            
            checkCatParts
        Else
            
        End If
        
        
        
        
    End If
    
    
End Sub

Private Sub fgPart_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
    
    If fgPart.TextMatrix(Row, 0) = "Характеристика" And Col = 1 Then
        
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Наименование" And Col = 1 Then
        
'        If InStr(1, "АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЬЫЪЭЮЯ", CStr(Chr(KeyAscii)), vbTextCompare) > 0 Then
'            KeyAscii = 0
'        End If
        
    ElseIf fgPart.TextMatrix(Row, 0) = "Лист" And Col = 1 Then
        
        If InStr(1, sFilterPartSheet, CStr(Chr(KeyAscii)), vbTextCompare) > 0 Then
        ElseIf KeyAscii = 13 Then
        ElseIf KeyAscii = 8 Then ' backsp
        ElseIf KeyAscii = 27 Then ' esc
        Else
            KeyAscii = 0
        End If
        
        
'    ElseIf fgPart.TextMatrix(Row, 0) = "Версия" And Col = 1 Then
'
'        If InStr(1, sFilterPartVersion, CStr(Chr(KeyAscii)), vbTextCompare) > 0 Then
'        ElseIf KeyAscii = 13 Then
'        Else
'            KeyAscii = 0
'        End If
        
    Else
        
    End If
    
End Sub

'/******************************************************************************
Private Sub fgPart_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************
    
    On Error GoTo fgPart_MouseDown_ERR
    
    If bCatIsBlocked Then Exit Sub
    
    If Button <> 2 Then Exit Sub
    
    If fgPart.TextMatrix(fgPart.MouseRow, 0) = "Характеристика" And fgPart.MouseCol = 1 Then
        
        Dim pdID As Long
        pdID = Val(fgPart.TextMatrix(fgPart.MouseRow, 2))
        
        mnuPartApply.Tag = pdID
        
        fgPart.Select fgPart.MouseRow, fgPart.MouseCol
        
        PopupMenu mnuPart
        
        
'    ElseIf fgPart.TextMatrix(fgPart.Row, 0) = "Обозначение" And fgPart.Col = 1 Then
'    ElseIf fgPart.TextMatrix(fgPart.Row, 0) = "Лист" And fgPart.Col = 1 Then
'    ElseIf fgPart.TextMatrix(fgPart.Row, 0) = "Версия" And fgPart.Col = 1 Then

    Else
        
    End If
    
    
    
    Exit Sub
    
fgPart_MouseDown_ERR:
    F1.SB.Panels("status").text = "fgPart_MouseDown" & "() - " & err.Description
    
End Sub

Private Sub fgPDSet_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    
    
    Dim strSQL As String
    Dim strColumns As String
    Dim strValues As String
    Dim iRecAf As Integer
    
    Dim cmd As ADODB.Command
    
    Dim relID As Long
    Dim pdsID As Long
            
    Dim strNameAlt As String
    Dim strNameAltQ As String
    
    
    
    If Not curPosdef Is Nothing Then
        
        If Col = 1 Or Col = 3 Then
        
            relID = Val(fgPDSet.TextMatrix(Row, 5))
            pdsID = Val(fgPDSet.TextMatrix(Row, 0))
            
            strNameAlt = Trim(fgPDSet.TextMatrix(Row, 3))
            
            If CBool(fgPDSet.TextMatrix(Row, 1)) Then ' on
                
                If Len(strNameAlt) = 0 Then
                    strNameAltQ = "null"
                Else
                    strNameAltQ = "'" & strNameAlt & "'"
                End If
                
                If relID = 0 Then
                    relID = insertDataInBase(cn_srtm, "r_pdset_posdef", "pdsID", pdsID, "posdefID", curPosdef.pdID, "relNameAlt", strNameAltQ)
                    
                    fgPDSet.TextMatrix(Row, 5) = relID
                    fgPDSet.TextMatrix(Row, 3) = strNameAlt
                Else
                    Call updateTableInBase(cn_srtm, "r_pdset_posdef", "relNameAlt", strNameAltQ, "relID", relID)
                End If
                
            ElseIf Col = 1 Then ' off
                
                If relID > 0 Then
                    Set cmd = New ADODB.Command
                    cmd.ActiveConnection = cn_srtm
                    cmd.CommandText = "DELETE FROM [r_pdset_posdef] WHERE relID = " & relID
                    cmd.Execute iRecAf
                    
                    If iRecAf = 1 Then
                        fgPDSet.TextMatrix(Row, 5) = 0
                    Else
                        SB.Panels("status").text = "Ошибка записи в базу данных"
                    End If
                Else
                End If
                
                
            End If
            
            curPosdef.loadPDSets
            
        Else
        End If
        
    ElseIf Not curStdPd Is Nothing Then
        
        If Col = 1 Then
            
            relID = Val(fgPDSet.TextMatrix(Row, 5))
            pdsID = Val(fgPDSet.TextMatrix(Row, 0))
'            strNameAlt = Trim(fgPDSet.TextMatrix(Row, 3))
            
            If Not CBool(fgPDSet.TextMatrix(Row, 1)) Then ' OFF - отличие!!!
                
'                If relID = 0 Then
                    relID = insertDataInBase(cn_srtm, "r_stdpd_pdset", "pdsID", pdsID, "stdpdID", curStdPd.stdpdID)
'                    fgPDSet.TextMatrix(Row, 5) = relID
'                Else
'                    Call updateTableInBase(cn_srtm, "r_stdpd_pdset", "relNameAlt", strNameAltQ, "relID", relID)
'                End If

                If relID > 0 Then
                    fgPDSet.Cell(flexcpBackColor, Row, 1) = lngGrey
                End If
                
            Else ' on
                
                If relID > 0 Then
                    Set cmd = New ADODB.Command
                    cmd.ActiveConnection = cn_srtm
                    cmd.CommandText = "DELETE FROM [r_stdpd_pdset] WHERE pdsID = " & pdsID & " AND stdpdID = " & curStdPd.stdpdID
                    cmd.Execute iRecAf
                    
                    If iRecAf = 1 Then
                        fgPDSet.Cell(flexcpBackColor, Row, 1) = &H80000005
                    End If
                Else
                End If
                
                
            End If
            
            curStdPd.loadStdPdSets
            
        Else
        End If
        
        
        
        
    End If
    
    
    
    
End Sub

Private Sub fgPDSet_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)

    Dim relID As Long
    relID = Val(fgPDSet.TextMatrix(Row, 5))


    If Col = 1 Then
    ElseIf Col = 3 Then
        If relID = 0 Then Cancel = True
    Else
        Cancel = True
    End If


End Sub

'/******************************************************************************
Private Sub fgPositions_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************
    
    On Error GoTo fgPositions_AfterEdit_ERR
    
    
    
    
    Dim ID As Long
    Dim v As Double
    Dim sv As String
    Dim r As Long
    Dim pos As clsPos
    Dim bUpd As Boolean
    
    ID = Val(fgPositions.TextMatrix(Row, 4))
    If ID = 0 Then Exit Sub
    
    Set pos = curPart.ps(CStr(ID))
        
    sv = Trim(Me.fgPositions.TextMatrix(Row, Col))
        
    v = getDbl(sv)
    If v < 0 Then v = 0
    
    If fgPositions.RowHeight(Row) = 480 Then ' position
        
        
        If Col = 1 Then ' quantity
            pos.setQuantity v
        ElseIf Col = 2 Then ' unit mass by hand
            pos.POS_UMASS_REAL = v
        ElseIf Col = 3 Then ' common mass by hand
            pos.POS_CMASS_REAL = v
        End If
        
        r = Row
        
    Else ' property
        
        Dim p As clsProp
        Dim propKey As String
        Dim bLap As Boolean
'        propKey = fgPositions.TextMatrix(Row, 3)
        propKey = fgPositions.RowData(Row)
        
        Set p = pos.pos_props(propKey)
        
        If p.propvalName = "string" Then
            p.PVAL = sv
        Else
            p.PVAL = v
        End If
        
        
        
        
'        If IsEmpty(p.propValue) Then
'            Me.fgPositions.TextMatrix(Row, Col) = ""
'        Else
'            Me.fgPositions.TextMatrix(Row, Col) = p.propValue
'        End If

        Me.fgPositions.TextMatrix(Row, Col) = p.PVAL

        If propKey = "length" Then
            Call pos.getPosLength(pos.bCalcLap, bLap)
            Me.fgPositions.Cell(flexcpFontUnderline, Row, Col) = bLap
        End If

        
        If IsEmpty(p.propValue) Or p.propValue = 0# Then
            Me.fgPositions.Cell(flexcpFontItalic, Row, 1) = True
        Else
            Me.fgPositions.Cell(flexcpFontItalic, Row, 1) = False
        End If
    
        ' ищем Row позиции
        r = Row
        Do While Val(fgPositions.TextMatrix(r, 4)) = ID
            r = r - 1
        Loop
        r = r + 1
        
        
    End If
    
    
    pos.updatePosRow r, bUpd, False, True, False, True
    
    
    Exit Sub
    
fgPositions_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgPositions_AfterEdit - Error"
    
End Sub

'/******************************************************************************
Private Sub fgPositions_AfterMoveRow(ByVal Row As Long, Position As Long)
'/******************************************************************************

    On Error GoTo fgPositions_AfterMoveRow_ERR


    If Row = Position Then Exit Sub


    Dim pn As Long
    
'    Set pos(0) = curPart.ps.pm(CStr(Val(fgPositions.TextMatrix(Row, 4))))
'    Set pos(1) = curPart.ps.pm(CStr(Val(fgPositions.TextMatrix(Position, 4))))
    
    If pos(0) Is Nothing Then Exit Sub
    If pos(1) Is Nothing Then Exit Sub
    
    pn = pos(0).posNumber
    pos(0).posNumber = pos(1).posNumber
    pos(1).posNumber = pn
    
    
    curPart.updatePosNumbersInBase False
    
    curPart.setIDv2 curPart.partID, True, True, False
    
    curPart.updatePartGrids True
    
    fgPositions.Select pos(1).fgRowToEdit, 0


Exit Sub

fgPositions_AfterMoveRow_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgPositions_AfterMoveRow - Error"

End Sub

Private Sub fgPositions_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)

    tbPart.Buttons("AddPos").Enabled = CBool((fgPositions.RowOutlineLevel(NewRow) = 0) And _
                                        (NewRow < fgPositions.Rows - 1)) And _
                                        Not bCatIsBlocked And _
                                        checkGroupPerm(usrCurrent.groupID, "part", operModify)

    Dim ID As Long
    ID = Val(fgPositions.TextMatrix(NewRow, 4))
    
    If curPart.bIsCat Then
        If ID > 0 Then loadLog "catpos", ID
    Else
        If ID > 0 Then loadLog "position", ID
    End If


End Sub

'/******************************************************************************
Private Sub fgPositions_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgPositions_BeforeEdit_ERR

    
    Dim pos As clsPos
    
    If Not checkPart(curPart, operModify) Then
        Cancel = True
        Exit Sub
    End If
    
    
    Dim ID As Long
    ID = Val(fgPositions.TextMatrix(Row, 4))
    
    
    
    
    
    If fgPositions.RowHeight(Row) = 480 Then
        If Col = 0 Then Cancel = True ' use DblClick
        If ID = 0 And Col > 1 Then Cancel = True
        If ID > 0 Then
            Set pos = curPart.ps(CStr(ID))
            If pos.POS_MCALC.mcID = 10 Then ' масса общая
                If Col = 1 Or Col = 2 Then Cancel = True
            End If
        End If
    Else
        If Col <> 1 Then
            Cancel = True
        Else
            Dim p As clsProp
            Dim propKey As String
'            propKey = fgPositions.TextMatrix(Row, 3)
            propKey = fgPositions.RowData(Row)
            
            Set p = curPart.ps(CStr(ID)).pos_props(propKey)
            
            If p.propName = "chainx" Or p.propName = "chainy" Then
                '...
                'Cancel = True
            Else
                Cancel = Not p.bEditable
            End If
            
        
        End If
    End If
    
    
    
    
Exit Sub

fgPositions_BeforeEdit_ERR:
    Cancel = True

End Sub

'/******************************************************************************
Private Sub fgPositions_BeforeMouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgPositions_BeforeMouseDown_ERR

    
    If fgPositions.MouseRow < 1 Then Exit Sub
    
    If Not checkPart(curPart, operModify) Then
'        Cancel = True
        Exit Sub
    End If
    
    
    If Button = 1 And Shift = 1 And fgPositions.RowHeight(fgPositions.MouseRow) = 480 Then
        
        If Val(fgPositions.TextMatrix(fgPositions.MouseRow, 4)) > 0 Then
            
            Cancel = True
            
            fgPositions.Select fgPositions.MouseRow, 0
            
            fgPositions.DragRow fgPositions.MouseRow
            
        End If
        
    End If
    
    
Exit Sub

fgPositions_BeforeMouseDown_ERR:

End Sub

'/******************************************************************************
Private Sub fgPositions_BeforeMoveRow(ByVal Row As Long, Position As Long)
'/******************************************************************************

    On Error GoTo fgPositions_BeforeMoveRow_ERR
    

    If Row = Position Then Exit Sub
    
    Dim r As Long
    
    If Row < Position Then r = Position + 1
    If Row > Position Then r = Position

    If (Row < Position And fgPositions.RowHeight(r) = 480) Or (Row > Position And fgPositions.RowHeight(r) = 480) Then
'        Debug.Print "ok", Row, Position
    Else
'        Debug.Print "skip", Row, Position
        Position = Row
        Exit Sub
    End If
    
    Set pos(0) = curPart.ps.pm(CStr(Val(fgPositions.TextMatrix(Row, 4))))
    Set pos(1) = curPart.ps.pm(CStr(Val(fgPositions.TextMatrix(Position, 4))))
    
    pos(0).fgRowToEdit = Row
    pos(1).fgRowToEdit = r


Exit Sub

fgPositions_BeforeMoveRow_ERR:
    Set pos(0) = Nothing
    Set pos(1) = Nothing
    Position = Row

End Sub




Private Sub fgPositions_DblClick()

    If fgPositions.Row = 0 Then Exit Sub

    fgPositionsStartEdit fgPositions.Row, fgPositions.Col, False

End Sub


'/******************************************************************************
Private Sub fgPositions_GotFocus()
'/******************************************************************************

    On Error GoTo fgPositions_GotFocus_ERR


    Me.tbPart.Buttons("AddPos").Enabled = CBool((fgPositions.RowOutlineLevel(fgPositions.Row) = 0) And _
                                        (fgPositions.Row < fgPositions.Rows - 1)) And _
                                        Not bCatIsBlocked And _
                                        checkGroupPerm(usrCurrent.groupID, "part", operModify)

Exit Sub

fgPositions_GotFocus_ERR:

End Sub

Private Sub fgPositions_KeyDown(KeyCode As Integer, Shift As Integer)
    
    Dim iRecordsAffected As Integer
    Dim r As Long
    r = fgPositions.Row
    Dim ind As Integer
    Dim bUpd As Boolean
    
    
    If Not checkPart(curPart, operModify) Then
        Exit Sub
    End If
    
    
    If fgPositions.RowHeight(r) = 480 Then
    
        Dim posID As Long
        posID = Val(fgPositions.TextMatrix(r, 4))
        If posID = 0 Then Exit Sub
        Dim pos As clsPos
        Set pos = curPart.ps(CStr(posID))
        
        If KeyCode = 46 And Shift = 1 Then
            
            
            
            
            Dim cmd As New ADODB.Command
            cmd.ActiveConnection = cn_data
            cmd.CommandText = "DELETE FROM [" & pos.POS_SRC_TABLE & "] WHERE posID = " & posID & ";"
            cmd.Execute iRecordsAffected
            
            If iRecordsAffected = 1 Then
                
                curPart.ps.Remove CStr(posID)
                
                Do While Val(fgPositions.TextMatrix(r, 4)) = posID
                    fgPositions.RemoveItem r
                Loop
                
                curPart.updateMasses
                
                Call writeOperationS(operDelete, pos.POS_SRC_TABLE, posID, "удаление позиции " & ind & " в " & curPart.partName)
                
            Else
                MsgBox "   Ошибка при удалении   ", vbCritical, "Ошибка"
            End If
            
            
            
            
            
        ElseIf KeyCode = 39 And Shift = 1 Then
            
            
            ind = pos.numDigits + 1
            
            If updateTableInBase(cn_data, pos.POS_SRC_TABLE, "numDigits", ind, "posID", posID) Then
                pos.numDigits = ind
                pos.updatePosRow r, bUpd, False, True, False, True
                Call writeOperationS(operModify, pos.POS_SRC_TABLE, posID, "уст. знаков после запятой " & ind)
            Else
            End If
            
            
            
            
            
        ElseIf KeyCode = 37 And Shift = 1 Then
            
            ind = pos.numDigits - 1
            If ind = -1 Then Exit Sub
            
            If updateTableInBase(cn_data, pos.POS_SRC_TABLE, "numDigits", ind, "posID", posID) Then
                pos.numDigits = ind
                pos.updatePosRow r, bUpd, False, True, False, True
                Call writeOperationS(operModify, pos.POS_SRC_TABLE, posID, "уст. знаков после запятой " & ind)
            End If
            
            
            
            
            
            
        Else
        End If
    End If
    
    
End Sub



'/******************************************************************************
Private Sub fgPositions_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
'/******************************************************************************

    On Error GoTo fgPositions_KeyPressEdit_ERR

    'Debug.Print KeyAscii
    
    
    If KeyAscii = 13 Then ' enter
    ElseIf KeyAscii = 8 Then ' backsp
    ElseIf KeyAscii = 27 Then ' esc
    ElseIf KeyAscii = 42 Then ' *
    ElseIf KeyAscii = 43 Then ' +
    ElseIf KeyAscii = 44 Then ' ,
    ElseIf KeyAscii = 46 Then ' .
    ElseIf KeyAscii > 47 And KeyAscii < 58 Then ' 0-9
    Else
        KeyAscii = 0
    End If
    
    
    Exit Sub

fgPositions_KeyPressEdit_ERR:
    'MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgPositions_KeyPressEdit - Error"

End Sub

'/******************************************************************************
Private Sub fgPositions_LostFocus()
'/******************************************************************************

    On Error GoTo fgPositions_LostFocus_ERR


    Me.tbPart.Buttons("AddPos").Enabled = False

Exit Sub

fgPositions_LostFocus_ERR:

End Sub

'/******************************************************************************
Private Sub fgPositions_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgPositions_MouseDown_ERR

    
    
    
    If Not checkPart(curPart, operModify) Then
        Exit Sub
    End If
    
    
    Dim nr As Long, nc As Long
    
    Dim pos As clsPos
    
    
    If Button <> 2 Then Exit Sub
    
    ' get coordinates
    
    nr = fgPositions.MouseRow
    
    nc = fgPositions.MouseCol
    
    
    fgPositions.Select fgPositions.MouseRow, 0
    
    
    Dim posID As Long
    posID = Val(fgPositions.TextMatrix(nr, 4))
    If posID = 0 Then Exit Sub
    Set pos = curPart.ps(CStr(posID))
    fgPositions.Tag = nr
    
    
    
    If fgPositions.RowHeight(nr) = 480 Then
    
        If Not pos.POS_MCALC.calcs Is Nothing Then
            If loadPositionsMenu(pos.POS_MCALC, pos.POS_MCALC.calcs, pos.POS_MCALC.mcID) Then PopupMenu mnuPositions
        ElseIf Not pos.POS_MCALC.MC_PRNT Is Nothing Then
            If loadPositionsMenu(pos.POS_MCALC.MC_PRNT, pos.POS_MCALC.MC_PRNT.calcs, pos.POS_MCALC.mcID) Then PopupMenu mnuPositions
        Else
            If loadPositionsMenu(Nothing, Nothing, 0) Then PopupMenu mnuPositions
        End If
        
    Else
    
        If loadPositionsMenu2(pos) And Not curPart.bIsCat Then PopupMenu mnuPositions
        
        
    End If
    
    
    
    
    
    
    
    
Exit Sub

fgPositions_MouseDown_ERR:
    F1.SB.Panels("status").text = "fgPositions_MouseDown" & "() - " & err.Description

End Sub



Private Sub fgPositionsStartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    
    Dim posID As Long
    posID = Val(fgPositions.TextMatrix(Row, 4))
    Dim pos As clsPos
    Dim propKey As String
    Dim bLap As Boolean
    
    If Not checkPart(curPart, operModify) Then Exit Sub
    
    
    If fgPositions.RowOutlineLevel(Row) = 0 Then
        
        If Col = 0 Then
            
            Cancel = True
            
            '            If tbPart.Buttons("EditPart").Value = tbrPressed Then
            
            fgPositions.IsCollapsed(Row) = flexOutlineExpanded
            
            Load F2
            
            F2.bCatPos = curPart.bIsCat
            
            F2.Move MouseX(F1.fgPositions.hwnd, F1.fgPositions.CellLeft, F1.fgPositions.CellTop + F1.fgPositions.RowHeight(fgPositions.Row)), _
                           MouseY(F1.fgPositions.hwnd, F1.fgPositions.CellLeft, F1.fgPositions.CellTop + F1.fgPositions.RowHeight(fgPositions.Row))
            
            If F2.top + F2.height > Screen.height Then
                F2.top = F2.top - F2.height - 480
            End If
            
            
            
            If posID > 0 Then
                
                Set F2.curPos = curPart.ps(CStr(posID)) ' просто запоминается
                
                ' редактирование и сохранение будет проходить через след. экземпляр (хорошо бы клонировать)
                '                    Set F2.curPos = New clsPos
                '                    F2.curPos.setIDfromBase posID, True, curPart
                ' не подошло потому что происходит перерасчет curPart.ps
                
                F2.curPosIndex = F2.curPos.getIndex
                
            Else
                
                Set F2.curPos = New clsPos
                Set F2.curPos.parentPart = curPart
                
                If Row = fgPositions.Rows - 1 Then
                    F2.curPosIndex = 0
                Else
                    Dim posNext As clsPos
                    Dim posNextID As Long
                    Dim r As Long
                    posNextID = 0
                    r = Row + 1
                    Do
                        posNextID = Val(fgPositions.TextMatrix(r, 4))
                        If posNextID > 0 Then Exit Do
                        r = r + 1
                        If fgPositions.Rows = r Then Exit Do
                    Loop
                    Set posNext = curPart.ps(CStr(posNextID))
                    F2.curPosIndex = posNext.getIndex
                End If
                
            End If
            
            F2.curPos.fgRowToEdit = Row
            
            F2.loadGrids
            F2.Show
            
            SetAlwaysOnTopMode F2.hwnd, F1.mnuViewOnTop.Checked
            
            '            End If
            
        ElseIf Col = 2 Then
            
            '            If tbPart.Buttons(2).Value = tbrPressed Then
            '                Cancel = True
            '                Load FPart
            '                FPart.Move MouseX(F1.fgPositions.hwnd, F1.fgPositions.CellLeft, F1.fgPositions.CellTop + F1.fgPositions.RowHeight(fgPositions.Row)), _
                                               '                                  MouseY(F1.fgPositions.hwnd, F1.fgPositions.CellLeft, F1.fgPositions.CellTop + F1.fgPositions.RowHeight(fgPositions.Row))
            '                FPart.Show
            '            End If
            
        End If
        
    Else
        
        '        If Col = 1 Then
        '            posID = Val(fgPositions.TextMatrix(Row, 4))
        '            If posID = 0 Then Exit Sub
        '
        '            Set pos = curPart.ps(CStr(posID))
        '
        '            propKey = fgPositions.RowData(Row)
        '
        '            If propKey = "length" Then
        '
        '                fgPositions.TextMatrix(Row, Col) = pos.getPosLength(pos.bCalcLap, bLap)
        '                fgPositions.Cell(flexcpFontUnderline, Row, Col) = False
        '
        '            End If
        '
        '        End If
        
        
        
    End If
    
    
End Sub




Private Sub fgSim2_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    fgSim_AfterEdit_common fgSim2, Row, Col
End Sub

Private Sub fgSim_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    fgSim_AfterEdit_common fgSim, Row, Col
End Sub

'/******************************************************************************
Private Sub fgSim_AfterEdit_common(ByRef fgSim As VSFlexGrid, ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************
    
    On Error GoTo fgSim_AfterEdit_ERR
    
    Dim fcID As Long
    Dim v As Long
    Dim dv As Double
    Dim cnfc As ADODB.Connection
    
    If fgSim.Col = 2 And fgSim.Tag = "room" Then
        
        
        Dim prlistID As Long
        prlistID = Val(fgSim.ComboData(fgSim.ComboIndex))
        
        Dim pr As clsPrp
        Set pr = curRoom.room_prps(fgSim.TextMatrix(fgSim.Row, 0))
        
        If pr.propvalName = "secid" Then
            If pr.hasListValue(prlistID) Then
                
                Dim iRecordsAffected As Integer
                Dim cmd As New ADODB.Command
                cmd.ActiveConnection = cn_data
                cmd.CommandText = "delete from [r_room_propertylist] where roomID = " & curRoom.simID & " and propID = " & pr.propID & " and valueID = " & prlistID
                cmd.Execute iRecordsAffected
                Set cmd = Nothing
                
                If iRecordsAffected = 1 Then
                    pr.setPrpValue 0, prlistID
                    Call writeOperationS(operModify, "room", curRoom.simID, pr.propDescr & " = " & pr.PVAL)
                End If
                
            Else
                If insertDataInBase(cn_data, "r_room_propertylist", "roomID", curRoom.simID, "propID", pr.propID, "valueID", prlistID) > 0 Then
                    pr.setPrpValue 1, prlistID
                    Call writeOperationS(operModify, "room", curRoom.simID, pr.propDescr & " = " & pr.PVAL)
                End If
            End If
            fgSim.TextMatrix(Row, Col) = pr.PVAL
            If pr.colValues.Count > 0 Then fgSim.RowHeight(Row) = 240 + (pr.colValues.Count - 1) * 210
            
        ElseIf pr.propvalName = "id" Then
            pr.propValue = prlistID
            pr.saveValue
        ElseIf pr.propvalName = "long" Then
            pr.propValue = CLng(Val(fgSim.TextMatrix(fgSim.Row, 2)))
            pr.saveValue
        Else
            pr.propValue = Trim(fgSim.TextMatrix(fgSim.Row, 2))
            pr.saveValue
        End If
        
        
    ElseIf fgSim.ColKey(fgSim.Col) = strFireAreaMan And InStr(fgSim.Tag, "FireCompartment") Then
    
        Set cnfc = New ADODB.Connection
        cnfc.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"

        fcID = CLng(Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireCompID))))
        
        dv = getDbl(fgSim.TextMatrix(Row, Col))
        
        If updateTableInBase(cnfc, strFireCompTable, strFireAreaField, dv, strFireCompID, fcID) Then
            fgSim.TextMatrix(Row, Col) = dv
        Else
            fgSim.TextMatrix(Row, Col) = 0
        End If
        
        If Val(fgSim.TextMatrix(Row, Col)) = 0 Then fgSim.TextMatrix(Row, Col) = ""
        
        cnfc.Close
        Set cnfc = Nothing
        
        If Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireArea))) <> Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireAreaMan))) _
                            And Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireAreaMan))) > 0 Then
            fgSim.Cell(flexcpBackColor, Row, fgSim.ColIndex(strFireArea), Row, fgSim.ColIndex(strFireAreaMan)) = lngLightRed
        Else
            fgSim.Cell(flexcpBackColor, Row, fgSim.ColIndex(strFireArea), Row, fgSim.ColIndex(strFireAreaMan)) = lngRowWinColor
        End If
    
    ElseIf fgSim.ColKey(fgSim.Col) = strFireResMan And InStr(fgSim.Tag, "FireCompartment") Then


        Set cnfc = New ADODB.Connection
        cnfc.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"

        fcID = CLng(Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireCompID))))
        
        v = CLng(Val(fgSim.TextMatrix(Row, Col)))
        
        If updateTableInBase(cnfc, strFireCompTable, strFireResField, v, strFireCompID, fcID) Then
            fgSim.TextMatrix(Row, Col) = v
        Else
            fgSim.TextMatrix(Row, Col) = 0
        End If
        
        If Val(fgSim.TextMatrix(Row, Col)) = 0 Then fgSim.TextMatrix(Row, Col) = ""
        
        cnfc.Close
        Set cnfc = Nothing
        
        If Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireRes))) <> Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireResMan))) Then
            fgSim.Cell(flexcpBackColor, Row, fgSim.ColIndex(strFireRes), Row, fgSim.ColIndex(strFireResMan)) = lngLightRed
        Else
            fgSim.Cell(flexcpBackColor, Row, fgSim.ColIndex(strFireRes), Row, fgSim.ColIndex(strFireResMan)) = lngRowWinColor
        End If


    ElseIf fgSim.Col = 0 And Not pwset.ispwdb Then
    
        Dim strPath As String
        Dim strBld As String
        Dim strBldq As String
        Dim strBldqq As String
        Dim bldID As Long
        Dim sClass As String
    
        Dim ar() As String
        ar = Split(fgSim.Tag, "|||")
        
        strBld = ar(0)
        strPath = ar(1)
    
        Dim cnt As New ADODB.Connection
        cnt.Open pwset.constring, "so2user", "so2user"
        
        Dim bAdd As Boolean
        Dim bDel As Boolean
        Dim bVal As Boolean
        
        bVal = CBool(fgSim.TextMatrix(Row, fgSim.ColIndex("ex")))
        
        
        sClass = fgSim.TextMatrix(Row, fgSim.ColIndex("contname"))
        
        If Len(strBld) > 0 Then
            bldID = selectLongFromBase(cnt, "buildings", "bldID", "bldCode", strBld)
        Else
            bldID = 0
        End If
        
        
        Dim isc As Integer
        isc = Val(fgSim.TextMatrix(Row, fgSim.ColIndex("isc")))
        
        Dim isec As Integer
        isec = Val(fgSim.TextMatrix(Row, fgSim.ColIndex("section")))
        
        
        Dim strSQL As String
        strSQL = "select * from filter where filterPath = '" & strPath & "' and filterClass = '" & sClass & "'"
        strSQL = strSQL & " and filterBuilding = " & bldID
        strSQL = strSQL & " and filterSection = " & isec
        strSQL = strSQL & " and filterSafetyClass = " & isc
        
        
        Dim RS As New ADODB.Recordset
        RS.Open strSQL, cnt, adOpenStatic, adLockReadOnly

        If Not RS.EOF Then
            If bVal Then bDel = True
        Else
            If Not bVal Then bAdd = True
        End If

        RS.Close
        Set RS = Nothing
        
        
        Dim cmdd As New ADODB.Command
        Set cmdd.ActiveConnection = cnt
        
        If bAdd Then
            cmdd.CommandText = "insert into filter (filterPath,filterBuilding,filterClass,filterSafetyClass,filterSection) values ('" & _
                    strPath & "'," & bldID & ",'" & sClass & "'," & isc & "," & isec & ")"
        End If
        
        If bDel Then
            cmdd.CommandText = "delete from filter where filterPath = '" & strPath & "' and filterBuilding = " & bldID & _
                    " and filterClass = '" & sClass & "' and filterSafetyClass = " & isc & " and filterSection = " & isec
        End If
        
        cmdd.Execute
        
        
        If Not tvWise.SelectedItem Is Nothing Then
            If strTechViewName = "view_tech_wcount" Then
                tvWise.SelectedItem.bOld = CBool(selectLongFromBase(cnt, "filter", "count(*)", "filterPath", strPath, "filterBuilding", bldID))
            End If
        End If
    
        cnt.Close
        Set cnt = Nothing
    
    Else
        
        Dim csrc As clsObj
        Dim ctrg As clsObj
        Set csrc = getEditField(fgSim, Row, Col, False)
        Set ctrg = getEditField(fgSim, Row, Col, True)
        If csrc Is Nothing Or ctrg Is Nothing Then
            Exit Sub
        Else
        
        
            Dim cn As New ADODB.Connection
            cn.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
       
        
            Dim var As Variant
            Dim strMes As String
            
            If getDbl(fgSim.TextMatrix(Row, Col)) <= 0 Then
                var = Null
                strMes = csrc.props("Column").propValue & " to default"
            Else
                var = getDbl(fgSim.TextMatrix(Row, Col))
                strMes = csrc.props("Column").propValue & " = " & var
            End If
            
            strSQL = ""
            
            If updateTableInBase2(cn, strSQL, _
                                    ctrg.props("Table").propValue, _
                                    ctrg.props("Field").propValue, _
                                    var, _
                                    ctrg.props("Key").propValue, _
                                    ctrg.objID) Then
                                    
                Call writeOperationS(operModify, "elemod", ctrg.objID, strMes)
                
                If right(strMes, 7) = "default" Then
                    Dim dval As Double
                
                    dval = selectDoubleFromBase(cn, csrc.props("Table").propValue, _
                                                    csrc.props("Field").propValue, _
                                                    csrc.props("Key").propValue, _
                                                    csrc.objID)
                
                    If dval = 0 Then
                        dval = selectDoubleFromBase(cn, csrc.props("TableIfNull").propValue, _
                                                        csrc.props("FieldIfNull").propValue, _
                                                        csrc.props("Key").propValue, _
                                                        csrc.objID)
                    
                    End If
                    
                    
                    fgSim.TextMatrix(Row, Col) = Format(dval * Val("1e" & csrc.props("Factor").propValue), "0.00")
                    fgSim.Cell(flexcpBackColor, Row, Col) = lngRowWinColor
                    fgSim.TextMatrix(Row, Col + 1) = ""
                Else
                    fgSim.TextMatrix(Row, Col) = getDbl(fgSim.TextMatrix(Row, Col))
                    fgSim.Cell(flexcpBackColor, Row, Col) = lngGrey
                    fgSim.TextMatrix(Row, Col + 1) = getDbl(fgSim.TextMatrix(Row, Col))
                End If
            
            Else
                MsgBox "fgSim_AfterEdit" & "() - cannot execute sql command:" & vbNewLine & strSQL
            End If
            
            cn.Close
            
            Set cn = Nothing
        
        
        End If
        
    End If
    
    Exit Sub
    
fgSim_AfterEdit_ERR:
    F1.SB.Panels("status").text = "fgSim_AfterEdit" & "() - " & err.Description
    If Len(Trim(strSQL)) > 0 Then MsgBox "fgSim_AfterEdit" & "() - " & err.Description & vbNewLine & strSQL
    
End Sub



'/******************************************************************************
Private Sub fgSim_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'/******************************************************************************

    On Error GoTo fgSim_AfterRowColChange_ERR

    Dim simID As Long
    simID = Val(fgSim.TextMatrix(NewRow, fgSim.ColIndex("simID")))
    
       
    If simID > 0 Then loadLog "elemod", simID


Exit Sub

fgSim_AfterRowColChange_ERR:
    F1.SB.Panels("status").text = "fgSim_AfterRowColChange" & "() - " & err.Description

End Sub

Private Function getEditField(fgSim As VSFlexGrid, ByVal Row As Long, ByVal Col As Long, bTarget As Boolean) As clsObj

On Error GoTo err

    Dim oView As clsConfigSimView
    Dim oViewFound As clsConfigSimView
    
    For Each oView In Config.SimViews
        Dim txtpos1, txtpos2 As Integer
        txtpos1 = InStr(oView.SqlQuery, "where pwdocID in")
        txtpos2 = InStr(fgSim.Tag, "where pwdocID in")
        If txtpos1 > 0 And txtpos1 = txtpos2 Then
            If left(oView.SqlQuery, txtpos1) = left(fgSim.Tag, txtpos2) Then
                Set oViewFound = oView
                Exit For
            End If
        End If
    Next
    
    
    If oViewFound Is Nothing Then Exit Function
    If oViewFound.cEditFields.Count = 0 Then Exit Function
    
    Dim i As Integer
    Dim c As clsObjVec
    'Set c = oViewFound.cEditFields(1) ' first member, must be LOOP !!!!!!!!.........
    
    For Each c In oView.cEditFields
        For i = 0 To fgSim.cols - 1
            If StrComp(fgSim.ColKey(i), c.src.props("Key").propValue, vbTextCompare) = 0 Then
            'If fgSim.ColKey(i) = c.src.props("Key").propValue Then
                c.setObjectID Val(fgSim.TextMatrix(Row, i))
            ElseIf StrComp(fgSim.ColKey(i), c.src.props("Column").propValue, vbTextCompare) = 0 Then
            'ElseIf fgSim.ColKey(i) = c.src.props("Column").propValue Then
                If Col = i Then
                    If bTarget Then Set getEditField = c.trg Else Set getEditField = c.src
                    Exit Function
                End If
            End If
        Next i
    Next
    
    
    
    Exit Function
err:
Set getEditField = Nothing

End Function


Private Sub fgSim2_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    fgSim_BeforeEdit_common fgSim2, Row, Col, Cancel
End Sub

Private Sub fgSim_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    fgSim_BeforeEdit_common fgSim, Row, Col, Cancel
End Sub

'/******************************************************************************
Private Sub fgSim_BeforeEdit_common(ByRef fgSim As VSFlexGrid, ByVal Row As Long, ByVal Col As Long, ByRef Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgSim_BeforeEdit_ERR

    Dim i As Integer
    
    fgSim.ComboList = ""


    Dim fcID As Long
    

    
    If fgSim.Col = 2 And fgSim.Tag = "room" Then
    
        If fgSim.TextMatrix(fgSim.Row, 0) = "0" Then
            Cancel = True
        Else
            Dim pr As clsPrp
            Set pr = curRoom.room_prps(fgSim.TextMatrix(fgSim.Row, 0))
            If pr.propvalName = "id" Then
                For i = 0 To UBound(prplisttypes)
                    If prplisttypes(i).prpID = pr.propID Then
                        If Len(fgSim.ComboList) > 0 Then fgSim.ComboList = fgSim.ComboList & "|"
                        fgSim.ComboList = fgSim.ComboList & "#" & prplisttypes(i).plID & ";" & prplisttypes(i).plValue
                    End If
                Next i
            ElseIf pr.propvalName = "secid" Then
'                fgSim.ComboList = "..."
                For i = 0 To UBound(prplisttypes)
                    If prplisttypes(i).prpID = pr.propID Then
                        If Len(fgSim.ComboList) > 0 Then fgSim.ComboList = fgSim.ComboList & "|"
                        
                        If pr.hasListValue(prplisttypes(i).plID) Then
                            fgSim.ComboList = fgSim.ComboList & "#" & prplisttypes(i).plID & ";" & prplisttypes(i).plValue & vbTab & "x"
                        Else
                            fgSim.ComboList = fgSim.ComboList & "#" & prplisttypes(i).plID & ";" & prplisttypes(i).plValue & vbTab & ""
                        End If
                    End If
                Next i
            End If
        End If
    
    ElseIf Not pwset.ispwdb Then
        If fgSim.Col = 0 And pwset.canedit_grid Then
        Else
            Cancel = True
        End If
        
    ElseIf fgSim.ColKey(fgSim.Col) = strFireAreaMan And InStr(fgSim.Tag, "FireCompartment") Then
    
        ' fire compartment
    
        fcID = CLng(Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireCompID))))
        If fcID = 0 Then Cancel = True
        
    ElseIf fgSim.ColKey(fgSim.Col) = strFireResMan And InStr(fgSim.Tag, "FireCompartment") Then
    
        ' fire compartment
    
        fcID = CLng(Val(fgSim.TextMatrix(Row, fgSim.ColIndex(strFireCompID))))
        If fcID = 0 Then Cancel = True
    
    Else
    
        Dim c As clsObj
        Set c = getEditField(fgSim, Row, Col, False)
        If c Is Nothing Then
            Cancel = True
            Exit Sub
        End If
    
    
    End If


Exit Sub

fgSim_BeforeEdit_ERR:
    Cancel = True
    F1.SB.Panels("status").text = "fgSim_BeforeEdit" & "() - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgSim_CellButtonClick(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgSim_CellButtonClick_ERR
    
    '...


Exit Sub

fgSim_CellButtonClick_ERR:
    F1.SB.Panels("status").text = "fgSim_CellButtonClick" & "() - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgSim_ComboCloseUp(ByVal Row As Long, ByVal Col As Long, FinishEdit As Boolean)
'/******************************************************************************

    On Error GoTo fgSim_ComboCloseUp_ERR
    
    FinishEdit = True


Exit Sub

fgSim_ComboCloseUp_ERR:
    F1.SB.Panels("status").text = "fgSim_ComboCloseUp" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSimDblClick(FG As VSFlexGrid)
'/******************************************************************************

    On Error GoTo fgSimDblClick_ERR

    If FG.MouseRow = 0 Then
    
    
'        FG.Select 0, FG.Col
        If FG.ColSort(FG.MouseCol) = flexSortGenericAscending Then
            FG.ColSort(FG.MouseCol) = flexSortGenericDescending
        Else
            FG.ColSort(FG.MouseCol) = flexSortGenericAscending
        End If
        
        FG.sort = flexSortUseColSort
        
    ElseIf FG.MouseRow > 0 Then

        Dim pwdocID As Long
        pwdocID = Val(FG.TextMatrix(FG.MouseRow, FG.ColIndex("pwdocID")))
        
        If pwdocID > 0 Then
            Call showWiseTreeItem(0, pwdocID)
        End If

    End If



Exit Sub

fgSimDblClick_ERR:
    F1.SB.Panels("status").text = "fgSimDblClick" & "() - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgSim_DblClick()
'/******************************************************************************

    On Error GoTo fgSim_DblClick_ERR

    If fgSim.Tag <> "room" Then fgSimDblClick fgSim






Exit Sub

fgSim_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSim_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************

    On Error GoTo fgSim_KeyDown_ERR


    If Me.tbWise.Buttons("CanChange").Value = tbrUnpressed Then Exit Sub

    If KeyCode = 46 And Shift = 1 Then
        ' delete....
    
    
    End If


Exit Sub

fgSim_KeyDown_ERR:
    F1.SB.Panels("status").text = "fgSim_KeyDown" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSimCrnt_MouseDown(ByRef fgSimCrnt As VSFlexGrid, Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgSim_MouseDown_ERR
    
    If Button <> 2 Then Exit Sub
    If fgSimCrnt Is Nothing Then Exit Sub
    
    Set fgSimCrntGlob = fgSimCrnt
    
    If fgSimCrnt.ColKey(fgSimCrnt.MouseCol) = "Civil Code" Then
        mnuSimDataCodes.Tag = "ccode"
        mnuSimDataCodes.Caption = "Зафиксировать код"
        PopupMenu mnuSimData, , , , mnuSimDataCodes
    ElseIf InStr(fgSimCrnt.Tag, "FireCompartment") Then
    
    
        With fgSimCrnt
            Dim i As Long
            Dim stp As Long
        
            If .RowSel < .Row Then stp = -1 Else stp = 1
    
            If fgSimCrnt.ColKey(fgSimCrnt.MouseCol) = strFireCode Then
        
'                For i = .Row To .RowSel Step stp
'                    If Val(.TextMatrix(i, .ColIndex(strFireCompID))) = 0 Then
'                        mnuSimDataCodes.Tag = "fccode"
'                        mnuSimDataCodes.Caption = "Сохранить код"
'                        PopupMenu mnuSimData, , , , mnuSimDataCodes
'                        Exit For
'                    End If
'                Next
        
            'ElseIf fgSimCrnt.ColKey(fgSimCrnt.MouseCol) = strFireRes Then
            Else
            
                For i = .Row To .RowSel Step stp
                    If Val(.TextMatrix(i, .ColIndex(strFireCompID))) > 0 Then
                        mnuSimDataCodes.Tag = "fcval"
                        mnuSimDataCodes.Caption = "Сохранить значения"
                        PopupMenu mnuSimData, , , , mnuSimDataCodes
                        Exit For
                    End If
                Next
            
            End If
    

        End With
    
        
    End If


Exit Sub

fgSim_MouseDown_ERR:
    F1.SB.Panels("status").text = "fgSimCrnt_MouseDown" & "() - " & err.Description

End Sub

Private Sub fgSim_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim, Button, Shift, X, Y
End Sub


Private Sub fgSim2_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim2, Button, Shift, X, Y
End Sub

Private Sub fgSim3_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim3, Button, Shift, X, Y

End Sub

Private Sub fgSim4_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim4, Button, Shift, X, Y

End Sub

Private Sub fgSim5_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim5, Button, Shift, X, Y

End Sub

Private Sub fgSim6_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    fgSimCrnt_MouseDown fgSim6, Button, Shift, X, Y

End Sub

'/******************************************************************************
Private Sub fgSim2_DblClick()
'/******************************************************************************

    On Error GoTo fgSim2_DblClick_ERR

    fgSimDblClick fgSim2




Exit Sub

fgSim2_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim2_DblClick" & "() - " & err.Description

End Sub



'/******************************************************************************
Private Sub fgSim3_DblClick()
'/******************************************************************************

    On Error GoTo fgSim3_DblClick_ERR


    fgSimDblClick fgSim3


Exit Sub

fgSim3_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim3_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSim4_DblClick()
'/******************************************************************************

    On Error GoTo fgSim4_DblClick_ERR


    fgSimDblClick fgSim4


Exit Sub

fgSim4_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim4_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSim5_DblClick()
'/******************************************************************************

    On Error GoTo fgSim5_DblClick_ERR

    fgSimDblClick fgSim5

Exit Sub

fgSim5_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim5_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSim6_DblClick()
'/******************************************************************************

    On Error GoTo fgSim6_DblClick_ERR

    fgSimDblClick fgSim6

Exit Sub

fgSim6_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSim6_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSimVol_DblClick()
'/******************************************************************************

    On Error GoTo fgSimVol_DblClick_ERR


    If fgSimVol.MouseRow = 0 Then

'        fgSimVol.Select 0, fgSimVol.Col

        If fgSimVol.ColSort(fgSimVol.MouseRow) = flexSortGenericAscending Then
            fgSimVol.ColSort(fgSimVol.MouseRow) = flexSortGenericDescending
        Else
            fgSimVol.ColSort(fgSimVol.MouseRow) = flexSortGenericAscending
        End If

        fgSimVol.sort = flexSortUseColSort
        
    ElseIf fgSimVol.MouseRow > 0 Then
'        Dim partID As Long
'        Dim catID As Long
'        partID = Val(fgSimVol.TextMatrix(fgSimVol.MouseRow, fgSimVol.ColIndex("partID")))
'        catID = Val(fgSimVol.TextMatrix(fgSimVol.MouseRow, fgSimVol.ColIndex("catID")))
'        If partID > 0 Then
'            goToPartFromList objs("part"), partID, catID
'        End If
    End If


Exit Sub

fgSimVol_DblClick_ERR:
    F1.SB.Panels("status").text = "fgSimVol_DblClick" & "() - " & err.Description

End Sub

Private Sub fgSpec_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)

On Error GoTo err

    If Button = 2 Then

    'fgSpec.Select fgSpec.MouseRow, fgSpec.MouseCol


    Dim objID  As Long
    Dim objectID As Long
    objID = objs("part")
    objectID = Val(fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("partID")))
    
    If objID = 0 Then Exit Sub
    If objectID = 0 Then Exit Sub
    
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    cmd.CommandText = "getPath2"
    cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
    cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objID)
    cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , objectID)
    cmd.Parameters.Append cmd.CreateParameter("nameshort", adInteger, adParamInput, , 30)
    cmd.Execute
    
    Dim strCatPath As String
    strCatPath = cmd.Parameters("ret") & ""
    
    Set tt = New CBalloonToolTip
    tt.Icon = TTNoIcon
'    If fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("objID")) = objs("part") Then
        tt.Title = "изделие " & fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("Наименование"))
'    ElseIf fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("objID")) = objs("catalog") Then
'        tt.Title = "каталог " & fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("Наименование"))
'    ElseIf fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("objID")) = objs("catlist") Then
'        tt.Title = "список " & fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("Наименование"))
'    Else
'        tt.Title = fgSpec.TextMatrix(fgSpec.MouseRow, fgSpec.ColIndex("Наименование"))
'    End If
    tt.PopupOnDemand = False
    'tt.ForeColor = vbBlue
    tt.Style = TTStandard
    tt.TipText = Replace(strCatPath, " - ", vbNewLine)
    tt.VisibleTime = 3000
    tt.DelayTime = 3000
    tt.CreateToolTip Me.hwnd
    tt.Show
    Timer2.Enabled = False
    Timer2.Enabled = True

    End If

err:

End Sub

'/******************************************************************************
Private Sub fgSrtm_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************
    
    On Error GoTo fgSrtm_AfterEdit_ERR
    
    Dim sp As clsStdPd
    If Len(fgSrtmPos.Tag) = 0 Then Exit Sub
    
    Dim ID As Long
    Dim spID As Long
    
    ID = Val(fgSrtm.ComboData(fgSrtm.ComboIndex))
    spID = Val(fgSrtmPos.Tag)
    
    
    If typeName(fgSrtm.RowData(Row)) = "String" Then
        
        If fgSrtm.RowData(Row) = "masscalc" Then
            If ID = 0 Then
                
                If updateTableInBase(cn_srtm, "r_standard_posdef", "mcID", Null, "relID", spID) Then
                    Set sp = globStdPosdefs(fgSrtmPos.Tag)
                    sp.loadByID spID ' перегружаем
                End If
                
            Else
                
                If updateTableInBase(cn_srtm, "r_standard_posdef", "mcID", ID, "relID", spID) Then
                    Set sp = globStdPosdefs(fgSrtmPos.Tag)
                    sp.loadByID spID ' перегружаем
                End If
                
            End If
        ElseIf fgSrtm.RowData(Row) = "usedrawsign" Then
            
            If updateTableInBase(cn_srtm, "r_standard_posdef", "useDrawSign", ID, "relID", spID) Then
                Set sp = globStdPosdefs(fgSrtmPos.Tag)
                sp.bUseDrawSgn = CBool(ID)
            End If
            
        Else
        End If
        
        
    Else
    End If
    
    
    
    
    
    
    Exit Sub
    
fgSrtm_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgSrtm_AfterEdit - Error"
    
End Sub

Private Sub fgSrtm_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    
    fgSrtm.ComboList = ""
    
    If Not checkGroupPerm(usrCurrent.groupID, "standard", operModify) Then
        Cancel = True
        Exit Sub
    End If
    
    
    If Len(fgSrtmPos.Tag) = 0 Then Cancel = True: Exit Sub
    
    If typeName(fgSrtm.RowData(Row)) = "String" Then
        
        '        Dim mcID As Long
        '        mcID = Val(fgSrtm.RowData(Row))
        
        If fgSrtm.RowData(Row) = "masscalc" Then
            Dim mc As clsMC
            fgSrtm.ComboList = "#0;" & "стандартный"
            For Each mc In globMassCalcs
                fgSrtm.ComboList = fgSrtm.ComboList & "|#" & mc.mcID & ";" & mc.mcName
            Next mc
        ElseIf fgSrtm.RowData(Row) = "usedrawsign" Then
            fgSrtm.ComboList = "#1;стандартный|#0;не использовать"
        Else
            Cancel = True
        End If
        
        
    Else
        Cancel = True
    End If
    
End Sub

'/******************************************************************************
Private Sub fgSrtmMat_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgSrtmMat_AfterEdit_ERR

    Dim matID As Long
    Dim stdpdID As Long
    Dim relID As Long
    

    If Col = 1 And Val(fgSrtmMat.TextMatrix(Row, 0)) = 0 Then
        matID = Val(fgSrtmMat.ComboData(fgSrtmMat.ComboIndex))
        stdpdID = Val(fgSrtmPos.Tag)
        
        If matID > 0 And stdpdID > 0 Then
            Dim RS As New ADODB.Recordset
            RS.Open "select * from r_stdpd_material where stdpdID = " & stdpdID & " and matID = " & matID, cn_srtm, adOpenStatic, adLockOptimistic
            If RS.EOF Then
                RS.AddNew
                RS.fields("stdpdID").Value = stdpdID
                RS.fields("matID").Value = matID
                RS.Update
                
                Dim mt As clsMat
                Set mt = globMats(CStr(matID))
                
                fgSrtmMat.TextMatrix(Row, 0) = mt.matID
                fgSrtmMat.TextMatrix(Row, 1) = mt.matName
                If mt.MAT_STD.stdID > 0 Then fgSrtmMat.TextMatrix(Row, 2) = mt.MAT_STD.FULLNUMBER & " - " & mt.MAT_STD.stdName
                
                fgSrtmMat.AddItem "0"
            End If
            RS.Close
            Set RS = Nothing
            
            
            
        End If
        
    End If



Exit Sub

fgSrtmMat_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgSrtmMat_AfterEdit - Error"

End Sub

'/******************************************************************************
Private Sub fgSrtmMat_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************
    
    On Error GoTo fgSrtmMat_BeforeEdit_ERR
    
    
    
    
    fgSrtmMat.ComboList = ""
    
    Cancel = Not checkGroupPerm(usrCurrent.groupID, "standard", operModify)
    
    If Cancel Then Exit Sub
    
    If Col = 1 And Val(fgSrtmMat.TextMatrix(Row, 0)) = 0 Then
        Dim RS As New ADODB.Recordset
        RS.Open "select matID, matName, stdFullNumber from view_r_material_standard order by matName, stdFullNumber", cn_srtm, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                
                If Len(fgSrtmMat.ComboList) > 0 Then fgSrtmMat.ComboList = fgSrtmMat.ComboList & "|"
                fgSrtmMat.ComboList = fgSrtmMat.ComboList & "#" & RS.fields("matID").Value & ";" & RS.fields("matName").Value & vbTab & RS.fields("stdFullNumber").Value
                
                RS.MoveNext
            Loop Until RS.EOF
        End If
        
        RS.Close
        Set RS = Nothing
    Else
        fgSrtmMat.ComboList = ""
        
    End If
    
    
    Exit Sub
    
fgSrtmMat_BeforeEdit_ERR:
    fgSrtmMat.ComboList = ""
    
End Sub

'/******************************************************************************
Private Sub fgSrtmMat_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************

    On Error GoTo fgSrtmMat_KeyDown_ERR

    If fgSrtmMat.Row < 1 Then Exit Sub

    If Not checkGroupPerm(usrCurrent.groupID, "standard", operModify) Then Exit Sub
    
    Dim matID As Long
    Dim stdpdID As Long
    
    matID = Val(fgSrtmMat.TextMatrix(fgSrtmMat.Row, 0))
    stdpdID = Val(fgSrtmPos.Tag)
    
    
    If KeyCode = 46 And matID > 0 And stdpdID > 0 Then
    
        If MsgBox("Удалить?", vbOKCancel, "") = vbCancel Then Exit Sub
        
        Dim iRecordsAffected As Integer
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_srtm
        cmd.CommandText = "DELETE FROM [r_stdpd_material] WHERE stdpdID = " & stdpdID & " AND matID = " & matID
        cmd.Execute iRecordsAffected
        Set cmd = Nothing
        If iRecordsAffected = 1 Then fgSrtmMat.RemoveItem fgSrtmMat.Row


        
        
    End If



Exit Sub

fgSrtmMat_KeyDown_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgSrtmMat_KeyDown - Error"

End Sub

'/******************************************************************************
Private Sub fgSrtmPos_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************
    
    On Error GoTo fgSrtmPos_AfterEdit_ERR
    
    Dim strProp As String
    Dim dValue As Double
    Dim sValue As String
    Dim prop As clsProp
    Dim srtm As clsSrtm
    
    
    '    If curSrtmPos Is Nothing Then
    '        fgSrtmPos_AfterSelChange 0, Col, Row, Col
    '    End If
    
    If Not curSrtmPos Is Nothing Then
        
        
        strProp = fgSrtmPos.ColKey(Col)
        
        If strProp = "srtmName" Then
            sValue = Trim(fgSrtmPos.TextMatrix(Row, Col))
            If Len(sValue) = 0 Then Exit Sub
            curSrtmPos.srtmName = sValue
            curSrtmPos.saveSrtm "изм. наименования"
            If curSrtmPos.bNew Then
                fgSrtmPos.TextMatrix(Row, fgSrtmPos.ColIndex("srtmID")) = curSrtmPos.srtmID
                Me.fgSrtmPos.Cell(flexcpBackColor, fgSrtmPos.Rows - 1, fgSrtmPos.ColIndex("srtmName")) = lngRowWinColor
                Me.fgSrtmPos.AddItem 0
                Me.fgSrtmPos.Cell(flexcpBackColor, fgSrtmPos.Rows - 1, fgSrtmPos.ColIndex("srtmName")) = lngBlue
            End If
        ElseIf strProp = "srtmUsing" Then
            curSrtmPos.bUsing = CBool(fgSrtmPos.TextMatrix(Row, Col))
            curSrtmPos.saveSrtm "изм. использования"
        Else
            dValue = getDbl(fgSrtmPos.TextMatrix(Row, Col))
            
            Set prop = globProps(strProp)
            
            Dim RS As New ADODB.Recordset
            RS.Open "select * from " & prop.sTableName & " where srtmID = " & curSrtmPos.srtmID, cn_srtm, adOpenKeyset, adLockOptimistic
            
            If RS.EOF Then
                RS.AddNew
                RS.fields("srtmID").Value = curSrtmPos.srtmID
            Else
                RS.MoveFirst
            End If
            
            If dValue = 0# Then
                RS.fields(strProp).Value = Null
                fgSrtmPos.TextMatrix(Row, Col) = ""
            Else
                RS.fields(strProp).Value = dValue
                fgSrtmPos.TextMatrix(Row, Col) = dValue
            End If
            RS.Update
            
            Call writeOperationS(operModify, "srtm", curSrtmPos.srtmID, strProp & " = " & CStr(dValue))
            
            RS.Close
            Set RS = Nothing
            
            
            If curSrtmPos.loadSrtm(Nothing, curSrtmPos.srtmID) Then curSrtmPos.loadSrtmProps
            
        End If
        
    ElseIf Not curMatPos Is Nothing Then
        
        'fgSrtmPos.ColKey(0) = "matID"
        'fgSrtmPos.ColKey(1) = "x"
        'fgSrtmPos.ColKey(2) = "matName"
        'fgSrtmPos.ColKey(3) = "matStd"
        
        strProp = fgSrtmPos.ColKey(Col)
        
        Dim posdefID As Long
        Dim pd As clsPD
        Dim iRA As Integer
        
        Dim nd As Node
        Set nd = tvSrtm.SelectedItem
        If nd Is Nothing Then Exit Sub
        
        posdefID = Val(right(nd.KEY, Len(nd.KEY) - Len(nd.Tag)))
        Set pd = globPosdefs(CStr(posdefID))
        
        
        
        
        If strProp = "x" Then
            
            If CBool(fgSrtmPos.TextMatrix(Row, Col)) Then ' on
                
                Dim RSS As New ADODB.Recordset
                RSS.Open "select * from [r_posdef_material] where posdefID = " & posdefID & " and matID = " & curMatPos.matID, cn_srtm, adOpenForwardOnly, adLockOptimistic
                If RSS.EOF Then
                    RSS.AddNew
                    RSS.fields("posdefID").Value = posdefID
                    RSS.fields("matID").Value = curMatPos.matID
                    RSS.Update
                    RSS.Close
                Else
                End If
                    
                Set RSS = Nothing
                
                curMatPos.pdc.Add pd, CStr(posdefID)
                
            Else ' off
                
                Dim cmd As New ADODB.Command
                cmd.ActiveConnection = cn_srtm
                cmd.CommandText = "DELETE FROM [r_posdef_material] WHERE posdefID = " & posdefID & " and matID = " & curMatPos.matID
                cmd.Execute iRA
                
                If iRA = 1 Then
                    Dim i As Integer
                    For i = 1 To curMatPos.pdc.Count
                        Set pd = curMatPos.pdc(i)
                        If pd.pdID = posdefID Then
                            curMatPos.pdc.Remove i
                            Exit For
                        End If
                    Next i
                Else
                    SB.Panels("status").text = "Ошибка записи в базу данных"
                End If
                
            End If
            
        End If
        
        
    End If
    
    
    Exit Sub
    
fgSrtmPos_AfterEdit_ERR:
    fgSrtmPos.TextMatrix(Row, Col) = "error"
    
End Sub



'/******************************************************************************
Private Sub fgSrtmPos_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'/******************************************************************************

    On Error GoTo fgSrtmPos_AfterRowColChange_ERR


    Dim srtmID As Long

    srtmID = Val(fgSrtmPos.TextMatrix(NewRow, fgSrtmPos.ColIndex("srtmID")))

    loadLog "srtm", srtmID


Exit Sub

fgSrtmPos_AfterRowColChange_ERR:
    Me.SB.Panels("status").text = "[" & err.Number & "] " & err.Description

End Sub

'/******************************************************************************
Private Sub fgSrtmPos_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgSrtmPos_BeforeEdit_ERR

    
    Dim srtmID As Long
    
    Cancel = Not checkGroupPerm(usrCurrent.groupID, "standard", operModify)
    If fgSrtmPos.Rows <= 1 Then Cancel = True
    If Row < 1 Then Cancel = True
    
    
    
    If Len(fgSrtmPos.Tag) > 0 Then
        
        Set curMatPos = Nothing
        
        srtmID = Val(fgSrtmPos.TextMatrix(Row, fgSrtmPos.ColIndex("srtmID")))
        
        If srtmID = 0 And Col <> fgSrtmPos.ColIndex("srtmName") Then Cancel = True ' позволяем сначала редактировать только наименование
        
'        If InStr(fgSrtmPos.ColKey(Col), "_") Then Cancel = True
        
        If srtmID = 0 Then
            Set curSrtmPos = New clsSrtm
        Else
            Set curSrtmPos = globSrtm(CStr(srtmID))
        End If
            
        curSrtmPos.stdpdID = Val(fgSrtmPos.Tag)
        
    Else
    
        If Col <> fgSrtmPos.ColIndex("x") Then Cancel = True
        
        If tvSrtm.SelectedItem Is Nothing Then Cancel = True ' потом нужен будет posdefID
        
        
        Set curSrtmPos = Nothing
        
        Dim matID As Long
        
        matID = Val(fgSrtmPos.TextMatrix(Row, fgSrtmPos.ColIndex("matID")))
        
        If matID = 0 Then
            Set curMatPos = New clsMat
        Else
            Set curMatPos = globMats(CStr(matID))
        End If
        
    End If
    
    
    
Exit Sub

fgSrtmPos_BeforeEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgSrtmPos_BeforeEdit - Error"

End Sub


Private Sub Form_Load()
        
    On Error GoTo m1 ' ec
    
    
    ReDim arListRem(0)
    
    If loadArm Then
        SB.Panels("arm").text = "OK"
    Else
        SB.Panels("arm").text = "--"
    End If
    
    
    'ez 2017-07-11 предварителное выключение видимости всех вкладок
    Dim tabi%
    For tabi% = 0 To tbSimData.NumTabs - 1
        tbSimData.TabVisible(tabi%) = False
    Next
    
    tbCats.Buttons("newproject").Enabled = checkGroupPerm(usrCurrent.groupID, "project", operModify)
    tbCats.Buttons("LoadAll").Value = GetSetting("Offtake2", "Size", "tbCats.LoadAll", tbrUnpressed)
    
    tbSpec.Buttons("Check").Value = GetSetting("Offtake2", "Size", "tbSpec.Check", tbrPressed)
    
    F1.top = GetSetting("Offtake2", "Size", "F1.top", F1.top)
    F1.left = GetSetting("Offtake2", "Size", "F1.Left", F1.left)
    F1.height = GetSetting("Offtake2", "Size", "F1.Height", F1.height)
    F1.width = GetSetting("Offtake2", "Size", "F1.Width", F1.width)
    
    mnuPrefLap.Checked = GetSetting("Offtake2", "Size", "mnuPrefLap.Checked", False)
    mnuPrefCatDelConfirm.Checked = GetSetting("Offtake2", "Size", "mnuPrefCatDelConfirm.Checked", True)
    mnuPrefPdSortByUse.Checked = GetSetting("Offtake2", "Size", "mnuPrefPdSortByUse.Checked", False)
    mnuPrefShowGridIcons.Checked = bFormGridsRedraw
    'mnuPrefShowGridIcons.Checked = GetSetting("Offtake2", "Size", "mnuPrefShowGridIcons.Checked", bFormGridsRedraw)
    
    mnuViewCatsStat(pst.pstRazrabotka).Checked = GetSetting("Offtake2", "Size", "pstRazrabotka", True)
    mnuViewCatsStat(pst.pstProvereno).Checked = GetSetting("Offtake2", "Size", "pstProvereno", True)
    mnuViewCatsStat(pst.pstArchive).Checked = GetSetting("Offtake2", "Size", "pstArchive", True)
    mnuViewCatsStat(pst.pstUstar).Checked = GetSetting("Offtake2", "Size", "pstUstar", True)
    
'    If usrCurrent.groupID = 1 Then
        fgOps.Visible = True
'    Else
'        fgOps.Visible = False
'    End If
    
    elList.width = GetSetting("Offtake2", "Size", "elList.Width", elList.width)
    elTabs.width = GetSetting("Offtake2", "Size", "elTabs.Width", elTabs.width)
    
    elCatsInf.width = GetSetting("Offtake2", "Size", "elCatsInf.Width", elCatsInf.width)
    
    elFgPart.width = GetSetting("Offtake2", "Size", "elFgPart.Width", elFgPart.width)
    
    elFgSrtm.width = GetSetting("Offtake2", "Size", "elFgSrtm.Width", elFgSrtm.width)
    
    fgCatParts.height = GetSetting("Offtake2", "Size", "fgCatParts.Height", fgCatParts.height)
    
    fgPart.ColAlignment(1) = flexAlignLeftCenter
    
    tvWise.width = GetSetting("Offtake2", "Size", "tvWise.width", tvWise.width)
    lvWise.ColumnHeaders(1).width = GetSetting("Offtake2", "Size", "lvWise.ColumnHeaders(1).width", lvWise.ColumnHeaders(1).width)
    lvWise.ColumnHeaders(2).width = GetSetting("Offtake2", "Size", "lvWise.ColumnHeaders(2).width", lvWise.ColumnHeaders(2).width)
    
'    F1.tbPart.Buttons("EditPart").Value = GetSetting("Offtake2", "Size", "EditPart", tbrUnpressed)
    F1.tbPart.Buttons("Collapsed").Value = GetSetting("Offtake2", "Size", "Collapsed", tbrUnpressed)
'    F1.tbPart.Buttons("SelFly").Value = GetSetting("Offtake2", "Size", "SelFly", tbrUnpressed)
    
    loadCatsTree2 CBool(Me.tbCats.Buttons("LoadAll").Value = tbrPressed) And usrCurrent.trusted
    
    loadSrtmTree
    
    ctabMain.BoldCurrent = True
    
    Dim nkey As String
    nkey = GetSetting("Offtake2", "Size", "tvCats.SelectedItem.Key", "")
    
    
    selectTreeNode nkey, tvCats
    
    
    tbSrtm.Buttons("NewPosdef").Enabled = checkGroupPerm(usrCurrent.groupID, "material", operModify)
    
    ' история операций только для админов
    'elExt.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
    
    tbCats.Buttons("newproject").Visible = checkGroupPerm(usrCurrent.groupID, "project", operCreate)
    
    tbCats.Buttons("FindCat").Visible = (usrCurrent.strLogin = "l_vibe")
    
    
    Dim ID As Long
    Dim tID As Long
    ID = GetSetting("Offtake2", "Size", "catID", 0)
    
    
    
    If tvCats.Nodes.Count = 0 Then
        ' all off
        Dim III As Integer
        
        If bFormTabsHide Then
        ctabMain.TabVisible(0) = False
        ctabMain.TabVisible(1) = False
        ctabMain.TabVisible(2) = False
        End If
        
        For III = 3 To ctabMain.NumTabs - 2
            ctabMain.TabVisible(III) = False
        Next
        
'        ctabMain.TabVisible(7) = True

        ctabMain.CurrTab = 7
        elList.width = 10
    Else
        If bFormTabsHide Then
        ctabMain.TabVisible(1) = False
        ctabMain.TabVisible(2) = False
        End If
        
        ctabMain.TabVisible(3) = True
        ctabMain.TabVisible(4) = True
'        ctabMain.TabVisible(7) = True

        ctabSrtm.CurrTab = 0
        ctabMain.TabVisible(6) = usrCurrent.trusted
    
        lngCurCatListID = GetSetting("Offtake2", "Size", "catListID", 0)
        
        If lngCurCatListID = 0 Then ' после того как убран usrlist - автоматическая копия в catlist
        
            lngCurCatListID = createCatListFromUsrlist(ID)
        
        End If
        
        If lngCurCatListID > 0 Then loadListGrid lngCurCatListID, , False
        
        
        tID = loadCatalog(ID, True, 0, False, False) ' перегружаем каталог, изде. выделяем позже, вкладку активируем позже, список загружаем позже
    
    '    Dim cat As clsCat
    '    Set cat = cCats(CStr(ID))
        
        If tID > 0 Then
            
            nkey = GetSetting("Offtake2", "Size", "tvParts.SelectedItem.Key", "")
            tvPartsSelectItem nkey
            
    '        If cat.catTypeID = 1 Then loadSpec
    '        loadOfftake
            
            Dim ct As Integer
            ct = GetSetting("Offtake2", "Size", "ctabMain.CurrTab", 0)
            If Not ctabMain.TabVisible(ct) = False Then
                ctabMain.CurrTab = ct
            End If
            
        Else
            ctabMain.CurrTab = 0
            
        End If
    End If
    
    
    
    
    
'    If StrComp(conn.strSrtmName, conn.strBaseName, vbTextCompare) = 0 Then
        SB.Panels("srv").text = conn.strServerName & " (" & pwset.server & ") " & " : " & conn.strBaseName & " (" & strCurSimBase & ")  "
'    Else
'        SB.Panels("srv").text = conn.strServerName & " srtm: " & conn.strSrtmName & " data: " & conn.strBaseName & "  "
'    End If
    
'    If pwset.connected Then SB.Panels("srv").text = SB.Panels("srv").text & "pw:" & pwset.server & "  "
    
    SB.Panels("srv").AutoSize = sbrContents
    
    SB.Panels("prov").text = conn.strProvStatus
    SB.Panels("prov").AutoSize = sbrContents
    
    
    Me.tbCats.Buttons("LoadAll").Visible = usrCurrent.trusted
    
    
    lngCmdCatIDs(1) = GetSetting("Offtake2", "Size", "lngCmdCatIDs(1)", 0)
    lngCmdCatIDs(2) = GetSetting("Offtake2", "Size", "lngCmdCatIDs(2)", 0)

'    If lngCmdCatIDs(1) > 0 Then Call loadCmdCatalog(Me.fgCommanderLeft, lblCmdLeft, lngCmdCatIDs(1))
'    If lngCmdCatIDs(2) > 0 Then Call loadCmdCatalog(Me.fgCommanderRight, lblCmdRight, lngCmdCatIDs(2))
    
'    mnuPrefRound03.Checked = GetSetting("Offtake2", "Size", "mnuPrefRound03.Checked", True)
'    mnuPrefUseRein.Checked = GetSetting("Offtake2", "Size", "mnuPrefUseRein.Checked", False)
    
    mnuViewOnTop.Checked = GetSetting("Offtake2", "Size", "mnuViewOnTop.Checked", False)
    mnuViewShowPart.Checked = GetSetting("Offtake2", "Size", "mnuViewShowPart.Checked", False)
    
    mnuListSyncLoad.Checked = GetSetting("Offtake2", "Size", "mnuListSyncLoad.Checked", False)
    mnuListSyncList.Checked = GetSetting("Offtake2", "Size", "mnuListSyncList.Checked", True)
    mnuListSortAuto.Checked = GetSetting("Offtake2", "Size", "mnuListSortAuto.Checked", True)
    lngSpecDefaultRows = GetSetting("Offtake2", "Size", "lngSpecDefaultRows", 300)
    lngSpecLastRows = GetSetting("Offtake2", "Size", "lngSpecLastRows", 5)
    lngSpecFirstRows = GetSetting("Offtake2", "Size", "lngSpecFirstRows", 0)
    blnSpecLastRows = GetSetting("Offtake2", "Size", "blnSpecLastRows", False)
    blnDrawSpecCap = GetSetting("Offtake2", "Size", "blnDrawSpecCap", True)
    blnSortDiam = GetSetting("Offtake2", "Size", "blnSortDiam", False)
    blnSkipEmpty = GetSetting("Offtake2", "Size", "blnSkipEmpty", False)
    
    
    mnuPrefLoadPics.Visible = usrCurrent.trusted
'    Me.tbPart.Buttons("EditPart").Value = tbrPressed
'    Me.tbPart.Buttons("EditPart").Visible = False
    
    iSketchRadiusOpt = GetSetting("Offtake2", "Size", "iSketchRadiusOpt", 0)
    iSketchRadiusVal = GetSetting("Offtake2", "Size", "iSketchRadiusVal", 200)
    iSketchScaleLft = GetSetting("Offtake2", "Size", "iSketchScaleLft", 1)
    iSketchScaleRgt = GetSetting("Offtake2", "Size", "iSketchScaleRgt", 1)
    iSketchShowDialog = GetSetting("Offtake2", "Size", "iSketchShowDialog", 1)
    iSketchScaleHor = GetSetting("Offtake2", "Size", "iSketchScaleHor", 0)
    iSketchScaleVer = GetSetting("Offtake2", "Size", "iSketchScaleVer", 0)
    
    iSketchCellWidth = GetSetting("Offtake2", "Size", "iSketchCellWidth", 8000)
    iSketchCellHeight = GetSetting("Offtake2", "Size", "iSketchCellHeight", 4000)
    iSketchMaxHeight = GetSetting("Offtake2", "Size", "iSketchMaxHeight", 30000)
    
    iSpecAlign = GetSetting("Offtake2", "SpecParams", "iSpecAlign", 0)
    
    dSpecCmnScale = GetSetting("Offtake2", "SpecParams", "dSpecCmnScale", scfgCmn.spec_table_scale)
    
    SetAlwaysOnTopMode Me.hwnd, mnuViewOnTop.Checked
    
    If mnuViewShowPart.Checked Then
        Load frmPartImage
        frmPartImage.Show
    End If
    
    Dim i As Integer
    For i = 0 To UBound(arBases)
        cmbCmd(0).AddItem arBases(i)
        cmbCmd(1).AddItem arBases(i)
    Next i
    
    cmbCmd(0).ListIndex = 0
    cmbCmd(1).ListIndex = 0
    
    fgCmd(0).ColHidden(0) = True
    fgCmd(0).ColHidden(1) = True
    fgCmd(1).ColHidden(0) = True
    fgCmd(1).ColHidden(1) = True
    
    mnuCatsTreeGetIds.Visible = usrCurrent.trusted
    
    Dim pds As clsPDSet
    For Each pds In globPDSets
        Me.mnuPrefPosdefSet(pds.pdID).Caption = pds.pdsNameAlt
        Me.mnuPrefPosdefSet(pds.pdID).Visible = True
    Next pds
    
    Me.mnuPrefPosdefSet(usrCurrent.pdsID).Checked = True
    
    mnuPrefLoadListByView.Checked = Not bOfftNew
    
    If usrCurrent.pdsID = 0 Then
        mnuPrefPdSortByUse.Enabled = False
    End If
    
    
    Dim usp As clsSCfg
    Dim Index As Integer
    For Each usp In scfgs
        If usp.spcfgID > 0 Then
            Index = Index + 1
            Load mnuCatsTreeUserSpecVal(Index)
            mnuCatsTreeUserSpecVal(Index).Tag = usp.spcfgID
            mnuCatsTreeUserSpecVal(Index).Caption = usp.spcfgListName
            mnuCatsTreeUserSpecVal(Index).Visible = False
        End If
    Next usp
    
    
    Dim pd As clsPD
    Dim pdcnt As Integer
    For Each pd In globPosdefs
    
        
        If pd.pdID = 12 Then
            Debug.Print ""
        End If
    
        If pd.iMassLevel > 0 Then
            If pdcnt > 0 Then
                Load mnuOfftMassLevel(pdcnt)
            End If
            mnuOfftMassLevel(pdcnt).Caption = pd.PD_NAME
            mnuOfftMassLevel(pdcnt).Tag = pd.pdID
            pdcnt = pdcnt + 1
        End If
    Next pd
    
    
    If pwset.connected Then
        reloadData2
        Me.tbWise.Buttons("CanChange").Enabled = pwset.canedit
    Else
        'Me.tbWise.Enabled = False
    End If
    
    
    If usrCurrent.groupID = 4 Then Me.tbWise.Buttons("CanChange").Enabled = False
    
    
    nkey = GetSetting("Offtake2", "Size", "tvWise.SelectedItem.Key", "")
    selectTreeNode nkey, tvWise
    
    Me.mnuHelpUpdateSim.Enabled = CBool(IsUserAnAdmin)
    
    
    For i = 1 To pwsets.Count
        If Len(pwsets(i).text) > 0 And i <= Me.tbWise.Buttons("Reload").ButtonMenus.Count Then
            Me.tbWise.Buttons("Reload").ButtonMenus(i).Visible = True
            Me.tbWise.Buttons("Reload").ButtonMenus(i).text = pwsets(i).text
            Me.tbWise.Buttons("Reload").ButtonMenus(i).Tag = pwsets(i).text
            If pwset.server = pwsets(i).server Then Me.tbWise.Buttons("Reload").ButtonMenus(i).text = ">>> " & pwsets(i).text
        End If
    Next i
    
    Dim o As clsObj
    For i = 1 To imps.Count
        Set o = imps(i)
        If o.props("app").propValue = "Excel" And i < Me.tbRein.Buttons("Excel").ButtonMenus.Count Then
            Me.tbRein.Buttons("Excel").ButtonMenus(i + 1).Visible = True
            Me.tbRein.Buttons("Excel").ButtonMenus(i + 1).text = o.props("name").propValue
            Me.tbRein.Buttons("Excel").ButtonMenus(i + 1).Tag = o.KEY
        End If
    Next i
    
    
   
    
    Me.mnuHelpVideo.Enabled = False
    If Len(strHelpPath) > 0 Then
        If FileExists(strHelpPath) Then
            Me.mnuHelpVideo.Enabled = True
        End If
    End If
    
    
    
    Exit Sub
   
m1:
    Me.SB.Panels("status").text = err.Description
    
    
End Sub

'/******************************************************************************
Private Function selectTreeNode(nkey As String, ByRef tvTree As TreeView) As Boolean
'/******************************************************************************

    On Error GoTo selectTreeNode_ERR

    If Len(nkey) > 0 Then
        Set tvTree.SelectedItem = tvTree.Nodes(nkey)
    End If
    
    tvTree.SelectedItem.EnsureVisible
    
    selectTreeNode = True

Exit Function

selectTreeNode_ERR:
selectTreeNode = False

End Function



'/******************************************************************************
Private Sub tvPartsSelectItem(nkey As String)
'/******************************************************************************
    
    On Error GoTo tvPartsSelectItem_ERR
    
    If Len(nkey) > 0 And tvParts.Nodes.Count > 1 Then
        
        Set tvParts.SelectedItem = tvParts.Nodes(nkey)
        
    End If
    
    tvParts.SelectedItem.EnsureVisible
    
    
    Exit Sub
    
tvPartsSelectItem_ERR:
    
End Sub


'/******************************************************************************
Public Function loadOfftGrid() As Boolean
'/******************************************************************************

    On Error GoTo loadOfftGrid_ERR
    
    fgOfftake.loadGrid App.path & "\offt.grid", flexFileAll
    
    loadOfftGrid = True

Exit Function

loadOfftGrid_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadOfftGrid - Error"

End Function

'/******************************************************************************
Public Function addToCol(Col As colOG, wta As clsOU, sKey As String, iLev As Integer) As Boolean
'/******************************************************************************

    On Error GoTo addToCol_ERR

    
    Dim ou As clsOU
    
    Set ou = Col(sKey)
    
    If ou Is Nothing Then
        If iLev > 0 Then err.Raise 100, , "Ошибка при расчете многоуровневой выборки"
        Col.Add wta, sKey
'        If iLev = 0 Then Col.Add wta, sKey
    Else
        ou.arOuMass(iLev) = ou.arOuMass(iLev) + wta.arOuMass(iLev)
        If ou.pd.mcID = 1 Then ou.qty = ou.qty + wta.qty
        
    End If
    
    
    addToCol = True

    

Exit Function

addToCol_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "addToCol - Error"
    Me.SB.Panels("status").text = err.Description

End Function



'/******************************************************************************
Public Function getCol(Col As Collection, sKey As String) As colOG
'/******************************************************************************

    On Error GoTo getCol_ERR
    
    Set getCol = Col(sKey)

Exit Function

getCol_ERR:
    Set getCol = Nothing

End Function

'/******************************************************************************
Public Function getColPos(Col As Collection, strKey As String, Optional bQtyZero As Boolean = True) As clsPos
'/******************************************************************************

    On Error GoTo getColPos_ERR
    
    Set getColPos = Col(strKey)

Exit Function

getColPos_ERR:
    Dim p As New clsPos
    If bQtyZero Then p.posQty = 0
    Col.Add p, strKey
    Set getColPos = p

End Function

' see getColPart in clsSG
''/******************************************************************************
'Public Function getColPart(Col As Collection, strKey As String) As clsPart
''/******************************************************************************
'
'    On Error GoTo getColPart_ERR
'
'    Set getColPart = Col(strKey)
'
'Exit Function
'
'getColPart_ERR:
'    Dim prt As New clsPart
'    Col.Add prt, strKey
'    Set getColPart = prt
'
'
'End Function


'/******************************************************************************
Public Sub saveOfftake(catListID As Long)
'/******************************************************************************

    On Error GoTo saveOfftake_ERR


Exit Sub

saveOfftake_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "saveOfftake - Error"

End Sub



'/******************************************************************************
Public Sub loadOfftake3(catListID As Long, strSQL As String)
'/******************************************************************************

    On Error GoTo loadOfftake3_ERR

    Dim RS As New ADODB.Recordset
    Dim pos As clsPos
    Dim cPos As New Collection
    Dim smID As Long
    Dim mtID As Long
    Dim partdefID As Long
    
    Dim smu As String



    RS.Open strSQL, cn_data, adOpenStatic, adLockReadOnly

    If RS.EOF Then
        RS.Close
        Set RS = Nothing
        Exit Sub
    End If


    RS.MoveFirst
    Do
        smID = Val(RS.fields("srtmID").Value & "")
        mtID = Val(RS.fields("matID").Value & "")
        smu = CStr(RS.fields("mu").Value & "")
        partdefID = Val(RS.fields("partdefID").Value & "")
        Set pos = getColPos(cPos, CStr(smID) & "-" & CStr(mtID) & "-" & smu)
'        Set pos = getColPos(cPos, CStr(smID) & "-" & CStr(mtID))
        If pos.POS_SRTM.srtmID = 0 Then
            pos.setSrtm smID, False, False
            pos.matID = mtID
            pos.posUMass = 0
        End If
        
        pos.partID = partdefID
        
        If Len(pos.sSegmArcLens) > 0 Then pos.sSegmArcLens = pos.sSegmArcLens & ","
        pos.sSegmArcLens = pos.sSegmArcLens & RS.fields("kks").Value
        pos.sSegmLineLens = RS.fields("mu").Value
        pos.posCMass = pos.posCMass + RS.fields("mass").Value
        
        If pos.POS_SRTM.srtmID = 1141 Then
        Debug.Print ""
        End If
        
        
'        If pos.POS_MCALC.mcID = 1 Then
            pos.posQty = pos.posQty + RS.fields("qty").Value
            If pos.posQty > 0 Then pos.posUMass = pos.posCMass / pos.posQty
'        End If

        If pos.POS_MCALC.mcID = 5 Then
            pos.sSegmLineLens = ""
            pos.posQty = 0#
        End If
        
        RS.MoveNext
    Loop Until RS.EOF
    
    RS.Close
    Set RS = Nothing


    fgOfftake.cols = 14
    
    
    fgOfftake.TextMatrix(0, 1) = "материал"
    fgOfftake.TextMatrix(0, 2) = "позиция"
    fgOfftake.TextMatrix(0, 3) = "стандарт"
    fgOfftake.TextMatrix(0, 4) = "артикул"
    fgOfftake.TextMatrix(0, 5) = "наим."
    fgOfftake.TextMatrix(0, 6) = "кол-во"
    fgOfftake.TextMatrix(0, 7) = "изм"
    fgOfftake.TextMatrix(0, 8) = "м.ед."
    fgOfftake.TextMatrix(0, 9) = "м.общ."
    fgOfftake.TextMatrix(0, 10) = "srtmID"
    fgOfftake.TextMatrix(0, 11) = "matID"
    fgOfftake.TextMatrix(0, 12) = "partdefID"
    
    fgOfftake.ColKey(1) = "Mat"
    fgOfftake.ColKey(2) = "PD"
    fgOfftake.ColKey(3) = "Std"
    fgOfftake.ColKey(4) = "art"
    fgOfftake.ColKey(5) = "PN"
    fgOfftake.ColKey(6) = "qty"
    fgOfftake.ColKey(7) = "mu"
    fgOfftake.ColKey(8) = "umass"
    fgOfftake.ColKey(9) = "mass"
    fgOfftake.ColKey(10) = "srtmID"
    fgOfftake.ColKey(11) = "matID"
    fgOfftake.ColKey(12) = "partdefID"
    
    fgOfftake.ColDataType(1) = flexDTString
    fgOfftake.ColDataType(2) = flexDTString
    fgOfftake.ColDataType(3) = flexDTString
    fgOfftake.ColDataType(4) = flexDTLong
    fgOfftake.ColDataType(5) = flexDTString
    fgOfftake.ColDataType(6) = flexDTDouble
    fgOfftake.ColDataType(7) = flexDTString
    fgOfftake.ColDataType(8) = flexDTDouble
    fgOfftake.ColDataType(9) = flexDTDouble
    fgOfftake.ColDataType(10) = flexDTLong
    fgOfftake.ColDataType(11) = flexDTLong
    fgOfftake.ColDataType(12) = flexDTLong

    fgOfftake.ColFormat(fgOfftake.ColIndex("umass")) = sFmt3
    fgOfftake.ColFormat(fgOfftake.ColIndex("mass")) = sFmt3

    If Not usrCurrent.strLogin = "l_vibe" Then
'    fgOfftake.ColHidden(fgOfftake.ColIndex("key")) = True
    fgOfftake.ColHidden(fgOfftake.ColIndex("srtmID")) = True
    fgOfftake.ColHidden(fgOfftake.ColIndex("matID")) = True
    fgOfftake.ColHidden(fgOfftake.ColIndex("partdefID")) = True
'    fgOfftake.ColHidden(fgOfftake.ColIndex("mc")) = True
'    fgOfftake.ColHidden(fgOfftake.ColIndex("offt")) = True
    End If


    For Each pos In cPos
    
        Dim pr As clsProp
        Dim strArt As String
        strArt = ""
        If pos.pos_props.existsProperty("article") Then
            Set pr = pos.pos_props("article")
            If pr.hasValue Then
                strArt = pr.propValue
            End If
        End If
    
        fgOfftake.AddItem vbTab & pos.POS_MAT.matName & pos.POS_MAT.MAT_STD.FULLNUMBER & vbTab & _
                                pos.POS_PD_NAME & vbTab & _
                                pos.POS_STD_FULLNUMBER & vbTab & _
                                strArt & vbTab & _
                                pos.POS_SRTM.srtmName & vbTab & _
                                Format(pos.posQty, "0.###") & vbTab & _
                                pos.sSegmLineLens & vbTab & _
                                Format(pos.posUMass, "0.000") & vbTab & _
                                Format(pos.posCMass, "0.000") & vbTab & _
                                pos.POS_SRTM.srtmID & vbTab & _
                                pos.POS_MAT.matID & vbTab & _
                                pos.partID & vbTab & _
                                pos.sSegmArcLens
                                
    Next pos

    fgOfftake.ColAlignment(fgOfftake.ColIndex("PN")) = flexAlignLeftCenter

    fgOfftake.Select 1, fgOfftake.ColIndex("PD")
    fgOfftake.sort = flexSortStringAscending
    fgOfftake.Subtotal flexSTSum, -1, fgOfftake.ColIndex("mass"), "0.000", lngGrey, , True, "Всего"

    tbOfftake.Buttons("Draw").Enabled = False

    
    Me.SB.Panels("offtmass").text = "Выборка: " & Format(fgOfftake.TextMatrix(fgOfftake.Rows - 1, fgOfftake.ColIndex("mass")), sFmt1) & "  "
    Me.SB.Panels("offtmass").AutoSize = sbrContents

Exit Sub

loadOfftake3_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadOfftake3 - Error"

End Sub


'/******************************************************************************
Public Sub loadOfftake2(objectID As Long, strSQL As String, objID As Long, Optional iOuMasLev As Integer = 0, Optional bCalcInner As Boolean = True, Optional dPartQty As Double = 1#)
'/******************************************************************************
    
    On Error GoTo loadOfftake2_ERR
    
    Dim RS As New ADODB.Recordset
    
    Dim offt As colOG
    Dim ou As clsOU
    
    Dim sMat As String
    Dim sKey As String
    Dim curPartDef As Long
    curPartDef = -1
    
    
    
    Dim i As Integer
    
    
    If Len(strSQL) = 0 Then
        strSQL = "SELECT partdefID, srtmID, matID, sum(mass) as mass, sum(qty) as qty FROM "
        strSQL = strSQL & conn.strBaseName & ".dbo." & strFuncNameOfftake1 & "("
        strSQL = strSQL & objectID & "," & objID & ",1"
        strSQL = strSQL & "," & Abs(CInt(Me.tbOfftake.Buttons("Nulls").Value = tbrPressed))
        strSQL = strSQL & ",-1, 1" ' пассивность, коэффициент параметров из имени
        strSQL = strSQL & ") group by partdefID, srtmID, matID"
    End If
    
    
    
    RS.Open strSQL, cn_data, adOpenStatic, adLockReadOnly
    
    
    
    If RS.EOF Then
        RS.Close
        Set RS = Nothing
        Exit Sub
    End If
    
'    Set Me.fgOfftake.DataSource = RS
'    RS.Close
'    Set RS = Nothing
'    Exit Sub


    If iOuMasLev = 0 Then Me.PB.Min = 0:    Me.PB.Max = RS.RecordCount
    i = 0
    
    RS.MoveFirst
    Do
        
        '==================================================
        Set ou = New clsOU
        
        ou.pos.setSrtm RS.fields("srtmID").Value, False, False
        
'        If ou.pos.POS_SRTM.srtmID = 236 Then
'        Debug.Print
'        End If
        
         ' дублирование для совместимости
         '=====================================
        ou.smName = ou.pos.POS_SRTM.srtmName
        ou.srtmID = ou.pos.POS_SRTM.srtmID
        Set ou.pd = ou.pos.POS_PD
         '=====================================
         
        ' ========= отрывок из конфигурации ==================
        '        <Offtake>
        '            ...
        '            <mass_common>
        '                <spcfgid16 name="settings for El-Dabaa">
        '                    <posdef id="12" value="true"/>
        '                </spcfgid16>
        '                <spcfgid18>
        '                    <posdef id="12" value="true"/>
        '                </spcfgid18>
        '            </mass_common>
        '        </Offtake>
        If Len(offtcfg("mass_common")("spcfgid" & curSpecCfg.spcfgID)("posdef" & ou.pd.pdID).attval("value")) > 0 Then
            ou.pd.bMassCommon = CBool(offtcfg("mass_common")("spcfgid" & curSpecCfg.spcfgID)("posdef" & ou.pd.pdID).attval("value"))
        End If
        ' ===========================
    
        If Not IsNull(RS.fields("matID").Value) Then
            ou.pos.setMaterial RS.fields("matID").Value, False
        End If
        
        Set ou.pos.parentPart = New clsPart
        
        If Not ou.pos.POS_PD.bMassCommon Then ou.pos.parentPart.partdefID = RS.fields("partdefID").Value
'        ou.pos.parentPart.partdefID = RS.Fields("partdefID").Value

'If ou.pos.parentPart.partdefID = 0 Then
'Debug.Print ""
'End If
        
        ou.arOuMass(iOuMasLev) = Round(RS.fields("mass").Value, 3)
        If iOuMasLev > 0 Then ou.arOuMass(iOuMasLev) = ou.arOuMass(iOuMasLev) * dPartQty
        If ou.pd.mcID = 1 Then ou.qty = Round(RS.fields("qty").Value, 3)
        '==================================================
        
        sKey = Format(Abs(CInt(ou.pos.POS_PD.bMassCommon)), "0") & "-" & Format(globPartDefs(CStr(ou.pos.parentPart.partdefID)).partdefSort, "000")
'        sKey = Format(partdefs(ou.pos.parentPart.partdefID).partdefSort, "000") & "-" & Format(Abs(CInt(ou.pos.POS_PD.bMassCommon)), "0")
        
        Set offt = getCol(offts, sKey)
        
        If offt Is Nothing Then
            Set offt = New colOG
            offt.bComonMass = ou.pos.POS_PD.bMassCommon
            offt.partdefID = ou.pos.parentPart.partdefID
            offts.Add offt, sKey
            Set offt = getCol(offts, sKey)
        End If
        
'        If ou.pos.POS_PD.pdID = 12 Then
'            Debug.Print ""
'        End If
'
        
        If ((Me.tbOfftake.Buttons("Nulls").Value = tbrUnpressed And ou.arOuMass(iOuMasLev) > 0# And ou.pos.getMassLevel(True) = 0) Or _
            Me.tbOfftake.Buttons("Nulls").Value = tbrPressed) Then
            
            Call addToCol(offt, ou, ou.KEY, iOuMasLev)
            
            
        End If
        
        Set ou = Nothing
        
        RS.MoveNext
        If iOuMasLev = 0 Then Me.PB.Value = i:      Me.PB.Refresh
        i = i + 1
    Loop Until RS.EOF
    
    RS.Close
    Set RS = Nothing
    
    
    If iOuMasLev > 0 Then Exit Sub ' остальное только для общей массы
    
    
    Set offts = sortCollection(offts)
    
    
    fgOfftake.cols = 15
    
    
    fgOfftake.ColKey(1) = "PrtD"
    fgOfftake.ColKey(2) = "PDG"
    fgOfftake.ColKey(3) = "Mat"
    fgOfftake.ColKey(4) = "Std"
    fgOfftake.ColKey(5) = "PD"
    fgOfftake.ColKey(6) = "PN"
    fgOfftake.ColKey(7) = "mass"
    fgOfftake.ColKey(8) = "qty"
    fgOfftake.ColKey(9) = "key"
    fgOfftake.ColKey(10) = "srtmID"
    fgOfftake.ColKey(11) = "mc"
    fgOfftake.ColKey(12) = "offt"
    fgOfftake.ColKey(13) = "matID"
    fgOfftake.ColKey(14) = "partdefID"
    
    fgOfftake.ColFormat(fgOfftake.ColIndex("mass")) = sFmt1
    fgOfftake.ColFormat(fgOfftake.ColIndex("qty")) = "#"
    
    
    If Not usrCurrent.strLogin = "l_vibe" Then
        fgOfftake.ColHidden(fgOfftake.ColIndex("key")) = True
    '    fgOfftake.ColHidden(fgOfftake.ColIndex("srtmID")) = True
        fgOfftake.ColHidden(fgOfftake.ColIndex("mc")) = True
        fgOfftake.ColHidden(fgOfftake.ColIndex("offt")) = True
        For i = 0 To fgOfftake.cols - 1
            If right(LCase(fgOfftake.TextMatrix(0, i)), 2) = "id" Then
                fgOfftake.ColHidden(i) = True
            End If
        Next i
    End If
    
    
    
    Dim j As Integer
    Dim k As Integer
    
    
    
    
    
    
    i = 1
    For Each offt In offts
        If offt.Count = 0 Then
            offts.Remove i
        Else

            'Debug.Print "1111111111111111111111111111111111111"
            'For Each ou In offt
            '    Debug.Print ou.KEY, ou.arOuMass(0)
            'Next ou
            
            offt.sort
            
            offt.checkPosdefIsMatEmpty
            
            'Debug.Print "2222222222222222222222222222222222222"
            'For Each ou In offt
            '    Debug.Print ou.KEY, ou.arOuMass(0)
            'Next ou
            
'            If bFillGrid Then
            
                For Each ou In offt
                
                    sKey = ou.KEY
                    
                    If ou.pos.POS_MAT.matID > 0 Then
                        'sMat = ou.pos.POS_MAT.matName & " " & ou.pos.POS_MAT.matStd.FULLNUMBER
                        
                        'ou.pos.bTranslateStdType = CBool(curSpecCfg.iTrans = 2)
                        
                        If Len(curSpecCfg.offtMatMask) = 0 Then
                            sMat = ou.pos.POS_MAT.getClass(curSpecCfg.bNewAC, curSpecCfg.bOldAC) & " " & _
                                            ou.pos.POS_MAT.getReinMatName & "|" & _
                                            ou.pos.POS_MAT.MAT_STD.FULLNUMBER
                        Else
                            sMat = curSpecCfg.offtMatMask
                            sMat = Replace(sMat, "[CLS]", ou.pos.POS_MAT.getClass(curSpecCfg.bNewAC, curSpecCfg.bOldAC))
                            sMat = Replace(sMat, "[RMAT]", ou.pos.POS_MAT.getReinMatName)
                            sMat = Replace(sMat, "[MAT]", ou.pos.POS_MAT.matName)
                            sMat = Replace(sMat, "[STD]", ou.pos.POS_MAT_STD_FULLNUMBER)
                        End If
                        
                        ' если offtMatMask обнулил sMat - используем стандартный вариант
                        If Len(Trim(sMat)) = 0 Then
                            sMat = ou.pos.POS_MAT.getClass(curSpecCfg.bNewAC, curSpecCfg.bOldAC) & " " & _
                                            ou.pos.POS_MAT.getReinMatName & "|" & _
                                            ou.pos.POS_MAT.MAT_STD.FULLNUMBER
                        End If
                        
                    Else
                        sMat = ""
                    End If
                    
                    j = j + 1
                    
                    Dim strQty As String
                    If ou.qty = 0 Then strQty = "" Else strQty = ou.qty
                
                    fgOfftake.AddItem vbTab & globPartDefs(CStr(ou.pos.parentPart.partdefID)).partdefNameMulti & vbTab & _
                                      globPosdefs(ou.pos.POS_PD.pdIDGlobal).pdNameMulti & vbTab & _
                                      sMat & vbTab & _
                                      ou.pos.POS_STD_FULLNUMBER & vbTab & _
                                      ou.pos.POS_PD_NAME & vbTab & _
                                      ou.pos.POS_SRTM.srtmName & vbTab & _
                                      Format(ou.arOuMass(0), sFmt1) & vbTab & _
                                      strQty & vbTab & _
                                      ou.KEY & vbTab & ou.pos.POS_SRTM.srtmID & vbTab & _
                                      ou.pos.POS_PD.bMassCommon & vbTab & i & vbTab & _
                                      ou.pos.POS_MAT.matID & vbTab & ou.pos.parentPart.partdefID
                                      
                Next ou
            
'            End If
            
            i = i + 1
        End If
    Next offt
    
    
    i = 0
    strOfftMarks = ""
    
'    Me.tbOfftake.Buttons("Draw").ButtonMenus("Draw_in").Enabled = False
    
    If bCalcInner And objID = objs("catlist") Then
        
        Set RS = New ADODB.Recordset
        RS.Open "select * from r_catlist_part where catlistID = " & objectID & " order by partSortID", cn_data, adOpenStatic, adLockReadOnly
        
        Me.PB.Max = RS.RecordCount
        
        If Not RS.EOF Then
            RS.MoveFirst
            i = 1
            Do
                loadOfftake2 RS.fields("partID").Value, "", RS.fields("objID").Value, i, False, RS.fields("partQty").Value
                
                If i > 1 Then strOfftMarks = strOfftMarks & "!"
                
                If RS.fields("objID").Value = objs("part") Then
                    strOfftMarks = strOfftMarks & selectStringFromBase(cn_data, "part", "partName", "partID", RS.fields("partID").Value)
                ElseIf RS.fields("objID").Value = objs("catalog") Then
                    strOfftMarks = strOfftMarks & selectStringFromBase(cn_data, "i_catalog", "catName", "catID", RS.fields("partID").Value)
                ElseIf RS.fields("objID").Value = objs("catlist") Then
                    strOfftMarks = strOfftMarks & selectStringFromBase(cn_data, "catlist", "catlistName", "catlistID", RS.fields("partID").Value)
                End If
                
                RS.MoveNext
                If RS.EOF Then Exit Do
                Me.PB.Value = i
                Me.PB.Refresh
                i = i + 1
            Loop
            
'            Me.tbOfftake.Buttons("Draw").ButtonMenus("Draw_in").Enabled = True
            
        End If
        
        
        RS.Close
        Set RS = Nothing
        
    End If
    
    Me.PB.Value = 0
    
    
    Me.SB.Panels("status").text = ""
    
    For Each offt In offts
        offt.iMassLevCount = i
        For Each ou In offt
        
            ' проверка масс отдельных строчек
            Dim m As Double
            If bCalcInner And offt.iMassLevCount > 0 Then
                m = 0#
                For k = 1 To offt.iMassLevCount
                    m = m + ou.arOuMass(k)
                Next k
'                If Format(m, "0") <> Format(ou.arOuMass(0), "0") Then
                If ou.arOuMass(0) > 0 Then
                    If Abs(m - ou.arOuMass(0)) / ou.arOuMass(0) > 0.05 Then
                    Me.SB.Panels("status").text = "Ошибка при проверке суммарной массы - " & ou.KEY
                    End If
                End If
            End If
        
        Next ou
    Next offt
    
    
    ' ===============================
    ' =========== результаты таблицы ===========
    
    fgOfftake.Subtotal flexSTSum, fgOfftake.ColIndex("PD"), fgOfftake.ColIndex("mass"), , lngGrey, , True, "Итого"
    fgOfftake.Subtotal flexSTSum, fgOfftake.ColIndex("PrtD"), fgOfftake.ColIndex("mass"), , lngGrey, , True, "Всего"
    
    For i = 1 To fgOfftake.Rows - 1
        
        If fgOfftake.Cell(flexcpBackColor, i, 5) = lngGrey Then
            
            fgOfftake.Select i, 1, i, fgOfftake.ColIndex("mass")
            fgOfftake.CellBorder RGB(0, 0, 125), 0, 1, 0, 1, 0, 0
            
            fgOfftake.Select i, 1, i, fgOfftake.ColIndex("qty")
            fgOfftake.CellBorder RGB(0, 0, 125), 0, 1, 0, 1, 0, 0
            
        End If
        
    Next i
    
    
    
    fgOfftake.Subtotal flexSTSum, -1, fgOfftake.ColIndex("mass"), , lngGrey, , True, "Общая масса"
'    fgOfftake.Subtotal flexSTSum, -1, fgOfftake.ColIndex("qty"), , lngGrey, , True, "Общая масса"
    
    Me.SB.Panels("offtmass").text = "Выборка: " & Format(fgOfftake.TextMatrix(fgOfftake.Rows - 1, fgOfftake.ColIndex("mass")), sFmt1) & "  "
    Me.SB.Panels("offtmass").AutoSize = sbrContents
    
    fgOfftake.Select fgOfftake.Rows - 1, 1, fgOfftake.Rows - 1, fgOfftake.ColIndex("mass")
    fgOfftake.CellBorder RGB(0, 0, 125), 0, 1, 0, 1, 0, 0
    fgOfftake.Select fgOfftake.Rows - 1, 1, fgOfftake.Rows - 1, fgOfftake.ColIndex("qty")
    fgOfftake.CellBorder RGB(0, 0, 125), 0, 1, 0, 1, 0, 0
    
    fgOfftake.MergeCol(1) = True
    fgOfftake.MergeCol(2) = True
    fgOfftake.MergeCol(3) = True
    fgOfftake.MergeCol(4) = True
    fgOfftake.MergeCol(5) = True
    
    fgOfftake.ColAlignment(fgOfftake.ColIndex("PN")) = flexAlignLeftCenter
    
    Me.tbOfftake.Buttons("Draw").Enabled = True
    
    
    Exit Sub
    
loadOfftake2_ERR:
    Set RS = Nothing
    Me.SB.Panels("status").text = "loadOfftake2 - Error - " & err.Description
'    Resume Next
    
End Sub






''/******************************************************************************
'Public Sub loadOfftake0() ' NU
''/******************************************************************************
'
'        On Error GoTo loadOfftake_ERR
'
'    Dim prtd As clsPD
'    Dim posC As clsPos
'
'    Dim I As Integer
'    Dim ID As Long
'
'    Dim pdg As clsPD
'    Dim mt As clsMat
'    Dim std As clsStd
'    Dim pd As clsPD
'
'    Dim sMat As String
'    Dim sPDG As String
'    Dim sPrtD As String
'
'    Dim sKey As String
'    Dim sKeyAfter As String
'    Dim sPartDef As String
'
''    Set offts = New Collection
'
'    Dim ou As clsOU
'
'    Dim X As Double
'    Dim srtmID As Long
'
'    Dim sColumns As String
'    Dim sOrder As String
'
'    Dim sPrtDprev As String
'
'    Dim offt As colOG
'
'    If lngCurCatListID = 0 Then Exit Sub
'
'
'    sColumns = "partdefID, partdefNameMulti, pdgID, matID, psID, pdID, srtmID, srtmName, mass, mcTable"
'    sOrder = "order by massCommon, partdefNameMulti, sortNumber, matSortNumber, msTName, msNumber, psTName, psNumber, diameter, width, height, thickness"
'
'
'
'    Dim RS As New ADODB.Recordset
'    Dim strSQL As String
'
'    If bCatsInList Then
'        strSQL = "select " & sColumns & ", catlistID, massCommon from view_offt_cl where catlistID = " & lngCurCatListID & " " & sOrder
'    Else
'        strSQL = "select " & sColumns & ", catlistID, massCommon from view_offt7_union2 where catlistID = " & lngCurCatListID & " " & sOrder
'    End If
'
'
'    If bUseCursorClient Then RS.CursorLocation = adUseClient
'
'    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
'
'
'    If Not RS.EOF Then
'
'        RS.MoveFirst
'
'        Do
'
'            If IsNull(RS.Fields("pdgID").Value) Then GoTo continue
'
'            Set ou = New clsOU
'
'            Set ou.pdg = globPosdefs(CStr(RS.Fields("pdgID").Value))
'            Set ou.std = globStds(CStr(RS.Fields("psID").Value))
'            Set ou.pd = globPosdefs(CStr(RS.Fields("pdID").Value))
'
'            ou.srtmID = RS.Fields("srtmID").Value
'            ou.smName = RS.Fields("srtmName").Value
'            ou.arOuMass(0) = Round(RS.Fields("mass").Value, 1)
'            Set ou.sm = globSrtm(CStr(ou.srtmID))
'
'            If Not ou.sm.SRTM_STDPD.bUseDrawSgn Then
'                ou.bDrawSignOver = True
'                ou.sDrawSignOver = ""
'            End If
'
''            Debug.Assert ou.arOuMass(0) > 0#
'
'            If Not RS.Fields("massCommon").Value Then
'
'                Set ou.prtd = New clsPD
'                ou.prtd.pdID = Val(RS.Fields("partdefID").Value & "")
'                ou.prtd.pdName = RS.Fields("partdefNameMulti").Value & ""
'
'                If IsNull(RS.Fields("matID").Value) Then
'                    Set ou.mt = Nothing
'                    sMat = ""
'                Else
'                    Set ou.mt = globMats(CStr(RS.Fields("matID").Value))
''                    sMat = ou.mt.matName & " " & ou.mt.matStd.stdFullNumber
'
'                    sMat = ou.mt.getClass(curSpecCfg.bNewAC, curSpecCfg.bOldAC) & " " & ou.mt.getReinMatName & "|" & ou.mt.MAT_STD.FULLNUMBER
'
'                End If
'
'                sPrtD = ou.prtd.PD_NAME
'                sPDG = ou.pdg.pdNameMulti
'
'            Else
'
'                sPrtD = ""
'                sPDG = ou.pdg.pdNameMulti
'                sMat = ""
'
'            End If
'
'            If sPrtDprev <> sPrtD Then
'                Set offt = New colOG
'                offt.bComonMass = RS.Fields("massCommon").Value
'                offts.Add offt
'                Set offt = Nothing
'                sPrtDprev = sPrtD
'            End If
'
'
'            sKey = CStr(fgOfftake.Rows)
'
'            If ((Me.tbOfftake.Buttons("Nulls").Value = tbrUnpressed And ou.arOuMass(0) > 0# And ou.pd.iMassLevel = 0) Or Me.tbOfftake.Buttons("Nulls").Value = tbrPressed) Then
'                fgOfftake.AddItem vbTab & sPrtD & vbTab & _
'                                  sPDG & vbTab & _
'                                  sMat & vbTab & _
'                                  ou.std.FULLNUMBER & vbTab & _
'                                  ou.pd.PD_NAME & vbTab & _
'                                  RS.Fields("srtmName").Value & vbTab & _
'                                  ou.arOuMass(0) & vbTab & _
'                                  sKey & vbTab & ou.srtmID & vbTab & RS.Fields("massCommon").Value & vbTab & offts.Count
'
'                offts(offts.Count).Add ou, sKey
'            End If
'
'            Set ou = Nothing
'
'continue:
'
'            RS.MoveNext
'
'        Loop Until RS.EOF
'
'
'    End If
'
'    RS.Close
'    Set RS = Nothing
'
'    ' если коллекция пустая - удаляем
'    I = 1
'    For Each offt In offts
'        If offt.Count = 0 Then
'            offts.Remove I
'        Else
'            I = I + 1
'        End If
'    Next offt
'
'
'
'
'
'    Exit Sub
'
'loadOfftake_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadOfftake - Error"
'
'End Sub


'/******************************************************************************
Public Sub loadOfftake(Optional bInner As Boolean = True, Optional bSkipFirst As Boolean = False)
'/******************************************************************************
    
        On Error GoTo loadOfftake_ERR
    
    Dim strSQL As String
    Dim strSQL_mlX As String
    Dim strSQL_pds As String
    Dim strSQL_ml0 As String
    Dim strSQLins As String
    Dim strSQLdel As String
    
    Dim prtd As clsPD
    Dim pos As clsPos
    Dim posC As clsPos
    
    Dim i As Integer
    Dim ID As Long
    
    Dim pdg As clsPD
    Dim mt As clsMat
    Dim std As clsStd
    Dim pd As clsPD
    
    Dim sMat As String
    Dim sPDG As String
    Dim sPrtD As String
    
    Dim sKey As String
    Dim sKeyAfter As String
    Dim sPartDef As String
    
    Set offts = New Collection
    Set ouGlobSum = New clsOU
    
    Dim ou As clsOU
    
    Dim X As Double
    Dim srtmID As Long
    
    Dim sColumns As String
    Dim sOrder As String
    
    Dim sPrtDprev As String
    
    Dim offt As colOG
    
    Dim bPrepareTableStruct As Boolean
    
    
    Dim specID As Long
    
    
    Dim catID As Long
    Dim catStatus As pst
    Dim catListPassive As Boolean
    catID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", lngCurCatListID)
    catListPassive = selectLongFromBase(cn_data, "catlist", "clPassive", "catlistID", lngCurCatListID)
    catStatus = selectLongFromBase(cn_data, "i_catalog", "catStatus", "catID", catID)
    
    
    Me.MousePointer = 11
    
    fgOfftake.Rows = 1

    If Not bFormGridsRedraw Then fgOfftake.redraw = flexRDNone
    
    
    Dim cat As clsCat
    
    Set cat = cCats(CStr(catID))
    
    If cat.userspecID = 0 Then
        specID = selectLongFromBase(cn_data, "i_project", "specID", "projectID", lngCurProjectID)
    Else
        specID = cat.userspecID
    End If
    
    setSpecConfig specID
    
    
'    If bOfftNew Then
        strSQL_mlX = "partdefID, srtmID, matID, sum(mass) as mass, sum(qty) as qty FROM "
        If bSkipFirst Then strSQL_mlX = "1 as " & strSQL_mlX ' объединение по первому столбцу
        strSQL_mlX = strSQL_mlX & conn.strBaseName & ".dbo." & strFuncNameOfftake1 & "(" & lngCurCatListID & "," & objs("catlist") & ",1,"
        
        strSQL_ml0 = strSQL_mlX
        
        strSQL_mlX = strSQL_mlX & Abs(CInt(Me.tbOfftake.Buttons("Nulls").Value = tbrPressed))
'        strSQL_ml0 = strSQL_ml0 & "0" ' только нулевой
        strSQL_ml0 = strSQL_ml0 & "1" ' всегда считать
        
        strSQL_mlX = strSQL_mlX & ",-1" ' параметр - брать настройку пассивности из списка (catlist)
        strSQL_ml0 = strSQL_ml0 & ",-1"
        
        strSQL_mlX = strSQL_mlX & ",1" ' параметр - коэффициент для массы по параметрам из имени изделия (strFuncNameOfftake)
        strSQL_ml0 = strSQL_ml0 & ",1"
        
        strSQL_mlX = strSQL_mlX & ") group by partdefID, srtmID, matID"
        strSQL_ml0 = strSQL_ml0 & ") group by partdefID, srtmID, matID"
        
        strSQL_pds = "mu, kks, partdefID, srtmID, matID, sum(mass) as mass, sum(qty) as qty FROM "
        strSQL_pds = strSQL_pds & conn.strBaseName & ".dbo." & strFuncNameOfftake2 & "(" & lngCurCatListID & "," & objs("catlist") & ",1) group by mu, kks, partdefID, srtmID, matID"
        
        If usrCurrent.pdsID = 1 Then
            strSQL = "SELECT " & strSQL_pds
        Else
            strSQL = "SELECT " & strSQL_mlX
        End If
        
        strSQLdel = "DELETE FROM offtable WHERE objID = " & objs("catlist") & " AND objectID = " & lngCurCatListID
        strSQLins = "INSERT INTO offtable (objID,objectID,partdefID,srtmID,matID,mass,qty) SELECT " & objs("catlist") & "," & lngCurCatListID & "," & strSQL_ml0
'    Else
'        strSQL = "SELECT "
'        strSQL = strSQL & conn.strBaseName & ".dbo.view_offtake_all.* "
'        strSQL = strSQL & "FROM "
'        strSQL = strSQL & conn.strBaseName & ".dbo.view_offtake_all "
'        strSQL = strSQL & "WHERE "
'        strSQL = strSQL & conn.strBaseName & ".dbo.view_offtake_all.catlistID = " & catListID & " "
'    End If
    
    '====================================
    If usrCurrent.pdsID = 1 Then ' подопорные
        loadOfftake3 lngCurCatListID, strSQL
        bPrepareTableStruct = False
    Else
        loadOfftake2 lngCurCatListID, strSQL, objs("catlist"), , bInner
        bPrepareTableStruct = True
    End If
    
    iCurOfft = 0
  
    
    '====================================
    If bPrepareTableStruct Then
        For i = 1 To offts.Count
    
            Set offt = offts(i)
    
            If offt.bComonMass Then
                offt.createStructCom i
            Else
                offt.createStructMet i
            End If
    
        Next i
    End If
    '====================================
    
    
    
    fgOfftake.AutoSize 0, fgOfftake.cols - 1
    
    If Not bFormGridsRedraw Then fgOfftake.redraw = flexRDDirect
    Me.MousePointer = 0
    
    
    If catStatus <> pstRazrabotka Then Me.SB.Panels("status").text = "Выборка посчитана, но не сохранена из-за статуса каталога"
    If bCatListIsBlocked Then Me.SB.Panels("status").text = "Выборка посчитана, но не сохранена из-за блокировки списка"
    If catListPassive Then Me.SB.Panels("status").text = "Выборка не посчитана, но загружена из сохраненной таблицы"
    
    '====================================
    If catStatus = pstRazrabotka And Not bCatListIsBlocked And Not catListPassive Then
    
        Dim res As VbMsgBoxResult
        res = vbYes
    
        Dim RS As New ADODB.Recordset
        RS.Open "select changes from offtable where objID = " & objs("catlist") & " and objectID = " & lngCurCatListID & " and changes > 0", cn_data, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF Then
            res = MsgBox("   В сохраненной выборке есть введенные вручную значения... пересохранить?   ", vbYesNo)
        End If
        
        If res = vbYes Then
    
            Dim cmd As New ADODB.Command
            Set cmd.ActiveConnection = cn_data
            cmd.CommandText = strSQLdel & ";" & strSQLins
            cmd.Execute
            
            Me.SB.Panels("status").text = "Выборка посчитана и сохранена в таблице базы данных"
        
        End If
    End If
    
    
'    ctabMain.TabVisible(4) = True


    iLastOfftMode = 0
    
    
    Exit Sub
    
loadOfftake_ERR:
    If Not bFormGridsRedraw Then fgOfftake.redraw = flexRDDirect
    Me.MousePointer = 0
    Me.SB.Panels("status").text = "loadOfftake - Error - " & err.Description
    
End Sub

'/******************************************************************************
Public Sub drawSpec(p As Point3d)
'/******************************************************************************
    
    On Error GoTo drawSpec_ERR
    
    
    mspoint.X = p.X
    mspoint.Y = p.Y
    mspoint.z = 0#
    
    
    
    spec.draw_spec
    
    
    
    
    
    Exit Sub
    
drawSpec_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "drawSpec - Error"
    
End Sub




'/******************************************************************************
Public Sub drawOfftake(p As Point3d, dWidth As Double, msapp As Object)
'/******************************************************************************
    
    On Error GoTo drawOfftake_ERR
    
    If msapp Is Nothing Then Exit Sub
    
    
    msapp.CadInputQueue.SendMessageToApplication strReinSpec, "activefont " & curSpecCfg.iTextFont
    
    Dim w As Double
    
    Dim c As clsOCell
    
    Dim offt As colOG
    Set offt = offts(1)
    
    
    If Not drawLineXY(msapp, p.X, p.Y - offt.getHeight(1, 5), p.X + dWidth, p.Y - offt.getHeight(1, 5)) Then Exit Sub
    
    Set c = New clsOCell
    c.offt_cell_height = offt.getHeight(1, 5)
    c.offt_cell_width = dOfftHeadWidth
    c.sText = getTrans("Марка элемента", , curSpecCfg.iTrans)
    c.setOriginXY p.X, p.Y
    c.drawOfftCell
    
    Set c = New clsOCell
    c.offt_cell_height = offt.getHeight(6, 6)
    c.offt_cell_width = dOfftHeadWidth
    If offt.iMassLevCount > 0 Then c.sText = strOfftMarks
    c.setOriginXY p.X, p.Y - offt.getHeight(1, 5)
    c.drawOfftCell
    
    
    offt.setOriginXY p.X + dOfftHeadWidth, p.Y + 0#
    
    
    w = 0#
    
    For Each offt In offts
    
    
        offt.setOriginXY p.X + dOfftHeadWidth + w, p.Y + 0#
        offt.draw
        
        w = w + offt.getWidth
    
    Next offt
    
    
    
    Set offt = offts(1)
    
    
    Set c = New clsOCell
    c.offt_cell_height = offt.getHeight(1, 5)
    c.offt_cell_width = dOfftGlobalSumWidth
    
    
    Dim sSumText As String
    
    If Len(offtcfg("Summary")("spcfgid" & curSpecCfg.spcfgID).attval("label")) > 0 Then
        sSumText = offtcfg("Summary")("spcfgid" & curSpecCfg.spcfgID).attval("label")
    'ElseIf Len(offtcfg("Summary").attval("label")) > 0 Then
    '    sSumText = offtcfg("Summary").attval("label")
    Else
        sSumText = "Общий" & vbNewLine & "расход" & vbNewLine & "стали"
        
        If curSpecCfg.iTrans = 1 Then
            sSumText = c.sText & vbNewLine & vbNewLine & "Total" & vbNewLine & "steel" & vbNewLine & "consumption"
        ElseIf curSpecCfg.iTrans = 2 Then
            sSumText = "Total" & vbNewLine & "steel" & vbNewLine & "consumption "
        End If
    End If
    
    c.sText = sSumText
    
    
    c.setOriginXY p.X + dOfftHeadWidth + w, p.Y
    c.iTextColorOver = 0
    c.drawOfftCell

    Set c = New clsOCell
    c.offt_cell_height = offt.getHeight(6, 6)
    c.offt_cell_width = dOfftGlobalSumWidth
    c.setOriginXY p.X + dOfftHeadWidth + w, p.Y - offt.getHeight(1, 5)
    c.sText = Format(fgOfftake.TextMatrix(fgOfftake.Rows - 1, fgOfftake.ColIndex("mass")), sFmt0)
        
    
    If offt.iMassLevCount > 0 Then
        Dim j As Integer
        For j = 1 To offt.iMassLevCount
            If j = 1 Then c.sText = "" ' чтобы не печаталась сумма по столбцу
            c.sText = getSepText(c.sText, ouGlobSum.arOuMass(j))
        Next j
    End If
    
    
    
    
    
    If curSpecCfg.spcfgUseDots Then c.sText = Replace(c.sText, ",", ".")
    c.iTextColorOver = 0
    c.drawOfftCell
    
    
    Exit Sub
    
drawOfftake_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "drawOfftake - Error"
    
End Sub




'/******************************************************************************
Public Sub loadSpecPart(partID As Long)
'/******************************************************************************
    
    On Error GoTo loadSpecPart_ERR
    
    
    
    
    Dim part As New clsPart
    part.setIDv2 partID, True, True, False
    
    Set spec = New clsSG
    
    spec.cSpParts.Add part, CStr(part.partID) & "|" & CStr(objs("part"))
    Set part = Nothing
    
    spec.createCmnSpecDrawStruct stPart
    
    
'    Dim su As colSU
'    Set su = loadSpecPartUnit(spec, part)
'    If su Is Nothing Then
'        Exit Sub
'    Else
'        spec.cSpecUnits.Add su
'    End If
    
    
    
    
    
    
    Exit Sub
    
loadSpecPart_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadSpecPart - Error"
    
End Sub

'/******************************************************************************
Public Sub loadSpecWise(Optional specin As clsSG = Nothing)
'/******************************************************************************

    On Error GoTo loadSpecWise_ERR

    If specin Is Nothing Then
        Set spec = New clsSG
    Else
        Set spec = specin
    End If


    Dim fgDyn As VSFlexGrid
    Set fgDyn = Config.fgTabs(F1.tbSimData.CurrTab)



    spec.createWiseDrawStruct stRooms, fgDyn





Exit Sub

loadSpecWise_ERR:
    F1.SB.Panels("status").text = "loadSpecWise" & "() - " & err.Description

End Sub


'/******************************************************************************
Public Sub loadSpecRein(bLoadSketch As Boolean, Optional specin As clsSG = Nothing, Optional rcatID As Long = 0)
'/******************************************************************************
    
    On Error GoTo loadSpecRein_ERR
    
    Dim p As clsPos
    Dim RS As New ADODB.Recordset
    Dim su As colSU
    Dim sm As clsSrtm
    
    '===================================
    If specin Is Nothing Then
        Set spec = New clsSG
    Else
        Set spec = specin
    End If
    '===================================
    
    Dim strSqlIn As String
    Dim strSQL As String
    Dim partID As Long
    Dim cnt As Long
    Dim bOk As Boolean
    Dim part As clsPart
    
    Dim i As Long
    
    strSqlIn = "("
    
    If rcatID = 0 Then
    
        For i = 1 To fgCatParts.Rows - 2
            
            partID = Val(fgCatParts.TextMatrix(i, fgCatParts.ColIndex("partID")))
            
            If partID > 0 Then
                If cnt > 0 Then strSqlIn = strSqlIn & ","
                strSqlIn = strSqlIn & partID
                cnt = cnt + 1
            Else
                ' в спецификации будет пропущена...
            End If
            
        Next i
        
    Else
    
        strSqlIn = strSqlIn & "select partID from part where catID = " & rcatID & " and deleted = 0"
    
    
    End If
    
    
    strSqlIn = strSqlIn & ")"
    
    
    
    If bUseCursorClient Then RS.CursorLocation = adUseClient
    
    
    strSQL = "SELECT "
    
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.*, "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property.*, "
    strSQL = strSQL & conn.strSrtmName & ".dbo.material.matSortNumber "
    
    strSQL = strSQL & "FROM "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position "
    
    strSQL = strSQL & "LEFT OUTER JOIN "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property "
    strSQL = strSQL & "ON "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.pos_srtmID "
    strSQL = strSQL & "= "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property.srtmID "
    
    strSQL = strSQL & "LEFT OUTER JOIN "
    strSQL = strSQL & conn.strSrtmName & ".dbo.material "
    strSQL = strSQL & "ON "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.matID "
    strSQL = strSQL & "= "
    strSQL = strSQL & conn.strSrtmName & ".dbo.material.matID "
    
    strSQL = strSQL & "WHERE "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.partID in " & strSqlIn & " "
    
    If blnSkipEmpty Then
    strSQL = strSQL & "AND "
    strSQL = strSQL & "isnull( "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.posID"
    strSQL = strSQL & ",0)>0 "
    End If
    
    If blnSortDiam Then
        'If usrCurrent.depID = 1 Then
        '    strSQL = strSQL & "ORDER BY [matSortNumber], [diameter] desc, [partSortNumber] asc"
        'Else
            strSQL = strSQL & "ORDER BY [posNumber], [matSortNumber], [diameter] desc, [partSortNumber] asc" ' posnumber добавлен для того чтобы корректно выводить вторую позицию (муфта/гайка)
        'End If
    Else
    strSQL = strSQL & "ORDER BY [partSortNumber], [posNumber]"
    End If
    
    RS.Open strSQL, cn_data, adOpenStatic, adLockReadOnly
    '    RS.Open "select * from view_r_part_position where partID in " & strSqlIn & " order by partSortNumber", cn_data, adOpenForwardOnly, adLockReadOnly
    
    If RS.EOF Then Exit Sub
    
    
    Me.PB.Max = RS.RecordCount + 1
    Me.PB.Min = 0
    
    RS.MoveFirst
    
    Do
        
        bOk = True
        If IsNull(RS.fields("pos_srtmID").Value) Then ' отсутствует
            bOk = False
        Else
            Set sm = globSrtm(CStr(RS.fields("pos_srtmID").Value))
            If sm.srtmID = 0 Then ' srtm id does not exists in table 'sortament'
                bOk = False
            End If
        End If
        
        
        '============================================
        
        Set p = New clsPos
        
        If bOk Then
        
            If p.loadDataFromRSrecord(RS, "pos_") Then
                
                'p.getSrtmProps
                p.reloadSrtmPropsFromRS RS ' нет сортамента в запросе
                p.reloadPosPropsFromRS RS, "pos_"
                
                If bLoadSketch And p.bSketch Then 'And Not Arm_2D1 Is Nothing Then
                    armUpdateSketch Arm_2D1, p, True, False ' загрузить данные, без обновления контрола
                End If
                
            Else
                err.Raise 1, , "Функция loadSpecRein(), ошибка в loadDataFromRSrecord()"
            End If
        
        End If
        '============================================
        
        
        Set part = spec.getColPart(CStr(RS.fields("partID").Value) & "|" & CStr(objs("part")))
        
        If part.partID = 0 Then
        
            part.catID = RS.fields("catID").Value
            part.partID = RS.fields("partID").Value
            part.partName = RS.fields("partName").Value
            part.iSpecNumber = Val(RS.fields("partName").Value)
            part.partdefID = RS.fields("partdefID").Value
            part.partdefName = part.PARTDEF.partdefNameMulti
            
            If Not specin Is Nothing Then
                part.partQty = 1#
            End If
            
            part.bRunMet = part.isInRunningMeters
            
            part.partOK = True
            
            If bLoadSketch Then
                If p.bSketch And p.pointsSkch.Count > 0 Then spec.cSpParts.Add part, CStr(part.partID) & "|" & CStr(objs("part")) ' пропускаем без эскизов
            Else
                spec.cSpParts.Add part, CStr(part.partID) & "|" & CStr(objs("part"))
            End If
            
        End If
        
        Set p.parentPart = part
        part.ps.AddPos p, CStr(p.posID)
        Set p = Nothing
        Set part = Nothing
        
        Me.PB.Value = RS.AbsolutePosition
        
        RS.MoveNext
        
    Loop Until RS.EOF
    
    Me.PB.Value = 0
    
'    If bLoadSketch And Not Arm_2D1 Is Nothing Then Arm_2D1.Clear ' очищаем, иначе показывает последнюю позицию
    If bLoadSketch Then Arm_2D1.Clear  ' очищаем, иначе показывает последнюю позицию
    
    
    Exit Sub
    
    Me.PB.Value = 0
    
    
loadSpecRein_ERR:
    Me.PB.Value = Me.PB.Min
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadSpecRein - Error"
    
End Sub



'/******************************************************************************
Public Sub loadSpecParts2()
'/******************************************************************************

    On Error GoTo loadSpecParts2_ERR

    Dim bRein As Boolean
'    bRein = (cattypes(cCats(CStr(lngCurCatID)).catTypeID).ctEnum = ctRein)
    
    Dim RS As New ADODB.Recordset
    RS.Open "select count(*) from r_catlist_part where catlistID = " & lngCurCatListID & " and objID != " & objs("catalog"), cn_data, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        If RS.fields(0).Value = 0 Then bRein = True
    End If
    RS.Close
    Set RS = Nothing
    
    Dim catID As Long
    catID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", lngCurCatListID)
    

    Set spec = New clsSG
    
    spec.bSaveSpec = checkCatPerm(catID) And checkGroupPerm(0, "catlist", operModify)
    spec.bCheckMass = (Me.tbSpec.Buttons("Check").Value = tbrPressed)
    
    If spec.bSaveSpec Then
        Dim iRecordsAffected As Integer
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        cmd.CommandText = "delete from [spectable] where catlistID = " & lngCurCatListID
        cmd.Execute iRecordsAffected
        Set cmd = Nothing
    End If
    
    
    
    If bRein Then
        spec.loadParts2 lngCurCatListID, usrCurrent.usrID, True, 0, True
    Else
        'If usrCurrent.depID = 1 Then
        '    spec.loadParts2 lngCurCatListID, usrCurrent.usrID, True, -5 ' новый, добавлять не детали
        '    spec.loadParts2 lngCurCatListID, usrCurrent.usrID, False, 5 ' не очищать, добавлять только детали
        'Else
            spec.loadParts2 lngCurCatListID, usrCurrent.usrID
        'End If
        
        spec.loadParts2 lngCurCatListID, usrCurrent.usrID, False, 0, True, objs("catalog")
        
    End If
    
    Dim prntcatID As Long
    prntcatID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", lngCurCatListID)
    
    spec.loadCatPos prntcatID, 15 ' материал
    
    Dim dSumMass As Double
    Dim bReal As Boolean
    bReal = False ' spec.bParams, настройка?
    
    spec.setSpecGrid fgSpec, dSumMass, bReal
    
    Me.SB.Panels("specmass").text = "Спецификация: " & Format(dSumMass, sFmt1) & "  "
    Me.SB.Panels("specmass").AutoSize = sbrContents


Exit Sub

loadSpecParts2_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadSpecParts2 - Error"

End Sub



'/******************************************************************************
Public Function checkCatalogListRelation2(catListID As Long, catID As Long) As Boolean
'/******************************************************************************

    On Error GoTo checkCatalogListRelation2_ERR

    Dim ndCat As Node
    Dim ndCL As Node
    Dim n As Node
    Dim ID As Long
    
    Set ndCat = tvGetTreeNode(tvCats, "catalog" & catID)
    Set ndCL = tvGetTreeNode(tvCats, "catlist" & catListID)

    If ndCat Is Nothing Or ndCL Is Nothing Then Exit Function
    
    
    If LCase(left(ndCL.parent.KEY, Len("catalog"))) = "catalog" Then
        ID = Val(right(ndCL.parent.KEY, Len(ndCL.parent.KEY) - Len("catalog")))
    End If
    
    If ID = catID Then checkCatalogListRelation2 = True: Exit Function
    
    
    If ndCL.parent.children > 0 Then
    
        Set n = ndCL.parent.Child
        
        Do Until n Is Nothing
            
            If LCase(left(n.KEY, Len("catalog"))) = "catalog" Then
                ID = Val(right(n.KEY, Len(n.KEY) - Len("catalog")))
            End If
            
            If ID = catID Then checkCatalogListRelation2 = True: Exit Function
            
            Set n = n.Next
        Loop
        
        
    End If
    

Exit Function

checkCatalogListRelation2_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "checkCatalogListRelation2 - Error"

End Function


'/******************************************************************************
Public Function checkCatalogListRelation(catListID As Long, catID As Long) As Boolean
'/******************************************************************************

    On Error GoTo checkCatalogListRelation_ERR

    If catListID = 0 Then checkCatalogListRelation = True: Exit Function


    Dim RS As New ADODB.Recordset
    
    RS.Open "select * from catlist where catlistID = " & catListID & " and catID = " & catID, cn_data, adOpenForwardOnly, adLockReadOnly
    
    If RS.EOF Then
        RS.NextRecordset
        RS.Open "select * from i_catalog where catID = " & catID, cn_data, adOpenForwardOnly, adLockReadOnly
        If RS.EOF Then
        Else
            RS.MoveFirst
            checkCatalogListRelation = CBool(RS.fields("catUnif").Value)
        End If
    Else
        checkCatalogListRelation = True
    End If

    RS.Close
    Set RS = Nothing

Exit Function

checkCatalogListRelation_ERR:
    Set RS = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "checkCatalogListRelation - Error"

End Function





'/******************************************************************************
Public Sub loadListGrid(Optional catListID As Long = 0, Optional bReloadCatIfNotSame As Boolean = False, Optional bRes As Boolean = True, Optional bListRem As Boolean = True)
'/******************************************************************************

    On Error GoTo loadListGrid_ERR

    Dim nd As Node
    
    Dim RS As New ADODB.Recordset
    
'    Dim catID As Long
    Dim catName As String
    Dim strPath As String
    
    fgList.ToolTipText = ""
    
    
    
    If cn_data Is Nothing Or catListID = 0 Then
        Me.lblListName.Caption = "список не загружен"
        bCatListIsBlocked = True
        Exit Sub
    End If
    
    
    Set nd = tvGetTreeNode(tvCats, "catlist" & lngCurCatListID)
    
    If Not nd Is Nothing Then
        nd.ForeColor = &H80000008
    End If
    
    If bUseCursorClient Then RS.CursorLocation = adUseClient
    
'    If bOfftNew Then
    RS.Open "select 0 as [m],* from gocatlist(" & catListID & ") order by partSortID", cn_data, adOpenStatic, adLockReadOnly
'    Else
'    RS.Open "select 0 as [m],* from view_clist where catlistID = " & catListID & " order by partSortID", cn_data, adOpenStatic, adLockReadOnly
'    End If
    
    Me.tbSpec.Buttons("Draw").Enabled = True
    Me.tbOfftake.Buttons("Draw").Enabled = True
    
    If Not bFormGridsRedraw Then fgList.redraw = flexRDNone
    
    Set fgList.DataSource = RS ' fires fgList_AfterDataRefresh
    
    
    
    
    lngCurCatListID = catListID

    lngCurCatListCatID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", catListID) ' для синхр. загрузки каталога
    
        
    Dim cmd As ADODB.Command

    
    Set cmd = New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    cmd.CommandText = "getPath2"
    cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
    cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objs("catlist"))
    cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , catListID)
    cmd.Parameters.Append cmd.CreateParameter("nameshort", adInteger, adParamInput, , 30)
    cmd.Execute
    strPath = cmd.Parameters("ret") & ""
    
    Set cmd = New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    cmd.CommandText = "getProjID"
    cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
    cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objs("catlist"))
    cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , catListID)
    cmd.Execute
    lngCurCatListProjID = Val(cmd.Parameters("ret"))
    
    Set cmd = New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    cmd.CommandText = "getBlockID"
    cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
    cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objs("catlist"))
    cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , catListID)
    cmd.Execute
    lngCurCatListBlockID = Val(cmd.Parameters("ret"))
    
    
    
    Me.lblListName.Caption = Replace(strPath, " - ", vbNewLine)
    
    
    bCatListIsBlocked = Not checkCatPerm(lngCurCatListCatID) Or checkGroupPerm(0, "catlist", operModify) = False
        
    
    Me.tbPart.Buttons("InList").Enabled = Not bCatListIsBlocked
    Me.tbRein.Buttons("InList").Enabled = Not bCatListIsBlocked
    Me.tbCats.Buttons("InList").Enabled = Not bCatListIsBlocked
    
    
    mnuListClear.Enabled = Not bCatListIsBlocked
    mnuListSort.Enabled = Not bCatListIsBlocked
    'mnuListLoadFromModel.Enabled = Not bCatListIsBlocked
    mnuListCreate.Enabled = Not bCatListIsBlocked
    mnuListDelMarkedRows.Enabled = Not bCatListIsBlocked
    mnuListReplaceFromCurCat.Enabled = Not bCatListIsBlocked
    
    
    If bRes Then elList.AutoSizeChildren = azUnevenVert
    
    fgList.AutoSize 0, fgList.cols - 1
    
    
    Dim i As Integer
    
    For i = fgList.ColIndex("partName") To fgList.cols - 1
        fgList.ColKey(i) = fgList.TextMatrix(0, i)
    Next i
    
    For i = fgList.ColIndex("partID") To fgList.cols - 1
        fgList.ColHidden(i) = True
    Next i
    
    fgList.ColKey(0) = "p"
    fgList.ColKey(1) = "b"
    fgList.ColKey(2) = "c"
    fgList.ColKey(3) = "cnt"
    
    fgList.ColWidth(fgList.ColIndex("p")) = 100
    fgList.ColWidth(fgList.ColIndex("b")) = 100
    fgList.ColWidth(fgList.ColIndex("c")) = 100
    
    fgList.ColWidth(fgList.ColIndex("m")) = 300
    
    
    For i = 1 To fgList.Rows - 1
        fgList.TextMatrix(i, fgList.ColIndex("cnt")) = i
    Next i
    
    If fgList.Rows > 1 Then fgList.Cell(flexcpFontBold, 1, 0, fgList.Rows - 1) = False
    
    If Not bFormGridsRedraw Then fgList.redraw = flexRDDirect
    
    '        fgList.ColHidden(fgList.ColIndex("partSortID")) = False
    
    
    If bReloadCatIfNotSame Then loadCatalog lngCurCatListCatID, False, 0, False, False ' не перегружать каталог, изделие не выделять, вкладку не активировать, СПИСОК НЕ ПЕРЕГРУЖАТЬ
    
    checkListParts
    
    SaveSetting "Offtake2", "Size", "catListID", catListID
    
    
    elList_ResizeChildren

    updateStatusListMass
    
    
    
    If bListRem And arListRem(iListRemPos) <> catListID Then
        iListRemPos = iListRemPos + 1
        ReDim Preserve arListRem(iListRemPos)
        arListRem(iListRemPos) = catListID
    End If
    
    
Exit Sub

loadListGrid_ERR:
    If Not bFormGridsRedraw Then fgList.redraw = flexRDDirect
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadListGrid - Error"

End Sub

'/******************************************************************************
Private Function updateStatusListMass() As Boolean
'/******************************************************************************
    
    On Error GoTo updateStatusListMass_ERR
    
    
    Dim d As String
    
    '        If fgList.Rows >= 2 Then
    '            d = Format(fgList.Aggregate(flexSTSum, 1, fgList.ColIndex("mass"), fgList.Rows - 1, fgList.ColIndex("mass")), "0.0")
    '        End If
    
    
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    cmd.CommandText = strFuncNameListMass
    cmd.Parameters.Append cmd.CreateParameter("ret", adDouble, adParamReturnValue)
    cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objs("catlist"))
    cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , lngCurCatListID)
    cmd.Execute
    d = cmd.Parameters("ret")
    
    Me.SB.Panels("listmass").text = "Список: " & Format(d, sFmt1) & "  "
    Me.SB.Panels("listmass").AutoSize = sbrContents
    
    
    Exit Function
    
updateStatusListMass_ERR:
    F1.SB.Panels("status").text = "updateStatusListMass" & "() - " & err.Description
    Resume Next
    
End Function



Private Function addTreeNode(t As TreeView, n As Node, parentkey As String, rel As TreeRelationshipConstants, _
                             KEY As String, Name As String, imagekey As String, Optional bSorted As Boolean = True, _
                             Optional selimage As String = "", Optional bSkipEmpty As Boolean = False, _
                             Optional sTryAddParentBySep As String = "") As Boolean
    
    On Error GoTo merr
    
    addTreeNode = False
    Dim i As Integer
    
    If Len(Trim(KEY)) = 0 Then Exit Function
    
    If bSkipEmpty And Len(Trim(Name)) = 0 Then Exit Function
    
    If Len(Trim(parentkey)) = 0 Then
        If Len(imagekey) = 0 Then
            Set n = t.Nodes.Add(, , KEY, Name)
        Else
            Set n = t.Nodes.Add(, , KEY, Name, imagekey)
        End If
    Else
    
        If rel = tvwChild Then
        
            Dim nd As Node
            Set nd = tvGetTreeNode(t, parentkey)
            
            If nd Is Nothing Then
            
'                If Len(sTryAddParentBySep) > 0 Then
'
'                    Dim ar() As String
'                    ar = Split(parentkey, sTryAddParentBySep)
'
'                    If UBound(ar) > 0 Then
'
'                        Dim strNewKey As String
'                        Dim strNewKeyParent As String
'                        Dim nn As Node
'
'                        For I = UBound(ar) To 0 Step -1
'                            If Len(strNewKey) > 0 Then strNewKey = strNewKey & sTryAddParentBySep
'                            strNewKey = strNewKey & ar(I)
'                        Next I
'
'                        For I = UBound(ar) - 1 To 0 Step -1
'                            If Len(strNewKeyParent) > 0 Then strNewKeyParent = strNewKeyParent & sTryAddParentBySep
'                            strNewKeyParent = strNewKeyParent & ar(I)
'                        Next I
'
'
'                        addTreeNode t, nn, strNewKeyParent, rel, strNewKey, ar(UBound(ar)), imagekey
'
'                    End If
'                Else
                    Exit Function
'                End If
            
            End If
            
'            If right(nd.Tag, 6) = "noload" Then Exit Function
        End If
    
    
        If Len(imagekey) = 0 Then
            Set n = t.Nodes.Add(parentkey, rel, KEY, Name)
        Else
            Set n = t.Nodes.Add(parentkey, rel, KEY, Name, imagekey)
        End If
    End If
    
    n.Sorted = bSorted
    
    addTreeNode = True
    
    If Len(selimage) > 0 Then n.SelectedImage = selimage
    
    Exit Function
merr:
    addTreeNode = False
    
    
End Function

'/******************************************************************************
Public Sub loadSrtmTree()
'/******************************************************************************

    On Error GoTo loadSrtmTree_ERR


    Dim RS As New ADODB.Recordset
    Dim TN As Node
    
    
    If cn_srtm Is Nothing Then Exit Sub
    
    tvSrtm.Visible = False
    tvSrtm.Nodes.Clear
    
    
'    If usrCurrent.pdsID = 0 Then
'    RS.Open "select * from posdef where posdefUsing = 1", cn_srtm, adOpenForwardOnly, adLockReadOnly
'    Else
'    End If

    Set TN = tvSrtm.Nodes.Add(, , "root1", "Первичный набор")
    TN.Expanded = GetSetting("Offtake2", "srtmTree", TN.KEY, True)

    Set TN = tvSrtm.Nodes.Add(, , "root0", "Дополнительно")
    TN.Expanded = GetSetting("Offtake2", "srtmTree", TN.KEY, True)


    RS.Open "select * from posdef order by posdefUsing, posdefName", cn_srtm, adOpenForwardOnly, adLockReadOnly
    
    
    RS.MoveFirst
    Do
    
            Set TN = tvSrtm.Nodes.Add("root" & Abs(CInt(RS![posdefUsing])), tvwChild, "posdef" & RS![posdefID], RS![posdefName])
            Dim posdefID As Long
            Dim strProjectType As String
            TN.Tag = "posdef"
            TN.Expanded = GetSetting("Offtake2", "srtmTree", TN.KEY, True)

    RS.MoveNext
    Loop Until RS.EOF
    
    RS.NextRecordset
    
    RS.Open "select * from view_r_standard_posdef where [stdUsing] = 1 and [using] = 1", cn_srtm, adOpenForwardOnly, adLockReadOnly
    
    RS.MoveFirst
    Do
    
            If addTreeNode(tvSrtm, TN, "posdef" & RS![posdefID], tvwChild, "stdposdef" & RS![relID], Trim(RS![stdTypeName] & " " & RS![stdNumber]), "") Then
                TN.Tag = "stdposdef"
                TN.Expanded = GetSetting("Offtake2", "srtmTree", TN.KEY, True)
            End If

    RS.MoveNext
    Loop Until RS.EOF
    
    '=============
    
    RS.NextRecordset

    RS.Open "select pdsID, 0, pdsName as [Наим.], null as [Альт. наим.], null, null from pdset order by pdsName", cn_srtm, adOpenForwardOnly, adLockReadOnly

    Set Me.fgPDSet.DataSource = RS

    fgPDSet.ColHidden(0) = True ' pdsID
    fgPDSet.ColHidden(5) = True ' relID
    fgPDSet.ColDataType(1) = flexDTBoolean
    fgPDSet.ColWidth(1) = 200
    
    '=============
    
'    RS.NextRecordset
'
'    RS.Open "select * from sortament where srtmUsing = 1", cn_srtm, adOpenForwardOnly, adLockReadOnly
'
'    RS.MoveFirst
'    Do
'
'            If addTreeNode(tvSrtm, TN, "stdposdef" & RS.Fields("stdposdefID").Value, tvwChild, "srtm" & RS![srtmID], RS![srtmName], "") Then
'                TN.Tag = "srtm"
'                TN.Expanded = GetSetting("Offtake2", "srtmTree", TN.KEY, True)
'            End If
'
'    RS.MoveNext
'    Loop Until RS.EOF
    
    tvSrtm.Visible = True


    RS.Close
    Set RS = Nothing

Exit Sub

loadSrtmTree_ERR:
    Set frmSps = Nothing
    tvSrtm.Visible = True
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadSrtmTree - Error"

End Sub

'/******************************************************************************
'Public Sub loadCatsTreeCatalog(RS As ADODB.Recordset)
''/******************************************************************************
'
'    On Error GoTo loadCatsTreeCatalog_ERR
'
'    Dim TN As Node
'    Dim obj As clsObj
'
'
'    If Not RS.EOF Then
'        RS.MoveFirst
'        Do
'            Dim ct As New clsCat
'
'            Set obj = globObjs(CStr(RS![objID]))
'
'            If ct.loadCatByID(RS, 0) Then
'
'                cCats.AddCatSimple ct, CStr(ct.catID)
'
'
'                If Not ct.bDeleted Then
'                    If Not (ct.bForTesting And usrCurrent.groupID > 1) Then
'
'                        If addTreeNode(tvCats, TN, obj.objname & RS.fields("objectID").Value, tvwChild, _
'                                "catalog" & RS.fields("catID").Value, RS.fields("catName").Value, ct.getTreeNodeImage) Then
'                            TN.Tag = "catalog"
'                            TN.Expanded = isCatNodeExpanded(TN.KEY)
'                            TN.bOld = ct.bUnif
'                            If ct.bForTesting Then TN.ForeColor = &H80000010
'                            TN.Sorted = True
'                        End If
'
'                    End If
'                End If
'
'            End If
'
'            Set ct = Nothing
'
'            RS.MoveNext
'        Loop Until RS.EOF
'    End If
'
'Exit Sub
'
'loadCatsTreeCatalog_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCatsTreeCatalog - Error"
'
'End Sub


'/******************************************************************************
Public Function getBloackName(bn As Long) As String
'/******************************************************************************

    On Error GoTo getBloackName_ERR
    
    If bn = 0 Then
        getBloackName = "Общестанционные"
    Else
        getBloackName = "Блок " & bn
    End If

Exit Function

getBloackName_ERR:
    'MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "getBloackName - Error"

End Function


Private Sub Form_Unload(Cancel As Integer)
    
    On Error Resume Next
    
    Unload F2
    Unload FLog
    Unload frmSrtmLoad
    Unload frmPartImage
    
    If F1.WindowState = 0 Then
        If F1.top >= 0 Then SaveSetting "Offtake2", "Size", "F1.top", F1.top
        If F1.left >= 0 Then SaveSetting "Offtake2", "Size", "F1.Left", F1.left
        If F1.height >= 0 Then SaveSetting "Offtake2", "Size", "F1.Height", F1.height
        If F1.width >= 0 Then SaveSetting "Offtake2", "Size", "F1.Width", F1.width
        
        
        SaveSetting "Offtake2", "Size", "elList.Width", elList.width
        SaveSetting "Offtake2", "Size", "elTabs.Width", elTabs.width
        
        SaveSetting "Offtake2", "Size", "elCatsInf.Width", elCatsInf.width
        
        SaveSetting "Offtake2", "Size", "elFgPart.Width", elFgPart.width
        SaveSetting "Offtake2", "Size", "elFgSrtm.Width", elFgSrtm.width
        
        SaveSetting "Offtake2", "Size", "fgCatParts.Height", fgCatParts.height
        
        Call SaveSetting("Offtake2", "Size", "tvWise.width", tvWise.width)
        Call SaveSetting("Offtake2", "Size", "lvWise.ColumnHeaders(1).width", lvWise.ColumnHeaders(1).width)
        Call SaveSetting("Offtake2", "Size", "lvWise.ColumnHeaders(2).width", lvWise.ColumnHeaders(2).width)
        
    End If
    
    
    SaveSetting "Offtake2", "Size", "tvCats.SelectedItem.Key", tvCats.SelectedItem.KEY
    SaveSetting "Offtake2", "Size", "tvParts.SelectedItem.Key", tvParts.SelectedItem.KEY
    SaveSetting "Offtake2", "Size", "tvWise.SelectedItem.Key", tvWise.SelectedItem.KEY
    
    SaveSetting "Offtake2", "Size", "catID", lngCurCatID
    '    SaveSetting "Offtake2", "Size", "catPartID", lngCurPartCatID
    '    SaveSetting "Offtake2", "Size", "catReinID", lngCurReinCatID
    
    SaveSetting "Offtake2", "Size", "lngCmdCatIDs(1)", lngCmdCatIDs(1)
    SaveSetting "Offtake2", "Size", "lngCmdCatIDs(2)", lngCmdCatIDs(2)
    
'    SaveSetting "Offtake2", "Size", "mnuPrefRound03.Checked", mnuPrefRound03.Checked
'    SaveSetting "Offtake2", "Size", "mnuPrefUseRein.Checked", mnuPrefUseRein.Checked

    Call SaveSetting("Offtake2", "Size", "tbCats.LoadAll", tbCats.Buttons("LoadAll").Value)
    Call SaveSetting("Offtake2", "Size", "tbSpec.Check", tbSpec.Buttons("Check").Value)

    
'    SaveSetting "Offtake2", "Size", "EditPart", F1.tbPart.Buttons("EditPart").Value
    SaveSetting "Offtake2", "Size", "Collapsed", F1.tbPart.Buttons("Collapsed").Value
'    SaveSetting "Offtake2", "Size", "SelFly", F1.tbPart.Buttons("SelFly").Value
    
    SaveSetting "Offtake2", "Size", "ctabMain.CurrTab", ctabMain.CurrTab
    SaveSetting "Offtake2", "Size", "mnuViewOnTop.Checked", mnuViewOnTop.Checked
    SaveSetting "Offtake2", "Size", "mnuViewShowPart.Checked", mnuViewShowPart.Checked
    SaveSetting "Offtake2", "Size", "mnuListSyncLoad.Checked", mnuListSyncLoad.Checked
    SaveSetting "Offtake2", "Size", "mnuListSyncList.Checked", mnuListSyncList.Checked
    SaveSetting "Offtake2", "Size", "mnuListSortAuto.Checked", mnuListSortAuto.Checked
    
    SaveSetting "Offtake2", "Size", "mnuPrefLap.Checked", mnuPrefLap.Checked
    SaveSetting "Offtake2", "Size", "mnuPrefCatDelConfirm.Checked", mnuPrefCatDelConfirm.Checked
    SaveSetting "Offtake2", "Size", "mnuPrefPdSortByUse.Checked", mnuPrefPdSortByUse.Checked
    SaveSetting "Offtake2", "Size", "mnuPrefShowGridIcons.Checked", mnuPrefShowGridIcons.Checked
    
    SaveSetting "Offtake2", "Size", "lngSpecDefaultRows", lngSpecDefaultRows
    SaveSetting "Offtake2", "Size", "lngSpecLastRows", lngSpecLastRows
    SaveSetting "Offtake2", "Size", "lngSpecFirstRows", lngSpecFirstRows
    SaveSetting "Offtake2", "Size", "blnSpecLastRows", blnSpecLastRows
    SaveSetting "Offtake2", "Size", "blnDrawSpecCap", blnDrawSpecCap
    SaveSetting "Offtake2", "Size", "blnSortDiam", blnSortDiam
    SaveSetting "Offtake2", "Size", "blnSkipEmpty", blnSkipEmpty
    
    
     Call SaveSetting("Offtake2", "Size", "pstRazrabotka", mnuViewCatsStat(pst.pstRazrabotka).Checked)
     Call SaveSetting("Offtake2", "Size", "pstProvereno", mnuViewCatsStat(pst.pstProvereno).Checked)
     Call SaveSetting("Offtake2", "Size", "pstArchive", mnuViewCatsStat(pst.pstArchive).Checked)
     Call SaveSetting("Offtake2", "Size", "pstUstar", mnuViewCatsStat(pst.pstUstar).Checked)
    
    
    Dim i As Long
'    Dim str As String
'    str = ""
'
'    For I = 1 To F1.tvCats.Nodes.Count
'        If tvCats.Nodes(I).Expanded Then
'            str = str & tvCats.Nodes(I).KEY & ":1|"
'        Else
'            str = str & tvCats.Nodes(I).KEY & ":0|"
'        End If
'    Next I
'    SaveSetting "Offtake2", "CatsTree2", "all", str

    saveCatTreeSets
    saveWiseTreeSets
    
    
    For i = 1 To F1.tvSrtm.Nodes.Count
        SaveSetting "Offtake2", "srtmTree", F1.tvSrtm.Nodes(i).KEY, CInt(F1.tvSrtm.Nodes(i).Expanded)
    Next i
    
    
    
    
    
    
End Sub



Private Sub lblCmdLeft_Click()

End Sub





'/******************************************************************************
Private Sub lblCurCatName_MouseDown(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo lblCurCatName_MouseDown_ERR


    If Button = 2 Then
    
        mnuLabelCopy.Tag = Index
        
        Dim i As Integer
        Dim ct As clsCat
        For i = 1 To colCatRem.Count
            Set ct = colCatRem(colCatRem.Count - i + 1)
            If i > 1 And i > iCatRemMenu Then
                Load mnuLabelCat(i - 1)
                iCatRemMenu = i
            End If
            mnuLabelCat(i - 1).Caption = i & ". " & ct.getCatPath(True)
            mnuLabelCat(i - 1).Checked = CBool(ct.catID = lngCurCatID)
            mnuLabelCat(i - 1).Enabled = CBool(ct.catID <> lngCurCatID)
            mnuLabelCat(i - 1).Visible = True
            mnuLabelCat(i - 1).Tag = ct.catID
        Next i
    
        PopupMenu mnuLabel
        
    End If




Exit Sub

lblCurCatName_MouseDown_ERR:
    F1.SB.Panels("status").text = "lblCurCatName_MouseDown" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub lblListName_DblClick()
'/******************************************************************************
    
    On Error GoTo lblListName_DblClick_ERR
    
    If lngCurCatListID = 0 Then Exit Sub
    
'    Dim nd As Node
'
'    Set nd = tvGetTreeNode(tvCats, "catlist" & lngCurCatListID)
'    If Not nd Is Nothing Then nd.Selected = True: nd.EnsureVisible: Me.ctabMain.CurrTab = 0
    
    goToPartFromList objs("catlist"), lngCurCatListID
    
    Exit Sub
    
lblListName_DblClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "lblListName_DblClick - Error"
    
End Sub

'/******************************************************************************
Private Sub fgCatTree_DblClick()
'/******************************************************************************

    On Error GoTo fgCatTree_DblClick_ERR

    
    
    Dim objID As Long
    Dim objectID As Long
    
    objID = fgCatTree.TextMatrix(fgCatTree.Row, 0)
    objectID = fgCatTree.TextMatrix(fgCatTree.Row, 1)
    
    Dim nd As Node
    
    If objID = objs("catalog") Then
        
        fgCatTree.Rows = 1
        loadCmdParts fgCatTree, False, objectID, cn_data
        Me.fgCatTree.Tag = objectID
        
        Set nd = tvGetTreeNode(tvCats, "catalog" & objectID)
        If Not nd Is Nothing Then
            nd.Selected = True
            nd.EnsureVisible
'            tvCats_NodeClick nd
        End If
    ElseIf objID = objs("part") And Len(fgCatTree.Tag) > 0 Then
        loadCatalog Val(fgCatTree.Tag), False, objectID, True, mnuListSync.Checked ' каталог не перегружать, изделие выделить, вкладку активировать, список перегрузить по опции
        If Not tvParts.SelectedItem Is Nothing Then
            tvParts_NodeClick tvParts.SelectedItem
        End If
    Else
    End If

    
    
Exit Sub

fgCatTree_DblClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatTree_DblClick - Error"

End Sub


'/******************************************************************************
Private Sub fgCatTree_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgCatTree_MouseDown_ERR
    
    Dim iCount As Long
'    Dim prt As ListItem
    Dim catID As Long
    Dim bCatLocked As Boolean
    Dim i As Long
    
'    If fgCatTree.ListItems.Count = 0 Then Exit Sub
    
    
    If Button = 2 Then
    
        mnuCatPartsOpen.Enabled = False
        mnuCatPartsCopy.Enabled = False
        mnuCatPartsPaste.Enabled = False
        mnuCatPartsLinks.Enabled = False
        
        
        For i = 1 To fgCatTree.Rows - 1
            If fgCatTree.IsSelected(i) Then
                iCount = iCount + 1
            End If
        Next i
        
'        If Not fgCatTree.SelectedItem Is Nothing Then
'            Set prt = fgCatTree.SelectedItem
'        End If
        
'        If Not prt Is Nothing Then
'            mnuCatPartsOpen.Enabled = CBool(cCats(CStr(catID)).catTypeID = 1)
'            mnuCatPartsOpen.Caption = "Открыть " & prt.text
'            catID = Val(prt.Tag)
'        Else
'            mnuCatPartsOpen.Caption = "Открыть"
'            catID = lngCurCatTreeSelectedID
'        End If
        
        
        catID = Val(fgCatTree.Tag)
        
        If catID = 0 Then Exit Sub
        
        bCatLocked = Not checkCatPerm(catID)
        
        If iCount > 0 Then
            mnuCatPartsCopy.Enabled = checkGroupPerm(usrCurrent.groupID, "part", operCreate) And Not bCatLocked
            mnuCatPartsCopy.Caption = "Копировать " & iCount & " изд. в буфер"
        Else
            mnuCatPartsCopy.Caption = "Копировать в буфер"
        End If
        
        If iCopyPartsCount > 0 Then
            mnuCatPartsPaste.Enabled = checkGroupPerm(usrCurrent.groupID, "part", operCreate) And _
                                                    CBool(lngCurCatTreeObjID = objs("catalog")) And Not bCatLocked
                                                    
        End If
        
        If iCopyPartsCount > 0 Then
            mnuCatPartsLinks.Enabled = checkGroupPerm(usrCurrent.groupID, "part", operCreate) And _
                                                    CBool(lngCurCatTreeObjID = objs("catalog")) And CBool(cCats(CStr(catID)).catTypeID = 1) And Not bCatLocked
            mnuCatPartsLinks.Enabled = checkGroupPerm(usrCurrent.groupID, "part", operCreate) And _
                                                    CBool(lngCurCatTreeObjID = objs("catalog")) And Not bCatLocked
                                                    
        End If
        
        mnuCatPartsPaste.Caption = "Создать копию изделий буфера (" & iCopyPartsCount & ")"
        mnuCatPartsLinks.Caption = "Вставить ссылку на изделия буфера (" & iCopyPartsCount & ")"
        
'        fgCatTree.Refresh ' иначе после выполнения появляется рамка выделения
        
        PopupMenu mnuCatParts
        
    End If
    
    
    
    
    
    
    
    
'    Dim li As ListItem
'
'    If Button = 1 Then
'
'        Set li = fgCatTree.HitTest(x, y)
'
'        If li Is Nothing Then ' frame
'            bListDrag = False
'        Else ' drag
'            bListDrag = True
'
'            Dim Item As ListItem
'            For Each Item In fgCatTree.ListItems
'                If Item.Selected = True Then
'                '....
'                End If
'            Next
'
'        End If
'
'
'        dDragX = x
'        dDragY = y
'
'    End If
    
    
Exit Sub

fgCatTree_MouseDown_ERR:

End Sub

Private Sub fgCatTree_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    
    
'    If Button = 1 Then
'
'        If bListDrag Then
'            fgCatTree.Drag vbBeginDrag
'        Else
'        End If
'
'    End If

    
    
End Sub



Private Sub lblListName_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)


    If Button = 2 Then
'        If iListRemPos < UBound(arListRem) Then
'            iListRemPos = iListRemPos + 1
'            loadListGrid arListRem(iListRemPos), , , False
'        End If

        
        

    End If




End Sub

'/******************************************************************************
Private Sub lvWise_Click()
'/******************************************************************************

    On Error GoTo lvWise_Click_ERR

    Dim li As ListItem
    Set li = Me.lvWise.SelectedItem
    
    If li Is Nothing Then Exit Sub
    
    Dim ar() As String
    ar = Split(li.Tag, "-")
    
    loadLog "pwdoc", Val(ar(1))




Exit Sub

lvWise_Click_ERR:
    F1.SB.Panels("status").text = "lvWise_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Public Sub showWiseTreeItem(projID As Long, pwdocID As Long)
'/******************************************************************************
    
    On Error GoTo showWiseTreeItem_ERR
    
    Dim cnpw As ADODB.Connection
    Dim nd As Node
    
    
    If projID > 0 Then
        
        Set nd = tvGetTreeNode(tvWise, "wise" & projID)
        
        If Not nd Is Nothing Then
            nd.Selected = True
            nd.EnsureVisible
            Exit Sub
        End If
        
    End If
    
    
    Set cnpw = New ADODB.Connection
    cnpw.Open pwset.constring, pwset.login, pwset.login
    
    If projID = 0 And pwdocID > 0 Then
        
        Dim RSS As New ADODB.Recordset
        RSS.Open "select * from view_docdata_all where ID = " & pwdocID, cnpw, adOpenStatic, adLockReadOnly
        
        If Not RSS.EOF Then
            RSS.MoveFirst
            projID = RSS.fields("o_projectno").Value
        End If
        
        RSS.Close
        Set RSS = Nothing
        
    End If
    
    
    If projID = 0 Then Exit Sub
    
    
    Set nd = tvGetTreeNode(tvWise, "wise" & projID)
    
    If Not nd Is Nothing Then
        nd.Selected = True
        nd.EnsureVisible
    Else
        
        Dim RS As New ADODB.Recordset
        RS.Open "select * from getProjPath(" & projID & "," & pwset.root & ")", cnpw, adOpenStatic, adLockReadOnly
        
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                Set nd = tvGetTreeNode(tvWise, "wise" & RS.fields("projid").Value)
                If Not nd Is Nothing Then Exit Do
                RS.MoveNext
            Loop Until RS.EOF
        End If
        
        If Not nd Is Nothing Then
            nd.Expanded = True
            Do
                RS.MovePrevious
                If RS.BOF Then Exit Do
                Set nd = tvGetTreeNode(tvWise, "wise" & RS.fields("projid").Value)
                If Not nd Is Nothing Then nd.Expanded = True
            Loop
        End If
        
        Set nd = tvGetTreeNode(tvWise, "wise" & projID)
        
        If Not nd Is Nothing Then
            nd.Selected = True
            nd.EnsureVisible
        End If
        
        RS.Close
        Set RS = Nothing
        
        
    End If
    
    cnpw.Close
    Set cnpw = Nothing
    
    
    If pwdocID = 0 Then Exit Sub
    
    
    Set nd = tvGetTreeNode(tvWise, "wise" & projID)
    
    If Not nd Is Nothing Then
    
        bWise = True
        tvWise_NodeClick nd
        bWise = False
        
        Dim li As ListItem
        
        For Each li In lvWise.ListItems
            Dim ar() As String
            
            ar = Split(li.Tag, "-")
            
            If UBound(ar) = 1 Then
                If Val(ar(1)) = pwdocID Then
                    li.Selected = True
                    lvWise.SetFocus
                End If
            End If
            
        Next li
        
        
    End If
    
    
    
    
    
    
    Exit Sub
    
showWiseTreeItem_ERR:
    Set cnpw = Nothing
    F1.SB.Panels("status").text = "showWiseTreeItem" & "() - " & err.Description
    
End Sub


'/******************************************************************************
Private Sub lvWise_DblClick()
'/******************************************************************************

    On Error GoTo lvWise_DblClick_ERR
    
    Dim li As ListItem
    Set li = Me.lvWise.SelectedItem
    
    If li Is Nothing Then Exit Sub
    
    Dim projID As Long
    
    Dim ar() As String
    ar = Split(li.Tag, "-")
    
    projID = Val(ar(0))
    
    Call showWiseTreeItem(projID, 0)






Exit Sub

lvWise_DblClick_ERR:
    F1.SB.Panels("status").text = "lvWise_DblClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub lvWise_ItemCheck(ByVal Item As MSComctlLib.ListItem)
'/******************************************************************************

    On Error GoTo lvWise_ItemCheck_ERR



    Dim RS As New ADODB.Recordset
    Dim sDocGUID As String
    Dim ndNew As Node
    Dim ndPlus As Node
    
    Dim pwdocID As Long
    
    
    
    
    If Me.tbWise.Buttons("CanChange").Value = tbrUnpressed Then
        Item.Checked = Not Item.Checked
        
        If pwset.canedit Then ' blink button
            Me.tbWise.Buttons("CanChange").Value = tbrPressed
            Me.tbWise.Refresh
            Sleep 100
            Me.tbWise.Buttons("CanChange").Value = tbrUnpressed
            Me.tbWise.Refresh
            Sleep 100
            Me.tbWise.Buttons("CanChange").Value = tbrPressed
            Me.tbWise.Refresh
            Sleep 100
            Me.tbWise.Buttons("CanChange").Value = tbrUnpressed
            Me.tbWise.Refresh
            Sleep 100
            Me.tbWise.Buttons("CanChange").Value = tbrPressed
            Me.tbWise.Refresh
            Sleep 100
            Me.tbWise.Buttons("CanChange").Value = tbrUnpressed
            Me.tbWise.Refresh
        End If
        
        Exit Sub
    End If
    
    sDocGUID = Replace(Item.KEY, "item", "")
    
    
    Dim cn As New ADODB.Connection
    
    cn.Open pwset.constring, pwset.login, pwset.login
    
    
    Dim strFName As String
    strFName = selectStringFromBase(cn, "dms_doc", "o_filename", "o_docguid", sDocGUID)
    
    If Item.Checked Then
        If StrComp(right(strFName, 4), ".dgn", vbTextCompare) = 0 Then
        ElseIf StrComp(right(strFName, 4), ".ifc", vbTextCompare) = 0 Then
        Else
            Item.Checked = False
            cn.Close
            Exit Sub
        End If
    End If
    

    RS.Open "select * from aep_docdata where docguid = '" & sDocGUID & "'", cn, adOpenForwardOnly, adLockOptimistic



    If Item.Checked Then
    
    
        If RS.EOF Then
            RS.AddNew
            RS.fields("docguid").Value = sDocGUID
            RS.fields("dmsstatus").Value = ""
            RS.fields("last_state").Value = ""
            RS.fields("usr_create").Value = usrCurrent.strLogin
            RS.fields("dt_change").Value = Now
            RS.Update
            RS.Requery
            RS.MoveFirst
            pwdocID = RS.fields("ID").Value
        Else
            RS.MoveFirst
            RS.fields("deleted").Value = 0
'            RS.fields("dmsstatus").Value = ""
            RS.fields("last_state").Value = ""
            RS.fields("usr_delete").Value = usrCurrent.strLogin
            RS.fields("dt_change").Value = Now
            pwdocID = RS.fields("ID").Value
            RS.Update
        End If
        

        Call writeOperationS(operModify, "pwdoc", pwdocID, "включение передачи данных")
        
        Item.SubItems(2) = "в очереди"
    
    
    
    Else ' not checked
    
    
        If Not RS.EOF Then
            RS.MoveFirst
            RS.fields("deleted").Value = 1
'            RS.fields("dmsstatus").Value = "CI"
            RS.fields("usr_delete").Value = usrCurrent.strLogin
            RS.fields("dt_change").Value = Now
            pwdocID = RS.fields("ID").Value
            RS.Update
            
            Call writeOperationS(operModify, "pwdoc", pwdocID, "выключение передачи данных")
            
            Item.SubItems(2) = "в очереди"
            
        End If
    
    
    End If

    RS.Close
    
    Set RS = Nothing

    cn.Close
    
    Set cn = Nothing









Exit Sub

lvWise_ItemCheck_ERR:
    F1.SB.Panels("status").text = "lvWise_ItemCheck" & "() - " & err.Description

End Sub

Private Sub lvWise_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)

On Error GoTo err

    Dim nd As ListItem
    
    Set lvWise.SelectedItem = lvWise.HitTest(X, Y)
    Set nd = lvWise.SelectedItem

    
    If nd Is Nothing Then
        Exit Sub
    End If

    mnuSimFilesReprocess.Visible = False
    
    


    If Button = 2 Then
    
        mnuSimFilesLinks.Tag = nd.KEY
        
        If nd.Checked Then
            Me.mnuSimFilesReprocess.Tag = nd.KEY
            mnuSimFilesReprocess.Visible = True
        End If
    
        PopupMenu Me.mnuSimFiles
    
    End If
    

Exit Sub
err:
'MsgBox err.Description


End Sub

'/******************************************************************************
Private Sub mnuCatFilesOpenDir_Click()
'/******************************************************************************

    On Error GoTo mnuCatFilesOpenDir_Click_ERR

    'If fgCatFiles.Row < 1 Then
    Exit Sub


    Dim ar() As String
    Dim strDir As String
    ar = Split(fgCatFiles.TextMatrix(fgCatFiles.Row, 1), "\")
    strDir = Replace(fgCatFiles.TextMatrix(fgCatFiles.Row, 1), "\" & ar(UBound(ar)), "")

    Dim sh As New Shell
    sh.Explore strDir
    Set sh = Nothing


Exit Sub

mnuCatFilesOpenDir_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatFilesOpenDir_Click - Error"

End Sub

Private Sub mnuCatFilesOpenFile_Click()

    'fgCatFiles_DblClick


End Sub

'/******************************************************************************
Private Sub mnuCatPartsCopy_Click()
'/******************************************************************************

    On Error GoTo mnuCatPartsCopy_Click_ERR

    
    iCopyPartsCount = 0
    
    
    

    
    Dim i As Long
    For i = 1 To fgCatTree.Rows - 1
        If fgCatTree.IsSelected(i) Then
            iCopyPartsCount = iCopyPartsCount + 1
            
            If iCopyPartsCount = 1 Then
                ReDim arCopyParts(1 To 1)
            Else
                ReDim Preserve arCopyParts(1 To iCopyPartsCount)
            End If
            
            arCopyParts(iCopyPartsCount) = Val(fgCatTree.TextMatrix(i, 1))
        End If
    Next i
    
    
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    
    
    
Exit Sub

mnuCatPartsCopy_Click_ERR:
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatPartsCopy_Click - Error"

End Sub

Private Sub mnuCatPartsLinks_Click()
    
    
    If iCopyPartsCount = 0 Then Exit Sub
    
    Dim i As Integer
    Dim partID As Long
    Dim catID As Long
    Dim RS As New ADODB.Recordset
    
    catID = Val(right(tvCats.SelectedItem.KEY, Len(tvCats.SelectedItem.KEY) - Len("catalog")))
    
    '    Me.MousePointer = 11
    
    For i = 1 To iCopyPartsCount
        
        partID = arCopyParts(i)
        
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        
        If selectLongFromBase(cn_data, "part", "catID", "partID", partID) = catID Then ' дублирование
        Else
            
            If selectLongFromBase(cn_data, "r_catalog_part", "relID", "catID", catID, "partID", partID) = 0 Then
                cmd.CommandText = "INSERT INTO r_catalog_part (catID,partID) VALUES (" & catID & "," & partID & ")"
                cmd.Execute
            End If
            
            
            
'            RS.Open "select * from r_catalog_part where catID = " & catID & " and partID = " & partID, cn_data, adOpenStatic, adLockOptimistic
'
'            If RS.EOF Then
'                RS.AddNew
'                RS.Fields("catID").Value = catID
'                RS.Fields("partID").Value = partID
'                RS.Update
'            Else
'
'            RS.NextRecordset
'
'            End If
            
        End If
        
        
    Next i
    
    fgCatTree.Refresh
    
    
    Set RS = Nothing
    
    
    tvCats_NodeClick tvCats.SelectedItem
    
    '    Me.MousePointer = 0
    
    
    
End Sub

Private Sub mnuCatPartsOpen_Click()

fgCatTree_DblClick


End Sub

'/******************************************************************************
Private Sub mnuCatPartsPaste_Click()
'/******************************************************************************

    On Error GoTo mnuCatPartsPaste_Click_ERR


    If iCopyPartsCount = 0 Then Exit Sub

    Dim i As Integer
    Dim ID As Long
    Dim part As clsPart
    Dim catID As Long
    Dim cat As clsCat
    Dim bSkip As Boolean
    Dim bAdd As Boolean
    
    catID = Val(right(tvCats.SelectedItem.KEY, Len(tvCats.SelectedItem.KEY) - Len("catalog")))
    
    Set cat = cCats(CStr(catID))
    
    Me.MousePointer = 11
    
    PB.Max = iCopyPartsCount
    PB.Min = 0
    
    For i = 1 To iCopyPartsCount
    
        ID = arCopyParts(i)
        
        Set part = New clsPart
        
        part.setIDv2 ID, True, True, True
        
        bSkip = False
        bAdd = True ' добавлять в лист
        
        Dim iExistingPartID As Long
        iExistingPartID = selectLongFromBase(cn_data, "part", "partID", "partName", part.partName, "catID", catID, "deleted", 0)
        
        If iExistingPartID > 0 Then
            
            Dim res As VbMsgBoxResult
            res = MsgBox("Изделие " & part.partName & " уже есть в каталоге, заменить?", vbYesNoCancel, "Совпадение")
            
            bAdd = False ' не добавлять в лист
            
            If res = vbYes Then
                Call updateTableInBase(cn_data, "part", "deleted", 1, "partID", iExistingPartID)
            ElseIf res = vbNo Then
'                If cat.catTypeID = 2 Then bSkip = True
                bSkip = True
            ElseIf res = vbCancel Then
                Exit For
            End If
            
        End If
        
        If Not bSkip Then

            part.setCat catID
            part.partIDold = part.partID
            part.partID = 0
            part.part_prntID = 0
            part.partStatusID = pst.pstRazrabotka
            part.savePart , True
        
        End If
        
'        If bAdd Then
'
'            Dim li As ListItem
'            Set li = fgCatTree.ListItems.Add(, "part" & part.partID, part.partName)
'            If Len(part.partVers) > 0 Then li.text = li.text & "(" & part.partVers & ")"
'            li.Selected = False
'            li.Bold = True
'            li.Tag = part.partID
'
'        End If
        
        Set part = Nothing
        
        PB.Value = i
        PB.Refresh
        
    Next i
    
    
    tvCats_NodeClick tvCats.SelectedItem
    
    fgCatTree.Refresh
    
    Me.MousePointer = 0

    PB.Value = 0
    PB.Refresh

Exit Sub

mnuCatPartsPaste_Click_ERR:
    Me.MousePointer = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatPartsPaste_Click - Error"

End Sub

Private Sub mnuCatsTreeAccess_Click()


    Dim nd As Node
    Dim catID As Long
    Dim bChildren As Boolean

    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
    
        catID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    
    End If

    
    Dim i As Integer
    
    If nd.children > 0 Then
        Dim ndx As Node
        Set ndx = nd.Child.FirstSibling
        For i = 1 To nd.children
            If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
                bChildren = True
                Exit For
            End If
            
            Set ndx = ndx.Next
        Next
    End If



    Load frmAccess
    frmAccess.loadGrid catID
    frmAccess.chkChildren.Visible = bChildren
    frmAccess.Show 1, Me


End Sub





'/******************************************************************************
Private Sub mnuCatsTreeBindDgn_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeBindDgn_Click_ERR

    Dim msapp As Object
    Set msapp = getMS
    If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
    
    

    
    
    Dim nd As Node
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    Dim catID As Long
    catID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    
    
    If Not rcatExists(msapp) Then
    
        MsgBox "Для MicroStation должно быть установлено соответствующее приложение", vbCritical, ""
        Exit Sub
        
    End If
    

    msapp.CadInputQueue.SendMessageToApplication "rcat", "curcat" & "|" & _
                                                        conn.strBaseName & "|" & _
                                                        getProjID(nd, catID) & "|" & _
                                                        catID & "|" & _
                                                        nd.text & "|" & _
                                                        nd.FullPath & "|" & _
                                                        "1"


    '=====================================================
    Exit Sub '>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    '=====================================================


    Dim oScanCriteria As ElementScanCriteria
    Set oScanCriteria = New ElementScanCriteria
    
    oScanCriteria.ExcludeAllTypes
    oScanCriteria.IncludeType msdElementTypeMicroStation


    Dim oScanEnumerator As ElementEnumerator
    Set oScanEnumerator = ActiveModelReference.Scan(oScanCriteria)

    Dim ele As Element
    Dim clele As Element
    Dim ae As ApplicationElement
    Dim bOk As Boolean


    Do While oScanEnumerator.MoveNext
        Set ele = oScanEnumerator.Current
        If ele.Subtype = msdElementSubtypeApplicationElement Then
            Set ae = ele.AsApplicationElement
            
            If ae.ApplicationID = appID Then
            
                Dim dbOut As DataBlock
                
                Set dbOut = ae.GetApplicationData
                
                dbOut.CopyLong catID, False
                
                Set nd = tvGetTreeNode(tvCats, "catalog" & catID)
                
                If nd Is Nothing Then
                    ActiveModelReference.RemoveElement ele
                    bOk = True
                Else
                    partsTreeAddLabel lblCatName, tvCats.Nodes("catalog" & catID), , , , True
                    
                    If MsgBox("Файлу " & vbNewLine & msapp.ActiveDesignFile.FullName & ", модель " & msapp.ActiveModelReference.Name & vbNewLine _
                                & "уже привязан каталог " & vbNewLine & lblCatName.Caption & vbNewLine & "Заменить?", vbYesNo, "") = vbYes Then
                        ActiveModelReference.RemoveElement ele
                        bOk = True
                    Else
                        Exit Sub
                    End If
                End If
                
                
                
            
            End If
        
        End If
        
    Loop
    
    
    catID = Val(right(tvCats.SelectedItem.KEY, Len(tvCats.SelectedItem.KEY) - Len("catalog")))
    
    partsTreeAddLabel lblCatName, tvCats.Nodes("catalog" & catID), , , , True


    If Not bOk Then
        If MsgBox("Файлу " & vbNewLine & msapp.ActiveDesignFile.FullName & ", модель " & msapp.ActiveModelReference.Name & vbNewLine _
                    & "будет привязан каталог " & vbNewLine & lblCatName.Caption & vbNewLine & "Все правильно?", vbYesNo, "") = vbNo Then
            Exit Sub
        End If
    End If



    Dim ad As New DataBlock
    
    
    
    ad.Offset = 0

    ad.CopyLong catID, True

    
    Set ae = CreateApplicationElement(appID, ad)
    
    msapp.ActiveModelReference.AddElement ae
    
    MsgBox "Файл " & msapp.ActiveDesignFile.FullName & ", модель " & msapp.ActiveModelReference.Name & vbNewLine _
                & "успешно привязан к каталогу" & vbNewLine & lblCatName.Caption
                
    '... событие для rein.ma

    Set msapp = Nothing

Exit Sub

mnuCatsTreeBindDgn_Click_ERR:
    Set msapp = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeBindDgn_Click - Error"

End Sub

'/******************************************************************************
Private Sub fgCmdFillPosRow(ByRef FG As VSFlexGrid, ByRef RS As ADODB.Recordset, Row As Long)
'/******************************************************************************

    On Error GoTo fgCmdFillPosRow_ERR
    
    Dim sm As clsSrtm
    Dim mt As clsMat
    
    Set sm = globSrtm(CStr(RS.fields("srtmID").Value))
    If Not IsNull(RS.fields("matID").Value) Then Set mt = globMats(CStr(RS.fields("matID").Value)) Else Set mt = New clsMat


    FG.TextMatrix(Row, FG.ColIndex("ID")) = RS.fields("posID").Value
    If (RS.fields("posNumber").Value > 0) Then FG.TextMatrix(Row, FG.ColIndex("number")) = RS.fields("posNumber").Value
    FG.TextMatrix(Row, FG.ColIndex("qty")) = RS.fields("posQuantity").Value
    FG.TextMatrix(Row, FG.ColIndex("untmass")) = RS.fields("posUnitMass").Value
    FG.TextMatrix(Row, FG.ColIndex("cmnmass")) = RS.fields("posCommonMass").Value
    FG.TextMatrix(Row, FG.ColIndex("name")) = sm.SRTM_STDPD.SP_PD.PD_NAME & " " & sm.srtmName & " " & mt.matName
    FG.TextMatrix(Row, FG.ColIndex("srtmID")) = RS.fields("srtmID").Value
    If Not IsNull(RS.fields("partStatusID").Value) Then FG.TextMatrix(Row, FG.ColIndex("status")) = RS.fields("partStatusID").Value


Exit Sub

fgCmdFillPosRow_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCmdFillPosRow - Error"
    FG.TextMatrix(Row, FG.ColIndex("name")) = err.Description
    FG.Cell(flexcpBackColor, Row, FG.ColIndex("name")) = lngRed

End Sub

'/******************************************************************************
Private Sub mnuCatsTreeCopy_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeCopy_Click_ERR

    Dim nd As Node

    lngCurCatListIDtoCopy = 0
    lngCurCatalogIDtoCopy = 0


    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If LCase(left(nd.KEY, Len("catlist"))) = "catlist" Then
        
        lngCurCatListIDtoCopy = Val(right(nd.KEY, Len(nd.KEY) - Len("catlist")))

    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
    
        lngCurCatalogIDtoCopy = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    
    End If





Exit Sub

mnuCatsTreeCopy_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreeCopy_Click - Error"

End Sub




'/******************************************************************************
Private Sub mnuCatsTreeCopyHere_Click()
'/******************************************************************************
    
    On Error GoTo mnuCatsTreeCopyHere_Click_ERR
    
    
    Dim n As Node
    Dim nd As Node
    Dim ndp As Node
    
    Set nd = tvCats.SelectedItem
    Set ndp = nd.parent
    
    If nd Is Nothing Then Exit Sub
    If ndp Is Nothing Then Exit Sub
    
    Dim ID As Long
    Dim pID As Long
    Dim catIDnew As Long
    Dim objectID As Long
    Dim objID As Long
    
    

    
    
    If LCase(left(nd.KEY, Len("catlist"))) = "catlist" Then
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
        
        If InStr(ndp.KEY, "catalog") = 1 Then
            pID = Val(right(ndp.KEY, Len(ndp.KEY) - Len("catalog")))
            catIDnew = copyCatList(pID, ID)
            If catIDnew > 0 Then
                Set tvCats.SelectedItem = tvCats.Nodes("catlist" & catIDnew)
                tvCats.StartLabelEdit
            End If
        End If
        
        
        
    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        
        ' parent
        
        Call getNodeIds(ndp, objID, objectID, False)
        
'        If InStr(ndp.KEY, "building") = 1 Then
'            objectID = Val(right(ndp.KEY, Len(ndp.KEY) - Len("building")))
'            objID = objs("building")
'        ElseIf InStr(ndp.KEY, "block") = 1 Then
'            objectID = Val(right(ndp.KEY, Len(ndp.KEY) - Len("block")))
'            objID = objs("block")
'        ElseIf InStr(ndp.KEY, "project") = 1 Then
'            objectID = Val(right(ndp.KEY, Len(ndp.KEY) - Len("project")))
'            objID = objs("project")
'        ElseIf InStr(ndp.KEY, "catalog") = 1 Then
'            objectID = Val(right(ndp.KEY, Len(ndp.KEY) - Len("catalog")))
'            objID = objs("catalog")
'        End If
        
        Dim ct As clsCat
        Set ct = cCats(CStr(ID))
        
        copyInfo.bOk = False
        copyInfo.sOldCatName = nd.text
        copyInfo.sNewCatName = nd.text & " (копия)"
        Set copyInfo.cn_dst = Nothing
        Set copyInfo.cn_src = Nothing
        copyInfo.sBaseNameDst = ""
        copyInfo.sBaseNameSrc = ""
        
        Dim fc As New frmCopy
        
        fc.txtSrcName.text = copyInfo.sOldCatName
        fc.txtDstName.text = copyInfo.sNewCatName
        
        partsTreeAddLabel fc.lblSrc, tvGetTreeNode(tvCats, ndp.KEY), , False, , True
        partsTreeAddLabel fc.lblDst, tvGetTreeNode(tvCats, ndp.KEY), , False, , True
        
        
        
        fc.Show 1, Me
        
        If Not copyInfo.bOk Then Exit Sub
        
        Me.MousePointer = 11
        
        catIDnew = copyCatalog2(objectID, objID, ID, , ndp.KEY, cattypes(ct.catTypeID).tnNum & "_open_st0", copyInfo.bReinChilds, copyInfo.sNewCatName)
        
        setCatlistDefault ID, catIDnew
        
        selectTreeNode "catalog" & catIDnew, tvCats
        
        Me.MousePointer = 0
        
        
        '        If catIDnew > 0 Then
        '            If addTreeNode(tvCats, n, ndp.KEY, tvwChild, "catalog" & catIDnew, _
                                    '                        selectStringFromBase(cn_data, "i_catalog", "catName", "catID", catIDnew), _
                                    '                        nd.Image) Then
        '                n.Tag = "catalog"
        '                If CBool(selectLongFromBase(cn_data, "i_catalog", "catUnif", "catID", lngCurCatalogIDtoCopy)) > 0 Then n.bOld = True
        '                If CBool(selectLongFromBase(cn_data, "i_catalog", "forTesting", "catID", lngCurCatalogIDtoCopy)) Then n.ForeColor = &H80000010
        '
        ''                If objID <> objs("catalog") Then createCatList catIDnew, "спецификация", True, False
        '
        '
        '                ' ===========================================================
        '                ' копируем списки
        '
        ''                Dim clID As Long
        ''
        ''                Dim RSparts As New ADODB.Recordset
        ''                RSparts.Open "select * from catlist where catID = " & ID, cn_data, adOpenForwardOnly, adLockReadOnly
        ''
        ''                If Not RSparts.EOF Then
        ''                    RSparts.MoveFirst
        ''                    Do
        ''                        clID = RSparts.Fields("catlistID").Value
        ''
        ''                        copyCatList catIDnew, clID, prtcol
        ''
        ''                        RSparts.MoveNext
        ''                    Loop Until RSparts.EOF
        ''                End If
        ''
        ''                RSparts.Close
        ''                Set RSparts = Nothing
        '
        '                ' ======================================
        '
        '
        '            End If
        '        End If
        
        
    End If
    
    
    
    
    
    
    Exit Sub
    
mnuCatsTreeCopyHere_Click_ERR:
    Me.MousePointer = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeCopyHere_Click - Error"
    
End Sub

'/////////////////////////////////////////////////////////////////////////////////
Private Sub mnuCatsTreeCreateBlock_Click()


    On Error GoTo mnuCatsTreeCreateBlock_Click_ERR

    
    
    Dim nd As Node
    Set nd = tvCats.SelectedItem
    Dim RS As New ADODB.Recordset
    Dim iMax As Integer
    Dim RSC As New ADODB.Recordset
    Dim projectID As Long
    Dim ID As Long
    
    projectID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
    
    If projectID = 0 Then Exit Sub
    
    RS.Open "select max(blockNumber) as [mx] from i_block where projectID = " & projectID & " and deleted = 0", cn_data, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        If IsNull(RS![mx]) Then
            iMax = 1
        Else
            iMax = RS![mx]
            iMax = iMax + 1
        End If
    End If
    
    Dim ndNew As Node
    
    Set ndNew = tvCats.Nodes.Add(nd.KEY, tvwChild, "block0", getBloackName(CLng(iMax)), "block")
    
    ndNew.Selected = True
    
    Set RSC = New ADODB.Recordset
    
    RSC.Open "select top 1 * from i_block order by blockID desc", cn_data, adOpenForwardOnly, adLockOptimistic
    
    
    RSC.AddNew
    RSC![blockNumber] = iMax
    RSC![projectID] = projectID
    RSC.Update
    RSC.Requery
    RSC.MoveFirst
    ID = RSC![blockID]
    RSC.Close
    
    
    ndNew.KEY = "block" & ID
    ndNew.Tag = "block"
    
    
    
    Call writeOperationS(operCreate, "block", ID)
    
    
    
    
Exit Sub

mnuCatsTreeCreateBlock_Click_ERR:



End Sub

'/////////////////////////////////////////////////////////////////////////////////
Private Sub mnuCatsTreeCreateBuilding0_Click(Index As Integer)


    On Error GoTo mnuCatsTreeCreateBuilding0_Click_ERR

    
    '
    Dim cbldID As Long
    Dim parentID As Long
    Dim objID As Long
    cbldID = mnuCatsTreeCreateBuilding0(Index).Tag
    Dim ID As Long
    
    Dim strCode As String
    Dim strName As String
    
    strCode = selectStringFromBase(cn_data, "c_building", "buildingCode", "buildingID", cbldID)
    strName = selectStringFromBase(cn_data, "c_building", "buildingName", "buildingID", cbldID)
    
    Dim nd As Node
    Set nd = tvCats.SelectedItem
    
    
    
    If LCase(left(nd.KEY, Len("project"))) = "project" Then
        
        parentID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
        objID = objs("project")
        
    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
        
        parentID = Val(right(nd.KEY, Len(nd.KEY) - Len("block")))
        objID = objs("block")
        
    End If
    
    
    
    
    Dim ndNew As Node
    
    Set ndNew = tvCats.Nodes.Add(nd.KEY, tvwChild, "building0", strCode & " - " & strName, "building")
    
    ndNew.Selected = True
    
    Dim RSC As New ADODB.Recordset
    
    RSC.Open "select top 1 * from i_building order by bldID desc", cn_data, adOpenForwardOnly, adLockOptimistic
    
    
    RSC.AddNew
    RSC![buildingID] = cbldID
    RSC![objectID] = parentID
    RSC![objID] = objID
    RSC.Update
    RSC.Requery
    RSC.MoveFirst
    ID = RSC![bldID]
    RSC.Close
    
    
    ndNew.KEY = "building" & ID
    ndNew.Tag = "building|" & cbldID ' разделитель "|"
    
    
    Call writeOperationS(operCreate, "building", ID)

    
Exit Sub

mnuCatsTreeCreateBuilding0_Click_ERR:




End Sub

'/////////////////////////////////////////////////////////////////////////////////
'/******************************************************************************
Private Sub createCatalog(catTypeID As Long, Optional prnt_objID As Long = 0, Optional prnt_objectID As Long = 0, Optional ByRef ndToRemove As Node = Nothing)
'/******************************************************************************

    On Error GoTo createCatalog_ERR


    Dim ndPnt As Node
    Dim ndNew As Node
    
    Dim ID As Long
    Dim objID As Long
    Dim pID As Long
    Dim pobjID As Long
    'Dim strObjName As String
    'Dim cattypeID As Long
    Dim catID As Long
    Dim catListID As Long
    Dim strCatTypeName As String
    Dim strName As String
    
    Dim iSub As pwbldsub
    iSub = pwbldsubNon
    
    'cattypeID = cattypeID
    
    strCatTypeName = cattypes(catTypeID).tnNum
    
    ' определяем родителя
    If prnt_objID > 0 And prnt_objectID > 0 Then
        pobjID = prnt_objID
        pID = prnt_objectID
        iSub = pwbldsubSet
    Else
    
        Set ndPnt = tvCats.SelectedItem
    
        If ndPnt Is Nothing Then Exit Sub
    
        If Not getNodeIds(ndPnt, pobjID, pID, False, iSub) Then
            Exit Sub
        End If
    End If
    
    Dim o As clsObj
    Dim po As clsObj
    
    Set po = globObjs(CStr(pobjID))
    
    'strObjName = o.objname
    
'    If LCase(left(nd.KEY, Len("project"))) = "project" Then
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
'        strObjName = "project"
'    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("block")))
'        strObjName = "block"
'    ElseIf LCase(left(nd.KEY, Len("building"))) = "building" Then
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("building")))
'        strObjName = "building"
'    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
'        strObjName = "catalog"
'    End If
'
'    objID = objs(strObjName)
    
    
    
    If ndToRemove Is Nothing Then
        strName = InputBox("Наименование каталога", "", "Новый каталог " & (ndPnt.children + 1))
        Set o = globObjs(CStr(objs("catalog")))
    Else
    
        If getNodeIds(ndToRemove, objID, ID, False) Then
            strName = ndToRemove.text
        Else
            Exit Sub
        End If
        
        Set o = globObjs(CStr(objID))
    
    End If
    

    If Len(Trim(strName)) = 0 Then Exit Sub
    
    
    
    
    If o.objname = "docset" Then
        catID = insertDataInBase(cn_data, "i_catalog", "catName", strName, "catTypeID", catTypeID, "dsDrawingsID", ID)
    
    Else
        catID = insertDataInBase(cn_data, "i_catalog", "catName", strName, "catTypeID", catTypeID)
    
    End If
    
    
    

    
    If catID > 0 Then
    
        If Not ndToRemove Is Nothing Then
        
            tvCats.Nodes.Remove ndToRemove.KEY
        
        End If
    
        Dim prnkey As String
    
        If iSub Then
            prnkey = getPwBldSub(iSub) & pID
        Else
            prnkey = po.objname & pID
        End If
    
    
        Set ndNew = tvCats.Nodes.Add(prnkey, tvwChild, "catalog" & catID, strName, strCatTypeName)
        
        ndNew.Tag = "catalog"
        Call writeOperationS(operCreate, "catalog", catID, strName)
    Else
        MsgBox "Каталог не создан"
        Exit Sub
    End If
    
    If po.objname <> "catalog" Then
    
        catListID = createCatList(catID, "спецификация", True, False)
        
    End If


    ' relations

    Call insertDataInBase(cn_data, "r_object_catalog", "objID", pobjID, "catalogID", catID, "objectID", pID)
    
    
    If po.objname = "pwbld" Then
    
        Dim blckID As Long
        Dim bldID As Long
        
        ' get block id
        blckID = getBlockID(ndNew, 0)
    
        ' check pobjid reloation to block
        If blckID > 0 Then
        
            ' i_building_pw аналогично i_building
            bldID = selectLongFromBase(cn_data, "i_building_pw", "bldID", "buildingID", pID, "objID", objs("block"), "objectID", blckID)
        
            ' insert if not exist
            If bldID = 0 Then
            
                Call insertDataInBase(cn_data, "i_building_pw", "buildingID", pID, "objID", objs("block"), "objectID", blckID)
            
            End If
        
        
        
        End If
    
    
    
    End If
    
    
    
    ndNew.Selected = True
'    tvCats.StartLabelEdit



Exit Sub

createCatalog_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "createCatalog - Error"

End Sub



'/////////////////////////////////////////////////////////////////////////////////
Private Sub mnuCatsTreeCreateReinCat_Click()

    createCatalog 2


End Sub


'/////////////////////////////////////////////////////////////////////////////////
Private Sub mnuCatsTreeCreateCatalog_Click()


    createCatalog 1
    
    


End Sub

'/******************************************************************************
Private Function createCatList(catID As Long, strName As String, bSetDefault As Boolean, Optional bStartEdit As Boolean = True) As Long
'/******************************************************************************

    On Error GoTo createCatList_ERR
    
    Dim clID As Long
    
    If catID = 0 Then Exit Function
    
    clID = insertDataInBase(cn_data, "catlist", "catID", catID, "catlistName", strName)
    
    If clID = 0 Then Exit Function

    
    Dim ndNew As Node
    Set ndNew = tvCats.Nodes.Add("catalog" & catID, tvwChild, "catlist" & clID, strName, "catlist")
    ndNew.Tag = "catlist"
    
    Call writeOperationS(operCreate, "catlist", clID, "создание списка '" & strName & "'")
    
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))
    
    If ct.catListID = 0 And bSetDefault Then
        If updateTableInBase(cn_data, "i_catalog", "catlistID", clID, "catID", catID) Then
            ct.catListID = clID
            ndNew.Image = "catlist_def"
            Call writeOperationS(operModify, "catalog", catID, "назначен список " & strName)
        End If
    
    End If
    
    If bStartEdit Then
        ndNew.Selected = True
        tvCats.StartLabelEdit
    End If
    
    createCatList = clID

Exit Function

createCatList_ERR:
    createCatList = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "createCatList - Error"

End Function


'/******************************************************************************
Private Sub mnuCatsTreeCreateList_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeCreateList_Click_ERR


    Dim nd As Node
    Set nd = tvCats.SelectedItem

    Dim ID As Long
    Dim objID As Long
    Dim catListID As Long


    ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))

    catListID = createCatList(ID, "Новый список", True)


Exit Sub

mnuCatsTreeCreateList_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreeCreateList_Click - Error"

End Sub



'/////////////////////////////////////////////////////////////////////////////////
Private Sub mnuCatstreeDeleteItem_Click()


    On Error GoTo mnuCatstreeDeleteItem_Click_ERR


    Dim nd As Node
    Dim RS As New ADODB.Recordset
    Dim ID As Long
    
    Set nd = tvCats.SelectedItem
    
    
    If LCase(left(nd.KEY, Len("project"))) = "project" Then
        
        If mnuPrefCatDelConfirm.Checked Then
            If MsgBox("Подтвердите удаление проекта:" & vbNewLine & Replace(nd.FullPath, " - ", vbNewLine), vbOKCancel, "Подтверждение") = vbCancel Then Exit Sub
        End If
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
    
        RS.Open "select * from i_project where projectID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If Not RS.EOF Then
            RS.MoveFirst
            RS![deleted] = 1
            RS.Update
            tvCats.Nodes.Remove nd.KEY
            Call writeOperationS(operDelete, "project", ID)
        End If
        
        RS.Close
        
    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
    
        If mnuPrefCatDelConfirm.Checked Then
            If MsgBox("Подтвердите удаление блока:" & vbNewLine & Replace(nd.FullPath, " - ", vbNewLine), vbOKCancel, "Подтверждение") = vbCancel Then Exit Sub
        End If
    
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("block")))
    
        RS.Open "select * from i_block where blockID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If Not RS.EOF Then
            RS.MoveFirst
            RS![deleted] = 1
            RS.Update
            tvCats.Nodes.Remove nd.KEY
            Call writeOperationS(operDelete, "block", ID)
        End If
        
        RS.Close
    
    ElseIf LCase(left(nd.KEY, Len("building"))) = "building" Then
    
        If mnuPrefCatDelConfirm.Checked Then
            If MsgBox("Подтвердите удаление здания:" & vbNewLine & Replace(nd.FullPath, " - ", vbNewLine), vbOKCancel, "Подтверждение") = vbCancel Then Exit Sub
        End If
    
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("building")))
    
        RS.Open "select * from i_building where bldID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If Not RS.EOF Then
            RS.MoveFirst
            RS![deleted] = 1
            RS.Update
            tvCats.Nodes.Remove nd.KEY
            Call writeOperationS(operDelete, "building", ID)
        End If
        
        RS.Close
    
    
    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
    
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        
        Dim ndtext As String
        Dim prnkey As String
        Dim bPW As Boolean
        Dim ct As clsCat
        Set ct = cCats(CStr(ID))
        
        prnkey = nd.parent.KEY
        
        
        If mnuPrefCatDelConfirm.Checked And ct.pw_ds_fld_ID = 0 Then
            If MsgBox("Подтвердите удаление каталога:" & vbNewLine & Replace(nd.FullPath, " - ", vbNewLine), vbOKCancel, "Подтверждение") = vbCancel Then Exit Sub
        Else
            If MsgBox("Подтвердите удаление каталога:" & vbNewLine & _
                        "(Комплект ProjectWise не удаляется)" & vbNewLine & _
                        Replace(nd.FullPath, " - ", vbNewLine), vbOKCancel, "Подтверждение") = vbCancel Then Exit Sub
        End If
        
        If Not ct Is Nothing Then
        
            RS.Open "select * from i_catalog where catID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
            
            If Not RS.EOF Then
                RS.MoveFirst
                RS![deleted] = 1
                If ct.pw_ds_fld_ID > 0 Then
                    RS![dsDrawingsID] = 0
                    bPW = True
                    ndtext = nd.text
                End If
                RS.Update
                tvCats.Nodes.Remove nd.KEY
                Call ct.loadCatByID(Nothing, ID, bPW)
                Call writeOperationS(operDelete, "catalog", ID)
                
                If bPW Then
                    Dim TN As Node
                    If addTreeNode(tvCats, TN, prnkey, tvwChild, _
                        "docset" & ct.dsDrawID, ndtext, "pwfolder") Then
                        TN.Tag = "docset" & "|" & ct.getDocSetNumber(False)
                        TN.Selected = True
                    End If
                End If
                
            End If
            
        
            RS.Close
            
        End If

    
    ElseIf LCase(left(nd.KEY, Len("catlist"))) = "catlist" Then
    
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
    
        RS.Open "select * from catlist where catlistID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If Not RS.EOF Then
            RS.MoveFirst
            RS![deleted] = 1
            RS.Update
            tvCats.Nodes.Remove nd.KEY
'            loadCatList lngCurCatID
            Call writeOperationS(operDelete, "catlist", ID)
        End If
        
        
        RS.Close
    
    Else
    End If

    Set RS = Nothing


Exit Sub

mnuCatstreeDeleteItem_Click_ERR:
    Set RS = Nothing

End Sub





'/******************************************************************************
Private Sub mnuCatsTreeDocSet_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeDocSet_Click_ERR


    Dim i As Long
    Dim nd As Node
    Dim n As Node
    Dim sIDs As String
    Dim bNoCheck As Boolean
    Dim cnt As Long
    Dim iPartListID As Long
    Dim iDrawingsID As Long
    Dim ct As clsCat
    
    Dim ID As Long
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If left(nd.KEY, Len("catalog")) = "catalog" Then
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        Set ct = cCats(CStr(ID))
    Else
        Exit Sub
    End If
    
    If ct Is Nothing Then Exit Sub
    If ct.catID = 0 Then Exit Sub

    
    Dim frm As New frmDocSet
    frm.setIDs -1, ct.catDocSetDrawingsID
    frm.Show 1, Me
    
    If frm.bOk Then
    
'        iPartListID = frm.iPartListID
        iDrawingsID = frm.iDrawingsID

        Dim cmd As New ADODB.Command
        Dim iRecordsAffected As Integer
        cmd.ActiveConnection = cn_data

'        If iPartListID >= 0 Then
'            cmd.CommandText = "UPDATE [i_catalog] SET [dsPartListID] = " & iPartListID & " WHERE catID = " & ct.catID
'            cmd.Execute iRecordsAffected
'            If iRecordsAffected = 1 Then ct.catDocSetPartListID = iPartListID
'        End If

        If iDrawingsID >= 0 Then
            cmd.CommandText = "UPDATE [i_catalog] SET [dsDrawingsID] = " & iDrawingsID & " WHERE catID = " & ct.catID
            cmd.Execute iRecordsAffected
            If iRecordsAffected = 1 Then ct.catDocSetDrawingsID = iDrawingsID
        End If
    
        Set frm = Nothing
        Exit Sub
    Else
        Set frm = Nothing
    End If



Exit Sub

mnuCatsTreeDocSet_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeDocSet_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuCatsTreeGetIds_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeGetIds_Click_ERR



    Dim nd As Node
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then
        Exit Sub
    End If
    
    Dim cnt As Long
    
    Dim strCats As String
    Dim catID As Long

    Dim strSQL As String
    

    Dim i As Integer
    
    If nd.children > 0 Then
        Dim ndx As Node
       
        Set ndx = nd.Child.FirstSibling
        
        For i = 1 To nd.children
            If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
                catID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("catalog")))
'                If cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein Then
                    strSQL = strSQL & "," & catID
'                End If
            End If
            
            Set ndx = ndx.Next
        Next
    End If
    
    Clipboard.Clear
    Clipboard.SetText strSQL, vbCFText


Exit Sub

mnuCatsTreeGetIds_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeGetIds_Click - Error"

End Sub

Private Sub mnuCatsTreeLoad_Click() ' загрузить как изделия
    
    Dim nd As Node
    Dim ID As Long
    
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If left(nd.KEY, Len("catalog")) = "catalog" Then
        
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        
'        loadPartsTree ID, True
        loadCatalog ID, True, , , , ctEmb
        
    End If
    
End Sub

'/******************************************************************************
Private Function getPrt(Col As Collection, prtID As Long) As clsPart
'/******************************************************************************

    On Error GoTo getPrt_ERR

    If Col Is Nothing Then Exit Function
    
    Set getPrt = Col(CStr(prtID))


Exit Function

getPrt_ERR:
    Set getPrt = Nothing

End Function



'/******************************************************************************
Private Function copyCatList(catIDwhere As Long, catlistIDtoCopy As Long, Optional prtcol As Collection = Nothing, Optional bDef As Boolean = False) As Long
'/******************************************************************************

    On Error GoTo copyCatList_ERR


    Dim catlistName As String
    Dim catListID As Long
    Dim RS As New ADODB.Recordset
    Dim RSto As New ADODB.Recordset
    Dim prt As clsPart
    Dim prtIDtoSave As Long
    
    If catIDwhere = 0 Then Exit Function
    

    If catlistIDtoCopy > 0 Then
        catlistName = selectStringFromBase(cn_data, "catlist", "catlistName", "catlistID", catlistIDtoCopy)
    Else
        Exit Function
    End If
    
    
    catListID = createCatList(catIDwhere, catlistName, bDef, False)
    
    If catListID = 0 Then Exit Function
    
    
    
'    RS.Open "select * from catlist order by catlistID desc", cn_data, adOpenStatic, adLockOptimistic
'
'    RS.MoveFirst
'    RS.AddNew
'    RS.Fields("catID").Value = catIDwhere
'    RS.Fields("catlistName").Value = catlistName
'    RS.Update
'    RS.Requery
'    RS.MoveFirst
'    catListID = RS.Fields("catlistID").Value
'
'    RS.NextRecordset
    
    
    If catlistIDtoCopy > 0 Then
        RS.Open "select * from r_catlist_part where catlistID = " & catlistIDtoCopy, cn_data, adOpenForwardOnly, adLockReadOnly
    Else
        GoTo ext
    End If
    
    
    If Not RS.EOF Then
        RSto.Open "select * from r_catlist_part", cn_data, adOpenKeyset, adLockBatchOptimistic
        RS.MoveFirst
        Do
        
            Set prt = getPrt(prtcol, RS.fields("partID").Value)
            
            If prt Is Nothing Then
                prtIDtoSave = RS.fields("partID").Value
            ElseIf prt.bIsLink Then
                prtIDtoSave = RS.fields("partID").Value
            Else
                prtIDtoSave = prt.partID
            End If
        
            If prtIDtoSave > 0 Then
        
                RSto.AddNew
                RSto.fields("catlistID").Value = catListID
                RSto.fields("partID").Value = prtIDtoSave
                RSto.fields("partQty").Value = RS.fields("partQty").Value
                RSto.fields("partSortID").Value = RS.fields("partSortID").Value
                RSto.fields("objID").Value = RS.fields("objID").Value
            
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
        
        RSto.UpdateBatch
        RSto.Close
        Set RSto = Nothing
    End If
    
    RS.Close
    Set RS = Nothing
    
    Dim TN As Node
    If addTreeNode(tvCats, TN, "catalog" & catIDwhere, tvwChild, "catlist" & catListID, catlistName, "catlist") Then
        TN.Tag = "catlist"
    End If
    
ext:
    
    Set RS = Nothing
    Set RSto = Nothing
    
    copyCatList = catListID


Exit Function

copyCatList_ERR:
    copyCatList = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyCatList - Error"

End Function

'/******************************************************************************
Private Function copyCatalogRecord(objectID As Long, objID As Long, lngCatIDtoCopy As Long, _
                                        Optional bAskForName As Boolean = True, Optional strNewName As String = "", _
                                        Optional cn_src As ADODB.Connection = Nothing, _
                                        Optional cn_dst As ADODB.Connection = Nothing) As Long
'/******************************************************************************

    On Error GoTo copyCatalogRecord_ERR

    If lngCatIDtoCopy = 0 Then Exit Function

    copyCatalogRecord = 0
    
    
    Dim strOldCatName As String
    Dim strNewCatName As String
    Dim strCatCopySuffix As String
    
    
    If cn_src Is Nothing Then Set cn_src = cn_data
    If cn_dst Is Nothing Then Set cn_dst = cn_data
    

    strOldCatName = selectStringFromBase(cn_src, "i_catalog", "catName", "catID", lngCatIDtoCopy)
    strNewCatName = strNewName

    If Len(Trim(strOldCatName)) = 0 Then Exit Function
    If Len(Trim(strNewCatName)) = 0 Then Exit Function

    

    Dim RSsrc As New ADODB.Recordset
    
    Dim catNewID As Long
    
    RSsrc.Open "select * from i_catalog where catID = " & lngCatIDtoCopy, cn_src, adOpenForwardOnly, adLockReadOnly
    
    If Not RSsrc.EOF Then
    
        RSsrc.MoveFirst
        
        ' создаем каталог
        catNewID = insertDataInBase(cn_dst, "i_catalog", _
                    "catName", strNewCatName, _
                    "catTypeID", RSsrc.fields("catTypeID").Value, _
                    "forTesting", RSsrc.fields("forTesting").Value, _
                    "catlistID", 0)
        
        If catNewID = 0 Then err.Raise 100, "Offt", "ошибка при insertDataInBase в i_catalog"
                    
        copyInfo.catTypeID = RSsrc.fields("catTypeID").Value
        
        ' получаем ID нового каталога
'        RSsrc.NextRecordset
'        RSsrc.Open "select top 1 * from i_catalog order by catID desc", cn_dst, adOpenForwardOnly, adLockReadOnly
'        RSsrc.MoveFirst
'        catNewID = RSsrc.Fields("catID").Value
        
        ' прописываем отношение к объекту
        If insertDataInBase(cn_dst, "r_object_catalog", _
                    "objID", objID, _
                    "objectID", objectID, _
                    "catalogID", catNewID) = 0 Then err.Raise 100, "Offt", "ошибка при insertDataInBase в r_object_catalog"
        
    End If
    
    
    RSsrc.Close
    Set RSsrc = Nothing
    
    


    copyCatalogRecord = catNewID


Exit Function



copyCatalogRecord_ERR:
    Set RSsrc = Nothing
    copyCatalogRecord = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyCatalogRecord - Error"

End Function


'/******************************************************************************
' NOT USING. новое копирование copyCatalog2
'Private Function copyCatalog(objectID As Long, objID As Long, lngCatIDtoCopy As Long, _
'                             Optional bCopyLists As Boolean = False, _
'                             Optional sParentNodeKey As String = "", _
'                             Optional sNodeImage As String = "", _
'                             Optional bCopyReinChildCats As Boolean = True, _
'                             Optional sNewCatName As String = "") As Long
''/******************************************************************************
'
'    On Error GoTo copyCatalog_ERR
'
'
'    If lngCatIDtoCopy = 0 Then Exit Function
'
'    copyCatalog = 0
'
'
'    Dim bSkipLinks As Boolean
'    Dim res As VbMsgBoxResult
'    Dim iLinkCount As Integer
'
'
'    Dim catNewID As Long
'
'    catNewID = copyCatalogRecord(objectID, objID, lngCatIDtoCopy, , sNewCatName)
'
'    If catNewID = 0 Then Exit Function
'
'    Dim RS As New ADODB.Recordset
'
'    RS.Open "select count(*) as cnt from r_catalog_part where catID = " & lngCatIDtoCopy, cn_data, adOpenStatic, adLockReadOnly
'    If Not RS.EOF Then
'        RS.MoveFirst
'        iLinkCount = RS.Fields("cnt").Value
'    End If
'    RS.Close
'    Set RS = Nothing
'
'    If iLinkCount > 0 And getProjID(Nothing, lngCatIDtoCopy) <> getProjID(Nothing, catNewID) Then
'
'        res = MsgBox("Так как идет копирование между разными проектами, ссылки будут указывать на изделия старого проекта. Какие варианты:" & vbNewLine & _
'                     "Да - будет скопировано все содержимое каталога, включая ссылки на изделия другого проекта" & vbNewLine & _
'                     "Нет - будет скопировано содержимое каталога без ссылок" & vbNewLine & _
'                     "Отмена - копимрование будет отменено" _
'                     , vbYesNoCancel, "Вопрос")
'
'        If res = vbNo Then bSkipLinks = True
'        If res = vbCancel Then Exit Function
'
'    End If
'
'
'    ' копируем изделия в новый каталог
'    ' ======================================
'    Dim RSparts As New ADODB.Recordset
'    RSparts.Open "select * from part where catID = " & lngCatIDtoCopy, cn_data, adOpenForwardOnly, adLockReadOnly
'
'    Dim prt As clsPart
'    Dim prtcol As New Collection
'
'    Dim bDeleted As Boolean
'    '
'    '    ' перебор изделий
'    '    If Not RSparts.EOF Then
'    '        RSparts.MoveFirst
'    '        Do
'    '            Set prt = New clsPart
'    '            prt.setValuesFromRS RSparts, catNewID, RSparts.Fields("partID").Value ' partID = 0
'    '            Set prt = Nothing
'    '            RSparts.MoveNext
'    '        Loop Until RSparts.EOF
'    '    End If
'    '
'    '    RSparts.Close
'    '    Set RSparts = Nothing
'    '
'
'
'    ' перебор изделий
'    If Not RSparts.EOF Then
'        RSparts.MoveFirst
'        Do
'            Set prt = New clsPart
'            prt.partID = RSparts.Fields("partID").Value
'            prt.partName = RSparts.Fields("partName").Value & ""
'            prt.partStatusID = RSparts.Fields("partStatusID").Value
'            bDeleted = CBool(RSparts.Fields("deleted").Value)
'
'            If Not bDeleted And prt.partStatusID <> pst.pstUstar Then
'                prtcol.Add prt, CStr(prt.partID) ' ключ для дальнейшего обращения по partIDold - для копирования списков с перенаправленными ссылками
'            End If
'
'            Set prt = Nothing
'            RSparts.MoveNext
'        Loop Until RSparts.EOF
'    End If
'
'
'    PB.Min = 0
'    If prtcol.Count > 0 Then PB.Max = prtcol.Count
'    PB.Value = 0
'
'    For Each prt In prtcol
'        If prt.setIDv2(prt.partID, True, True, True) Then
'
'            prt.setCat catNewID
'            prt.partIDold = prt.partID
'            prt.partID = 0 ' обнуляем так как новая
'            prt.parentID = 0
'            prt.partStatusID = pst.pstRazrabotka
'
'            prt.savePart , True
'
'            PB.Value = PB.Value + 1
'            PB.Refresh
'
'        Else
'            err.Raise 100, , "Ошибка при сохранении " & prt.partName
'        End If
'    Next prt
'
'    PB.Value = 0
'
'
'    ' копируем ссылки в новый каталог
'    ' ======================================
'    RSparts.NextRecordset
'    RSparts.Open "select * from r_catalog_part where catID = " & lngCatIDtoCopy, cn_data, adOpenForwardOnly, adLockReadOnly
'
'    If Not RSparts.EOF And bSkipLinks = False Then
'
'        RSparts.MoveFirst
'        Do
'
'            Set prt = New clsPart
'            prt.partID = RSparts.Fields("partID").Value
'            '            prt.partName = RSparts.Fields("partName").Value
'            prt.bIsLink = True
'            prtcol.Add prt, CStr(prt.partID)
'            Set prt = Nothing
'
'            insertDataInBase cn_data, "r_catalog_part", "catID", catNewID, "partID", RSparts.Fields("partID").Value
'
'            RSparts.MoveNext
'        Loop Until RSparts.EOF
'    End If
'
'
'    ' добавляем ветку дерева если требуется
'    If Len(sParentNodeKey) > 0 And catNewID > 0 Then
'
'        Dim N As Node
'
'        If addTreeNode(tvCats, N, sParentNodeKey, tvwChild, "catalog" & catNewID, _
'           selectStringFromBase(cn_data, "i_catalog", "catName", "catID", catNewID), _
'           sNodeImage) Then
'            N.Tag = "catalog"
'            If CBool(selectLongFromBase(cn_data, "i_catalog", "catUnif", "catID", lngCatIDtoCopy)) > 0 Then N.bOld = True
'            If CBool(selectLongFromBase(cn_data, "i_catalog", "forTesting", "catID", lngCatIDtoCopy)) Then N.ForeColor = &H80000010
'        End If
'
'    End If
'
'
'
'
'
'    '    ' ===========================================================
'    '    ' копируем списки
'
'    Dim clID As Long
'
'    If bCopyLists Then
'
'        RSparts.NextRecordset
'        RSparts.Open "select * from catlist where catID = " & lngCatIDtoCopy, cn_data, adOpenForwardOnly, adLockReadOnly
'
'        If Not RSparts.EOF Then
'            RSparts.MoveFirst
'            Do
'                clID = RSparts.Fields("catlistID").Value
'
'                copyCatList catNewID, clID, prtcol, CBool(selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", lngCatIDtoCopy) = clID)
'
'                RSparts.MoveNext
'            Loop Until RSparts.EOF
'        End If
'
'
'    End If
'
'    '    ' ======================================
'
'
'    '========================================================
'    ' убрано временно, потом доделать - копирование подкаталогов, не работает для вставки из буфера
''    Dim I As Integer
''    Dim catIDchild As Long
''    Dim catID As Long
''
''    Dim nd_to_copy As Node
''    Dim nd_new As Node
''    Set nd_to_copy = tvGetTreeNode(tvCats, "catalog" & lngCatIDtoCopy)
''    Set nd_new = tvGetTreeNode(tvCats, "catalog" & catNewID)
''
''    If bCopyReinChildCats And Not nd_new Is Nothing And Not nd_to_copy Is Nothing Then
''        If nd_to_copy.children > 0 Then
''            Dim ndx As Node
''
''            Set ndx = nd_to_copy.Child.FirstSibling
''
''            For I = 1 To nd_to_copy.children
''                If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
''                    catID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("catalog")))
''                    If cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein Then
''
''                        catIDchild = copyCatalog(catNewID, objs("catalog"), catID, False, nd_new.KEY, nd_new.Image, False, ndx.text)
''
''
''                    End If
''                End If
''
''                Set ndx = ndx.Next
''            Next
''        End If
''    End If
'    '========================================================
'
'
'
'
'    RSparts.Close
'    Set RSparts = Nothing
'
'    writeOperationS operCreate, "catalog", catNewID, "Создание каталога копированием"
'
'
'    copyCatalog = catNewID
'
'
'    Exit Function
'
'copyCatalog_ERR:
'    Set prt = Nothing
'    Set RSparts = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyCatalog - Error"
'
'End Function


'/******************************************************************************
Private Sub mnuCatsTreePaste_Click()
'/******************************************************************************
    
    On Error GoTo mnuCatsTreePaste_Click_ERR
    
    
    Dim nd As Node
    
    Dim catID As Long
    Dim catIDnew As Long
    
    Dim catlistName As String
    
    Dim catlistIDdef As Long
    Dim catlistIDnew As Long
    
'    Dim RS As New ADODB.Recordset
'    Dim RSto As New ADODB.Recordset
    
    Dim n As Node
    Dim nc As Node
    Dim ntc As Node
    
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    
    

    
    
    If lngCurCatalogIDtoCopy > 0 Then
    
        Set ntc = tvGetTreeNode(tvCats, "catalog" & lngCurCatalogIDtoCopy)
        
        If ntc Is Nothing Then Exit Sub
        
        copyInfo.bOk = False
        copyInfo.sOldCatName = ntc.text
        copyInfo.sNewCatName = ntc.text
        Set copyInfo.cn_dst = Nothing
        Set copyInfo.cn_src = Nothing
        copyInfo.sBaseNameDst = ""
        copyInfo.sBaseNameSrc = ""
        
        Dim fc As New frmCopy
        
        Dim projSrcID As Long
        Dim projDstID As Long
        projSrcID = getProjID(ntc, 0)
        projDstID = getProjID(nd, 0)
        If projSrcID <> projDstID Then
'            fc.chkLinks.ForeColor = lngRed
'            fc.chkLinks.Value = 0
            fc.chkLinks.Enabled = False
        End If
        
        
        
        
        fc.txtSrcName.text = copyInfo.sOldCatName
        fc.txtDstName.text = copyInfo.sNewCatName
        
        
        partsTreeAddLabel fc.lblSrc, tvGetTreeNode(tvCats, ntc.parent.KEY), , False, , True
        partsTreeAddLabel fc.lblDst, tvGetTreeNode(tvCats, nd.KEY), , False, , True
        
        
        
        fc.Show 1, Me
        
        If Not copyInfo.bOk Then Exit Sub
    
    
    ElseIf lngCurCatListIDtoCopy = 0 Then
        Exit Sub
    
    End If
    
    
    Me.MousePointer = 11
    
    
    Dim ct As clsCat
    Set ct = cCats(CStr(lngCurCatalogIDtoCopy))
    
    
    If LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then ' копируется подкаталог или список
    
        catID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        
        If lngCurCatalogIDtoCopy > 0 Then
        
            catIDnew = copyCatalog2(catID, objs("catalog"), lngCurCatalogIDtoCopy, , nd.KEY, cattypes(ct.catTypeID).tnNum & "_open_st0", copyInfo.bReinChilds, copyInfo.sNewCatName)
            
'            If catIDnew > 0 Then
'                Set nc = tvGetTreeNode(tvCats, "catalog" & lngCurCatalogIDtoCopy)
'                If Not nc Is Nothing Then
'                    If addTreeNode(Me.tvCats, n, "catalog" & catID, tvwChild, "catalog" & catIDnew, _
'                                selectStringFromBase(cn_data, "i_catalog", "catName", "catID", catIDnew), _
'                                nc.Image) Then
'                        n.Tag = "catalog"
'                        If CBool(selectLongFromBase(cn_data, "i_catalog", "catUnif", "catID", lngCurCatalogIDtoCopy)) > 0 Then n.bOld = True
'                        If CBool(selectLongFromBase(cn_data, "i_catalog", "forTesting", "catID", lngCurCatalogIDtoCopy)) Then n.ForeColor = &H80000010
'                    End If
'                End If
'            End If
            
            
        ElseIf lngCurCatListIDtoCopy > 0 Then
            copyCatList catID, lngCurCatListIDtoCopy
        Else
        End If
        
        
        
        
    ElseIf LCase(left(nd.KEY, Len("building"))) = "building" Then
    
        Dim bldID As Long
        bldID = Val(right(nd.KEY, Len(nd.KEY) - Len("building")))
        
'################################
'        MsgBox "   Эта операция пока не готова к использованию   ", vbCritical, ""
'        Exit Sub
'################################
        
        'copy catalog to building
        '==========================================================
        catIDnew = copyCatalog2(bldID, objs("building"), lngCurCatalogIDtoCopy, , nd.KEY, cattypes(ct.catTypeID).tnNum & "_open_st0", copyInfo.bReinChilds, copyInfo.sNewCatName)

        
        selectTreeNode "catalog" & catIDnew, tvCats
        
        
'        If catIDnew > 0 Then
            
'            Set nc = tvGetTreeNode(tvCats, "catalog" & lngCurCatalogIDtoCopy)
'            If Not nc Is Nothing Then
'                If addTreeNode(Me.tvCats, n, "building" & bldID, tvwChild, "catalog" & catIDnew, _
'                            selectStringFromBase(cn_data, "i_catalog", "catName", "catID", catIDnew), _
'                            nc.Image) Then
'                    n.Tag = "catalog"
'                    If CBool(selectLongFromBase(cn_data, "i_catalog", "catUnif", "catID", lngCurCatalogIDtoCopy)) > 0 Then n.bOld = True
'                    If CBool(selectLongFromBase(cn_data, "i_catalog", "forTesting", "catID", lngCurCatalogIDtoCopy)) Then n.ForeColor = &H80000010
'
'                    createCatList catIDnew, "спецификация", True, False
'
'                End If
'            End If
            
            ' копирование списков предполагает что в них заносятся линки на НОВЫЕ изделия,
            ' данный код копирует в новые списки линки на изделия из старых списков
            ' (сравнение содержимого списков?)
            
            
'            catlistIDdef = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", lngCurCatalogIDtoCopy)
'
'            Dim RS As New ADODB.Recordset
'            RS.Open "select * from catlist where catID = " & lngCurCatalogIDtoCopy & " and deleted = 0", cn_data, adOpenForwardOnly, adLockReadOnly
'
'            If Not RS.EOF Then
'
'                RS.MoveFirst
'                Do
'                    catlistIDnew = copyCatList(catIDnew, RS.Fields("catlistID").Value)
'
'                    If catlistIDnew > 0 And catlistIDdef = RS.Fields("catlistID").Value Then
'                        If updateTableInBase(cn_data, "i_catalog", "catlistID", catlistIDnew, "catID", catIDnew) Then
'                            Set nc = tvGetTreeNode(tvCats, "catlist" & catlistIDnew)
'                            If Not nc Is Nothing Then
'                                nc.Image = "catlist_def"
'                            End If
'                        End If
'
'                        writeOperationS operCreate, "catlist", catlistIDnew, "Копия списка при копировании каталога"
'
'                    End If
'
'                    RS.MoveNext
'                Loop Until RS.EOF
'            End If
'
'            RS.Close
'            Set RS = Nothing
            
        
            
'        End If
        
    End If
    
    setCatlistDefault lngCurCatalogIDtoCopy, catIDnew
    
    Me.MousePointer = 0
    
    
    Exit Sub
    
mnuCatsTreePaste_Click_ERR:
    Me.MousePointer = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreePaste_Click - Error"
    
End Sub




'/******************************************************************************
Private Sub mnuCatsTreePWArm_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreePWArm_Click_ERR

    
    Dim nd As Node

    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    Dim objID As Long
    Dim ID As Long
    
    If getNodeIds(nd.parent, objID, ID, False) Then
        createCatalog ctRein, objID, ID, nd
    End If


Exit Sub

mnuCatsTreePWArm_Click_ERR:
    'MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreePWArm_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuCatsTreePWEmb_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreePWEmb_Click_ERR

    Dim nd As Node

    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    Dim objID As Long
    Dim ID As Long
    
    If getNodeIds(nd.parent, objID, ID, False) Then
        createCatalog ctEmb, objID, ID, nd
    End If
    



Exit Sub

mnuCatsTreePWEmb_Click_ERR:
    'MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreePWEmb_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuCatsTreeReinLoad_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeReinLoad_Click_ERR



    Dim nd As Node
    Dim ID As Long
    
    Set nd = tvCats.SelectedItem
    
    
    
    ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    
    loadCatalog ID, , , , , ctRein
'    loadPartsGrid ID


Exit Sub

mnuCatsTreeReinLoad_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuCatsTreeReinLoad_Click - Error"

End Sub


Private Sub mnuCatsTreeRenameItem_Click()

    tvCats.StartLabelEdit

End Sub

Private Sub mnuCatsTreeSetList_Click()

    Dim nd As Node
    Dim ID As Long
    Dim catID As Long
    Dim IDold As Long
    
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    Dim ct As clsCat
    
    If left(nd.KEY, Len("catlist")) = "catlist" Then
        
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
        
        catID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", ID)
        IDold = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", catID)
        
        Set ct = cCats(CStr(catID))
        
        If updateTableInBase(cn_data, "i_catalog", "catlistID", ID, "catID", catID) Then
            Call writeOperationS(operModify, "catalog", catID, "назначен список " & nd.text)
            nd.Image = "catlist_def"
            Set nd = tvGetTreeNode(tvCats, "catlist" & IDold)
            If Not nd Is Nothing Then nd.Image = "catlist"
            ct.catListID = ID
        End If
        
    End If


End Sub

Private Sub mnuCatsTreeUnif_Click()

    Dim catID As Long
    
'    If usrCurrent.groupID > 1 Then Exit Sub
    If tvCats.SelectedItem Is Nothing Then Exit Sub
    
    catID = Val(right(tvCats.SelectedItem.KEY, Len(tvCats.SelectedItem.KEY) - Len("catalog")))

    If Not checkCatPerm(catID) Then Exit Sub
    If Not checkGroupPerm(usrCurrent.groupID, "catalog", operModify) Then Exit Sub
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))

    If mnuCatsTreeUnif.Checked Then
        If updateTableInBase(cn_data, "i_catalog", "catUnif", 0, "catID", catID) Then
            tvCats.SelectedItem.bOld = False
            mnuCatsTreeUnif.Checked = False
            ct.bUnif = False
            writeOperationS operModify, "catalog", catID, "не унифицированный"
        Else
        End If
    Else
        If updateTableInBase(cn_data, "i_catalog", "catUnif", 1, "catID", catID) Then
            tvCats.SelectedItem.bOld = True
            mnuCatsTreeUnif.Checked = True
            ct.bUnif = True
            writeOperationS operModify, "catalog", catID, "унифицированный"
        Else
        End If
    End If


End Sub


Private Sub mnuCatsTreePassive_Click()

    Dim clID As Long
    
    If tvCats.SelectedItem Is Nothing Then Exit Sub
    
    clID = Val(right(tvCats.SelectedItem.KEY, Len(tvCats.SelectedItem.KEY) - Len("catlist")))

    If mnuCatsTreePassive.Checked Then
        If updateTableInBase(cn_data, "catlist", "clPassive", 0, "catlistID", clID) Then
            tvCats.SelectedItem.bOld = False
            mnuCatsTreePassive.Checked = False
            writeOperationS operModify, "catlist", clID, "не пассивный"
        Else
        End If
    Else
        If updateTableInBase(cn_data, "catlist", "clPassive", 1, "catlistID", clID) Then
            tvCats.SelectedItem.bOld = True
            mnuCatsTreePassive.Checked = True
            writeOperationS operModify, "catlist", clID, "пассивный"
        Else
        End If
    End If


End Sub

'/******************************************************************************
Private Sub mnuCatsTreeUpdateCatlist_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeUpdateCatlist_Click_ERR

    Dim nd As Node
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then
        Exit Sub
    End If
    
    Dim cnt As Long
    
    Dim strCats As String
    Dim catID As Long

    Dim strSQL As String
    
    If lngCurCatListID = 0 Then Exit Sub

    Dim relID As Long
    Dim relIDmax As Long

    Dim i As Integer
    
    If nd.children > 0 Then
        Dim ndx As Node
        
        Dim RS As New ADODB.Recordset
        RS.Open "select max(relID) as relID from r_catlist_part", cn_data, adOpenStatic, adLockOptimistic
        If Not RS.EOF Then
            RS.MoveFirst
            relIDmax = RS.fields("relID").Value
        End If
        
        Set ndx = nd.Child.FirstSibling
        
        For i = 1 To nd.children
            If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
                catID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("catalog")))
                If cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein Then
                
'                    strSQL = strSQL & "," & catID
                
                    RS.NextRecordset
                    RS.Open "select * from r_catlist_part where partID = " & catID & " and catlistID = " & lngCurCatListID & " and objID = " & objs("catalog"), cn_data, adOpenStatic, adLockOptimistic

                    If RS.EOF Then
                        RS.AddNew
                        RS.fields("partQty").Value = 1#
                        RS.fields("partSortID").Value = relIDmax
                        RS.fields("catlistID").Value = lngCurCatListID
                        RS.fields("partID").Value = catID
                        RS.fields("objID").Value = objs("catalog")
                        RS.Update
                        cnt = cnt + 1
                        relIDmax = relIDmax + 1
                    End If
                    
                
                End If
            End If
            
            Set ndx = ndx.Next
        Next
    End If
    
    
    RS.Close
    Set RS = Nothing
    
    


    If cnt > 0 Then Call writeOperationS(operModify, "catlist", lngCurCatListID, "обновление арматурных подкаталогов")


    loadListGrid lngCurCatListID


Exit Sub

mnuCatsTreeUpdateCatlist_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeUpdateCatlist_Click - Error"

End Sub



'/******************************************************************************
Private Sub mnuCatsTreeUserSpecVal_Click(Index As Integer)
'/******************************************************************************

    On Error GoTo mnuCatsTreeUserSpecVal_Click_ERR


    Dim catID As Long
    
    catID = Val(mnuCatsTreeUserSpec.Tag)
    
    If catID = 0 Then Exit Sub
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))
    
    Dim specID As Long
    specID = Val(mnuCatsTreeUserSpecVal(Index).Tag)
    
    If updateTableInBase(cn_data, "i_catalog", "specID", specID, "catID", catID) Then
        ct.userspecID = specID
        
        Dim i As Integer
        For i = 0 To mnuCatsTreeUserSpecVal.Count - 1
'            If mnuCatsTreeUserSpecVal(i) Then
                mnuCatsTreeUserSpecVal(i).Checked = False
'            End If
        Next i
        
    End If



Exit Sub

mnuCatsTreeUserSpecVal_Click_ERR:
    If Not err.Number = 340 Then
        F1.SB.Panels("status").text = "mnuCatsTreeUserSpecVal_Click" & "() - " & err.Description
    End If

End Sub

Private Sub mnuHelpAbout_Click()

    Set frmSps = New frmSplash
    frmSps.lblStatus.top = 1700
    frmSps.lblStatus.Caption = "Правообладатель: Вибе Леонид, WLEO@ya.ru" & vbNewLine & "Разработка: ИМАПП, Санкт-Петербург, 2018"
    frmSps.Show 0, F1


End Sub

'/******************************************************************************
Private Sub mnuHelpNew_Click()
'/******************************************************************************

    On Error GoTo mnuHelpNew_Click_ERR


    
    
    Dim RS As New ADODB.Recordset
    RS.Open "select wnVers, wnDate, wnDescr  from whatsnew order by wndate desc", cn_srtm, adOpenStatic, adLockReadOnly
    
    If RS.EOF Then Exit Sub
    
    Load FLog
    
    
    Set FLog.fgLog.DataSource = RS
    
    FLog.fgLog.ColDataType(1) = flexDTDate
    FLog.fgLog.ColFormat(1) = "DD.MM.YYYY"
    
'    FLog.fgLog.AutoSize 1
    
    
    FLog.fgLog.ColAlignment(0) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(1) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(2) = flexAlignLeftCenter
    
    FLog.fgLog.TextMatrix(0, 0) = "Версия"
    FLog.fgLog.TextMatrix(0, 1) = "Дата"
    FLog.fgLog.TextMatrix(0, 2) = "Что нового"
    
    RS.Close
    Set RS = Nothing
    
    
    FLog.Caption = "Что нового"
    FLog.Show 1, Me
    

Exit Sub

mnuHelpNew_Click_ERR:
    Set RS = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuHelpNew_Click - Error"

End Sub

Private Sub mnuHelpUpdateSim_Click()

    On Error GoTo err
    
'    Dim res As Long
'
    Dim strPath As String
'    Dim strUser As String
'    Dim strPass As String
'    Dim strDomain As String

    strPath = "//vibe1.sp.spbaep.ru/install/AECOsim Building Designer/SS6/08.11.09.866 eng/Setup.exe"
    
    
    If FileExists(strPath) Then
    
        Shell strPath
        
    End If
'
err:
'
'    strDomain = Environ("USERDOMAIN")
'
'    If Trim(LCase(strDomain)) = "vnipiet" Then
'        strUser = "lib_registrar"
'        strPass = ""
'    ElseIf Trim(LCase(strDomain)) = "spbaep" Then
'        strUser = "Administrator"
'        strPass = ""
'    ElseIf Trim(LCase(strDomain)) = "sp" Then
'        strUser = "l_vibe"
'        strPass = ""
'    Else
'        strUser = ""
'        strPass = ""
'    End If
'
'    res = W2KRunAsUser(strUser, strPass, strDomain, strPath, CurDir)
'
'    If res > 0 Then MsgBox APIErrorDescription(res), vbCritical, ""

End Sub

Private Sub mnuHelpVideo_Click()
    
    On Error Resume Next
    
    If Len(strHelpPath) > 0 Then
        If Dir(strHelpPath, vbDirectory) = "" Then
        Else
            ShellExecute Me.hwnd, "explore", strHelpPath, strHelpPath, strHelpPath, 3 ' maximized
        End If
    End If
    
'    Shell "explorer.exe " & App.Path & "\hlp", vbNormalFocus
'    Shell "explorer.exe " & GetSetting("Offtake2", "Size", "HelpPath", App.Path), vbNormalFocus

End Sub


'/******************************************************************************
Public Sub listClear(ct As ctype, bReload As Boolean)
'/******************************************************************************

    On Error GoTo listClear_ERR

    Dim strSQL As String

    If lngCurCatListID = 0 Then Exit Sub


    strSQL = "delete from r_catlist_part where catlistID = " & lngCurCatListID
    If ct <> ctNone Then
        strSQL = strSQL & " and partID in "
        strSQL = strSQL & "("
'        If bOfftNew Then
        strSQL = strSQL & "select partID from gocatlist(" & lngCurCatListID & ")"
'        Else
'        strSQL = strSQL & "select partID from view_clist where catlistID = " & lngCurCatListID
'        End If
        strSQL = strSQL & " and catTypeID = " & ct
        strSQL = strSQL & ")"
    End If
    
    Dim iRA As Integer
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandText = strSQL
    cmd.Execute iRA
    
    Call writeOperationS(operModify, "catlist", lngCurCatListID, "полная очистка списка")


    If bReload Then loadListGrid lngCurCatListID


Exit Sub

listClear_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "listClear - Error"

End Sub


'/******************************************************************************
Private Sub mnuLabelCat_Click(Index As Integer)
'/******************************************************************************

    On Error GoTo mnuLabelCat_Click_ERR
    
    loadCatalog Val(mnuLabelCat(Index).Tag), False, , True, False


Exit Sub

mnuLabelCat_Click_ERR:
    F1.SB.Panels("status").text = "mnuLabelCat_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub mnuLabelCopy_Click()
'/******************************************************************************

    On Error GoTo mnuLabelCopy_Click_ERR

    
    Clipboard.Clear
'   Clipboard.SetText lblTvCatName.Caption, vbCFText
    SetUnicodeText lblCurCatName(Val(mnuLabelCopy.Tag)).Caption
        

Exit Sub

mnuLabelCopy_Click_ERR:
    F1.SB.Panels("status").text = "mnuLabelCopy_Click" & "() - " & err.Description

End Sub

Public Sub mnuListClear_Click()


    If bCatListIsBlocked Then Exit Sub


    listClear ctNone, True



End Sub

'/******************************************************************************
Private Sub mnuListCopy_Click()
'/******************************************************************************

    On Error GoTo mnuListCopy_Click_ERR



    lngCurCatListIDtoCopy = lngCurCatListID








Exit Sub

mnuListCopy_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuListCopy_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuListCreate_Click() ' UNUSED
'/******************************************************************************





Exit Sub

mnuListCreate_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuListCreate_Click - Error"

End Sub

Private Sub mnuListDelMarkedRows_Click()


    If bCatListIsBlocked Then Exit Sub
    
    If lngCurCatListID = 0 Then Exit Sub
    
        
    deleteMarkedListRows True
    
    DoListDepsUpdate
    



End Sub

Private Sub mnuListExit_Click()

    Unload Me

End Sub





'/******************************************************************************
Public Function getPartByID(prts As Collection, ID As Long) As clsPart
'/******************************************************************************

    On Error GoTo getPartByID_ERR

    
    Dim prt As clsPart
    
    
    For Each prt In prts
        If prt.partID = ID Then Set getPartByID = prt
        Exit Function
    Next prt
    
    Set getPartByID = Nothing

    

Exit Function

getPartByID_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "getPartByID - Error"

End Function


'/******************************************************************************
Private Sub mnuListGoHome_Click()
'/******************************************************************************

    On Error GoTo mnuListGoHome_Click_ERR

    Me.mnuListGoHome.Checked = Not Me.mnuListGoHome.Checked
    
    
'    If Me.mnuListGoHome.Checked Then
'    elList.Visible = False
'    Else
''    elExt.Visible = False
''    elMain.Visible = False
''    elList.Visible = False
''
''    elExt.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
''    elMain.Visible = True
'    elList.Visible = True
'    End If
'
'    elMain.Align = asFill
'    elMain.AutoSizeChildren = azEvenHorz
    
'    elMain.FreezeElastics = True

Exit Sub

mnuListGoHome_Click_ERR:
    F1.SB.Panels("status").text = "mnuListGoHome_Click" & "() - " & err.Description

End Sub





'/******************************************************************************
Private Sub mnuListLoadFromModelTags_Click()
'/******************************************************************************

    On Error GoTo mnuListLoadFromModelTags_Click_ERR


    Dim msapp As Object
    Set msapp = getMS
    If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub




    Load frmSrtmLoad
    frmSrtmLoad.mnuLoad.Visible = False
    frmSrtmLoad.FG.cols = 4
    frmSrtmLoad.FG.ColWidth(1) = 300
    frmSrtmLoad.FG.ColWidth(3) = 500
    frmSrtmLoad.FG.ColHidden(0) = True
    frmSrtmLoad.FG.ColHidden(3) = True
    frmSrtmLoad.FG.ColDataType(1) = flexDTBoolean
    frmSrtmLoad.InitTagProcess msapp
    frmSrtmLoad.Show

        Set msapp = Nothing

Exit Sub

mnuListLoadFromModelTags_Click_ERR:
        Set msapp = Nothing

    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuListLoadFromModelTags_Click - Error"

End Sub



'/******************************************************************************
Public Function addPart(Col As Collection, prt As clsPart) As Boolean
'/******************************************************************************

    On Error GoTo addPart_ERR

    Col.Add prt, UCase(prt.partName)


    addPart = True

Exit Function

addPart_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "addPart - Error"

End Function

'/******************************************************************************
Private Sub sortListInBaseProc()
'/******************************************************************************
    
    On Error GoTo sortListInBaseProc_ERR
    
    If lngCurCatListID = 0 Then Exit Sub
    
    If bCatListIsBlocked Then Exit Sub
    
    Dim raf As Integer
    
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandType = adCmdStoredProc
    
    cmd.CommandText = "seqq"
    cmd.Parameters.Append cmd.CreateParameter("clID", adBigInt, adParamInput, , lngCurCatListID)
    
    
    
    cmd.Execute raf
    
    
    
    Exit Sub
    
sortListInBaseProc_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "sortListInBaseProc - Error"
    
End Sub


Private Sub mnuListRowsBack_Click()

        If iListRemPos > 1 Then
            iListRemPos = iListRemPos - 1
            loadListGrid arListRem(iListRemPos), , , False
        End If


End Sub

'/******************************************************************************
Private Sub mnuListRowsDelete_Click()
'/******************************************************************************

    On Error GoTo mnuListRowsDelete_Click_ERR



        deleteMarkedListRows False
        
        DoListDepsUpdate


Exit Sub

mnuListRowsDelete_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuListRowsDelete_Click - Error"

End Sub

Private Sub mnuListRowsFwd_Click()

        If iListRemPos < UBound(arListRem) Then
            iListRemPos = iListRemPos + 1
            loadListGrid arListRem(iListRemPos), , , False
        End If


End Sub

'/******************************************************************************
Private Sub mnuListRowsGo_Click()
'/******************************************************************************

    On Error GoTo mnuListRowsGo_Click_ERR


    goToPartFromList Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("objID"))), Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("partID"))), Val(fgList.TextMatrix(fgList.Row, fgList.ColIndex("catID")))


Exit Sub

mnuListRowsGo_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuListRowsGo_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuListSaveExcel_Click()
'/******************************************************************************

    On Error GoTo mnuListSaveExcel_Click_ERR


    Dim sFileName As String
    
    Dim OFN As OPENFILENAME
    OFN.lStructSize = Len(OFN)
    OFN.hWndOwner = Me.hwnd
    OFN.hInstance = App.hInstance
    OFN.lpstrFilter = "Excel Files (*.xls)" + Chr$(0) + "*.xls" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    OFN.lpstrFile = Space$(254)
    OFN.nMaxFile = 255
    OFN.lpstrFileTitle = Space$(254)
    OFN.nMaxFileTitle = 255
    OFN.lpstrInitialDir = CurDir
    OFN.lpstrTitle = "Сохранить файл"
    OFN.flags = 0
    Dim a
    a = GetSaveFileName(OFN)
    If (a) Then
        sFileName = LCase(Trim$(OFN.lpstrFile))
    Else
        Exit Sub
    End If
    
    If Asc(right(sFileName, 1)) = 0 Then sFileName = left(sFileName, Len(sFileName) - 1)
    
    If Not right(sFileName, 4) = ".xls" Then
        sFileName = sFileName & ".xls"
    End If
    
    Me.fgList.ColHidden(fgList.ColIndex("m")) = True

    Me.fgList.SaveGrid sFileName, flexFileExcel

    Me.fgList.ColHidden(fgList.ColIndex("m")) = False

Exit Sub

mnuListSaveExcel_Click_ERR:
    Me.fgList.ColHidden(fgList.ColIndex("m")) = False
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuListSaveExcel_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuListSort_Click()
'/******************************************************************************

    On Error GoTo mnuListSort_Click_ERR

    If bCatListIsBlocked Then Exit Sub

    If lngCurCatListID = 0 Then Exit Sub


    If lngCurCatListProjID > 0 Then
        Dim o As colAts
        For Each o In listcfg
            If o.atname = "Sort" Then
                If Val(o.attval("projectID")) = lngCurCatListProjID Then
    If MsgBox("Будет выполнена честная сортировка списка без учета специфики проекта, продолжаем?", vbYesNo, "") = vbNo Then Exit Sub
                End If
            End If
        Next
    End If




    sortListInBaseProc
    
    loadListGrid lngCurCatListID
    
    Call writeOperationS(operModify, "catlist", lngCurCatListID, "сортировка")
    


Exit Sub

mnuListSort_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuListSort_Click - Error"

End Sub

Private Sub mnuListSortAuto_Click()
    mnuListSortAuto.Checked = Not mnuListSortAuto.Checked
End Sub

Private Sub mnuListSyncLoad_Click()
    mnuListSyncLoad.Checked = Not mnuListSyncLoad.Checked
End Sub

Private Sub mnuListSyncList_Click()
    mnuListSyncList.Checked = Not mnuListSyncList.Checked
End Sub


'/******************************************************************************
Private Sub mnuOfftMassLevel_Click(Index As Integer)
'/******************************************************************************

    On Error GoTo mnuOfftMassLevel_Click_ERR



    
    Dim pd As clsPD
    
    Set pd = globPosdefs(mnuOfftMassLevel(Index).Tag)
    
    If pd.iMassLevel = 0 Then
        pd.iMassLevel = 1
    Else
        pd.iMassLevel = 0
    End If
    
    

    mnuOfftMassLevel(Index).Checked = Not mnuOfftMassLevel(Index).Checked

Exit Sub

mnuOfftMassLevel_Click_ERR:
    F1.SB.Panels("status").text = "mnuOfftMassLevel_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub mnuPartsTreeCopy_Click()
'/******************************************************************************
    
    On Error GoTo mnuPartsTreeCopy_Click_ERR
    
    Dim i As Long
'    Dim ID As Long
'    Dim n As Node
    
    
'    Dim nd As Node
    Dim iCount As Long
    
    iCopyPartsCount = 0
    iCount = 0
    
    If colParts.Count = 0 Then Exit Sub
    
    Dim prt As clsPart
    
    For Each prt In colParts
    
        
            iCount = iCount + 1
            
'            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
            
            ReDim Preserve arCopyParts(1 To iCount)

            arCopyParts(iCount) = prt.partID
            
    Next
    
    

    
    
'    If iCount = 0 Then
'
'        Set n = tvParts.SelectedItem
'
'        If n Is Nothing Then Exit Sub
'
'        If LCase(left(n.KEY, Len("part"))) = "part" Then
'
'            ID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
'
'            iCount = 1
'
'            ReDim arCopyParts(1 To 1)
'
'            arCopyParts(1) = ID
'
'        End If
'
'    End If
    
    
    iCopyPartsCount = iCount
    
    
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    
    
    Exit Sub
    
mnuPartsTreeCopy_Click_ERR:
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuPartsTreeCopy_Click - Error"
    
End Sub


'/******************************************************************************
Private Sub mnuPartsTreeCopyHere_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeCopyHere_Click_ERR


    mnuPartsTreeCopy_Click

    Dim i As Long
    Dim part As clsPart
    Dim ID As Long
    Dim nd As Node
    
  

    Me.MousePointer = 11
    
    For i = 1 To iCopyPartsCount
    
        ID = arCopyParts(i)
        
        Set part = New clsPart
        
        part.setIDv2 ID, True, True, True
        
        part.partName = part.partName & " (копия)"
        part.setCat lngCurCatID
        part.partIDold = part.partID
        part.partID = 0 ' обнуляем так как новая
        part.part_prntID = 0
        part.partVers = ""
        part.partStatusID = pst.pstRazrabotka
        part.savePart , True   ' получен новый partID
        
        ' перегружаем позиции, так как их Key не совпадают с их ID
        part.setIDv2 part.partID, True, True, True
        
        Set nd = tvParts.Nodes.Add("part" & ID, tvwNext, "part" & part.partID, part.partName, "part0")
        
    
    Next i
    
    Me.MousePointer = 0
    
    iCopyPartsCount = 0
    
    Set tvParts.SelectedItem = nd
    tvParts_NodeClick nd
    
    Set curPart = part
    
    If iCopyPartsCount = 1 Then tvParts.StartLabelEdit
    
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    


Exit Sub

mnuPartsTreeCopyHere_Click_ERR:
    Me.MousePointer = 0
    SB.Panels("partqty").text = "Копируется изделий: " & iCopyPartsCount & "  "
    Me.SB.Panels("partqty").AutoSize = sbrContents
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuPartsTreeCopyHere_Click - Error"

End Sub

'/******************************************************************************
Private Function partsRecycle(strPartIDs As String, strLinkIDs As String) As Boolean
'/******************************************************************************
    
    On Error GoTo partsRecycle_ERR
    
    Dim iRA As Integer
    Dim cmd As New ADODB.Command
            
    If Len(strLinkIDs) > 0 Then
    
        cmd.ActiveConnection = cn_data
        cmd.CommandText = "DELETE FROM [r_catalog_part] WHERE relID IN (" & strLinkIDs & ")"
        cmd.Execute iRA
        
        
    End If
    
    If Len(strPartIDs) > 0 Then
        
        cmd.ActiveConnection = cn_data
        cmd.CommandText = "UPDATE [part] SET [deleted] = 1 WHERE partID IN (" & strPartIDs & ")"
        cmd.Execute iRA
        
    End If
            
    partsRecycle = True
    
    Exit Function
    
partsRecycle_ERR:
    partsRecycle = False
    
End Function


'/******************************************************************************
Private Sub mnuPartsTreeDelete_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeDelete_Click_ERR

    
    
'    Dim ID As Long
'    Dim nd As Node
'    Dim bLink As Boolean
    
'    Set nd = tvParts.SelectedItem
'
'    If nd Is Nothing Then Exit Sub
    
    Dim bOk As Boolean
    
    
    If colParts.Count = 0 Then Exit Sub
    
    Dim prt As clsPart
    
    Set prt = colParts(1)
'
'
'    If prt.bIsLink Then
'        ID = CLng(nd.Tag)
'        bLink = True
'    ElseIf nd.Image = "part2" Then ' архив
'        Exit Sub
'    Else
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
'        bLink = False
'    End If
'

    
    
    If prt.partID > 0 And prt.bIsLink Then
        Dim relID As Long
        relID = selectLongFromBase(cn_data, "r_catalog_part", "relID", "partID", prt.partID, "catID", lngCurCatID)
        If relID > 0 Then
            bOk = partsRecycle("", CStr(relID))
        End If
    End If
    If prt.partID > 0 And Not prt.bIsLink Then bOk = partsRecycle(CStr(prt.partID), "")
    
    If bOk Then
        tvParts.Nodes.Remove "part" & prt.partID
    End If
    
        
    If Not tvParts.SelectedItem Is Nothing Then tvParts_NodeClick tvParts.SelectedItem
    
    
    
    
Exit Sub

mnuPartsTreeDelete_Click_ERR:
    F1.SB.Panels("status").text = "mnuPartsTreeDelete_Click" & "() - " & err.Description

End Sub


'/******************************************************************************
Private Sub mnuPartsTreeDeleteChecked_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeDeleteChecked_Click_ERR



    Dim strPartIDs As String
    Dim strLinkIDs As String
    
    
'    Dim items As New Collection
    Dim Keys As New Collection

'    For Each nd In tvParts.Nodes
'
'        If LCase(left(nd.KEY, Len("part"))) = "part" And nd.Checked Then
'            items.Add nd
'        End If
'
'    Next nd
    
'    If items.Count = 0 Then Exit Sub
    If colParts.Count = 0 Then Exit Sub
        
    Dim prt As clsPart
    
    For Each prt In colParts

        If prt.bIsLink Then
            If Len(strLinkIDs) > 0 Then strLinkIDs = strLinkIDs & ","
            strLinkIDs = strLinkIDs & prt.part_prntID ' link id
            Keys.Add "part" & prt.partID
        ElseIf prt.partStatusID = pst.pstArchive Then  ' архив
            ' пропускаем
        Else
            If Len(strPartIDs) > 0 Then strPartIDs = strPartIDs & ","
            strPartIDs = strPartIDs & prt.partID
            Keys.Add "part" & prt.partID
        End If
    
    Next prt
    
    
    
    If partsRecycle(strPartIDs, strLinkIDs) Then
    
        Dim strKey As String
        
        Dim i As Integer
        
        For i = 1 To Keys.Count
            strKey = Keys(i)
            tvParts.Nodes.Remove strKey
        Next i
    
    End If
    
    
    If Not tvParts.SelectedItem Is Nothing Then tvParts_NodeClick tvParts.SelectedItem
    
    
    Set Keys = Nothing



Exit Sub

mnuPartsTreeDeleteChecked_Click_ERR:
    F1.SB.Panels("status").text = "mnuPartsTreeDeleteChecked_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Public Function erasePart(cnxn As ADODB.Connection, partID As Long, bMes As Boolean, Optional partName As String = "") As Boolean
'/******************************************************************************
    
    On Error GoTo erasePart_ERR
    
    If partID = 0 Then Exit Function
    
    Dim posIDs() As Long
    Dim posIDsCount As Integer
    Dim arRecAf(1 To 8) As Integer
    Dim arRecAfPos(1 To 8) As Integer
    Dim iUserCnt As Integer
    Dim iCatListCnt As Integer
    Dim RS As New ADODB.Recordset
    
    erasePart = False
    
    
    RS.Open "select posID from position where partID = " & partID, cnxn, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            
            posIDsCount = posIDsCount + 1
            
            ReDim Preserve posIDs(1 To posIDsCount)
            posIDs(posIDsCount) = RS.fields("posID").Value
            
            
            RS.MoveNext
        Loop Until RS.EOF
        
    End If
    
'    RS.NextRecordset
'    RS.Open "select count(*) as cnt from usrlist where partID = " & partID & " group by usrID"
'    If Not RS.EOF Then
'        iUserCnt = RS.Fields("cnt").Value
'    End If
    
    RS.NextRecordset
    RS.Open "select count(*) as cnt from r_catlist_part where partID = " & partID & " group by catlistID"
    If Not RS.EOF Then
        iCatListCnt = RS.fields("cnt").Value
    End If
    
    RS.Close
    Set RS = Nothing
    
    cnxn.BeginTrans
    
    Dim cmd As New ADODB.Command
    Dim iRecordsAffected As Integer
    cmd.ActiveConnection = cnxn
    
    cmd.CommandText = "delete from [part] where partID = " & partID
    cmd.Execute arRecAf(1)
    
    cmd.CommandText = "delete from [position] where partID = " & partID
    cmd.Execute arRecAf(2)
    
'    cmd.CommandText = "delete from [usrlist] where partID = " & partID
'    cmd.Execute arRecAf(3)
    
    cmd.CommandText = "delete from [r_catlist_part] where partID = " & partID
    cmd.Execute arRecAf(4)
    
    cmd.CommandText = "delete from [r_catalog_part] where partID = " & partID
    cmd.Execute arRecAf(5)
    
    cmd.CommandText = "delete from [operationslog] where objID = " & objs("part") & " and objectID = " & partID
    cmd.Execute arRecAf(6)
    
    Dim i As Integer
    
    For i = 1 To posIDsCount
        cmd.CommandText = "delete from [r_position_property] where posID = " & posIDs(i)
        cmd.Execute arRecAfPos(7)
        arRecAf(7) = arRecAf(7) + arRecAfPos(7)
        
        cmd.CommandText = "delete from [operationslog] where objID = " & objs("position") & " and objectID = " & posIDs(i)
        cmd.Execute arRecAfPos(8)
        arRecAf(8) = arRecAf(8) + arRecAfPos(8)
    Next i
    
    
    If bMes Then
        
        Dim strMes As String
        
        strMes = "Будет удалено для " & partName & ":" & vbNewLine
        
        If arRecAf(1) > 0 Then
            strMes = strMes & "- записей из таблицы изделий: " & arRecAf(1) & vbNewLine
        End If
        If arRecAf(2) > 0 Then
            strMes = strMes & "- записей из таблицы позиций: " & arRecAf(2) & vbNewLine
        End If
        If arRecAf(3) > 0 Then
            strMes = strMes & "- записей из таблицы списков пользователей: " & arRecAf(3) & vbNewLine
            strMes = strMes & vbTab & "затронет пользователей: " & iUserCnt & vbNewLine
        End If
        If arRecAf(4) > 0 Then
            strMes = strMes & "- записей из таблицы списков каталогов: " & arRecAf(4) & vbNewLine
            strMes = strMes & vbTab & "затронет списков: " & iCatListCnt & vbNewLine
        End If
        If arRecAf(5) > 0 Then
            strMes = strMes & "- записей из таблицы ссылок: " & arRecAf(5) & vbNewLine
        End If
        If arRecAf(6) > 0 Then
            strMes = strMes & "- записей из таблицы лога операций для изделий: " & arRecAf(6) & vbNewLine
        End If
        If arRecAf(7) > 0 Then
            strMes = strMes & "- записей из таблицы свойств позиций: " & arRecAf(7) & vbNewLine
        End If
        If arRecAf(8) > 0 Then
            strMes = strMes & "- записей из таблицы лога операций для позиций: " & arRecAf(8) & vbNewLine
        End If
        
        strMes = strMes & "Удалить записи из базы данных без возможности восстановления?"
        
        
        If MsgBox(strMes, vbYesNo, "Подтверждение") = vbYes Then
            cnxn.CommitTrans
            erasePart = True
        Else
            cnxn.RollbackTrans
        End If
    Else
        cnxn.CommitTrans
        erasePart = True
    End If
    
    
    
    
    Exit Function
    
erasePart_ERR:

    If Not RS Is Nothing Then
        If RS.State = adStateOpen Then RS.Close
    End If
    Set RS = Nothing

    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "erasePart - Error"
    
End Function


'/******************************************************************************
Private Sub mnuPartsTreeDocSet_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeDocSet_Click_ERR



    Dim i As Long
    Dim n As Node
    Dim sIDs As String
    Dim bNoCheck As Boolean
    Dim cnt As Long
    Dim iPartListID As Long
    Dim iDrawingsID As Long
    
    
    If colParts.Count = 0 Then Exit Sub
    
    Dim prt As clsPart
    
    
    For Each prt In colParts
        
'        Set n = tvParts.Nodes(I)
        
'        If n.Checked Then
            
'            If LCase(left(n.KEY, Len("part"))) = "part" And Not n.Image = "link" Then
                
'                Dim prt As New clsPart
'                prt.partID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
                
                If Len(sIDs) > 0 Then sIDs = sIDs & ","
                sIDs = sIDs & CStr(prt.partID)
                
                cnt = cnt + 1
                
'                Set prt = Nothing
                
'            End If
'
'        End If
        
    Next prt
    
    
'    If Len(sIDs) = 0 Then
'        Set n = tvParts.SelectedItem
'        If Not n Is Nothing Then
'            If LCase(left(n.KEY, Len("part"))) = "part" And Not n.Image = "link" Then
'                sIDs = right(n.KEY, Len(n.KEY) - Len("part"))
'                cnt = 1
'            End If
'        End If
'        bNoCheck = True
'    End If
    
    
'    If Len(sIDs) = 0 Then
'        MsgBox "   Для выполнения команды выделите детали   "
'        Exit Sub
'    End If
    
    Dim frm As New frmDocSet
'    frm.setIDs
    frm.Show 1, Me
    
    If frm.bOk Then
    
        iPartListID = frm.iPartListID
        iDrawingsID = frm.iDrawingsID

        Dim cmd As New ADODB.Command
        Dim iRecordsAffected As Integer
        cmd.ActiveConnection = cn_data

        If iPartListID >= 0 Then
            cmd.CommandText = "update [part] set [dsPartListID] = " & iPartListID & " where partID in (" & sIDs & ")"
            cmd.Execute iRecordsAffected
        End If

        If iDrawingsID >= 0 Then
            cmd.CommandText = "update [part] set [dsDrawingsID] = " & iDrawingsID & " where partID in (" & sIDs & ")"
            cmd.Execute iRecordsAffected
        End If
    
        Set frm = Nothing
        Exit Sub
    Else
        Set frm = Nothing
    End If
    
    
    
    


Exit Sub

mnuPartsTreeDocSet_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuPartsTreeDocSet_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuPartsTreeErase_Click()
'/******************************************************************************
    
    On Error GoTo mnuPartsTreeErase_Click_ERR
    
    If colParts.Count <> 1 Then Exit Sub
    Dim prt As clsPart
    Set prt = colParts(1)
    
    Dim cnxn As New ADODB.Connection
    cnxn.Open cn_data.ConnectionString, "so2user", "so2user"
    
'    Dim nd As Node
'    Dim partID As Long
'
'    Set nd = tvParts.SelectedItem
'
'    If nd Is Nothing Then Exit Sub
'
'    If LCase(left(nd.KEY, Len("part"))) = "part" Then
'        partID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
'    End If
    
    If erasePart(cnxn, prt.partID, True, prt.partName) Then
        tvParts.Nodes.Remove "part" & prt.partID
        loadListGrid lngCurCatListID
    End If
    
    cnxn.Close
    Set cnxn = Nothing
    
    
    Exit Sub
    
mnuPartsTreeErase_Click_ERR:

    
    If Not cnxn Is Nothing Then
        If cnxn.State = adStateOpen Then cnxn.Close
    End If
    Set cnxn = Nothing
    
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuPartsTreeErase_Click - Error"
    
End Sub

'/******************************************************************************
Private Sub mnuPartsTreeEraseAll_Click()
'/******************************************************************************
    
    On Error GoTo mnuPartsTreeEraseAll_Click_ERR
    
    
    
    Dim nd As Node
    Dim partID As Long
    Dim items As New Collection
    Dim cnt As Long
    
    For Each nd In tvParts.Nodes
        items.Add nd
    Next nd
    
    If items.Count = 0 Then Exit Sub
    
    Me.PB.Min = 0
    Me.PB.Max = items.Count
    
    Me.tvParts.Refresh
    
    Dim cnxn As New ADODB.Connection
    cnxn.Open cn_data.ConnectionString, "so2user", "so2user"
    
    For Each nd In items
        partID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
        If partID > 0 Then
            If erasePart(cnxn, partID, False) Then
'                tvParts.Nodes.Remove nd.Key
            End If
        End If
        cnt = cnt + 1
        Me.PB.Value = cnt
        Me.PB.Refresh
    Next nd
    
    Me.PB.Value = 0
    
    cnxn.Close
    Set cnxn = Nothing
    
'    loadPartsTree lngCurCatID
    loadCatalog lngCurCatID, , , , , ctEmb
    
    Set items = Nothing
    
    
    Exit Sub
    
mnuPartsTreeEraseAll_Click_ERR:
    Me.PB.Value = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuPartsTreeEraseAll_Click - Error"
    
End Sub

'/******************************************************************************
Public Function uploadFileToTable(cnf As ADODB.Connection, strFileName As String, sTable As String, sIDname As String, sFileFieldName As String, ID As Long) As Boolean
'/******************************************************************************

    On Error GoTo loadFile_ERR

    Dim ar() As String
    ar = Split(strFileName, ".")
    
    If FileLen(strFileName) > 5000000 Then
        MsgBox "Файл слишком большой, операция не выполнена"
        Exit Function
    End If

    Dim RS As New ADODB.Recordset
    RS.Open "Select * from " & sTable & " where " & sIDname & " = " & ID, cnf, adOpenKeyset, adLockOptimistic
    
    If RS.EOF Then RS.AddNew Else RS.MoveFirst
    
    
    Dim mstream As New ADODB.Stream
    mstream.Type = adTypeBinary
    mstream.Open
    mstream.LoadFromFile strFileName
    RS.fields(sFileFieldName).Value = mstream.Read
'    RS.Fields(sIDname).Value = ID
    RS.Update
    
    RS.Close
    Set RS = Nothing

    uploadFileToTable = True


Exit Function

loadFile_ERR:
    uploadFileToTable = False
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadFile - Error"

End Function




'/******************************************************************************
Public Function uploadPartFile(cnf As ADODB.Connection, strFileName As String, partID As Long) As Boolean
'/******************************************************************************

    On Error GoTo loadFile_ERR

    Dim ar() As String
    ar = Split(strFileName, ".")
    
    If FileLen(strFileName) > 5000000 Then
        MsgBox "Файл слишком большой, операция не выполнена"
        Exit Function
    End If

    Dim RS As New ADODB.Recordset
    RS.Open "Select * from r_part_file where partID = " & partID, cnf, adOpenKeyset, adLockOptimistic
    
    If RS.EOF Then RS.AddNew Else RS.MoveFirst
    
    
    Dim mstream As New ADODB.Stream
    mstream.Type = adTypeBinary
    mstream.Open
    mstream.LoadFromFile strFileName
    RS.fields("pfData").Value = mstream.Read
    RS.fields("pfExt").Value = UCase(ar(UBound(ar)))
    RS.fields("partDB").Value = conn.strBaseName
    RS.fields("partID").Value = partID
    RS.Update
    
    RS.Close
    Set RS = Nothing

    uploadPartFile = True


Exit Function

loadFile_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadFile - Error"

End Function





'/******************************************************************************
Private Sub mnuPartsTreeFile_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeFile_Click_ERR

'    Dim ID As Long
'    Dim nd As Node
    

'    Set nd = tvParts.SelectedItem

    If colParts.Count <> 1 Then Exit Sub
    
    Dim prt As clsPart
    
    Set prt = colParts(1)
    
'    If LCase(left(nd.KEY, Len("part"))) = "part" Then
'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
'    Else
'        Exit Sub
'    End If
'
'
'    If ID = 0 Then Exit Sub



    Dim OFN As OPENFILENAME
    Dim strFileName As String
    
    OFN.lStructSize = Len(OFN)
    OFN.hWndOwner = Me.hwnd
    OFN.hInstance = App.hInstance
    OFN.lpstrFilter = "PDF Files (*.pdf)" + Chr$(0) + "*.pdf" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    OFN.lpstrFile = Space$(254)
    OFN.nMaxFile = 255
    
    OFN.lpstrFileTitle = Space$(254)
    OFN.nMaxFileTitle = 255
    OFN.lpstrInitialDir = CurDir
    OFN.lpstrTitle = "Открываем файл"
    OFN.flags = 0
    
    Dim a
    a = GetOpenFileName(OFN)
    If (a) Then
        strFileName = Trim$(OFN.lpstrFile)
        If right(strFileName, 1) = Chr(0) Then strFileName = left(strFileName, Len(strFileName) - 1)
    Else
        Exit Sub
    End If
    
    
    Dim cnf As New ADODB.Connection
    cnf.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=15;User ID=" & conn.strUser & ";Initial Catalog=docs;Data Source=" & conn.strServerName, conn.strUser, conn.strPass
    
    If uploadPartFile(cnf, strFileName, prt.partID) Then
        writeOperationS operModify, "part", prt.partID, "загрузка изображения для " & prt.partName
        MsgBox "   Файл для " & prt.partName & " загружен.   "
    End If

    cnf.Close
    Set cnf = Nothing
    

Exit Sub

mnuPartsTreeFile_Click_ERR:
    Set cnf = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuPartsTreeFile_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuPartsTreeGoLink_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeGoLink_Click_ERR



    Dim partID As Long
    Dim catID As Long
    Dim nd As Node
    
'    Set nd = tvParts.SelectedItem
'
'    If nd Is Nothing Then Exit Sub
'
'    If Not LCase(left(nd.KEY, Len("part"))) = "part" Then Exit Sub
'
'    If Val(nd.Tag) = 0 Then Exit Sub ' only for links

    If colParts.Count = 0 Then Exit Sub
    
    Dim prt As clsPart
    
    Set prt = colParts(1)
    
'    partID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
    partID = prt.partID

    catID = selectLongFromBase(cn_data, "part", "catID", "partID", partID)
    
    loadCatalog catID, False, partID, True, False ' каталог не перегружать, изд. выделить, вкладку активировать, список не перегружать

Exit Sub

mnuPartsTreeGoLink_Click_ERR:
    F1.SB.Panels("status").text = "mnuPartsTreeGoLink_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub mnuPartsTreeNoParent_Click()
'/******************************************************************************
    
    On Error GoTo mnuPartsTreeNoParent_Click_ERR
    
    Dim nd As Node
    Dim ndNew As Node
    Dim ID As Long
    
    Dim pk As String
    Dim k As String
    Dim t As String
    Dim im As String
    
    Set nd = tvParts.SelectedItem
    
    If LCase(left(nd.KEY, Len("part"))) = "part" Then
        
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
        
        pk = nd.parent.KEY
        k = nd.KEY
        t = nd.text
        im = CStr(nd.Image)
        
        If updateTableInBase(cn_data, "part", "parentID", 0, "partID", ID) Then
        
            tvParts.Nodes.Remove nd.KEY
            
            If addTreeNode(tvParts, ndNew, pk, tvwNext, k, t, im) Then
                
                ndNew.bOld = True
                tvParts.SelectedItem = ndNew
                
            End If
            
            Call writeOperationS(operModify, "part", ID, "снятие зависимости " & nd.text)
            
        End If
        
        
        
    End If
    
    
    
    Exit Sub
    
mnuPartsTreeNoParent_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuPartsTreeNoParent_Click - Error"
    
End Sub

'/******************************************************************************
Private Sub mnuPartsTreeRestore_Click()
'/******************************************************************************

    On Error GoTo mnuPartsTreeRestore_Click_ERR


'    Dim nd As Node
'    Dim RS As New ADODB.Recordset
'    Dim ID As Long
'
'    Set nd = tvParts.SelectedItem
'
'    If nd Is Nothing Then Exit Sub

    If colParts.Count <> 1 Then Exit Sub
    
    Dim prt As clsPart
    
    Set prt = colParts(1)


'    If LCase(left(nd.KEY, Len("part"))) = "part" Then

'        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
        
        If updateTableInBase(cn_data, "part", "deleted", 0, "partID", prt.partID) Then
            tvParts.Nodes.Remove "part" & prt.partID
            tvParts_NodeClick tvParts.SelectedItem
            writeOperationS operRestore, "part", prt.partID, "восстановление " & prt.partName
        Else
        End If


'    End If
    





Exit Sub

mnuPartsTreeRestore_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuPartsTreeRestore_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuPartsTreeStatusVal_Click(Index As Integer)
'/******************************************************************************
    
    On Error GoTo mnuPartsTreeStatusVal_Click_ERR
    
    
    Dim i As Long
    Dim n As Node
    Dim sIDs As String
    Dim bNoCheck As Boolean
    
    
    If colParts.Count = 0 Then Exit Sub
    
    Dim prt As clsPart
    
    For Each prt In colParts
        
'        Set n = tvParts.Nodes(I)
'
'        If n.Checked Then
'
'            If LCase(left(n.KEY, Len("part"))) = "part" And Not n.Image = "link" Then
'
'                Dim prt As New clsPart
'                prt.partID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
                
                If Len(sIDs) > 0 Then sIDs = sIDs & ","
                sIDs = sIDs & CStr(prt.partID)
                
'                Set prt = Nothing
'
'            End If
'
'        End If
        
    Next prt
    
    
'    If Len(sIDs) = 0 Then
'        Set n = tvParts.SelectedItem
'        If Not n Is Nothing Then
'            If LCase(left(n.KEY, Len("part"))) = "part" And Not n.Image = "link" Then
'                sIDs = right(n.KEY, Len(n.KEY) - Len("part"))
'            End If
'        End If
'        bNoCheck = True
'    End If
    
    
'    If Len(sIDs) = 0 Then
'        MsgBox "   Ничего не изменено, для выполнения команды выделите детали   "
'        Exit Sub
'    End If
    
    Dim cmd As New ADODB.Command
    Dim iRecordsAffected As Integer
    cmd.ActiveConnection = cn_data
    cmd.CommandText = "update [part] set [partStatusID] = " & Index & " where partID in (" & sIDs & ")"
    cmd.Execute iRecordsAffected
    
    If iRecordsAffected = 0 Then err.Raise 100, , "No parts updated"
    
'    If bNoCheck Then
'        n.Image = "part" & CStr(Index)
'        Exit Sub
'    End If
    
    
    For Each prt In colParts
        
'        Set n = tvParts.Nodes(I)
'
'        If n.Checked Then
'            If LCase(left(n.KEY, Len("part"))) = "part" And Not n.Image = "link" Then
'                n.Image = "part" & CStr(Index)
'            End If
'
'        End If

        If Not prt.bIsLink Then
        
            Set n = tvGetTreeNode(tvParts, "part" & prt.partID)
            
            If Not n Is Nothing Then
                n.Image = "part" & CStr(Index)
            End If
        
        End If
        
    Next prt
    
    
    
'    MsgBox "   Статус изменен у " & iRecordsAffected & " деталей   "
    
    
    Exit Sub
    
mnuPartsTreeStatusVal_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuPartsTreeStatusVal_Click - Error"
    
End Sub

'/******************************************************************************
Private Sub mnuPositionsMC_Click(Index As Integer)
'/******************************************************************************

    On Error GoTo mnuPositionsMC_Click_ERR

    
    
    Dim posID As Long
    Dim pos As clsPos
    Dim Row As Long
    Dim t As Long
    
    Row = fgPositions.Tag
    
    posID = Val(fgPositions.TextMatrix(Row, 4))
    t = Val(mnuPositionsMC(Index).Tag)
    
    If posID = 0 Then Exit Sub
    If t = 0 Then Exit Sub
    
    Set pos = curPart.ps(CStr(posID))
    
    Dim bUpd As Boolean
    
    
    
    If Val(mnuPositions.Tag) = 1 Then
    
        If t = -1 Then ' удаление
            
            Dim cmd As New ADODB.Command
            Dim iRecordsAffected As Integer
            cmd.ActiveConnection = cn_data
            cmd.CommandText = "delete from " & pos.POS_SRC_TABLE & " where posID = " & posID
            cmd.Execute iRecordsAffected
            
            If iRecordsAffected = 1 Then
                
                curPart.ps.Remove CStr(posID)
                
                Do While Val(fgPositions.TextMatrix(Row, 4)) = posID
                    fgPositions.RemoveItem Row
                Loop
                
                curPart.updatePosNumbersInBase True
                curPart.updateMasses
                
            Else
                MsgBox "   Ошибка при удалении   ", vbCritical, "Ошибка"
            End If
            
        Else
            
            pos.POS_MCALC = t  ' masscalc ID
            
            pos.updatePosRow Row, bUpd, True, True, True, True
            
            pos.savePos
            
        End If
        
    ElseIf Val(mnuPositions.Tag) = 2 Then
    
        Dim prntRow As Long
        Dim i As Long
        
        For i = Row To 1 Step -1
            If fgPositions.RowHeight(i) = 480 Then
                prntRow = i
                Exit For
            End If
        Next i
        
        If prntRow < 1 Then Exit Sub
    
        Dim p As New clsProp
        
        If p.loadByPropID(Val(mnuPositionsMC(Index).Tag)) Then
            Set p = p.fromExisting(p.propName)
            Set p.parentPos = pos
        Else
            Exit Sub
        End If
        
        If mnuPositionsMC(Index).Checked Then
        
            pos.pos_props.Remove p.propName
        
        Else
        
            p.bAddedByUser = True
            pos.pos_props.AddNewProp p
            
            Set p = Nothing
            
        End If
        
        pos.updatePosRow prntRow, bUpd, True, False, False, False
    
    Else
    
    End If
    
    
    
    
    
    
    
Exit Sub

mnuPositionsMC_Click_ERR:
    F1.SB.Panels("status").text = "mnuPositionsMC_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub mnuSrtmLoad_Click()
'/******************************************************************************

    On Error GoTo mnuSrtmLoad_Click_ERR

    
    
    
    Dim f As New frmSrtmLoad
    
    
    
    Dim OFN As OPENFILENAME
    Dim strFileName As String
    Dim strFN As String
    
    OFN.lStructSize = Len(OFN)
    OFN.hWndOwner = F1.hwnd
    OFN.hInstance = App.hInstance
    OFN.lpstrFilter = "CSV Files (*.csv)" + Chr$(0) + "*.csv" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    OFN.lpstrFile = Space$(254)
    OFN.nMaxFile = 255
    
    OFN.lpstrFileTitle = Space$(254)
    OFN.nMaxFileTitle = 255
    OFN.lpstrInitialDir = CurDir
    OFN.lpstrTitle = "Открываем файл"
    OFN.flags = 0
    Dim a
    a = GetOpenFileName(OFN)
    If (a) Then
        strFileName = Trim$(OFN.lpstrFile)
        If right(strFileName, 1) = Chr(0) Then strFileName = left(strFileName, Len(strFileName) - 1)
    Else
        Exit Sub
    End If
    
    Dim ar() As String
    ar = Split(strFileName, "\", , vbTextCompare)
    strFN = ar(UBound(ar))
    strFN = Replace(strFN, ".csv", "", , , vbTextCompare)
    
    
    
    f.FG.ClipSeparators = ";" & vbCr
    
    
    f.FG.loadGrid strFileName, flexFileCustomText
    f.FG.AutoSize 0, f.FG.cols - 1, , "   "
    
    
    
    f.strFileName = strFN
    
    f.Show , F1
    
    
Exit Sub

mnuSrtmLoad_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuSrtmLoad_Click - Error"

End Sub

Private Sub mnuPrefCatDelConfirm_Click()

mnuPrefCatDelConfirm.Checked = Not mnuPrefCatDelConfirm.Checked

End Sub

Private Sub mnuPrefConnect_Click()
    
    Dim fDB As New frmDB
    fDB.Show 1, Me
    
'    If Not bBaseConnected Then
'
'        Unload Me
'
'    End If
    
    
End Sub

Private Sub mnuPrefLap_Click()

    mnuPrefLap.Checked = Not mnuPrefLap.Checked


End Sub

Private Sub mnuPrefLoadListByView_Click()

    bOfftNew = mnuPrefLoadListByView.Checked
    
    mnuPrefLoadListByView.Checked = Not bOfftNew


End Sub

Private Sub mnuPrefLoadPics_Click()
    
    If Not usrCurrent.trusted Then Exit Sub
    
    
    
    
    
    Dim strPath As String
    Dim strFileName As String
    Dim strFileNameFull As String
    Dim strDescr As String
    Dim strName As String
    Dim iSheet As Integer
    Dim ar() As String
    Dim partID As Long
    
    Dim iCntOk As Integer
    Dim iCntNOk As Integer
    Dim iCntNF As Integer
    
    Dim fn As Integer
    
    
    Dim shlShell As Shell32.Shell
    Dim shlFolder As Shell32.Folder
    Const BIF_RETURNONLYFSDIRS = &H1
    
    If strPath = "" Then
        Set shlShell = New Shell32.Shell
        Set shlFolder = shlShell.BrowseForFolder(Me.hwnd, "Директория PDF файлов", BIF_RETURNONLYFSDIRS)
        If shlFolder Is Nothing Then
            Exit Sub
        End If
        strPath = shlFolder.Self.path
    End If
    
    lstPics.Pattern = "*.pdf"
    
    lstPics.path = strPath
    
    lstPics.Refresh
    
    If lstPics.ListCount = 0 Then Exit Sub
    
    Dim cnf As New ADODB.Connection
    cnf.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=15;User ID=" & conn.strUser & ";Initial Catalog=docs;Data Source=" & conn.strServerName, conn.strUser, conn.strPass
    
    Dim i As Integer
    
    Me.PB.Min = 0
    Me.PB.Max = lstPics.ListCount
    
    For i = 0 To lstPics.ListCount - 1
        
        
        strFileName = lstPics.List(i)
        ar = Split(strFileName, "_")
        
        strFileNameFull = strPath & "\" & strFileName
        
        
'        strName = correctPartName(ar(0) & "-" & CStr(Val(ar(1))))
        strName = correctPartName(ar(0))
        strName = Replace(strName, ".pdf", "")
        
'        If UBound(ar) = 1 Then
'
'            strDescr = ar(0)
'            iSheet = Val(ar(1))
'
'        End If
        
'        partID = selectLongFromBase(cn_data, "part", "partID", "partName", strName, "deleted", CInt(0), "catID", lngCurCatID)
        partID = selectLongFromBase(cn_data, "part", "partID", "partDescr", strName, "deleted", CInt(0), "catID", lngCurCatID)
        
        fn = FreeFile

        If i = 0 Then
            Open App.path & "\_pdf_log.txt" For Output As fn
        Else
            Open App.path & "\_pdf_log.txt" For Append As fn
        End If
        
        If partID > 0 Then
            
            If uploadPartFile(cnf, strFileNameFull, partID) Then
                '                Print #fn, strFileName, "OK"
                iCntOk = iCntOk + 1
            Else
                Print #fn, strFileName, "failed"

                iCntNOk = iCntNOk + 1
            End If
            
        Else
            Print #fn, strFileName, "не найден"
            iCntNF = iCntNF + 1
            
        End If
        
        Close fn
        
        
        
        Me.PB.Value = i
        Me.PB.Refresh
        
        
    Next i
    
    Me.PB.Value = 0
    
    
    cnf.Close
    Set cnf = Nothing
    
    
    MsgBox " загружено " & iCntOk & ", пропущено " & iCntNOk & ", не найдено " & iCntNF
    
    
End Sub

Private Sub mnuPrefPdSortByUse_Click()

mnuPrefPdSortByUse.Checked = Not mnuPrefPdSortByUse.Checked


End Sub



'/******************************************************************************
Private Sub mnuPrefPosdefSet_Click(Index As Integer)
'/******************************************************************************

    On Error GoTo mnuPrefPosdefSet_Click_ERR

    If updateTableInBase(cn_srtm, "usr", "pdsID", CLng(Index), "usrID", usrCurrent.usrID) Then
    
        usrCurrent.pdsID = CLng(Index)
        
        Dim i As Integer
        For i = 0 To mnuPrefPosdefSet.Count - 1
            mnuPrefPosdefSet(i).Checked = False
        Next i
        
        mnuPrefPosdefSet(Index).Checked = True
    End If
    



Exit Sub

mnuPrefPosdefSet_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuPrefPosdefSet_Click - Error"

End Sub

Private Sub mnuPrefRound03_Click()

'    Me.mnuPrefRound03.Checked = Not Me.mnuPrefRound03.Checked

    Load frmRound
    frmRound.Show 1, Me


End Sub



'/******************************************************************************
Private Sub mnuPrefShowGridIcons_Click()
'/******************************************************************************

    On Error GoTo mnuPrefShowGridIcons_Click_ERR

    mnuPrefShowGridIcons.Checked = Not mnuPrefShowGridIcons.Checked
    bFormGridsIcons = mnuPrefShowGridIcons.Checked


Exit Sub

mnuPrefShowGridIcons_Click_ERR:

End Sub

Private Sub mnuPrefUseRein_Click()


    Dim f As New frmSketch
    
    f.bSaveSketchSettings = True
    
    f.Frame3.Move 120, 1080
    f.Frame3.Visible = True
    
    f.Frame4.Visible = False
    
    f.Show 1, Me


End Sub

'/******************************************************************************
Private Sub mnuReinCatApply_Click()
'/******************************************************************************

    On Error GoTo mnuReinCatApply_Click_ERR

    If lngCurCatTreeObjID = objs("catalog") Then
    
        Dim ct As clsCat
        
        Set ct = cCats(CStr(Val(mnuReinCatApply.Tag)))
        
        Dim pd As clsPartDef
        Set pd = globPartDefs(CStr(ct.CAT_CATDEF.partdefID))
        
        If cattypes(ct.catTypeID).ctEnum = ctRein And ct.CAT_CATDEF.partdefID > 0 Then
            If updateTableInBase(cn_data, "part", "partdefID", ct.CAT_CATDEF.partdefID, "catID", lngCurCatTreeSelectedID) Then
                writeOperationS operModify, "catalog", lngCurCatTreeSelectedID, "изменение всех позиций на " & pd.partdefName
            End If
        End If
    End If


Exit Sub

mnuReinCatApply_Click_ERR:
    F1.SB.Panels("status").text = "mnuReinCatApply_Click" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub mnuReinGridBlock_Click()
'/******************************************************************************

    On Error GoTo mnuReinGridBlock_Click_ERR
    
    If Not getReinPos(fgCatParts.Row, curPos, "mnuReinGridBlock_Click (1)") Then Exit Sub
    
    If mnuReinGridBlock.Checked = False Then
    
        If updateTableInBase(cn_data, "part", "partMainPosEP", 1, "partID", curPos.partID) Then
            mnuReinGridBlock.Checked = True
            curPos.parentPart.bBlockUpdate = True
        End If
    
    Else
    
        If updateTableInBase(cn_data, "part", "partMainPosEP", 0, "partID", curPos.partID) Then
            mnuReinGridBlock.Checked = False
            curPos.parentPart.bBlockUpdate = False
        End If
        
    End If




Exit Sub

mnuReinGridBlock_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuReinGridBlock_Click - Error"

End Sub

'Private Sub mnuPrefUseRein_Click()
'
'    Me.mnuPrefUseRein.Checked = Not Me.mnuPrefUseRein.Checked
'
'
'End Sub

Private Sub mnuReinGridDelete_Click()
    
    Dim partID As Long
    Dim Row As Long
    Dim iRecordsAffected As Integer
    
    
    
    
    Row = fgCatParts.Row
    
    If Not getReinPos(Row, curPos, "mnuReinGridDelete_Click (1)") Then Exit Sub
    
    partID = curPos.getPartID
    
    If partID > 0 Then
        
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        
        cmd.CommandText = "UPDATE [part] SET [deleted] = 1 WHERE partID = " & partID
        cmd.Execute iRecordsAffected
        
        If iRecordsAffected = 0 Then Exit Sub
        
    End If
    
    fgCatParts.RemoveItem Row
    
    colRein2.Remove Row
    
    
    fgCatPartsUpdatePosNumbersAll
    
    If Not getReinPos(Row, curPos, "mnuReinGridDelete_Click (2)") Then Exit Sub
    fgCatPartsSetRowData Row, curPos, True, True
    
    
    
End Sub

'/******************************************************************************
Private Sub fgCatPartsUpdatePosNumbersAll()
'/******************************************************************************

    On Error GoTo fgCatPartsUpdatePosNumbersAll_ERR

    
    Dim n As Long
    
    Dim p As clsPos
    
    Dim strSQL As String
    
    If colRein2 Is Nothing Then Exit Sub
    If colRein2.Count = 0 Then Exit Sub
    
    n = 1
    For Each p In colRein2
    
        p.parentPart.partName = CStr(n)
        Me.fgCatParts.TextMatrix(n, fgCatParts.ColIndex("num")) = CStr(n)
    
        If p.getPartID > 0 Then
        
            strSQL = strSQL & "UPDATE part set partName=" & _
                                            "'" & CStr(n) & "'" & _
                                            ",partSortNumber=" & _
                                            "'" & p.parentPart.genSortNumber(CStr(n)) & "'" & _
                                            " WHERE partID = " & p.getPartID & ";"
        

        
        End If
        
        n = n + 1
    Next p
    
    If Len(strSQL) = 0 Then Exit Sub

    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandText = strSQL
    cmd.Execute


Exit Sub

fgCatPartsUpdatePosNumbersAll_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatPartsUpdatePosNumbersAll - Error"

End Sub




'/******************************************************************************
Private Sub mnuReinGridDrawSketch_Click()
'/******************************************************************************
    
    On Error GoTo mnuReinGridDrawSketch_Click_ERR
    
    Dim i As Integer
    Dim s As String
    
    Dim rad As Integer
    
    Dim Row As Long
    Row = fgCatParts.Row
    
    If Not getReinPos(Row, curPos, "mnuReinGridDrawSketch_Click") Then Exit Sub
    
    
    Dim msapp As Object
    Set msapp = getMS
    If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
    
    
    
        

    ' не забывать заменять запятую на точку
    'send curPos.pointsSkch
    
    Dim p As OfftPoint2D
    Dim prop As clsProp
    
    
'        Call checkReinUpdate(msapp)
    
    If Not reinExists(msapp) Then
        MsgBox "Для MicroStation должно быть установлено соответствующее приложение", vbCritical, ""
        Exit Sub
    End If
    
    
    
    If iSketchShowDialog Then
        Load frmSketch
        frmSketch.bSaveSketchSettings = True
        
        frmSketch.Frame3.Move 120, 1080
        frmSketch.Frame3.Visible = True
        
        frmSketch.Frame4.Visible = False
        
        frmSketch.Show 1, Me
    End If
    
    If Not bFormOk Then Exit Sub
    
    
    Set prop = curPos.POS_SRTM.srtm_props("fillet_radius")
    If Not prop Is Nothing Then
        rad = prop.PVAL
    Else
        rad = 0
    End If
    
    
    If iSketchRadiusOpt > 0 And rad > 0 Then rad = iSketchRadiusVal
        
    rad = rad * iSketchScaleLft / iSketchScaleRgt
    
'        writeToLogFile "rad = " & CStr(rad), True
    
    
'        Dim p1() As Double
'        Dim p2() As Double
'
'        If Not Arm_2D1 Is Nothing Then Call Arm_2D1.getLengths(p1, p2)
'
'        Dim sLineLens As String
'        Dim sArcLens As String
'
'        If SafeArrayGetDim(p1) = 0 Then Exit Sub
'        If curPos.pointsSkch.Count = 0 Then Exit Sub
'
'        For I = LBound(p1) To UBound(p1)
'            If I > LBound(p1) Then sLineLens = sLineLens & ";"
'            sLineLens = sLineLens & Format(p1(I), "0")
'        Next I
'
''        writeToLogFile "sLineLens = " & sLineLens
'
'        If SafeArrayGetDim(p2) > 0 Then
'            For I = LBound(p2) To UBound(p2)
'                If I > LBound(p2) Then sArcLens = sArcLens & ";"
'                sArcLens = sArcLens & Format(p2(I), "0")
'            Next I
'        End If
    
'        writeToLogFile "sArcLens = " & sArcLens



    If InStr(msapp.Version, "08.11") > 0 Then
        msapp.SetCExpressionValue "bSketchPoint", 0, "rein"
    End If




    

    
    msapp.SetCExpressionValue "sLineLens", curPos.sSegmLineLens, "rein"
    msapp.SetCExpressionValue "sArcLens", curPos.sSegmArcLens, "rein"
    
    msapp.SetCExpressionValue "iSketchScaleHor", iSketchScaleHor, "rein"
    msapp.SetCExpressionValue "iSketchScaleVer", iSketchScaleVer, "rein"
    
    For i = 1 To curPos.pointsSkch.Count
        p = curPos.pointsSkch(i)
        s = s & Replace(";" & p.X * iSketchScaleLft / iSketchScaleRgt & ";" & p.Y * iSketchScaleLft / iSketchScaleRgt, ",", ".")
    Next i
    
'        writeToLogFile "send string = " & s
    
    msapp.CadInputQueue.SendMessageToApplication "rein", "sketch;" & rad & s
    
        
        
    
    Set msapp = Nothing
    
    
    Exit Sub
    
mnuReinGridDrawSketch_Click_ERR:
    Set msapp = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuReinGridDrawSketch_Click - Error"
    
End Sub

'/******************************************************************************
Private Sub mnuReinGridLap_Click()
'/******************************************************************************

    On Error GoTo mnuReinGridLap_Click_ERR
    
    
    If Not getReinPos(Me.fgCatParts.Row, curPos, "mnuReinGridLap_Click") Then Exit Sub

    If curPos.posID = 0 Then Exit Sub
    
    mnuReinGridLap.Checked = Not mnuReinGridLap.Checked
    
    curPos.bCalcLap = mnuReinGridLap.Checked
    curPos.savePos
    
    fgCatPartsSetRowData fgCatParts.Row, curPos, True, True
    
    

    

Exit Sub

mnuReinGridLap_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuReinGridLap_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuReinGridCont_Click()
'/******************************************************************************

    On Error GoTo mnuReinGridCont_Click_ERR


    
    If Not getReinPos(Me.fgCatParts.Row, curPos, "mnuReinGridCont_Click") Then Exit Sub

    If curPos.posID = 0 Then Exit Sub
    If curPos.POS_SRTM.srtmID = 0 Then Exit Sub
    
    
    Dim RS As New ADODB.Recordset
    
    RS.Open "select isCont from r_part_reinpoints where partID = " & curPos.getPartID & " and isMain = 1", cn_data, adOpenStatic, adLockOptimistic
    
    If Not RS.EOF Then
        RS.MoveFirst
        
        RS.fields("isCont").Value = Not mnuReinGridCont.Checked
        
        RS.Update
        
        RS.Close
        Set RS = Nothing
        
        
        mnuReinGridCont.Checked = Not mnuReinGridCont.Checked
        curPos.bCont = mnuReinGridCont.Checked
        
        writeOperationS operModify, "part", curPos.getPartID, "изменение параметра переменной длины"
    
'        If Not Arm_2D1 Is Nothing Then
            Arm_2D1.bCont = mnuReinGridCont.Checked
            Arm_2D1.Fit 1.5
'        End If
    
    Else
    
    
        Set tt = New CBalloonToolTip
        tt.Icon = TTNoIcon
        tt.Title = ""
        tt.PopupOnDemand = False
        tt.Style = TTStandard
        tt.TipText = "Нет точек эскиза, свойство не изменено"
        tt.VisibleTime = 3000
        tt.DelayTime = 3000
        tt.CreateToolTip Me.hwnd
        tt.Show
        Timer2.Enabled = True
    
    End If



Exit Sub

mnuReinGridCont_Click_ERR:
    Set RS = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuReinGridCont_Click - Error"

End Sub



Private Sub mnuReinGridPasteLengths_Click()

    On Error GoTo lenerr
    
    
    Exit Sub
lenerr:

End Sub

Private Sub mnuReinGridPasteLengths1_Click(Index As Integer)

    On Error GoTo err

    If curPos Is Nothing Then Exit Sub
    
    



err:


End Sub

'/******************************************************************************
Private Sub mnuReinGridProps_Click()
'/******************************************************************************

    On Error GoTo mnuReinGridProps_Click_ERR


    '..........



Exit Sub

mnuReinGridProps_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuReinGridProps_Click - Error"

End Sub

'/******************************************************************************
Private Sub mnuReinGridSetUnavailable_Click()
'/******************************************************************************
    
    On Error GoTo mnuReinGridSetUnavailable_Click_ERR
    
    

    If Not getReinPos(fgCatParts.Row, curPos, "mnuReinGridSetUnavailable_Click") Then Exit Sub
    
    Dim iRecordsAffected As Integer
    Dim partID As Long
    partID = curPos.getPartID
    
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    
    cmd.CommandText = "delete from [" & curPos.POS_SRC_TABLE & "] where posID = " & curPos.posID
    cmd.Execute iRecordsAffected
    
    If iRecordsAffected = 1 Then
        
        cmd.CommandText = "delete from [r_" & curPos.POS_SRC_TABLE & "_property] where posID = " & curPos.posID
        cmd.Execute iRecordsAffected
        
        Set curPos = New clsPos
        Set curPos.parentPart = New clsPart
        curPos.parentPart.setIDv2 partID, False, False, False
        curPos.partID = partID
        
        colRein2.Remove fgCatParts.Row
        colRein2.Add curPos, , fgCatParts.Row
        
        fgCatPartsSetRowData fgCatParts.Row, curPos, True, True
        
    End If
    
    

    
    
    Exit Sub
    
mnuReinGridSetUnavailable_Click_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "mnuReinGridSetUnavailable_Click - Error"
    
End Sub

'/******************************************************************************
Private Sub mnuSimDataCodes_Click()
'/******************************************************************************
    
    On Error GoTo mnuSimDataCodes_Click_ERR
    
    Dim i As Integer
    Dim simID As Long
    Dim sCode As String
    Dim sShCode As String
    Dim codeID As Long
    Dim codeNum As Long
    Dim dval As Double
    
    If fgSimCrntGlob Is Nothing Then Exit Sub
    
    
    Dim cn As New ADODB.Connection
    cn.Open "Provider=SQLOLEDB;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
    
    With fgSimCrntGlob
    
        If InStr(.Tag, "FireCompartment") Then
        
            Dim stp As Long
            If .RowSel < .Row Then stp = -1 Else stp = 1
        
        
            If mnuSimDataCodes.Tag = "fccode" Then
            
                For i = .Row To .RowSel Step stp
                
                    codeID = Val(.TextMatrix(i, .ColIndex(strFireCompID)))
                    sCode = Trim(.TextMatrix(i, .ColIndex(strFireCode)))
                
                    If codeID = 0 And Len(Trim(sCode)) > 0 Then
                        
                        ' проверка на уже имеющийся код
                        codeID = selectLongFromBase(cn, strFireCompTable, strFireCompID, "fcCode", sCode)
                    
                        If codeID = 0 Then codeID = insertDataInBase(cn, strFireCompTable, "fcCode", sCode)
    
                        If codeID > 0 Then
                            .Cell(flexcpFontBold, i, .ColIndex(strFireCode), i, .ColIndex(strFireCode)) = True
                            .TextMatrix(i, .ColIndex(strFireCompID)) = codeID
                            'Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
                        End If
    
                    End If
                    
                Next
                 
            ElseIf mnuSimDataCodes.Tag = "fcval" Then
            
                For i = .Row To .RowSel Step stp
                
                    codeID = Val(.TextMatrix(i, .ColIndex(strFireCompID)))
                
                    'fcFireRes
                    'fcFloorArea
                    'fcFireLoad
                    'fcRoomCodes
                
                    If codeID > 0 Then
                        
                        'fcFireRes
                        codeNum = Val(.TextMatrix(i, .ColIndex(strFireResMan)))
                        If codeNum = 0 Then codeNum = Val(.TextMatrix(i, .ColIndex(strFireRes)))
                        
                        If codeNum > 0 Then
                            If updateTableInBase(cn, strFireCompTable, strFireResField, codeNum, strFireCompID, codeID) Then
                                .Cell(flexcpFontBold, i, .ColIndex(strFireResMan), i, .ColIndex(strFireResMan)) = True
                                .TextMatrix(i, .ColIndex(strFireResMan)) = codeNum ' если взято из (strFireRes)
                                'Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
                            End If
                        End If
                        
                        'fcFloorArea
                        dval = getDbl(.TextMatrix(i, .ColIndex(strFireAreaMan)))
                        If dval = 0 Then dval = getDbl(.TextMatrix(i, .ColIndex(strFireArea)))
                        
                        If dval > 0 Then
                            If updateTableInBase(cn, strFireCompTable, strFireAreaField, dval, strFireCompID, codeID) Then
                                .Cell(flexcpFontBold, i, .ColIndex(strFireArea), i, .ColIndex(strFireArea)) = True
                                'Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
                            End If
                        End If
                        
                        'fcFireLoad - берем максимальный
                        sCode = .TextMatrix(i, .ColIndex(strFireLoads))
                        If InStr(sCode, ">") Then
                            sCode = ">"
                        ElseIf InStr(sCode, "=") Then
                            sCode = "="
                        ElseIf InStr(sCode, "<") Then
                            sCode = "<"
                        Else
                            sCode = "" ' не определены для помиещений
                        End If
                        
                        If updateTableInBase(cn, strFireCompTable, "fcFireLoad", sCode, strFireCompID, codeID) Then
                            .Cell(flexcpFontBold, i, .ColIndex(strFireLoads), i, .ColIndex(strFireLoads)) = True
                            '.TextMatrix(i, .ColIndex(strFireLoads)) = codeNum
                            'Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
                        End If
                        
                        'fcRoomCodes
                        sCode = .TextMatrix(i, .ColIndex(strFireRooms))
                        If updateTableInBase(cn, strFireCompTable, "fcRoomCodes", sCode, strFireCompID, codeID) Then
                            .Cell(flexcpFontBold, i, .ColIndex(strFireRooms), i, .ColIndex(strFireRooms)) = True
                            '.TextMatrix(i, .ColIndex(strFireRooms)) = codeNum
                            'Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
                        End If
                        
                        If Val(.TextMatrix(i, .ColIndex(strFireArea))) <> Val(.TextMatrix(i, .ColIndex(strFireAreaMan))) _
                                            And Val(.TextMatrix(i, .ColIndex(strFireAreaMan))) > 0 Then
                            .Cell(flexcpBackColor, i, .ColIndex(strFireArea), i, .ColIndex(strFireAreaMan)) = lngLightRed
                        Else
                            .Cell(flexcpBackColor, i, .ColIndex(strFireArea), i, .ColIndex(strFireAreaMan)) = lngRowWinColor
                        End If
                        
                        If Val(.TextMatrix(i, .ColIndex(strFireRes))) <> Val(.TextMatrix(i, .ColIndex(strFireResMan))) Then
                            .Cell(flexcpBackColor, i, .ColIndex(strFireRes), i, .ColIndex(strFireResMan)) = lngLightRed
                        Else
                            .Cell(flexcpBackColor, i, .ColIndex(strFireRes), i, .ColIndex(strFireResMan)) = lngRowWinColor
                        End If
    
                    End If
                    
                Next
            
            
            End If
        

        Else
        
'            For i = 0 To .SelectedRows - 1
'
'                codeID = Val(.TextMatrix(.SelectedRow(i), .ColIndex("codeID")))
'                simID = Val(.TextMatrix(.SelectedRow(i), .ColIndex("simID")))
'                sCode = Trim(.TextMatrix(.SelectedRow(i), .ColIndex("Civil Code")))
'                sShCode = Trim(.TextMatrix(.SelectedRow(i), .ColIndex("codeShortID")))
'                codeNum = Val(.TextMatrix(.SelectedRow(i), .ColIndex("codeNumID")))
'
'                If Len(sCode) > 0 And codeNum > 0 And simID > 0 And codeID = 0 Then
'                    If updateTableInBase(cn, "elemCodes", "codeFull", sCode, "simID", CStr(simID)) Then
'                        Call updateTableInBase(cn, "elemCodes", "codeNum", codeNum, "simID", CStr(simID))
'                        Call updateTableInBase(cn, "elemCodes", "codeShort", sShCode, "simID", CStr(simID))
'                        codeID = selectLongFromBase(cn, "elemCode", "codeID", "simID", simID)
'                    Else
'                        codeID = insertDataInBase(cn, "elemCodes", "simID", simID, "codeFull", sCode, "codeNum", codeNum, "codeShort", sShCode)
'                    End If
'
'                    If codeID > 0 Then
'                        .Cell(flexcpFontBold, .SelectedRow(i), .ColIndex("Civil Code"), .SelectedRow(i), .ColIndex("Civil Code")) = True
'                        .TextMatrix(.SelectedRow(i), .ColIndex("codeID")) = codeID
'                        Call writeOperationS(operCreate, "elemod", simID, "фиксация кода " & sCode)
'                    End If
'
'                End If
'
'            Next
            
        End If
    
    End With
    
    cn.Close
    Set cn = Nothing
    
    
    Exit Sub
    
mnuSimDataCodes_Click_ERR:
    Set cn = Nothing
    F1.SB.Panels("status").text = "mnuSimDataCodes_Click" & "() - " & err.Description
    
End Sub

Private Sub mnuSimFilesLinks_Click()

    On Error GoTo err
    
    Dim guid As String
    guid = Replace(mnuSimFilesLinks.Tag, "item", "")
    
'    If usrCurrent.trusted = False Then Exit Sub
    If Len(guid) = 0 Then Exit Sub
    
    If Not pwset.connected Then Exit Sub
    
    Load frmPwDoc
    frmPwDoc.Text1.text = guid
    If usrCurrent.trusted = False Then frmPwDoc.Text1.Locked = True
    frmPwDoc.Command1_Click
    frmPwDoc.Show
        
    
    
    Exit Sub
err:
    
    MsgBox err.Description

End Sub

Private Sub mnuSimFilesReprocess_Click()

On Error GoTo err

    Dim guid As String
    guid = Replace(mnuSimFilesReprocess.Tag, "item", "")
    

    If Len(guid) = 0 Then Exit Sub
    
    If Not pwset.connected Then Exit Sub
    
    Dim li As ListItem
    Set li = lvWise.ListItems(mnuSimFilesReprocess.Tag)
    
    Dim cn As New ADODB.Connection
    
    cn.Open pwset.constring, pwset.login, pwset.login
    
    If cn.State = adStateOpen Then
        
        Dim RS As New ADODB.Recordset
        
        RS.Open "select * from aep_docdata where [docguid] = '" & guid & "'", cn, adOpenStatic, adLockOptimistic
        
        If Not RS.EOF Then
            RS.MoveFirst
            
            If RS.fields("last_state").Value <> "process" Or RS.fields("counter").Value = 6 Then
                RS.fields("counter").Value = 0
                RS.fields("last_state").Value = ""
                RS.fields("dt_change").Value = Now
                RS.Update
                
                li.SubItems(2) = "в очереди"
            End If
            
        End If
        
        RS.Close
        Set RS = Nothing
        
        cn.Close
        Set cn = Nothing
        
    End If
    
    
Exit Sub
err:
    Set RS = Nothing
    Set cn = Nothing
MsgBox err.Description

End Sub

Private Sub mnuViewCatsStat_Click(Index As Integer)

    mnuViewCatsStat(Index).Checked = Not mnuViewCatsStat(Index).Checked

End Sub

Private Sub mnuViewOnTop_Click()

    mnuViewOnTop.Checked = Not mnuViewOnTop.Checked
    SetAlwaysOnTopMode Me.hwnd, mnuViewOnTop.Checked


End Sub

'/******************************************************************************
Private Sub mnuViewShowPart_Click()
'/******************************************************************************

    On Error GoTo mnuViewShowPart_Click_ERR

    Load frmPartImage
    frmPartImage.Show
    
    Dim nd As Node
    
    Set nd = tvParts.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If left(nd.KEY, Len("part")) = "part" Then
        Dim ID As Long
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
    
        If mnuViewShowPart.Checked Then
            loadPartImageWindow ID
            frmPartImage.Caption = curPart.partName
        End If
    
    End If

    
    
        
    

Exit Sub

mnuViewShowPart_Click_ERR:
    Me.SB.Panels("status").text = err.Description

End Sub

Sub setNodeImage(nd As Node, idir As Integer)

    Dim ndx As Node
    Dim i As Integer

    If idir = -1 Then
    If nd.Image = "folder" Then nd.Image = "folder_out"
    If nd.Image = "elem_1" Then nd.Image = "noelem"
    End If
   
    If idir = 1 Then
    If nd.Image = "folder_out" Then nd.Image = "folder"
    If nd.Image = "noelem" Then nd.Image = "elem_1"
    End If
   
   
    If nd.children > 0 Then
        Set ndx = nd.Child.FirstSibling
        For i = 1 To nd.children
            setNodeImage ndx, idir
            Set ndx = ndx.Next
        Next
    End If


End Sub


Private Sub mnuWiseTreeCmdBack_Click()


On Error GoTo err

    If tvWise.SelectedItem Is Nothing Then Exit Sub
    If pwset Is Nothing Then Exit Sub

    Dim strSQL As String
    Dim i As Integer
    Dim strKey As String
    Dim strBldCode As String
    'Dim iLev As Integer
    Dim nd As Node
    Dim ndd As Node
    Dim ndx As Node
    Dim bldID As Long
    Dim RS As ADODB.Recordset
    Dim cmd As ADODB.Command
    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    

    Set nd = tvWise.SelectedItem
    'iLev = nd.Tag
    
    

    strBldCode = getPathPartial(nd.KEY, 0, 0)
    strKey = getPathPartial(nd.KEY, 1)
    bldID = selectLongFromBase(cnpw, "buildings", "bldID", "bldCode", strBldCode)
    
    Dim iRs As Integer
    Dim img As String
    
    If bldID > 0 And Len(strKey) > 0 Then
    
        Set cmd = New ADODB.Command
        Set cmd.ActiveConnection = cnpw
    
        If nd.Image = "folder_inc" Then
        
            cmd.CommandText = "delete from filter_inc where bldID = " & bldID & " and fnPath = '" & strKey & "'"
            img = "folder"
        
        ElseIf nd.Image = "elem_inc" Then
        
            cmd.CommandText = "delete from filter_inc where bldID = " & bldID & " and fnPath = '" & strKey & "'"
            img = "elem_0"
        
        ElseIf nd.Image = "folder_out" Then
        
            cmd.CommandText = "delete from filter_out where bldID = " & bldID & " and ftPath = '" & strKey & "'"
            img = "folder"

        ElseIf nd.Image = "elem_out" Then
        
            cmd.CommandText = "delete from filter_out where bldID = " & bldID & " and ftPath = '" & strKey & "'"
            img = "elem_1"

            
        End If
        
        cmd.Execute iRs
    
        If iRs > 0 Then nd.Image = img
        
        Set cmd = Nothing
    
    
    End If
        
    cnpw.Close
    Set cnpw = Nothing
        

    Exit Sub
err:

    Set cnpw = Nothing


End Sub



Private Sub mnuWiseTreeOpenBld_Click()

'    On Error GoTo err
'
'    If tvWise.SelectedItem Is Nothing Then Exit Sub
'
'    wiseOpenModel tvWise.SelectedItem, strNavisFTPbld


Exit Sub
err:

End Sub

Private Sub mnuWiseTreeOpenTech_Click()

'    On Error GoTo err
'
'    If tvWise.SelectedItem Is Nothing Then Exit Sub
'
'
'    If tvWise.SelectedItem.Image = "project" Then
'        Call ShellExecute(0, "open", "http://" & strNavisFTPserv & "/" & tvWise.SelectedItem.text & ".nwd", "", "", 1)
'    ElseIf tvWise.SelectedItem.Image = "building" Then
'        wiseOpenModel tvWise.SelectedItem, strNavisFTPtech
'    End If
    


Exit Sub
err:

End Sub

Private Sub mnuWiseTreeSearch_Click()

    On Error GoTo err

    Dim strFind As String
    Dim bldID As Long
    Dim strBldCode As String
    Dim strKey As String
    
    If tvWise.SelectedItem Is Nothing Then Exit Sub
    
    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    
    
    Dim nd As Node
    Set nd = tvWise.SelectedItem
    strBldCode = getPathPartial(nd.KEY, 0, 0)
    strKey = getPathPartial(nd.KEY, 1)
    bldID = selectLongFromBase(cnpw, "buildings", "bldID", "bldCode", strBldCode)
    
    'loadTreeNodeTech nd
    
    If bldID > 0 Then
    
        strFind = Trim(InputBox("", "", Clipboard.GetText))
        If Len(Trim(strFind)) > 0 Then
            Dim RS As New ADODB.Recordset
            
            RS.Open "select * from " & strTechViewName & " where pwdocID = " & bldID & " and path like '%\" & strFind & "%' order by path", cnpw, adOpenForwardOnly, adLockReadOnly
        
            If Not RS.EOF Then
                RS.MoveFirst
                strKey = RS.fields("path").Value
            Else
                MsgBox "Не найдено"
            End If
            
            RS.Close
            Set RS = Nothing
        
        End If
        
        
        Dim ndd As Node
        Dim strKey2 As String
        
        strKey = strBldCode & "\" & strKey
        
        
bgn:
        Set ndd = tvGetTreeNode(tvWise, strKey)
        strKey2 = strKey
        
        If ndd Is Nothing Then
        
            Do While ndd Is Nothing
            
                strKey2 = getPathPartial(strKey2, 0, -2)
                
                If InStr(strKey2, "\") = 0 Then Exit Do
            
                Set ndd = tvGetTreeNode(tvWise, strKey2)
                
            Loop
            
            If InStr(strKey2, "\") > 0 Then Call loadTreeNodeTech(ndd, False)
            
            GoTo bgn
        Else
        End If
        
        If Not ndd Is Nothing Then ndd.Selected = True
        
        If Not ndd Is Nothing Then ndd.EnsureVisible
        
        
'        For Each nd In tvWise.Nodes
'            If InStr(nd.FullPath, strFind) > 0 Then
'                nd.EnsureVisible
'            End If
'        Next nd
        
    End If
    
    cnpw.Close
    Set cnpw = Nothing
    

    Exit Sub
err:
    MsgBox err.Description
    Set cnpw = Nothing


End Sub

Private Sub RSSev_FieldChangeComplete(ByVal cFields As Long, ByVal fields As Variant, ByVal pError As ADODB.Error, adStatus As ADODB.EventStatusEnum, ByVal pRecordset As ADODB.Recordset)

    '


End Sub

'/******************************************************************************
Private Sub SB_PanelClick(ByVal Panel As MSComctlLib.Panel)
'/******************************************************************************

    On Error GoTo SB_PanelClick_ERR


    Me.SB.Panels("status").text = ""
    
    If Panel.KEY = "queue" Then
        Panel.text = CStr(Me.getQueueCnt()) & "  "
        Panel.AutoSize = sbrContents
    End If


Exit Sub

SB_PanelClick_ERR:
    F1.SB.Panels("status").text = "SB_PanelClick" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Sub sldRound_Change()
'/******************************************************************************

    On Error GoTo sldRound_Change_ERR

    If BRYS Then Exit Sub
    If curPart Is Nothing Then Exit Sub
    If curPart.partID = 0 Then Exit Sub
    If curPart.bIsCat Then Exit Sub

    If Not checkPart(curPart, operModify) Then Exit Sub
    
    If updateTableInBase(cn_data, "part", "partRoundShift", sldRound.Value, "partID", curPart.partID) Then
        updateTableInBase cn_data, "part", "partRoundSaved", CInt(1), "partID", curPart.partID
        curPart.bRoundDefined = True
        curPart.iRoundLocalShift = sldRound.Value
        curPart.updateMasses True, True
        writeOperationS operModify, "part", curPart.partID, "сдвиг округления = " & sldRound.Value
    End If
    


Exit Sub

sldRound_Change_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "sldRound_Change - Error"

End Sub

'/******************************************************************************
Private Sub tbCats_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************

    On Error GoTo tbCats_ButtonClick_ERR


    Dim ndNew As Node
    Dim ID As Long
    


    If Button.KEY = "newproject" Then
    
        If Not checkGroupPerm(usrCurrent.groupID, "project", operCreate) Then Exit Sub
        
        
'        Dim strPath As String
'
'        Dim shlShell As Shell32.Shell
'        Dim shlFolder As Shell32.Folder
'        Const BIF_RETURNONLYFSDIRS = &H1
        
'        If strPath = "" Then
'            Set shlShell = New Shell32.Shell
'            Set shlFolder = shlShell.BrowseForFolder(Me.hwnd, "Директория проекта", BIF_RETURNONLYFSDIRS)
'            If shlFolder Is Nothing Then
'                Exit Sub
'            End If
'            strPath = shlFolder.Self.Path
'        End If
'
'        If Right(strPath, 1) = "\" Then strPath = Left(strPath, Len(strPath) - 1)
        
        
        ID = insertDataInBase(cn_data, "i_project", "projectName", "Новый проект")
        
        If ID > 0 Then
            Call insertDataInBase(cn_data, "r_department_project", "projectID", ID, "depID", usrCurrent.depID)
            
            Set ndNew = tvCats.Nodes.Add(, , "project0", "Новый проект", "project")
            ndNew.KEY = "project" & ID
            ndNew.Tag = "project"
            ndNew.Selected = True
            tvCats.StartLabelEdit
    
            Call writeOperationS(operCreate, "project", ID, "создание проекта")
        End If
        
    ElseIf Button.KEY = "reload" Then
    
    
        Dim i As Integer
        
        tvCatsTreeUpdateExpanded
    
        loadCatsTree2 CBool(Me.tbCats.Buttons("LoadAll").Value = tbrPressed) And usrCurrent.trusted
    
    
    
    ElseIf Button.KEY = "Search" Then
    
        Dim fs As New frmSearch
        fs.Show
    
    ElseIf Button.KEY = "InList" Then
        
        Dim sPrntKey As String
        Dim catID As Long
        
        If lngCurCatTreeObjID = objs("catlist") Then
        
            If lngCurCatListID = lngCurCatTreeSelectedID Then
                MsgBox "Нельзя добавлять список сам в себя", vbInformation, ""
                Exit Sub
            End If
        End If
            
        sPrntKey = srvGetParentKey(objs("catlist"), lngCurCatListID)
        
        If left(sPrntKey, Len("catalog")) = "catalog" Then
            catID = Val(right(sPrntKey, Len(sPrntKey) - Len("catalog")))
        Else ' ?
            Exit Sub
        End If
            
        
        If srvIsCatBlocked(catID, usrCurrent.usrID) Then
            MsgBox "Нельзя добавлять в список блокированного каталога", vbInformation, ""
            Exit Sub
        End If
        
        Dim RS As New ADODB.Recordset
        
        RS.Open "select * from r_catlist_part where catlistID = " & lngCurCatListID & " and partID = " & lngCurCatTreeSelectedID & " and objID = " & lngCurCatTreeObjID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If RS.EOF Then
            
            RS.AddNew
            RS.fields("catlistID").Value = lngCurCatListID
            RS.fields("partID").Value = lngCurCatTreeSelectedID
            RS.fields("partQty").Value = 1
            RS.fields("objID").Value = lngCurCatTreeObjID
            RS.Update
            
            
            If lngCurCatTreeObjID = objs("catalog") Then
                Call writeOperationS(operModify, "catlist", lngCurCatListID, "добавлен каталог " & selectStringFromBase(cn_data, "i_catalog", "catName", "catID", lngCurCatTreeSelectedID))
            ElseIf lngCurCatTreeObjID = objs("catlist") Then
                Call writeOperationS(operModify, "catlist", lngCurCatListID, "добавлен список " & selectStringFromBase(cn_data, "catlist", "catlistName", "catlistID", lngCurCatTreeSelectedID))
            End If
            
            If mnuListSortAuto.Checked Then sortListInBaseProc
            
            loadListGrid lngCurCatListID
            
            
        End If
        
        RS.Close
        Set RS = Nothing
        
        
    ElseIf Button.KEY = "FindCat" Then
    
        Dim nd As Node
        Set nd = tvGetTreeNode(F1.tvCats, InputBox("Поиск узла дерева по ключу", "", ""))
        If Not nd Is Nothing Then
            nd.EnsureVisible
            nd.Selected = True
        End If
    
    Else
    
    
    
    End If


Exit Sub

tbCats_ButtonClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "tbCats_ButtonClick - Error"

End Sub

'/******************************************************************************
Public Function reinExists(ByRef ms As Object) As Boolean
'/******************************************************************************

    On Error GoTo appExists_ERR
    
    If ms Is Nothing Then Exit Function


    ms.CadInputQueue.SendCommand "mdl load rein"

    Dim i As Integer
'    Dim arLens As String
    
    i = ms.GetCExpressionValue("diam", "rein")
'    arLens = ms.GetCExpressionValue("arLens", "rein")
    
    
    If i > 0 Then
        reinExists = True
    Else
        i = ms.GetCExpressionValue("diam", "rein")
        If i > 0 Then reinExists = True
    End If

Exit Function

appExists_ERR:

End Function


'/******************************************************************************
Public Function rcatExists(ByRef ms As Object) As Boolean
'/******************************************************************************

    On Error GoTo appExists_ERR
    
    If ms Is Nothing Then Exit Function

    ms.CadInputQueue.SendCommand "mdl load rcat"

    Dim i As Integer
    
    i = ms.GetCExpressionValue("rcat", "rcat")
    
    If i = 11 Then
        rcatExists = True
    End If

Exit Function

appExists_ERR:

End Function

Public Function getMSWindowH(ByRef ms As Object) As Long

    On Error GoTo appExists_ERR
    
    Dim hwnd As Long

    If ms Is Nothing Then Exit Function

    ms.CadInputQueue.SendCommand "mdl load " & App.path & "\" & strReinSpec

    hwnd = ms.GetCExpressionValue("hwnd", strReinSpec)
    
    getMSWindowH = hwnd


Exit Function

appExists_ERR:

End Function

'/******************************************************************************
Public Function reinSpecExists(ByRef ms As Object) As Boolean
'/******************************************************************************

    On Error GoTo appExists_ERR
    
    If ms Is Nothing Then Exit Function


    ms.CadInputQueue.SendCommand "mdl load " & App.path & "\" & strReinSpec

    Dim i As Integer
'    Dim arLens As String
    
    i = ms.GetCExpressionValue("diam", strReinSpec)
'    arLens = ms.GetCExpressionValue("arLens", "rein")
    
    
    If i > 0 Then
        reinSpecExists = True
    Else
        i = ms.GetCExpressionValue("diam", strReinSpec)
        If i > 0 Then reinSpecExists = True
    End If

Exit Function

appExists_ERR:

End Function

'/******************************************************************************
Public Sub checkReinSpecUpdate(ms As Object)
'/******************************************************************************

    On Error GoTo checkRein_ERR
    
    If ms Is Nothing Then Exit Sub
    
'    If Not bUpdateRein Then Exit Sub
    

'    ms.CadInputQueue.SendKeyin "mdl unload reinspec"

'    If usrCurrent.strLogin <> "l_vibe" Then

        If InStr(ms.Version, "08.05") > 0 Then
            strReinSpec = "reinsp05"
'            Call copyFile(App.Path & "\reinsp05.ma", ms.Path & "\mdlapps\reinspec.ma", bUpdateRein)
        Else
            strReinSpec = "reinsp11"
'            Call copyFile(App.Path & "\reinsp11.ma", ms.Path & "\mdlapps\reinspec.ma", bUpdateRein)
        End If

'    End If

'    ms.CadInputQueue.SendKeyin "mdl load reinspec"



Exit Sub

checkRein_ERR:

End Sub



'/******************************************************************************
Public Sub checkReinUpdate(ms As Object)
'/******************************************************************************

    On Error GoTo checkRein_ERR
    
    If ms Is Nothing Then Exit Sub
    
'    If Not bUpdateRein Then Exit Sub
    

'    ms.CadInputQueue.SendKeyin "mdl unload rein"
'
'
'    If usrCurrent.strLogin <> "l_vibe" Then
'
'        Call copyFile(App.Path & "\rein.ma", ms.Path & "\mdlapps\rein.ma", bUpdateRein)
'
'    End If
'
'    ms.CadInputQueue.SendKeyin "mdl load rein"



Exit Sub

checkRein_ERR:

End Sub

'/******************************************************************************
Public Sub drawVed(pCmnVert As Point3d, msapp As Object) ' устар.
'/******************************************************************************

    On Error GoTo drawVed_ERR
    
    If msapp Is Nothing Then Exit Sub


    Dim pos As clsPos
    Dim prop As clsProp
    Dim i, j As Integer
    Dim rad As Double
    Dim p As OfftPoint2D
    Dim s As String
    Dim hgtLn As Double
    Dim hgtSk As Double
    Dim dMaxHgt As Double
    Dim dColWdt(2) As Double
    Dim pTxt As Point3d
    
    
   
    hgtLn = iSketchCellHeight
    hgtSk = iSketchCellHeight / 4 * 3
    
    dColWdt(0) = iSketchCellWidth * 0.15
    dColWdt(1) = iSketchCellWidth - dColWdt(0)
    
    
    If hgtLn > iSketchMaxHeight Then
        dMaxHgt = spec.cSpParts.Count * iSketchCellHeight + iSketchCellHeight
    Else
        dMaxHgt = iSketchMaxHeight
    End If
    
    
    msapp.SetCExpressionValue "bSketchPoint", 1, "rein"
    
    
    msapp.SetCExpressionValue "iSketchScaleHor", dColWdt(1) / 2, "rein"
    msapp.SetCExpressionValue "iSketchScaleVer", iSketchCellHeight / 2, "rein"
    
    msapp.SetCExpressionValue "iSketchBarWeight", 2, "rein"
    msapp.SetCExpressionValue "iSketchTxtWeight", 1, "rein"
    
    
    
    
    
    For i = 1 To spec.cSpParts.Count
        
        Set pos = spec.cSpParts(i).ps.pm(1)
        
        
        Set prop = pos.POS_SRTM.srtm_props("fillet_radius")
        If Not prop Is Nothing Then
            rad = prop.PVAL
        Else
            rad = 0
        End If
        
        If hgtLn > dMaxHgt Then
            hgtLn = iSketchCellHeight
            hgtSk = iSketchCellHeight / 4 * 3
            pCmnVert.X = pCmnVert.X + iSketchCellWidth * 1.2
        End If
        
        If iSketchRadiusOpt > 0 And rad > 0 Then rad = iSketchRadiusVal
        
        rad = rad * iSketchScaleLft / iSketchScaleRgt
        
        msapp.SetCExpressionValue "sLineLens", pos.sSegmLineLens, "rein"
        msapp.SetCExpressionValue "sArcLens", pos.sSegmArcLens, "rein"
        
        msapp.SetCExpressionValue "dSketchPointX", pCmnVert.X + dColWdt(0) + dColWdt(1) / 4, "rein"
        msapp.SetCExpressionValue "dSketchPointY", pCmnVert.Y - hgtSk, "rein"
        msapp.SetCExpressionValue "dSketchPointZ", pCmnVert.z, "rein"
        
        s = ""
        For j = 1 To pos.pointsSkch.Count
            p = pos.pointsSkch(j)
            s = s & Replace(";" & p.X * 5 & ";" & p.Y * 5, ",", ".") ' сделать getRange и ранжировать по нему, сейчас масштаб тупо увеличивается в 5 раз
        Next j
        
        If pos.pointsSkch.Count > 0 Then msapp.CadInputQueue.SendMessageToApplication "rein", "sketch;" & rad & s

        Call drawLineXY(msapp, pCmnVert.X, pCmnVert.Y, pCmnVert.X + iSketchCellWidth, pCmnVert.Y)
        Call drawLineXY(msapp, pCmnVert.X, pCmnVert.Y - hgtLn, pCmnVert.X + iSketchCellWidth, pCmnVert.Y - hgtLn)
        
        Call drawLineXY(msapp, pCmnVert.X, pCmnVert.Y, pCmnVert.X, pCmnVert.Y - hgtLn, 1)
        Call drawLineXY(msapp, pCmnVert.X + dColWdt(0), pCmnVert.Y, pCmnVert.X + dColWdt(0), pCmnVert.Y - hgtLn)
        Call drawLineXY(msapp, pCmnVert.X + dColWdt(0) + dColWdt(1), pCmnVert.Y, pCmnVert.X + dColWdt(0) + dColWdt(1), pCmnVert.Y - hgtLn)
        
        pTxt = pCmnVert
        pTxt.X = pTxt.X + dColWdt(0) / 2#
        pTxt.Y = pTxt.Y - hgtLn + iSketchCellHeight / 2#
        
        
        Dim txt As TextElement
        Set txt = CreateTextElement1(Nothing, spec.cSpParts(i).partName, pTxt, Matrix3dIdentity)
        txt.LineWeight = 1
        ActiveModelReference.AddElement txt
        
        
        hgtLn = hgtLn + iSketchCellHeight
        hgtSk = hgtSk + iSketchCellHeight
        
    Next i
    



Exit Sub

drawVed_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "drawVed - Error"

End Sub


'/******************************************************************************
Private Function goMS(whatToDraw As Integer, dWidth As Double, dHeight As Double) As Boolean
'/******************************************************************************
    
    On Error GoTo goMS_ERR
    
    'Dim msapp As MicroStationDGN.Application
    Dim msapp As Object
    Set msapp = getMS
    If msapp Is Nothing Then MsgBox sCommonMessage: Exit Function

    
'    Dim el As Object
'    Dim ap As Object
'    Set el = GetObject(, "MicroStationDGN.Element")
'    Set el = ap.Element
    
    
    Dim iAlignHor As Integer
    Dim iAlignVer As Integer
    
    

    sCommonMessage = "Call checkReinSpecUpdate(msapp)"
    Call checkReinSpecUpdate(msapp)
    
    sCommonMessage = "reinSpecExists(msapp)"
    If Not reinSpecExists(msapp) Then Exit Function
    
    '===========================================
    
    sCommonMessage = "msapp.UpdateGraphicGroupNumber"
    msapp.UpdateGraphicGroupNumber
    
    Dim lvl As Level
    
    sCommonMessage = "getLevelByNumber(msapp, iLineLevel)"
    If Not getLevelByNumber(msapp, iLineLevel) Then
        Set lvl = ActiveDesignFile.AddNewLevel("Линии таблиц")
        lvl.Number = iLineLevel
        ActiveDesignFile.Levels.Rewrite
    End If
    
    sCommonMessage = "getLevelByNumber(msapp, iTextLevel)"
    If Not getLevelByNumber(msapp, iTextLevel) Then
        Set lvl = ActiveDesignFile.AddNewLevel("Текст таблиц")
        lvl.Number = iTextLevel
        ActiveDesignFile.Levels.Rewrite
    End If
    
    
    If iSpecAlign = 0 Then iAlignHor = 1: iAlignVer = -1
    If iSpecAlign = 1 Then iAlignHor = -1: iAlignVer = -1
    If iSpecAlign = 2 Then iAlignHor = 1: iAlignVer = 1
    If iSpecAlign = 3 Then iAlignHor = -1: iAlignVer = 1
    
    Dim s As ShapeElement
    Dim vtcs(1 To 4) As Point3d
    
    vtcs(2).X = dWidth * iAlignHor
    vtcs(3).X = dWidth * iAlignHor
    
    vtcs(3).Y = dHeight * iAlignVer
    vtcs(4).Y = dHeight * iAlignVer
    
    sCommonMessage = "CreateShapeElement1"
    Set s = CreateShapeElement1(Nothing, vtcs, msdFillModeNotFilled)
    s.LineWeight = 1
    s.LineStyle = ActiveDesignFile.LineStyles("1")


    
    sCommonMessage = "s.GraphicGroup = msapp.CurrentGraphicGroup"
    s.GraphicGroup = msapp.CurrentGraphicGroup
    
    
    
    sCommonMessage = "msapp.ActiveModelReference.AddElement s"
    msapp.ActiveModelReference.AddElement s
    
    
    sCommonMessage = "msapp.ActiveModelReference.SelectElement s, False"
    msapp.ActiveModelReference.SelectElement s, False
    
    sCommonMessage = "CadInputQueue.SendMessageToApplication"
'    If Not reinSpecExists(msapp) Then
'        bUseCoreLines = False
'        bUseCoreText = False
'    Else
'        bUseCoreLines = bCoreLines
'        bUseCoreText = bCoreText
        CadInputQueue.SendMessageToApplication strReinSpec, "dp"   ' prepare drawing
'    End If
    
    
    sCommonMessage = "move"
    With CadInputQueue
        
        .SendCommand "move"
        
        .SendDataPoint Point3dZero
        
        
        Dim Message As CadInputMessage
        
        Do While True
            
            
            Set Message = .GetInput(msdCadInputTypeDataPoint, msdCadInputTypeReset)
            If Message.InputType = msdCadInputTypeDataPoint Then
            
                Dim p As Point3d
                p = Message.Point
                If iSpecAlign = 1 Or iSpecAlign = 3 Then p.X = p.X - dWidth
                If iSpecAlign = 2 Or iSpecAlign = 3 Then p.Y = p.Y + dHeight
                
            
                .SendReset
                s.redraw msdDrawingModeErase
                s.Move Message.Point
                
                If whatToDraw = 0 Then
                
                    s.LineWeight = 1
                    s.LineStyle = ActiveDesignFile.LineStyles("0")
                    s.Color = 0
                    
                    s.Rewrite
                    msapp.ActiveModelReference.UnselectElement s
'                    msapp.ActiveModelReference.RemoveElement s
                
                    drawOfftake p, dWidth, msapp
                    
                ElseIf whatToDraw = 1 Then
                
                    s.Rewrite
                    s.redraw msdDrawingModeErase
                    msapp.ActiveModelReference.UnselectElement s
                    msapp.ActiveModelReference.RemoveElement s
                
                    drawSpec p
                    
                ElseIf whatToDraw = 2 Then
                
                
                    If InStr(msapp.Version, "08.11") > 0 Then
                    
                        s.LineWeight = 1
                        s.LineStyle = ActiveDesignFile.LineStyles("0")
                        s.Color = 0
                        
                        s.Rewrite
                        s.redraw msdDrawingModeErase
                        msapp.ActiveModelReference.UnselectElement s
                        msapp.ActiveModelReference.RemoveElement s
                        
                        drawVed p, msapp
                        
                    Else
                    
                        MsgBox "Установка ведомостей деталей работает только для версии MicroStation 8.11"
                    
                    End If
                
                
                End If
                
                Exit Do
                
            ElseIf Message.InputType = msdCadInputTypeReset Then
                .SendReset
                s.redraw msdDrawingModeErase
                msapp.ActiveModelReference.UnselectElement s
                msapp.ActiveModelReference.RemoveElement s
                Exit Do
            End If
        Loop
        
        msapp.CommandState.StartDefaultCommand
        
        
        
    End With
    
    msapp.CadInputQueue.SendCommand "mdl unload " & strReinSpec
    
    
    Set msapp = Nothing

    
    
    Exit Function
    
goMS_ERR:
    Set msapp = Nothing
    MsgBox "[" & err.Number & "] " & err.Description & vbNewLine & sCommonMessage, vbCritical, "goMS - Error"
    
End Function


'/******************************************************************************
Private Function copyPositions(ID1 As Long, ID2 As Long) As Boolean ' NU
'/******************************************************************************

    On Error GoTo copyPositions_ERR
    
    If ID1 = ID2 Then Exit Function
    
    cn_data.BeginTrans

    Dim RS1 As New ADODB.Recordset
    Dim RS2 As New ADODB.Recordset
    
    RS1.Open "select * from position where posID = " & ID1, cn_data, adOpenForwardOnly, adLockOptimistic
    RS2.Open "select * from position where posID = " & ID2, cn_data, adOpenForwardOnly, adLockOptimistic
    
    
    
    
    If Not RS1.EOF And Not RS2.EOF Then
    
        RS1.MoveFirst
        RS2.MoveFirst
        
        RS2.fields("posName").Value = RS1.fields("posName").Value ' не используется
'        RS2.Fields("partID").Value = RS1.Fields("partID").Value ' остается старым
        RS2.fields("srtmID").Value = RS1.fields("srtmID").Value
        RS2.fields("muID").Value = RS1.fields("muID").Value
        RS2.fields("posQuantity").Value = RS1.fields("posQuantity").Value
        RS2.fields("matID").Value = RS1.fields("matID").Value
        RS2.fields("posUnitMass").Value = RS1.fields("posUnitMass").Value
        RS2.fields("posCommonMass").Value = RS1.fields("posCommonMass").Value
        RS2.fields("mcID").Value = RS1.fields("mcID").Value
        RS2.fields("numDigits").Value = RS1.fields("numDigits").Value
'        RS2.Fields("posNumber").Value = RS1.Fields("posNumber").Value ' остается старым
'        RS2.Fields("posIDold").Value = RS1.Fields("posIDold").Value ' не нужен
        RS2.fields("posUMCalc").Value = RS1.fields("posUMCalc").Value
        RS2.fields("posCMCalc").Value = RS1.fields("posCMCalc").Value
        RS2.fields("posSketch").Value = RS1.fields("posSketch").Value
        RS2.fields("posBarLength").Value = RS1.fields("posBarLength").Value
        
        RS2.Update
    
        RS1.NextRecordset
        RS2.NextRecordset
        
        RS1.Open "select * from r_position_property where posID = " & ID1, cn_data, adOpenForwardOnly, adLockOptimistic
        RS2.Open "select * from r_position_property where posID = " & ID2, cn_data, adOpenForwardOnly, adLockOptimistic
    
        If Not RS1.EOF Then ' если есть что копировать
        
            RS1.MoveFirst
            
            If Not RS2.EOF Then ' если есть куда копировать
                RS2.MoveFirst
            Else
                RS2.AddNew ' создаем запись куда копировать
                RS2.fields("posID").Value = ID2
            End If
            
            Dim i As Integer
            
            For i = 0 To RS1.fields.Count - 1
            
                If LCase(right(RS1.fields(i).Name, 2)) <> "id" Then
                    RS2.fields(i).Value = RS1.fields(i).Value
                End If
            
            Next i
            
            
            RS2.Update
        
        ElseIf Not RS1.EOF And Not RS2.EOF Then
        
        End If
    
    End If
    
    
    
    cn_data.CommitTrans
    
    
    RS1.Close
    RS2.Close
    
    Set RS1 = Nothing
    Set RS2 = Nothing
    
    copyPositions = True

    
Exit Function

copyPositions_ERR:
    cn_data.RollbackTrans
    Set RS1 = Nothing
    Set RS2 = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyPositions - Error"

End Function




'/******************************************************************************
Private Sub tbCmd_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************

    On Error GoTo tbCmd_ButtonClick_ERR


    Dim FG As VSFlexGrid
    
    Dim indexSrc As Integer
    Dim indexDst As Integer
    
    Dim objID_dst As Long
    Dim objectID_dst As Long
    
    Dim cCats As New Collection
    Dim cParts As New Collection
    
    Dim bBaseOk(0 To 1) As Boolean
    
    Dim fc As frmCopy

    
    
    If TypeOf Me.ActiveControl Is VSFlexGrid Then
        Set FG = Me.ActiveControl
        
        If Not FG.Name = "fgCmd" Then Exit Sub
        
        Dim objID As Long
        Dim objectID As Long
        
        indexSrc = FG.Index
        indexDst = Abs(CInt(Not CBool(FG.Index)))
        
        If Me.cmbCmd(indexSrc).text = "" Then Exit Sub
        If Me.cmbCmd(indexDst).text = "" Then Exit Sub
        
        Dim ar() As String
        Dim ar2() As String
        ar = Split(sCmdPath(indexDst), "|")
        If UBound(ar) > -1 Then
            ar2 = Split(ar(UBound(ar)), ":")
            If UBound(ar2) > -1 Then objID_dst = ar2(0)
            If UBound(ar2) > 0 Then objectID_dst = ar2(1)
        End If
        
        If objID_dst = 0 Or objectID_dst = 0 Then Exit Sub
        
        
        Dim i As Long
        For i = 1 To FG.Rows - 1
        
            If Not FG.IsSelected(i) Then GoTo cnt
        
            objID = Val(fgCmd(FG.Index).TextMatrix(i, 0))
            objectID = Val(fgCmd(FG.Index).TextMatrix(i, 1))
            
            If objID = 0 Or objectID = 0 Then GoTo cnt
            
            
            If objID = objs("catalog") Then
                Dim c As New clsCat
                c.catID = objectID
                c.catName = FG.TextMatrix(i, 3)
                cCats.Add c
                Set c = Nothing
            ElseIf objID = objs("part") Then
                Dim p As New clsPart
                p.partID = objectID
                p.partName = FG.TextMatrix(i, 3)
                cParts.Add p
                Set p = Nothing
            Else
            End If
            
            
cnt:
        Next i
        
        
        
        
        
        copyInfo.sBaseNameSrc = Me.cmbCmd(indexSrc).text
        copyInfo.sBaseNameDst = Me.cmbCmd(indexDst).text
        
        
        
        If cCats.Count > 0 And cParts.Count = 0 Then
        
            copyInfo.bLinks = False
            copyInfo.bLists = True
            copyInfo.bListContent = True
            copyInfo.bListRedirect = True
            copyInfo.bReinChilds = True
            
            
            If cCats.Count = 1 Then
                copyInfo.sOldCatName = fgCmd(FG.Index).TextMatrix(FG.Row, 3)
            Else
                copyInfo.sOldCatName = cCats.Count & " каталогов"
            End If
            
            copyInfo.sNewCatName = copyInfo.sOldCatName
            
            Set fc = New frmCopy
            
            fc.txtSrcName.text = copyInfo.sOldCatName
            fc.txtDstName.text = copyInfo.sNewCatName
            If cCats.Count > 1 Then fc.txtDstName.Enabled = False
            
            fc.lblSrc.Caption = Me.cmbCmd(indexSrc).text & " \ " & Me.lblCmd(indexSrc).Caption
            fc.lblDst.Caption = Me.cmbCmd(indexDst).text & " \ " & Me.lblCmd(indexDst).Caption
            
            
            If Not copyInfo.sBaseNameSrc = copyInfo.sBaseNameDst Then
                fc.chkLinks.Value = 0
                fc.chkLinks.Enabled = False
            End If
            
            fc.Show 1, Me
            
            If Not copyInfo.bOk Then Exit Sub
            
            If copyInfo.sBaseNameSrc = copyInfo.sBaseNameDst Then
                copyInfo.sBaseNameSrc = ""
                copyInfo.sBaseNameDst = ""
            End If
            
            bBaseOk(indexSrc) = conn.createNewConnection(copyInfo.cn_src, cmbCmd(indexSrc).text)
            bBaseOk(indexDst) = conn.createNewConnection(copyInfo.cn_dst, cmbCmd(indexDst).text)
            
            If bBaseOk(indexSrc) = False Or bBaseOk(indexDst) = False Then Exit Sub
            
            Dim catNewID As Long
            
            
            
            Dim ct As clsCat
            For Each ct In cCats
            
                catNewID = copyCatalog2(objectID_dst, objID_dst, ct.catID, , , , copyInfo.bReinChilds, ct.catName)
                
                setCatlistDefault ct.catID, catNewID
                
                If catNewID > 0 Then
                
                    ' добавление строчки в каталог назначения
                    Me.fgCmd(indexDst).AddItem objs("catalog") & vbTab & catNewID & vbTab & ct.catName & vbTab & ct.catName
        
                If bFormGridsIcons Then
                    If cattypes(copyInfo.catTypeID).ctEnum = ctRein Then
                        Me.fgCmd(indexDst).Cell(flexcpPicture, fgCmd(indexDst).Rows - 1, 3) = ImageList2.ListImages("reincat").ExtractIcon
                    Else
                        Me.fgCmd(indexDst).Cell(flexcpPicture, fgCmd(indexDst).Rows - 1, 3) = ImageList2.ListImages("catalog").ExtractIcon
                    End If
                End If
                    
                    If copyInfo.bSrcDstEqual Then ' добавление строчки в исходный каталог
                        Me.fgCmd(indexSrc).AddItem objs("catalog") & vbTab & catNewID & vbTab & ct.catName & vbTab & ct.catName
            
                        If bFormGridsIcons Then
                        If cattypes(copyInfo.catTypeID).ctEnum = ctRein Then
                            Me.fgCmd(indexSrc).Cell(flexcpPicture, fgCmd(indexSrc).Rows - 1, 3) = ImageList2.ListImages("reincat").ExtractIcon
                        Else
                            Me.fgCmd(indexSrc).Cell(flexcpPicture, fgCmd(indexSrc).Rows - 1, 3) = ImageList2.ListImages("catalog").ExtractIcon
                        End If
                        End If
                        
                    End If
        
                End If
                
                
            Next ct
        
        ElseIf cCats.Count = 0 And cParts.Count > 0 Then
        
            Set fc = New frmCopy
            
            If cParts.Count = 1 Then
                fc.txtSrcName.text = cParts(1).partName
                fc.txtDstName.text = cParts(1).partName
            Else
                fc.txtSrcName.text = cParts.Count & " изделий"
                fc.txtDstName.text = cParts.Count & " изделий"
            End If
            
            fc.lblSrc.Caption = Me.cmbCmd(indexSrc).text & " \ " & Me.lblCmd(indexSrc).Caption
            fc.lblDst.Caption = Me.cmbCmd(indexDst).text & " \ " & Me.lblCmd(indexDst).Caption
            
            fc.chkLinks.Value = 0
            fc.chkListContent.Value = 0
            fc.chkLists.Value = 0
            fc.chkRedirect.Value = 0
            fc.chkReinChilds.Value = 0
            
            fc.chkLinks.Enabled = False
            fc.chkListContent.Enabled = False
            fc.chkLists.Enabled = False
            fc.chkRedirect.Enabled = False
            fc.chkReinChilds.Enabled = False
            
            fc.txtDstName.Enabled = False
            
            fc.Show 1, Me
            
            If Not copyInfo.bOk Then Exit Sub
            
            bBaseOk(indexSrc) = conn.createNewConnection(copyInfo.cn_src, cmbCmd(indexSrc).text)
            bBaseOk(indexDst) = conn.createNewConnection(copyInfo.cn_dst, cmbCmd(indexDst).text)
            
            If bBaseOk(indexSrc) = False Or bBaseOk(indexDst) = False Then Exit Sub
            
            Dim prt As clsPart
            For Each prt In cParts
                '.......
            Next prt
        
        
        ElseIf cCats.Count > 0 And cParts.Count > 0 Then
            Exit Sub
        Else
            Exit Sub
        End If
        
        
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    End If


Exit Sub

tbCmd_ButtonClick_ERR:
    Me.SB.Panels("status").text = err.Description

End Sub


'/******************************************************************************
Public Function getCatWord(iQty As Integer) As String
'/******************************************************************************

    On Error GoTo getCatWord_ERR
    
    If iQty = 1 Then
        getCatWord = "каталог"
    ElseIf iQty >= 2 And iQty <= 4 Then
        getCatWord = "каталога"
    Else
        getCatWord = "каталогов"
    End If

Exit Function

getCatWord_ERR:

End Function

'/******************************************************************************
Public Sub tbOfftake_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************
    
    On Error GoTo tbOfftake_ButtonClick_ERR
    
    
    Select Case Button.KEY
        
        Case "Offtake"
            
'            If usrCurrent.trusted Then bOfftNew = True
            loadOfftake False
            
        Case "OfftVed"
        
            loadOfftakeVed True
            
        Case "Beton"
        
            loadOfftakeBet
            
        Case "Nulls"
        
'            loadOfftake False
            If iLastOfftMode = 1 Then
                loadOfftakeVed True
            ElseIf iLastOfftMode = 2 Then
                'loadOfftakeBet ' без реакции
            Else
                loadOfftake False
            End If
            
            
        Case "Excel"
        
            Dim sFileName As String
        
            Dim OFN As OPENFILENAME
            OFN.lStructSize = Len(OFN)
            OFN.hWndOwner = F1.hwnd
            OFN.hInstance = App.hInstance
            OFN.lpstrFilter = "Excel Files (*.xls)" + Chr$(0) + "*.xls" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
            OFN.lpstrFile = Space$(254)
            OFN.nMaxFile = 255
            OFN.lpstrFileTitle = Space$(254)
            OFN.nMaxFileTitle = 255
            OFN.lpstrInitialDir = CurDir
            OFN.lpstrTitle = "Сохранить файл"
            OFN.flags = 0
            Dim a
            a = GetSaveFileName(OFN)
            If (a) Then
                sFileName = LCase(Trim$(OFN.lpstrFile))
            Else
                Exit Sub
            End If
        
            If Asc(right(sFileName, 1)) = 0 Then sFileName = left(sFileName, Len(sFileName) - 1)
            
            If Not right(sFileName, 4) = ".xls" Then
                sFileName = sFileName & ".xls"
            End If
            
            fgOfftake.SaveGrid sFileName, flexFileExcel
        
        Case "Draw"
        
            Dim w As Double
            Dim oft As colOG
            
            
            loadOfftake False
            
            
            For Each oft In offts
                w = w + oft.getWidth
            Next oft
            
            Set oft = offts(1)
            
            goMS 0, dOfftHeadWidth + w + dOfftGlobalSumWidth, oft.getHeight(1, 6)
            
            
        Case "Print"
            
            fgOfftake.PrintGrid "Выборка - " & usrCurrent.strLogin & " - " & VBA.FormatDateTime(Now, vbGeneralDate), True, , 500, 500
            
            '            With vp
            '
            '                .StartDoc
            '                .Paragraph = "Here is the list"
            '                .RenderControl = fgOfftake.hwnd
            '                .EndDoc
            '
            '            End With
            
            
            
            
            
            
    End Select
    
    
    Exit Sub
    
tbOfftake_ButtonClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tbOfftake_ButtonClick - Error"
    
End Sub

'/******************************************************************************
Private Function addPartsInList() As Long
'/******************************************************************************
    
    
    
    On Error GoTo addPartsInList_ERR
    
    Dim cnt As Long
    Dim i As Integer
    Dim n As Node
    Dim ID As Long
    Dim sIDs As String
    Dim iMaxSort As Long
    Dim strSQL As String
    
    Dim prts As New Collection
    
    
    If lngCurCatListID = 0 Then Exit Function
    
    For i = 1 To tvParts.Nodes.Count
        
        Set n = tvParts.Nodes(i)
        
        If n.Checked Then
            
            If LCase(left(n.KEY, Len("part"))) = "part" Then
            
                Dim prt As New clsPart
                prt.partID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
                
                If Len(sIDs) > 0 Then sIDs = sIDs & ","
                sIDs = sIDs & CStr(prt.partID)
                
                prts.Add prt, CStr(prt.partID)
                
                Set prt = Nothing
                
            End If
            
        End If
        
    Next i
    
    If prts.Count = 0 Then Exit Function
    
    
    Dim RS As New ADODB.Recordset
    
    
    RS.Open "select max(partSortID) as mx from r_catlist_part where catlistID = " & lngCurCatListID, cn_data, adOpenForwardOnly, adLockReadOnly
    
    
    
    If Not RS.EOF Then
        RS.MoveFirst
        iMaxSort = Val(RS.fields("mx").Value & "")
    End If
    
    RS.NextRecordset
    
    RS.Open "select * from r_catlist_part where catlistID = " & lngCurCatListID & " and partID in (" & sIDs & ")", cn_data, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Set prt = prts(CStr(RS.fields("partID").Value))
            prt.partQty = RS.fields("partQty").Value
            prt.catIDold = 1 ' exists
            
            RS.MoveNext
        Loop Until RS.EOF
    Else
    End If
    
    RS.Close
    Set RS = Nothing
    
    
    
    For Each prt In prts
        If prt.catIDold = 0 Then
        
            iMaxSort = iMaxSort + 10
            
            If insertDataInBase(cn_data, "r_catlist_part", "catlistID", lngCurCatListID, "partID", prt.partID, "partQty", 1#, "partSortID", iMaxSort) Then cnt = cnt + 1
            
        Else
        
            ' update?...
        
        End If
        
    Next prt
    
    Set prts = Nothing
    
    addPartsInList = cnt
    
    
    
    Exit Function
    
addPartsInList_ERR:
    Set RS = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "addPartsInList - Error"
    
End Function




'/******************************************************************************
Private Sub tbOfftake_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)
'/******************************************************************************

    On Error GoTo tbOfftake_ButtonMenuClick_ERR

    Dim w As Double
    Dim oft As colOG
    

    Select Case ButtonMenu.KEY
        
        Case "Offt_st"

            loadOfftake False
            Exit Sub
        
        Case "Offt_in"

            loadOfftake False, True
            Exit Sub

        Case "InclChildren" ' Beton

            loadOfftakeBet True
            Exit Sub

        Case "Draw_st"
        
            loadOfftake False
            
        Case "Draw_in"
        
            loadOfftake True
            
        Case "NoPass"
        
            loadOfftakeVed False
            Exit Sub
            
    End Select
    
            
    For Each oft In offts
        w = w + oft.getWidth
    Next oft
    
    Set oft = offts(1)
    
    goMS 0, dOfftHeadWidth + w + dOfftGlobalSumWidth, oft.getHeight(1, 6)

            





Exit Sub

tbOfftake_ButtonMenuClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "tbOfftake_ButtonMenuClick - Error"

End Sub

Private Sub tbPart_ButtonClick(ByVal Button As MSComctlLib.Button)
    
    Dim ID As Long
    Dim ndNew As Node
    
    Dim n As Node
    
    Select Case Button.KEY
        Case "NewPart"
        
            If bCatIsBlocked Then Exit Sub
            
            Set ndNew = tvParts.Nodes.Add("root", tvwChild, "part0", strNewPartName, "part0")
            ndNew.Selected = True
            
            Dim p As New clsPart
            p.setCat lngCurCatID
            p.partName = strNewPartName
            p.partdefID = lngCurDefaultPartdefID
            p.partStatusID = pst.pstRazrabotka
'            p.partdefName = partdefs(p.partdefID).partdefName
            
            p.savePart
            
            ndNew.KEY = "part" & p.partID
            ndNew.Tag = "part"
            
            Set curPart = p
            
            tvParts.StartLabelEdit
            
        Case "ShowDeleted"
        
'            loadPartsTree lngCurCatID
            loadCatalog lngCurCatID, , , , , ctEmb
            
        Case "AddPos"
        
            If bCatIsBlocked Then Exit Sub
            
            fgPositions.AddItem "", fgPositions.Row
            fgPositions.RowHeight(fgPositions.Row) = 480
            fgPositions.Cell(flexcpFontBold, fgPositions.Row, 1, , 3) = True
            fgPositions.IsSubtotal(fgPositions.Row) = True
            
            fgPositions.Select fgPositions.Row, 0
'            fgPositions.EditCell
            fgPositionsStartEdit fgPositions.Row, 0, False
            
            
        Case "Reload"
        
'            loadPartsTree lngCurCatID
            loadCatalog lngCurCatID
            
        Case "Draw"
        
            Set n = tvParts.SelectedItem
            
            If n Is Nothing Then Exit Sub
            
            If left(n.KEY, 4) <> "part" Then Exit Sub
            
            ID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
        
            Dim f As New frmSpecParams
            If Len(f.txtTextHeight.text) = 0 Then f.txtTextHeight.text = 2.6
            If Len(f.txtTextWidth.text) = 0 Then f.txtTextWidth.text = 2.08
            If Len(f.txtTextScale.text) = 0 Then f.txtTextScale.text = 1#
            f.chkCommonMass.Value = 1
            f.Show 1, Me

            If Not f.bOk Then
                Set f = Nothing
                Exit Sub
            Else
                Set f = Nothing
            End If
                
            loadSpecPart ID
                
            goMS 1, spec.getWidth, spec.getHeight(True)
        
        Case "InList"
        
            Dim cnt As Long
            
            cnt = addPartsInList
            
            If mnuListSortAuto.Checked Then sortListInBaseProc
            
            loadListGrid lngCurCatListID
            
            If cnt > 0 Then Call writeOperationS(operModify, "catlist", lngCurCatListID, "добавление " & cnt & " изделий")
            
'        Case "EditPart"
'
'                If Button.Value = tbrPressed Then
'                    Set tt = New CBalloonToolTip
'                    tt.Icon = TTNoIcon
'                    tt.Title = "Подсказка"
'                    tt.PopupOnDemand = False
''                    tt.ForeColor = vbBlue
''                    tt.BackColor = &H80000018
'                    tt.Style = TTBalloon
'                    tt.TipText = "При нажатой кнопке возможно редактирование закладных изделий"
'                    tt.VisibleTime = 3000
'                    tt.DelayTime = 3000
'                    tt.CreateToolTip Me.hwnd
'                    tt.Show
'                    Timer2.Enabled = True
'                Else
'                    Set tt = Nothing
'                    Timer2.Enabled = False
'                End If
            
            
        Case "Collapsed"
            
                If Button.Value = tbrPressed Then
                    Set tt = New CBalloonToolTip
                    tt.Icon = TTNoIcon
                    tt.Title = "Подсказка"
                    tt.PopupOnDemand = False
'                    tt.ForeColor = vbBlue
'                    tt.BackColor = &H80000018
                    tt.Style = TTBalloon
                    tt.TipText = "При нажатой кнопке изделие открывается с развернутыми свойствами позиций"
                    tt.VisibleTime = 3000
                    tt.DelayTime = 3000
                    tt.CreateToolTip Me.hwnd
                    tt.Show
                    Timer2.Enabled = True
                Else
                    Set tt = Nothing
                    Timer2.Enabled = False
                End If
            
        Case Else
    End Select
    
    
    
    
    
    
    
End Sub

'/******************************************************************************
Private Sub tbPart_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)
'/******************************************************************************
    
    On Error GoTo tbPart_ButtonMenuClick_ERR
    
    
    If ButtonMenu.KEY = "simple" Then
    
        iPartTreeLevel = tlSimple
        loadCatalog lngCurCatID
    
    ElseIf ButtonMenu.KEY = "type" Then
        
        iPartTreeLevel = tlType
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "user" Then
        
        iPartTreeLevel = tlUser
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "sign" Then
    
        iPartTreeLevel = tlSign
        loadCatalog lngCurCatID
    
    ElseIf ButtonMenu.KEY = "signsheet" Then
    
        iPartTreeLevel = tlSignSheet
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "partlist" Then
    
        iPartTreeLevel = tlPartList
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "drawings" Then
    
        iPartTreeLevel = tlDrawings
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "stat" Then
    
        iPartTreeLevel = tlStatus
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "kks" Then
    
        iPartTreeLevel = tlKKS
        loadCatalog lngCurCatID
        
    ElseIf ButtonMenu.KEY = "filter" Then
    
        Load frmPartTreeFilter
        frmPartTreeFilter.Show 1, Me
        
        If frmPartTreeFilter.bOk Then loadCatalog lngCurCatID
    
    End If
    
    
     Call SaveSetting("Offtake2", "Size", "iPartTreeLevel", iPartTreeLevel)
    
    
    
    Exit Sub
    
tbPart_ButtonMenuClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tbPart_ButtonMenuClick - Error"
    
End Sub

'/******************************************************************************
Public Function openExcelDoc(bSave As Boolean) As String
'/******************************************************************************
    
    On Error GoTo openExcelDoc_ERR
    
    
    Dim sFileName As String
    
    Dim OFN As OPENFILENAME
    OFN.lStructSize = Len(OFN)
    OFN.hWndOwner = F1.hwnd
    OFN.hInstance = App.hInstance
    OFN.lpstrFilter = "Excel Files (*.xls)" + Chr$(0) + "*.xls" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    OFN.lpstrFile = Space$(254)
    OFN.nMaxFile = 255
    OFN.lpstrFileTitle = Space$(254)
    OFN.nMaxFileTitle = 255
    OFN.lpstrInitialDir = CurDir
    If bSave Then OFN.lpstrTitle = "Сохранить файл" Else OFN.lpstrTitle = "Открыть файл"
    OFN.flags = 0
    
    Dim a
    If bSave Then a = GetSaveFileName(OFN) Else a = GetOpenFileName(OFN)
    
    If (a) Then
        sFileName = LCase(Trim$(OFN.lpstrFile))
    Else
        Exit Function
    End If
    
    If Asc(right(sFileName, 1)) = 0 Then sFileName = left(sFileName, Len(sFileName) - 1)
    
    If Not right(sFileName, 4) = ".xls" Then
        sFileName = sFileName & ".xls"
    End If
    
    openExcelDoc = sFileName
    
    
    
    
'    If bSave Then
'        fgCatParts.SaveGrid sFileName, flexFileExcel
'    ElseIf usrCurrent.depID = 2 Then
'        Load frmSrtmLoad
'        frmSrtmLoad.FG.loadGrid sFileName, flexFileExcel
'        frmSrtmLoad.FG.RowHidden(0) = True
'        frmSrtmLoad.FG.RowHidden(1) = True
'        frmSrtmLoad.FG.RowHidden(2) = True
'        frmSrtmLoad.FG.RowHidden(3) = True
'        frmSrtmLoad.FG.RowHidden(4) = True
'        frmSrtmLoad.FG.RowHidden(5) = True
'        frmSrtmLoad.bLoadRein = True
''        frmSrtmLoad.fgLog.Visible = False
'        frmSrtmLoad.Show 0, Me
'
'        MsgBox "Выделите строчки загружаемых позиций и нажмите в меню 'Загрузить'" & vbNewLine & "При совпадении номеров позиции будут заменены!"
'
'    ElseIf usrCurrent.depID = 3 Then
'        Load frmSrtmLoad
'        frmSrtmLoad.FG.loadGrid sFileName, flexFileExcel
'        frmSrtmLoad.bLoadRein = True
''        frmSrtmLoad.fgLog.Visible = False
'        frmSrtmLoad.Show 0, Me
'    End If
    
    
    
    
    Exit Function
    
openExcelDoc_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "openExcelDoc - Error"
    
End Function


'/******************************************************************************
Private Sub tbRein_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************
    
    On Error GoTo tbRein_ButtonClick_ERR
    
    
    Dim RS As New ADODB.Recordset
    Dim RSS As ADODB.Recordset
    
    
    Dim stdID As Long
    Dim posdefID As Long
    Dim srtmID As Long
    Dim smName As String
    Dim matID As Long
    Dim stdpdID As Long
    Dim Row As Long
    Dim masslength As Double
    Dim ID As Long
    Dim i As Long
    Dim tr As Long
    
    Dim cmd As ADODB.Command
    
    Dim p As clsPos
    
    
    With fgCatParts
        
        Row = .Row
        
        
        Select Case Button.KEY
            
            Case "defaultpos"
            
                If Not getReinPos(Row, curPos, "tbRein_ButtonClick") Then Exit Sub
            
                Dim p1 As OfftPoint2D
                Dim p2 As OfftPoint2D
            
                
                If curPos.POS_SRTM.srtmID = 0 Then Exit Sub
                
                
                
                Set cmd = New ADODB.Command
                cmd.ActiveConnection = cn_data
                cmd.CommandText = "delete from [r_usr_reinpoints] where usrID = " & usrCurrent.usrID
                cmd.Execute
                Set cmd = Nothing
                
                
                
                RS.Open "select * from r_usr_rein where usrID = " & usrCurrent.usrID, cn_data, adOpenForwardOnly, adLockOptimistic
                
                If RS.EOF Then
                    RS.AddNew
                Else
                    RS.MoveFirst
                End If
                
                RS.fields("usrID").Value = usrCurrent.usrID
                RS.fields("posdefID").Value = curPos.POS_PD.pdID
                RS.fields("stdID").Value = curPos.POS_STD.stdID
                RS.fields("srtmID").Value = curPos.POS_SRTM.srtmID
                RS.fields("matID").Value = curPos.POS_MAT.matID
                RS.Update
                
                RS.Close
                Set RS = Nothing
                
                If curPos.pointsDraw.Count > 0 And curPos.pointsDraw.Count = curPos.pointsSkch.Count Then
                    
                    Set RSS = New ADODB.Recordset
                    
                    RSS.Open "select * from r_usr_reinpoints", cn_data, adOpenKeyset, adLockBatchOptimistic
                    
                    For i = 1 To curPos.pointsDraw.Count
                        p1 = curPos.pointsDraw(i)
                        p2 = curPos.pointsSkch(i)
                        
                        RSS.AddNew
                        RSS.fields("usrID").Value = usrCurrent.usrID
                        RSS.fields("xd").Value = p1.X
                        RSS.fields("yd").Value = p1.Y
                        If curPos.iMainLine + 1 = i Then RSS.fields("isMain").Value = True
                        RSS.fields("xs").Value = p2.X
                        RSS.fields("ys").Value = p2.Y
                        RSS.fields("isSketchOk").Value = True
                    Next i
                    
                    RSS.UpdateBatch
                    
                    RSS.Close
                    Set RSS = Nothing
                    
                End If
                
                
                tbRein.Buttons("defaultpos").Enabled = False
                
                setReinDefaultPos False, curPos.parentPart.catID, True
                
                checkReinButtons fgCatParts.Row, curPos
                
                
            Case "posok_shift"
            
                If Button.Value = tbrPressed Then
                    Set tt = New CBalloonToolTip
                    tt.Icon = TTNoIcon
                    tt.Title = "Подсказка"
                    tt.PopupOnDemand = False
'                    tt.ForeColor = vbBlue
'                    tt.BackColor = &H80000018
                    tt.Style = TTBalloon
                    tt.TipText = "Если нажата эта кнопка, то при вставке и удалении строки номера нижних позиций будут смещаться"
                    tt.VisibleTime = 3000
                    tt.DelayTime = 3000
                    tt.CreateToolTip Me.hwnd
                    tt.Show
                    Timer2.Enabled = True
                Else
                    Set tt = Nothing
                    Timer2.Enabled = False
                End If
            
            Case "posok_clear"
            
                If Me.tbRein.Buttons("posok_shift").Value = tbrPressed Then
                
                    Set p = New clsPos
                    
                    Set p.parentPart = New clsPart
                    p.parentPart.partName = CStr(Row)
                    p.parentPart.catID = lngCurCatID
'                    p.loadDefalts
                    colRein2.Add p, , Row
                    p.savePos
                    .AddItem "", Row
                    fgCatPartsSetRowData Row, p, True, True
                    
                    Set p = Nothing

                    fgCatPartsUpdatePosNumbersAll
                Else
                    mnuReinGridSetUnavailable_Click
                End If
            
            Case "posok"
                
                If Me.tbRein.Buttons("posok_shift").Value = tbrPressed Then
                
                    Set p = New clsPos
                    
                    Set p.parentPart = New clsPart
                    p.parentPart.partName = CStr(Row)
                    p.parentPart.catID = lngCurCatID
                    p.loadDefalts
                    colRein2.Add p, , Row
                    p.savePos
                    .AddItem "", Row
                    fgCatPartsSetRowData Row, p, True, True
                    
                    Set p = Nothing

                    fgCatPartsUpdatePosNumbersAll
                Else
                
                    If Not getReinPos(Row, curPos, "tbRein_ButtonClick") Then Exit Sub
                    
                    If curPos.POS_SRTM.srtmID = 0 Or curPos.bIsReinDefault Then
                        If curPos.POS_SRTM.srtmID = 0 Then curPos.loadDefalts
                        curPos.savePos
                        fgCatPartsSetRowData Row, curPos, True, True
                        
                        If curPos.bIsReinDefault Then
                            setReinDefaultPos True, curPos.parentPart.catID, True
                            Me.fgCatParts.Row = Me.fgCatParts.Rows - 1
                        End If
                    End If
                    
                    checkReinButtons fgCatParts.Row, curPos
                
                End If
                
                
            Case "Reload"
                
                Dim r As Long
                
                tr = fgCatParts.toprow
                r = fgCatParts.Row
                
'                loadPartsGrid lngCurCatID
                loadCatalog lngCurCatID
                
                fgCatParts.toprow = tr
                fgCatParts.Row = r
                
                
            Case "InList"
                
                If lngCurCatListID = 0 Then Exit Sub
                
'                If Not getBool(GetSetting("Offtake2", "Size", "CatsInListOk", False)) Then
'                    If MsgBox("   В новых версиях программы изменен принцип работы арматурных позиций со списками.   " & vbNewLine & _
'                            "   В список будет добавлены не позиции, а каталог. Это должно существенно упросить работу." & vbNewLine & _
'                            "   За более подробной информацией обращайтесь к Леониду, тел. 1418 (гор. 717-08-14)", vbOKCancel, "Информация") = vbCancel Then Exit Sub
'                    SaveSetting "Offtake2", "Size", "CatsInListOk", True
'                End If
                            
                
                
                RS.Open "select * from r_catlist_part where catlistID = " & lngCurCatListID & " and partID = " & lngCurCatID & " and objID = " & objs("catalog"), cn_data, adOpenForwardOnly, adLockOptimistic
                
                If RS.EOF Then
                    
                    RS.AddNew
                    RS.fields("catlistID").Value = lngCurCatListID
                    RS.fields("partID").Value = lngCurCatID
                    RS.fields("partQty").Value = 1
                    RS.fields("objID").Value = objs("catalog")
                    RS.Update
                    Call writeOperationS(operModify, "catlist", lngCurCatListID, "добавлен каталог " & selectStringFromBase(cn_data, "i_catalog", "catName", "catID", lngCurCatID))
                    
                    If mnuListSortAuto.Checked Then sortListInBaseProc
                    
                    loadListGrid lngCurCatListID
                    
                    
                End If
                
                RS.Close
                Set RS = Nothing
                
                
            Case "Draw"
                
                goReinSpec
                
                
            Case "Print"
                
                
                fgCatParts.PrintGrid "Арматура - " & selectStringFromBase(cn_data, "i_catalog", "catName", "catID", lngCurCatID) & _
                                     " - " & usrCurrent.strLogin & " - " & VBA.FormatDateTime(Now, vbGeneralDate), True, , 500, 500
                
            Case "Excel"
                Dim strFile As String
                strFile = openExcelDoc(True)
                If Len(strFile) > 0 Then fgCatParts.SaveGrid strFile, flexFileExcel
                
                
        End Select
        
        
        
        
    End With
    
    Exit Sub
    
tbRein_ButtonClick_ERR:
    SB.Panels("status").text = err.Description
    
End Sub

Sub loadSpec()
    
    
'    loadSpecParts False ' details
    
    
    loadSpecParts2

    
    
End Sub

'/******************************************************************************
Public Sub goReinSpec()
'/******************************************************************************

    On Error GoTo goSpec_ERR


    Dim f As New frmSpecParams
    If Len(f.txtTextHeight.text) = 0 Then f.txtTextHeight.text = 2.8
    If Len(f.txtTextWidth.text) = 0 Then f.txtTextWidth.text = 2.24
    If Len(f.txtTextScale.text) = 0 Then f.txtTextScale.text = 0.9
    
'    Dim nd As Node
'    Dim ID As Long
'    Dim prntID As Long
'    Set nd = tvGetTreeNode(tvCats, "catalog" & lngCurCatID)
'    If Not nd Is Nothing Then
'        If LCase(left(nd.Parent.KEY, Len("catalog"))) = "catalog" Then
'            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
'            prntID = Val(right(nd.Parent.KEY, Len(nd.Parent.KEY) - Len("catalog")))
'            If cattypes(cCats(CStr(ID)).catTypeID).ctEnum = ctRein And cattypes(cCats(CStr(prntID)).catTypeID).ctEnum = ctRein Then
'                f.chkCommonMass.Value = 1
'            End If
'        End If
'    End If
    
    f.Show 1, Me

    If Not f.bOk Then
        Set f = Nothing
        Exit Sub
    Else
        Set f = Nothing
    End If
    
    
    loadSpecRein False
    
    
    spec.createCmnSpecDrawStruct stRein, Format(fgCatParts.Aggregate(flexSTSum, 1, fgCatParts.ColIndex("cmass"), fgCatParts.Rows - 2, fgCatParts.ColIndex("cmass")), sFmt1)
    
    goMS 1, spec.getWidth, spec.getHeight(True)


Exit Sub

goSpec_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "goReinSpec - Error"

End Sub

Sub msImportSpec(bFromMain As Boolean)

    On Error GoTo err

    Dim bResume As Boolean
    Dim ar() As String
    Dim Arr() As String
    Dim i As Integer, ii As Integer, III As Integer
    Dim j As Integer
    
    Dim msapp As MicroStationDGN.Application
    
    Set msapp = getMS()
    
    If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
    
    Dim fnc As Fence
    Dim ee As ElementEnumerator
    Dim el As Element
    Dim tel As TextElement
    Dim lin As LineElement
    Dim SC As New ElementScanCriteria
    Dim t As clsTable, tt As clsTable, ttt As clsTable
    Dim f As clsObj, ff As clsObj, fff As clsObj
          
          
    With ActiveSettings
        .FenceClip = True
        .FenceOverlap = True
        .FenceVoid = False
    End With
    
    Set fnc = ActiveDesignFile.Fence
          
    If Not fnc.IsDefined Then
        sCommonMessage = "The fence is not defined"
        MsgBox sCommonMessage
        Exit Sub
    End If
          

    Set ee = fnc.GetContents()

'    sc.ExcludeAllTypes
'    sc.IncludeType msdElementTypeText
'    Set ee = ActiveModelReference.Scan(sc)


    Dim Col As New Collection
    Dim Col2 As New Collection
    Dim bAdd As Boolean
    Dim sKey As String, sKeyCol As String, sKeyRow As String, sText As String
    Dim iKey As Long
    Dim iDigs As Integer
    
    If iSpecImportRowHeight > 100 Then
        iDigs = -1
    Else
        iDigs = 0
    End If
    
    Do While ee.MoveNext
    
        Set el = ee.Current
        
'        If el.FilePosition = 4000108 Then
'        Debug.Print ""
'        End If
'        If el.FilePosition = 4000109 Then
'        Debug.Print ""
'        End If
        
        sText = ""
    
        If el.IsLineElement Then
        
            Set lin = el.AsLineElement
            
            sKeyRow = Format(CLng(roundShaman((lin.StartPoint.Y + lin.EndPoint.Y) / 2, iDigs)), "000000000000000")
            sKey = sKeyRow & "|000000000000000"
            
            If Abs(lin.StartPoint.Y - lin.EndPoint.Y) < iSpecImportRowHeight / 50 Then
                sText = "!line!"
            End If
            
        ElseIf el.IsTextElement Then
   
            Set tel = el.AsTextElement
            
            sKeyRow = Format(CLng(roundShaman(tel.origin.Y, iDigs)), "000000000000000")
            sKeyCol = Format(CLng(roundShaman(tel.origin.X, iDigs)), "000000000000000")
            sKey = sKeyRow & "|" & sKeyCol
            
            sText = Trim(tel.text)
            
        End If
        
        If Len(sText) > 0 Then
        
            Dim a As Integer
            a = InStr(sText, "L=")
            If a > 0 Then
                sText = Mid(sText, a)
            End If
        
'            ar() = Split(sText, " ")
            
'           For I = 0 To UBound(ar)
            
'                If Len(Trim(ar(I))) > 0 Then
                
'                    Set f = getColItem(Col, sKey & "-" & CStr(I))
                    Set f = getColItem(Col, sKey)
                    
                    If f Is Nothing Then
                        Set f = New clsObj
'                        f.KEY = sKey & "-" & CStr(I)
                        f.KEY = sKey
'                        f.ctable = ar(I)
                        f.ctable = sText
                        bAdd = True
                    Else
                        bAdd = False
                    End If
                        
            
                    If bAdd Then
                        Col.Add f, f.KEY
                    End If
                    
                    Set f = Nothing
                    
'                End If
'            Next
        
            
        End If
        
        

    Loop
    
    
    
    
    If Col.Count = 0 Then
        MsgBox "Не найдено элементов для импорта"
    End If

    
    Set Col = sortCollection(Col) ' prepare with string sort
    
    
    Dim bNewLevel As Boolean
    bNewLevel = True
    Set t = Nothing
    
    
    
    For Each fff In Col
        
        ar = Split(fff.KEY, "|")
        
        If fff.ctable = "!line!" Then
        
            bNewLevel = True
            Set t = Nothing
            
        Else
        
            If bNewLevel Then
                Set t = New clsTable
                t.KEY = CLng(Val(ar(0))) ' KEY type is long for sort
                Col2.Add t
            Else
                ' use existing t
            End If
            
'            arr = Split(ar(1), "-")
            
'            iKey = CLng(Val(arr(0)))
            iKey = CLng(Val(ar(1)))
            
'            If UBound(arr) > 0 Then
'                iKey = iKey + CLng(Val(arr(1)))
'            End If

            Set tt = New clsTable
            tt.sTableName = fff.ctable
            tt.KEY = iKey ' KEY type is long
            bResume = True
            t.cols.Add tt, CStr(iKey) ' need key?
            bResume = False
            Set tt = Nothing
            
            bNewLevel = False
            
        End If
        
        
    Next
    
    
    Set Col2 = sortCollection(Col2) ' long sort
    
    For Each ttt In Col2
        Set ttt.cols = sortCollection(ttt.cols) ' long sort
    Next
    
    
    
    ' load form
    If bFromMain Then Load FLog
    FLog.Caption = "Импорт спецификации из MicroStation"
    FLog.fgLog.cols = 10
    FLog.fgLog.Rows = 1
    
    FLog.fgLog.TextMatrix(0, 1) = "Номер"
    FLog.fgLog.TextMatrix(0, 2) = ""
    FLog.fgLog.TextMatrix(0, 3) = ""
    FLog.fgLog.TextMatrix(0, 4) = "Длина"
    FLog.fgLog.TextMatrix(0, 5) = "Кол-во"
    FLog.fgLog.TextMatrix(0, 6) = "Мас ед"
    FLog.fgLog.TextMatrix(0, 7) = "Мас общ"
    
    FLog.fgLog.ColDataType(0) = flexDTBoolean


    FLog.fgLog.ColAlignment(1) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(2) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(3) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(4) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(5) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(6) = flexAlignLeftCenter
    FLog.fgLog.ColAlignment(7) = flexAlignLeftCenter

    FLog.fgLog.ColKey(0) = "save"
    FLog.fgLog.ColKey(1) = "num"
    FLog.fgLog.ColKey(2) = "sketch"
    FLog.fgLog.ColKey(3) = "name"
    FLog.fgLog.ColKey(4) = "length"
    FLog.fgLog.ColKey(5) = "qty"
    FLog.fgLog.ColKey(6) = "umass"
    FLog.fgLog.ColKey(7) = "cmass"
    
    FLog.fgLog.ColKey(9) = "row" ' row num in fgCatParts
    FLog.fgLog.ColHidden(9) = True
    
    FLog.fgLog.AddItem GetSetting("Offtake2", "SpecDgnImport", "formatstring", _
            "" & vbTab & "-" & vbTab & "-" & vbTab & "-" & vbTab & "+" & vbTab & "+" & vbTab & "+" & vbTab & "+")
    
    FLog.fgLog.FrozenRows = 1
    
    FLog.fgLog.Editable = flexEDKbdMouse
    
    
    
    Dim p As clsPos
    Dim bFound As Boolean
    Dim Row As Long
    
    For III = Col2.Count To 1 Step -1
        
        Set t = Col2(III)
        
        While t.cols.Count > 7
            t.cols.Remove 2
        Wend
        
        If t.cols.Count < 4 Then GoTo cont
        
        While t.cols.Count < 7
            Set tt = New clsTable
            t.cols.Add tt, , , 1
        Wend
        
        Dim strToAdd As String
        FLog.fgLog.AddItem "true" ' галка
    
        For j = 1 To t.cols.Count
        
            bResume = False
            
            Set tt = t.cols(j)
        
            If j = t.cols.Count Or j = t.cols.Count - 1 Or j = t.cols.Count - 2 Then ' cmass, umass, qty
                FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, j) = getDbl(tt.sTableName)
                If getDbl(tt.sTableName) = 0 Then
                    'FLog.fgLog.Cell(flexcpBackColor, FLog.fgLog.Rows - 1, 0, , FLog.fgLog.cols - 1) = lngLightRed
                    FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, 0) = False ' galka off
                End If
            ElseIf j = t.cols.Count - 3 Then ' length
                FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, j) = Val(Replace(tt.sTableName, "L=", "", , , vbTextCompare))
            ElseIf j = 1 Then ' pos num (part name), первое поле
            
                bFound = False
                If Not colRein2 Is Nothing Then
                    For Each p In colRein2
                        If CLng(Val(p.parentPart.partName)) = CLng(Val(Trim(tt.sTableName))) And CLng(Val(Trim(tt.sTableName))) > 0 Then
                            FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, j) = CLng(Val(Trim(tt.sTableName)))
                            bFound = True
                            Exit For
                        End If
                    Next p
                End If
            
                If p Is Nothing Or bFound = False Then
                    FLog.fgLog.Cell(flexcpBackColor, FLog.fgLog.Rows - 1, 0, , FLog.fgLog.cols - 1) = lngLightRed
                    FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, 0) = False
                ElseIf p.getPartID > 0 Then
                
                    FLog.fgLog.RowData(FLog.fgLog.Rows - 1) = p.getPartID
                    
                    ' находим строку
                    FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, FLog.fgLog.ColIndex("row")) = 0
                    For ii = 1 To fgCatParts.Rows - 1
                        If CLng(fgCatParts.TextMatrix(ii, fgCatParts.ColIndex("partID"))) = p.getPartID Then
                            FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, FLog.fgLog.ColIndex("row")) = ii
                            Exit For
                        End If
                    Next ii
                    
                Else
                    FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, 0) = False ' galka off
                End If
            
            Else
                bResume = True
                FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, j) = tt.sTableName
                bResume = False
            End If
        
        
        Next
        
        
        If t.cols.Count < 7 Then
            FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, 0) = False
        End If
            
'       FLog.fgLog.AddItem strToAdd
'       FLog.fgLog.TextMatrix(FLog.fgLog.Rows - 1, 7) = "true"
            
cont:
        
    Next
    
    FLog.fgLog.AutoSize 0, FLog.fgLog.cols - 1
    
    If bFromMain Then FLog.Show , Me
    
    
    Exit Sub
err:
    
    If bResume Then Resume Next
    
    If MsgBox(err.Description & vbNewLine & "Продолжаем?", vbYesNo) = vbYes Then Resume Next

End Sub


'/******************************************************************************
Private Sub tbRein_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)
'/******************************************************************************
    
    On Error GoTo tbRein_ButtonMenuClick_ERR
    
    Dim strFile As String
    
    Select Case ButtonMenu.KEY
        
        Case "specimp"
        
            msImportSpec True
        
        Case "ExcelSave"
            
            strFile = openExcelDoc(True)
            If Len(strFile) > 0 Then fgCatParts.SaveGrid strFile, flexFileExcel
            
        Case ""
            
            strFile = openExcelDoc(False)
            
            If Len(strFile) > 0 Then

                fgExcel.loadGrid strFile, flexFileExcel
                
                loadReinPositions fgExcel, ButtonMenu.Tag
                
                loadCatalog lngCurCatID
            
            End If
            
        Case "spec"
            
            goReinSpec
            
        Case "ved"
        
            Load frmSketch
            
            frmSketch.bSaveSketchSettings = True
            
            frmSketch.Frame4.Move 120, 1080
            frmSketch.Frame4.Visible = True
            
            frmSketch.Frame3.Visible = False
            
            loadSpecRein True
            
            frmSketch.Show 1, Me
            
            If Not bFormOk Then Exit Sub
            
            
            Dim hgtLn As Double
            Dim hgtCmn As Double
            Dim colcnt As Integer
            Dim i As Long
            
            colcnt = 1
            
            For i = 1 To spec.cSpParts.Count
                
                hgtLn = hgtLn + iSketchCellHeight
                
                If hgtLn > iSketchMaxHeight Then
                    i = i - 1
                    hgtCmn = hgtLn - iSketchCellHeight
                    hgtLn = 0#
                    colcnt = colcnt + 1
                End If
                
                
            Next i
            
            If hgtCmn = 0 Then hgtCmn = hgtLn
            
            
            
            If spec.cSpParts.Count > 0 Then
                goMS 2, CDbl(iSketchCellWidth * 1.2 * colcnt), hgtCmn
            End If
            
        Case "sketch"
        
            mnuReinGridDrawSketch_Click
            
            
    End Select
    
    Exit Sub
    
tbRein_ButtonMenuClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tbRein_ButtonMenuClick - Error"
    
End Sub

Private Sub tbSimData_Click()
    If Not Config.LastTabIndex = tbSimData.CurrTab Then
        Config.checkTabViewErrors (tbSimData.CurrTab)
        Config.LastTabIndex = tbSimData.CurrTab
    End If
    
    tbWise.Buttons("Update").Enabled = (tbSimData.CurrTab = 0)
    
End Sub

'/******************************************************************************
Private Sub tbSpec_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************

    On Error GoTo tbSpec_ButtonClick_ERR

    Select Case Button.KEY
        
        Case "refresh"
        
            loadSpec
'            loadOfftake
        
        Case "Print"
            
             fgSpec.PrintGrid "Спецификация - " & usrCurrent.strLogin & " - " & VBA.FormatDateTime(Now, vbGeneralDate), True, , 500, 500

        Case "Excel"
        
            Dim sFileName As String
        
            Dim OFN As OPENFILENAME
            OFN.lStructSize = Len(OFN)
            OFN.hWndOwner = F1.hwnd
            OFN.hInstance = App.hInstance
            OFN.lpstrFilter = "Excel Files (*.xls)" + Chr$(0) + "*.xls" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
            OFN.lpstrFile = Space$(254)
            OFN.nMaxFile = 255
            OFN.lpstrFileTitle = Space$(254)
            OFN.nMaxFileTitle = 255
            OFN.lpstrInitialDir = CurDir
            OFN.lpstrTitle = "Сохранить файл"
            OFN.flags = 0
            Dim a
            a = GetSaveFileName(OFN)
            If (a) Then
                sFileName = LCase(Trim$(OFN.lpstrFile))
            Else
                Exit Sub
            End If
        
            If Asc(right(sFileName, 1)) = 0 Then sFileName = left(sFileName, Len(sFileName) - 1)
            
            If Not right(sFileName, 4) = ".xls" Then
                sFileName = sFileName & ".xls"
            End If
            
            fgSpec.SaveGrid sFileName, flexFileExcel
        
        
        Case "Draw"
        
    
'            Dim asd As String
'            asd = InputBox("Максимальное количество строк на одну секцию", "Параметр спецификации", lngSpecDefaultRows)
'            If Len(Trim(asd)) = 0 Then Exit Sub
'            If Val(Trim(asd)) < 5 Then Exit Sub
'            lngSpecDefaultRows = Val(Trim(asd))

            If spec Is Nothing Then Exit Sub
            If spec.cSpParts Is Nothing Then Exit Sub
            If spec.cSpParts.Count = 0 Then Exit Sub
            
            Dim f As New frmSpecParams
            If Len(f.txtTextHeight.text) = 0 Then f.txtTextHeight.text = 3#
            If Len(f.txtTextWidth.text) = 0 Then f.txtTextWidth.text = 2.4
            If Len(f.txtTextScale.text) = 0 Then f.txtTextScale.text = 0.8
            f.chkCommonMass.Enabled = False
            f.Show 1, Me

            If Not f.bOk Then
                Set f = Nothing
                Exit Sub
            Else
                Set f = Nothing
            End If
            
            
            
            spec.createCmnSpecDrawStruct stList
            
            goMS 1, spec.getWidth, spec.getHeight(True)
    
        
    End Select



Exit Sub

tbSpec_ButtonClick_ERR:
    If err.Description = "Automation error" Then Exit Sub
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tbSpec_ButtonClick - Error"

End Sub



Private Sub tbSpec_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)


    On Error GoTo tbSpec_ButtonClick_ERR

    Select Case ButtonMenu.KEY
        
        Case "all_emb"
        
            fgSpec.Rows = 1
            
            Dim strSQL As String
            
            strSQL = "select partID,partName as [Наименование], partDescr as [Обозначение], sum(qty) as [Кол-во], isrunmet as [пог.м.],''"
            strSQL = strSQL & " from dbo.gospec1(" & lngCurCatListID & ", 14, 1) group by partID,partName,partDescr,isrunmet"
            strSQL = strSQL & " order by [Наименование]"
            
            Dim RS As New ADODB.Recordset
            RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
                        
        
            Set fgSpec.DataSource = RS
            
            fgSpec.ColHidden(0) = True
            
            Dim Row As Long
            For Row = 1 To fgSpec.Rows - 1
'                If CBool(fgSpec.TextMatrix(row, fgSpec.ColIndex("rm"))) Then
                    fgSpec.TextMatrix(Row, fgSpec.ColIndex("Кол-во")) = getDbl(Format(fgSpec.TextMatrix(Row, fgSpec.ColIndex("Кол-во")), "0.00"))
'                Else
'                    fgSpec.TextMatrix(row, fgSpec.ColIndex("Кол-во")) = Format(fgSpec.TextMatrix(row, fgSpec.ColIndex("Кол-во")), "0")
'                End If
            Next Row
      
        
    End Select


Exit Sub

tbSpec_ButtonClick_ERR:
    If err.Description = "Automation error" Then Exit Sub
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tbSpec_ButtonClick - Error"


End Sub

Private Sub tbSrtm_ButtonClick(ByVal Button As MSComctlLib.Button)
    
    Select Case Button.KEY
        
        Case "Load"
            
            
            If Not checkGroupPerm(usrCurrent.groupID, "material", operModify) Then
                Exit Sub
            End If
            
            mnuSrtmLoad_Click
            
        Case "Reload"
        
            Me.loadSrtmTree
            
        Case "NewPosdef"
        
            If Not usrCurrent.trusted Then Exit Sub
        
        
            Load frmPosdef
            frmPosdef.Show 1, Me
            
            
        Case "Stds"
        
'            If Not usrCurrent.trusted Then Exit Sub
            
            Dim nd As Node
            Set nd = tvSrtm.SelectedItem
            
        
        
            Load frmStds
            
            Dim ID As Long
            ID = 0
            
            If Not nd Is Nothing Then
            
                If nd.Tag = "posdef" Then
            
                    ID = Val(right(nd.KEY, Len(nd.KEY) - Len(nd.Tag)))

                    If ID > 0 Then
                        frmStds.Toolbar1.Buttons("AddToPosDef").Visible = usrCurrent.trusted
                        frmStds.Toolbar1.Buttons("AddToPosDef").Caption = "Добавить к '" & nd.text & "'"
                        frmStds.Tag = ID
                    Else
                        frmStds.Toolbar1.Buttons("AddToPosDef").Visible = False
                    End If
                    
                End If
                
            
            End If
            
            
            
            
            
            frmStds.Show 1, Me
            
            
            
        Case "Mats"
        
'            If Not usrCurrent.trusted Then Exit Sub
            
            Load frmMats
            frmMats.Show 1, Me
            
'        Case "Docsets"
'
'            Dim frm As New frmDocSet
'            frm.btnSet.Enabled = False
'            frm.Show 1, Me
        
    End Select
    
    
End Sub

''/******************************************************************************
'Private Function getString(iValue As Variant) As String
''/******************************************************************************
'
'    'On Error GoTo getString_ERR
'
'        If typeName(iValue) = "String" Then
'            getString = "'" & Trim(iValue) & "'"
'        ElseIf typeName(iValue) = "Integer" Or typeName(iValue) = "Long" Or typeName(iValue) = "Double" Then
'            getString = Trim(str(iValue))
'        Else
'            getString = iValue
'        End If
'
'
'
'Exit Function
'
'getString_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "getString - Error"
'
'End Function

'/******************************************************************************
Public Function updateOrInsertTableInBase(conn As ADODB.Connection, _
                                          strTable As String, _
                                          strField As String, _
                                          fieldValue As Variant, _
                                          strWhere As String, _
                                          whereValue As Variant) As Boolean
'/******************************************************************************

    On Error GoTo updateOrInsertTableInBase_ERR


                                          
                                          
                                          
    
    Set RSSev = New ADODB.Recordset
    
    RSSev.Open "select " & strWhere & "," & strField & " from " & strTable & " where " & strWhere & " = " & getString(whereValue), conn, adOpenForwardOnly, adLockOptimistic
    
    If RSSev.EOF Then
        RSSev.AddNew
        RSSev.fields(strWhere).Value = whereValue
    Else
        RSSev.MoveFirst
    End If
    
    RSSev.fields(strField).Value = fieldValue
    
    RSSev.Update
    
    RSSev.Close
    Set RSSev = Nothing
    
    updateOrInsertTableInBase = True
    
    
Exit Function

updateOrInsertTableInBase_ERR:
    updateOrInsertTableInBase = False

End Function



'BeginUpdateBatchVB
Public Sub MainUpdateBatchSample()
    On Error GoTo ErrorHandler

    'To integrate this code
    'replace the data source and initial catalog values
    'in the connection string

    'connection and recordset variables
    Dim RS As ADODB.Recordset
    Dim strCnxn As String
    Dim strTable As String
     'record variables
    Dim strTitle As String
    Dim strMessage As String
    

    
     ' open recordset for batch uodate
    Set RS = New ADODB.Recordset
    strTable = "r_position_property"
    RS.Open strTable, cn_data, adOpenKeyset, adLockBatchOptimistic, adCmdTable
    
    RS.MoveFirst
    ' Loop through recordset and ask user if she wants
    ' to change the type for a specified title.
    Do Until RS.EOF
        ' change records...
    
        RS.MoveNext
    Loop
    
    ' Ask the user if she wants to commit to all the
    ' changes made above.
    If MsgBox("Save all changes?", vbYesNo) = vbYes Then
        RS.UpdateBatch
    Else
        RS.CancelBatch
    End If
    
    ' Print current data in recordset.
    RS.Requery
    RS.MoveFirst
    Do While Not RS.EOF
        Debug.Print RS!Title & " - " & RS!Type
        RS.MoveNext
    Loop
    


    ' clean up
    RS.Close
    
    Set RS = Nothing
    
    Exit Sub
    
ErrorHandler:
    ' clean up
    If Not RS Is Nothing Then
        If RS.State = adStateOpen Then RS.Close
    End If
    Set RS = Nothing
    

    
    If err <> 0 Then
        MsgBox err.source & "-->" & err.Description, , "Error"
    End If
End Sub
'EndUpdateBatchVB

Private Sub Toolbar2_ButtonClick(ByVal Button As MSComctlLib.Button)

End Sub



Private Sub Toolbar6_ButtonClick(ByVal Button As MSComctlLib.Button)

End Sub

'/******************************************************************************
Private Sub tbSrtm_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)
'/******************************************************************************

    On Error GoTo tbSrtm_ButtonMenuClick_ERR

    
    If ButtonMenu.KEY = "LoadSrtm" Then
    
        If Not CBool(bDontUseSplash) Then
            Set frmSps = New frmSplash
            frmSps.Show 0, Me
            loadBaseData frmSps.lblStatus
            Set frmSps = Nothing
        Else
            loadBaseData Nothing
        End If
        
        Me.loadSrtmTree
    
    End If
    
Exit Sub

tbSrtm_ButtonMenuClick_ERR:
Set frmSps = Nothing

End Sub


Public Sub reloadData2()


    If pwset.ispwdb Then
        reloadWise
    Else
        reloadTech
    End If


End Sub



'/******************************************************************************
Public Sub reloadWise()
'/******************************************************************************

    On Error GoTo reloadWise_ERR


    tvWise.Visible = False
    
    tvWise.Nodes.Clear


    Dim cn As New ADODB.Connection
    
    cn.Open pwset.constring, pwset.login, pwset.login

    Dim RS As New ADODB.Recordset
    Dim nd As Node
    Dim ndPlus As Node
    Dim strSQL As String
    
    strSQL = "select * from dms_proj "
    strSQL = strSQL & "where o_parentno = " & pwset.root
    
    If Len(pwset.sql_filter) > 0 And left(pwset.sql_filter, 2) = "('" And right(pwset.sql_filter, 2) = "')" Then
        strSQL = strSQL & " and o_projectname in " & pwset.sql_filter
    End If
    
    strSQL = strSQL & " order by o_projectname"
    
    RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Set nd = tvWise.Nodes.Add(, , "wise" & RS.fields("o_projectno").Value, RS.fields("o_projectname").Value, "project")
            
            nd.Tag = 0 ' tree level
            nd.Expanded = isWiseNodeExpanded(nd.KEY)
            
            If nd.Expanded Then
                loadTreeNodeWise nd
            Else
                Call addTreeNode(tvWise, ndPlus, nd.KEY, tvwChild, nd.KEY & "+", "", "")
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    
    End If
    
    tvWise.Visible = True

    RS.Close
    Set RS = Nothing

    cn.Close
    Set cn = Nothing

Exit Sub

reloadWise_ERR:
    F1.SB.Panels("status").text = "reloadWise" & "() - " & err.Description
    tvWise.Visible = True

End Sub


'/******************************************************************************
Private Sub tbWise_ButtonClick(ByVal Button As MSComctlLib.Button)
'/******************************************************************************
    
    On Error GoTo tbWise_ButtonClick_ERR ' ec
    
    Dim oExcel As Object 'As Excel.Application
    Dim FlCloseExcel As Boolean: FlCloseExcel = True
    Dim oBook As Object  ' As Excel.Workbook '
    Dim oSheet As Object 'As Excel.Worksheet
    Dim rng As Object ' As Excel.Range '
    
    Dim RegExp As RegExp: Set RegExp = New RegExp
    
    Dim sqlq$, n%, r%, rr%, c%, cc%, i%, j%
    
    Dim cn As ADODB.Connection
    Dim RS2 As ADODB.Recordset
    
    Dim fso As New FileSystemObject
    
    Dim DataArray() As Variant
    Dim Arr() As String
    Dim Coll_HMarks As Dictionary 'колллекция отметок
    Dim RemProvider As String
    
    '    Dim specID As Long
    '    specID = selectLongFromBase(cn_data, "i_project", "specID", "projectID", lngCurProjectID)
    '    setSpecConfig specID
    
    
    If Button.KEY = "Reload" Then 'Перезагрузить дерево
        
        reloadData2
        
    ElseIf Button.KEY = "Update" Then 'Обновить
        
        If tbSimData.CurrTab > 0 Then
            Exit Sub ' не файлы
        End If
        
        If usrCurrent.groupID > 1 And getQueueCnt() > 20 Then
            MsgBox "   Очередь документов превышает допустимое количество. Пожалуйста, сделайте обновление позже.  ", vbExclamation, ""
            Exit Sub
        End If
        
        Dim Item As ListItem, pwid$, strguids$
        strguids = ""
        For Each Item In lvWise.ListItems
            If Item.Checked Then
                pwid = Replace(Item.KEY, "item", "")
                strguids = strguids & "'" & pwid & "',"
            End If
        Next
        If Len(strguids) > 0 Then strguids = left(strguids, Len(strguids) - 1)
        
        Dim dcnt%: dcnt = UBound(Split(strguids, ",")) 'кол-во документов
        If dcnt > 5 Then
            Select Case MsgBox("Вы собираетесь поставить на обновление " & dcnt & _
                        " документ(а/ов). Это может занять значительное время, подтвердить?", vbYesNo + vbExclamation, "Project Wise Update")
                Case vbNo
                    Exit Sub
            End Select
        End If
        
        sqlq = "update aep_docdata set last_state = '' where docguid in (" & strguids & ")"
        
        Set cn = New ADODB.Connection
        cn.Open pwset.constring, pwset.login, pwset.login
        cn.Execute sqlq
        
        For Each Item In lvWise.ListItems
            If Item.Checked Then
                Item.SubItems(2) = "в очереди"
            End If
        Next
        
    ElseIf Button.KEY = "Excel" Then
        'экспорт в Excel
        Call exportExcel
        
    ElseIf Button.KEY = "Word" Then
        Call exportWord
    ElseIf Button.KEY = "Micro" Then
    
'        Dim flags As MsdTransientFlags
'        Set tec1 = CreateTransientElementContainer1(Nothing, flags, msdViewMaskAllViews, msdDrawingModeNormal)



        Dim hwnd As Long
        Dim hwnd2 As Long
        hwnd = FindWindow("MstnTop", vbNullString)
            
        If hwnd = 0 Then
            MsgBox "Не удалось обнаружить запущенное прилоежение для размещения таблицы" & vbNewLine & _
                    "Запустите приложение платформы MicroStation, откройте файл, затем заново запустите команду", vbExclamation
                    
            Exit Sub
        End If
        
        Dim msapp As Object
        Set msapp = getMS
        If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
        
        hwnd2 = getMSWindowH(msapp)

        If hwnd2 > 0 Then hwnd = hwnd2
        
'        If Not msapp Is Nothing Then msapp.Quit: Set msapp = Nothing

        Me.MousePointer = 11
        
        Set spec = New clsSG
    
        If getSpecParams(curSpecCfg) Then
            
            Me.MousePointer = 0
            
            If MsgBox("После нажатия кнопки ОК Вы будете переведены в приложение для размещения таблицы" & vbNewLine & _
                    "Укажите левую верхнюю точку таблицы нажатием левой кнопки мыши", vbOKCancel, "") = vbCancel Then Exit Sub
            
            Dim rtc As Long
            rtc = SetForegroundWindow(hwnd)
            loadSpecWise spec
        Else
        
            Me.MousePointer = 0
        
            MsgBox "Не удалось получить параметры шаблона таблицы" & vbNewLine & "Для решения проблемы обратитесь к администраторам", vbCritical, ""
            Exit Sub
        End If
    
'        Dim f As New frmSpecParams
'
'        f.cmbSpecConfig.Enabled = False
'
'        f.Frame2.Visible = False ' Хвать
'        f.Frame3.Visible = False ' Арматура
'        f.Frame4.Visible = False ' параметры тексте
'
'        f.chkDrawCap.Value = 1: f.chkDrawCap.Enabled = False
'        f.chkCommonMass.Value = 1: f.chkCommonMass.Enabled = False
'        f.chkRows.Value = 0: f.chkRows.Enabled = False
'
'        f.txtSpecScale.text = "1": f.txtSpecScale.Enabled = False
'
'        f.txtSpecRows.text = "": f.txtSpecRows.Enabled = False: f.Label1.Enabled = False
'        f.txtFirstRows.text = "": f.txtFirstRows.Enabled = False: f.Label4.Enabled = False
'        f.txtLastRows.text = "": f.txtLastRows.Enabled = False: f.Label2.Enabled = False
'
'        Me.MousePointer = 0
'
'        f.btnOK.Caption = "Указать точку"
'
'        f.Show 1, Me
'
'        If Not f.bOk Then
'            Set f = Nothing
'            Exit Sub
'        Else


            
'            msapp.MessageCenter.AddMessage "Укажите точку размещения таблицы", , msdMessageCenterPriorityInfo, True
            

'            Set f = Nothing
'        End If
        
        
        
        
        
        
        
        
        


            
'        goMS 1, spec.getWidth, spec.getHeight(True)
    
        
    'ElseIf Button.KEY = "OpenModel" Then
        
    End If
    
LCancel:
    If FlCloseExcel And Not oExcel Is Nothing Then
        Set rng = Nothing
        Set oSheet = Nothing
        Set oBook = Nothing
        oExcel.DisplayAlerts = False
        oExcel.Quit
        Set oExcel = Nothing
    End If
    If Not RS2 Is Nothing Then
        RS2.Close: Set RS2 = Nothing
    End If
    If Not cn Is Nothing Then
        cn.Close: Set cn = Nothing
    End If
    
    Exit Sub
    
tbWise_ButtonClick_ERR:
    Me.MousePointer = 0
    F1.SB.Panels("status").text = "tbWise_ButtonClick" & "() - " & err.Description
End Sub


Sub gogoRS(iStartRow As Integer, ByRef RS As ADODB.Recordset, ByRef oSheet As Object, ByRef n As Integer)

    Dim DataArray() As Variant
    ReDim DataArray(1 To scfgCmn.spec_xls_rows, 0 To fgSim.cols - 1)
    Dim r As Integer
    Dim c As Integer
    Dim cc As Integer
    
    For r = 1 To scfgCmn.spec_xls_rows
        
        If RS.EOF Then Exit For
        
        n = n + 1
        
        cc = 0
        
        For c = scfgCmn.spec_xls_startcol To fgSim.cols - 1
            DataArray(r, cc) = RS.fields(c).Value
            If RS.fields(c).Name = "Number" Then DataArray(r, cc) = n
            cc = cc + 1
        Next c
    
        RS.MoveNext

    Next r
    
    If r > 1 Then oSheet.Range("A" & iStartRow).Resize(r - 1, cc).Value = DataArray

End Sub


Private Sub tbWise_ButtonMenuClick(ByVal ButtonMenu As MSComctlLib.ButtonMenu)

    On Error GoTo err ' ec

    Dim i As Integer
    Dim j As Long
    

    
    
    
    If ButtonMenu.KEY = "ExcelSave" Then
    
        'If oView.Name = "FireRoomsFH1" Then ' редактирование
        'End If
    
        If FileExists(sFireCompFileName) Then
            Dim res As VbMsgBoxResult
            res = MsgBox("Файл для этого здания есть. Перезаписать?" & vbNewLine & _
                "чтобы открыть этот файл - нажмите НЕТ", vbYesNoCancel, "Предупреждение")
            If res = vbCancel Then Exit Sub
            If res = vbNo Then Shell "explorer.exe " & sFireCompFileName, vbNormalFocus: Exit Sub
        End If
    
        Call exportExcel(sFireCompFileName)
        
        tbWise.Buttons("Excel").ButtonMenus("ExcelOpen").Enabled = FileExists(sFireCompFileName)
        tbWise.Buttons("Excel").ButtonMenus("ExcelLoad").Enabled = FileExists(sFireCompFileName)
        
    ElseIf ButtonMenu.KEY = "ExcelOpen" Then
    
        If FileExists(sFireCompFileName) Then
            Shell "explorer.exe " & sFireCompFileName, vbNormalFocus
        End If
    
    ElseIf ButtonMenu.KEY = "ExcelLoad" Then
    
        Dim sProjName As String
    
        If Config.fgTabViews.exists(tbSimData.CurrTab) Then
            'Dim fgDyn As VSFlexGrid
            'Set fgDyn = Config.fgTabs(tbSimData.CurrTab)
    
            Dim oView As clsConfigSimView
            Set oView = Config.fgTabViews(tbSimData.CurrTab)
            
            '"^(Hanhikivi)$" -->> "Hanhikivi"
            If Not oView Is Nothing Then sProjName = Mid(oView.Proj, 3, Len(oView.Proj) - 4)
            
        End If
        
        If Len(sProjName) = 0 Then
            Dim ar() As String
            ar = Split(sFireCompFileName, "_")
            If UBound(ar) >= 0 Then
                sProjName = ar(0)
            End If
        End If
    
    
        If FileExists(sFireCompFileName) Then
        
            If MsgBox("Внести данные файла в базу?" & vbNewLine & sFireCompFileName, vbOKCancel) = vbCancel Then Exit Sub
        
        
            Dim cn As New ADODB.Connection
            cn.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
        
        
            fgExcel.loadGrid sFireCompFileName, flexFileExcel
            
            
            Dim fcID As Long
            Dim simID As Long
            Dim pwdocID As Long
            Dim sFCCode As String
            Dim sRoomCode As String
            
'            For j = 0 To fgDyn.cols - 1
'                If j < fgExcel.cols Then fgExcel.ColKey(j) = fgDyn.ColKey(j)
'            Next

            For j = 0 To fgExcel.cols - 1
                If Len(Trim(fgExcel.TextMatrix(1, j))) > 0 Then fgExcel.ColKey(j) = Trim(fgExcel.TextMatrix(1, j))
                'fgExcel.ColHidden(j) = False
            Next
            'fgExcel.AutoSize 0, fgExcel.cols - 1
            
            
            
            Dim fccnt As Integer
            Dim rmcnt As Integer
            
            For j = 2 To fgExcel.Rows - 1
            
                'fcID = Val(fgExcel.TextMatrix(j, fgExcel.ColIndex(strFireCompID)))
                
                'pwdocID = Val(fgExcel.TextMatrix(j, fgExcel.ColIndex("pwdocID")))
                'simID = Val(fgExcel.TextMatrix(j, fgExcel.ColIndex("simID")))
                
                sFCCode = UCase(Trim(fgExcel.TextMatrix(j, fgExcel.ColIndex(strFireCode))))
                sRoomCode = UCase(Trim(fgExcel.TextMatrix(j, fgExcel.ColIndex(strRoomCode))))
                
                If Len(sFCCode) > 0 And Len(sRoomCode) > 0 Then
                
                    fcID = selectLongFromBase(cn, strFireCompTable, strFireCompID, "fcCode", sFCCode)
                    
                    If Len(sProjName) > 0 Then
                        simID = selectLongFromBase(cn, "view_i_Space", strKeySimID, "kks", sRoomCode, "project_name", sProjName)
                    Else
                        'simID = selectLongFromBase(cn, "view_i_Space", strKeySimID, "kks", sRoomCode, "bldID", projID)
                        simID = selectLongFromBase(cn, "view_i_Space", strKeySimID, "kks", sRoomCode)
                    End If
                    
                    If simID > 0 Then
                
                        If fcID = 0 Then
                            fcID = insertDataInBase(cn, strFireCompTable, "fcCode", sFCCode)
                            If fcID > 0 Then fccnt = fccnt + 1
                        End If
                        
                        If fcID > 0 Then
                            If updateTableInBase(cn, "i_Space", "fcID", fcID, "simID", simID) Then
                                'fgDyn.Cell(flexcpFontBold, ...) = True
                                rmcnt = rmcnt + 1
                            End If
                        Else
                            'MsgBox "AAAAAAAAAA"
                        End If
                    
                    End If
            
                End If
                
            Next
            
            cn.Close
            Set cn = Nothing
            
            MsgBox "Добавлено пожарных отсеков: " & fccnt & vbNewLine & "Обновлено помещений: " & rmcnt & vbNewLine & "Для обновления таблицы нажмите на Fire"

        
        Else
            tbWise.Buttons("Excel").ButtonMenus("ExcelLoad").Enabled = False
        End If
        
        
        
    
    Else ' reload pw tree
        For i = 1 To pwsets.Count
            If Len(pwsets(i).text) > 0 Then
            
                Me.tbWise.Buttons("Reload").ButtonMenus(i).text = pwsets(i).text
                Me.tbWise.Buttons("Reload").ButtonMenus(i).Tag = pwsets(i).text
                
                If ButtonMenu.Tag = pwsets(i).text Then
                
                    Set pwset = pwsets(i)
                    
                    pwset.constring = "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;"
                    pwset.constring = pwset.constring & "User ID=" & pwset.login & ";"
                    pwset.constring = pwset.constring & "Initial Catalog=" & pwset.database & ";"
                    pwset.constring = pwset.constring & "Data Source=" & pwset.server & ";"
                
                    pwset.connected = connectPW(conn.strProvider, False)
                    
                    If pwset.connected Then
                        Me.tbWise.Buttons("Reload").ButtonMenus(i).text = ">>> " & pwsets(i).text
                        Call SaveSetting("Offtake2", "pw", "connection index", i - 1)
                        reloadData2
                    Else
                        Me.tbWise.Buttons("Reload").ButtonMenus(i).Enabled = False
                        
                        Dim ind As Integer
                        ind = GetSetting("Offtake2", "pw", "connection index", 0) + 1
                        
                        Set pwset = pwsets(ind)
                    
                        pwset.constring = "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;"
                        pwset.constring = pwset.constring & "User ID=" & pwset.login & ";"
                        pwset.constring = pwset.constring & "Initial Catalog=" & pwset.database & ";"
                        pwset.constring = pwset.constring & "Data Source=" & pwset.server & ";"
                        
                        pwset.connected = connectPW(conn.strProvider, False)
                        
                    End If
                    
                End If
            End If
        Next i
    End If

    
    
    
Exit Sub
err:
MsgBox err.Description

End Sub

Private Sub Timer2_Timer()

    Set tt = Nothing
    Timer2.Enabled = False
End Sub


'/******************************************************************************
Private Sub Timer3_Timer()
'/******************************************************************************

    On Error GoTo Timer3_Timer_ERR


'    Debug.Print Now

    Dim strIDs As String



    If ctabMain.CurrTab = 7 And tbSimData.CurrTab = 0 Then
    
        Dim li As ListItem
        Dim ar() As String
        
'        "item" & Trim(RS.Fields("o_docguid").Value)
'        li.Tag = RS.Fields("projid").Value & "-" & RS.Fields("ID").Value

        For Each li In Me.lvWise.ListItems
            If Len(Trim(li.SubItems(2))) > 0 Then
                
                ar = Split(li.Tag, "-")
                
                If UBound(ar) = 1 Then
                    
                    If Len(strIDs) > 0 Then strIDs = strIDs & ","
                    strIDs = strIDs & ar(1)
                    
                End If
                
            End If
        
        Next li
        
        
        
        If Len(strIDs) > 0 Then
        
            Dim cnpwa As New ADODB.Connection
            cnpwa.Open pwset.constring, pwset.login, pwset.login
            
            Dim strSQL As String
            
            strSQL = "SELECT CONVERT(varchar, aep_docdata.deleted)  + '#' + CONVERT(varchar, dms_doc.o_fupdatetime, 121) as cs"
            strSQL = strSQL & ",aep_docdata.last_state, dms_doc.o_docguid, aep_docdata.counter FROM aep_docdata"
            strSQL = strSQL & " INNER JOIN dms_doc ON aep_docdata.docguid = dms_doc.o_docguid"
            strSQL = strSQL & " WHERE aep_docdata.id in (" & strIDs & ")"
            
            Dim RS As New ADODB.Recordset
            RS.Open strSQL, cnpwa, adOpenForwardOnly, adLockReadOnly
            
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                    If (Trim(RS.fields("last_state").Value & "") = Trim(RS.fields("cs").Value & "")) Then
                        lvWise.ListItems("item" & Trim(RS.fields("o_docguid").Value)).SubItems(2) = ""
                    ElseIf Trim(RS.fields("last_state").Value & "") = "process" Then
                        lvWise.ListItems("item" & Trim(RS.fields("o_docguid").Value)).SubItems(2) = "в обработке"
                    ElseIf Val(RS.fields("counter").Value & "") > 5 Then
                        lvWise.ListItems("item" & Trim(RS.fields("o_docguid").Value)).SubItems(2) = "ошибка"
                    End If
                    RS.MoveNext
                Loop Until RS.EOF
                
            
            End If
            
            RS.Close
            Set RS = Nothing
            
            cnpwa.Close
            Set cnpwa = Nothing
        
        End If
        
    
    
    End If

Exit Sub

Timer3_Timer_ERR:
    F1.SB.Panels("status").text = "Timer3_Timer" & "() - " & err.Description

End Sub



'/******************************************************************************
Private Sub tvCats_AfterLabelEdit(Cancel As Integer, NewString As String)
'/******************************************************************************

    On Error GoTo tvCats_AfterLabelEdit_ERR





    
    Dim nd As Node
    Dim RS As New ADODB.Recordset
    Dim projectTypeID As Long
    Dim ID As Long
    Dim strProjectType As String
    
    
    
    Set nd = tvCats.SelectedItem
    
    If Len(Trim(NewString)) = 0 Then
        Cancel = 1
        Exit Sub
    End If
    
    
    If LCase(left(nd.KEY, Len("project"))) = "project" Then
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
    
        RS.Open "select * from i_project where projectID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If RS.EOF Then
            Cancel = 1
            Exit Sub
        End If
        
        RS.MoveFirst
        If Not IsNull(RS.fields("typeID").Value) Then projectTypeID = RS.fields("typeID").Value
        RS![projectName] = NewString
        RS.Update
        
        RS.Close
        Set RS = Nothing
        
        
        Call writeOperationS(operModify, "project", ID, "наименование " & NewString)
        
        tvCats_NodeClick tvCats.SelectedItem
        
    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
        Cancel = 1
    ElseIf LCase(left(nd.KEY, Len("building"))) = "building" Then
        Cancel = 1
    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
    
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    
        RS.Open "select * from i_catalog where catID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If RS.EOF Then
            Cancel = 1
            Exit Sub
        End If
        
        RS.MoveFirst
        RS![catName] = NewString
        RS.Update
        
        RS.Close
        Set RS = Nothing
        
        Call writeOperationS(operModify, "catalog", ID, "наименование " & NewString)
        
        tvCats_NodeClick tvCats.SelectedItem
        
    ElseIf LCase(left(nd.KEY, Len("catlist"))) = "catlist" Then
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
        RS.Open "select * from catlist where catlistID = " & ID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If RS.EOF Then
            Cancel = 1
            Exit Sub
        End If
        
        RS.MoveFirst
        RS![catlistName] = NewString
        RS.Update
        
        RS.Close
        Set RS = Nothing
        
        Call writeOperationS(operModify, "catlist", ID, "наименование " & NewString)
        
        tvCats_NodeClick tvCats.SelectedItem
        
'        loadCatList lngCurCatID
        
    Else
    End If




Exit Sub

tvCats_AfterLabelEdit_ERR:
    Cancel = 1
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvCats_AfterLabelEdit - Error"

End Sub



Private Sub tvCats_BeforeLabelEdit(Cancel As Integer)
    Dim nd As Node
    
    Set nd = tvCats.SelectedItem
    Dim ID As Long
    Dim typeID As Long
    Dim strType As String
    
    strTreeCatsLabelBeforeEdit = nd.text
    
    
    If LCase(left(nd.KEY, Len("project"))) = "project" Then
        If Not checkGroupPerm(usrCurrent.groupID, "project", operModify) Then
            Cancel = 1
            Exit Sub
        End If
        
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("project")))
        
    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
        If Not checkGroupPerm(usrCurrent.groupID, "block", operModify) Then
            Cancel = 1
            Exit Sub
        End If
    ElseIf LCase(left(nd.KEY, Len("building"))) = "building" Then
        If Not checkGroupPerm(usrCurrent.groupID, "building", operModify) Then
            Cancel = 1
            Exit Sub
        End If
    ElseIf LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
    
        If left(nd.parent.Tag, Len("catalog")) = "catalog" Then ' подкаталоги пользователям редактировать можно
            If Not checkGroupPerm(usrCurrent.groupID, "part", operModify) Then
                Cancel = 1
                Exit Sub
            End If
        Else
            If Not checkGroupPerm(usrCurrent.groupID, "catalog", operModify) Then
                Cancel = 1
                Exit Sub
            End If
        End If
    
    
    
    Else
    End If
    
    

End Sub

'/******************************************************************************
Public Sub checkListParts(Optional prtID As Long = 0, Optional iRM As Integer = -1)
'/******************************************************************************

    On Error GoTo checkListParts_ERR


    Dim i As Integer
    
    Dim iMCol As Long
    Dim iNameCol As Long
    
    iMCol = fgList.ColIndex("m")
    iNameCol = fgList.ColIndex("Наименование")
    
    
    If lngCurCatListID = 0 Then Exit Sub
    
    For i = 1 To Me.fgList.Rows - 1
    
        Dim prjID As Long
        Dim blkID As Long
        Dim catID As Long
    
        If prtID > 0 And prtID <> Val(fgList.TextMatrix(i, fgList.ColIndex("partID"))) Then GoTo cont
    
    
        If iRM >= 0 Then fgList.TextMatrix(i, fgList.ColIndex("partMainPosEP")) = iRM
    
    
'        If Me.fgList.TextMatrix(I, fgList.ColIndex("objID")) = objs("part") And cattypes(Val(Me.fgList.TextMatrix(I, fgList.ColIndex("catTypeID")))).ctEnum = ctRein Then
''            fgList.TextMatrix(I, fgList.ColIndex("Количество")) = fgList.TextMatrix(I, fgList.ColIndex("posQuantity"))
'            fgList.TextMatrix(I, fgList.ColIndex("Количество")) = "-"
'
'        Else
'        End If

        catID = 0
        
        ' картинки
        '===========================================
        If Me.fgList.TextMatrix(i, fgList.ColIndex("objID")) = objs("catalog") And cattypes(Val(Me.fgList.TextMatrix(i, fgList.ColIndex("catTypeID")))).ctEnum = ctRein Then
            Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("reincat").Picture
        ElseIf Me.fgList.TextMatrix(i, fgList.ColIndex("objID")) = objs("catalog") Then
            Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("catalog").Picture
        ElseIf Me.fgList.TextMatrix(i, fgList.ColIndex("objID")) = objs("part") Then
            Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("part0").Picture
            catID = fgList.TextMatrix(i, fgList.ColIndex("catID"))
        ElseIf Me.fgList.TextMatrix(i, fgList.ColIndex("objID")) = objs("catlist") Then
            Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("catlist").Picture
'            catID = fgList.TextMatrix(I, fgList.ColIndex("catID"))
        End If
        
        
        ' подсветка строчек
        '===========================================
        If Me.fgList.TextMatrix(i, fgList.ColIndex("partMainPosEP")) <> 0 Then
            fgList.Cell(flexcpBackColor, i, iMCol, , fgList.cols - 1) = lngGrey
        Else
            fgList.Cell(flexcpBackColor, i, iMCol, , fgList.cols - 1) = lngRowWinColor
            
'            If Val(Me.fgList.TextMatrix(I, fgList.ColIndex("Количество"))) <> CInt(Val(Me.fgList.TextMatrix(I, fgList.ColIndex("Количество")))) Then
'                fgList.Cell(flexcpBackColor, I, 1, , fgList.Cols - 1) = lngLightRed
'            End If
            
        End If
        
        
        prjID = Val(Me.fgList.TextMatrix(i, fgList.ColIndex("projID")))
        blkID = Val(Me.fgList.TextMatrix(i, fgList.ColIndex("blkID")))
        
        If prjID <> lngCurProjectID Then
            fgList.Cell(flexcpBackColor, i, iNameCol) = lngLightRed
        End If
       
'        If blkID <> lngCurBlockID Then
'            fgList.Cell(flexcpBackColor, I, iNameCol) = lngLightRed
'        End If

        fgList.Cell(flexcpBackColor, i, fgList.ColIndex("p")) = &H8000000F
        fgList.Cell(flexcpBackColor, i, fgList.ColIndex("b")) = &H8000000F
        fgList.Cell(flexcpBackColor, i, fgList.ColIndex("c")) = &H8000000F

        If prjID <> lngCurCatListProjID Then
            fgList.Cell(flexcpBackColor, i, fgList.ColIndex("p")) = lngRed
        End If

        If blkID > 0 And blkID <> lngCurCatListBlockID Then
            fgList.Cell(flexcpBackColor, i, fgList.ColIndex("b")) = lngRed
        End If

        If catID > 0 And fgList.TextMatrix(i, fgList.ColIndex("catUnif")) = False And catID <> lngCurCatListCatID Then
            fgList.Cell(flexcpBackColor, i, fgList.ColIndex("c")) = lngRed
        End If
       
        
        ' подсветка текста
        '===========================================
        
        If Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("catlist").Picture Then
            fgList.Cell(flexcpForeColor, i, iNameCol) = lngTextColor
        ElseIf Me.fgList.Cell(flexcpPicture, i, iNameCol) = ImageList2.ListImages("reincat").Picture Then
            If checkCatalogListRelation2(lngCurCatListID, lngCurCatID) Then
                fgList.Cell(flexcpForeColor, i, iNameCol) = lngTextColor
            Else
                fgList.Cell(flexcpForeColor, i, iNameCol) = lngRed
            End If
        ElseIf Val(fgList.TextMatrix(i, fgList.ColIndex("catID"))) = lngCurCatID Then
            fgList.Cell(flexcpForeColor, i, iNameCol) = lngTextColor
        ElseIf Val(fgList.TextMatrix(i, fgList.ColIndex("catID"))) <> lngCurCatID And fgList.TextMatrix(i, fgList.ColIndex("catUnif")) = True Then
            fgList.Cell(flexcpForeColor, i, iNameCol) = &HFF0000
        Else
            fgList.Cell(flexcpForeColor, i, iNameCol) = lngRed
        End If
        '===========================================
        
        ' если удалено - перечеркиваем
        If Val(fgList.TextMatrix(i, fgList.ColIndex("deleted"))) = 0 Then
            fgList.Cell(flexcpFontStrikethru, i, iNameCol) = False
        Else
            fgList.Cell(flexcpFontStrikethru, i, iNameCol) = True
        End If
        
        
        If prtID > 0 And prtID = Val(fgList.TextMatrix(i, fgList.ColIndex("partID"))) Then Exit For
        
cont:
        
        
        
    Next i
    
    
    If checkCatalogListRelation2(lngCurCatListID, lngCurCatID) Then
        Me.lblListName.ForeColor = &H80000012
        Me.lblListName.ToolTipText = "Список соответствует каталогу"
    Else
        Me.lblListName.ForeColor = lngRed
        Me.lblListName.ToolTipText = "Список не соответствует каталогу"
    End If



Exit Sub

checkListParts_ERR:
    'MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "checkListParts - Error"
    F1.SB.Panels("status").text = "checkListParts" & "() - " & err.Description
    Resume Next

End Sub

'/******************************************************************************
Public Sub calcReinGridSum()
'/******************************************************************************

    On Error GoTo calcReinGridSum_ERR

        Dim d As String
        
        If fgCatParts.Rows > 1 Then
        d = Format(fgCatParts.Aggregate(flexSTSum, 1, fgCatParts.ColIndex("cmass"), fgCatParts.Rows - 2, fgCatParts.ColIndex("cmass")), sFmt1)
        End If

        Me.SB.Panels("reinmass").text = "Арматура: " & Format(d, sFmt1) & "  "
        Me.SB.Panels("reinmass").AutoSize = sbrContents


Exit Sub

calcReinGridSum_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "calcReinGridSum - Error"

End Sub



'/////////////////////////////////////////////////////////////////////
'/******************************************************************************
Public Sub partsTreeAddLabel(ByRef lab As Label, nd As Node, Optional bEnter As Boolean = False, Optional bTrim As Boolean = True, Optional iOffs As Integer = 3, Optional bClearText As Boolean = False)
'/******************************************************************************

    On Error GoTo partsTreeAddLabel_ERR


    Dim strDelim As String
    Dim strToAdd As String
    Dim strOffs As String
    Dim s As String
    
    If bEnter Then
        strDelim = vbNewLine
    Else
        strDelim = " - "
    End If
    
    
    If nd Is Nothing Then Exit Sub
    
    If bTrim And Len(nd.text) > 35 Then
        s = left(nd.text, 32) & "..."
    Else
        s = nd.text
    End If
    
    
    If bClearText Then lab.Caption = ""
    
    
    If left(nd.KEY, Len("catlist")) = "catlist" Then
    
    
        If bEnter Then strOffs = Space(iOffs * 4) Else strOffs = ""
        lab.Caption = strOffs & nd.text
        partsTreeAddLabel lab, nd.parent, bEnter, bTrim, iOffs
    
    ElseIf left(nd.KEY, Len("catalog")) = "catalog" Then
    
        If bEnter Then strOffs = Space(iOffs * 3) Else strOffs = ""
        
        If Len(lab.Caption) > 0 Then
            strToAdd = strOffs & nd.text & strDelim & lab.Caption
            lab.Caption = strToAdd
        Else
            lab.Caption = strOffs & nd.text
        End If
    
        partsTreeAddLabel lab, nd.parent, bEnter, bTrim, iOffs
        
    ElseIf left(nd.KEY, Len("building")) = "building" Then
    
        If bEnter Then strOffs = Space(iOffs * 2) Else strOffs = ""
    
    
        strToAdd = strOffs & s & strDelim & lab.Caption
    
        lab.Caption = strToAdd
        partsTreeAddLabel lab, nd.parent, bEnter, bTrim, iOffs
        
    ElseIf left(nd.KEY, Len("block")) = "block" Then
        If bEnter Then strOffs = Space(iOffs * 1) Else strOffs = ""
        strToAdd = strOffs & nd.text & strDelim & lab.Caption
        lab.Caption = strToAdd
        partsTreeAddLabel lab, nd.parent, bEnter, bTrim, iOffs
        
    ElseIf left(nd.KEY, Len("project")) = "project" Then
        strOffs = ""
        strToAdd = nd.text & strDelim & lab.Caption
        lab.Caption = strToAdd
    End If
    
    

Exit Sub

partsTreeAddLabel_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "partsTreeAddLabel - Error"

End Sub




'/******************************************************************************
Public Sub loadPartsTree(catID As Long, Optional bReloadIfSame As Boolean = True, Optional partID As Long = 0, Optional bShowCatTab As Boolean = True)
'/******************************************************************************
    
    On Error GoTo loadPartsTree_ERR
    
    
    Me.tvParts.Checkboxes = CBool(Me.tbPart.Buttons("ShowDeleted").Value = tbrUnpressed)
    
    
    
    tvParts.Visible = False
    
    Dim catName As String
    Dim nd As Node
    Dim catTypeID As Long
    Dim sSheetKey As String
    Dim sDescrKey As String
    Dim strOrder As String
    Dim sTable As String
    
    Dim part As New clsPart
    
    Dim strSQL As String
    Dim strSQL_mlX As String
    
    
    If catID = lngCurCatID And Not bReloadIfSame Then GoTo weiter
    
    ' пытаемся запомнить чтобы потом выделяить опять
    If partID = 0 And Not tvParts.SelectedItem Is Nothing Then
        If left(tvParts.SelectedItem.KEY, 4) = "part" Then
            partID = Val(right(tvParts.SelectedItem.KEY, Len(tvParts.SelectedItem.KEY) - Len("part")))
        End If
    End If
    
    ' ========== S Q L ==================
    
    If bUsePartPdfColor Then
        
        strSQL = "SELECT "
        strSQL = strSQL & conn.strBaseName & ".dbo.view_part2.* "
        strSQL = strSQL & ",docs.dbo.r_part_file.pfID "
        strSQL = strSQL & "FROM "
        strSQL = strSQL & conn.strBaseName & ".dbo.view_part2 "
        
        strSQL = strSQL & "LEFT OUTER JOIN "
        strSQL = strSQL & "docs.dbo.r_part_file "
        strSQL = strSQL & "ON "
        strSQL = strSQL & conn.strBaseName & ".dbo.view_part2.partID "
        strSQL = strSQL & "= "
        strSQL = strSQL & "docs.dbo.r_part_file.partID "
        strSQL = strSQL & "AND "
        strSQL = strSQL & "docs.dbo.r_part_file.partDB "
        strSQL = strSQL & "= "
        strSQL = strSQL & "'" & conn.strBaseName & "' " '        strSQL = strSQL & "'" & "PARTS" & "' "
        
        strSQL = strSQL & "WHERE "
        
        strSQL = strSQL & conn.strBaseName & ".dbo.view_part2.catID = " & catID & " "
        
    Else
        
        strSQL = "select * from view_part2 where catID = " & catID
        
    End If
        
    If Len(Trim(Replace(sFilterPartName, "%", ""))) > 0 Then
        strSQL = strSQL & " AND [partName] LIKE '" & sFilterPartName & "'"
    End If
    
    If Me.tbPart.Buttons("ShowDeleted").Value = tbrUnpressed Then
        strSQL = strSQL & " AND [deleted] = 0"
    Else
        strSQL = strSQL & " AND [deleted] = 1"
    End If
    
    strSQL_mlX = strSQL
    
    If iPartTreeLevel = tlSimple Then
        strSQL = strSQL & " and parentID = 0"
        strSQL_mlX = strSQL_mlX & " and parentID > 0"
    End If
    
    
    strOrder = " order by"
    If iPartTreeLevel = tlSign Then
        strOrder = strOrder & " partDescr,"
    ElseIf iPartTreeLevel = tlSignSheet Then
        strOrder = strOrder & " partDescr, partSheet,"
    ElseIf iPartTreeLevel = tlPartList Then
        strOrder = strOrder & " dsPartList,"
    ElseIf iPartTreeLevel = tlDrawings Then
        strOrder = strOrder & " dsDrawings,"
    ElseIf iPartTreeLevel = tlStatus Then
        strOrder = strOrder & " partStatusID,"
    End If
    
    strOrder = strOrder & " partSortNumber, partName, partVersion"
    
    
    strSQL = strSQL & strOrder
    strSQL_mlX = strSQL_mlX & strOrder
    
    ' =====================================
    
    '    bCatIsBlocked = Not checkCatPerm(catID)
    
    Me.tbPart.Buttons("NewPart").Enabled = Not bCatIsBlocked And checkGroupPerm(usrCurrent.groupID, "part", operCreate)
    Me.tbPart.Buttons("AddPos").Enabled = False
    
    tvParts.Nodes.Clear
    
    Dim RS As New ADODB.Recordset
    
    
    catName = selectStringFromBase(cn_data, "i_catalog", "catName", "catID", catID)
    catTypeID = selectLongFromBase(cn_data, "i_catalog", "catTypeID", "catID", catID)
    lngCurCatListDefaultID = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", catID)
    
    Set nd = tvParts.Nodes.Add(, , "root", catName, "catalog")
    nd.Expanded = True
    
    fgPart.Rows = 0
    
    
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    
    If Not RS.EOF Then
        
        RS.MoveFirst
        Do
            
            part.partID = RS![partID]
            part.partName = RS![partName]
            part.typeID = Val(RS![typeID] & "")
            part.parttypeID = Val(RS![typeID] & "")
            part.typeName = RS![typeName] & ""
            part.partDescr = RS![partDescr] & ""
            part.partSheet = RS![partSheet] & ""
            part.partVers = RS![partVersion] & ""
            part.part_prntID = RS![parentID]
            part.partStatusID = RS![partStatusID]
            
            sSheetKey = "descr" & part.partDescr & "sheet" & part.partSheet
            sDescrKey = "descr" & part.partDescr
            
            
            If iPartTreeLevel = tlType And part.typeID > 0 Then
                
                If addTreeNode(tvParts, nd, "root", tvwChild, "type" & part.typeID, part.typeName, "type") Then
                    'nd.Expanded = True
                End If
                
                If Not addTreeNode(tvParts, nd, "type" & part.typeID, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
            ElseIf iPartTreeLevel = tlSign Then ' sign
                
                If Len(part.partDescr) > 0 Then
                    If addTreeNode(tvParts, nd, "root", tvwChild, sDescrKey, part.partDescr, "descr") Then
                        '                    nd.Expanded = True
                    End If
                End If
                
                If Not addTreeNode(tvParts, nd, sDescrKey, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
            ElseIf iPartTreeLevel = tlPartList Then '
                
                sDescrKey = "descr" & RS.fields("dsPartList").Value
                
                If Len(RS.fields("dsPartList").Value & "") > 0 Then
                    If addTreeNode(tvParts, nd, "root", tvwChild, sDescrKey, RS.fields("dsPartList").Value, "descr") Then
                        '                    nd.Expanded = True
                    End If
                End If
                
                If Not addTreeNode(tvParts, nd, sDescrKey, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
            ElseIf iPartTreeLevel = tlDrawings Then '
                
                sDescrKey = "descr" & RS.fields("dsDrawings").Value
                
                If Len(RS.fields("dsDrawings").Value & "") > 0 Then
                    If addTreeNode(tvParts, nd, "root", tvwChild, sDescrKey, RS.fields("dsDrawings").Value, "descr") Then
                        '                    nd.Expanded = True
                    End If
                End If
                
                If Not addTreeNode(tvParts, nd, sDescrKey, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
            ElseIf iPartTreeLevel = tlStatus Then ' status
                
                If addTreeNode(tvParts, nd, "root", tvwChild, "stat" & part.partStatusID, stts(part.partStatusID), "stat") Then
                    '                    nd.Expanded = True
                End If
                
                If Not addTreeNode(tvParts, nd, "stat" & part.partStatusID, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
                
            ElseIf iPartTreeLevel = tlSignSheet Then ' sign & sheet
                
                
                If Len(part.partDescr) > 0 Then
                    If addTreeNode(tvParts, nd, "root", tvwChild, sDescrKey, part.partDescr, "descr") Then
                        '                    nd.Expanded = True
                    End If
                End If
                
                If Len(Trim(part.partSheet)) > 0 Then
                    If addTreeNode(tvParts, nd, sDescrKey, tvwChild, sSheetKey, part.partSheet, "sheet") Then
                        '                    nd.Expanded = True
                    End If
                End If
                
                If Not addTreeNode(tvParts, nd, sSheetKey, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                    If Not addTreeNode(tvParts, nd, sDescrKey, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                        Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                    End If
                End If
                
                
            Else
                Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
            End If
            
            
            
            nd.bOld = CBool(Me.tbPart.Buttons("ShowDeleted").Value = tbrUnpressed)
            
            If CBool(RS![link]) Then
                nd.Image = "link"
                nd.Tag = RS.fields("link").Value ' linkID - using for deleteing links, see mnuPartsTreeDeleteChecked_Click
            End If
            
            If part.partID = partID Then
                nd.Selected = True
                nd.EnsureVisible
            End If
            
            If bUsePartPdfColor Then
            If Not IsNull(RS![pfID]) Then
                nd.ForeColor = &HC00000 ' blue if pdf
            End If
            End If
            
            
            RS.MoveNext
        Loop Until RS.EOF
        
        
    End If
    
    
    If iPartTreeLevel = tlSimple Then
        
        RS.NextRecordset
        RS.Open strSQL_mlX, cn_data, adOpenForwardOnly, adLockReadOnly
        
        
        If Not RS.EOF Then
            
            RS.MoveFirst
            Do
                
                part.partID = RS![partID]
                part.partName = RS![partName]
                part.typeID = RS![typeID]
                part.parttypeID = RS![typeID]
                part.typeName = RS![typeName] & ""
                part.partDescr = RS![partDescr] & ""
                part.partSheet = RS![partSheet] & ""
                part.partVers = RS![partVersion] & ""
                part.part_prntID = RS![parentID]
                part.partStatusID = RS![partStatusID]
                
                
                If Me.tbPart.Buttons("ShowDeleted").Value = tbrUnpressed Then
                    
                    If Not addTreeNode(tvParts, nd, "part" & part.part_prntID, tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID) Then
                        Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                    End If
                    
                Else
                    Set nd = tvParts.Nodes.Add("root", tvwChild, "part" & part.partID, part.getNodeName, "part" & part.partStatusID)
                End If
                
                
                nd.bOld = CBool(Me.tbPart.Buttons("ShowDeleted").Value = tbrUnpressed)
                
                If CBool(RS![link]) Then
                    nd.Image = "link"
                    nd.Tag = RS.fields("link").Value ' linkID
                End If
                
                If part.partID = partID Then
                    nd.Selected = True
                    nd.EnsureVisible
                End If
                
                If bUsePartPdfColor Then
                If Not IsNull(RS![pfID]) Then
                    nd.ForeColor = &HC00000 ' blue if pdf
                End If
                End If
                
                
                RS.MoveNext
            Loop Until RS.EOF
            
            
        End If
        
    End If
    
    
    '    If catID <> lngCurCatID Then
    '        loadCatList catID, lngCurCatListDefaultID
    '    End If
    
    lngCurCatID = catID
    '    lngCurPartCatID = catID
    
    lngCurDefaultPartdefID = cattypes(catTypeID).partdefID
    If usrCurrent.partdefDefaultID > 0 Then lngCurDefaultPartdefID = usrCurrent.partdefDefaultID
    
    
    checkCatParts
    
    checkListParts
    
    Dim strAr As String
    strAr = "-> "
    
    Dim i As Integer
    For i = 1 To tlDrawings + 1
        If iPartTreeLevel = Val(Me.tbPart.Buttons("Reload").ButtonMenus(i).Tag) Then
            Me.tbPart.Buttons("Reload").ButtonMenus(i).text = strAr & Replace(Me.tbPart.Buttons("Reload").ButtonMenus(i).text, strAr, "")
        Else
            Me.tbPart.Buttons("Reload").ButtonMenus(i).text = Replace(Me.tbPart.Buttons("Reload").ButtonMenus(i).text, strAr, "")
        End If
    Next i
    
    
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))
    lblCurCatName(0).Caption = ct.getCatPath
    
weiter:
    
    If partID > 0 Then tvPartsSelectItem "part" & partID
    
    If Me.tvCats.Nodes.Count > 0 Then
        ctabMain.TabVisible(1) = True
        If bShowCatTab Then ctabMain.CurrTab = 1
    End If
    
    If bFormTabsHide Then ctabMain.TabVisible(2) = False
    '    ctabMain.TabVisible(3) = True
    
    tvParts.Visible = True
    
    fgPositions.Rows = 1
    
    
    
    
    
    If Not Me.tvParts.Checkboxes Then Me.tvParts.Nodes("root").text = Me.tvParts.Nodes("root").text & " (корзина)"
    
    
    Exit Sub
    
loadPartsTree_ERR:
    tvParts.Visible = True
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadPartsTree - Error"
    
End Sub

'/******************************************************************************
Public Function loadCatalog(catID As Long, _
                            Optional bReloadIfSame As Boolean = True, _
                            Optional partID As Long = 0, _
                            Optional bShowCatTab As Boolean = True, _
                            Optional bReloadList As Boolean = False, _
                            Optional iCatType As ctype = ctNone) As Long
'/******************************************************************************
    
    On Error GoTo loadCatalog_ERR
    
    Dim RS As ADODB.Recordset
    
    Dim tID As Long
    Dim ct As ctype
    
    
    Dim curcat As New clsCat
    curcat.catID = catID
    
    If iCatType = ctNone Then
        tID = selectLongFromBase(cn_data, "i_catalog", "catTypeID", "catID", catID) ' catalog type ID
        ct = cattypes(tID).ctEnum
    Else
        ct = iCatType
    End If
    
    Dim nd As Node
    Set nd = tvGetTreeNode(tvCats, "catalog" & lngCurCatID)
    
    If Not nd Is Nothing Then
        nd.ForeColor = &H80000008
    End If
    
    
    lngCurProjectID = curcat.getProjectIDfromDB()
    lngCurBlockID = curcat.getBlockIDfromDB()
    lngCurBuildingID = curcat.getBuildingID()
    
    bCatIsBlocked = Not checkCatPerm(catID) Or checkGroupPerm(0, "part", operModify) = False
    
    ' useRienFillet - так называется столбец в базе
    iUseReinFilletByProject = selectLongFromBase(cn_data, "i_project", "useRienFillet", "projectID", lngCurProjectID)
    bUseDopMass = CBool(selectLongFromBase(cn_data, "i_project", "useMassDop", "projectID", lngCurProjectID))
    bUseStdNumberAlt = CBool(selectLongFromBase(cn_data, "i_project", "useStdNumberAlt", "projectID", lngCurProjectID))
    lngCurSpecID = selectLongFromBase(cn_data, "i_project", "specID", "projectID", lngCurProjectID)
    
    If ct = ctEmb Then
        loadPartsTree catID, bReloadIfSame, partID, bShowCatTab
        lngCurReinCatID = 0
        lngCurPartCatID = catID
    ElseIf ct = ctRein Then
        loadPartsGrid catID, bReloadIfSame, partID, bShowCatTab
        lngCurReinCatID = catID
        lngCurPartCatID = 0
    Else
        lngCurReinCatID = 0
        lngCurPartCatID = 0
        tID = 0
    End If
    
    If Not bReadOnly And catID > 0 Then
        
        Set RS = New ADODB.Recordset
        RS.Open "select usrCatalogID, usrTime, getdate() as tm from usr where usrID = " & usrCurrent.usrID, cn_srtm, adOpenForwardOnly, adLockOptimistic
        If Not RS.EOF Then
            RS.MoveFirst
            RS.fields("usrCatalogID").Value = catID
            RS.fields("usrTime").Value = RS.fields("tm").Value
            RS.Update
        End If
        RS.Close
        Set RS = Nothing
        
    End If
    

    Set nd = tvGetTreeNode(tvCats, "catalog" & lngCurCatID)
    
    If Not nd Is Nothing Then
        nd.ForeColor = &HFF0000
    End If

    
    
    
    
    
    
    If bReloadList Then
        tID = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", catID)
        If tID > 0 Then loadListGrid tID, False
    End If

    
    
    loadCatalog = tID
    
    Dim icrp As Integer
    icrp = getCatRemPos(catID)
    If icrp = 0 Then
        colCatRem.Add curcat
        iCatRemPos = colCatRem.Count
    Else
        iCatRemPos = icrp
    End If
    
    
    Exit Function
    
loadCatalog_ERR:
    loadCatalog = 0
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "loadCatalog - Error"
    
End Function


'/******************************************************************************
Public Function getCatRemPos(catID As Long) As Integer
'/******************************************************************************

    On Error GoTo getCatRemPos_ERR
    
    Dim i As Integer
    Dim ct As clsCat
    
    For i = 1 To colCatRem.Count
    
        Set ct = colCatRem(i)
    
        If ct.catID = catID Then getCatRemPos = i
    
    Next i
    

Exit Function

getCatRemPos_ERR:

End Function



'/******************************************************************************
Public Function getBlockID(nnd As Node, catID As Long) As Long
'/******************************************************************************

    On Error GoTo getProjID_ERR


    Dim nd As Node
    
    If nnd Is Nothing Then
        Set nd = Me.tvCats.Nodes("catalog" & catID)
    Else
        Set nd = nnd
    End If
    
    
    Dim n As Node
    Set n = nd.parent
    
    If n Is Nothing Then
        getBlockID = 0
        Exit Function
    End If
    
    If left(n.KEY, Len("block")) = "block" Then
        getBlockID = Val(right(n.KEY, Len(n.KEY) - Len("block")))
    ElseIf left(n.KEY, Len("pwblock")) = "pwblock" Then
        getBlockID = Val(right(n.KEY, Len(n.KEY) - Len("pwblock")))
    Else
        getBlockID = getBlockID(n, catID)
    End If
    
    
    
    
Exit Function

getProjID_ERR:
    getBlockID = 0

End Function


'/******************************************************************************
Public Function getProjID(nnd As Node, catID As Long) As Long
'/******************************************************************************

    On Error GoTo getProjID_ERR


    Dim nd As Node
    
    If nnd Is Nothing Then
        Set nd = Me.tvCats.Nodes("catalog" & catID)
    Else
        Set nd = nnd
    End If
    
    
    Dim n As Node
    Set n = nd.parent
    
    If n Is Nothing Then
        getProjID = 0
        Exit Function
    End If
    
    If left(n.KEY, Len("project")) = "project" Then
        getProjID = Val(right(n.KEY, Len(n.KEY) - Len("project")))
    Else
        getProjID = getProjID(n, catID)
    End If
    
    
    
    
Exit Function

getProjID_ERR:
    getProjID = 0

End Function


'/******************************************************************************
Private Sub tvCats_DblClick()
'/******************************************************************************

    On Error GoTo tvCats_DblClick_ERR

    
    Dim nd As Node
    Dim ID As Long
    Dim tID As Long
    
    Set nd = tvCats.SelectedItem
    
    
    Me.MousePointer = 11
    
    If LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
        
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        
        loadCatalog ID, True, 0, True, mnuListSyncList.Checked ' каталог перегрузить, изделие не выделять, активировать вкладку, перегрузить список по опции
        
    ElseIf LCase(left(nd.KEY, Len("catlist"))) = "catlist" Then
        
        ID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
        
        loadListGrid ID, mnuListSyncLoad.Checked
        
    ElseIf LCase(left(nd.KEY, Len("docset"))) = "docset" Then
    
'        If Not checkGroupPerm(usrCurrent.groupID, "catalog", operCreate) Then
'            MsgBox "Нет прав на редактирование каталога!", vbExclamation
'            Exit Sub
'
'        Else
'
'            If MsgBox("Добавить возможность расчета спецификацийдля этого каталога?", vbDefaultButton2) = vbYes Then
'
'                'createCatalog(
'            End If
'
'
'        End If
    
    
    End If
    
    
    Me.MousePointer = 0
    
    
    
    
Exit Sub

tvCats_DblClick_ERR:
    Me.MousePointer = 0
'    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvCats_DblClick - Error"

End Sub

'/******************************************************************************
Private Sub tvCats_DragDrop(source As Control, X As Single, Y As Single)
'/******************************************************************************
    
        On Error GoTo tvCats_DragDrop_ERR
    
    
    Dim ndprnt As Node
    Dim ndCur As Node
    
    Dim objID As Long
    Dim srcID As Long
    Dim objectID As Long
    Dim prntID As Long
    
    Set ndCur = tvCats.SelectedItem
    Set ndprnt = tvCats.DropHighlight
    
    
    If ndCur Is Nothing Then Exit Sub
    If ndprnt Is Nothing Then Exit Sub
    
    Dim bCat As Boolean
    Dim bCatList As Boolean
    Dim bBld As Boolean
    
    
    If (left(ndCur.Tag, Len("catlist"))) = "catlist" Then
        
        bCatList = True
        
        srcID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catlist")))
        
        prntID = Val(right(ndCur.parent.KEY, Len(ndCur.KEY) - Len("catalog")))
        
        Dim ID As Long
        ID = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", prntID)
        
        If ID = srcID Then ' по умолчанию
            ' будем обнулять
        Else
            prntID = 0
        End If
        
        If (left(ndprnt.Tag, Len("catalog"))) = "catalog" Then
            objID = objs("catalog")
            objectID = Val(right(ndprnt.KEY, Len(ndprnt.KEY) - Len("catalog")))
            If objectID = srcID Then objectID = 0
        Else
            objectID = 0
        End If
        
    ElseIf (left(ndCur.Tag, Len("catalog"))) = "catalog" Then
        
        bCat = True
        
        srcID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catalog")))
        
        If Not getNodeIds(ndprnt, objID, objectID, False) Then
            objectID = 0
        Else
            If objectID = srcID Then objectID = 0
        End If
        
'        If (left(ndprnt.Tag, Len("project"))) = "project" Then
'            objID = objs(left(ndprnt.Tag, Len("project")))
'            objectID = Val(right(ndprnt.KEY, Len(ndprnt.KEY) - Len("project")))
'        ElseIf (left(ndprnt.Tag, Len("block"))) = "block" Then
'            objID = objs(left(ndprnt.Tag, Len("block")))
'            objectID = Val(right(ndprnt.KEY, Len(ndprnt.KEY) - Len("block")))
'        ElseIf (left(ndprnt.Tag, Len("building"))) = "building" Then
'            objID = objs(left(ndprnt.Tag, Len("building")))
'            objectID = Val(right(ndprnt.KEY, Len(ndprnt.KEY) - Len("building")))
'        ElseIf (left(ndprnt.Tag, Len("catalog"))) = "catalog" Then
'            objID = objs(left(ndprnt.Tag, Len("catalog")))
'            objectID = Val(right(ndprnt.KEY, Len(ndprnt.KEY) - Len("catalog")))
'            If objectID = srcID Then objectID = 0
'        Else
'            objectID = 0
'        End If
        
    End If
    
    
    
    
    
    
    If objectID > 0 And bCat Then
        
        Dim RS As New ADODB.Recordset
        
        RS.Open "select * from r_object_catalog where catalogID = " & srcID, cn_data, adOpenForwardOnly, adLockOptimistic
        
        If Not RS.EOF Then
            
            RS.MoveFirst
            
            If Not (RS.fields("objID").Value = objID And RS.fields("objectID").Value = objectID) Then
                RS.fields("objID").Value = objID
                RS.fields("objectID").Value = objectID
                RS.Update
                Call writeOperationS(operModify, "catalog", srcID, "перенос в " & ndprnt.FullPath)
            End If
            
        End If
        
        RS.Close
        Set RS = Nothing
        
    ElseIf objectID > 0 And bCatList Then
        
        If updateTableInBase(cn_data, "catlist", "catID", objectID, "catlistID", srcID) Then
            
            If prntID > 0 Then
                Call updateTableInBase(cn_data, "i_catalog", "catlistID", 0, "catID", prntID)
            End If
            
            Call writeOperationS(operModify, "catlist", srcID, "перенос в " & ndprnt.FullPath)
            
        End If
        
    End If
    
    
    If ndprnt.children > 0 Then
        If right(ndprnt.Child.KEY, 1) = "+" Then
            tvCats.Nodes.Remove ndprnt.Child.KEY
            tvCats.Nodes.Remove ndCur.KEY
            loadCatsTreeNode ndprnt
            Set ndCur = Nothing
        End If
    End If
    
    
    If Not ndCur Is Nothing Then
        Set ndCur.parent = ndprnt
        If bCatList Then ndCur.Image = "catlist"
    End If
    
    
    
    Set tvCats.DropHighlight = Nothing
    tvCats.Refresh
    
    
    
    Exit Sub
    
tvCats_DragDrop_ERR:
    Set tvCats.DropHighlight = Nothing
    tvCats.Refresh
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvCats_DragDrop - Error"
    
End Sub

Function existString(strWhere As String, strWhat As String) As Boolean

    On Error Resume Next

    existString = Not CBool(InStr(strWhere, strWhat) = 0) ' =0 значит не найден

End Function


'/******************************************************************************
Private Sub tvCats_DragOver(source As Control, X As Single, Y As Single, State As Integer)
'/******************************************************************************
    
    On Error GoTo tvCats_DragOver_ERR
    
    
'    Debug.Print "tvCats_DragOver", X, Y
    
    Dim ndDst As Node
    Dim catDstID As Long
    Dim catSrcID As Long
    
    Dim ndCur As Node
    
    Dim bOk As Boolean
    
    Dim i As Integer
    
    Set ndDst = tvCats.HitTest(X, Y)
    
    Set ndCur = tvCats.SelectedItem
    
    If ndDst Is Nothing Or ndCur Is Nothing Then
        tvCats.DropHighlight = Nothing
        Exit Sub
    End If
    

'    If LCase(left(ndDst.KEY, Len("catalog"))) = "catalog" Then
'        Debug.Print ndDst.KEY, ndDst.Image, ndCur.Image
'    End If
    
    Dim str1 As String
    Dim str2 As String
    
    str1 = ndCur.Image
    str2 = ndDst.Image
    
    
    
    If LCase(left(ndCur.KEY, Len("catalog"))) = "catalog" Then
    
    
        If Not existString(str1, "_st0") Then
            tvCats.DropHighlight = Nothing
            Exit Sub
        End If
        
        If Not existString(str1, "_open_") Then
            tvCats.DropHighlight = Nothing
            Exit Sub
        End If
    
        If LCase(left(ndDst.KEY, Len("catalog"))) = "catalog" Then
            
            
            If Not existString(str2, "_st0") Then
                tvCats.DropHighlight = Nothing
                Exit Sub
            End If
            
            If Not existString(str2, "_open_") Then
                tvCats.DropHighlight = Nothing
                Exit Sub
            End If
            
            
'            If LCase(left(ndDst.Parent.KEY, Len("catalog"))) = "catalog" Then Set ndCur = Nothing
                
'            If ndCur.children > 0 Then
'                Dim ndx As Node
'                Set ndx = ndCur.Child.FirstSibling
'                For I = 1 To ndCur.children
'                    If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
'                        Set ndCur = Nothing
'                        Exit For
'                    End If
'                    Set ndx = ndx.Next
'                Next
'            End If
            
            
            If Not ndCur Is Nothing Then
                catSrcID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catalog")))
                catDstID = Val(right(ndDst.KEY, Len(ndDst.KEY) - Len("catalog")))
                
                If catSrcID = catDstID Then
                    tvCats.DropHighlight = Nothing
                    Exit Sub
                End If
                
                'If cattypes(cCats(CStr(catSrcID)).catTypeID).ctEnum = ctRein And cattypes(cCats(CStr(catDstID)).catTypeID).ctEnum = ctRein Then
                Set tvCats.DropHighlight = ndDst
                bOk = True
                'End If
            End If
                
            
        ElseIf LCase(left(ndDst.KEY, Len("catlist"))) = "catlist" Then
            'Set tvCats.DropHighlight = ndDst
            'bOk = True
        ElseIf LCase(left(ndDst.KEY, Len("building"))) = "building" Then
        
            If Not ndCur Is Nothing Then
                catSrcID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catalog")))
                catDstID = Val(right(ndDst.KEY, Len(ndDst.KEY) - Len("building")))
                
                Set tvCats.DropHighlight = ndDst
                bOk = True
            End If
            
        Else
            Set tvCats.DropHighlight = ndDst
            bOk = True
        End If
        
    ElseIf LCase(left(ndCur.KEY, Len("catlist"))) = "catlist" Then
    
        If LCase(left(ndDst.KEY, Len("catalog"))) = "catalog" Then
            
            If Not ndCur Is Nothing Then
                catSrcID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catlist")))
                catDstID = Val(right(ndDst.KEY, Len(ndDst.KEY) - Len("catalog")))
                
                Set tvCats.DropHighlight = ndDst
                bOk = True
            End If
                
        End If
    
    End If
        
        
        
'    Debug.Print catSrcID, catDstID
        
    
    
    
    If Not bOk Then Set tvCats.DropHighlight = Nothing
    
    
    
    Exit Sub
    
tvCats_DragOver_ERR:
    
End Sub


Private Sub tvCats_LostFocus()

    Me.tbCats.Buttons("InList").Enabled = False

End Sub

'/******************************************************************************
Private Sub tvCats_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
'/******************************************************************************
    
    On Error GoTo tvCats_MouseDown_ERR
    
    Dim nd As Node
    Dim prjID As Long
    Dim catID As Long
    Dim catPrntID As Long
    Dim catChldID As Long
    Dim bShowMenu As Boolean
    Dim bRein As Boolean
    Dim i As Integer
    
    bShowMenu = True
    
    Set tvCats.SelectedItem = tvCats.HitTest(X, Y)
    Set nd = tvCats.SelectedItem
    
    mnuCatsTreeCreateList.Visible = False
    mnuCatsTreeUpdateCatlist.Visible = False
    mnuCatsTreeDocSet.Visible = False
    mnuCatsTreePassive.Visible = False
    
    mnuCatsTreeBeton.Visible = False
    
    mnuCatsTreeReload.Visible = True
    
    mnuCatsTreeUserSpec.Visible = False
    
    If nd Is Nothing Then
        dDragX = 0
        dDragY = 0
        Exit Sub
    End If
    
'    objs
    
    If Button = 1 Then
        
'        If Not usrCurrent.trusted Then
'            dDragX = 0
'            dDragY = 0
'        Else
'            dDragX = X
'            dDragY = Y
'        End If
        
        If Shift = 2 Then
            dDragX = X
            dDragY = Y
        Else
            dDragX = 0
            dDragY = 0
        End If
        
    ElseIf Button = 2 Then
        
        
        If (left(nd.Tag, Len("project"))) = "project" Then
        
            prjID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
        
            mnuCatsTreeSep2.Visible = False
            mnuCatsTreeUnif.Visible = False
            mnuCatsTreeTest.Visible = False
            mnuCatsTreeSetList.Visible = False
            mnuCatsTreeLoad.Visible = False
            mnuCatsTreeReinLoad.Visible = False
            mnuCatsTreeCreateBlock.Visible = checkGroupPerm(usrCurrent.groupID, "block", operCreate)
            mnuCatsTreeCreateBuilding.Visible = loadBuildingMenus(tvCats.SelectedItem)
            mnuCatsTreeCreateCatalog.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
            mnuCatsTreeCreateReinCat.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
            mnuCatsTreeRenameItem.Visible = checkGroupPerm(usrCurrent.groupID, "project", operModify)
            mnuCatsTreeDeleteItem.Visible = checkGroupPerm(usrCurrent.groupID, "project", operDelete)
            mnuCatsTreeCopy.Visible = False
            mnuCatsTreeCopyHere.Visible = False
            mnuCatsTreePaste.Visible = False
            mnuCatsTreeBindDgn.Visible = False
            mnuCatsTreeCmdLeft.Visible = False
            mnuCatsTreeCmdRight.Visible = False
            mnuCatsTreeAccess.Visible = False
            bShowMenu = checkGroupPerm(usrCurrent.groupID, "project", operModify)
            
        ElseIf (left(nd.Tag, Len("block"))) = "block" Then
        
            mnuCatsTreeSep2.Visible = False
            mnuCatsTreeUnif.Visible = False
            mnuCatsTreeTest.Visible = False
            mnuCatsTreeSetList.Visible = False
            mnuCatsTreeLoad.Visible = False
            mnuCatsTreeReinLoad.Visible = False
            mnuCatsTreeCreateBlock.Visible = False
            mnuCatsTreeCreateBuilding.Visible = loadBuildingMenus(tvCats.SelectedItem)
            mnuCatsTreeCreateCatalog.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
            mnuCatsTreeCreateReinCat.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
            mnuCatsTreeRenameItem.Visible = False
            mnuCatsTreeDeleteItem.Visible = checkGroupPerm(usrCurrent.groupID, "block", operDelete)
            mnuCatsTreeCopy.Visible = False
            mnuCatsTreeCopyHere.Visible = False
            mnuCatsTreePaste.Visible = False
            mnuCatsTreeBindDgn.Visible = False
            mnuCatsTreeCmdLeft.Visible = False
            mnuCatsTreeCmdRight.Visible = False
            mnuCatsTreeAccess.Visible = False
            bShowMenu = checkGroupPerm(usrCurrent.groupID, "block", operModify)
            
        ElseIf left(nd.Tag, Len("building")) = "building" _
                Or nd.Tag = "pwcat" Then
        
            
            mnuCatsTreeUnif.Visible = False
            mnuCatsTreeTest.Visible = False
            mnuCatsTreeSetList.Visible = False
                mnuCatsTreeSep2.Visible = False
            mnuCatsTreeLoad.Visible = False
            mnuCatsTreeReinLoad.Visible = False
                mnuCatsTreeSep1.Visible = False
                mnuCatsTreeSep100.Visible = False
            mnuCatsTreeCreateBlock.Visible = False
            mnuCatsTreeCreateBuilding.Visible = False
            mnuCatsTreeCreateCatalog.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
            mnuCatsTreeCreateReinCat.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
                mnuCatsTreeSep10.Visible = True
            mnuCatsTreeRenameItem.Visible = False
            mnuCatsTreeDeleteItem.Visible = checkGroupPerm(usrCurrent.groupID, "building", operDelete) And nd.Tag <> "pwcat"
            mnuCatsTreeCopy.Visible = False
            mnuCatsTreeCopyHere.Visible = False
            mnuCatsTreePaste.Visible = True
            mnuCatsTreePaste.Enabled = (CBool(lngCurCatalogIDtoCopy) Or CBool(lngCurCatListIDtoCopy)) And nd.Tag <> "pwcat"
            mnuCatsTreePaste.Caption = "Создать копию каталога '" & left(selectStringFromBase(cn_data, "i_catalog", "catName", "catID", lngCurCatalogIDtoCopy), 30) & "'..."
            mnuCatsTreeBindDgn.Visible = False
            mnuCatsTreeCmdLeft.Visible = False
            mnuCatsTreeCmdRight.Visible = False
            mnuCatsTreeAccess.Visible = False
                mnuCatsTreeSep3.Visible = False
            
            bShowMenu = checkGroupPerm(usrCurrent.groupID, "building", operModify)
            
        ElseIf (left(nd.Tag, Len("catalog"))) = "catalog" Then
        
            catID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
            
            Dim ct As clsCat
            
            Set ct = cCats(CStr(catID))
            
            prjID = getProjID(nd, catID)
            
            Dim specID As Long
            specID = selectLongFromBase(cn_data, "i_project", "specID", "projectID", prjID)
            
            If ct.pw_ds_fld_ID > 0 Then
            Else
            
                Dim usp As clsSCfg
                For i = 0 To mnuCatsTreeUserSpecVal.Count - 1
                
                    If i > 0 Then mnuCatsTreeUserSpecVal(i).Visible = False
                    mnuCatsTreeUserSpecVal(i).Checked = False
                    
                    Set usp = getColItem(scfgs, mnuCatsTreeUserSpecVal(i).Tag)
                    If Not usp Is Nothing Then
                        If specID > 0 And usp.spcfg_prntID = specID Then
                            mnuCatsTreeUserSpecVal(i).Visible = True
                        End If
                    End If
                    
                    If Val(mnuCatsTreeUserSpecVal(i).Tag) = ct.userspecID Then
                        mnuCatsTreeUserSpecVal(i).Checked = True
                    End If
                    
                Next
                
                mnuCatsTreeUserSpec.Tag = catID
            
            End If
            
            If (left(nd.parent.Tag, Len("catalog"))) = "catalog" Then
                catPrntID = Val(right(nd.parent.KEY, Len(nd.parent.KEY) - Len("catalog")))
'                If Not cattypes(cCats(CStr(catPrntID)).catTypeID).ctEnum = ctRein Then catPrntID = 0
            Else
                catPrntID = 0
            End If
            
            
            ' mnuCatsTreeUpdateCatlist - Занести в список подкаталоги
            If nd.children > 0 Then
                Dim ndx As Node
                Set ndx = nd.Child.FirstSibling
                For i = 1 To nd.children
                    If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
                        catChldID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("catalog")))
                        If cattypes(cCats(CStr(catChldID)).catTypeID).ctEnum = ctRein Then
                            Dim ccctID As Long
                            ccctID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", lngCurCatListID)
                            mnuCatsTreeUpdateCatlist.Visible = checkCatPerm(ccctID)
                            '....
                        End If
                    End If
                    
                    Set ndx = ndx.Next
                Next
            End If
            
            If catPrntID > 0 Then
                mnuCatsTreeCopyHere.Visible = checkGroupPerm(usrCurrent.groupID, "part", operModify)
                mnuCatsTreeRenameItem.Visible = checkGroupPerm(usrCurrent.groupID, "part", operModify) And checkCatPerm(catID) And ct.pw_ds_fld_ID = 0
                mnuCatsTreeDeleteItem.Visible = checkGroupPerm(usrCurrent.groupID, "part", operDelete) And checkCatPerm(catID) 'And ct.pw_ds_fld_ID = 0
            Else
                mnuCatsTreeCopyHere.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify) And ct.pw_ds_fld_ID = 0
                mnuCatsTreeRenameItem.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify) And checkCatPerm(catID) And ct.pw_ds_fld_ID = 0
                mnuCatsTreeDeleteItem.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operDelete) And checkCatPerm(catID) 'And ct.pw_ds_fld_ID = 0
            End If
            
            
'            If cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein And catPrntID = 0 Then
'            If catPrntID = 0 Then
                mnuCatsTreeCreateReinCat.Visible = checkCatPerm(catID)
                mnuCatsTreeCreateCatalog.Visible = checkCatPerm(catID)
                mnuCatsTreeUserSpec.Visible = checkCatPerm(catID) And ct.pw_ds_fld_ID = 0
'            Else
'                mnuCatsTreeCreateReinCat.Visible = False ' checkGroupPerm(usrCurrent.groupID, "catalog", operCreate)
'                mnuCatsTreeCreateCatalog.Visible = False
'            End If
            
            mnuCatsTreeBeton.Visible = checkCatPerm(catID) And ct.pw_ds_fld_ID = 0 'And usrCurrent.trusted
            mnuCatsTreeSep2.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify) And checkCatPerm(catID) And ct.pw_ds_fld_ID = 0
            mnuCatsTreeUnif.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify) And checkCatPerm(catID) And ct.pw_ds_fld_ID = 0
            mnuCatsTreeUnif.Checked = nd.bOld And ct.pw_ds_fld_ID = 0
            mnuCatsTreeTest.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
            mnuCatsTreeTest.Checked = CBool(nd.ForeColor = &H80000010)
            mnuCatsTreeTest.Enabled = False
            mnuCatsTreeSetList.Visible = False
            mnuCatsTreeLoad.Visible = True
            mnuCatsTreeReinLoad.Visible = True
            mnuCatsTreeCreateBlock.Visible = False
            mnuCatsTreeCreateBuilding.Visible = False
            mnuCatsTreeCreateList.Visible = checkCatPerm(catID)
            mnuCatsTreeCopy.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify) Or CBool(catPrntID > 0)
            mnuCatsTreeCopyHere.Caption = "Создать рядом копию каталога"
            
'            If lngCurCatalogIDtoCopy > 0 And cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein And cattypes(cCats(CStr(lngCurCatalogIDtoCopy)).catTypeID).ctEnum = ctRein And catPrntID = 0 Then
            If lngCurCatalogIDtoCopy > 0 And catPrntID = 0 Then
                mnuCatsTreePaste.Visible = checkCatPerm(catID)
                mnuCatsTreePaste.Caption = "Создать подкаталог - копию каталога '" & left(selectStringFromBase(cn_data, "i_catalog", "catName", "catID", lngCurCatalogIDtoCopy), 30) & "'..."
            ElseIf lngCurCatListIDtoCopy > 0 Then
                mnuCatsTreePaste.Visible = checkCatPerm(catID)
                mnuCatsTreePaste.Caption = "Создать копию списка из буфера"
            Else
                mnuCatsTreePaste.Visible = False
            End If
            
            mnuCatsTreePaste.Enabled = CBool(lngCurCatalogIDtoCopy) Or CBool(lngCurCatListIDtoCopy)
            
            mnuCatsTreeBindDgn.Visible = True
            mnuCatsTreeCmdLeft.Visible = True
            mnuCatsTreeCmdRight.Visible = True
            mnuCatsTreeAccess.Visible = checkGroupPerm(usrCurrent.groupID, "catalog", operModify)
            
        ElseIf (left(nd.Tag, Len("catlist"))) = "catlist" Then
        
            Dim clID As Long
            clID = Val(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
            catID = selectLongFromBase(cn_data, "catlist", "catID", "catlistID", clID)
            mnuCatsTreeSep2.Visible = False
            mnuCatsTreeUnif.Visible = False
            mnuCatsTreePassive.Visible = checkCatPerm(catID) 'And CBool(selectLongFromBase(cn_data, "r_catlist_part", "relID", "objID", objs("catlist"), "catlistID", clID))
            mnuCatsTreePassive.Checked = CBool(selectLongFromBase(cn_data, "catlist", "clPassive", "catlistID", clID))
            mnuCatsTreeTest.Visible = False
            mnuCatsTreeSetList.Visible = True
            mnuCatsTreeSetList.Enabled = checkCatPerm(catID) And Not CBool(selectLongFromBase(cn_data, "i_catalog", "catID", "catlistID", clID))
            mnuCatsTreeLoad.Visible = False
            mnuCatsTreeReinLoad.Visible = False
            mnuCatsTreeCreateBlock.Visible = False
            mnuCatsTreeCreateBuilding.Visible = False
            mnuCatsTreeCreateCatalog.Visible = False
            mnuCatsTreeCreateReinCat.Visible = False
            mnuCatsTreeRenameItem.Visible = checkCatPerm(catID)
            mnuCatsTreeDeleteItem.Visible = True
'            mnuCatsTreeDeleteItem.Enabled = False
'            If clID <> lngCurCatListID Then
                mnuCatsTreeDeleteItem.Enabled = checkCatPerm(catID)
'            End If
            mnuCatsTreeCopy.Visible = checkGroupPerm(usrCurrent.groupID, "part", operModify)
            mnuCatsTreeCopyHere.Visible = checkCatPerm(catID)
            mnuCatsTreeCopyHere.Caption = "Создать рядом копию списка"
            mnuCatsTreePaste.Visible = False
            mnuCatsTreeBindDgn.Visible = False
            mnuCatsTreeCmdLeft.Visible = False
            mnuCatsTreeCmdRight.Visible = False
            mnuCatsTreeAccess.Visible = False
            mnuCatsTreeReload.Visible = False
        ElseIf (left(nd.Tag, Len("docset"))) = "docset" Then
        
            PopupMenu mnuCatsTreePW
            
            Exit Sub
        
        Else
            bShowMenu = False
        End If
        
        
        
        If bShowMenu Then PopupMenu mnuCatsTree
    End If
    
    Exit Sub
    
tvCats_MouseDown_ERR:
    
End Sub

'/******************************************************************************
Private Function loadPositionsMenu(ByRef mc As clsMC, ByRef calcs As Collection, posmcID As Long) As Boolean
'/******************************************************************************

    On Error GoTo loadPositionsMenu_ERR


    
    Dim i As Integer
    Dim cnt As Integer
    
    For i = mnuPositionsMC.Count - 1 To 1 Step -1
        Unload mnuPositionsMC(i)
    Next i
    
    
    i = 0
    cnt = 0
    
    mnuPositions.Tag = 1
    
'    If Not mc Is Nothing Then
'
'        If I > 0 Then Load mnuPositionsMC(I)
'
'        mnuPositionsMC(I).Visible = True
'        mnuPositionsMC(I).Checked = CBool(posmcID = mc.mcID)
'        mnuPositionsMC(I).Caption = mc.mcName
'        mnuPositionsMC(I).Tag = mc.mcID
'
'        cnt = cnt + 1
'
'    End If
    
    
    
    If Not calcs Is Nothing Then
        
        
        Dim m As clsMC
        
        For i = 0 To calcs.Count - 1
            
            If (i + cnt) > 0 Then Load mnuPositionsMC(i + cnt)
            
            Set m = calcs(i + 1)
            
            mnuPositionsMC(i + cnt).Visible = True
            mnuPositionsMC(i + cnt).Checked = CBool(posmcID = m.mcID)
            mnuPositionsMC(i + cnt).Caption = m.mcName
            mnuPositionsMC(i + cnt).Tag = m.mcID
            
            
        Next i
        
        
        
        Load mnuPositionsMC(i + cnt)
        
        mnuPositionsMC(cnt).Visible = True
        mnuPositionsMC(i + cnt).Checked = False
        mnuPositionsMC(i + cnt).Caption = "-"
        mnuPositionsMC(i + cnt).Tag = 0
        
        i = i + 1
        
        
    End If
    
    If i > 0 Then Load mnuPositionsMC(i + cnt)
    
    mnuPositionsMC(i + cnt).Visible = True
    mnuPositionsMC(i + cnt).Checked = False
    mnuPositionsMC(i + cnt).Caption = "удалить позицию"
    mnuPositionsMC(i + cnt).Tag = -1
    
    
    
    
    
    
    
    loadPositionsMenu = True
    


Exit Function

loadPositionsMenu_ERR:
    F1.SB.Panels("status").text = "loadPositionsMenu" & "() - " & err.Description

End Function



'/////////////////////////////////////////////////////////////////////////////////
Private Function loadBuildingMenus(nd As Node) As Boolean



    On Error GoTo loadBuildingMenus_ERR

    
    loadBuildingMenus = False
    
    unloadBuildingMenus
    
    Dim iParentID As Long
    Dim iParentTypeID As Long
    Dim i As Integer
    Dim strNotIn As String
    Dim dnc As Node
    Dim iBCnt As Integer
    Dim strSQL As String
    
    
    
    If LCase(left(nd.KEY, Len("project"))) = "project" Then
        iParentID = Val(right(nd.KEY, Len(nd.KEY) - Len("project")))
    ElseIf LCase(left(nd.KEY, Len("block"))) = "block" Then
        iParentID = Val(right(nd.parent.KEY, Len(nd.parent.KEY) - Len("project")))
    End If
    
    iParentTypeID = selectLongFromBase(cn_data, "i_project", "typeID", "projectID", iParentID)
    
    iBCnt = 0
    
    For i = 0 To nd.children
        If i = 0 Then
            strNotIn = "("
            Set dnc = nd.Child
        Else
            Set dnc = dnc.Next
        End If
        
        If Not dnc Is Nothing Then
        
            If left(dnc.Tag, Len("building")) = "building" Then ' разделитель "|"
        
                strNotIn = strNotIn & Val(right(dnc.Tag, Len(dnc.Tag) - Len("building|"))) & ","
                iBCnt = iBCnt + 1
            
            End If
        
        End If
            
        If i = nd.children Then
            If iBCnt > 0 Then strNotIn = left(strNotIn, Len(strNotIn) - 1) ' удаляем запятую
            strNotIn = strNotIn & ")"
        End If
    Next i
    
    strSQL = "select * from c_building where typeID = " & iParentTypeID
    If iBCnt > 0 Then strSQL = strSQL & " and buildingID not in " & strNotIn
    strSQL = strSQL & " order by buildingCode"
    
    Dim RS As New ADODB.Recordset
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    If RS.EOF Then Exit Function
    
    RS.MoveFirst
    
    Dim bAdded As Boolean
    
    i = 0
    bAdded = False
    
    
    Do Until RS.EOF
        
        
'        If Not checkBildingInTreeNode(RS.Fields("buildingID").Value, nd) Then
            If i > 0 Then Load mnuCatsTreeCreateBuilding0(i)
            mnuCatsTreeCreateBuilding0(i).Caption = RS![buildingCode] & " - " & left(RS![buildingName], 50)
            mnuCatsTreeCreateBuilding0(i).Visible = True
            mnuCatsTreeCreateBuilding0(i).Tag = RS![buildingID]
            bAdded = True
            i = i + 1
'        End If
        
        RS.MoveNext
    Loop
    
    
    loadBuildingMenus = bAdded
    
    
    iLoadedMenuBuildings = i
    
Exit Function

loadBuildingMenus_ERR:

If err.Number = 360 Then ' already loaded
    Resume Next
End If

End Function



'Function checkBildingInTreeNode(ID As Long, nd As Node) As Boolean
'
'    checkBildingInTreeNode = False
'
'
'    Dim n As Long
'    Dim ndtc As Node
'
'    If nd.children > 0 Then ' There are children.
'
'        Dim idtc As Long
'
'
'        n = nd.Child.index
'
'        Set ndtc = nd.Child
'
'        If checkBildingInTreeNode(ID, ndtc) Then
'            checkBildingInTreeNode = True
'            Exit Function
'        End If
'
'        If (Left(ndtc.Tag, Len("building"))) = "building" Then
'            idtc = CLng(Right(ndtc.Tag, Len(ndtc.Tag) - Len("building")))
'            If idtc = ID Then
'                checkBildingInTreeNode = True
'                Exit Function
'            End If
'        End If
'
'
'        While n <> nd.Child.LastSibling.index
'
'            Set ndtc = tvCats.Nodes(n).Next
'
'            If checkBildingInTreeNode(ID, ndtc) Then
'                checkBildingInTreeNode = True
'                Exit Function
'            End If
'
'            If (Left(ndtc.Tag, Len("building"))) = "building" Then
'                idtc = CLng(Right(ndtc.Tag, Len(ndtc.Tag) - Len("building")))
'                If idtc = ID Then
'                    checkBildingInTreeNode = True
'                    Exit Function
'                End If
'            End If
'
'
'            n = tvCats.Nodes(n).Next.index
'        Wend
'    End If
'
'
'End Function


Sub unloadBuildingMenus()


    Dim i As Integer
    
    For i = iLoadedMenuBuildings - 1 To 1 Step -1
        Unload mnuCatsTreeCreateBuilding0(i)
    Next i

    
    iLoadedMenuBuildings = 1

End Sub

'/******************************************************************************
Private Sub fgCatsAddProject(ID As Long)
'/******************************************************************************

    On Error GoTo fgCatsAddProject_ERR


    Dim objID As Long
    Dim typeID As Long
    Dim strProj As String
    Dim strProjCode As String
    
    objID = lngCurCatTreeObjID
    
    Dim RS As New ADODB.Recordset
    
    RS.Open "select * from i_project where projectID = " & ID, cn_data, adOpenStatic, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        If Not IsNull(RS.fields("typeID").Value) Then typeID = RS.fields("typeID").Value
        strProj = RS.fields("projectName").Value & ""
        strProjCode = RS.fields("projectCode").Value & ""
    End If
    
    RS.Close
    Set RS = Nothing
    
    fgCats.AddItem "" & vbTab & "Проект"
    fgCats.Cell(flexcpFontBold, fgCats.Rows - 1, 1) = True
    
    fgCats.AddItem "Тип" & vbTab & selectStringFromBase(cn_srtm, "typelist", "typeName", "typeID", typeID) _
                & vbTab & "i_project" & vbTab & "projectID" & vbTab & ID & vbTab & "typeID" & vbTab & typeID
                
    fgCats.AddItem "Имя" & vbTab & strProj _
                & vbTab & "i_project" & vbTab & "projectID" & vbTab & ID & vbTab & "projectName" & vbTab & strProj
                
    fgCats.AddItem "Код" & vbTab & strProjCode _
                & vbTab & "i_project" & vbTab & "projectID" & vbTab & ID & vbTab & "projectCode" & vbTab & strProjCode


    fgCats.AutoSizeMode = flexAutoSizeColWidth
    fgCats.AutoSize 0, 1
    fgCats.AutoSizeMode = flexAutoSizeRowHeight
    fgCats.AutoSize 0, 1


Exit Sub

fgCatsAddProject_ERR:
    Set RS = Nothing
    F1.SB.Panels("status").text = "fgCatsAddProject" & "() - " & err.Description

End Sub
'/////////////////////////////////////////////////////////////////////////////////
'/******************************************************************************
Private Sub fgCatsAddBlock(ID As Long)
'/******************************************************************************

    On Error GoTo fgCatsAddBlock_ERR


'    Dim prjID As Long
'    prjID = selectLongFromBase(cn_data, "i_block", "projectID", "blockID", ID)
'    fgCatsAddProject prjID
    
    fgCats.AddItem "" & vbTab & "Блок"
    fgCats.Cell(flexcpFontBold, fgCats.Rows - 1, 1) = True
    
    fgCats.AddItem "Номер" & vbTab & selectStringFromBase(cn_data, "i_block", "blockNumber", "blockID", ID) _
                & vbTab & "i_block" & vbTab & "blockNumber" & vbTab & "blockID" & vbTab & ID

    fgCats.AutoSizeMode = flexAutoSizeColWidth
    fgCats.AutoSize 0, 1
    fgCats.AutoSizeMode = flexAutoSizeRowHeight
    fgCats.AutoSize 0, 1

    fgCats.height = (fgCats.Rows + 1) * fgCats.RowHeight(1)

Exit Sub

fgCatsAddBlock_ERR:
    F1.SB.Panels("status").text = "fgCatsAddBlock" & "() - " & err.Description

End Sub
'/////////////////////////////////////////////////////////////////////////////////
Private Sub fgCatsAddBuilding(ID As Long)

    Dim objID As Long
    Dim objectID As Long
    Dim cbldID As Long
    Dim strBldCode As String
    Dim strBldName As String
    
    Dim RS As New ADODB.Recordset
    
    RS.Open "select * from view_object_building where buildingID = " & ID, cn_data, adOpenForwardOnly, adLockReadOnly
    
    
    If Not RS.EOF Then
        RS.MoveFirst
        
        objID = RS.fields("objID").Value
        
        objectID = RS.fields("objectID").Value
        strBldCode = RS.fields("buildingCode").Value
        strBldName = RS.fields("buildingName").Value & ""
        cbldID = RS.fields("cbldID").Value
        
    End If
    
'    If objID = objs("block") Then
'        fgCatsAddBlock objectID
'    ElseIf objID = objs("project") Then
'        fgCatsAddProject objectID
'    Else
'        Exit Sub
'    End If

    objID = objs("building")
    
    fgCats.AddItem "" & vbTab & "Здание"
    fgCats.Cell(flexcpFontBold, fgCats.Rows - 1, 1) = True
    
    fgCats.AddItem "KKS" & vbTab & strBldCode & vbTab & "c_building" & vbTab & "buildingCode" & vbTab & "buildingID" & vbTab & cbldID
    
    fgCats.AddItem "Имя" & vbTab & strBldName & vbTab & "c_building" & vbTab & "buildingName" & vbTab & "buildingID" & vbTab & cbldID
    
    fgCats.AutoSizeMode = flexAutoSizeColWidth
    fgCats.AutoSize 0, 1
    fgCats.AutoSizeMode = flexAutoSizeRowHeight
    fgCats.AutoSize 0, 1
    
    fgCats.height = (fgCats.Rows + 1) * fgCats.RowHeight(1)

End Sub


'/******************************************************************************
Private Function fgCatsAddListOfft(ID As Long, ByRef bListExist As Boolean) As Boolean
'/******************************************************************************

    On Error GoTo fgCatsAddListOfft_ERR

    
    Dim RS As New ADODB.Recordset
    
    Me.fgCatOfft.Rows = 1
'    Me.fgCatOfft.cols = 6

    Dim cnt As Integer
    
   
    Me.fgCatOfft.ColHidden(0) = False
    Me.fgCatOfft.ColHidden(1) = False
    Me.fgCatOfft.ColHidden(2) = False
    Me.fgCatOfft.ColHidden(3) = False
    Me.fgCatOfft.ColHidden(4) = False
    Me.fgCatOfft.ColHidden(5) = False
    
    Me.fgCatOfft.ColAlignment(0) = flexAlignLeftCenter
    Me.fgCatOfft.ColAlignment(1) = flexAlignLeftCenter
    Me.fgCatOfft.ColAlignment(2) = flexAlignLeftCenter
    Me.fgCatOfft.ColAlignment(3) = flexAlignLeftCenter
    Me.fgCatOfft.ColAlignment(4) = flexAlignLeftCenter
    Me.fgCatOfft.ColAlignment(5) = flexAlignLeftCenter
    
    Me.fgCatOfft.TextMatrix(0, 0) = ""
    Me.fgCatOfft.TextMatrix(0, 1) = ""
    Me.fgCatOfft.TextMatrix(0, 2) = ""
    Me.fgCatOfft.TextMatrix(0, 3) = ""
    Me.fgCatOfft.TextMatrix(0, 4) = ""
    Me.fgCatOfft.TextMatrix(0, 5) = ""
    
    RS.Open "select * from view_offtable where objID = " & objs("catlist") & " and objectID = " & ID & " order by partdefID, sortNumber, matID, stdID, diameter, thickness, width, height, srtmName", cn_data, adOpenStatic, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            fgCatOfft.AddItem Replace(globPartDefs(CStr(RS.fields("partdefID").Value)).partdefNameMulti, " ", vbNewLine) & vbTab & _
                            globPosdefs(CStr(RS.fields("posdefID").Value)).PD_NAME & vbTab & _
                            globStds(CStr(RS.fields("stdID").Value)).FULLNUMBER & vbTab & _
                            globMats(CStr(RS.fields("matID").Value)).matName & vbNewLine & globMats(CStr(RS.fields("matID").Value)).MAT_STD.FULLNUMBER & vbTab & _
                            RS.fields("srtmName").Value & vbTab & _
                            Format(RS.fields("mass").Value, sFmt1)
                            
            fgCatOfft.RowData(fgCatOfft.Rows - 1) = RS.fields("offtID").Value
        
            If RS.fields("changes").Value > 0 Then fgCatOfft.Cell(flexcpBackColor, fgCatOfft.Rows - 1, 5) = lngGrey
        
        
            RS.MoveNext
        Loop Until RS.EOF
        
    End If
    
    RS.Close
    Set RS = Nothing
    
    If fgCatOfft.Rows = 1 Then Exit Function
    
    fgCatOfft.AutoSize 0, fgCatOfft.cols - 1
    
    fgCatOfft.MergeCol(0) = True
    fgCatOfft.MergeCol(1) = True
    fgCatOfft.MergeCol(2) = True
    fgCatOfft.MergeCol(3) = True
    

    fgCatOfft.Subtotal flexSTSum, -1, 5, "0.0", lngGrey, , True, "Всего"
    
    
Exit Function

fgCatsAddListOfft_ERR:
    F1.SB.Panels("status").text = "fgCatsAddListOfft" & "() - " & err.Description

End Function


'/******************************************************************************
Public Sub fgCatsAddPositions(catID As Long)
'/******************************************************************************

    On Error GoTo fgCatsAddPositions_ERR

    Dim prt As New clsPart
    Dim r As Long
    
    prt.setPartFromCat catID, True, True, False

    Dim p As clsPos


    fgCatPos.FormatString = "Позиция" & vbTab & "Кол-во" & vbTab & "Масса" & vbTab & "Общ. масса"
    fgCatPos.Rows = 1
    
    fgCatPos.ColAlignment(2) = flexAlignRightCenter
    fgCatPos.ColAlignment(3) = flexAlignRightCenter
    


    For Each p In prt.ps.pm
    
        Set p.fgp = Me.fgCatPos
        
        p.fgAddEmptyRow , False
        r = p.fgp.Rows - 1
        
        p.updatePosRow r, False, True, False, True, False
        p.fgRowToEdit = r
        
    Next p
    
    
    For Each p In prt.ps.pe
    
        Set p.fgp = Me.fgCatPos
        
        p.fgAddEmptyRow , False
        r = p.fgp.Rows - 1
        
        p.updatePosRow r, False, True, False, True, False
        p.fgRowToEdit = r
        
    Next p


    fgCatPos.AddItem "" & vbTab & vbTab & vbTab & vbTab & 0
    fgCatPos.RowHeight(fgCatPos.Rows - 1) = 480
    fgCatPos.Cell(flexcpFontBold, fgCatPos.Rows - 1, 1, , 3) = True
    fgCatPos.IsSubtotal(fgCatPos.Rows - 1) = True
    fgCatPos.TextMatrix(fgCatPos.Rows - 1, 3) = prt.getCommonMassString(" / ")

'    fgCatPos.AutoSize 0, fgCatPos.cols - 1

    fgCatPos.ColHidden(4) = True
    fgCatPos.ColWidth(0) = fgCatPos.width / 10 * 6
    fgCatPos.ColWidth(1) = fgCatPos.width / 10
    fgCatPos.ColWidth(2) = fgCatPos.width / 10 * 1.2
    fgCatPos.ColWidth(3) = fgCatPos.width / 10

Exit Sub

fgCatsAddPositions_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatsAddPositions - Error"

End Sub




'/******************************************************************************
Private Function fgCatsAddList2(ID As Long, ByRef bListExist As Boolean) As Boolean ' NU
'/******************************************************************************

    On Error GoTo fgCatsAddList_ERR

    
    

    
    Dim objectID As Long
    Dim objname As String
    Dim partsCount As Long
    Dim catlistName As String
    Dim catID As Long
    
    Dim RS As New ADODB.Recordset
    
    
    RS.Open "select * from catlist where catlistID = " & ID, cn_data, adOpenForwardOnly, adLockReadOnly
    
    
    If Not RS.EOF Then
        RS.MoveFirst
        objname = "catlist"
        objectID = ID
        catlistName = RS.fields("catlistName").Value & ""
        catID = RS.fields("catID").Value
    Else
        RS.Close
        Set RS = Nothing
        Exit Function
    End If
    
    If Not bFormGridsRedraw Then fgCats.redraw = flexRDNone
    
    
    
    
'    RSP.Open "select count(*) as cnt from view_clist where catlistID = " & ID, cn_data, adOpenForwardOnly, adLockReadOnly
'    If Not RSP.EOF Then
'        RSP.MoveFirst
'        partsCount = RSP.Fields("cnt").Value
'    Else
        partsCount = 0
'    End If
    
'    If objName = "block" Then
'        fgCatsAddBlock objectID
'    ElseIf objName = "project" Then
'        fgCatsAddProject objectID
'    ElseIf objName = "building" Then
'        fgCatsAddBuilding objectID
'    Else
'        Exit Sub
'    End If
    
    Dim obj As clsObj
    Set obj = globObjs(CStr(objs("catlist")))
    
    
    fgCats.AddItem "" & vbTab & obj.objDescr
    fgCats.Cell(flexcpFontBold, fgCats.Rows - 1, 1) = True
    
    fgCats.AddItem "Имя" & vbTab & catlistName _
                   & vbTab & "catlist" & vbTab & "catlistName" & vbTab & "catlistID" & vbTab & ID
    
    
    
    fgCatTree.Rows = 1
'    fgCatTree.cols = 1
    fgCatTree.ColAlignment(0) = flexAlignLeftCenter

    
    RS.NextRecordset
    
    RS.Open "select distinct partName, partID, partSortNumber, objID from gocatlist(" & ID & ") order by partSortNumber", cn_data, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        
        
        RS.MoveFirst
        Do
            
            fgCatTree.AddItem RS.fields("partName").Value
            
            fgCatTree.RowData(fgCatTree.Rows - 1) = RS.fields("partID").Value
            
            If RS.fields("objID").Value = objs("catlist") Then bListExist = True
            
            partsCount = partsCount + 1
            
            RS.MoveNext
        Loop Until RS.EOF
        
        
        
    End If
    
    
    RS.Close
    
    Set RS = Nothing
    
    fgCats.AddItem "Количество изделий" & vbTab & partsCount
    
    
    fgCats.height = (fgCats.Rows + 1) * fgCats.RowHeight(1)
    If Not bFormGridsRedraw Then fgCats.redraw = flexRDDirect
    
    
'    Me.fgCatTree.Enabled = False ' так как содержимое catlist
    
    
Exit Function

fgCatsAddList_ERR:
    If Not bFormGridsRedraw Then fgCats.redraw = flexRDDirect
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgCatsAddList - Error"

End Function



'/******************************************************************************
Public Sub fgCatAddDocSetRow(ct As clsCat, FG As VSFlexGrid, Row As Long, bEvent As Boolean)
'/******************************************************************************

    On Error GoTo fgCatAddDocSetRow_ERR

    If ct Is Nothing Then Exit Sub
    
    If Row < 1 Then Exit Sub
    If Row > FG.Rows Then Exit Sub
    
    Dim bHC As Boolean
    
    If Row < FG.Rows Then
        If FG.TextMatrix(Row, 2) = "i_catalog" And FG.TextMatrix(Row, 5) = "catNum" Then
            FG.RemoveItem Row
            FG.height = FG.height - FG.RowHeight(1)
            bHC = True
        End If
    End If
    
    If Row < FG.Rows Then
        If FG.TextMatrix(Row, 2) = "docset" And FG.TextMatrix(Row, 5) = "docsetLevel" Then
            FG.RemoveItem Row
            FG.height = FG.height - FG.RowHeight(1)
            bHC = True
        End If
    End If
    

    If Not ct.bUnif And ct.CAT_CATDEF.bIsDocSet Then
        If ct.iStatus = pstUstar Or ct.iStatus = pstArchive Then
    
            If ct.dsDrawID > 0 Then
                FG.AddItem "Номер комплекта" & vbTab & ct.getDocSetNumber, Row
    '            FG.Cell(flexcpFontBold, fgToAdd.Rows - 1, 1) = True
            Else
                FG.AddItem "Номер комплекта" & vbTab & ct.CAT_DS_NUM_Lite, Row
            End If
        Else
            FG.AddItem "Номер (уровень-комплект)" & vbTab & ct.CAT_DS_NUM_Lite _
                           & vbTab & "i_catalog" & vbTab & "catID" & vbTab & ct.catID & vbTab & "catNum" & vbTab & ct.iStatus, Row
            FG.EditMask = "&&-0000"
        End If
        
        
'        If ct.dsDrawID > 0 Then
'
'            Dim ds As clsDocSet
'
'            Set ds = globDocSets(CStr(ct.dsDrawID))
'            FG.AddItem "Уровень отметки" & vbTab & getLevSign(ds.docsetLevel, "По номеру каталога") _
'                & vbTab & "docset" & vbTab & "dsID" & vbTab & ct.dsDrawID & vbTab & "docsetLevel" & vbTab & ct.iStatus, Row + 1
'
'        End If
        
        
        FG.height = FG.height + FG.RowHeight(1)
        bHC = Not bHC
        
    End If
        
    If bEvent And bHC Then elCatsInf.AutoSizeChildren = azUnevenVert


Exit Sub

fgCatAddDocSetRow_ERR:
    F1.SB.Panels("status").text = "fgCatAddDocSetRow" & "() - " & err.Description

End Sub

'/******************************************************************************
Public Sub fgCatsAddCatalogPW(fgToAdd As VSFlexGrid, ID As Long, Optional bOnlyParent As Boolean = False)
'/******************************************************************************

    On Error GoTo fgCatsAddCatalogPW_ERR

    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    

    strSQL = "select * from view_object_catalog_pw where dsID = " & ID

    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        
        Dim i As Integer
        For i = 1 To RS.fields.Count - 1
        
            If Len(Trim(RS.fields(i).Value & "")) > 0 And InStr(1, RS.fields(i).Name & "", "project", vbTextCompare) > 0 Then
                fgToAdd.AddItem " " & vbTab & RS.fields(i).Value
            End If

        Next i


    End If
    
    RS.Close
    Set RS = Nothing


Exit Sub

fgCatsAddCatalogPW_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgCatsAddCatalogPW - Error"

End Sub



'/////////////////////////////////////////////////////////////////////////////////
'/******************************************************************************
Public Sub fgCatsAddCatalog(fgToAdd As VSFlexGrid, ID As Long, Optional bOnlyParent As Boolean = False)
'/******************************************************************************
    
    On Error GoTo fgCatsAddCatalog_ERR
    
'    If Not bFormGridsRedraw Then fgToAdd.redraw = flexRDNone
    
'    Dim Item As ListItem
'    For Each Item In fgCatTree.ListItems
'        If Item.Selected = True Then
'            Item.Selected = False
'        End If
'    Next

'    fgCatTree.Rows = 1
'    fgCatTree.cols = 1
'    fgCatTree.ColAlignment(0) = flexAlignLeftCenter
    
    Dim objID As Long
    Dim objectID As Long
    Dim catName As String
    Dim catTypeName As String
    Dim catTypeID As Long
    Dim li As ListItem
    Dim bUnif As Boolean
    Dim partsCount(1 To 2) As Long
    Dim dblMass As Double
    Dim dsDrawID As Long
    Dim dsPrLtID As Long
    Dim iCatStatus As pst
    Dim catdefID As Long
    
    Dim RS As New ADODB.Recordset
'    Dim RSP As New ADODB.Recordset
'    Dim RSA As New ADODB.Recordset
    
    Dim strSQL As String
    
    strSQL = "select *"
    strSQL = strSQL & ",(select COUNT(*) from [part] where [part].catID = [view_object_catalog].catID and [part].deleted=0) as cnt"
    strSQL = strSQL & ",(select COUNT(*) from [part] where [part].catID = [view_object_catalog].catID and [part].deleted=1) as dcnt"
    strSQL = strSQL & ",(select sum(posCommonMass) from view_position where view_position.catID = [view_object_catalog].catID and view_position.deleted=0) as mass"
    strSQL = strSQL & " from view_object_catalog where catID = " & ID
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        objID = RS.fields("objID").Value
        objectID = RS.fields("objectID").Value
        catName = RS.fields("catName").Value & ""
        catTypeID = RS.fields("catTypeID").Value
        catTypeName = cattypes(catTypeID).ctName
        bUnif = CBool(RS.fields("catUnif").Value)
        partsCount(1) = RS.fields("cnt").Value
        partsCount(2) = RS.fields("dcnt").Value
        dsDrawID = RS.fields("dsDrawingsID").Value
        dsPrLtID = RS.fields("dsPartListID").Value
        If Not IsNull(RS.fields("mass").Value) Then dblMass = RS.fields("mass").Value
        iCatStatus = RS.fields("catStatus").Value
    Else
        Exit Sub
    End If
    
'    Me.fgCatTree.Enabled = True
    
'    Me.fgCatTree.Tag = ID
    
    
'    If objID = objs("block") Then
'        fgCatsAddBlock objectID
'    ElseIf objID = objs("project") Then
'        fgCatsAddProject objectID
'    ElseIf objID = objs("building") Then
'        fgCatsAddBuilding objectID
'    ElseIf objID = objs("catalog") Then
'        fgCatsAddCatalog objectID, True
'    End If
'
'    If bOnlyParent Then Exit Sub
    
'    fgCatTree.ColAlignment(0) = flexAlignLeftCenter

    Dim ct As clsCat
    Set ct = cCats(CStr(ID))
    
    
    objID = objs("catalog")
    
'    fgToAdd.AddItem "" & vbTab & "Каталог"
'    fgToAdd.Cell(flexcpFontBold, fgToAdd.Rows - 1, 1) = True
'    If bUnif Then fgToAdd.TextMatrix(fgToAdd.Rows - 1, 1) = "Унифицированный" & fgToAdd.TextMatrix(fgToAdd.Rows - 1, 1)


    fgToAdd.AddItem "Наименование" & vbTab & ct.catName

    fgToAdd.AddItem "Статус" & vbTab & stts(iCatStatus) _
                   & vbTab & "i_catalog" & vbTab & "catID" & vbTab & ID & vbTab & "catStatus" & vbTab & iCatStatus
                   
    If ct.pw_ds_fld_ID = 0 Then
        fgToAdd.AddItem "Конструкция" & vbTab & ct.CAT_CATDEF.cdName _
                   & vbTab & "i_catalog" & vbTab & "catID" & vbTab & ID & vbTab & "catdefID" & vbTab & ct.catdefID
        fgCatAddDocSetRow ct, fgToAdd, fgToAdd.Rows, False
    End If
                   
                   
'    If Not ct.bUnif And ct.CAT_CATDEF.bIsDocSet Then
'        If iCatStatus = pstUstar Or iCatStatus = pstArchive Then
'
'            If dsDrawID > 0 Then
'                fgToAdd.AddItem "Номер комплекта" & vbTab & ct.getDocSetNumber
'    '            fgToAdd.Cell(flexcpFontBold, fgToAdd.Rows - 1, 1) = True
'            Else
'                fgToAdd.AddItem "Номер комплекта" & vbTab & ct.CAT_DS_NUM_Lite
'            End If
'        Else
'            fgToAdd.AddItem "Номер (уровень-комплект)" & vbTab & ct.CAT_DS_NUM_Lite _
'                           & vbTab & "i_catalog" & vbTab & "catID" & vbTab & ID & vbTab & "catNum" & vbTab & iCatStatus
'            fgToAdd.EditMask = "00-0000"
'        End If
'    End If

                   
'    fgToAdd.AddItem "Путь" & vbTab & cCats(CStr(ID)).getCatPath
    
'    fgToAdd.AddItem "Имя" & vbTab & catName _
'                   & vbTab & "i_catalog" & vbTab & "catName" & vbTab & "catID" & vbTab & ID
    
    fgToAdd.AddItem "Тип" & vbTab & catTypeName _
                   & vbTab & "i_catalog" & vbTab & "catID" & vbTab & ID & vbTab & "catTypeID" & vbTab & catTypeID

    
    fgToAdd.AddItem "Количество изделий" & vbTab & partsCount(1)
    If partsCount(2) > 0 Then fgToAdd.TextMatrix(fgToAdd.Rows - 1, 1) = fgToAdd.TextMatrix(fgToAdd.Rows - 1, 1) & " (в корзине " & partsCount(2) & ")"
    
    fgToAdd.AddItem "Маcса изделий каталога" & vbTab & Format(dblMass, "###,###,###")
    
'    fgCatTree.Rows = 1
'
'    RSA.Open "select partName, partID, partVersion, link  from view_part2 where catID = " & ID & " and deleted = 0 order by partSortNumber", cn_data, adOpenForwardOnly, adLockReadOnly
'
'    If Not RSA.EOF Then
'
'
'        RSA.MoveFirst
'        Do
'
'
'            fgCatTree.AddItem RSA.Fields("partName").Value
'            fgCatTree.RowData(fgCatTree.Rows - 1) = RSA.Fields("partID").Value
'            If Len(Trim(RSA.Fields("partVersion").Value & "")) > 0 Then
'                fgCatTree.TextMatrix(fgCatTree.Rows - 1, 0) = fgCatTree.TextMatrix(fgCatTree.Rows - 1, 0) & "(" & RSA.Fields("partVersion").Value & "" & ")"
'            End If
'            If RSA.Fields("link").Value = 0 Then fgCatTree.Cell(flexcpFontBold, fgCatTree.Rows - 1, 0) = True
'
'            RSA.MoveNext
'        Loop Until RSA.EOF
'
'
'
'    End If
'
'    fgCatTree.AutoSize 0, fgCatTree.cols - 1
    
    
    
    RS.Close
'    RSP.Close
'    RSA.Close
    
    Set RS = Nothing
'    Set RSP = Nothing
'    Set RSA = Nothing
    
'    fgToAdd.AutoSizeMode = flexAutoSizeColWidth
'    fgToAdd.AutoSize 0, 1
'    fgToAdd.AutoSizeMode = flexAutoSizeRowHeight
'    fgToAdd.AutoSize 0, 1
'
'
'    fgToAdd.height = (fgToAdd.Rows + 1) * fgToAdd.RowHeight(1)
'    If Not bFormGridsRedraw Then fgToAdd.redraw = flexRDDirect
    
    
    Exit Sub
    
fgCatsAddCatalog_ERR:
'    If Not bFormGridsRedraw Then fgToAdd.redraw = flexRDDirect
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgCatsAddCatalog - Error"
    
End Sub


Private Sub tvCats_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    
    Dim prntID As Long
    Dim catID As Long
    Dim clID As Long
    Dim ndCur As Node
    
    
    If Button = 1 Then
    
        Set ndCur = tvCats.SelectedItem
        
        If ndCur Is Nothing Then Exit Sub
        
        If dDragX = 0 And dDragY = 0 Then Exit Sub
        
        If left(ndCur.KEY, Len("catalog")) = "catalog" Then
        
            catID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catalog")))
            
            If left(ndCur.parent.KEY, Len("catalog")) = "catalog" Then
                prntID = Val(right(ndCur.parent.KEY, Len(ndCur.parent.KEY) - Len("catalog")))
            End If
            
        ElseIf left(ndCur.KEY, Len("catlist")) = "catlist" Then
        
            clID = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("catlist")))
            catID = Val(right(ndCur.parent.KEY, Len(ndCur.parent.KEY) - Len("catalog")))
            
        Else
            Exit Sub
        End If
        
        If Abs(dDragX - X) > 50 And Abs(dDragY - Y) > 50 Then
        
            If catID > 0 Then
                If prntID > 0 Then
                    If checkCatPerm(prntID) And checkCatPerm(catID) Then tvCats.Drag
                ElseIf clID > 0 Then
                    If checkCatPerm(catID) Then tvCats.Drag
                Else
                    If checkGroupPerm(0, "catalog", operModify) And checkCatPerm(catID) Then tvCats.Drag
                End If
            End If
            
        End If
    End If
    
    
End Sub

'/******************************************************************************
Public Function getNodeIds(nd As Node, ByRef objID As Long, ByRef objectID As Long, bUpdateCurIds As Boolean, Optional ByRef iPwBldSub As pwbldsub = pwbldsubNon) As Boolean
'/******************************************************************************

    On Error GoTo getNodeIds_ERR

    If (left(nd.Tag, Len("project"))) = "project" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("project")))
        objID = objs("project")
    ElseIf (left(nd.Tag, Len("block"))) = "block" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("block")))
        objID = objs("block")
    ElseIf (left(nd.Tag, Len("building"))) = "building" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("building")))
        objID = objs("building")
    ElseIf (left(nd.Tag, Len("catalog"))) = "catalog" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
        objID = objs("catalog")
    ElseIf (left(nd.Tag, Len("catlist"))) = "catlist" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("catlist")))
        objID = objs("catlist")
    ElseIf (left(nd.Tag, Len("docset"))) = "docset" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("docset")))
        objID = objs("docset")
    ElseIf (left(nd.Tag, Len("pwblock"))) = "pwblock" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("pwblock")))
        objID = objs("pwblock")
    ElseIf (left(nd.Tag, Len("pwbld"))) = "pwbld" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("pwbld")))
        objID = objs("pwbld")
    ElseIf (left(nd.Tag, Len("pwcat"))) = "pwcat" Then
        objectID = CLng(right(nd.parent.KEY, Len(nd.parent.KEY) - Len("pwbld")))
        objID = objs("pwbld")
        iPwBldSub = pwbldsubCat
    ElseIf (left(nd.Tag, Len("pwset"))) = "pwset" Then
        objectID = CLng(right(nd.parent.KEY, Len(nd.parent.KEY) - Len("pwbld")))
        objID = objs("pwbld")
        iPwBldSub = pwbldsubSet
    ElseIf (left(nd.Tag, Len("pwmod"))) = "pwmod" Then
        'objectID = CLng(right(nd.parent.KEY, Len(nd.parent.KEY) - Len("pwbld")))
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("pwmod")))
        objID = objs("pwbld")
        iPwBldSub = pwbldsubMod
    ElseIf (left(nd.Tag, Len("pwfolder"))) = "pwfolder" Then
        objectID = CLng(right(nd.KEY, Len(nd.KEY) - Len("pwfolder")))
        objID = objs("pwfolder")
    End If
    
    If bUpdateCurIds Then
        lngCurCatTreeObjID = objID
        lngCurCatTreeSelectedID = objectID
    End If

    getNodeIds = True

Exit Function

getNodeIds_ERR:

End Function




'/////////////////////////////////////////////////////////////////////////////////
Private Sub tvCats_NodeClick(ByVal Node As MSComctlLib.Node)

    Dim ID As Long
    Dim objID As Long
    Dim bNoAdd As Boolean
    
    Dim pID As Long
    Dim pobjID As Long
    
    If Not bFormGridsRedraw Then fgCats.redraw = flexRDNone
    
    fgCats.Rows = 1
    
    Dim bVis(4) As Boolean
    
    fgCats.ColHidden(2) = True
    fgCats.ColHidden(3) = True
    fgCats.ColHidden(4) = True
    fgCats.ColHidden(5) = True
    fgCats.ColHidden(6) = True
    
    Me.fgCatTree.ColAlignment(0) = flexAlignLeftCenter
    Me.fgCatTree.ColAlignment(1) = flexAlignLeftCenter
    Me.fgCatTree.ColAlignment(2) = flexAlignLeftCenter
    Me.fgCatTree.ColAlignment(3) = flexAlignLeftCenter
    Me.fgCatTree.ColAlignment(4) = flexAlignLeftCenter
    Me.fgCatTree.ColAlignment(5) = flexAlignLeftCenter

    fgCatTree.MergeCol(0) = False
    fgCatTree.MergeCol(1) = False
    fgCatTree.MergeCol(2) = False
    fgCatTree.MergeCol(3) = False


    fgCats.ColAlignment(1) = flexAlignLeftCenter
    
    Me.tbCats.Buttons("InList").Enabled = False
    
    If Not getNodeIds(Node, objID, ID, True) Then Exit Sub
    
    Me.fgCatTree.Tag = ""

    If bFormTabsHide Then
    ctabCat.TabVisible(0) = False
    ctabCat.TabVisible(1) = False
    ctabCat.TabVisible(2) = False
    ctabCat.TabVisible(3) = False
    ctabCat.TabVisible(4) = False
    End If

'    fgCatTree.Visible = False
'    fgCatSpec.Visible = False
'    fgCatOfft.Visible = False
'    fgCatPos.Visible = False

    If Not bFormGridsRedraw Then
    fgCatTree.redraw = flexRDNone
    fgCatSpec.redraw = flexRDNone
    fgCatOfft.redraw = flexRDNone
    fgCatPos.redraw = flexRDNone
    fgCatFiles.redraw = flexRDNone
    End If

    fgCatTree.Rows = 1
    fgCatSpec.Rows = 1
    fgCatOfft.Rows = 1
    fgCatPos.Rows = 1
    fgCatFiles.Rows = 1

    Dim ct As clsCat


    If objID = objs("project") Then
        
        fgCatsAddProject ID
        
    ElseIf objID = objs("block") Then
        
        fgCatsAddBlock ID
        
    ElseIf objID = objs("pwblock") Then
        
        fgCatsAddBlock ID
        
    ElseIf objID = objs("building") Then
        
'        fgCatsAddBuilding ID
        
        loadCmdCat fgCatTree, False, objs("building"), ID, cn_data
        
        ctabCat.CurrTab = 0
        bVis(0) = True
        
    ElseIf objID = objs("docset") Then
    
        fgCatsAddCatalogPW fgCats, ID
    
    
    ElseIf objID = objs("catalog") Then
        
        fgCatsAddCatalog fgCats, ID

        Me.tbCats.Buttons("InList").Enabled = CBool(lngCurCatListID > 0) And checkGroupPerm(usrCurrent.groupID, "catlist", operModify)
        
        Set ct = cCats(CStr(ID))
        
'        If ct.iStatus = pstArchive Or ct.iStatus = pstUstar And ct.catListID > 0 Then
'            loadCmdListContent fgCatTree, False, ct.catListID, cn_data, 0 ' ID
'        Else
'        End If
        
        If ctabCat.CurrTab = 0 Then
            loadCmdParts fgCatTree, False, ID, cn_data
            Me.fgCatTree.Tag = ID
        End If
        
        If ctabCat.CurrTab = 1 Then
            fgCatsAddListSpec ct.catListID, bNoAdd
        End If
        
        If ctabCat.CurrTab = 2 Then
            fgCatsAddListOfft ct.catListID, bNoAdd
        End If
        
        If ctabCat.CurrTab = 3 Then
            fgCatsAddPositions ID
        End If
        
        'fgCatsAddFiles ID
        
        If ctabCat.CurrTab = 4 Then
            fgCatsAddPartsModel ID
        End If
        
        bVis(0) = True
        bVis(1) = True
        bVis(2) = True
        bVis(3) = True
        bVis(4) = True
        
    ElseIf objID = objs("catlist") Then
    
        
        If getNodeIds(Node.parent, pobjID, pID, False) Then
            Set ct = cCats(CStr(pID))
        End If
        
        Me.fgCatTree.Tag = ct.catID
        
'        fgCatTree.Visible = True
        
'        If ct.iStatus = pstArchive Or ct.iStatus = pstUstar Then
'        End If
        
        If ctabCat.CurrTab = 2 Then
            fgCatsAddListOfft ID, bNoAdd
        End If
        
        If ctabCat.CurrTab = 1 Then
            fgCatsAddListSpec ID, bNoAdd
        End If
        
        If ctabCat.CurrTab = 0 Then
            loadCmdListContent fgCatTree, False, ID, cn_data
        End If
        
        Me.tbCats.Buttons("InList").Enabled = CBool(lngCurCatListID > 0) And bNoAdd = False And checkGroupPerm(usrCurrent.groupID, "catlist", operModify)

        If ctabCat.CurrTab = 3 Then ctabCat.CurrTab = 0
        If ctabCat.CurrTab = 4 Then ctabCat.CurrTab = 0
        bVis(0) = True
        bVis(1) = True
        bVis(2) = True
        
    End If
    
    
    fgCats.AutoSizeMode = flexAutoSizeColWidth
    fgCats.AutoSize 0, 1
    fgCats.AutoSizeMode = flexAutoSizeRowHeight
    fgCats.AutoSize 0, 1
    
    fgCats.height = (fgCats.Rows) * fgCats.RowHeight(fgCats.Rows - 1)
    
    
    elCatsInf.AutoSizeChildren = azUnevenVert
    
    
    Dim strNoteTag As String
    
'    strNoteTag = Replace(Node.Tag, "_noload", "")
    strNoteTag = Replace(Node.Tag, "0", "")
    strNoteTag = Replace(strNoteTag, "1", "")
    strNoteTag = Replace(strNoteTag, "2", "")
    strNoteTag = Replace(strNoteTag, "3", "")
    strNoteTag = Replace(strNoteTag, "4", "")
    strNoteTag = Replace(strNoteTag, "5", "")
    strNoteTag = Replace(strNoteTag, "6", "")
    strNoteTag = Replace(strNoteTag, "7", "")
    strNoteTag = Replace(strNoteTag, "8", "")
    strNoteTag = Replace(strNoteTag, "9", "")
    
    If ID > 0 Then loadLog strNoteTag, ID
    
    If Not bFormGridsRedraw Then fgCats.redraw = flexRDDirect
    
    
'    fgCatTree.Visible = bVis(0)
'    fgCatSpec.Visible = bVis(1)
'    fgCatOfft.Visible = bVis(2)
'    fgCatPos.Visible = bVis(3)
    
    If Not bFormGridsRedraw Then
    fgCatTree.redraw = flexRDDirect
    fgCatSpec.redraw = flexRDDirect
    fgCatOfft.redraw = flexRDDirect
    fgCatPos.redraw = flexRDDirect
    'fgCatFiles.redraw = flexRDDirect
    End If
    
    If bFormTabsHide Then
    ctabCat.TabVisible(0) = bVis(0)
    ctabCat.TabVisible(1) = bVis(1)
    ctabCat.TabVisible(2) = bVis(2)
    ctabCat.TabVisible(3) = bVis(3)
    ctabCat.TabVisible(4) = bVis(4)
    End If
    
    

End Sub


'/******************************************************************************
Public Sub loadLog(objname As String, objectID As Long)
'/******************************************************************************

    On Error GoTo loadLog_ERR
    
    Dim pcnt As Long
    Dim ccnt As Long

    If objectID = 0 Then
        fgOps.Rows = 0
'        fgOps.AddItem "ошибка" & vbTab & vbTab & "objectID = 0"
        Exit Sub
    End If

    Dim RS As New ADODB.Recordset
    
    Dim strSQL As String
    
    If objname = "srtm" Then
        strSQL = "select count(*) from position as pcnt where srtmID = " & objectID
        RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF Then pcnt = RS.fields(0).Value
        RS.Close
        strSQL = "select count(*) from catpos as ccnt where srtmID = " & objectID
        RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF Then ccnt = RS.fields(0).Value
        RS.Close
        
    End If
    
    
    strSQL = "SELECT "
    strSQL = strSQL & conn.strSrtmName & ".dbo.operation.operDescr, "
    strSQL = strSQL & conn.strSrtmName & ".dbo.usr.usrLogin, "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.oplogDate, "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.what "
    strSQL = strSQL & "FROM "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog "
    
    strSQL = strSQL & "INNER JOIN "
    strSQL = strSQL & conn.strSrtmName & ".dbo.operation "
    strSQL = strSQL & "ON "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.operID "
    strSQL = strSQL & "= "
    strSQL = strSQL & conn.strSrtmName & ".dbo.operation.operID "
    
    strSQL = strSQL & "INNER JOIN "
    strSQL = strSQL & conn.strSrtmName & ".dbo.usr "
    strSQL = strSQL & "ON "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.usrID "
    strSQL = strSQL & "= "
    strSQL = strSQL & conn.strSrtmName & ".dbo.usr.usrID "
    
    strSQL = strSQL & "WHERE "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.objID = " & objs(objname) & " "
    
    strSQL = strSQL & "AND "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.objectID = " & objectID & " "
    
    strSQL = strSQL & "ORDER BY "
    strSQL = strSQL & conn.strBaseName & ".dbo.operationslog.oplogDate"
    
    
    
    RS.Open strSQL, cn_data, adOpenStatic, adLockReadOnly
    
    Set fgOps.DataSource = RS
    
    fgOps.ColDataType(2) = flexDTDate
    

    If objname = "srtm" Then
    fgOps.AddItem "объект" & vbTab & objname & vbTab & objectID & vbTab & "pos " & pcnt & ", catpos " & ccnt, 0
    Else
    fgOps.AddItem "объект" & vbTab & objname & vbTab & objectID, 0
    End If
    
    fgOps.AutoSize 0, fgOps.cols - 1

    RS.Close
    Set RS = Nothing
    

Exit Sub

loadLog_ERR:
    Me.SB.Panels("status").text = "loadLog() - " & err.Description

End Sub



'/******************************************************************************
Private Sub tvParts_AfterLabelEdit(Cancel As Integer, NewString As String)
'/******************************************************************************

    On Error GoTo tvParts_AfterLabelEdit_ERR

    
    curPart.saveName NewString
    
    NewString = curPart.getNodeName
    
    checkCatParts
    
    
Exit Sub

tvParts_AfterLabelEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvParts_AfterLabelEdit - Error"

End Sub

Private Sub tvParts_BeforeLabelEdit(Cancel As Integer)

    If curPart Is Nothing Then Cancel = 1
    
    tvParts.SelectedItem.text = curPart.partName ' чтобы убрать rev



End Sub

'/******************************************************************************
Private Sub tvParts_DblClick()
'/******************************************************************************

    On Error GoTo tvParts_DblClick_ERR

    Exit Sub '######################################3
    
    If curPart Is Nothing Then Exit Sub
    
    Dim msapp As Object
    
    If curPart.ps.pm.Count > 0 Then
        
        Dim p As clsPos
        Set p = curPart.ps.pm(1)
        Dim pPipe As clsPos
        Dim pList As clsPos
        Dim pr(0 To 2) As clsProp
        
        '        Dim prop As clsProp
        '        For Each prop In pos_props
        '        Next prop
        
        If curPart.typeID = 5 Or curPart.typeID = 6 Or curPart.typeID = 7 Then ' проходка
        
            Set msapp = getMS
            If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
            
            msapp.CadInputQueue.SendKeyin "vba run [so2]db.pen " & curPart.partName & "-" & curPart.partID
        
            Set msapp = Nothing

            
            
        ElseIf p.pos_props.existsProperty("length") And p.pos_props.existsProperty("width") And p.pos_props.existsProperty("thickness") Then
            
            
            Set msapp = getMS
            If msapp Is Nothing Then MsgBox sCommonMessage: Exit Sub
            
            Set pr(0) = p.pos_props("length")
            Set pr(1) = p.pos_props("width")
            Set pr(2) = p.pos_props("thickness")
            

            
            msapp.CadInputQueue.SendKeyin "vba run [so2]db.emb " & pr(0).PVAL & "x" & pr(1).PVAL & "x" & pr(2).PVAL & "x" & curPart.partID & "x" & curPart.partName
            
            
            Set msapp = Nothing

            
        End If
        
    End If
    
    
    Set msapp = Nothing
    
    
Exit Sub

tvParts_DblClick_ERR:
    Set msapp = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "tvParts_DblClick - Error"

End Sub

Private Sub tvParts_DragDrop(source As Control, X As Single, Y As Single)
    
    Dim ndprnt As Node
    Dim ndCur As Node
    Dim ndNew As Node
    Dim k As String
    Dim pk As String
    Dim t As String
    Dim pt As String
    Dim im As String
    
    Dim IDcur As Long
    Dim IDprnt As Long
    
    ' возможность устанавливать зависимость временно убрана, ну или не временно...
    '=======================
    Exit Sub
    '=======================
    
'    Set ndCur = tvParts.SelectedItem
'    Set ndPrnt = tvParts.DropHighlight
'    '    Set ndPrnt = tvParts.HitTest(x, y)
'
'
'    If ndCur Is Nothing Then Exit Sub
'    If ndPrnt Is Nothing Then Exit Sub
'
'    If Not LCase(left(ndPrnt.KEY, Len("part"))) = "part" Then Exit Sub
'    If Not LCase(left(ndCur.KEY, Len("part"))) = "part" Then Exit Sub
'
'    IDcur = Val(right(ndCur.KEY, Len(ndCur.KEY) - Len("part")))
'
'    If left(ndPrnt.Parent.KEY, Len("part")) = "part" Then
'        Set ndPrnt = ndPrnt.Parent
'    End If
'
'    IDprnt = Val(right(ndPrnt.KEY, Len(ndPrnt.KEY) - Len("part")))
'
'
'    If IDprnt <> IDcur Then
'
'
'        pk = ndPrnt.KEY
'        k = ndCur.KEY
'        t = ndCur.text
'        pt = ndPrnt.text
'        im = CStr(ndCur.Image)
'
'
'
'        If updateTableInBase(cn_data, "part", "parentID", IDprnt, "partID", IDcur) Then
'
'            tvParts.Nodes.Remove ndCur.KEY
'
'            If addTreeNode(tvParts, ndNew, pk, tvwChild, k, t, im) Then
'
'                ndPrnt.Expanded = True
'                ndNew.bOld = True
'                tvParts.SelectedItem = ndNew
'
'            End If
'
'            Call writeOperationS(operModify, "part", IDcur, "установка зависимости от " & pt)
'
'        End If
'
'
'    End If
'
'
'    Set tvParts.DropHighlight = Nothing
'
'    tvParts.Refresh
    
    
End Sub

Private Sub tvParts_DragOver(source As Control, X As Single, Y As Single, State As Integer)
    
'    Dim nd As Node
'    Set nd = tvParts.HitTest(X, Y)
'
'    Dim ndsel As Node
'    Set ndsel = tvParts.SelectedItem
'
'    If nd Is Nothing Then Exit Sub
'    If ndsel Is Nothing Then Exit Sub
'
'
'    If LCase(left(nd.KEY, Len("part"))) = "part" And LCase(left(ndsel.KEY, Len("part"))) = "part" Then Set tvParts.DropHighlight = nd
        
    
    
End Sub

Private Sub tvParts_LostFocus()

tvParts.ToolTipText = ""

End Sub

Private Sub tvParts_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    
    Dim bMulti As Boolean
    Dim ID As Long
    Dim nd As Node
    Dim ndc As Node
    Dim icnt As Long
    Dim iCount(2) As Long
    Dim bCnt(2) As Boolean
    Dim bRecycle As Boolean
    Dim bIsLink As Boolean
    Dim sAddTextDel As String
    Dim sAddTextCopy As String
    Dim sAddTextLink As String
    Dim sAddTextStatus As String
    Dim iLinks As Integer
    Dim prt As clsPart
    
    bRecycle = tbPart.Buttons("ShowDeleted").Value = tbrPressed
    
    If Button = 2 Then
    
        Set colParts = New Collection
    
        For Each nd In tvParts.Nodes
            
            If LCase(left(nd.KEY, Len("part"))) = "part" And nd.Checked = True Then
                
                Set prt = New clsPart
                prt.partID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
                prt.bIsLink = CBool(nd.Image = "link")
                If prt.bIsLink Then
                    prt.part_prntID = Val(nd.Tag) ' link id
                Else
                    prt.partStatusID = Val(right(nd.Image, Len(nd.Image) - Len("part")))
                End If
                prt.partName = nd.text
                colParts.Add prt
                Set prt = Nothing
                
            End If
            
        Next
        
        If colParts.Count = 0 Then
        
            Set nd = tvParts.HitTest(X, Y)
            
            If nd Is Nothing Then Exit Sub
            
            Set tvParts.SelectedItem = nd
            
            Set prt = New clsPart
            prt.partID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
            prt.bIsLink = CBool(nd.Image = "link")
            If prt.bIsLink Then
                prt.part_prntID = Val(nd.Tag) ' link id
            Else
                prt.partStatusID = Val(right(nd.Image, Len(nd.Image) - Len("part")))
            End If
            prt.partName = nd.text
            colParts.Add prt
            Set prt = Nothing
        
        Else
            bMulti = True
        
        End If
        
        mnuPartsTreeNoParent.Visible = False
        mnuPartsTreeGoLink.Visible = False
        mnuPartsTreeDelete.Visible = False
        mnuPartsTreeDeleteChecked.Visible = False
        mnuPartsTreeRestore.Visible = False
        mnuPartsTreeFile.Visible = False
        mnuPartsTreeErase.Visible = False
        mnuPartsTreePart.Visible = False
        
        
        
        For Each prt In colParts
            
            '        Debug.Print nd.KEY, nd.Image
            
                
            If prt.bIsLink Then
                bCnt(0) = True ' del
                bCnt(1) = False ' change
                bCnt(2) = False ' status
                iLinks = iLinks + 1
                sAddTextLink = " (" & prt.partName & ")"
            ElseIf prt.partStatusID = pst.pstRazrabotka Then
                bCnt(0) = True ' del
                bCnt(1) = True ' change
                bCnt(2) = checkPartPerm(prt.partID, operOverStatus) ' status
            ElseIf prt.partStatusID = pst.pstProvereno Then
                bCnt(0) = True ' del
                bCnt(1) = False ' change
                bCnt(2) = checkPartPerm(prt.partID, operOverStatus) ' status
            ElseIf prt.partStatusID = pst.pstArchive Then
                bCnt(0) = False ' del
                bCnt(1) = False ' change
                bCnt(2) = checkPartPerm(prt.partID, operOverStatus) ' status
            ElseIf prt.partStatusID = pst.pstUstar Then
                bCnt(0) = True ' del
                bCnt(1) = False ' change
                bCnt(2) = checkPartPerm(prt.partID, operOverStatus) ' status
            Else
                bCnt(0) = False
                bCnt(1) = False
                bCnt(2) = False
            End If
            
            If bCnt(0) Or bCnt(1) Or bCnt(2) Then icnt = icnt + 1
            
            If bCnt(0) Then iCount(0) = iCount(0) + 1
            If bCnt(1) Then iCount(1) = iCount(1) + 1
            
            If bCnt(2) Then
                iCount(2) = iCount(2) + 1
                If Len(sAddTextStatus) = 0 Then
                    sAddTextStatus = " (" & prt.partName & ")"
                Else
                    sAddTextStatus = " (" & iCount(2) & " шт.)"
                End If
            ElseIf bCnt(0) Or bCnt(1) Then
                If Len(sAddTextDel) = 0 Then
                    sAddTextDel = " (" & prt.partName & ")"
                Else
                    sAddTextDel = " (" & iCount(0) & " шт.)"
                End If
            End If
            
            
            If Len(sAddTextCopy) = 0 Then
                sAddTextCopy = " (" & prt.partName & ")"
            Else
                sAddTextCopy = " (" & icnt & " шт.)"
            End If
                
            
        Next prt
        
'        If iCnt = 0 Then Exit Sub
        
        
        
        mnuPartsTreeGoLink.Visible = (iLinks = 1) And Not bRecycle
        mnuPartsTreeGoLink.Caption = "Перейти по ссылке" & sAddTextLink
        
        mnuPartsTreeDeleteChecked.Visible = iCount(0) > 1 And bMulti And Not bCatIsBlocked And Not bRecycle
        mnuPartsTreeDeleteChecked.Caption = "Удалить отмеченные" & sAddTextDel
        
        mnuPartsTreeDelete.Visible = iCount(0) = 1 And Not bCatIsBlocked And Not bRecycle
        mnuPartsTreeDelete.Caption = "Удалить" & sAddTextDel
        
        mnuPartsTreeCopy.Visible = True
        mnuPartsTreeCopy.Caption = "Копировать в буфер" & sAddTextCopy
        
        mnuPartsTreeCopyHere.Visible = Not bCatIsBlocked And Not bRecycle
        mnuPartsTreeCopyHere.Caption = "Создать рядом копию" & sAddTextCopy
        
        mnuPartsTreeStatus.Visible = iCount(2) > 0 And Not bRecycle And Not bCatIsBlocked
        mnuPartsTreeStatus.Caption = "Установить статус" & sAddTextStatus
        
        
        mnuPartsTreeFile.Visible = iCount(1) > 0 And Not bRecycle And Not bCatIsBlocked And Not bMulti
        
        mnuPartsTreeDocSet.Visible = iCount(1) > 0 And Not bRecycle And Not bCatIsBlocked
        
        
        mnuPartsTreeRestore.Visible = bRecycle And Not bCatIsBlocked
        mnuPartsTreeErase.Visible = bRecycle And Not bCatIsBlocked
        mnuPartsTreeEraseAll.Visible = checkGroupPerm(usrCurrent.groupID, "project", operModify) And mnuPartsTreeErase.Visible
        
        
        PopupMenu mnuPartsTree
        
        
        
    ElseIf Button = 1 Then
    
        bShift = False
        
        Set nd = tvParts.HitTest(X, Y)
        If nd Is Nothing Then
            dDragX = 0
            dDragY = 0
            Exit Sub
        Else
            Set tvParts.SelectedItem = nd
        End If
        
        bIsLink = CBool(nd.Image = "link")
        
        If LCase(left(nd.KEY, Len("part"))) = "part" Then
        
            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
            
            If Button = 1 And Shift = 1 And Not nChecked Is Nothing Then
                
                bShift = True
                
            ElseIf Button = 1 Then
                
                dDragX = X
                dDragY = Y
                
            End If
            
        ElseIf nd.KEY = "root" Then
            
            bShift = False
            If Button = 1 Then
                dDragX = X
                dDragY = Y
            End If
            
        Else
        
            dDragX = 0
            dDragY = 0
        
        End If
    
    End If
    
    


    
    
End Sub

Private Sub tvParts_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    
    If Button = 1 Then
        
        If tvParts.SelectedItem Is Nothing Then Exit Sub
        
'        If left(tvParts.SelectedItem.KEY, 4) <> "part" Then Exit Sub
        If dDragX = 0 And dDragY = 0 Then Exit Sub
        If bCatIsBlocked Then Exit Sub
        If bCatListIsBlocked Then Exit Sub
        
        If Abs(dDragX - X) > 50 And Abs(dDragY - Y) > 50 Then tvParts.Drag
        
'    ElseIf Me.tbPart.Buttons("SelFly").Value = tbrPressed Then
'
'        Dim n As Node
'        Set n = tvParts.HitTest(X, Y)
'        If Not n Is Nothing Then
'
'            Dim ID As Long
'            If LCase(left(n.KEY, Len("part"))) = "part" Then
'
'                ID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
'
'            End If
'
'            If lngCheckedPartID <> ID Then
'
'                If lngCheckedPartID = 0 Then bChecking = Not n.Checked
'
'                n.Checked = bChecking
'                lngCheckedPartID = ID
'            End If
'
'        Else
'
'            lngCheckedPartID = 0
'        End If
        
    Else
    
    
        lngCheckedPartID = 0
    End If
    
End Sub

Private Sub tvParts_NodeCheck(ByVal Node As MSComctlLib.Node)
    
    Dim n As Node
    
    bCheck = Node.Checked
    
    
        
        
        
        
    If left(Node.KEY, 4) = "part" Then
        
        
        If bShift And Not nChecked Is Nothing Then
            
            Dim n2 As Node
            Dim b1 As Boolean
            Dim b2 As Boolean
            Set n2 = Node
            
            For Each n In tvParts.Nodes
                
                If n.KEY = nChecked.KEY Then b1 = True
                If n.KEY = n2.KEY Then b2 = True
                
                If (b1 Or b2) And left(n.KEY, 4) = "part" Then n.Checked = bCheck
                
                If b1 And b2 Then
                    Exit For
                End If
                
            Next n
            
        Else
            Set nChecked = Node
        End If
        
        
        
    Else
        If Node.children > 0 Then
            Set n = Node.Child
            Do Until n Is Nothing
                
                n.Checked = Node.Checked
                
                If n.children > 0 Then
                    tvParts_NodeCheck n
                End If
                
                Set n = n.Next
            Loop
            
            
        End If
    End If
    
End Sub

'/******************************************************************************
Public Sub loadPartImageWindow(partID As Long)
'/******************************************************************************
    
    On Error GoTo loadPartImageWindow_ERR
    
    Dim RS As New ADODB.Recordset
    Dim mstream As ADODB.Stream
    Dim cnf As New ADODB.Connection
    
    cnf.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=15;User ID=" & strUser & ";Initial Catalog=docs;Data Source=" & conn.strServerName, conn.strUser, conn.strPass
    
    RS.Open "Select * from r_part_file where partID = " & partID & " and partDB = '" & conn.strBaseName & "'", cnf, adOpenKeyset, adLockOptimistic
    'RS.Open "Select * from r_part_file where partID = " & partID, cnf, adOpenKeyset, adLockOptimistic
    
    If Not RS.EOF Then
        
        Set mstream = New ADODB.Stream
        mstream.Type = adTypeBinary
        mstream.Open
        mstream.Write RS.fields("pfData").Value
        
        mstream.SaveToFile Environ("temp") & "\offtake_current_part.pdf", adSaveCreateOverWrite
        
        
        
        frmPartImage.AcroPDF1.LoadFile Environ("temp") & "\offtake_current_part.pdf"
        frmPartImage.AcroPDF1.Visible = True
        
    Else
    
        frmPartImage.AcroPDF1.Visible = False
    
    End If
    
    RS.Close
    Set RS = Nothing
    
    cnf.Close
    Set cnf = Nothing
    
    Exit Sub
    
loadPartImageWindow_ERR:
    Set RS = Nothing
    Set cnf = Nothing
'    Me.SB.Panels("status").text = err.Description
    
End Sub

'/******************************************************************************
Public Function checkPart(prt As clsPart, op As oper, Optional bLinkNotEditable As Boolean = True) As Boolean
'/******************************************************************************

    On Error GoTo checkPart_ERR


    If prt Is Nothing Then Exit Function
    
    If prt.bIsCat Then checkPart = checkCatPerm(prt.partID): Exit Function
    
    If bLinkNotEditable And prt.bIsLink Then Exit Function
    
    If Me.tbPart.Buttons("ShowDeleted").Value = tbrPressed Then Exit Function
'    If Me.tbPart.Buttons("EditPart").Value = tbrUnpressed Then Exit Function
    
    If Not checkPartPerm(prt.partID, op) Then Exit Function
    
    If Not checkGroupPerm(usrCurrent.groupID, "part", op) Then Exit Function
    
'    If Not checkCatPerm(prt.catID) Then Exit Function
    If bCatIsBlocked Then Exit Function

    checkPart = True



Exit Function

checkPart_ERR:

End Function



'/******************************************************************************
Public Sub tvParts_NodeClick(ByVal Node As MSComctlLib.Node)
'/******************************************************************************


    Dim ID As Long


    If LCase(left(Node.KEY, Len("part"))) = "part" Then
        
        ID = Val(right(Node.KEY, Len(Node.KEY) - Len("part")))
        
        Set curPart = New clsPart
        If Node.Image = "link" Then
            curPart.bIsLink = True
            curPart.partNameLink = selectStringFromBase(cn_data, "r_catalog_part", "partLinkName", "relID", CLng(Val(Node.Tag)))
        End If
        
        '==============
        curPart.ID = ID
        '==============
        
        loadLog left(Node.KEY, Len("part")), Val(right(Node.KEY, Len(Node.KEY) - Len("part")))
        
        Me.Refresh
        
        If mnuViewShowPart.Checked Then
            loadPartImageWindow ID
            frmPartImage.Caption = curPart.partName
        End If
        
        sldRound.Enabled = checkPart(curPart, operModify) And Not curPart.bIsCat
        
        'test
        'Dim scfg As clsSCfg
        'Set scfg = scfgs("0")
        'curPart.getPartNameForSpec scfg
        
        
    ElseIf Node.KEY = "root" Then
    
        Set curPart = New clsPart
        
        curPart.setPartFromCat lngCurCatID, True, True, False
        
        curPart.updatePartGrids False
        
    
    Else
    
        tvParts.ToolTipText = "Подсказка: клавиши [*],[+] раскрывают, клавиша [-] сворачивает текущую ветку дерева"
    
    End If
    
    Picture1.Visible = loadPic(globPartTypes_sketch_path & curPart.PARTTYPE.ptsketch & "." & globPartTypes_sketch_ext)
    
    
    


End Sub

Public Function loadPic(path As String) As Boolean

    On Error GoTo err

    Picture1.Picture = LoadPicture(path)

    loadPic = True
    
    elExt.Refresh

    Exit Function
err:
    loadPic = False

End Function



'/******************************************************************************
Private Sub tvSrtm_KeyDown(KeyCode As Integer, Shift As Integer)
'/******************************************************************************

    On Error GoTo tvSrtm_KeyDown_ERR

    
    
    If Not usrCurrent.trusted Then Exit Sub
    
    Dim ID As Long
    Dim nd As Node
    
    Set nd = tvSrtm.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If nd.Tag = "stdposdef" Then
        
        ID = Val(right(nd.KEY, Len(nd.KEY) - Len(nd.Tag)))
        
        
        If KeyCode = 46 Then
            
'            Dim iRecordsAffected As Integer
'            Dim cmd As New ADODB.Command
'            cmd.ActiveConnection = cn_srtm
'            cmd.CommandText = "delete from [r_standard_posdef] where relID = " & ID
'            cmd.Execute iRecordsAffected
'            Set cmd = Nothing
'            If iRecordsAffected = 1 Then tvSrtm.Nodes.Remove nd.Key

            If updateTableInBase(cn_srtm, "r_standard_posdef", "using", 0, "relID", ID) Then
                tvSrtm.Nodes.Remove nd.KEY
            End If
            
            
        End If
    End If
    
    
Exit Sub

tvSrtm_KeyDown_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvSrtm_KeyDown - Error"

End Sub

'/******************************************************************************
Private Sub tvSrtm_NodeClick(ByVal Node As MSComctlLib.Node)
'/******************************************************************************
    
    On Error GoTo tvSrtm_NodeClick_ERR
    
    
    Dim ID As Long
    Dim RS As New ADODB.Recordset
    Dim i As Integer
    Dim j As Integer
    Dim cp As colProp
    Dim prop As clsProp
    Dim strSQL As String
    
    ID = Val(right(Node.KEY, Len(Node.KEY) - Len(Node.Tag)))
    
    fgSrtm.Rows = 1
    fgSrtmMat.Rows = 1
    Me.fgSrtmPos.Visible = False
    
    Dim std As clsStd
    Dim pds As clsPDSet
    Dim smName As String
    
    fgSrtmPos.Tag = ""
    
    Set curPosdef = Nothing
    Set curStdPd = Nothing
    
    For i = 1 To fgPDSet.Rows - 1
        fgPDSet.Cell(flexcpBackColor, i, 1) = &H80000005
    Next i
    
    
    If Node.Tag = "posdef" Then
        
        Set curPosdef = globPosdefs(CStr(ID))
        
        ' материалы
        '===============================
        
        strSQL = "SELECT matID,null,matName,stdFullNumber,stdName"
        strSQL = strSQL & " FROM view_r_material_standard where matUsing = 1"
        strSQL = strSQL & " ORDER by stdFullNumber, matSortNumber"
        
        RS.Open strSQL, cn_srtm, adOpenStatic, adLockReadOnly
        Set Me.fgSrtmPos.DataSource = RS
        
        RS.Close
        
        For i = 0 To fgSrtmPos.cols - 1
            If LCase(right(fgSrtmPos.TextMatrix(0, i), 2)) = "id" Then fgSrtmPos.ColHidden(i) = True
        Next i
        
        Me.fgSrtmPos.Visible = True
        
        fgSrtmPos.TextMatrix(0, 1) = "Исп."
        fgSrtmPos.TextMatrix(0, 2) = "Материал"
        fgSrtmPos.TextMatrix(0, 3) = "Стандарт"
        
        fgSrtmPos.ColKey(0) = "matID"
        fgSrtmPos.ColKey(1) = "x"
        fgSrtmPos.ColKey(2) = "matName"
        fgSrtmPos.ColKey(3) = "matStd"
        
        
        Dim m As clsMat
        Dim p As clsPD
        For i = 1 To fgSrtmPos.Rows - 1
            Set m = globMats(fgSrtmPos.TextMatrix(i, fgSrtmPos.ColIndex("matID")))
            For Each p In m.pdc
                If p.pdID = ID Then
                    fgSrtmPos.TextMatrix(i, fgSrtmPos.ColIndex("x")) = -1
                    Exit For
                End If
            Next p
        Next i
        
        fgSrtmPos.ColDataType(1) = flexDTBoolean
        fgSrtmPos.AutoSize 0, fgSrtmPos.cols - 1
        
'        ctabSrtm.TabVisible(2) = True
        
        ' posdef sets
        '===============================
        
'        strSQL = "SELECT pdsID,null,pdsName as [Наим.],relNameAlt as [Альт. наим.]"
'        strSQL = strSQL & " FROM view_r_pdset_posdef where posdefID = " & curPosdef.pdID
'        strSQL = strSQL & " ORDER by pdsName"
'
'        RS.Open strSQL, cn_srtm, adOpenStatic, adLockReadOnly
'        Set Me.fgPDSet.DataSource = RS
'
'        RS.Close
'
'        For I = 0 To fgPDSet.cols - 1
'            If LCase(right(fgPDSet.TextMatrix(0, I), 2)) = "id" Then fgPDSet.ColHidden(I) = True
'        Next I
'
'        fgSrtmPos.ColKey(0) = "pdsID"
'        fgSrtmPos.ColKey(1) = "x"
'        fgSrtmPos.ColKey(2) = "pdsName"
'        fgSrtmPos.ColKey(3) = "relNameAlt"
        
        For i = 1 To fgPDSet.Rows - 1
            fgPDSet.TextMatrix(i, 1) = False
            fgPDSet.TextMatrix(i, 3) = ""
            fgPDSet.TextMatrix(i, 5) = 0
        Next i
        For Each pds In curPosdef.pdsets
            For i = 1 To fgPDSet.Rows - 1
                If Val(fgPDSet.TextMatrix(i, 0)) = pds.pdsID Then
                    fgPDSet.TextMatrix(i, 1) = True
                    fgPDSet.TextMatrix(i, 3) = pds.pdsNameAlt
                    fgPDSet.TextMatrix(i, 5) = pds.relID
                End If
            Next i
        Next pds
        
        fgPDSet.Tag = "posdef"
        
        fgPDSet.ColHidden(3) = False
        
        fgPDSet.ColDataType(1) = flexDTBoolean
        fgPDSet.AutoSize 0, fgPDSet.cols - 1
        
    ElseIf Node.Tag = "stdposdef" Then
        
        Set curStdPd = globStdPosdefs(CStr(ID))
        
        strSQL = "select srtmID,srtmUsing,srtmName"
        
        For Each prop In curStdPd.SP_PD.pd_props
            If Len(prop.sTableName) > 0 And Not curStdPd.SP_PD.PD_MCALC.mc_props.existsProperty(prop.propName) Then
                strSQL = strSQL & "," & prop.propName
            End If
        Next prop
        
        For Each prop In curStdPd.SP_PD.PD_MCALC.mc_props
            If Len(prop.sTableName) > 0 Then
                strSQL = strSQL & "," & prop.propName
            End If
        Next prop
        
        strSQL = strSQL & ", (select count(*) from position where position.srtmID = view_r_sortament_property_3.srtmID) as pcntid"
        
        ' ================== сортамент ======================
       
        With fgSrtmPos
           
            strSQL = strSQL & " from view_r_sortament_property_3 where stdposdefID = " & ID
            If Len(curStdPd.SP_PD.strSort) > 0 Then
                strSQL = strSQL & " order by " & curStdPd.SP_PD.strSort & ",srtmName"
            Else
                strSQL = strSQL & " order by srtmName"
            End If
           
            RS.Open strSQL, cn_srtm, adOpenStatic, adLockReadOnly
            Set .DataSource = RS
            RS.Close
            
            .Visible = True
            
            .TextMatrix(0, 1) = "Исп."
            .TextMatrix(0, 2) = "Поз."
            
            .ColKey(0) = "srtmID"
            .ColKey(1) = "srtmUsing"
            .ColKey(2) = "srtmName"
            
            .Tag = CStr(ID)
            
            .AddItem 0
            .Cell(flexcpBackColor, .Rows - 1, .ColIndex("srtmName")) = lngBlue
            
            For i = 1 To .Rows - 1
                If Val(.TextMatrix(i, .ColIndex("pcntid"))) > 0 Then .Cell(flexcpFontBold, i, 0, i, 2) = True
            Next i
            
            .AutoSize 0, .cols - 1
            
            For i = 0 To .cols - 1
                If LCase(right(.TextMatrix(0, i), 2)) = "id" Then .ColHidden(i) = True
            Next i
            
            For i = 0 To .cols - 1
                If InStr(.ColKey(i), "_") Then .ColWidth(i) = 500
            Next i
            
            
        End With
        
        ' ================ материалы ===============
        
        With fgSrtmMat
            
            RS.Open "select matID, matName as [Материал], stdFullNumber + ' - ' + stdName as [Стандарт] from view_r_stdpd_material where stdpdID = " & _
                                                                            ID & " order by matSortNumber", cn_srtm, adOpenStatic, adLockReadOnly
            Set .DataSource = RS
            RS.Close
            
            .ColHidden(0) = True
            
            .Tag = CStr(ID)
            
            .AddItem "0"
            
            .AutoSize 0, .cols - 1
            
        End With
        
        For i = 1 To fgPDSet.Rows - 1
            fgPDSet.TextMatrix(i, 1) = False
            fgPDSet.TextMatrix(i, 3) = ""
            fgPDSet.TextMatrix(i, 5) = 0
        Next i
        
        For Each pds In curStdPd.SP_PD.pdsets
            For i = 1 To fgPDSet.Rows - 1
                If Val(fgPDSet.TextMatrix(i, 0)) = pds.pdsID Then
                    fgPDSet.TextMatrix(i, 1) = True
                    fgPDSet.TextMatrix(i, 5) = pds.relID
                End If
            Next i
        Next pds
        
        For Each pds In curStdPd.spdsets
            For i = 1 To fgPDSet.Rows - 1
                If Val(fgPDSet.TextMatrix(i, 0)) = pds.pdsID Then
                    fgPDSet.Cell(flexcpBackColor, i, 1) = lngGrey
                    fgPDSet.TextMatrix(i, 1) = False
'                    fgPDSet.TextMatrix(I, 3) = pds.pdsNameAlt
                    fgPDSet.TextMatrix(i, 5) = pds.relID
                End If
            Next i
        Next pds
        
        fgPDSet.Tag = "stdposdef"
        
        fgPDSet.ColDataType(1) = flexDTBoolean
        fgPDSet.AutoSize 0, fgPDSet.cols - 1
        
        fgPDSet.ColHidden(3) = True
        
'        ctabSrtm.TabVisible(2) = True
'        If ctabSrtm.CurrTab = 2 Then ctabSrtm.CurrTab = 0
        
        
'    ElseIf Node.Tag = "srtm" Then
'
'        Dim s As String
'        Dim sm As clsSrtm
'
'        RS.Open "select * from r_sortament_property where srtmID = " & ID, cn_srtm, adOpenForwardOnly, adLockOptimistic
'        If Not RS.EOF Then
'
'            RS.MoveFirst
'
'            Set sm = globSrtm(CStr(RS.Fields("srtmID").Value))
'
'            Set std = sm.SRTM_STDPD.SP_STD
'            Set pd = sm.SRTM_STDPD.SP_PD
'            smName = sm.srtmName
'
'            Set cp = New colProp
'
'            For I = 2 To RS.Fields.Count - 1
'
'                s = RS.Fields(I).NAME
'
'                If Not IsNull(RS.Fields(I).Value) Then
'                    Set prop = New clsProp
'                    Set prop.pr = globProps(s)
'                    prop.setValue RS.Fields(I).Value
'                    cp.AddSimple prop, CStr(prop.pr.propID)
'                    Set prop = Nothing
'                End If
'
'            Next I
'
'
'
'        End If
'
'        RS.Close
'
'        ctabSrtm.TabVisible(2) = False
        
    End If
    
    
    Set RS = Nothing
    
    
    
    fgSrtm.AddItem vbTab & "Позиция сортамента"
    
    If Not curPosdef Is Nothing Then
        fgSrtm.AddItem "Наименование" & vbTab & curPosdef.PD_NAME
        fgSrtm.AddItem "Расчет массы" & vbTab & curPosdef.PD_MCALC.mcName
    End If
    
    If Not curStdPd Is Nothing Then
    
        fgSrtm.AddItem "Стандарт" & vbTab & curStdPd.SP_STD.FULLNUMBER
        
        fgSrtm.AddItem "" & vbTab & curStdPd.SP_STD.stdName
        
        If curStdPd.mcID <> 0 Then
            Dim mc As clsMC
            Set mc = globMassCalcs(CStr(curStdPd.mcID))
            fgSrtm.AddItem "Расчет массы" & vbTab & mc.mcName
        Else
            fgSrtm.AddItem "Расчет массы" & vbTab & "стандартный"
        End If
        fgSrtm.RowData(fgSrtm.Rows - 1) = "masscalc"
        
        If curStdPd.bUseDrawSgn Then
            fgSrtm.AddItem "Символ позиции" & vbTab & "стандартный"
        Else
            fgSrtm.AddItem "Символ позиции" & vbTab & "не использовать"
        End If
        fgSrtm.RowData(fgSrtm.Rows - 1) = "usedrawsign"
        
        If curStdPd.iStdPdMassLevel < 0 Then
            fgSrtm.AddItem "Исп. в выборке" & vbTab & "стандартно"
        ElseIf curStdPd.iStdPdMassLevel = 0 Then
            fgSrtm.AddItem "Исп. в выборке" & vbTab & "первостепенное"
        ElseIf curStdPd.iStdPdMassLevel = 1 Then
            fgSrtm.AddItem "Исп. в выборке" & vbTab & "второстепенное"
        End If
        
        If Len(curStdPd.pdNameAlt) > 0 Then
            fgSrtm.AddItem "Альт. обозн." & vbTab & curStdPd.pdNameAlt
        Else
            fgSrtm.AddItem "Альт. обозн." & vbTab & "нет"
        End If
        
        If usrCurrent.trusted Then
            fgSrtm.AddItem "curStdPd" & "/" & "std" & "/" & "pd" & vbTab & curStdPd.stdpdID & "/" & curStdPd.SP_STD.stdID & "/" & curStdPd.SP_PD.pdID
        End If
        
    End If
    
    
    If Len(smName) > 0 Then
        fgSrtm.AddItem "Позиция" & vbTab & smName
        
        If cp.Count > 0 Then
            For Each prop In cp
                fgSrtm.AddItem prop.pr.propDescr & vbTab & prop.propValue
            Next prop
            
        End If
        
    End If
    
    fgSrtm.AutoSize 0, 1
    
    Dim hgt As Double
    For i = 0 To fgSrtm.Rows - 1
        hgt = hgt + fgSrtm.RowHeight(i)
    Next i
    
    fgSrtm.height = hgt + 100
    
    
    elFgSrtm.AutoSizeChildren = azUnevenVert
    
    
    tvSrtm.SetFocus
    
    Exit Sub
    
tvSrtm_NodeClick_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "tvSrtm_NodeClick - Error"
    
End Sub



'/******************************************************************************
Private Sub Timer1_Timer()
'/******************************************************************************
    
    On Error GoTo Timer1_Timer_ERR
    
    Dim lii As LASTINPUTINFO
    lii.cbSize = Len(lii)
    Call GetLastInputInfo(lii)
'    With Label1
'        .Caption = FormatNumber((GetTickCount() - lii.dwTime) / 1000, 2)
'        .Refresh
'    End With
'    If Label1.Caption = "10.00" Then
'        MsgBox "hi"
'    End If
    
    Dim tm As Double
    tm = (GetTickCount() - lii.dwTime) / 1000
    
    If tm > 60 * 60 * 4 Then
        Unload Me
    End If
    
'    Debug.Print Now
    
    
    Exit Sub
    
Timer1_Timer_ERR:
'    MsgBox "[" & Err.Number & "] " & Err.Description, vbInformation, "Timer1_Timer - Error"
    
End Sub


Private Sub Arm_2D1_PlacePoint(points1() As Rein2D_prj.DPOINT2D, points2() As Rein2D_prj.DPOINT2D, Arcs() As Long)


    
'    Debug.Print "Arm_2D1_PlacePoint " & UBound(points2)

'    If Not mnuPrefUseRein.Checked Then Exit Sub

    Dim Row As Long
    Row = fgCatParts.Row
    
    
    If Not getReinPos(Row, curPos, "Arm_2D1_PlacePoint") Then Exit Sub
    
    If curPos.partID = 0 Then Exit Sub
    
    If Not curPos.bSketch Then
        curPos.bSketch = True
        curPos.savePos
    End If
    
    Dim i As Integer
    
'    Debug.Print "place point"
'    For I = 0 To UBound(points1)
'        Debug.Print "pp", Format(points1(I).x, "0"), Format(points1(I).y, "0"), Format(points2(I).x, "0"), Format(points2(I).y, "0")
'    Next I
    
    ' временно пока не исправлено
    ' =============================================
    ' чтобы не было одинаковых соседних точек
    ' =============================================
'    If UBound(points2()) > 0 Then
'        For I = 0 To UBound(points2()) - 1
'            If points2(I).x = points2(I + 1).x And points2(I).y = points2(I + 1).y Then
'                If Not Arm_2D1 Is Nothing Then armUpdateSketch Arm_2D1, curPos
'                Exit Sub
'            End If
'        Next I
'    End If
    ' чтобы не было точек на линии
    ' =============================================
'    If UBound(points2()) > 1 Then
'        For I = 0 To UBound(points2()) - 2
'
'            Dim p1(0 To 1) As OfftPoint2D
'            Dim p2(0 To 1) As OfftPoint2D
'
'            p1(0) = points2(I + 1)
'            p1(1) = points2(I)
'
'            p2(0) = points2(I + 1)
'            p2(1) = points2(I + 2)
'
'            If getAngle(p1, p2) = 0 Then
'                If Not Arm_2D1 Is Nothing Then armUpdateSketch Arm_2D1, curPos
'                Exit Sub
'            End If
'
'        Next I
'    End If
    ' =============================================
    ' =============================================
    
'    If Not Arm_2D1 Is Nothing Then
    
        Dim a As Long, b As Long, t As Long
        
        Arm_2D1.GetBegin t, a, b
        curPos.termBegType = t
        curPos.termBegAngle = a
        curPos.termBegLength = b
        
        Arm_2D1.GetEnd t, a, b
        curPos.termEndType = t
        curPos.termEndAngle = a
        curPos.termEndLength = b
        

    
        If armSavePoints(points1, points2, Arm_2D1.getMainLine, curPos) Then

            curPos.savePos
            
            fgCatPartsSetRowData fgCatParts.Row, curPos, True, True
            
            writeOperationS operModify, curPos.POS_SRC_TABLE, curPos.posID, "изменение эсиза, кол-во точек " & Arm_2D1.Count

        Else
            armUpdateSketch Arm_2D1, curPos
        End If
'    End If


    

End Sub



Private Sub Arm_2D1_DblClick()
    
    '
    Dim dLength As Double
    Dim bLap As Boolean
    
    

    If Not getReinPos(Me.fgCatParts.Row, curPos, "Arm_2D1_DblClick") Then Exit Sub
    
    
    
    With fgCatParts
        
        
'        If Not Arm_2D1 Is Nothing Then
'            dLength = getBarLength(curPos)
            dLength = Arm_2D1.getTotalLength
'        End If
        
        
        Dim prop As clsProp
        
        If curPos.pos_props.existsProperty("length") Then
            Set prop = curPos.pos_props("length")
            prop.setValue dLength
            Set prop = Nothing
        Else
            dLength = 0#
        End If
        
        If dLength > 0 Then
        
            curPos.savePos
            
            fgCatPartsSetRowData fgCatParts.Row, curPos, True, True
            
        End If
        
        
        
    End With
    
End Sub


'/******************************************************************************
Private Sub updateSketchPositions(Row As Long, bSketch As Boolean)
'/******************************************************************************
    
    On Error GoTo updateSketches_ERR
    
    Dim i As Integer
    Dim strSQLcmd As String
    Dim cmd As ADODB.Command
    Dim recaf As Integer
    Dim icnt As Integer
    
    Dim iFrom, iTo As Integer
    
    If bSketch Then i = 1 Else i = -1
    
    
    If arSketchRow(1) <> 0 And arSketchRow(2) <> 0 Then
        arSketchRow(1) = 0
        arSketchRow(2) = 0
    End If
    
    
    If arSketchRow(1) = 0 Then
        arSketchRow(1) = i * Row
        arSketchRow(2) = 0
'        Debug.Print Row
    Else
        arSketchRow(2) = i * Row
'        Debug.Print Row
    End If
    
    Dim p As New clsPos
    
    
    icnt = 0
    
    If arSketchRow(1) <> 0 And arSketchRow(2) <> 0 Then
        
        
        Set cmd = New ADODB.Command
        cmd.ActiveConnection = cn_data
        cmd.CommandType = adCmdText
        
        strSQLcmd = "UPDATE [" & p.POS_SRC_TABLE & "] SET [posSketch] = " & Abs(CInt(CBool(arSketchRow(1) > 0))) & " WHERE posID in ("
        
        If Abs(arSketchRow(1)) > Abs(arSketchRow(2)) Then
            iFrom = Abs(arSketchRow(2))
            iTo = Abs(arSketchRow(1))
        Else
            iFrom = Abs(arSketchRow(1))
            iTo = Abs(arSketchRow(2))
        End If
        
        For i = iFrom To iTo
        
            Set p = colRein2(i)
            
            If p.posID > 0 And p.POS_MCALC.mcID = 2 Then
                
'                Debug.Print arSketchRow(1), arSketchRow(2), Val(fgCatParts.TextMatrix(I, fgCatParts.ColIndex("num")))
                
                If icnt > 0 Then strSQLcmd = strSQLcmd & ","
                strSQLcmd = strSQLcmd & p.posID
                
                icnt = icnt + 1
                
            End If
            
            
        Next i
        
        strSQLcmd = strSQLcmd & ")"
        
        cmd.CommandText = strSQLcmd
        
        cmd.Execute recaf
        
        If recaf = icnt Then
            
            For i = iFrom To iTo
            
                Set p = colRein2(i)
                
                If p.posID > 0 And p.POS_MCALC.mcID = 2 Then
                    p.bSketch = CBool(arSketchRow(1) > 0)
                    fgCatParts.TextMatrix(i, fgCatParts.ColIndex("sketch")) = CBool(arSketchRow(1) > 0)
                End If
                
                
            Next i
            
            writeOperationS operModify, "catalog", lngCurCatID, "изм. свойства эскиз у " & recaf & " позиций"
            
        End If
        
        
    End If
    
    
    Exit Sub
    
updateSketches_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "updateSketches - Error"
    
End Sub



'/******************************************************************************
Public Function addCatPart(cl As Collection, prt As clsPart) As Boolean
'/******************************************************************************

    On Error GoTo addCatPart_ERR

    cl.Add prt, prt.partName


    addCatPart = True

Exit Function

addCatPart_ERR:

End Function

'/******************************************************************************
Public Sub checkCatParts()
'/******************************************************************************

    On Error GoTo checkCatParts_ERR

    Dim cl As New Collection
    Dim nd As Node
    Dim prt As clsPart
    Dim prtID As Long
    Dim i As Integer
    
    Set nd = tvParts.Nodes("root")
    
    ' работает только по именам, также нужно проверять версии
    
    If nd.children > 0 Then
        Dim ndx As Node
        Set ndx = nd.Child.FirstSibling
        For i = 1 To nd.children
            If (left(ndx.KEY, Len("part"))) = "part" Then
                prtID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("part")))
                
                Set prt = New clsPart
                prt.partID = prtID
                prt.partName = ndx.text
                
                If Not addCatPart(cl, prt) Then
                
                    Dim ndxx As Node
                    Dim prtx As clsPart
                    Set prtx = cl(prt.partName)
                    Set ndxx = tvGetTreeNode(tvParts, "part" & prtx.partID)
                        
'                    ndxx.ForeColor = lngRed
'                    ndx.ForeColor = lngRed
                    ndx.BackColor = lngLightRed
                    ndxx.BackColor = lngLightRed
'                    ndxx.text = "*" & ndxx.text ' не годится потому что при повторной проверке уже не те имена
'                    ndx.text = "*" & ndx.text
                
                Else
                    ndx.BackColor = &H80000005
                
                End If
                

            End If
            
            Set ndx = ndx.Next
        Next
    End If
    
    
    
    
    
    


Exit Sub

checkCatParts_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "checkCatParts - Error"
    Me.SB.Panels("status").text = "checkCatParts() error - " & err.Description

End Sub


'/******************************************************************************
Private Function createCatListFromUsrlist(catID As Long) As Long
'/******************************************************************************

    On Error GoTo createCatListFromUsrlist_ERR
    
    Dim clID As Long
    
    If catID = 0 Then Exit Function
    
    Dim RS As New ADODB.Recordset
    Dim RScl As ADODB.Recordset
    
    RS.Open "select * from usrlist where usrID = " & usrCurrent.usrID, cn_data, adOpenStatic, adLockReadOnly
    
    If Not RS.EOF Then
    
        clID = createCatList(catID, "список от " & usrCurrent.strLogin, False, False)
        
        If clID > 0 Then
        
            Set RScl = New ADODB.Recordset
            RScl.Open "select * from r_catlist_part", cn_data, adOpenKeyset, adLockBatchOptimistic
        
            RS.MoveFirst
            Do
                RScl.AddNew
                
                RScl.fields("catlistID").Value = clID
                RScl.fields("partID").Value = RS.fields("partID").Value
                RScl.fields("partQty").Value = RS.fields("partQty").Value
                RScl.fields("partSortID").Value = RS.fields("partSortID").Value
                RScl.fields("objID").Value = RS.fields("objID").Value
                
            
            
                RS.MoveNext
            Loop Until RS.EOF
            
            
            RScl.UpdateBatch
            
            RScl.Close
            
            
        End If
    
    
    End If
    

    
    RS.Close
    Set RS = Nothing

    Set RScl = Nothing
    
    
    createCatListFromUsrlist = clID


Exit Function

createCatListFromUsrlist_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "createCatListFromUsrlist - Error"

End Function


'/******************************************************************************
Private Function copyCatalog2(objectID As Long, objID As Long, lngCatIDtoCopy As Long, _
                            Optional bReserved As Boolean = False, _
                            Optional sParentNodeKey As String = "", _
                            Optional sNodeImage As String = "", _
                            Optional bCopyReinChildCats As Boolean = True, _
                            Optional sNewCatName As String = "") As Long
'/******************************************************************************

    On Error GoTo copyCatalog2_ERR


    If lngCatIDtoCopy = 0 Then Exit Function
    
    Dim cmd As ADODB.Command

    Dim catNewID As Long
    
    Dim strSQL As String
    Dim strView As String
    Dim sCopied As String
    
    Dim tbPart As clsTable
    Dim tbPos As clsTable
    Dim tbCPos As clsTable
    Dim tbProp As clsTable
    Dim tbCProp As clsTable
    Dim tbPrp As clsTable
    Dim tbPrs As clsTable
    Dim tbCatList As clsTable
    Dim tbCatLPart As clsTable
    
    Set tbPart = globTables("part")
    Set tbPos = globTables("position")
    Set tbCPos = globTables("catpos")
    Set tbProp = globTables("r_position_property")
    Set tbCProp = globTables("r_catpos_property")
    Set tbPrp = globTables("r_part_reinpoints")
    Set tbPrs = globTables("r_part_reinsketch")
    Set tbCatList = globTables("catlist")
    Set tbCatLPart = globTables("r_catlist_part")
    
    Dim strSrcPrefix As String
    Dim strDstPrefix As String
    
    If Len(copyInfo.sBaseNameSrc) > 0 Then strSrcPrefix = copyInfo.sBaseNameSrc & ".dbo."
    If Len(copyInfo.sBaseNameDst) > 0 Then strDstPrefix = copyInfo.sBaseNameDst & ".dbo."
    
    ' пустой каталог
    catNewID = copyCatalogRecord(objectID, objID, lngCatIDtoCopy, False, sNewCatName, copyInfo.cn_src, copyInfo.cn_dst)
    
    If catNewID = 0 Then GoTo exitf
    
    
'    strSQL = generateCopySql("catID", CStr(lngCatIDtoCopy), False, strDstPrefix, strSrcPrefix, catNewID)
    
   
    ' пустые изделия
    strSQL = copyDataInTable("part", "partID", strDstPrefix, _
                                "catID", CStr(lngCatIDtoCopy), , strSrcPrefix & "part", _
                                "catID", CStr(catNewID), "parentID", "0", "usrID", CStr(usrCurrent.usrID), "partIDold", "partID")
    
    ' позиции каталога
    ' #######################################################################
    
    strSQL = strSQL & ";" & copyDataInTable("catpos", "posID", strDstPrefix, _
                                "partID", CStr(lngCatIDtoCopy), , strSrcPrefix & "catpos", _
                                "partID", CStr(catNewID), "posIDold", "posID")
    
    strView = "SELECT "
    strView = strView & "i_catalog.catID as partID, "
    strView = strView & tbCPos.getFields(False, strDstPrefix, True, "partID") & ", "
    strView = strView & tbCProp.getFields(False, strSrcPrefix, True, "relID", "posID") & " "
    ' FROM position
    strView = strView & "FROM " & strDstPrefix & "catpos "
    ' INNER JOIN part ON position.partID = part.partID
    strView = strView & "INNER JOIN " & strDstPrefix & "i_catalog ON " & strDstPrefix & "catpos.partID = " & strDstPrefix & "i_catalog.catID "
    ' LEFT OUTER JOIN r_position_property ON position.posIDold = r_position_property.posID
    strView = strView & "LEFT OUTER JOIN " & strSrcPrefix & "r_catpos_property ON " & strDstPrefix & "catpos.posIDold = " & strSrcPrefix & "r_catpos_property.posID"
    strView = "(" & strView & ") view_pos"
                    
    strSQL = strSQL & ";" & copyDataInTable("r_catpos_property", "posID", strDstPrefix, _
                                "view_pos.partID", CStr(catNewID), , strView)

    ' позиции
    ' #######################################################################
    
    ' view_r_part_copy_1 - part from destination - position, r_position_property from source
    '=========================================================================
    ' SELECT part.*, position.*, r_position_property.*
    strView = "SELECT "
    strView = strView & tbPart.getFields(False, strDstPrefix, True) & ", "
    strView = strView & tbPos.getFields(False, strSrcPrefix, True, "partID") & ", "
    strView = strView & tbProp.getFields(False, strSrcPrefix, True, "relID", "posID") & " "
    ' FROM position
    strView = strView & "FROM " & strSrcPrefix & "position "
    ' INNER JOIN part ON position.partID = part.partIDold
    strView = strView & "INNER JOIN " & strDstPrefix & "part ON " & strSrcPrefix & "position.partID = " & strDstPrefix & "part.partIDold "
    ' LEFT OUTER JOIN r_position_property ON position.posID = r_position_property.posID
    strView = strView & "LEFT OUTER JOIN " & strSrcPrefix & "r_position_property ON " & strSrcPrefix & "position.posID = " & strSrcPrefix & "r_position_property.posID"
    strView = "(" & strView & ") view_pos"

    strSQL = strSQL & ";" & copyDataInTable("position", "posID", strDstPrefix, _
                                "view_pos.catID", CStr(catNewID), , strView, _
                                "posIDold", "posID")
                                
                                
    ' view_r_part_copy_2 - part, position from destination - r_position_property from source
    '=========================================================================
    ' SELECT part.*, position.*, r_position_property.*
    strView = "SELECT "
    strView = strView & tbPart.getFields(False, strDstPrefix, True) & ", "
    strView = strView & tbPos.getFields(False, strDstPrefix, True, "partID") & ", "
    strView = strView & tbProp.getFields(False, strSrcPrefix, True, "relID", "posID") & " "
    ' FROM position
    strView = strView & "FROM " & strDstPrefix & "position "
    ' INNER JOIN part ON position.partID = part.partID
    strView = strView & "INNER JOIN " & strDstPrefix & "part ON " & strDstPrefix & "position.partID = " & strDstPrefix & "part.partID "
    ' LEFT OUTER JOIN r_position_property ON position.posIDold = r_position_property.posID
    strView = strView & "LEFT OUTER JOIN " & strSrcPrefix & "r_position_property ON " & strDstPrefix & "position.posIDold = " & strSrcPrefix & "r_position_property.posID"
    strView = "(" & strView & ") view_pos"
                    
    strSQL = strSQL & ";" & copyDataInTable("r_position_property", "posID", strDstPrefix, _
                                "view_pos.catID", CStr(catNewID), , strView)
                    
                    
                    
                    
                    
    
    
    ' параметры арматуры
    ' #######################################################################
    ' view_r_part_copy_3 - part from destination - r_part_reinpoints from source
    '=========================================================================
    ' SELECT part.*, r_part_reinpoints.*
    strView = "SELECT "
    strView = strView & tbPart.getFields(False, strDstPrefix, True) & ", "
    strView = strView & tbPrp.getFields(False, strSrcPrefix, True, "rpID", "partID") & " "
    ' FROM part
    strView = strView & "FROM " & strDstPrefix & "part "
    ' INNER JOIN r_part_reinpoints ON part.partIDold = r_part_reinpoints.partID
    strView = strView & "INNER JOIN " & strSrcPrefix & "r_part_reinpoints ON " & strDstPrefix & "part.partIDold = " & strSrcPrefix & "r_part_reinpoints.partID "
    strView = "(" & strView & ") view_pos"
    
    
    strSQL = strSQL & ";" & copyDataInTable("r_part_reinpoints", "rpID", strDstPrefix, _
                                "view_pos.catID", CStr(catNewID), , strView)
                                
    
    
    
    
    ' view_r_part_copy_4 - part from destination - r_part_reinsketch from source
    '=========================================================================
    ' SELECT part.*, r_part_reinsketch.*
    strView = "SELECT "
    strView = strView & tbPart.getFields(False, strDstPrefix, True) & ", "
    strView = strView & tbPrs.getFields(False, strSrcPrefix, True, "sketchID", "partID") & " "
    ' FROM part
    strView = strView & "FROM " & strDstPrefix & "part "
    ' INNER JOIN r_part_reinpoints ON part.partIDold = r_part_reinpoints.partID
    strView = strView & "INNER JOIN " & strSrcPrefix & "r_part_reinsketch ON " & strDstPrefix & "part.partIDold = " & strSrcPrefix & "r_part_reinsketch.partID "
    strView = "(" & strView & ") view_pos"
    
                    
    strSQL = strSQL & ";" & copyDataInTable("r_part_reinsketch", "sketchID", strDstPrefix, _
                                "view_pos.catID", CStr(catNewID), , strView)
                    
    ' #######################################################################
    
   
    
    ' ссылки
    If copyInfo.bLinks Then
        strSQL = strSQL & ";" & copyDataInTable("r_catalog_part", "relID", strDstPrefix, _
                                    "catID", CStr(lngCatIDtoCopy), , strSrcPrefix & "r_catalog_part", _
                                    "catID", CStr(catNewID))
                        
    End If
                    
    ' списки
    If copyInfo.bLists Then
    
    
        strSQL = strSQL & ";" & copyDataInTable("catlist", "catlistID", strDstPrefix, _
                                    "catID", CStr(lngCatIDtoCopy), , strSrcPrefix & "catlist", _
                                    "catID", CStr(catNewID), _
                                    "clIDold", "catlistID")
                        
        If copyInfo.bListContent Then
        
        
            ' view_r_part_copy_5 - catlist from destination - r_catlist_part from source
            '=========================================================================
            ' SELECT catlist.*, r_catlist_part.*
            strView = "SELECT "
            strView = strView & tbCatList.getFields(False, strDstPrefix, True) & ", "
            strView = strView & tbCatLPart.getFields(False, strSrcPrefix, True, "relID", "catlistID") & " "
            ' FROM r_catlist_part
            strView = strView & "FROM " & strSrcPrefix & "r_catlist_part "
            ' INNER JOIN catlist ON r_catlist_part.catlistID = catlist.clIDold
            strView = strView & "INNER JOIN " & strDstPrefix & "catlist ON " & strSrcPrefix & "r_catlist_part.catlistID = " & strDstPrefix & "catlist.clIDold "
            strView = "(" & strView & ") view_catlist"
        
            strSQL = strSQL & ";" & copyDataInTable("r_catlist_part", "relID", strDstPrefix, _
                                    "view_catlist.catID", CStr(catNewID), , strView)
                                    
                
                                    
            ' перенаправление, см view_update_clist_redirect
            If copyInfo.bListRedirect Then
                
                strSQL = strSQL & ";UPDATE "
                strSQL = strSQL & strDstPrefix & "r_catlist_part "
                strSQL = strSQL & "SET "
                strSQL = strSQL & strDstPrefix & "r_catlist_part.partID = " & strDstPrefix & "part.partID "
                strSQL = strSQL & "FROM "
                strSQL = strSQL & strDstPrefix & "r_catlist_part "
                strSQL = strSQL & "INNER jOIN "
                strSQL = strSQL & strDstPrefix & "catlist "
                strSQL = strSQL & "ON "
                strSQL = strSQL & strDstPrefix & "r_catlist_part.catListID = " & strDstPrefix & "catlist.catListID "
                strSQL = strSQL & "INNER jOIN "
                strSQL = strSQL & strDstPrefix & "part "
                strSQL = strSQL & "ON "
                strSQL = strSQL & strDstPrefix & "catlist.catID = " & strDstPrefix & "part.catID "
                strSQL = strSQL & "AND "
                strSQL = strSQL & strDstPrefix & "r_catlist_part.partID = " & strDstPrefix & "part.partIDold "
                strSQL = strSQL & "WHERE "
                strSQL = strSQL & strDstPrefix & "catlist.catID = " & catNewID
                
                
            End If

        
        End If
    End If
    
    
    Set cmd = New ADODB.Command
    cmd.ActiveConnection = copyInfo.cn_src
    cmd.CommandText = strSQL
    cmd.Execute
    
    Dim RS As ADODB.Recordset
    Dim nc As Node
    
    ' добавляем ветку дерева если требуется
    If Len(sParentNodeKey) > 0 And catNewID > 0 Then
        
        Dim n As Node
        
        If addTreeNode(tvCats, n, sParentNodeKey, tvwChild, "catalog" & catNewID, _
           selectStringFromBase(copyInfo.cn_dst, "i_catalog", "catName", "catID", catNewID), _
           sNodeImage) Then
            n.Tag = "catalog"
            If CBool(selectLongFromBase(copyInfo.cn_src, "i_catalog", "catUnif", "catID", lngCatIDtoCopy)) > 0 Then n.bOld = True
            If CBool(selectLongFromBase(copyInfo.cn_src, "i_catalog", "forTesting", "catID", lngCatIDtoCopy)) Then n.ForeColor = &H80000010
            
            
            
            If copyInfo.bLists Then ' добавляем ветки списков
            
                Set RS = New ADODB.Recordset
                RS.Open "select * from catlist where catID = " & catNewID, copyInfo.cn_dst, adOpenForwardOnly, adLockReadOnly
                If Not RS.EOF Then
                    RS.MoveFirst
                    Do
                        If RS.fields("deleted").Value = 0 Then
                            If addTreeNode(tvCats, nc, "catalog" & catNewID, tvwChild, _
                                            "catlist" & RS.fields("catlistID").Value, RS.fields("catlistName").Value, "catlist") Then
                                nc.Tag = "catlist"
                            End If
                        End If
                        RS.MoveNext
                    Loop Until RS.EOF
                End If
                RS.Close
                Set RS = Nothing
            
            End If
            
        Else
            err.Raise 100, , "Не добавить ветку дерева"
        End If
        
'    Else
'        GoTo exitf
    End If
    
    
    '========================================================
    ' копирование подкаталогов
'    Dim I As Integer
'    Dim catIDchild As Long
'    Dim catID As Long
'
'    Dim nd_to_copy As Node
'    Dim nd_new As Node
'    Set nd_to_copy = tvGetTreeNode(tvCats, "catalog" & lngCatIDtoCopy)
'    Set nd_new = tvGetTreeNode(tvCats, "catalog" & catNewID)
'
'    If bCopyReinChildCats And Not nd_new Is Nothing And Not nd_to_copy Is Nothing Then
'        If nd_to_copy.children > 0 Then
'            Dim ndx As Node
'
'            Set ndx = nd_to_copy.Child.FirstSibling
'
'            For I = 1 To nd_to_copy.children
'
'                If (left(ndx.Tag, Len("catalog"))) = "catalog" Then
'
'                    catID = Val(right(ndx.KEY, Len(ndx.KEY) - Len("catalog")))
'
'                    If cattypes(cCats(CStr(catID)).catTypeID).ctEnum = ctRein Then
'
'                        catIDchild = copyCatalog2(catNewID, objs("catalog"), catID, , nd_new.KEY, nd_new.Image, False, ndx.text)
'
'                    End If
'                End If
'
'                Set ndx = ndx.Next
'            Next
'        End If
'    End If
    '========================================================
    
    
    '========================================================
    ' копирование подкаталогов
    Dim i As Integer
    Dim catIDchild As Long

    Me.PB.Min = 0

    If bCopyReinChildCats Then
    
    
        Dim RSch As New ADODB.Recordset
        RSch.Open "select * from view_object_catalog where objID = " & objs("catalog") & _
                                                    " and objectID = " & lngCatIDtoCopy & _
                                                    " and deleted = 0", copyInfo.cn_src, adOpenStatic, adLockReadOnly
        If Not RSch.EOF Then
        
            Me.PB.Max = RSch.RecordCount
        
            RSch.MoveFirst
            Do
            
'                If cattypes(RSch.Fields("catTypeID").Value).ctEnum = ctRein Then
                    catIDchild = copyCatalog2(catNewID, objs("catalog"), RSch.fields("catID").Value, , , , False, RSch.fields("catName").Value)
'                End If
                
                Me.PB.Value = RSch.AbsolutePosition
                Me.PB.Refresh
                
                RSch.MoveNext
            Loop Until RSch.EOF

        End If
        
        RSch.Close
        Set RSch = Nothing
        
        
            
        Set RS = New ADODB.Recordset
        RS.Open "select * from view_object_catalog where objID = " & objs("catalog") & " and objectID = " & catNewID, copyInfo.cn_dst, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                If RS.fields("deleted").Value = 0 Then
                    If addTreeNode(tvCats, nc, "catalog" & catNewID, tvwChild, _
                                    "catalog" & RS.fields("catID").Value, RS.fields("catName").Value, cattypes(RS.fields("catTypeID").Value).tnNum) Then
                        nc.Tag = "catalog"
                    End If
                End If
                RS.MoveNext
            Loop Until RS.EOF
        End If
        RS.Close
        Set RS = Nothing
                
        
        
        
    End If
    '========================================================
    
    
    
    Call writeOperationS(operCreate, "catalog", catNewID, "копирование каталога", copyInfo.cn_dst)
    
exitf:
    Me.PB.Value = 0
    copyCatalog2 = catNewID


Exit Function

copyCatalog2_ERR:
    copyCatalog2 = 0
    Me.PB.Value = Me.PB.Min
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyCatalog2 - Error"

End Function



'/******************************************************************************
Private Function copyDataInTable(strTableName As String, strIdentColName As String, Optional strDstTablePrefix As String = "", _
                                Optional strWhereField As String = "", Optional strWhereValue As String = "", _
                                Optional bWhereIn As Boolean = False, Optional sWhereTable As String = "", _
                                Optional strColName1 As String = "", Optional strColValue1 As String = "", _
                                Optional strColName2 As String = "", Optional strColValue2 As String = "", _
                                Optional strColName3 As String = "", Optional strColValue3 As String = "", _
                                Optional strColName4 As String = "", Optional strColValue4 As String = "") As String
'/******************************************************************************
    
    On Error GoTo copyDataInTable_ERR
    
    Dim strSQL As String

    Dim strColNames As String
    Dim strColValues As String
    Dim strSelectFrom As String
    Dim strDstTableFullName As String
    
    
    Dim tbl As clsTable
    Set tbl = globTables(strTableName)
    
    If Len(sWhereTable) = 0 Then
        strSelectFrom = strTableName
    Else
        strSelectFrom = sWhereTable
    End If
    
    strDstTableFullName = strDstTablePrefix & strTableName
    
    
    
    Dim strWhere As String
    
    If bWhereIn Then
        strWhere = " WHERE " & strWhereField & " in (" & strWhereValue & ")"
    Else
        strWhere = " WHERE " & strWhereField & " = " & strWhereValue
    End If
    
    strColNames = tbl.getFields(True) ' with brackets
    strColValues = strColNames
    
    If Len(strColName1) > 0 Then
        strColValues = Replace(strColValues, "[" & strColName1 & "]", strColValue1, , , vbBinaryCompare)
    End If
    If Len(strColName2) > 0 Then
        strColValues = Replace(strColValues, "[" & strColName2 & "]", strColValue2, , , vbBinaryCompare)
    End If
    If Len(strColName3) > 0 Then
        strColValues = Replace(strColValues, "[" & strColName3 & "]", strColValue3, , , vbBinaryCompare)
    End If
    If Len(strColName4) > 0 Then
        strColValues = Replace(strColValues, "[" & strColName4 & "]", strColValue4, , , vbBinaryCompare)
    End If
    
    
    
    strSQL = "INSERT INTO " & strDstTableFullName & " (" & strColNames & ") SELECT " & strColValues & " FROM " & strSelectFrom & strWhere
    
    Dim iRA As Integer
    
'    If bExecute Then
'        Dim cmd As New ADODB.Command
'        cmd.ActiveConnection = cn_data
'        cmd.CommandText = strSQL
'        Call cmd.Execute(iRA)
'        copyDataInTable = CStr(iRA)
'    Else
        copyDataInTable = strSQL
'    End If


    
    
    Exit Function
    
copyDataInTable_ERR:
    copyDataInTable = "0"
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "copyDataInTable - Error"
    
End Function



'/******************************************************************************
Public Sub loadCmdBlock(Index As Integer, bNew As Boolean, objectID As Long)
'/******************************************************************************

    On Error GoTo loadCmdBlock_ERR

    Dim RS As New ADODB.Recordset
    Dim strSQL As String

    If bNew Then
        Me.fgCmd(Index).Rows = 1
        Me.fgCmd(Index).AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."
    End If
    
    strSQL = "SELECT " & objs("block") & ", blockID, blockNumber, 'Блок ' + CONVERT(VARCHAR(10),blockNumber) as bName FROM i_block WHERE projectID = " & objectID & " AND deleted = 0"
    
    RS.Open strSQL, cn_cmd(Index), adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Me.fgCmd(Index).AddItem objs("block") & vbTab & RS.fields("blockID").Value & vbTab & RS.fields("blockNumber").Value & vbTab & RS.fields("bName").Value
            RS.MoveNext
        Loop Until RS.EOF
    End If

    RS.Close
    Set RS = Nothing

Exit Sub

loadCmdBlock_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmdBlock - Error"

End Sub

'/******************************************************************************
Public Sub loadCmdBuilding(Index As Integer, bNew As Boolean, objID As Long, objectID As Long)
'/******************************************************************************

    On Error GoTo loadCmdBuilding_ERR


    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    
    If bNew Then
        Me.fgCmd(Index).Rows = 1
        Me.fgCmd(Index).AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."
    End If

    strSQL = "SELECT " & objs("building") & ", buildingID, buildingCode, buildingCode + ' - ' + buildingName as bName FROM view_object_building WHERE objID = " & objID & " AND objectID = " & objectID & " AND deleted = 0"
    
    RS.Open strSQL, cn_cmd(Index), adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Me.fgCmd(Index).AddItem objs("building") & vbTab & RS.fields("buildingID").Value & vbTab & RS.fields("buildingCode").Value & vbTab & RS.fields("bName").Value
            RS.MoveNext
        Loop Until RS.EOF
    End If


    RS.Close
    Set RS = Nothing

Exit Sub

loadCmdBuilding_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmdBuilding - Error"

End Sub

'/******************************************************************************
Public Sub loadCmdCat(FG As VSFlexGrid, bNew As Boolean, objID As Long, objectID As Long, cn As ADODB.Connection)
'/******************************************************************************

    On Error GoTo loadCmdCat_ERR


    Dim RS As New ADODB.Recordset
    Dim strSQL As String

    If bNew Then
        FG.Rows = 1
        FG.AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."
    End If

    FG.TextMatrix(0, 4) = "содерж."
    FG.TextMatrix(0, 5) = "ссылок"

    ' catalogs
    strSQL = "SELECT " & objs("catalog") & ", catID, catName, catTypeID, "
    strSQL = strSQL & "(select count(*) from part where part.catID = view_object_catalog.catID and part.deleted = 0) as pcnt, "
    strSQL = strSQL & "(select count(*) from r_catalog_part where r_catalog_part.catID = view_object_catalog.catID) as lcnt "
    strSQL = strSQL & "FROM view_object_catalog WHERE objID = " & objID & " AND objectID = " & objectID & " AND deleted = 0 order by catName"
    
    RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            FG.AddItem objs("catalog") & vbTab & _
                                    RS.fields("catID").Value & vbTab & _
                                    RS.fields("catName").Value & vbTab & _
                                    RS.fields("catName").Value & vbTab & _
                                    RS.fields("pcnt").Value & vbTab & _
                                    RS.fields("lcnt").Value
            
            If bFormGridsIcons Then
            If cattypes(RS.fields("catTypeID").Value).ctEnum = ctRein Then
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("reincat").ExtractIcon
            Else
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("catalog").ExtractIcon
            End If
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

    RS.Close
    Set RS = Nothing

    FG.AutoSize 0, FG.cols - 1

    FG.ColHidden(0) = True
    FG.ColHidden(1) = True
    FG.ColHidden(2) = True

Exit Sub

loadCmdCat_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmdCat - Error"

End Sub

'/******************************************************************************
Public Sub loadCmdParts(FG As VSFlexGrid, bNew As Boolean, catID As Long, cn As ADODB.Connection)
'/******************************************************************************

    On Error GoTo loadCmdParts_ERR


    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    
    If Not bFormGridsRedraw Then FG.redraw = flexRDNone

    If bNew Then
        FG.Rows = 1
        FG.AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."
    End If

    FG.TextMatrix(0, 4) = "к.поз."
    FG.TextMatrix(0, 5) = "м.изд."

    ' catalogs
    strSQL = "SELECT *,(select count(*) from position where position.partID = view_part2.partID) as pcnt, "
    strSQL = strSQL & "(select sum(posCommonMass) from position where position.partID = view_part2.partID) as mass "
    strSQL = strSQL & "FROM view_part2 WHERE catID = " & catID & " AND deleted = 0 order by partSortNumber"
    
    RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            FG.AddItem objs("part") & vbTab & _
                                RS.fields("partID").Value & vbTab & _
                                RS.fields("partName").Value & vbTab & _
                                RS.fields("partName").Value & vbTab & _
                                RS.fields("pcnt").Value & vbTab & _
                                Format(RS.fields("mass").Value, sFmt1)
            
            If bFormGridsIcons Then
            If RS.fields("link").Value = 0 Then
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("part" & RS.fields("partStatusID").Value).ExtractIcon
            Else
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("link").ExtractIcon
            End If
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

    RS.Close
    Set RS = Nothing
    
    FG.AutoSize 0, FG.cols - 1
    
    FG.ColHidden(0) = True
    FG.ColHidden(1) = True
    FG.ColHidden(2) = True

    
    If Not bFormGridsRedraw Then FG.redraw = flexRDDirect
    


Exit Sub

loadCmdParts_ERR:
    If Not bFormGridsRedraw Then FG.redraw = flexRDDirect
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmdParts - Error"

End Sub

'/******************************************************************************
Public Sub loadCmdLists(Index As Integer, bNew As Boolean, catID As Long)
'/******************************************************************************

    On Error GoTo loadCmdLists_ERR


    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    

    If bNew Then
        Me.fgCmd(Index).Rows = 1
        Me.fgCmd(Index).AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."
    End If

    ' catalogs
    strSQL = "SELECT * FROM catlist WHERE catID = " & catID & " AND deleted = 0"
    
    RS.Open strSQL, cn_cmd(Index), adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Me.fgCmd(Index).AddItem objs("catlist") & vbTab & RS.fields("catlistID").Value & vbTab & RS.fields("catlistName").Value & vbTab & RS.fields("catlistName").Value
            
            If bFormGridsIcons Then
            Me.fgCmd(Index).Cell(flexcpPicture, fgCmd(Index).Rows - 1, 3) = ImageList2.ListImages("catlist").ExtractIcon
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

    RS.Close
    Set RS = Nothing



Exit Sub

loadCmdLists_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmdLists - Error"

End Sub


'/******************************************************************************
Public Sub loadCmdListContent(FG As VSFlexGrid, bNew As Boolean, clID As Long, cn As ADODB.Connection, Optional catposID As Long = 0)
'/******************************************************************************

    On Error GoTo loadCmdListContent_ERR


    Dim RS As New ADODB.Recordset
    Dim strSQL As String


    FG.Rows = 1
    
    FG.TextMatrix(0, 4) = "кол-во"
    FG.TextMatrix(0, 5) = "общ.м."
    
    If bNew Then FG.AddItem 0 & vbTab & 0 & vbTab & "" & vbTab & ".."

'    If bOfftNew Then
    strSQL = "SELECT distinct * FROM gocatlist(" & clID & ") WHERE deleted = 0 order by partSortID"
'    Else
'    strSQL = "SELECT distinct * FROM view_clist WHERE catlistID = " & clID & " AND deleted = 0 order by partSortID"
'    End If
    
    RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            FG.AddItem objs("part") & vbTab & _
                            RS.fields("partID").Value & vbTab & _
                            RS.fields("partMainPosEP").Value & vbTab & _
                            RS.fields("partName").Value & vbTab & _
                            RS.fields("partQty").Value
            
            If bFormGridsIcons Then
            If RS.fields("objID").Value = objs("part") Then
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("part0").ExtractIcon
            ElseIf RS.fields("objID").Value = objs("catalog") Then
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("catalog").ExtractIcon
            ElseIf RS.fields("objID").Value = objs("catlist") Then
                FG.Cell(flexcpPicture, FG.Rows - 1, 3) = ImageList2.ListImages("catlist").ExtractIcon
            End If
            End If
            
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

    

    RS.Close
    
    
'    FG.Subtotal flexSTSum, -1, 5, "0.0", lngGrey, , True, "Всего"
    
    
    If catposID > 0 Then
    
        strSQL = "SELECT * FROM catpos WHERE partID = " & catposID
        
        RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly


        If Not RS.EOF Then
            RS.MoveFirst
            Do
            
                Dim p As New clsPos
                
                p.setSrtm RS.fields("srtmID").Value, False, True
            
                FG.AddItem objs("position") & vbTab & _
                                RS.fields("partID").Value & vbTab & _
                                0 & vbTab & _
                                p.POS_PD_NAME & " " & p.POS_SRTM.srtmName & vbTab & _
                                Format(RS.fields("posQuantity").Value, "#.0##"), 1
                                
                FG.Cell(flexcpBackColor, 1, 1, , FG.cols - 1) = lngBlue
                

                RS.MoveNext
            Loop Until RS.EOF
        End If
        
        RS.Close

    
    End If
    
    
    
    FG.AutoSize 0, FG.cols - 1

    FG.ColHidden(0) = True
    FG.ColHidden(1) = True
    FG.ColHidden(2) = True
    
    
    
    
    Set RS = Nothing
    
    

Exit Sub

loadCmdListContent_ERR:
    F1.SB.Panels("status").text = "loadCmdListContent" & "() - " & err.Description

End Sub




'/******************************************************************************
Public Sub loadCmd(Index As Integer, Optional objID As Long = 0, Optional objectID As Long = 0, Optional objIDts As Long = 0, Optional objectIDts As Long = 0)
'/******************************************************************************

    On Error GoTo loadCmd_ERR
    
    Dim i As Integer

    If Not conn.createNewConnection(cn_cmd(Index), cmbCmd(Index).text) Then
        Me.SB.Panels("status").text = "Error in loadCmd() - [" & conn.strErrMessage
        conn.strErrMessage = ""
        Exit Sub
    End If
    
    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    Dim bNoAction As Boolean

    If objID = 0 Or objectID = 0 Then
    
        strSQL = "SELECT "
        
        strSQL = strSQL & objs("project") & ", "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project.projectID, "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project.projectName, "
        strSQL = strSQL & conn.strSrtmName & ".dbo.department.depName + ' ' + "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project.projectName, '', '' "
        
        strSQL = strSQL & "FROM "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project "
        
        strSQL = strSQL & "INNER JOIN "
        strSQL = strSQL & conn.strSrtmName & ".dbo.department "
        strSQL = strSQL & "ON "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project.depID "
        strSQL = strSQL & "= "
        strSQL = strSQL & conn.strSrtmName & ".dbo.department.depID "
        
        strSQL = strSQL & "WHERE "
        strSQL = strSQL & cn_cmd(Index).DefaultDatabase & ".dbo.view_r_dep_project.deleted = 0 "
        
        strSQL = strSQL & "ORDER BY depName, projectName"
        
        RS.Open strSQL, cn_cmd(Index), adOpenForwardOnly, adLockReadOnly
        Set Me.fgCmd(Index).DataSource = RS
        
        Me.fgCmd(Index).ColHidden(0) = True
        Me.fgCmd(Index).ColHidden(1) = True
        Me.fgCmd(Index).ColHidden(2) = True
        
        
        
        
'        Me.fgCmd(Index).MergeCol(3) = True

    ElseIf objID = objs("project") Then
    
    
        loadCmdBlock Index, True, objectID
    
        loadCmdBuilding Index, False, objID, objectID
        
        loadCmdCat fgCmd(Index), False, objID, objectID, cn_cmd(Index)
        
        

    
    ElseIf objID = objs("block") Then
    
    
        loadCmdBuilding Index, True, objID, objectID
        
        loadCmdCat fgCmd(Index), False, objID, objectID, cn_cmd(Index)
        
        
        
    ElseIf objID = objs("building") Then
    

        loadCmdCat fgCmd(Index), True, objID, objectID, cn_cmd(Index)
        
    ElseIf objID = objs("catalog") Then
    

        loadCmdCat fgCmd(Index), True, objID, objectID, cn_cmd(Index)
        
        loadCmdLists Index, False, objectID
        
        loadCmdParts fgCmd(Index), False, objectID, cn_cmd(Index)
        
    ElseIf objID = objs("catlist") Then
        
'        If StrComp(Me.cmbCmd(Index).text, cn_data.DefaultDatabase, vbTextCompare) = 0 Then
'            loadListGrid objectID, mnuListSyncLoad.Checked
'        End If

        loadCmdListContent fgCmd(Index), True, objectID, cn_cmd(Index)
        
    Else
    
        bNoAction = True
        
    End If
    
    
    
    
    
    
    
    
    If Not bNoAction And objID > 0 Then
        sCmdPath(Index) = sCmdPath(Index) & "|" & objID & ":" & objectID
'        sCmdDisp(Index) = sCmdDisp(Index) & " \ " & sDispName
        
'        Dim RSS As ADODB.Recordset
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        cmd.CommandType = adCmdStoredProc
        cmd.CommandText = "getPath2"
        cmd.Parameters.Append cmd.CreateParameter("ret", adBSTR, adParamReturnValue)
        cmd.Parameters.Append cmd.CreateParameter("objID", adBigInt, adParamInput, , objID)
        cmd.Parameters.Append cmd.CreateParameter("objectID", adBigInt, adParamInput, , objectID)
        cmd.Parameters.Append cmd.CreateParameter("short", adInteger, adParamInput, , 0)
        cmd.Execute
        Me.lblCmd(Index).Caption = " " & cmd.Parameters("ret")
'        Set RSS = cmd.Execute()
'        If Not RSS.EOF Then
'            Me.lblCmd(Index).Caption = RSS.Fields(0).Value
'        End If
'        RSS.Close
'        Set RSS = Nothing
        
'        Me.lblCmd(Index).Caption = sCmdDisp(Index)

    ElseIf Not bNoAction And objID = 0 Then
        Me.lblCmd(Index).Caption = ""
    End If
    
    
    Me.fgCmd(Index).AutoSize 0, Me.fgCmd(Index).cols - 1
    
    Me.fgCmd(Index).ColHidden(0) = True
    Me.fgCmd(Index).ColHidden(1) = True
    Me.fgCmd(Index).ColHidden(2) = True
    
    
    Me.fgCmd(Index).ColWidth(3) = Me.fgCmd(Index).width / 10 * 8
    Me.fgCmd(Index).ColWidth(4) = Me.fgCmd(Index).width / 10 * 1
    
    
    
    
    cn_cmd(Index).Close
    Set cn_cmd(Index) = Nothing
    
    
    
    
    
    For i = 0 To Me.fgCmd(Index).Rows - 1
    
        If bFormGridsIcons Then
        If Val(Me.fgCmd(Index).TextMatrix(i, 0)) = objs("project") Then Me.fgCmd(Index).Cell(flexcpPicture, i, 3) = ImageList2.ListImages("project").ExtractIcon
        If Val(Me.fgCmd(Index).TextMatrix(i, 0)) = objs("block") Then Me.fgCmd(Index).Cell(flexcpPicture, i, 3) = ImageList2.ListImages("block").ExtractIcon
        If Val(Me.fgCmd(Index).TextMatrix(i, 0)) = objs("building") Then Me.fgCmd(Index).Cell(flexcpPicture, i, 3) = ImageList2.ListImages("building").ExtractIcon
'        If Val(Me.fgCmd(Index).TextMatrix(I, 0)) = objs("catalog") Then Me.fgCmd(Index).Cell(flexcpPicture, I, 3) = ImageList2.ListImages("catalog").ExtractIcon
        End If
        
        If Val(Me.fgCmd(Index).TextMatrix(i, 0)) = objIDts And Val(Me.fgCmd(Index).TextMatrix(i, 1)) = objectIDts Then
            If Not bNoAction Then
                Me.fgCmd(Index).Select i, 2
                Me.fgCmd(Index).ShowCell i, 2
            End If
        End If
    Next i
    
    
    
    
    

Exit Sub

loadCmd_ERR:
    Set cn_cmd(Index) = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCmd - Error"
    Me.SB.Panels("status").text = "Error in loadCmd() - [" & err.Number & "] " & err.Description

End Sub


'/******************************************************************************
Private Function generateCopySql(strWhereField As String, strWhereValue As String, bWhereIn As Boolean, _
                                strDstPrefix As String, strSrcPrefix As String, catNewID As Long) As String
'/******************************************************************************

    On Error GoTo generateCopySql_ERR


    Dim tbPart As clsTable
    Dim tbPos As clsTable
    Dim tbProp As clsTable
    Dim tbPrp As clsTable
    Dim tbPrs As clsTable
    Dim tbCatList As clsTable
    Dim tbCatLPart As clsTable
    
    Set tbPart = globTables("part")
    Set tbPos = globTables("position")
    Set tbProp = globTables("r_position_property")
    Set tbPrp = globTables("r_part_reinpoints")
    Set tbPrs = globTables("r_part_reinsketch")
    Set tbCatList = globTables("catlist")
    Set tbCatLPart = globTables("r_catlist_part")


    Dim strSQL As String
    
    ' parentID - используется для идентификации вставленных строк (usrID со знаком "-"), после всех проведенных операций должно быть обнулено

    ' пустые изделия
    strSQL = copyDataInTable("part", "partID", strDstPrefix, _
                                strWhereField, strWhereValue, bWhereIn, strSrcPrefix & "part", _
                                "catID", CStr(catNewID), "parentID", CStr(-usrCurrent.usrID), "usrID", CStr(usrCurrent.usrID), "partIDold", "partID")



Exit Function

generateCopySql_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "generateCopySql - Error"

End Function


'=====================================
'/******************************************************************************
Public Sub calcMufts()
'/******************************************************************************
    
    On Error GoTo calcMufts_ERR
    
    
    
    
    Dim propDiam As clsProp
    Dim propLen As clsProp
    Dim propDiamIter As clsProp
    Dim iterPos As clsPos
    Dim iMuftCount As Integer
    Dim iMuftCountLap As Integer
    
    Set propDiam = curPos.pos_props("diameter")
    
    
    
    For Each iterPos In colRein2
        
        Set propDiamIter = iterPos.pos_props("diameter")
        
        If iterPos.POS_PD.pdID = 1 And Not propDiamIter Is Nothing Then
            
            
            If propDiamIter.propValue = propDiam.propValue Then
                
                If iterPos.POS_LAP.bMuft Then
                    Set propLen = iterPos.pos_props("length")
                    If Not propLen Is Nothing Then
                        If propLen.propValue > 0 And iterPos.POS_LAP.maxlen < propLen.propValue Then
                            iMuftCountLap = iMuftCountLap + Int(propLen.propValue / iterPos.POS_LAP.maxlen) * iterPos.posQty
                        End If
                    End If
                End If
                
                If iterPos.termBegType = 3 Then
                    iMuftCount = iMuftCount + iterPos.posQty
                End If
                
                If iterPos.termEndType = 3 Then
                    iMuftCount = iMuftCount + iterPos.posQty
                End If
                
            End If
            
        End If
        
        
    Next iterPos
    
    Dim strSB As String
    
    strSB = "Количество муфт для d" & propDiam.propValue & " - " & iMuftCount + iMuftCountLap & "шт."
    
    If iMuftCountLap > 0 Then
        strSB = strSB & " (с учетом ограничений по длине)"
    End If
    
    
    If (iMuftCount + iMuftCountLap) > 0 Then SB.Panels("status").text = strSB
    
    
    
    
    Exit Sub
    
calcMufts_ERR:
    Me.SB.Panels("status").text = "calcMufts - Error - [" & err.Number & "] - " & err.Description
    
End Sub


'/******************************************************************************
Public Sub updateComMassRows(Optional bUpdateInBase As Boolean = True)
'/******************************************************************************

    On Error GoTo updateComMassRows_ERR
    
    
    Dim pos As clsPos
    
    Dim Row As Long
    
    Dim strSQL As String
    
    Row = 1
    For Each pos In colRein2
    
        If pos.posID > 0 And pos.POS_MCALC.mcID = 5 Then
        
            fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("umass")) = pos.POS_UMASS
            fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("cmass")) = pos.POS_CMASS
            
            strSQL = strSQL & "UPDATE " & pos.POS_SRC_TABLE & " set posUnitMass=" & getString(getDbl(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("umass")))) & _
                                                ", posCommonMass=" & getString(getDbl(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("cmass")))) & _
                                                " WHERE posID = " & pos.posID & ";"

'            updateTableInBase cn_data, "position", "posUnitMass", getDbl(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("umass"))), "posID", pos.posID
'            updateTableInBase cn_data, "position", "posCommonMass", getDbl(fgCatParts.TextMatrix(Row, fgCatParts.ColIndex("cmass"))), "posID", pos.posID
        
        End If

        Row = Row + 1
    Next pos
    
    If Len(strSQL) = 0 Then Exit Sub
    
    If bUpdateInBase Then
        Dim cmd As New ADODB.Command
        cmd.ActiveConnection = cn_data
        cmd.CommandText = strSQL
        cmd.Execute
    End If
    
    

Exit Sub

updateComMassRows_ERR:
    Me.SB.Panels("status").text = "updateComMassRows() - Error - [" & err.Number & "] - " & err.Description

End Sub


'/******************************************************************************
Public Sub loadReinParts(catID As Long)
'/******************************************************************************
    
    On Error GoTo loadReinParts_ERR
    
    Dim p As clsPos
    Dim pAdded As clsPos
    Dim partID As Long
    
    Dim sm As clsSrtm
    
    Dim bDup As Boolean
    Dim bDupPart As Boolean
    
    Dim i As Long
    
    Set colRein2 = New Collection
    
    Dim strSQL As String
    
    strSQL = "SELECT "
    
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.*, "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property.* "
    
'    If tbCats.Buttons("UseFunc").Value = tbrPressed Then
'        strSQL = strSQL & "," & conn.strBaseName & ".dbo.posunitmass(" & conn.strBaseName & ".dbo.view_r_part_position.posID," & lngCurProjectID & ") as pum "
'    End If
    
    strSQL = strSQL & "FROM "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position "
    
    strSQL = strSQL & "LEFT OUTER JOIN "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property "
    strSQL = strSQL & "ON "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.pos_srtmID "
    strSQL = strSQL & "= "
    strSQL = strSQL & conn.strSrtmName & ".dbo.r_sortament_property.srtmID "
    
    strSQL = strSQL & "WHERE "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.catID = " & catID & " "
    strSQL = strSQL & "AND "
    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.deleted = 0 "
'    strSQL = strSQL & "AND "
'    strSQL = strSQL & "("
'    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.posNumber <= 1 "
'    strSQL = strSQL & "OR "
'    strSQL = strSQL & "isnull( "
'    strSQL = strSQL & conn.strBaseName & ".dbo.view_r_part_position.posNumber "
'    strSQL = strSQL & ",0)=0 "
'    strSQL = strSQL & ") "
    
    strSQL = strSQL & "ORDER BY [partSortNumber],[posNumber]"
    
    Dim RSP As New ADODB.Recordset
    
    If bUseCursorClient Then RSP.CursorLocation = adUseClient
    
    RSP.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    
    
    If Not RSP.EOF Then
        
        RSP.MoveFirst
        Do
            
            
            bDup = False
            bDupPart = False
            
            If Val(RSP.fields("partName").Value) > colRein2.Count + 1 Then
                For i = colRein2.Count + 1 To Val(RSP.fields("partName").Value) - 1
                    Set p = New clsPos
                    Set p.parentPart = New clsPart
                    p.parentPart.partName = CStr(i)
                    p.parentPart.catID = catID
                    colRein2.Add p
                    Set p = Nothing
                Next i
            ElseIf Val(RSP.fields("partName").Value) < colRein2.Count + 1 Then
                If partID = RSP.fields("partID").Value Then
                    bDup = True
                Else
                    bDupPart = True
                End If
            End If
            
            
            
            Set p = New clsPos
            
            Set p.parentPart = New clsPart
            p.parentPart.setIDv2 0, False, False, False, RSP
            p.partID = p.parentPart.partID
            partID = p.partID
            
           
            If IsNull(RSP.fields("pos_srtmID").Value) Then ' отсутствует
                GoTo continue_add
            Else
                Set sm = globSrtm(CStr(RSP.fields("pos_srtmID").Value))
                If sm.srtmID = 0 Then ' srtm id does not exists in table 'sortament'
                    GoTo continue_add
                End If
            End If
            
            If p.loadDataFromRSrecord(RSP, "pos_") Then
                
                'p.getSrtmProps
                p.reloadSrtmPropsFromRS RSP
                p.reloadPosPropsFromRS RSP, "pos_"
                
                If Not dblCmp(p.posUMass, getDbl(p.POS_UMASS), 3) Or Not dblCmp(p.posCMass, getDbl(p.POS_CMASS), 3) Then
                    p.bMustUpdate = True
                End If
                
                If Not bCatIsBlocked Then
                    If p.bMustUpdate Then p.updateMassInBase
                End If
                
            Else
                err.Raise 1, , "Функция loadReinParts(), ошибка в loadDataFromRSrecord()"
            End If
            
            
            
            
            
            
continue_add:
            
            If bDup Then ' p.posnumber > 1
                If Not pAdded Is Nothing Then pAdded.bNotOnly = True
            ElseIf bDupPart Then ' dublicate parts
                If Not pAdded Is Nothing Then pAdded.bDups = True
            Else
                colRein2.Add p
                Set pAdded = p
            End If
            
            


            Set p = Nothing
            
            
            RSP.MoveNext
        Loop Until RSP.EOF
        
        
        

        
    End If
    
    
    setReinDefaultPos True, catID, False
    
    Set pAdded = Nothing
    
    RSP.Close
    Set RSP = Nothing
    
    Exit Sub
    
loadReinParts_ERR:
    Set RSP = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadReinParts - Error"
    
End Sub

'/******************************************************************************
Public Function dblCmp(v1 As Double, v2 As Double, numdig As Integer) As Boolean
'/******************************************************************************

    On Error GoTo dblCmp_ERR


    Dim vv1 As Long
    Dim vv2 As Long
    
    vv1 = Round(v1, numdig - 1) * 10 ^ numdig
    vv2 = Round(v2, numdig - 1) * 10 ^ numdig
    
    dblCmp = CBool(vv1 = vv2)


Exit Function

dblCmp_ERR:
    dblCmp = False

End Function





'/******************************************************************************
Public Sub setReinDefaultPos(bNew As Boolean, catID As Long, bRefreshGrid As Boolean)
'/******************************************************************************
    
    On Error GoTo setReinDefaultPos_ERR
    
    If bCatIsBlocked Then Exit Sub
    
    
    Dim Row As Long
    
    Dim p As clsPos
    
    If bNew Then
        Set p = New clsPos
        p.bIsReinDefault = True
        Set p.parentPart = New clsPart
        p.parentPart.partName = CStr(colRein2.Count + 1)
        p.parentPart.catID = catID
        colRein2.Add p
    Else
        Set p = colRein2(colRein2.Count)
    End If
    
    p.loadDefalts
    
    
    Set p = Nothing
    
    If bRefreshGrid Then
        
        If bNew Then fgCatParts.AddItem ""
        
        Row = fgCatParts.Rows - 1
        
        If Not getReinPos(Row, p, "setReinDefaultPos") Then Exit Sub
        
        p.bIsReinDefault = True
        fgCatPartsSetRowData Row, p, False, False
        
        Set p = Nothing
        
        If bNew Then
            
            Row = fgCatParts.Rows - 2
            
            If Row > 0 Then
                
                If Not getReinPos(Row, p, "setReinDefaultPos") Then Exit Sub
                
                p.bIsReinDefault = False
                fgCatPartsSetRowData Row, p, True, True
                Set p = Nothing
            End If
            
        End If
        

    End If
    
    
    
    
    
    Exit Sub
    
setReinDefaultPos_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "setReinDefaultPos - Error"
    
End Sub



'/******************************************************************************
Public Sub loadPartsGrid(catID As Long, Optional bReloadIfSame As Boolean = True, Optional partID As Long = 0, Optional bShowCatTab As Boolean = True)
'/******************************************************************************
    
    On Error GoTo loadPartsGrid2_ERR
    
    If catID = 0 Then Exit Sub
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))
    
    If catID = lngCurCatID And Not bReloadIfSame Then GoTo weiter
    
    lngCurCatListDefaultID = ct.catListID
    
'    If Not Arm_2D1 Is Nothing Then
    Arm_2D1.Clear
    
    
    fgCatParts.Rows = 1
    
    loadReinParts catID
    
    loadPartsGrid3
    
    
    lngCurCatID = catID
    
    lngCurDefReinPartdefID = cattypes(ct.catTypeID).partdefID
    
    checkListParts
    
weiter:
    
    If Me.tvCats.Nodes.Count > 0 Then
    
        If bFormTabsHide Then ctabMain.TabVisible(2) = True ' арматура
        
        If bShowCatTab Then
            
            ctabMain.CurrTab = 2
            
            If partID > 0 Then
                fgCatParts.Row = fgCatParts.FindRow(partID, , fgCatParts.ColIndex("partID"))
                fgCatParts.Col = 1
                fgCatParts.SetFocus
            End If
            
        End If
    End If
    
    If bFormTabsHide Then ctabMain.TabVisible(1) = False ' изделия
    
    lblCurCatName(1).Caption = ct.getCatPath
    
    
    Exit Sub
    
loadPartsGrid2_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadPartsGrid2 - Error"
    
End Sub


'/******************************************************************************
Public Sub loadPartsGrid3()
'/******************************************************************************
    
    On Error GoTo fillReinGrid_ERR
    
    Dim Row As Long
    Dim p As clsPos
    
    With fgCatParts
        
        .Rows = colRein2.Count + 1
        
        .cols = 23
        
        
        .ColKey(0) = "num"
        .ColKey(1) = "posdef"
        .ColKey(2) = "std"
        .ColKey(3) = "srtm"
        .ColKey(4) = "mat"
        .ColKey(5) = "length"
        .ColKey(6) = "qty"
        .ColKey(7) = "sketch"
        .ColKey(8) = "masslength"
        .ColKey(9) = "umass"
        .ColKey(10) = "cmass"
        .ColKey(11) = "objID"
        .ColKey(12) = "ID"
        .ColKey(13) = "stdID"
        .ColKey(14) = "posdefID"
        .ColKey(15) = "stdpdID"
        .ColKey(16) = "srtmID"
        .ColKey(17) = "matID"
        .ColKey(18) = "mcID"
        .ColKey(19) = "partID"
        .ColKey(20) = "numDigits"
        .ColKey(21) = "roundshift"
        .ColKey(22) = "roundsaved"
        
        .TextMatrix(0, .ColIndex("num")) = "№"
        .TextMatrix(0, .ColIndex("posdef")) = "Профиль"
        .TextMatrix(0, .ColIndex("std")) = "Стандарт"
        .TextMatrix(0, .ColIndex("srtm")) = "Наим"
        .TextMatrix(0, .ColIndex("mat")) = "Материал"
        .TextMatrix(0, .ColIndex("length")) = "Длина"
        .TextMatrix(0, .ColIndex("qty")) = "Кол-во"
        .TextMatrix(0, .ColIndex("masslength")) = "Исх.масса"
        .TextMatrix(0, .ColIndex("umass")) = "Ед.масса"
        .TextMatrix(0, .ColIndex("cmass")) = "Об.масса"
        .TextMatrix(0, .ColIndex("objID")) = "objID"
        .TextMatrix(0, .ColIndex("ID")) = "ID"
        .TextMatrix(0, .ColIndex("stdID")) = "stdID"
        .TextMatrix(0, .ColIndex("posdefID")) = "posdefID"
        .TextMatrix(0, .ColIndex("stdpdID")) = "stdpdID"
        .TextMatrix(0, .ColIndex("srtmID")) = "srtmID"
        .TextMatrix(0, .ColIndex("matID")) = "matID"
        .TextMatrix(0, .ColIndex("mcID")) = "mcID"
        .TextMatrix(0, .ColIndex("partID")) = "partID"
        .TextMatrix(0, .ColIndex("numDigits")) = "numDigits"
        .TextMatrix(0, .ColIndex("sketch")) = "Эскиз"
        .TextMatrix(0, .ColIndex("roundshift")) = "roundshift"
        .TextMatrix(0, .ColIndex("roundsaved")) = "roundsaved"
        
        If Not usrCurrent.strLogin = "l_vibe" Then
            .ColHidden(.ColIndex("objID")) = True
            .ColHidden(.ColIndex("ID")) = True
            .ColHidden(.ColIndex("stdID")) = True
            .ColHidden(.ColIndex("posdefID")) = True
            .ColHidden(.ColIndex("stdpdID")) = True
            .ColHidden(.ColIndex("srtmID")) = True
            .ColHidden(.ColIndex("matID")) = True
            .ColHidden(.ColIndex("mcID")) = True
            .ColHidden(.ColIndex("partID")) = True
            .ColHidden(.ColIndex("numDigits")) = True
            .ColHidden(.ColIndex("roundshift")) = True
            .ColHidden(.ColIndex("roundsaved")) = True
        End If
        
        .ColDataType(.ColIndex("sketch")) = flexDTBoolean
        
        
        
        .ColFormat(.ColIndex("masslength")) = "0.000"
        
        .ColAlignment(.ColIndex("posdef")) = flexAlignLeftCenter
        .ColAlignment(.ColIndex("std")) = flexAlignLeftCenter
        .ColAlignment(.ColIndex("srtm")) = flexAlignLeftCenter
        
        
        Dim bLap As Boolean
        
        Dim dPosLength As Double
        Dim sPosLength As String
        
        
        If Not bFormGridsRedraw Then .redraw = flexRDNone
        
        Row = 1
        For Each p In colRein2
            
            fgCatPartsSetRowData Row, p, False, False
            
            Row = Row + 1
            
        Next p
        
        If Not bFormGridsRedraw Then .redraw = flexRDDirect
        
        
        calcReinGridSum
        
        .AutoSize 0, .cols - 1
        
        .ColWidth(.ColIndex("posdef")) = .ColWidth(.ColIndex("posdef")) + 300
        .ColWidth(.ColIndex("std")) = .ColWidth(.ColIndex("std")) + 300
        .ColWidth(.ColIndex("srtm")) = .ColWidth(.ColIndex("srtm")) + 300
        .ColWidth(.ColIndex("mat")) = .ColWidth(.ColIndex("mat")) + 300
        
        
    End With
    
    
    Exit Sub
    
fillReinGrid_ERR:
    If Not bFormGridsRedraw Then fgCatParts.redraw = flexRDDirect
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fillReinGrid - Error"
    
End Sub


'/******************************************************************************
Private Sub mnuListReplaceFromCurCat_Click()
'/******************************************************************************
    
    On Error GoTo mnuListReplaceFromCurCat_Click_ERR
    
    Dim i As Long
    Dim ID As Long
    Dim sNames As String
    Dim sSQL As String
    
    Dim Col As New Collection
    Dim prt As clsPart
    Dim RS As ADODB.Recordset
    
    
    For i = 1 To fgList.Rows - 1
        
        If CBool(fgList.TextMatrix(i, fgList.ColIndex("m"))) = True Then
            
            Set prt = New clsPart
            
            prt.partID = fgList.TextMatrix(i, fgList.ColIndex("relID")) ' partID = relID
            prt.partName = fgList.TextMatrix(i, fgList.ColIndex("Наименование"))
            
            If Len(sNames) > 0 Then sNames = sNames & ","
            sNames = sNames & "'" & prt.partName & "'"
            
            Col.Add prt, prt.partName
            
            Set prt = Nothing
            
        End If
        
        
    Next i
    
    
    If Col.Count = 0 Then
        MsgBox "Выделите изделия списка, которые необходимо заменить"
        Exit Sub
        
    End If
    
    
    Set RS = New ADODB.Recordset
    RS.Open "select * from part where catID = " & lngCurCatID & " and partName in (" & sNames & ") and deleted = 0", cn_data, adOpenForwardOnly, adLockReadOnly
    
    If RS.EOF Then
        MsgBox "Не найдено изделий для замены в текущем каталоге"
        GoTo ext
    End If
    
    ' МЕНЯЕМ
    '=====================
    
    RS.MoveFirst
    Do
        Set prt = Col(RS.fields("partName").Value)
        
        prt.partIDold = RS.fields("partID").Value
        
    
        RS.MoveNext
    Loop Until RS.EOF
    
    
    
    For Each prt In Col
    
        If Len(sSQL) > 0 Then sSQL = sSQL & ";"
        sSQL = sSQL & "UPDATE r_catlist_part set partID = " & prt.partIDold & " WHERE relID = " & prt.partID
    
    Next prt
    
    Dim cmd As New ADODB.Command
    cmd.ActiveConnection = cn_data
    cmd.CommandText = sSQL
    cmd.Execute
    
    Dim tr, r As Long
    
    tr = fgList.toprow
    r = fgList.Row
    
    
    loadListGrid lngCurCatListID, False, False
    
    
    fgList.toprow = tr
    fgList.Row = r
    
ext:
    RS.Close
    Set RS = Nothing
    
    
    Exit Sub
    
mnuListReplaceFromCurCat_Click_ERR:
    Set RS = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuListReplaceFromCurCat_Click - Error"
    
End Sub


'/******************************************************************************
Public Sub loadCatsTreeCatalog2(RS As ADODB.Recordset, iSub As pwbldsub)
'/******************************************************************************

    On Error GoTo loadCatsTreeCatalog_ERR

    Dim TN As Node
    Dim obj As clsObj
    Dim ndPlus As Node
    
    Dim prnkey As String
    

    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Dim ct As New clsCat
            
            Set obj = globObjs(CStr(RS![objID]))
        
            If iSub Then
                prnkey = getPwBldSub(iSub) & RS.fields("objectID").Value
                'Exit Sub ' tmp
            Else
                prnkey = obj.objname & RS.fields("objectID").Value
            End If
        
        
            If ct.loadCatByID(RS, 0) Then
            
                cCats.AddCatSimple ct, CStr(ct.catID)
            
                If Not ct.bDeleted Then
                    If Not (ct.bForTesting And usrCurrent.groupID > 1) Then
                    
                        ' каталоги сидящие в доксетах не грузим
                        ' у этих каталогов [dsDrawingsID]>0 and [dsNumber] is null
                        If Not (RS.fields("dsDrawingsID").Value > 0 And IsNull(RS.fields("dsNumber").Value)) Then
                    
                            If addTreeNode(tvCats, TN, prnkey, tvwChild, _
                                    "catalog" & RS.fields("catID").Value, RS.fields("catName").Value, ct.getTreeNodeImage) Then
                                TN.Tag = "catalog"
                                TN.Expanded = isCatNodeExpanded(TN.KEY)
                                TN.bOld = ct.bUnif
                                If ct.bForTesting Then TN.ForeColor = &H80000010
    '                            TN.Sorted = True
    
                                If TN.Expanded Then
                                    loadCatsTreeNode TN
                                Else
                                    If RS.fields("catcnt").Value > 0 Or RS.fields("lstcnt").Value > 0 Then
                                        Call addTreeNode(tvCats, ndPlus, TN.KEY, tvwChild, TN.KEY & "+", "", "")
                                    End If
                                End If
    
                            End If
                        
                        End If
                        
                    End If
                End If
            
            End If
            
            Set ct = Nothing
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

Exit Sub

loadCatsTreeCatalog_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCatsTreeCatalog2 - Error"

End Sub

'/******************************************************************************
Public Function getWdt(prnkey As String) As Integer
'/******************************************************************************

    On Error GoTo getWdt_ERR

    Dim ar() As String

    ar = Split(tvCats.Nodes(prnkey).FullPath, " - ")
    
    getWdt = (CInt(tvCats.width) - (UBound(ar)) * 300 - 1500) / 90
    
    If getWdt < 30 Then getWdt = 30

Exit Function

getWdt_ERR:

    getWdt = 30

End Function

'/******************************************************************************
Public Sub loadCatsTreeCatalogPW(RS As ADODB.Recordset, bPW As Boolean, iSub As pwbldsub)
'/******************************************************************************

    On Error GoTo loadCatsTreeCatalog_ERR

    Dim TN As Node
    Dim obj As clsObj
    Dim ndPlus As Node
    Dim prnkey As String

    If Not RS.EOF Then
        RS.MoveFirst
        Do
            Dim ct As New clsCat
            
            Set obj = globObjs(CStr(RS![objID]))
            
            If iSub Then
                prnkey = getPwBldSub(iSub) & RS.fields("objectID").Value
            Else
                prnkey = obj.objname & RS.fields("objectID").Value
            End If
            
            Dim w As Integer
            w = getWdt(prnkey)
        
            If ct.loadCatByID(RS, 0, bPW) Then
            
                cCats.AddCatSimple ct, CStr(ct.catID)
            
                If Not ct.bDeleted Then
                    If Not (ct.bForTesting And usrCurrent.groupID > 1) Then
                    
                        If addTreeNode(tvCats, TN, prnkey, tvwChild, _
                                "catalog" & ct.catID, ct.getDocSetNumber(False, RS![prjID], RS![o_projectdesc], w), ct.getTreeNodeImage) Then
                            TN.Tag = "catalog" & "|" & ct.getDocSetNumber(False)
                            TN.Expanded = isCatNodeExpanded(TN.KEY)
                            TN.bOld = ct.bUnif
                            If ct.bForTesting Then TN.ForeColor = &H80000010
'                            TN.Sorted = True

                            If TN.Expanded Then
                                loadCatsTreeNode TN
                            Else
                                If RS.fields("catcnt").Value > 0 Or RS.fields("lstcnt").Value > 0 Then
                                    Call addTreeNode(tvCats, ndPlus, TN.KEY, tvwChild, TN.KEY & "+", "", "")
                                End If
                            End If

                        End If
                        
                    End If
                End If
            
            'ElseIf bPW Then
            ElseIf bPW And ct.dsDrawID > 0 Then
            
                If addTreeNode(tvCats, TN, prnkey, tvwChild, _
                        "docset" & ct.dsDrawID, ct.getDocSetNumber(False, RS![prjID], RS![o_projectdesc], w), "pwfolder") Then
                    TN.Tag = "docset" & "|" & ct.getDocSetNumber(False)

                End If
            
            End If
            
            Set ct = Nothing
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

Exit Sub

loadCatsTreeCatalog_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCatsTreeCatalogPW - Error"

End Sub

'
'/******************************************************************************
Public Sub loadCatsTree2(Optional bAll As Boolean = False)
'/******************************************************************************

    On Error GoTo loadCatsTree2_ERR

    Dim sImage As String
    
    Dim sBldName As String
    
    Dim strKeySelected As String
    Dim strDepName As String
    Dim ndPlus As Node
    
    Me.MousePointer = 11
    
    Set cCats = New colCats
    
    
    If Not tvCats.SelectedItem Is Nothing Then
        strKeySelected = tvCats.SelectedItem.KEY
    Else
        strKeySelected = ""
    End If


    Dim RS As New ADODB.Recordset
    Dim TN As Node
    
    tvCats.Visible = False
    
    tvCats.Nodes.Clear
    
    
    
    If bAll Then
        RS.Open "select * from view_r_dep_project where [deleted] = 0", cn_data, adOpenForwardOnly, adLockReadOnly
    Else
        RS.Open "select * from view_r_dep_project where [depID] = " & usrCurrent.depID & " and [deleted] = 0", cn_data, adOpenForwardOnly, adLockReadOnly
    End If
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            If bAll Then
                strDepName = RS.fields("dprtName").Value
            End If
        
        
            If addTreeNode(tvCats, TN, "", 0, "project" & RS![projectID], RS![projectName], "project") Then
            
                Dim projectTypeID As Long
                Dim strProjectType As String
                If Not IsNull(RS![typeID]) Then
                    projectTypeID = RS![typeID]
                End If
                
                If bAll Then TN.text = strDepName & " - " & TN.text
                
                TN.Tag = "project"
                    
                TN.Expanded = isCatNodeExpanded(TN.KEY)
                
                If TN.Expanded Then
                    '===================
                    loadCatsTreeNode TN
                    '===================
                Else
                    Call addTreeNode(tvCats, ndPlus, TN.KEY, tvwChild, TN.KEY & "+", "", "")
                End If
            
            ElseIf bAll Then
                Set TN = tvGetTreeNode(tvCats, "project" & RS![projectID])
                If Not TN Is Nothing Then
'                    TN.text = RS![projectName]
                    TN.text = strDepName & " - " & TN.text
                End If
            End If
        
            
            RS.MoveNext
        Loop Until RS.EOF
    End If
    
    RS.Close
    
    
    lngCurCatalogIDtoCopy = 0
    lngCurCatListIDtoCopy = 0
    
    
    If (Len(strKeySelected) > 0) Then
        selectTreeNode strKeySelected, tvCats
    End If
    
    Set RS = Nothing
    
    tvCats.Visible = True
    
    Me.MousePointer = 0


Exit Sub

loadCatsTree2_ERR:
    tvCats.Visible = True
    Me.MousePointer = 0
    Set RS = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadCatsTree2 - Error"

End Sub


'/******************************************************************************
Public Sub tvRemoveChildNodes(nd As Node)
'/******************************************************************************

    On Error GoTo provideNode_ERR

    While Not nd.Child Is Nothing
        tvRemoveChildNodes nd.Child
        tvCats.Nodes.Remove nd.Child.KEY
    Wend



Exit Sub

provideNode_ERR:

End Sub


'/******************************************************************************
Private Sub mnuCatsTreeReload_Click()
'/******************************************************************************

    On Error GoTo mnuCatsTreeReload_Click_ERR
    
    Dim nd As Node
    Dim n As Node
    
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    tvCatsTreeUpdateExpanded
    
    tvCats.Visible = False
    
    While Not nd.Child Is Nothing
        tvRemoveChildNodes nd.Child
        tvCats.Nodes.Remove nd.Child.KEY
    Wend
    
    
    loadCatsTreeNode nd

    tvCats.Visible = True

Exit Sub

mnuCatsTreeReload_Click_ERR:
    tvCats.Visible = True
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "mnuCatsTreeReload_Click - Error"

End Sub

'/******************************************************************************
Public Function getDocGuids(ByRef cnpw As ADODB.Connection, projID As Long) As String
'/******************************************************************************

    On Error GoTo getDocGuids_ERR

    If projID = 0 Then
        getDocGuids = ""
        Exit Function
    End If

    Dim strSQL As String
    Dim strguids As String
    Dim cnpwa As ADODB.Connection
    
    If cnpw Is Nothing Then
        Set cnpwa = New ADODB.Connection
        cnpwa.Open pwset.constring, pwset.login, pwset.login
    Else
        Set cnpwa = cnpw
    End If

    Dim RS As New ADODB.Recordset

    strSQL = "select gsd.o_docguid, aep_docdata.ID as ddID from getSubDocs(" & projID & ",'..',0) as gsd "
    strSQL = strSQL & "inner join aep_docdata on gsd.o_docguid = aep_docdata.docguid "
    strSQL = strSQL & "where aep_docdata.deleted = 0"
    
    RS.Open strSQL, cnpwa, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            
            If Len(strguids) = 0 Then
                strguids = CStr(RS.fields("ddID").Value)
            Else
                strguids = strguids & "," & CStr(RS.fields("ddID").Value)
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    End If

    RS.Close
    Set RS = Nothing
    
    
    If cnpw Is Nothing Then
        cnpwa.Close
        Set cnpwa = Nothing
    End If
    
    getDocGuids = strguids

Exit Function

getDocGuids_ERR:
    getDocGuids = "0"
    F1.SB.Panels("status").text = "getDocGuids" & "() - " & err.Description

End Function


 'ez 2017-07-07 доб.
'/******************************************************************************
Public Sub loadSimDataTest(nd As Node, ByRef cnpw As ADODB.Connection)
'/******************************************************************************
    On Error GoTo loadSimDataTest_ERR
    
    Dim stp As String

    Dim RS As ADODB.Recordset
    Dim projID As Long
    Dim UnitFilter As String
    Dim strSQL As String
    Dim strguids As String
    Dim i As Integer, j As Integer
    Dim strView As String
    Dim ID As Long
    Dim fgDyn As VSFlexGrid
    Dim ar() As String
        
    'tbSimData
    Dim TabIndex%
    While Config.TempViewTabs.Count > 0
        stp = "Config.TempViewTabs.Remove 1"
        Config.TempViewTabs.Remove 1
    Wend
    
    'подключение с БД
    Dim cn As New ADODB.Connection
    cn.CommandTimeout = 60
    'cn.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
    stp = "cn.Open Provider=..."
    cn.Open "Provider=SQLOLEDB;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & _
                        strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
    'cn.Open "Provider=SQLOLEDB;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"

    fgSim.Rows = 1
    fgSim2.Rows = 1
    fgSim3.Rows = 1
    fgSim4.Rows = 1
    fgSim5.Rows = 1
    fgSim6.Rows = 1
    
    stp = "Call Config.fgTabViews.RemoveAll"
    Call Config.fgTabViews.RemoveAll
    stp = "Call Config.fgTabs.RemoveAll"
    Call Config.fgTabs.RemoveAll
    
    stp = "start view iteration"
    
    Dim oView As clsConfigSimView
    For Each oView In Config.SimViews
    
        stp = " oView.Name=" & oView.Name
    
        Dim RegExp As New RegExp
        stp = " RegExp.Pattern = oView.Keys"
        RegExp.Pattern = oView.Keys
        
        Dim re_Proj As New RegExp
        stp = " re_Proj.Pattern = oView.Proj"
        re_Proj.Pattern = oView.Proj
        
        Dim pNode As Node
        stp = " Set pNode = nd"
        Set pNode = nd
        
        stp = " If Len(oView.Proj) > 0 Then"
        If Len(oView.Proj) > 0 Then
            Do While Not pNode Is Nothing
                If re_Proj.Test(pNode.text) Then
                    GoTo L_Proj_OK
                End If
                Set pNode = pNode.parent
            Loop
            GoTo L_Next
        End If
        
L_Proj_OK:

        stp = " If RegExp.Test(nd.KEY) Then"
        If RegExp.Test(nd.KEY) Then
            
'            'создаём динамическую вкладку
'            tbSimData.AddTab oView.Title
'            Config.TempViewTabs.Add tbSimData.NumTabs - 1
'            'TODO достучатся до flexgrid
            
            TabIndex = -1
            
            Select Case Config.TempViewTabs.Count
                Case 0: TabIndex = 1: Set fgDyn = fgSim
                Case 1: TabIndex = 3: Set fgDyn = fgSim2
                Case 2: TabIndex = 4: Set fgDyn = fgSim3
                Case 3: TabIndex = 5: Set fgDyn = fgSim4
                Case 4: TabIndex = 6: Set fgDyn = fgSim5
                Case 5: TabIndex = 7: Set fgDyn = fgSim6
                Case Else: GoTo Cancel
            End Select
            
            stp = " Call Config.fgTabViews.Add(TabIndex, oView)"
            Call Config.fgTabViews.Add(TabIndex, oView)
            stp = " Call Config.fgTabs.Add(TabIndex, fgDyn)"
            Call Config.fgTabs.Add(TabIndex, fgDyn)
            
            'настройка выделения
            stp = " настройка выделения ..."
            With fgDyn
                .Rows = 1
                .SelectionMode = flexSelectionByRow
                .HighLight = flexHighlightAlways
                .AllowBigSelection = True
                If oView.cEditFields.Count > 0 Then
                    .Editable = flexEDKbdMouse
                Else
                    .Editable = flexEDNone
                End If
                .AutoResize = True
                .ScrollBars = flexScrollBarBoth
            End With
            
                        
            stp = " Config.TempViewTabs.Add TabIndex"
            Config.TempViewTabs.Add TabIndex
            stp = " tbSimData.TabVisible(TabIndex) = True"
            tbSimData.TabVisible(TabIndex) = True
            stp = " tbSimData.TabCaption(TabIndex) = oView.Title"
            tbSimData.TabCaption(TabIndex) = oView.Title
                        
            RegExp.Pattern = "\w{2}[A-Z]{3}[0-9]{2}$"
            UnitFilter = "" 'сброс фильтра по отметке здания
            stp = " If RegExp.Test(nd.KEY) Then"
            If RegExp.Test(nd.KEY) Then
                UnitFilter = right$(nd.KEY, Len(nd.KEY) - 4)
                If nd.parent.Tag = "|" Then
                    ar = Split(nd.parent.KEY, "|")
                    If UBound(ar) = 1 Then projID = Val(ar(1))
                Else
                    projID = Val(right$(nd.parent.KEY, Len(nd.parent.KEY) - 4))
                End If
            Else
                If nd.Tag = "|" Then
                    ar = Split(nd.KEY, "|")
                    If UBound(ar) = 1 Then projID = Val(ar(1))
                Else
                    projID = Val(right$(nd.KEY, Len(nd.KEY) - 4))
                End If
            End If
            
            stp = " strguids = getDocGuids(cnpw, projID)"
            strguids = getDocGuids(cnpw, projID)
            
            stp = " strguids = " & strguids
            If Len(strguids) = 0 Then GoTo Cancel
            
            'Обработка функций в тексте запроса:
            '1
            RegExp.Pattern = "%f\.getDocGuids%"
            stp = " strSQL = RegExp.Replace(oView.SqlQuery, strguids)"
            strSQL = RegExp.Replace(oView.SqlQuery, strguids)
            '2
            RegExp.Pattern = "%f\.pdsID%"
            stp = " strSQL = RegExp.Replace(strSQL, usrCurrent.pdsID)"
            strSQL = RegExp.Replace(strSQL, usrCurrent.pdsID)
            '3
            RegExp.Pattern = "%f\.CurCatID%"
            stp = " strSQL = RegExp.Replace(strSQL, lngCurCatID)"
            strSQL = RegExp.Replace(strSQL, lngCurCatID)
            '4
            RegExp.Pattern = "%f\.NodeText%"
            stp = " strSQL = RegExp.Replace(strSQL, nd.text)"
            strSQL = RegExp.Replace(strSQL, nd.text)
            '5
            RegExp.Pattern = "%f\.projID%"
            stp = " strSQL = RegExp.Replace(strSQL, nd.text)"
            strSQL = RegExp.Replace(strSQL, projID)
            
            'Выполнение SQL запроса:
            Set RS = New ADODB.Recordset
            stp = " RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly, strSQL=" & strSQL
            
            '======================================================
            RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
            '======================================================
            
            'запись результата запроса в таблицу
            stp = " Set fgDyn.DataSource = RS"
            Set fgDyn.DataSource = RS
            'cохранение sql запроса
            stp = " fgDyn.Tag = strSQL"
            fgDyn.Tag = strSQL
            
            'скрытые столбцы:
            stp = " If Len(oView.HiddenColumns) > 0 Then..."
            If Len(oView.HiddenColumns) > 0 Then
                RegExp.Pattern = oView.HiddenColumns
                For j = 0 To fgDyn.cols - 1
                    If RegExp.Test(fgDyn.ColKey(j)) Then fgDyn.ColHidden(j) = True
                Next
            End If
            
            'скрытые строки (фильтрация по отметке):
            stp = " If Len(UnitFilter) > 0 And Len(oView.LevelFilterColumn) > 0 Then..."
            If Len(UnitFilter) > 0 And Len(oView.LevelFilterColumn) > 0 Then
                RegExp.Pattern = oView.LevelFilterColumn
                Dim fld As Field
                For Each fld In RS.fields
                    If RegExp.Test(fld.Name) Then
                        RegExp.Pattern = UnitFilter
                        For i = 1 To fgDyn.Rows - 1
                            If Not RegExp.Test(fgDyn.TextMatrix(i, fgDyn.ColIndex(fld.Name))) Then
                                fgDyn.RowHidden(i) = True
                            End If
                        Next
                        Exit For
                    End If
                Next
            End If
            
            
            Dim c As clsObjVec
            stp = " iter cEditFields... Title=" & oView.Title & ", cEditFields.Count=" & oView.cEditFields.Count
            For Each c In oView.cEditFields
                Dim colindsrc As Long
                Dim colindtrg As Long
                colindsrc = fgDyn.ColIndex(c.src.props("Column").propValue)
                colindtrg = fgDyn.ColIndex(c.trg.props("Column").propValue)
                If colindsrc >= 0 And colindtrg >= 0 Then
                    fgDyn.Select 1, colindsrc, fgDyn.Rows - 1, colindsrc
                    fgDyn.CellBorder RGB(130, 130, 130), 1, 0, 1, 1, 0, 1
                    fgDyn.Select 0, 0, 0, 0
                    For i = 1 To fgDyn.Rows - 1
                        If Len(fgDyn.TextMatrix(i, colindtrg)) > 0 Then ' CHECK TARGET CELL (trg)
                             fgDyn.Cell(flexcpBackColor, i, colindsrc) = lngGrey
                         End If
                    Next
                End If
            Next
            
            'объединение ячеек в нужных столбцах:
            stp = " If Len(oView.MergeColumns) > 0 Then..."
            If Len(oView.MergeColumns) > 0 Then
                fgDyn.MergeCompare = flexMCExact: fgDyn.MergeCells = flexMergeFree
                RegExp.Pattern = oView.MergeColumns
                For j = 0 To fgDyn.cols - 1
                    If RegExp.Test(fgDyn.ColKey(j)) Then fgDyn.MergeCol(j) = True
                Next
            End If
            
            'Столбец с автоиндексацией (! пока только для Закладных, т.к. sql-серевер индексацию выполняет не корректно)
            stp = " If Len(oView.AutoIndexColumn) > 0 Then..."
            If Len(oView.AutoIndexColumn) > 0 Then
                RegExp.Pattern = oView.AutoIndexColumn
                For j = 0 To fgDyn.cols - 1
                    If RegExp.Test(fgDyn.ColKey(j)) Then
                        Dim Index%: Index = 0
                        For i = 1 To fgDyn.Rows - 1
                            Index = Index + 1
                            fgDyn.TextMatrix(i, j) = Index
                        Next
                    End If
                Next
            End If
            
            'Столбцы с вычислением суммы значений
            stp = " If Len(oView.SubTotalColumns) > 0 Then..."
            If Len(oView.SubTotalColumns) > 0 Then
                RegExp.Pattern = oView.SubTotalColumns
                For j = 0 To fgDyn.cols - 1
                    If RegExp.Test(fgDyn.ColKey(j)) Then
                        fgDyn.Subtotal flexSTSum, -1, j, "0.0", lngGrey, , True, "Всего"
                    End If
                Next
            End If
            
            'TODO заморозка/закрепление 1-го столбца ?
                        
            stp = " RS.Close: Set RS = Nothing"
            RS.Close: Set RS = Nothing
            
            ' FIRE COMPARTMENT temp section
            '===============================================
            Dim codeID As Long
            If oView.Name = "FireRoomsFH1" Then ' редактирование
                For j = 0 To fgDyn.Rows - 1
                
                    codeID = Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireCompID)))
                    If codeID > 0 Then
                        fgDyn.Cell(flexcpFontBold, j, fgDyn.ColIndex(strFireCode), j, fgDyn.ColIndex(strFireCode)) = True
                    End If
                    
                    sFireCompFileName = App.path & "\xls\" & Replace(tvWise.SelectedItem.FullPath, "\", "_") & ".xls"

                    tbWise.Buttons("Excel").ButtonMenus("ExcelOpen").Enabled = FileExists(sFireCompFileName)
                    tbWise.Buttons("Excel").ButtonMenus("ExcelLoad").Enabled = FileExists(sFireCompFileName)
                    
                Next
                
                makeDir App.path & "\xls"
                
            ElseIf oView.Name = "FireCompFH1" Then
                For j = 0 To fgDyn.Rows - 1
                
                    codeID = Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireCompID)))
                    
                    If codeID > 0 Then
                        fgDyn.Cell(flexcpFontBold, j, fgDyn.ColIndex(strFireCode), j, fgDyn.ColIndex(strFireCode)) = True
                        
                        If Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireResMan))) = 0 Then
                            fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireResMan)) = ""
                        Else
                            If Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireRes))) <> Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireResMan))) Then
                                fgDyn.Cell(flexcpBackColor, j, fgDyn.ColIndex(strFireRes), j, fgDyn.ColIndex(strFireResMan)) = lngLightRed
                            End If
                        End If
                        
                        If Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireArea))) <> Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireAreaMan))) _
                                            And Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireAreaMan))) > 0 Then
                            fgDyn.Cell(flexcpBackColor, j, fgDyn.ColIndex(strFireArea), j, fgDyn.ColIndex(strFireAreaMan)) = lngLightRed
                        End If
                        
                        If (fgDyn.ColIndex("f loads") > 0 And fgDyn.ColIndex("fcFireLoadID") > 0) Then
                            If fgDyn.TextMatrix(j, fgDyn.ColIndex("f loads")) <> fgDyn.TextMatrix(j, fgDyn.ColIndex("fcFireLoadID")) Then
                                'fgDyn.TextMatrix(j, fgDyn.ColIndex("f loads")) = fgDyn.TextMatrix(j, fgDyn.ColIndex("f loads")) & "(" & fgDyn.TextMatrix(j, fgDyn.ColIndex("fcFireLoadID")) & ")"
                                fgDyn.Cell(flexcpBackColor, j, fgDyn.ColIndex("f loads"), j, fgDyn.ColIndex("f loads")) = lngLightRed
                            End If
                        End If
                        
    '                    If Val(fgDyn.TextMatrix(j, fgDyn.ColIndex(strFireResMan))) > 0 Then
    '                        fgDyn.Cell(flexcpFontBold, j, fgDyn.ColIndex(strFireRes), j, fgDyn.ColIndex(strFireRes)) = True
    '                    End If
                    End If
                    
                Next
                
                fgDyn.Select 1, fgDyn.ColIndex(strFireResMan), fgDyn.Rows - 1, fgDyn.ColIndex(strFireResMan)
                fgDyn.CellBorder RGB(130, 130, 130), 1, 0, 1, 1, 0, 1
                fgDyn.Select 1, fgDyn.ColIndex(strFireAreaMan), fgDyn.Rows - 1, fgDyn.ColIndex(strFireAreaMan)
                fgDyn.CellBorder RGB(130, 130, 130), 1, 0, 1, 1, 0, 1
                fgDyn.Select 0, 0, 0, 0
                
                fgDyn.Editable = flexEDKbdMouse
            End If
            '===============================================
            
            stp = " AutoSize"
            With fgDyn
                .AutoSize 0, .cols - 1
                If .width > tbSimData.width Then
                    .width = tbSimData.width
                End If
            End With
            
            'контроль ошибок обрабатываемой вкладки
'            Call Config.checkTabViewErrors(TabIndex) ' перенесено ниже
        End If
L_Next:
    Next
    
    stp = "If Config.fgTabs.Count > 0 Then..."
    If Config.fgTabs.Count > 0 Then
        stp = " TabIndex = Config.fgTabs.Keys(0)"
        TabIndex = Config.fgTabs.Keys(0)
        stp = " Config.LastTabIndex = TabIndex"
        Config.LastTabIndex = TabIndex 'предваряем проверку на ошибки
        
        
        stp = " If Not Config.LastNodeKey = left$(nd.KEY, 4) Or tbSimData.CurrTab = 0 Then"
        If Not Config.LastNodeKey = left$(nd.KEY, 4) Or tbSimData.CurrTab = 0 Then
            stp = " tbSimData.CurrTab = TabIndex"
            tbSimData.CurrTab = TabIndex 'переключаем на первую вкладку
            stp = " Config.LastNodeKey = left$(nd.KEY, 4)"
            Config.LastNodeKey = left$(nd.KEY, 4)
        End If
        
        stp = " Config.checkTabViewErrors tbSimData.CurrTab"
        Config.checkTabViewErrors tbSimData.CurrTab
        
    End If
    
Cancel:


    stp = "cn.Close"
    cn.Close
    Set cn = Nothing

    stp = ""

Exit Sub

loadSimDataTest_ERR:
    F1.SB.Panels("status").text = "loadSimDataTest" & "() - " & err.Description & ", " & stp

End Sub



'/******************************************************************************
Public Sub loadSimData(nd As Node, ByRef cnpw As ADODB.Connection)
'/******************************************************************************
    
    On Error GoTo loadSimData_ERR
    
    Dim RS As ADODB.Recordset
    Dim RS2 As ADODB.Recordset
    Dim projID As Long
    Dim strSQL As String
    Dim strguids As String
    Dim i As Integer
    Dim strView As String
    Dim strViewOrder As String
    Dim ID As Long
    

    'активное состояние кнопки выгрузки в Excel для общего случая
    tbWise.Buttons("Excel").Enabled = True 'ezamiralov 2017-06-29 доб
    
    fgSim.Rows = 1
    fgSim.SelectionMode = flexSelectionListBox
    
    Dim cn As New ADODB.Connection
    cn.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
    
    With fgSim

        
        If left(nd.KEY, 4) = "wise" Then
            
            projID = Val(Replace(nd.KEY, "wise", ""))
            
            ' получаем имя проекта getProjName(projID) (cnpw)
            ' получаем имя вида из r_project_interface (cn)
            strView = "elements" '............
            
            strguids = getDocGuids(cnpw, projID)
            
            If Len(strguids) = 0 Then Exit Sub
            
            Set RS = New ADODB.Recordset
            
            strSQL = "select * from " & strView & " "
            strSQL = strSQL & "where pwdocID in (" & strguids & ")"
            
            '            strSQL = "select * from view_i_Concrete_group "
            '            strSQL = strSQL & "where pwdocID in (" & strGuids & ")"
            '
            
            RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly

            
            Set .DataSource = RS
            
            RS.Close
            Set RS = Nothing
            
            For i = 0 To .cols - 1
                If LCase(right(.ColKey(i), 2)) = "id" Then .ColHidden(i) = True
                If LCase(left(.ColKey(i), 3)) = "is " Then .ColDataType(i) = flexDTBoolean
            Next i
            
            For i = 1 To .Rows - 1
                .TextMatrix(i, .ColIndex("elemvolume")) = Round(getDbl(.TextMatrix(i, .ColIndex("elemvolume"))) * 0.000000000000001, 2)
            Next i
            
            fgSim.AutoSize 0, fgSim.cols - 1
            
            
            
'        ElseIf left(nd.KEY, 4) = "rmsf" Or left(nd.KEY, 4) = "rlvl" Then
'
'            strView = Environ$("AEP_SAVRD_VIEW_ROOM")
'            strViewOrder = Environ$("AEP_SAVRD_VIEW_ROOM_order")
'            If Len(Trim(strView)) = 0 Then strView = "view_i_Space_spf"
'
'            If left(nd.KEY, 4) = "rmsf" Then
'                projID = Val(Replace(nd.KEY, "rmsf", ""))
'            Else
'                projID = Val(Replace(nd.parent.KEY, "rmsf", ""))
'            End If
'
'            strguids = getDocGuids(cnpw, projID)
'
'            If Len(strguids) = 0 Then Exit Sub
'
'            Set RS2 = New ADODB.Recordset
'            strSQL = "select * from " & strView & " "
'            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
'            If Len(Trim(strViewOrder)) > 0 Then
'                If left(nd.KEY, 4) = "rlvl" Then strSQL = strSQL & "and " & strViewOrder & " like '" & nd.text & "%' "
'                strSQL = strSQL & " order by " & strViewOrder
'            End If
'            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
'
'            Set .DataSource = RS2
'
'            RS2.Close
'            Set RS2 = Nothing
'
'            For I = 0 To .cols - 1
'                If LCase(right(.ColKey(I), 2)) = "id" Then .ColHidden(I) = True
'            Next I
'
'            Dim errcnt%: errcnt = 0
'
'             'ezamiralov 2017-06-29 изм -------------------------------------------------------------------------
'            Dim RegExp As New RegExp: RegExp.Pattern = "[\sа-яА-Я]" 'ezamiralov доб
'            For I = 1 To .Rows - 1
'                .TextMatrix(I, .ColIndex("area")) = Round(getDbl(.TextMatrix(I, .ColIndex("area"))), 2)  ' m2
'                .TextMatrix(I, .ColIndex("volume")) = Round(getDbl(.TextMatrix(I, .ColIndex("volume"))), 2)  ' m3
'                If .TextMatrix(I, .ColIndex("kks")) = .TextMatrix(I - 1, .ColIndex("kks")) Then
'                    .Cell(flexcpBackColor, I - 1, .ColIndex("kks"), I, .ColIndex("kks")) = lngLightRed
'                End If
'                'ezamiralov доб проверка на кириллицу --------------------------------------------------------------
'                If RegExp.Test(.TextMatrix(I, .ColIndex("kks"))) Then
'                    .Cell(flexcpBackColor, I, .ColIndex("kks"), I, .ColIndex("kks")) = lngRed
'                    errcnt = errcnt + 1
'                End If
'                '-----------------------------------------------------------------------------
'            Next I
'            Set RegExp = Nothing 'ezamiralov доб
'
'            'ezamiralov доб ------------------------------------------------------------------
'            tbWise.Buttons("Excel").Enabled = errcnt = 0
'            If errcnt > 0 Then
'                MsgBox "В столбце 'kks' надены поля содержащие кириллические или пробельные символы." & _
'                vbLf & "Количество некорректных полей: " & errcnt, vbOKOnly + vbExclamation
'            End If
'            '---------------------------------------------------------------------------------
'            '----------------------------------------------------------------------------------------------------
'
'            fgSim.AutoSize 0, fgSim.cols - 1
'
'
'        ElseIf left(nd.KEY, 4) = "embf" Then
'
'            projID = Val(Replace(nd.KEY, "embf", ""))
'
'            strguids = getDocGuids(cnpw, projID)
'
'            If Len(strguids) = 0 Then Exit Sub
'
'            Set RS2 = New ADODB.Recordset
'
'            strSQL = "select * from func_i_EmbPart(0," & usrCurrent.pdsID & "," & lngCurCatID & ") "
'            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
'            strSQL = strSQL & "order by [Civil Code]"
'
'            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
'
'            Set .DataSource = RS2
'
'            RS2.Close
'            Set RS2 = Nothing
'
'            For I = 0 To .cols - 1
'                If LCase(right(.ColKey(I), 2)) = "id" Then .ColHidden(I) = True
'            Next I
'
'            For I = 1 To .Rows - 1
'                .TextMatrix(I, .ColIndex("number")) = I
'            Next I
'
'            fgSim.AutoSize 0, fgSim.cols - 1
            
        ElseIf left(nd.KEY, 4) = "cncf" Or left(nd.KEY, 4) = "clvl" Then
            
            strView = Environ$("AEP_SAVRD_VIEW_CONCRETE")
            strViewOrder = Environ$("AEP_SAVRD_VIEW_CONCRETE_order")
            If Len(Trim(strView)) = 0 Then strView = "view_i_Concrete"
            
            If left(nd.KEY, 4) = "cncf" Then
                projID = Val(Replace(nd.KEY, "cncf", ""))
            Else
                projID = Val(Replace(nd.parent.KEY, "cncf", ""))
            End If
            
            strguids = getDocGuids(cnpw, projID)
            
            If Len(strguids) = 0 Then Exit Sub
            
            Set RS2 = New ADODB.Recordset
            
            strSQL = "select * from " & strView & " "
            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
            If Len(Trim(strViewOrder)) > 0 Then
                If left(nd.KEY, 4) = "clvl" Then strSQL = strSQL & "and " & strViewOrder & " like '" & nd.text & "%' "
                strSQL = strSQL & " order by " & strViewOrder
            End If
            
            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
            
            Set .DataSource = RS2
            
            RS2.Close
            Set RS2 = Nothing
            
            For i = 0 To .cols - 1
                If LCase(right(.ColKey(i), 2)) = "id" Then .ColHidden(i) = True
            Next i
            
            fgSim.ColFormat(.ColIndex("volume")) = "#,##0.00"
            fgSim.ColFormat(.ColIndex("wallarea")) = "#,##0.00"
            
            For i = 1 To .Rows - 1
'                .TextMatrix(i, .ColIndex("volume")) = Round(getDbl(.TextMatrix(i, .ColIndex("volume"))) * 0.000000000000001, 2) ' m3
                If Val(.TextMatrix(i, .ColIndex("codeID"))) > 0 Then .Cell(flexcpFontBold, i, .ColIndex("Civil Code"), i, .ColIndex("Civil Code")) = True
            Next i
            
            fgSim.Subtotal flexSTSum, -1, fgSim.ColIndex("volume"), "0.0", lngGrey, , True, "Всего"
            fgSim.Subtotal flexSTSum, -1, fgSim.ColIndex("wallarea"), "0.0", lngGrey, , True, "Всего"
            
            fgSim.AutoSize 0, fgSim.cols - 1 ' before merge
            
            ' не работает из=за скрытых столбцов
'            fgSim.MergeCells = flexMergeRestrictAll
'            fgSim.MergeCol(.ColIndex("cattype")) = True
'            fgSim.MergeCol(.ColIndex("catitem")) = True
'            fgSim.MergeCol(.ColIndex("partdef")) = True
'            fgSim.MergeCol(.ColIndex("Lower Level")) = True
'            fgSim.MergeCol(.ColIndex("Upper Level")) = True
'            fgSim.MergeCol(.ColIndex("Material")) = True
            
            '==================
            
            Set RS2 = New ADODB.Recordset
            
            strSQL = "SELECT [elemLevel],[elemType],[Is External],[elemSection],[Material], sum([volume]) as volume, sum([elemArea]) as area "
            strSQL = strSQL & "FROM [" & strCurSimBase & "].[dbo].[view_i_Concrete_group] "
            strSQL = strSQL & "WHERE pwdocID in (" & strguids & ") "
            If left(nd.KEY, 4) = "clvl" Then strSQL = strSQL & "AND [codeLevel] = '" & nd.text & "'"
            strSQL = strSQL & "GROUP BY [elemLevel],[elemType],[Is External],[elemSection],[Material] "
            strSQL = strSQL & "ORDER BY [elemLevel],[elemType],[Is External],[elemSection],[Material] "
            
'            strSQL = "SELECT [elemType], [elemLevel], [Is External], [Material], sum([volume]) as volume "
'            strSQL = strSQL & "FROM " & strCurSimBase & ".[dbo].[view_i_Concrete_group] "
'            strSQL = strSQL & "WHERE pwdocID in (" & strGuids & ") "
'            strSQL = strSQL & "GROUP BY [elemType],[elemLevel],[Is External],[Material] "
'            strSQL = strSQL & "ORDER BY [elemType],[elemLevel],[Is External],[Material] "
            
            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
            
            Set fgSimVol.DataSource = RS2
            
            fgSimVol.ColFormat(fgSimVol.ColIndex("volume")) = "#,###.#"
            fgSimVol.ColFormat(fgSimVol.ColIndex("area")) = "#,###.#"
'            fgSimVol.ColFormat(fgSimVol.ColIndex("elemSection")) = "0"
            
'            For I = 1 To .Rows - 1
'                If InStr(.TextMatrix(I, .ColIndex("elemSection")), "x") = 0 Then .TextMatrix(I, .ColIndex("elemSection")) = getDbl(.TextMatrix(I, .ColIndex("elemSection")))
'            Next I
            
            fgSimVol.Subtotal flexSTSum, -1, fgSimVol.ColIndex("volume"), "0.0", lngGrey, , True, "Всего"
            fgSimVol.Subtotal flexSTSum, -1, fgSimVol.ColIndex("area"), "0.0", lngGrey, , True, "Всего"
            
            fgSimVol.cols = fgSimVol.cols + 1
            fgSimVol.AutoSize 0, fgSimVol.cols - 1 ' before merge
            
            fgSimVol.MergeCol(0) = True
            fgSimVol.MergeCol(1) = True
            fgSimVol.MergeCol(2) = True
            fgSimVol.MergeCol(3) = True
            
            RS2.Close
            Set RS2 = Nothing
            
            
        ElseIf left(nd.KEY, 4) = "drsf" Then
            
            strView = Environ$("AEP_SAVRD_VIEW_DOORS")
            strViewOrder = Environ$("AEP_SAVRD_VIEW_DOORS_order")
            If Len(Trim(strView)) = 0 Then strView = "view_i_Doors"
            
            projID = Val(Replace(nd.KEY, "drsf", ""))
            
            strguids = getDocGuids(cnpw, projID)
            
            If Len(strguids) = 0 Then Exit Sub
            
            Set RS2 = New ADODB.Recordset
            
            strSQL = "select * from " & strView & " "
            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
            If Len(Trim(strViewOrder)) > 0 Then
                strSQL = strSQL & " order by " & strViewOrder
            End If
            
            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
            
            Set .DataSource = RS2
            
            RS2.Close
            Set RS2 = Nothing
            
            For i = 0 To .cols - 1
                If LCase(right(.ColKey(i), 2)) = "id" Then .ColHidden(i) = True
            Next i
            
            For i = 1 To .Rows - 1
                .TextMatrix(i, .ColIndex("height")) = Round(getDbl(.TextMatrix(i, .ColIndex("height"))) * 0.01, 0) ' mm
                .TextMatrix(i, .ColIndex("width")) = Round(getDbl(.TextMatrix(i, .ColIndex("width"))) * 0.01, 0) ' mm
            Next i
            
            fgSim.AutoSize 0, fgSim.cols - 1

            
        ElseIf left(nd.KEY, 4) = "room" Then
            
            .cols = 3
            
            .ColHidden(0) = True
            .ColHidden(1) = False
            .ColHidden(2) = False
            
            .ColAlignment(1) = flexAlignRightCenter
            .ColAlignment(2) = flexAlignLeftCenter
            
            .Rows = 1
            .SelectionMode = flexSelectionFree
            .HighLight = flexHighlightAlways
            .AllowBigSelection = False
            .Editable = flexEDKbdMouse
            .AutoResize = True
            .ScrollBars = flexScrollBarVertical
            
            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("room")))
            Set curRoom = New clsRoom
            If curRoom.loadData(Nothing, cnpw, ID) Then
                
                .AddItem 0 & vbTab & "simID" & vbTab & curRoom.simID
                .AddItem 0 & vbTab & "Помещение" & vbTab & curRoom.sRoomKKS
                .AddItem 0 & vbTab & "Наименование" & vbTab & curRoom.sRoomNameRus
                .AddItem 0 & vbTab & "Наименование анг." & vbTab & curRoom.sRoomNameEng
                .AddItem 0 & vbTab & "Объем" & vbTab & curRoom.iVolume & " м3"
                If curRoom.iLevMin > 0 Then .AddItem 0 & vbTab & "Отметка низа" & vbTab & curRoom.iLevMin & " мм"
                If curRoom.iLevMax > 0 Then .AddItem 0 & vbTab & "Отметка верха" & vbTab & curRoom.iLevMax & " мм"
                
                Dim prp As clsPrp
                For Each prp In curRoom.room_prps
                    Dim sdscr As String
                    sdscr = prp.propDescr
                    If Len(prp.PROP_MU.muShortName) > 0 Then sdscr = sdscr & ", " & prp.PROP_MU.muShortName
                    .AddItem prp.propName & vbTab & sdscr & vbTab & prp.PVAL
                    If prp.propvalName = "secid" And prp.colValues.Count > 0 Then fgSim.RowHeight(.Rows - 1) = 240 + (prp.colValues.Count - 1) * 210
                Next prp
                
                .Cell(flexcpBackColor, 1, 1, .Rows - 1, 1) = lngGrey
                
            End If
            
            fgSim.AutoSize 0, fgSim.cols - 1
            
            strSQL = "room"

            
        ElseIf left(nd.KEY, 4) = "cstr" Then
        
            .cols = 3
            
            .ColHidden(0) = True
            .ColHidden(1) = False
            .ColHidden(2) = False
            
            .ColAlignment(1) = flexAlignRightCenter
            .ColAlignment(2) = flexAlignLeftCenter
            
            
            
            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("cstr")))
                
            Set RS2 = New ADODB.Recordset
            
            strSQL = "select * from view_i_Concrete "
            strSQL = strSQL & "where simID = " & ID
            
            RS2.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
            
            If Not RS2.EOF Then
                RS2.MoveFirst
                For i = 0 To RS2.fields.Count - 1
                    .AddItem 0 & vbTab & RS2.fields(i).Name & vbTab & RS2.fields(i).Value
                    If LCase(right(RS2.fields(i).Name, 2)) = "id" Then .RowHidden(.Rows - 1) = True
                Next i
            End If
            
            RS2.Close
            Set RS2 = Nothing
                
            fgSim.Cell(flexcpBackColor, 1, 1, .Rows - 1, 1) = lngGrey
            
            fgSim.AutoSize 0, fgSim.cols - 1
        
        
        Else
            
        End If
        
        
    End With
    
    
    cn.Close
    Set cn = Nothing
    
    
    fgSim.Tag = strSQL
    
    
    
    Exit Sub
    
loadSimData_ERR:
    Set cn = Nothing
    F1.SB.Panels("status").text = "loadSimData" & "() - " & err.Description
    
End Sub


'/******************************************************************************
Public Sub loadWiseListNode(nd As Node, ByRef cnpw As ADODB.Connection)
'/******************************************************************************

    On Error GoTo loadWiseListNode_ERR
    
'    Me.lvWise.ListItems.Clear


    Dim RS As New ADODB.Recordset
    Dim projID As Long
    Dim li As ListItem
    Dim lsi As ListSubItem
    Dim strSQL As String
    
    
    If left(nd.KEY, 4) <> "wise" Then Exit Sub
    
    'If usrCurrent.trusted = False And Val(nd.Tag) < 3 Then Exit Sub


    lvWise.ListItems.Clear

    projID = Val(Replace(nd.KEY, "wise", ""))
    

'    strSQL = "select * from dms_doc "
'    strSQL = strSQL & "left outer join aep_docdata on dms_doc.o_docguid = aep_docdata.docguid "
'    strSQL = strSQL & "where dms_doc.o_projectno = " & projID & " and dms_doc.o_original = 0 order by dms_doc.o_itemname"
    
    strSQL = "select * from getSubDocs2(" & projID & ",'..',0) as gsd "
    
    If Me.tbWise.Buttons("ListChecked").Value = tbrPressed Then
        strSQL = strSQL & "inner join aep_docdata on gsd.o_docguid = aep_docdata.docguid "
        strSQL = strSQL & "where aep_docdata.deleted = 0 "
'        strSQL = strSQL & "inner join view_docdata on gsd.o_docguid = view_docdata.o_docguid "
'        strSQL = strSQL & "where view_docdata.deleted = 0 "
    Else
        strSQL = strSQL & "left outer join aep_docdata on gsd.o_docguid = aep_docdata.docguid "
'        strSQL = strSQL & "left outer join view_docdata on gsd.o_docguid = view_docdata.o_docguid "
    End If
    
    'MsgBox strSQL
    
    lvWise.Visible = False
    
    RS.Open strSQL, cnpw, adOpenForwardOnly, adLockReadOnly

    If Not RS.EOF Then
        RS.MoveFirst
        Do
'            Set li = Me.lvWise.ListItems.Add(, "item" & RS.Fields("o_itemno").Value, RS.Fields("o_itemname").Value)
'
'            li.Tag = RS.Fields("o_docguid").Value
'
'            Set lsi = li.ListSubItems.Add(, "sitem" & RS.Fields("o_itemno").Value, RS.Fields("o_applno").Value)
            
            Set li = Me.lvWise.ListItems.Add(, "item" & Trim(RS.fields("o_docguid").Value), RS.fields("docname").Value)
            
            li.Tag = RS.fields("projid").Value & "-" & RS.fields("ID").Value
            
            Set lsi = li.ListSubItems.Add(, "sitem" & Trim(RS.fields("o_docguid").Value), RS.fields("projname").Value)
            
            Debug.Print li.Tag
            
            
            
            
            If Not IsNull(RS.fields("deleted").Value) Then
                If Not RS.fields("deleted").Value Then
                    li.Checked = (RS.fields("deleted").Value = 0)
                End If
                If Trim(Abs(CInt(RS.fields("deleted").Value)) & "#" & RS.fields("fupdtime").Value) <> Trim(RS.fields("last_state").Value & "") Then
                    If Trim(RS.fields("last_state").Value & "") = "process" Then
                        If li.Checked Then li.SubItems(2) = "в обработке"
                    Else
                        If li.Checked Then li.SubItems(2) = "в очереди"
                    End If
                End If
            End If
            
            If Not IsNull(RS.fields("counter").Value) Then
                If RS.fields("counter").Value > 5 And li.Checked Then li.SubItems(2) = "ошибка"
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
    End If


    RS.Close
    
    Set RS = Nothing


    lvWise.Visible = True


Exit Sub

loadWiseListNode_ERR:
    lvWise.Visible = True
    F1.SB.Panels("status").text = "loadWiseListNode" & "() - " & err.Description

End Sub



'/******************************************************************************
Public Sub loadTreeNodeWise(nd As Node, Optional bLoadExpandSettings As Boolean = True)
'/******************************************************************************

    On Error GoTo loadTreeNodeWise_ERR

    Dim RS As New ADODB.Recordset
    Dim projID As Long
    Dim ndNew As Node
    Dim ndPlus As Node
    Dim strSQL As String
    Dim strguids As String
    Dim nRoom As Node
    Dim cnsim As ADODB.Connection
    Dim ID As Long
    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    

    
    If left(nd.KEY, 4) = "rmsf" Then ' rooms folder
    
        projID = Val(Replace(nd.KEY, "rmsf", ""))
        
        strguids = getDocGuids(cnpw, projID)
        
        If Len(strguids) > 0 Then
            Set cnsim = New ADODB.Connection
            
            Set RS = New ADODB.Recordset
            
            cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
            
            
            Set RS = New ADODB.Recordset
            
            strSQL = "select simID, kkslevel from view_i_Space_level "
            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
            strSQL = strSQL & "order by kkslevel"
            
            RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
            
            tvWise.Visible = False
            
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                
                    If Not IsNull(RS.fields("kkslevel").Value) Then
                        If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "rlvl" & RS.fields("kkslevel").Value, RS.fields("kkslevel").Value, "room_level") Then
                            Call addTreeNode(tvWise, ndPlus, nRoom.KEY, tvwChild, nRoom.KEY & "+", "", "")
                            nRoom.Tag = CStr(RS.fields("simID").Value)
                        Else
                            nRoom.Tag = nRoom.Tag & "," & CStr(RS.fields("simID").Value)
                        End If
                    End If
                
                    RS.MoveNext
                Loop Until RS.EOF
            
            End If
            
            
            RS.Close
            Set RS = Nothing
            
            cnsim.Close
            Set cnsim = Nothing
        End If
        
        tvWise.Visible = True
        
        Exit Sub
    
    ElseIf left(nd.KEY, 4) = "rfcf" Then ' fire comp
    
'        projID = Val(Replace(nd.KEY, "rfcf", ""))
'
'        strguids = getDocGuids(cnpw, projID)
'
'        Set cnsim = New ADODB.Connection
'
'        Set RS = New ADODB.Recordset
'
'        cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
'
'        Set RS = New ADODB.Recordset
'
'        strSQL = "select distinct fcID, pwdocID, fc from [view_i_FireComp] "
'        strSQL = strSQL & "where pwdocID in (" & strguids & ") "
'        strSQL = strSQL & "order by fc"
'
'        RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
'
'        tvWise.Visible = False
'
'        If Not RS.EOF Then
'            RS.MoveFirst
'            Do
'
'                ID = Val(RS.fields(strFireCompID).Value & "")
'
'                If ID = 0 Then
'                    If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "rfcn" & RS.fields("fc").Value, RS.fields("fc").Value, "room") Then
'                        nRoom.ForeColor = lngRed
'                    Else
'                    End If
'                Else
'                    If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "rfcm" & ID, RS.fields("fc").Value, "room") Then
'                    Else
'                    End If
'                End If
'
'                RS.MoveNext
'            Loop Until RS.EOF
'
'        End If
'
'        tvWise.Visible = True
'
'        RS.Close
'        Set RS = Nothing
'
'        cnsim.Close
'        Set cnsim = Nothing
'
'        Exit Sub
    
    
    ElseIf left(nd.KEY, 4) = "rlvl" Then
    
    
        Set cnsim = New ADODB.Connection
        
        
        Set RS = New ADODB.Recordset
        
        cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
        
       
        Set RS = New ADODB.Recordset
        
        strSQL = "select simID, kks from view_i_Space "
        strSQL = strSQL & "where simID in (" & nd.Tag & ") "
        strSQL = strSQL & "order by kks"
        
        RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
        
        tvWise.Visible = False
        
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "room" & RS.fields("simID").Value, RS.fields("kks").Value, "room") Then
                Else
                End If
                RS.MoveNext
            Loop Until RS.EOF
        
        End If
        
        tvWise.Visible = True
        
        RS.Close
        Set RS = Nothing
        
        cnsim.Close
        Set cnsim = Nothing
        
        Exit Sub
        
        
    ElseIf left(nd.KEY, 4) = "cncf" Then ' concrete folder
    
        projID = Val(Replace(nd.KEY, "cncf", ""))
        
        strguids = getDocGuids(cnpw, projID)
        
        If Len(strguids) > 0 Then
            Set cnsim = New ADODB.Connection
            
            Set RS = New ADODB.Recordset
            
            cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
            
            Set RS = New ADODB.Recordset
            
            strSQL = "select simID, codelevel from view_i_Concrete_level "
            strSQL = strSQL & "where pwdocID in (" & strguids & ") "
            strSQL = strSQL & "order by codelevel"
            
            RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
            
            tvWise.Visible = False
            
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                
                    If Not IsNull(RS.fields("codelevel").Value) Then
                        If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "clvl" & RS.fields("codelevel").Value, RS.fields("codelevel").Value, "room_level") Then
                            Call addTreeNode(tvWise, ndPlus, nRoom.KEY, tvwChild, nRoom.KEY & "+", "", "")
                            nRoom.Tag = CStr(Val(RS.fields("simID").Value & ""))
                        Else
                            nRoom.Tag = nRoom.Tag & "," & CStr(Val(RS.fields("simID").Value & ""))
                        End If
                    End If
                
                    RS.MoveNext
                Loop Until RS.EOF
            
            End If
            
            
            RS.Close
            Set RS = Nothing
            
            cnsim.Close
            Set cnsim = Nothing
        End If
        
        tvWise.Visible = True
        
        Exit Sub
    
    ElseIf left(nd.KEY, 4) = "clvl" Then
    
        Set cnsim = New ADODB.Connection
        
        
        Set RS = New ADODB.Recordset
        
        cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
        
       
        Set RS = New ADODB.Recordset
        
        strSQL = "select simID, StructCode from i_StructProp "
        strSQL = strSQL & "where simID in (" & nd.Tag & ") "
        strSQL = strSQL & "order by StructCode"
        
        RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
        
        tvWise.Visible = False
        
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, "cstr" & RS.fields("simID").Value, RS.fields("StructCode").Value, "room", , , True) Then
                Else
                End If
                RS.MoveNext
            Loop Until RS.EOF
        
        End If
        
        tvWise.Visible = True
        
        RS.Close
        Set RS = Nothing
        
        cnsim.Close
        Set cnsim = Nothing
        
        Exit Sub
    
    
    ElseIf left(nd.KEY, 4) = "nv00" Then
    
        projID = Val(Replace(nd.KEY, "nv00", ""))
        
        strguids = getDocGuids(cnpw, projID)
        
        If Len(strguids) = 0 Then Exit Sub
        
        Set cnsim = New ADODB.Connection
        
       
        
        Set RS = New ADODB.Recordset
        
        cnsim.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"
        
       
        Set RS = New ADODB.Recordset
        
        strSQL = "select ObjectName, count(*) as cnt from view_i_NW_Civil_Components_local "
        strSQL = strSQL & "where pwdocID in (" & strguids & ") "
        strSQL = strSQL & "group by ObjectName"
        
        RS.Open strSQL, cnsim, adOpenForwardOnly, adLockReadOnly
        
        tvWise.Visible = False
        
        If Not RS.EOF Then
            RS.MoveFirst
            Do
            
                Dim str As String
                str = RS.fields("ObjectName").Value & ""
                If Len(Trim(str)) = 0 Then str = "Unknown"
            
                If RS.fields("cnt").Value > 0 Then
                    If addTreeNode(tvWise, nRoom, nd.KEY, tvwChild, str & "|" & projID, str, "room_level") Then
'                        Call addTreeNode(tvWise, ndPlus, nRoom.Key, tvwChild, nRoom.Key & "+", "", "")
                    Else
                    End If
                    nRoom.Tag = "|"
                End If
            
                RS.MoveNext
            Loop Until RS.EOF
        
        End If
        
        tvWise.Visible = True
        
        RS.Close
        Set RS = Nothing
        
        cnsim.Close
        Set cnsim = Nothing
        
        Exit Sub
    
    ElseIf left(nd.KEY, 4) = "wise" Then
        projID = Val(Replace(nd.KEY, "wise", ""))
    Else
        Exit Sub
    End If
    
    
    
    

    strSQL = "select dms_proj.*, ods_class.classname as classname from dms_proj "
    strSQL = strSQL & "left outer join ods_class on dms_proj.o_classid = ods_class.classid "
    strSQL = strSQL & "where o_parentno = " & projID & " order by o_projectname"
    

    'strSQL = "select * from view_wise "
    'strSQL = strSQL & "where o_parentno = " & projID & " order by o_projectname"
    
    RS.Open strSQL, cnpw, adOpenForwardOnly, adLockReadOnly


    If Not RS.EOF Then
        RS.MoveFirst
        Do
            
'            Dim r As New RegExp
'            Dim strExpr As Variant
'            Dim strTest As String
'            strTest = getFieldStringValue(RS, "pth", "")
'            Dim bOk As Boolean
'            Dim A As Integer
'
'            bOk = False
'            For Each strExpr In pwset.regexps
'                r.Pattern = strExpr
'                If r.Test(strTest) Then
'                    bOk = True
'                    Exit For
'                End If
'            Next
'
'            If bOk Then
            
                If addTreeNode(tvWise, ndNew, "wise" & projID, tvwChild, "wise" & RS![o_projectno], RS![o_projectname], "folder") Then
                
                    ndNew.Tag = Val(ndNew.parent.Tag) + 1 ' tree level
                    
                    If InStr(1, RS.fields("classname").Value & "", "building", vbTextCompare) > 0 Then
                        ndNew.Image = "building"
                    End If
                    
                    If InStr(1, RS.fields("classname").Value & "", "island", vbTextCompare) > 0 Then
                        ndNew.Image = "island"
                    End If
                    
                    If InStr(1, RS.fields("classname").Value & "", "unit", vbTextCompare) > 0 Then
                        ndNew.Image = "block"
                    End If
                    
                    ndNew.Expanded = isWiseNodeExpanded(ndNew.KEY)
                    
                    If RS![o_subprojects] = "Y" Then
                    
                        If ndNew.Expanded Then
                            loadTreeNodeWise ndNew
                        Else
                            Call addTreeNode(tvWise, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                        End If
                    
                    End If
                    
                End If
            
'            End If
            
            
            RS.MoveNext
        Loop Until RS.EOF
    End If


    RS.Close
    
    Set RS = Nothing

    cnpw.Close
    
    Set cnpw = Nothing
    
    If nd.Image = "building" Then
        Dim ndRooms As Node
        
        Call addTreeNode(tvWise, ndNew, nd.KEY, tvwChild, "simf" & projID, "AECOsim", "room_folder")
        
        
                
        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "rmsf" & projID, "Rooms", "room_folder")
        Call addTreeNode(tvWise, ndPlus, ndRooms.KEY, tvwChild, ndRooms.KEY & "+", "", "")
                
        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "rfcf" & projID, "Fire", "room_folder")
'        Call addTreeNode(tvWise, ndPlus, ndRooms.KEY, tvwChild, ndRooms.KEY & "+", "", "")

        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "embf" & projID, "Parts", "room_folder")

        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "cncf" & projID, "Concrete", "room_folder")
        Call addTreeNode(tvWise, ndPlus, ndRooms.KEY, tvwChild, ndRooms.KEY & "+", "", "")

        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "stef" & projID, "Steel", "room_folder")
        Call addTreeNode(tvWise, ndPlus, ndRooms.KEY, tvwChild, ndRooms.KEY & "+", "", "")

        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwChild, "drsf" & projID, "Doors", "room_folder")

        
        Call addTreeNode(tvWise, ndRooms, ndNew.KEY, tvwNext, "nv00" & projID, "Navis", "room_folder")
        Call addTreeNode(tvWise, ndPlus, ndRooms.KEY, tvwChild, ndRooms.KEY & "+", "", "")
        

'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv-1" & projID, "Architecture", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv-2" & projID, "Concrete Structures", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv-3" & projID, "Steel Structures", "room_folder")

'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv01" & projID, "Brick Wall", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv02" & projID, "Building External Outline", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv03" & projID, "Concrete Beam", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv04" & projID, "Concrete Column", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv05" & projID, "Concrete Mass Fill", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv06" & projID, "Concrete Slab", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv07" & projID, "Concrete Slabs", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv08" & projID, "Concrete Stair", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv09" & projID, "Concrete Wall", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv10" & projID, "Curtain Wall", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv11" & projID, "Door", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv12" & projID, "Embedded part", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv13" & projID, "Escape Route", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv14" & projID, "Finishing Floor", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv15" & projID, "Footing Concrete", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv16" & projID, "Insulation", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv17" & projID, "Ladder", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv18" & projID, "Louver", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv19" & projID, "Multilayer Panel", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv20" & projID, "Plumbing Fixtures", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv21" & projID, "Railing", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv22" & projID, "Roof", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv23" & projID, "Room", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv24" & projID, "Space Reservation", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv25" & projID, "Steel Beam", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv26" & projID, "Steel Column", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv27" & projID, "Steel Flooring", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv28" & projID, "Steel Liner", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv29" & projID, "Steel Plate", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv30" & projID, "Steel Platform", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv31" & projID, "Steel Stair", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv32" & projID, "Toilet Compartment", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv33" & projID, "Waterproof", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv34" & projID, "Waterstop", "room_folder")
'        Call addTreeNode(tvWise, ndRooms, ndNew.Key, tvwChild, "nv35" & projID, "Window", "room_folder")
        
        Dim ndTest As Node
'        Call addTreeNode(tvWise, ndTest, nd.Key, tvwChild, "iTest" & projID, "ez_Test", "room_folder")

        Dim nodeName
        If Not Config.Nodes Is Nothing Then
            For Each nodeName In Config.Nodes.Keys
                Call addTreeNode(tvWise, ndRooms, ndTest.KEY, tvwChild, CStr(nodeName) & projID, CStr(nodeName), "room_folder")
            Next
        End If
    End If
    
Exit Sub

loadTreeNodeWise_ERR:
    Set RS = Nothing
    Set cnpw = Nothing
    tvWise.Visible = True
    F1.SB.Panels("status").text = "loadTreeNodeWise" & "() - " & err.Description
    Resume

End Sub




'/******************************************************************************
Public Sub loadCatsTreeNode(nd As Node, Optional bLoadExpandSettings As Boolean = True)
'/******************************************************************************

    On Error GoTo loadTreeNode_ERR
    
    Dim RS As New ADODB.Recordset
    
    Dim objID As Long
    Dim objectID As Long
    Dim ndNew As Node
    Dim ndPlus As Node
    Dim sBldName As String
    Dim sPwPrj As String
    Dim sPwBlockObjName As String
    Dim strSQL As String
    Dim ar() As String
    Dim i As Integer
    
    Dim cnpw As ADODB.Connection
    Dim pws As clsDBCon
    Dim iSub As pwbldsub
    iSub = pwbldsubNon
    
    If Not getNodeIds(nd, objID, objectID, False, iSub) Then Exit Sub
    
    
    If objID = objs("project") Then
    
        RS.Open "select * from view_block where projectID = " & objectID & " and deleted = 0 order by blockNumber", cn_data, adOpenForwardOnly, adLockReadOnly
    
    
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                sPwPrj = getFieldStringValue(RS, "pwPrjName", "")
                
                If Len(sPwPrj) > 0 Then
                    sPwBlockObjName = "pwblock"
                Else
                    sPwBlockObjName = "block"
                End If
                
                If addTreeNode(tvCats, ndNew, "project" & RS![projectID], tvwChild, sPwBlockObjName & RS![blockID], getBloackName(RS![blockNumber]), "block") Then
                
                    ndNew.Tag = sPwBlockObjName & "|" & _
                                sPwPrj & "|" & _
                                RS![blockNumber] & "|" & _
                                getFieldStringValue(RS, "projectPath", "") & "|" & _
                                getFieldStringValue(RS, "projectDSTable", "")
                    
                    If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                    
                    If ndNew.Expanded Then
                        loadCatsTreeNode ndNew
                    Else
                        Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                    End If
                    
                End If
                RS.MoveNext
            Loop Until RS.EOF
            
        End If
    
        RS.Close
        
'        If Len(sPwPrj) > 0 Then
'            ' Типовые альбомы
'
'            If addTreeNode(tvCats, ndNew, "project" & objectID, tvwChild, "pwuni" & objectID, "Типовые альбомы", "pwset") Then
'
'                ndNew.Tag = "pwuni"
'
'                If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
'
'                If ndNew.Expanded Then
'                    loadCatsTreeNode ndNew
'                Else
'                    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
'                End If
'
'            End If
'
'        End If
        
        
    End If
    
    
    Dim strSQLdop As String
    strSQLdop = ""
    If mnuViewCatsStat(pst.pstRazrabotka).Checked = False Then strSQLdop = strSQLdop & " and catStatus != " & pst.pstRazrabotka
    If mnuViewCatsStat(pst.pstProvereno).Checked = False Then strSQLdop = strSQLdop & " and catStatus != " & pst.pstProvereno
    If mnuViewCatsStat(pst.pstArchive).Checked = False Then strSQLdop = strSQLdop & " and catStatus != " & pst.pstArchive
    If mnuViewCatsStat(pst.pstUstar).Checked = False Then strSQLdop = strSQLdop & " and catStatus != " & pst.pstUstar
    
    '===================
    
    If objID = objs("pwblock") Then
    
        ar = Split(nd.Tag, "|")
        
        
        If UBound(ar) = 4 Then
        
            strSQL = "select * from getBuildingData(0) where prjName = '" & ar(1) & "' and unitNum = '" & ar(2) & "'"
            
            For i = 1 To pwsets.Count
                If Len(pwsets(i).text) > 0 And pwsets(i).text = ar(3) Then
                    Set pws = pwsets(i)
                    Exit For
                End If
            Next i
            
            If Not pws Is Nothing Then
            
                Set cnpw = New ADODB.Connection
            
                cnpw.Open pws.constring, pws.login, pws.login
                
                RS.Open strSQL, cnpw, adOpenForwardOnly, adLockReadOnly
                
                If Not RS.EOF Then
                    RS.MoveFirst
                    Do
                    
                        Dim strNodeText As String
                        Dim strNodeTextAdd As String
                        Dim catcnt As Integer
                        
                        strNodeText = RS![unitNum] & RS![bldNum] & RS![bldCode]
                        strNodeTextAdd = getFieldStringValue(RS, "bldName", "")
                        If Len(Trim(strNodeTextAdd)) > 0 Then
                            If Len(strNodeTextAdd) > 30 Then strNodeTextAdd = left(strNodeTextAdd, 30) & "..."
                            strNodeText = strNodeText & " - " & strNodeTextAdd
                        End If
                        
                        'catcnt = getFieldLongValue(RS, "catcnt", 1) ' нет такого

                    
                        If addTreeNode(tvCats, ndNew, nd.KEY, tvwChild, "pwbld" & RS![bldID], strNodeText, "building") Then

                            ndNew.Tag = "pwbld|" & RS![bldID] & "|" & ar(4) & "|" & ar(3) ' id, docset view name, pwset name
                            
                            If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                            
                            If ndNew.Expanded Then
                                loadCatsTreeNode ndNew
                                'If ndNew.children = 0 And catcnt > 0 Then
                                '    ndNew.Expanded = False
                                '    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                                'End If
                            Else
                                'If catcnt > 0 Then
                                    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                                'End If
                            End If
                            
        '                    ndNew.Sorted = True
                        End If
                            
                    
                    
                        RS.MoveNext
                    Loop Until RS.EOF
                End If
                
                RS.Close
                Set RS = Nothing
                
                cnpw.Close
                Set cnpw = Nothing
                
            End If
            
            
        Else
            ' error
        End If
    
    
    End If
    
    
    If objID = objs("pwbld") Then
    
        Dim ndd As Node
        
        If iSub = pwbldsubNon Then
            Set ndd = nd
            
            ' add 3 pwbldsub...
            
            Dim modID As Long
            ' get Model folder ID ...
            
            ar = Split(nd.Tag, "|")
            
            
            If UBound(ar) = 3 Then
                
                
                strSQL = "select * from view_wise_model where [o_parentno] = " & objectID
                
                For i = 1 To pwsets.Count
                    If Len(pwsets(i).text) > 0 And pwsets(i).text = ar(3) Then
                        Set pws = pwsets(i)
                        Exit For
                    End If
                Next i
                
                If Not pws Is Nothing Then
                
                    Set cnpw = New ADODB.Connection
                
                    cnpw.Open pws.constring, pws.login, pws.login
                    
                    modID = selectLongFromBase(cnpw, "view_wise_model", "o_projectno", "o_parentno", objectID)
                    
                    cnpw.Close
                    Set cnpw = Nothing
                    
                End If
            
            End If
            
            
            If addTreeNode(tvCats, ndNew, "pwbld" & objectID, tvwChild, "pwset" & objectID, "Документация", "pwset") Then

                ndNew.Tag = "pwset"
                
                If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                
                If ndNew.Expanded Then
                    loadCatsTreeNode ndNew
                Else
                    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                End If
                
            End If
            
            If addTreeNode(tvCats, ndNew, "pwbld" & objectID, tvwChild, "pwcat" & objectID, "Изделия", "pwcat") Then

                ndNew.Tag = "pwcat"
                
                If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                
                If ndNew.Expanded Then
                    loadCatsTreeNode ndNew
                Else
                    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                End If
                
            End If
            
            If addTreeNode(tvCats, ndNew, "pwbld" & objectID, tvwChild, "pwmod" & modID, "Модель", "pwmod") Then

                ndNew.Tag = "pwmod"
                
                If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                
                If ndNew.Expanded Then
                    loadCatsTreeNode ndNew
                Else
                    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                End If
                
            End If
            
        ElseIf iSub = pwbldsubCat Then
        
            ' Set ndd = nd.parent
            
            ' add catalogs... see below
            
        ElseIf iSub = pwbldsubSet Then
        
            Set ndd = nd.parent
            
            ' add docsets...
            
            ar = Split(ndd.Tag, "|")
            
            Dim sTable As String
            Dim sBldID As String
            Dim spwset As String
            
            
            If UBound(ar) = 3 Then
            
                sBldID = ar(1)
                sTable = ar(2)
                spwset = ar(3)
                
                strSQL = "select * from view_object_catalog_pw where objectID = '" & sBldID & "' and (deleted is null or deleted = 0)"
                ' order by time?
                
                
                RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
                            
                Call loadCatsTreeCatalogPW(RS, True, iSub)
            
                RS.Close
                
                
            Else
                ' error
            End If
            
            
        ElseIf iSub = pwbldsubMod Then
        
            Set ndd = nd.parent
            
            ' add pw model folders...
            
            ' add catalogs... see below
            
        End If
    
    
    
    End If
    
    
    
    
    
    If objID = objs("project") Or objID = objs("block") Then
    
        strSQL = "select *"
        strSQL = strSQL & ",(select count(*) from view_object_catalog voc1 where voc1.objID=" & objs("building") & " and voc1.deleted=0 and voc1.objectID = voc2.buildingID " & strSQLdop & ") as catcnt"
        strSQL = strSQL & " from view_object_building voc2 where voc2.objID = " & objID
        strSQL = strSQL & " and voc2.objectID = " & objectID
        strSQL = strSQL & " and voc2.deleted = 0 order by voc2.buildingCode"
    
        RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
        
'        RS.Open "select * from view_object_building where objID = " & objID & _
'                    " and objectID = " & objectID & _
'                    " and deleted = 0 order by buildingCode", _
'                    cn_data, adOpenForwardOnly, adLockReadOnly
    
        Dim obj As clsObj
    
        If Not RS.EOF Then
            RS.MoveFirst
            Do
    
                Set obj = globObjs(CStr(RS![objID]))
    
                If addTreeNode(tvCats, ndNew, obj.objname & RS![objectID], tvwChild, "building" & RS![buildingID], RS![buildingCode], "building") Then
                    sBldName = RS![buildingName] & ""
                    If Len(sBldName) > 30 Then sBldName = left(sBldName, 30) & "..."
                    If Len(sBldName) > 0 Then ndNew.text = ndNew.text & " - " & sBldName
                    ndNew.Tag = "building|" & RS![cbldID] ' разделитель "|", ID нужен здесь чтобы потом отсеивать имеющиеся здания при добавлении
                    
                    If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                    
                    If ndNew.Expanded Then
                        loadCatsTreeNode ndNew
                        If ndNew.children = 0 And RS.fields("catcnt").Value > 0 Then
                            ndNew.Expanded = False
                            Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                        End If
                    Else
                        If RS.fields("catcnt").Value > 0 Then Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                    End If
                    
'                    ndNew.Sorted = True
                End If
                RS.MoveNext
            Loop Until RS.EOF
        End If
    
        RS.Close
        
    End If
        
    '===================
    
    If objID = objs("project") _
        Or objID = objs("block") _
        Or objID = objs("building") _
        Or (objID = objs("pwbld") And iSub = pwbldsubCat) _
        Or objID = objs("catalog") Then
        
       
        strSQL = "select *"
        strSQL = strSQL & ",(select COUNT(*) from view_object_catalog voc1 where voc1.objID = " & objs("catalog") & " and voc1.deleted = 0 and voc1.objectID = voc2.catid) as catcnt"
        strSQL = strSQL & ",(select COUNT(*) from catlist where catlist.catid = voc2.catid and catlist.deleted=0) as lstcnt"
        strSQL = strSQL & " from view_object_catalog voc2 where objID = " & objID
        strSQL = strSQL & " and objectID = " & objectID
        strSQL = strSQL & " and deleted = 0"
        strSQL = strSQL & strSQLdop
        
        RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
                    
'        RS.Open "select * from view_object_catalog where objID = " & objID & _
'                    " and objectID = " & objectID & _
'                    " and deleted = 0", _
'                    cn_data, adOpenForwardOnly, adLockReadOnly
    
'      ,(select COUNT(*) from [view_object_catalog] voc1 where voc1.objID=7 and voc1.deleted = 0 and voc1.objectID = voc2.catID) as catcnt
'      ,(select COUNT(*) from catlist where catlist.catid = voc2.catid and catlist.deleted=0) as lstcnt
    
        Call loadCatsTreeCatalog2(RS, iSub)
    
        RS.Close
        
    End If
        
    '===================
    
    If objID = objs("pwbld") And iSub = pwbldsubMod Or objID = objs("pwfolder") Then
    
    
        If objID = objs("pwfolder") Then
            ar = Split(nd.Tag, "|")
        Else
            ar = Split(ndd.Tag, "|")
        End If
    

    
        'Dim pws As clsDBCon

        For i = 1 To pwsets.Count
            If Len(pwsets(i).text) > 0 And pwsets(i).text = ar(3) Then
                Set pws = pwsets(i)
                Exit For
            End If
        Next i
        
        If Not pws Is Nothing Then
        
            Set cnpw = New ADODB.Connection
        
            cnpw.Open pws.constring, pws.login, pws.login
            
            strSQL = "select * from view_wise where o_parentno = " & objectID
            
            RS.Open strSQL, cnpw, adOpenForwardOnly, adLockReadOnly
            
            If Not RS.EOF Then
                RS.MoveFirst
                Do
                    If addTreeNode(tvCats, ndNew, nd.KEY, tvwChild, "pwfolder" & RS![o_projectno], RS![o_projectname], "pwfld") Then

                        ndNew.Tag = "pwfolder|" & RS![o_projectno] & "|" & "|" & ar(3)  ' id, docset view name, pwset name
                        
                        If bLoadExpandSettings Then ndNew.Expanded = isCatNodeExpanded(ndNew.KEY)
                        
                        If ndNew.Expanded Then
                            loadCatsTreeNode ndNew
                            'If ndNew.children = 0 And catcnt > 0 Then
                            '    ndNew.Expanded = False
                            '    Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                            'End If
                        Else
                            'If catcnt > 0 Then
                                Call addTreeNode(tvCats, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                            'End If
                        End If
                        
    '                    ndNew.Sorted = True
                    End If
                        
                
                
                    RS.MoveNext
                Loop Until RS.EOF
            End If
            
            RS.Close
            Set RS = Nothing
            
            cnpw.Close
            Set cnpw = Nothing
            
        End If

    
    
    End If
    
    '===================
        
    If objID = objs("catalog") Then
    
        RS.Open "select * from view_r_catlist_catalog where catID = " & objectID & _
                    " and deleted = 0", _
                    cn_data, adOpenForwardOnly, adLockReadOnly
    
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                If addTreeNode(tvCats, ndNew, "catalog" & RS![catID], tvwChild, "catlist" & RS![catListID], RS![catlistName], "catlist") Then
                    If Not IsNull(RS.fields("catDefID").Value) And RS.fields("catID").Value = RS.fields("catDefID").Value Then ndNew.Image = "catlist_def"
                    If RS.fields("clPassive").Value Then ndNew.bOld = True
                    ndNew.Tag = "catlist"
                    ndNew.Expanded = False
                End If
                RS.MoveNext
            Loop Until RS.EOF
        End If
    
        RS.Close
    End If
    
    
    
    
    

    Set RS = Nothing

Exit Sub

loadTreeNode_ERR:
    Set RS = Nothing
    Me.SB.Panels("status").text = err.Description

End Sub




'/******************************************************************************
Private Sub tvCats_Expand(ByVal nd As MSComctlLib.Node)
'/******************************************************************************

    On Error GoTo tvCats_Expand_ERR


    If right(nd.Child.KEY, 1) = "+" Then
        tvCats.Visible = False
        tvCats.Nodes.Remove nd.Child.KEY
        loadCatsTreeNode nd
        tvCats.Visible = True
    End If

Exit Sub

tvCats_Expand_ERR:
    tvCats.Visible = True
    Me.SB.Panels("status").text = err.Description

End Sub

'/******************************************************************************
Public Sub saveWiseTreeSets()
'/******************************************************************************

    On Error GoTo saveWiseTreeSets_ERR

    Dim i As Long

    Dim str As String
    str = ""
    
    For i = 1 To tvWise.Nodes.Count
        If tvWise.Nodes(i).Expanded Then
            str = str & tvWise.Nodes(i).KEY & ":1|"
        Else
            str = str & tvWise.Nodes(i).KEY & ":0|"
        End If
    Next i
    SaveSetting "Offtake2", "WiseTree2", "all", str


Exit Sub

saveWiseTreeSets_ERR:

End Sub


'/******************************************************************************
Public Sub saveCatTreeSets()
'/******************************************************************************

    On Error GoTo saveCatTreeSets_ERR
    Dim i As Long

    Dim str As String
    str = ""
    
    For i = 1 To tvCats.Nodes.Count
        If tvCats.Nodes(i).Expanded Then
            str = str & tvCats.Nodes(i).KEY & ":1|"
        Else
            str = str & tvCats.Nodes(i).KEY & ":0|"
        End If
    Next i
    SaveSetting "Offtake2", "CatsTree2", "all", str


Exit Sub

saveCatTreeSets_ERR:

End Sub

'/******************************************************************************
Public Sub tvCatsTreeUpdateExpanded()
'/******************************************************************************

    On Error GoTo tvCatsTreeUpdateExpanded_ERR
    
    Dim i As Long
    
    Set colCatTreeSet = New Collection
    
    For i = 1 To F1.tvCats.Nodes.Count
        colCatTreeSet.Add tvCats.Nodes(i).Expanded, tvCats.Nodes(i).KEY
    Next i
    

Exit Sub

tvCatsTreeUpdateExpanded_ERR:

End Sub



'/******************************************************************************
Private Sub fgPositions_DragDrop(source As Control, X As Single, Y As Single)
'/******************************************************************************

    On Error GoTo fgPositions_DragDrop_ERR


    Dim posID As Long
    Dim partID As Long
    Dim partName As String
    Dim objID As Long
    Dim pos As clsPos
    Dim bUpd As Boolean


    If source.Name = "tvParts" Then
        
        Dim t As TreeView
        Dim n As Node
        
        Set t = source
        Set n = t.SelectedItem
        
        If n Is Nothing Then Exit Sub
        
        If LCase(left(n.KEY, Len("part"))) = "part" Then
            partID = Val(right(n.KEY, Len(n.KEY) - Len("part")))
            partName = selectStringFromBase(cn_data, "part", "partName", "partID", partID)
            objID = objs("part")
        Else
            Exit Sub
        End If

    Else
        Exit Sub
    End If
    
    
    If partID = curPart.partID Then
        MsgBox "Для добавления изделия как позиции нужно выбрать другое изделие" & vbNewLine & "(Изделие нельзя добавлять само в себя)"
        Exit Sub
    End If


    Dim r As Long
    r = fgPositions.MouseRow

    If fgPositions.RowHeight(fgPositions.MouseRow) = 480 Then
        
        posID = Val(fgPositions.TextMatrix(fgPositions.MouseRow, 4))
        
        If posID = 0 And fgPositions.MouseRow = fgPositions.Rows - 1 Then ' last row
            Set pos = New clsPos
            Set pos.parentPart = curPart
        Else
'            Set pos = curPart.ps(CStr(posID))
            Exit Sub
        End If
        
    Else
        Exit Sub
    End If
    
    
    pos.posPrtName = partName
    pos.posPrtCatID = 0 '...
    pos.fgRowToEdit = r
    
    pos.setSrtm -partID, True, False

    
    
            
    Dim np As New clsPos
    np.fgAddEmptyRow
        
    pos.updatePosRow r, bUpd, True, True, False, True
    
    Set tvParts.SelectedItem = tvParts.Nodes("part" & curPart.partID)

Exit Sub

fgPositions_DragDrop_ERR:
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgPositions_DragDrop - Error"

End Sub

Private Sub fgPositions_DragOver(source As Control, X As Single, Y As Single, State As Integer)

'    Debug.Print fgPositions.MouseRow
'    fgPositions.Select fgPositions.MouseRow, 1

End Sub


'/******************************************************************************
Private Function fgCatsAddListSpec(clID As Long, ByRef bListExist As Boolean) As Boolean
'/******************************************************************************
    
    On Error GoTo fgCatsAddListOfft_ERR
    
    Dim RS As New ADODB.Recordset
    
    Me.fgCatSpec.Rows = 1
'    Me.fgCatSpec.cols = 6

    Dim cnt As Integer
    
   
'    Me.fgCatSpec.ColHidden(0) = False
'    Me.fgCatSpec.ColHidden(1) = False
'    Me.fgCatSpec.ColHidden(2) = False
'    Me.fgCatSpec.ColHidden(3) = False
'    Me.fgCatSpec.ColHidden(4) = False
'    Me.fgCatSpec.ColHidden(5) = False
    
    Me.fgCatSpec.ColAlignment(0) = flexAlignLeftCenter
    Me.fgCatSpec.ColAlignment(1) = flexAlignLeftCenter
    Me.fgCatSpec.ColAlignment(2) = flexAlignLeftCenter
    Me.fgCatSpec.ColAlignment(3) = flexAlignLeftCenter
    Me.fgCatSpec.ColAlignment(4) = flexAlignLeftCenter
    Me.fgCatSpec.ColAlignment(5) = flexAlignLeftCenter
    
    Me.fgCatSpec.TextMatrix(0, 0) = "N поз."
    Me.fgCatSpec.TextMatrix(0, 1) = "Наименование"
    Me.fgCatSpec.TextMatrix(0, 2) = "Кол-во"
    Me.fgCatSpec.TextMatrix(0, 3) = "Ед.масса"
    Me.fgCatSpec.TextMatrix(0, 4) = "Общ.масса"
    Me.fgCatSpec.TextMatrix(0, 5) = ""
    
    RS.Open "select * from spectable where catlistID = " & clID & " order by posNumber", cn_data, adOpenStatic, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            fgCatSpec.AddItem RS.fields("posNumber").Value & vbTab & _
                            RS.fields("stText").Value & vbTab & _
                            RS.fields("stQty").Value & vbTab & _
                            Format(RS.fields("stUmass").Value, "0.0") & vbTab & _
                            Format(RS.fields("stCmass").Value, "0.0") & vbTab
            RS.MoveNext
        Loop Until RS.EOF
        
    End If
    
    RS.Close
    Set RS = Nothing
    
    If fgCatSpec.Rows = 1 Then Exit Function
    
    
    fgCatSpec.Subtotal flexSTSum, -1, 4, "0.0", lngGrey, , True, "Всего"
    
    fgCatSpec.AutoSize 0, fgCatSpec.cols - 1
    
    Exit Function
    
fgCatsAddListOfft_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatsAddListOfft - Error"
    
End Function


'/******************************************************************************
Public Function setCatlistDefault(catIDfrom As Long, catIDnew As Long)
'/******************************************************************************

    On Error GoTo setCatlistDefault_ERR


    Dim cldefID As Long
    cldefID = selectLongFromBase(cn_data, "i_catalog", "catlistID", "catID", catIDfrom)
    If catIDnew > 0 And cldefID > 0 Then
        Dim nnn As Node
        Dim RS As New ADODB.Recordset
        Dim RS2 As New ADODB.Recordset
        RS.Open "select * from catlist where catID = " & catIDfrom, cn_data, adOpenForwardOnly, adLockReadOnly
        RS2.Open "select * from catlist where catID = " & catIDnew, cn_data, adOpenForwardOnly, adLockReadOnly
        If Not RS.EOF And Not RS2.EOF Then
            RS.MoveFirst
            RS2.MoveFirst
            Do
                If RS.fields("catlistID").Value = cldefID Then
                    updateTableInBase cn_data, "i_catalog", "catlistID", RS2.fields("catlistID").Value, "catID", catIDnew
                    Set nnn = tvGetTreeNode(tvCats, "catlist" & RS2.fields("catlistID").Value)
                    If Not nnn Is Nothing Then
                        nnn.Image = "catlist_def"
                    End If
                End If
                RS.MoveNext
                RS2.MoveNext
            Loop Until RS.EOF Or RS2.EOF
        End If
        RS.Close
        RS2.Close
        Set RS = Nothing
        Set RS2 = Nothing
    End If


Exit Function

setCatlistDefault_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "setCatlistDefault - Error"

End Function

'/******************************************************************************
Private Function fgCatsAddPartsModel(catID As Long) As Boolean
'/******************************************************************************

    On Error GoTo fgCatsAddPartsModel_ERR

    
    Me.fgPartsModel.Rows = 1

    Dim cnt As Integer
    
    Dim ar() As String
    
   
'    Me.fgPartsModel.ColHidden(0) = True
'    Me.fgPartsModel.ColHidden(1) = True
'    Me.fgPartsModel.ColHidden(3) = True ' резерв
'    Me.fgPartsModel.ColHidden(4) = True ' резерв
    
'    Me.fgPartsModel.ColDataType(3) = flexDTBoolean
    
    Me.fgPartsModel.TextMatrix(0, 0) = ""
    Me.fgPartsModel.TextMatrix(0, 1) = ""
    Me.fgPartsModel.TextMatrix(0, 2) = ""
    Me.fgPartsModel.TextMatrix(0, 3) = ""
    Me.fgPartsModel.TextMatrix(0, 4) = ""
    Me.fgPartsModel.TextMatrix(0, 5) = ""
    
    
    Dim cnfc As New ADODB.Connection
    cnfc.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=so2user;Initial Catalog=" & strCurSimBase & ";Data Source=" & conn.strServerName, "so2user", "so2user"

    
    
    
    
    
    
    Dim RS As New ADODB.Recordset
    Dim strSQL As String
    
    strSQL = "SELECT * from [view_file_model_cells] where catid = " & catID



    RS.Open strSQL, cnfc, adOpenStatic, adLockReadOnly
    
    
    Set fgPartsModel.DataSource = RS
    
    Dim i As Integer
    For i = 0 To fgPartsModel.cols - 1
        If LCase(right(fgPartsModel.ColKey(i), 2)) = "id" Then fgPartsModel.ColHidden(i) = True
    Next i
    
'    If Not RS.EOF Then
'        RS.MoveFirst
'        Do
'
'            ar = Split(RS.fields("").Value, "\")
'
'            fgPartsModel.AddItem RS.fields("").Value & vbTab & _
'                                RS.fields("").Value & vbTab & _
'                                RS.fields("").Value & vbTab & _
'                                ar(UBound(ar))
'
'            If Dir(RS.fields("").Value) = "" Then
'                fgPartsModel.Cell(flexcpForeColor, Me.fgCatFiles.Rows - 1, 2) = lngRed
'            End If
'
'            RS.MoveNext
'        Loop Until RS.EOF
'
'    End If
    
    RS.Close
    Set RS = Nothing
    
    cnfc.Close
    Set cnfc = Nothing
    
    
    If fgCatFiles.Rows = 1 Then Exit Function
    
    fgCatFiles.AutoSize 0, fgCatFiles.cols - 1



Exit Function

fgCatsAddPartsModel_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbCritical, "fgCatsAddPartsModel - Error"

End Function

'/******************************************************************************
Private Function fgCatsAddFiles(catID As Long) As Boolean ' not using
'/******************************************************************************

    On Error GoTo fgCatsAddFiles_ERR



    Dim RS As New ADODB.Recordset
    
    Me.fgCatFiles.Rows = 1

    Dim cnt As Integer
    
    Dim ar() As String
    
   
    Me.fgCatFiles.ColHidden(0) = True
'    Me.fgCatFiles.ColHidden(1) = True
    Me.fgCatFiles.ColHidden(3) = True ' резерв
    Me.fgCatFiles.ColHidden(4) = True ' резерв
    
'    Me.fgCatFiles.ColDataType(3) = flexDTBoolean
    
    Me.fgCatFiles.TextMatrix(0, 0) = ""
    Me.fgCatFiles.TextMatrix(0, 1) = ""
    Me.fgCatFiles.TextMatrix(0, 2) = ""
    Me.fgCatFiles.TextMatrix(0, 3) = ""
    Me.fgCatFiles.TextMatrix(0, 4) = ""
    Me.fgCatFiles.TextMatrix(0, 5) = ""
    
    Dim strSQL As String
    
    strSQL = "SELECT "
    strSQL = strSQL & conn.strBaseName & ".dbo.filestable.* "
'    strSQL = strSQL & ",docs.dbo.r_cat_file.pfID as fex "
    strSQL = strSQL & "FROM "
    strSQL = strSQL & conn.strBaseName & ".dbo.filestable "
    
'    strSQL = strSQL & "LEFT OUTER JOIN "
'    strSQL = strSQL & "docs.dbo.r_cat_file "
'    strSQL = strSQL & "ON "
'    strSQL = strSQL & conn.strBaseName & ".dbo.filestable.fileFullPath "
'    strSQL = strSQL & "= "
'    strSQL = strSQL & "docs.dbo.r_cat_file.pfFullName "
'    strSQL = strSQL & "AND "
'    strSQL = strSQL & "docs.dbo.r_cat_file.partDB "
'    strSQL = strSQL & "= "
'    strSQL = strSQL & "'" & conn.strBaseName & "' " '        strSQL = strSQL & "'" & "PARTS" & "' "
    
    strSQL = strSQL & "WHERE "
    
    strSQL = strSQL & conn.strBaseName & ".dbo.filestable.catID = " & catID & " "
    
    strSQL = strSQL & "ORDER BY " & conn.strBaseName & ".dbo.filestable.fileFullPath "
    
    
'    RS.Open "select * from filestable where catID = " & catID & " order by fileFullPath", cn_data, adOpenStatic, adLockReadOnly
    RS.Open strSQL, cn_data, adOpenStatic, adLockReadOnly
    
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
        
            ar = Split(RS.fields("fileFullPath").Value, "\")
        
            fgCatFiles.AddItem RS.fields("fileID").Value & vbTab & _
                                RS.fields("fileFullPath").Value & vbTab & _
                                RS.fields("fileDescr").Value & vbTab & _
                                ar(UBound(ar))

            If Dir(RS.fields("fileFullPath").Value) = "" Then
                fgCatFiles.Cell(flexcpForeColor, Me.fgCatFiles.Rows - 1, 2) = lngRed
            End If
        
            RS.MoveNext
        Loop Until RS.EOF
        
    End If
    
    RS.Close
    Set RS = Nothing
    
    If fgCatFiles.Rows = 1 Then Exit Function
    
    fgCatFiles.AutoSize 0, fgCatFiles.cols - 1


Exit Function

fgCatsAddFiles_ERR:
    Set RS = Nothing
    Me.SB.Panels("status").text = err.Description

End Function


'/******************************************************************************
Public Sub saveDgnFiles(catID As Long)
'/******************************************************************************

    On Error GoTo saveDgnFiles_ERR
    
    If fgCatFiles.Rows = 1 Then Exit Sub

    Dim cnf As New ADODB.Connection
    cnf.Open "Provider=" & conn.strProvider & ".1;Persist Security Info=False;Timeout=5;User ID=" & conn.strUser & ";Initial Catalog=docs;Data Source=" & conn.strServerName, conn.strUser, conn.strPass

    Dim pfID As Long
    Dim cnt As Long

    Me.PB.Min = 1
    Me.PB.Max = fgCatFiles.Rows - 1

    Dim i As Long
    For i = 1 To fgCatFiles.Rows - 1
        If uploadCatFile(cnf, fgCatFiles.TextMatrix(i, 1), catID, pfID) Then
            fgCatFiles.TextMatrix(i, 3) = pfID
            cnt = cnt + 1
        Else
        End If
        Me.PB.Value = i
        Me.PB.Refresh
    Next i


    
    Me.PB.Value = 1
    Me.PB.Refresh

    cnf.Close
    Set cnf = Nothing
    
    If cnt > 0 Then writeOperationS operModify, "catalog", catID, "сохранено в базу " & cnt & " файлов"

Exit Sub

saveDgnFiles_ERR:
    Set cnf = Nothing
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "saveDgnFiles - Error"

End Sub


'/******************************************************************************
Public Function uploadCatFile(cnf As ADODB.Connection, strFileName As String, catID As Long, ByRef pfID As Long) As Boolean
'/******************************************************************************

    On Error GoTo loadFile_ERR

    Dim ar() As String
    ar = Split(strFileName, ".")
    
    Dim strFile As String
    strFile = Trim(LCase(strFileName))
    
    If Len(strFile) = 0 Then Exit Function
    If Not FileExists(strFile) Then Exit Function
    
    Dim RS As New ADODB.Recordset
    RS.Open "Select * from r_cat_file where catID = " & catID & " and pfFullName = '" & strFile & "'", cnf, adOpenKeyset, adLockOptimistic
    
    If RS.EOF Then RS.AddNew Else RS.MoveFirst
    
    
    Dim mstream As New ADODB.Stream
    mstream.Type = adTypeBinary
    mstream.Open
    mstream.LoadFromFile strFile
    RS.fields("pfData").Value = mstream.Read
    RS.fields("pfExt").Value = UCase(ar(UBound(ar)))
    RS.fields("partDB").Value = conn.strBaseName
    RS.fields("pfFullName").Value = strFile
    RS.fields("catID").Value = catID
    RS.Update
    RS.Requery
    RS.MoveFirst
    pfID = RS.fields("pfID").Value
    
    RS.Close
    Set RS = Nothing

    uploadCatFile = True


Exit Function

loadFile_ERR:
    Set RS = Nothing
'    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadFile - Error"

End Function

'/******************************************************************************
Private Sub fgCatOfft_AfterEdit(ByVal Row As Long, ByVal Col As Long)
'/******************************************************************************

    On Error GoTo fgCatOfft_AfterEdit_ERR



    Dim catID As Long
    
    catID = Val(fgCatTree.Tag)
    
    If catID = 0 Then Exit Sub


    Dim ct As clsCat
    
    Set ct = cCats(CStr(catID))
    
    If (ct.iStatus = pstProvereno Or ct.iStatus = pstRazrabotka) And Col = 5 Then
        Dim offtID As Long
        offtID = Val(fgCatOfft.RowData(Row))
        
        Dim dval As Double
        dval = getDbl(fgCatOfft.TextMatrix(Row, 5))
        
        
        If offtID > 0 And dOfftVal <> dval Then
        
            If updateTableInBase(cn_data, "offtable", "mass", dval, "offtID", offtID) Then
                Call writeOperationS(operModify, "offtake", offtID, "изменение массы c " & dOfftVal & " на " & dval)
                
                Dim ich As Integer
                ich = selectLongFromBase(cn_data, "offtable", "changes", "offtID", offtID)
                ich = ich + 1
                Call updateTableInBase(cn_data, "offtable", "changes", ich, "offtID", offtID)
                
                fgCatOfft.Cell(flexcpBackColor, Row, Col) = lngGrey
            
            End If
        
        
        End If
        
    End If
    
    
    fgCatOfft.Subtotal flexSTSum, -1, 5, "0.0", lngGrey, , True, "Всего"




Exit Sub

fgCatOfft_AfterEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatOfft_AfterEdit - Error"

End Sub





'/******************************************************************************
Private Sub fgCatOfft_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
'/******************************************************************************

    On Error GoTo fgCatOfft_BeforeEdit_ERR


    Cancel = True

    Dim catID As Long
    
    catID = Val(fgCatTree.Tag)
    
    If catID = 0 Then Exit Sub


    Dim ct As clsCat
    
    Set ct = cCats(CStr(catID))
    
    If (ct.iStatus = pstProvereno Or ct.iStatus = pstRazrabotka) And Col = 5 Then
        Cancel = False
        dOfftVal = getDbl(fgCatOfft.TextMatrix(Row, Col))
    End If


 


Exit Sub

fgCatOfft_BeforeEdit_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "fgCatOfft_BeforeEdit - Error"

End Sub


'/******************************************************************************
Private Sub fgCatOfft_RowColChange()
'/******************************************************************************

    On Error GoTo fgCatOfft_RowColChange_ERR
    
    Dim ID As Long
    
    If fgCatOfft.Row <= 0 Then Exit Sub
    
    ID = Val(fgCatOfft.RowData(fgCatOfft.Row))
    
    
    If ID > 0 Then loadLog "offtake", ID


Exit Sub

fgCatOfft_RowColChange_ERR:

End Sub


'/******************************************************************************
Public Sub loadOfftakeBet(Optional bInclChildren As Boolean = False)
'/******************************************************************************

    On Error GoTo loadOfftakeBet_ERR

    Dim strSQL As String
    Dim strFuncName As String
    
'    strFuncName = "goOfftBet4"
    strFuncName = "goOfftBet5" ' добавили площадь опалубки бетона

'    strSQL = "SELECT lev, catdef, gamma, linear, class, width, sum(qty) as qty, srtmID, null as prim "
    strSQL = "SELECT lev, catdef, gamma, linear, class, width, sum(qty) as qty, sum(aqty) as area, srtmID, null as prim "
    strSQL = strSQL & "FROM " & conn.strBaseName & ".dbo." & strFuncName & "(" & lngCurCatListID
    
    strSQL = strSQL & "," & objs("catlist")
    
    strSQL = strSQL & ",1" ' количество 1
    
    If bInclChildren Then
        strSQL = strSQL & ",1"
    Else
        strSQL = strSQL & ",0"
    End If
    
    strSQL = strSQL & ") group by lev, catdef, gamma, linear, class, width, srtmID"
    
    
    Dim RS As New ADODB.Recordset
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    Set Me.fgOfftake.DataSource = RS
    
    RS.Close
    
    Set RS = Nothing
    
    iCurOfft = 2
    
    Me.fgOfftake.MergeCol(1) = True
    Me.fgOfftake.MergeCol(2) = True
    Me.fgOfftake.MergeCol(3) = True
    Me.fgOfftake.MergeCol(4) = True
    Me.fgOfftake.MergeCol(5) = True
'    Me.fgOfftake.MergeCol(6) = True

    Me.fgOfftake.ColHidden(fgOfftake.ColIndex("srtmID")) = True
    
    Me.fgOfftake.ColFormat(fgOfftake.ColIndex("qty")) = sFmt1
    Me.fgOfftake.ColFormat(fgOfftake.ColIndex("aqty")) = sFmt1
   
    Me.fgOfftake.Subtotal flexSTSum, 2, 7, , lngGrey, , True, ""
    Me.fgOfftake.Subtotal flexSTSum, 2, 8, , lngGrey, , True, ""
    
    Me.fgOfftake.Subtotal flexSTSum, 3, 7, , lngGrey, , True, ""
    Me.fgOfftake.Subtotal flexSTSum, 3, 8, , lngGrey, , True, ""
    
    Me.fgOfftake.Subtotal flexSTSum, 4, 7, , lngGrey, , True, ""
    Me.fgOfftake.Subtotal flexSTSum, 4, 8, , lngGrey, , True, ""
    
    Me.fgOfftake.Subtotal flexSTSum, -1, 7, , lngGrey, , True, "Всего"
    Me.fgOfftake.Subtotal flexSTSum, -1, 8, , lngGrey, , True, "Всего"
    
'    Dim I As Long
'    For I = 1 To fgOfftake.Rows - 1
'        fgOfftake.TextMatrix(I, 2) = Replace(fgOfftake.TextMatrix(I, 2), "Total ", "")
'    Next I
    
    fgOfftake.AutoSize 0, fgOfftake.cols - 1
    
'    Me.SB.Panels("offtmass").text = "Выборка: " & fgOfftake.TextMatrix(fgOfftake.Rows - 1, 6) & "  "
'    Me.SB.Panels("offtmass").AutoSize = sbrContents

    iLastOfftMode = 2

Exit Sub

loadOfftakeBet_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadOfftakeBet - Error"

End Sub


'/******************************************************************************
Public Sub loadOfftakeVed(bUseListPassivity As Boolean, Optional bNew As Boolean = True)
'/******************************************************************************

    On Error GoTo loadOfftakeVed_ERR

    Dim strSQL As String
    Dim i As Integer

    If bNew Then
    strSQL = "SELECT levName, catdefName, partdefName, posdefName, matName, sum(mass) as mass, sum(qty) as qty, matID, posdefID, catdefID, levnum as levID, null as prim "
    strSQL = strSQL & "FROM " & conn.strBaseName & ".dbo.goOfftVed5(" & lngCurCatListID
    Else
    strSQL = "SELECT levName, catdefName, partdefName, posdefName, matName, sum(mass) as mass, sum(qty) as qty, matID, null as prim "
    strSQL = strSQL & "FROM " & conn.strBaseName & ".dbo.goOfftVed3(" & lngCurCatListID
    End If
    
    strSQL = strSQL & "," & objs("catlist")
    
    strSQL = strSQL & ",1" ' количество 1
    
    strSQL = strSQL & ",0" ' параметр не участвует
    
    strSQL = strSQL & "," & CInt(bUseListPassivity) ' параметр - 0: принудительный расчет без таблиц для проверки массы, <>0: с учетом пассивности каждого списка
    
    If bNew Then
        strSQL = strSQL & "," & Abs(CInt(Me.tbOfftake.Buttons("Nulls").Value = tbrPressed)) '  "Nulls"
        strSQL = strSQL & ") group by levName, catdefName, partdefName, posdefName, matName, matID, posdefID, catdefID, levnum"
    Else
        strSQL = strSQL & ") group by levName, catdefName, partdefName, posdefName, matName, matID"
    End If
    
    
    Dim RS As New ADODB.Recordset
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    Set Me.fgOfftake.DataSource = RS
    
    RS.Close
    
    Set RS = Nothing
    
    iCurOfft = 1
    
    Me.fgOfftake.MergeCol(fgOfftake.ColIndex("levName")) = True
    Me.fgOfftake.MergeCol(fgOfftake.ColIndex("catdefName")) = True
    Me.fgOfftake.MergeCol(fgOfftake.ColIndex("partdefName")) = True
    Me.fgOfftake.MergeCol(fgOfftake.ColIndex("posdefName")) = True
    Me.fgOfftake.MergeCol(fgOfftake.ColIndex("matName")) = True
    
    Me.fgOfftake.ColFormat(fgOfftake.ColIndex("mass")) = sFmt1
    Me.fgOfftake.ColFormat(fgOfftake.ColIndex("qty")) = "0"
    
    If usrCurrent.strLogin <> "l_vibe" Then
        For i = 0 To fgOfftake.cols - 1
            If LCase(right(fgOfftake.ColKey(i), 2)) = "id" Then fgOfftake.ColHidden(i) = True
        Next i
    End If
    
    Me.fgOfftake.Subtotal flexSTSum, fgOfftake.ColIndex("catdefName"), fgOfftake.ColIndex("mass"), , lngGrey, , True, ""
    Me.fgOfftake.Subtotal flexSTSum, fgOfftake.ColIndex("partdefName"), fgOfftake.ColIndex("mass"), , lngGrey, , True, ""
    Me.fgOfftake.Subtotal flexSTSum, -1, fgOfftake.ColIndex("mass"), , lngGrey, , True, "Всего"
    
'    Dim I As Long
'    For I = 1 To fgOfftake.Rows - 1
'        fgOfftake.TextMatrix(I, 2) = Replace(fgOfftake.TextMatrix(I, 2), "Total ", "")
'    Next I
    
    fgOfftake.AutoSize 0, fgOfftake.cols - 1
    
    Me.SB.Panels("offtmass").text = "Выборка: " & Format(fgOfftake.TextMatrix(fgOfftake.Rows - 1, fgOfftake.ColIndex("mass")), sFmt1) & "  "
    Me.SB.Panels("offtmass").AutoSize = sbrContents
    
    iLastOfftMode = 1

Exit Sub

loadOfftakeVed_ERR:
    MsgBox "[" & err.Number & "] " & err.Description, vbInformation, "loadOfftakeVed - Error"

End Sub

'/******************************************************************************
Public Sub goCheckList(iOfftType As Integer)
'/******************************************************************************

    On Error GoTo goCheckList_ERR
    
    Dim Col As Long
    Dim Row As Long
    Dim i As Long
    
    Col = fgOfftake.Col
    Row = fgOfftake.Row
    
    Dim sFuncName As String
    Dim sName As String
    Dim ID As Long
    Dim relID As Long
    Dim strSQL As String
    Dim IDs(0 To 4) As Long
    
    Dim RS As ADODB.Recordset
    
    For i = 1 To Me.fgList.Rows - 1
        fgList.Cell(flexcpFontBold, i, fgList.ColIndex("Наименование")) = False
    Next i
    
    F1.SB.Panels("status").text = ""
    
    sName = Me.fgOfftake.TextMatrix(Row, Col)
    
'    Debug.Print fgOfftake.ColKey(Col)


    If iOfftType = 2 Then ' бетон
    
        If fgOfftake.ColKey(Col) = "class" Then
        
            ID = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("srtmID")))
        
            sFuncName = "findPosSrtm2"
        
        Else
            F1.SB.Panels("status").text = "Для этой части выборки обратный ход еще не сделан, обратитесь к разработчику"
            Exit Sub
        End If
        
        strSQL = "select * from " & sFuncName & "(" & ID & "," & lngCurCatListID & "," & -1 & ")"
    
    ElseIf iOfftType = 1 Then ' вед об раб
    
        strSQL = ""
    
        If fgOfftake.ColKey(Col) = "partdefName" Then '
            
            ID = selectLongFromBase(cn_data, "partdef", "partdefID", "partdefNameMulti", sName)
            
            sFuncName = "findPartDef"
            
        ElseIf fgOfftake.ColKey(Col) = "catdefName" Then '
        
            ID = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("catdefID")))
            
            sFuncName = "findCatDef"
            
        ElseIf fgOfftake.ColKey(Col) = "levName" Then '
        
            ID = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("levID")))
            
            sFuncName = "findCatLev"
        
        ElseIf fgOfftake.ColKey(Col) = "matName" Then '
        
            ID = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("matID")))
        
            sFuncName = "findMaterial"
        
        ElseIf fgOfftake.ColKey(Col) = "posdefName" Then '
        
            ID = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("posdefID")))
        
            sFuncName = "findPosdef"
        
        Else
        
            IDs(0) = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("posdefID")))
            IDs(1) = Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("matID")))
            IDs(2) = 100 ' Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("levID")))
            IDs(3) = 0 ' Val(Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("catdefID")))
            IDs(4) = selectLongFromBase(cn_data, "partdef", "partdefID", "partdefNameMulti", Me.fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("partdefName")))
            
            strSQL = "select * from findVedPos(" & IDs(0) & "," & IDs(1) & "," & IDs(2) & "," & IDs(3) & "," & IDs(4) & "," & lngCurCatListID & ")"
        
            'F1.SB.Panels("status").text = "Для этой части выборки обратный ход еще не сделан, обратитесь к разработчику"
            'Exit Sub
        End If
        
        If Len(strSQL) = 0 Then strSQL = "select * from " & sFuncName & "(" & ID & "," & lngCurCatListID & ")"
    
    ElseIf iOfftType = 0 Then
    
        IDs(0) = Val(fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("srtmID")))
        IDs(1) = Val(fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("matID")))
        IDs(2) = Val(fgOfftake.TextMatrix(Row, fgOfftake.ColIndex("partdefID")))
    
        sFuncName = "findPosSrtm3"
    
        strSQL = "select * from " & sFuncName & "(" & IDs(0) & "," & IDs(1) & "," & IDs(2) & "," & lngCurCatListID & ")"
        
    Else
    
        Exit Sub
    
    End If

    
    
    
    
obr:
    
    
    
    Set RS = New ADODB.Recordset
    
    RS.Open strSQL, cn_data, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then
        RS.MoveFirst
        Do
            relID = RS.fields("relID").Value
            
            For i = 1 To Me.fgList.Rows - 1
                If Val(Me.fgList.TextMatrix(i, fgList.ColIndex("relID"))) = relID Then
                    fgList.Cell(flexcpFontBold, i, fgList.ColIndex("Наименование")) = True
                End If
            Next i
            
            
            RS.MoveNext
        Loop Until RS.EOF
    End If
    
    RS.Close
    Set RS = Nothing



    
    
    If sFuncName = "findPartDef" And ID = 1 Then ' не определено
        strSQL = "select * from findPartDef(0," & lngCurCatListID & ")"
        GoTo obr
    End If
    
    

Exit Sub

goCheckList_ERR:
    F1.SB.Panels("status").text = "goCheckList" & "() - " & err.Description

End Sub

'/******************************************************************************
Private Function loadPositionsMenu2(pos As clsPos) As Boolean
'/******************************************************************************
    
    On Error GoTo loadPositionsMenu2_ERR
    
    Dim bSkip As Boolean
    Dim i As Integer
    
    For i = mnuPositionsMC.Count - 1 To 1 Step -1
        Unload mnuPositionsMC(i)
    Next i
    
    
    i = 0
    
    
    mnuPositions.Tag = 2
    
    
    Dim prop As clsProp
    
    For Each prop In globProps
        
        bSkip = False
        
        If pos.pos_props.existsProperty(prop.propName) Then
            If Len(pos.pos_props(prop.propName).sTableName) > 0 Then bSkip = True ' присутствует позиция из сортамента
            If pos.pos_props(prop.propName).bAddedByUser Then bSkip = False
        End If
        
        If (prop.bPosProp And bSkip = False) Then  ' есть в позициях и нет в сортаменте
            
            If i > 0 Then Load mnuPositionsMC(i)
            
            mnuPositionsMC(i).Visible = True
            mnuPositionsMC(i).Checked = pos.pos_props.existsProperty(prop.propName)
            mnuPositionsMC(i).Caption = prop.propDescr
            mnuPositionsMC(i).Tag = prop.propID
            
            i = i + 1
            
        End If
        
        
    Next prop
    
    
    loadPositionsMenu2 = True
    
    
    
    Exit Function
    
loadPositionsMenu2_ERR:
    F1.SB.Panels("status").text = "loadPositionsMenu2" & "() - " & err.Description
    
End Function


'/******************************************************************************
Private Sub mnuCatsTreeBeton_Click()
'/******************************************************************************
    
    On Error GoTo mnuCatsTreeBeton_Click_ERR
    
    Dim nd As Node
    Dim catID As Long
    Dim catposID As Long
    Dim cd As clsCatDef
    Dim sm As clsSrtm
    Dim cnt As Integer
    Dim i As Integer
    
    Set nd = tvCats.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    If LCase(left(nd.KEY, Len("catalog"))) = "catalog" Then
        catID = Val(right(nd.KEY, Len(nd.KEY) - Len("catalog")))
    Else
        Exit Sub
    End If
    
    
    
    '    Dim OFN As OPENFILENAME
    Dim strFileName As String
    Dim strFN As String
    Dim strLine As String
    Dim iMode As Integer
    Dim iLevel As Integer
    Dim bDel As Boolean
    '
    '    OFN.lStructSize = Len(OFN)
    '    OFN.hWndOwner = Me.hwnd
    '    OFN.hInstance = App.hInstance
    '    OFN.lpstrFilter = "TXT Files (*.txt)" + Chr$(0) + "*.txt" + Chr$(0) + "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    '    OFN.lpstrFile = Space$(254)
    '    OFN.nMaxFile = 255
    '
    '    OFN.lpstrFileTitle = Space$(254)
    '    OFN.nMaxFileTitle = 255
    '    OFN.lpstrInitialDir = GetSetting("Offtake2", "Size", "BetonReport", App.Path)
    '    OFN.lpstrTitle = "Отчет по бетону Speedikon"
    '    OFN.flags = 0
    '    Dim A
    '    A = GetOpenFileName(OFN)
    '    If (A) Then
    '        strFileName = Trim$(OFN.lpstrFile)
    '        If right(strFileName, 1) = Chr(0) Then strFileName = left(strFileName, Len(strFileName) - 1)
    '    Else
    '        Exit Sub
    '    End If
    '
    '    If Not FileExists(strFileName) Then Exit Sub
    
    
    Dim ff As New frmBeton
    
    ff.catID = catID
    
    Dim ct As clsCat
    Set ct = cCats(CStr(catID))
    
'    ff.Label2.Caption = Replace(ct.getCatPath(True), " - ", vbNewLine)
    ff.Label2.Caption = ct.getCatPath(True)
    
    ff.Show , Me
    

    
    
'    Dim cl As New colProp
'    Dim cs As New colSrtm
'
'
'    For Each sm In globSrtm
'        If sm.SRTM_STDPD.pdID = 96 And sm.srtm_props.existsProperty("speedmat") Then
'            cs.AddSimple sm
'        End If
'    Next sm
'
'
'
'    Dim fn As Integer
'    Dim ar() As String
'    Dim arr() As String
'    Dim catdefID As Long
'    Dim speedmatID As Long
'    Dim betthck As Double
'    Dim sechgt As Double
'    Dim secwdt As Double
'    Dim betrad As Double
'    Dim betvol As Double
'    Dim pr As clsProp
'    Dim strKey As String
'
'    fn = FreeFile
'
'    Open strFileName For Input As fn
'
'
'
'    If iMode = 1 Then ' speedikon
'
'
'        Dim iKeyCol As Integer
'        Dim iMatCol As Integer
'        Dim iWidCol As Integer
'        Dim iRadCol As Integer
'        Dim iVolCol As Integer
'        Dim iUseCol As Integer
'
'        Do
'
'            Line Input #fn, strLine
'            'beton;wall;floor: 1;part:40;element: 76;material:400;width:    300.0;netvol:      8.928;use: Interior...
'
'            cnt = 0
'
'            If Len(Trim(strLine)) = 0 Then GoTo cnt
'
'
'            If left(LCase(Trim(strLine)), 5) = "beton" Then
'
'                ar = Split(strLine, ";", , vbTextCompare)
'
'                '====================
'
'                iKeyCol = 1
'                iUseCol = -1
'
'                For I = 0 To UBound(ar)
'
'                    If left(ar(I), 8) = "material" Then iMatCol = I
'                    If left(ar(I), 5) = "width" Then iWidCol = I
'                    If left(ar(I), 6) = "radius" Then iRadCol = I
'                    If left(ar(I), 6) = "netvol" Then iVolCol = I
'                    If left(ar(I), 3) = "use" Then iUseCol = I
'
'                Next I
'
'                '====================
'
'                For Each cd In globCatDefs
'                    If iUseCol < 0 Then
'                        If cd.speedKey = ar(iKeyCol) Then
'                            catdefID = cd.cdID
'                            Exit For
'                        End If
'                    Else
'
'                        Dim s As String
'                        arr = Split(ar(iUseCol), ":")
'                        s = Trim(arr(1))
'
'                        If Len(cd.speedKey) > 0 Then
'                            If s Like cd.speedKey & "*" Then
'                                catdefID = cd.cdID
'                                Exit For
'                            End If
'                        End If
'                    End If
'
'                Next cd
'
'                speedmatID = 0
'                arr = Split(ar(iMatCol), ":")
'                For Each sm In cs
'
'                    If Val(Trim(arr(1))) = sm.srtm_props("speedmat").propValue Then
'                        speedmatID = sm.srtmID
'                        Exit For
'                    End If
'
'                Next sm
'
'                If speedmatID = 0 Then GoTo cnt
'
'                arr = Split(ar(iWidCol), ":")
'                betthck = getDbl(Trim(arr(1)))
'
'                arr = Split(ar(iVolCol), ":")
'                betvol = getDbl(Trim(arr(1)))
'
'                If UBound(ar) >= iRadCol Then
'                    arr = Split(ar(iRadCol), ":")
'                    betrad = getDbl(Trim(arr(1)))
'                End If
'
'                '====================
'
'                strKey = catdefID & "-" & speedmatID & "-" & Format(betthck, "0") & "-" & Format(betrad, "0")
'
'                If cl.existsProperty(strKey) Then
'                    Set pr = cl(strKey)
'                Else
'                    Set pr = New clsProp
'                    pr.muID = catdefID
'                    pr.muSrtmID = speedmatID
'                    pr.propK = betthck
'                    pr.iSortOrder = betrad
'                    pr.propID = iLevel
'                    cl.AddSimple pr, strKey
'                End If
'
'                pr.propValue = pr.propValue + betvol
'
'                Set pr = Nothing
'
'
'            ElseIf left(LCase(Trim(strLine)), 5) = "error" Then
'            Else
'            End If
'
'            cnt = cnt + 1
'
'cnt:
'        Loop Until EOF(fn)
'
'
'    ElseIf iMode = 2 Then ' aecosim
'
'        cnt = 0
'
'        Dim iTypeCol As Integer
'        Dim bSection As Boolean
'
'        Dim iWidthCol As Integer
'        Dim iSectCol As Integer
'        Dim iClassCol As Integer
'        Dim iCurvedCol As Integer
'        Dim iVolumeCol As Integer
'        Dim arf() As String
'        Dim A As Long
'
'        Line Input #fn, strLine ' ZB: External Walls,400.0mm,C50/60 XS1 G2400,,31.6890 m3,
'        Close fn
'
'        arf = Split(strLine, vbLf)
'
'
'
'
'        For A = 0 To UBound(arf)
'
'            strLine = arf(A)
'
'            ar = Split(strLine, ",", , vbTextCompare) 'WallType,Width,Class,Curved,Volume (Net),
'
'
'            If cnt = 0 Then ' первая строчка - названия столбцов
'
'                For I = 0 To UBound(ar)
'
'                    If InStr(LCase(ar(I)), "wall") > 0 Then iTypeCol = I
'                    If InStr(LCase(ar(I)), "slab") > 0 Then iTypeCol = I
'                    If InStr(LCase(ar(I)), "instance") > 0 Then
'                        iTypeCol = I ' beam & column
'                        bSection = True
'                    End If
'
'                    If ar(I) = "Width" Then iWidthCol = I
'                    If ar(I) = "Class" Then iClassCol = I
'                    If ar(I) = "Curved" Then iCurvedCol = I
'                    If InStr(LCase(ar(I)), "section") > 0 Then iSectCol = I
'
'                    If InStr(LCase(ar(I)), "volume") > 0 Then iVolumeCol = I
'
'                Next I
'            Else
'
'                '====================
'
'                For Each cd In globCatDefs
'                    If Len(cd.simKey) > 0 Then
'                        If ar(iTypeCol) Like "*" & cd.simKey & "*" Then
'                            catdefID = cd.cdID
'                            Exit For
'                        End If
'                    End If
'                Next cd
'
'                For Each sm In cs
'                    If Trim(ar(iClassCol)) = sm.srtmName Then
'                        speedmatID = sm.srtmID
'                        Exit For
'                    End If
'                Next sm
'
'                ' ===== SECTION =====
'                If bSection Then
'                    Dim ssec As String
'                    Dim arsec() As String
'                    ssec = LCase(ar(iSectCol))
'                    arsec = Split(ssec, "x")
'                    If UBound(arsec) = 0 Then
'                        secwdt = Val(arsec(0))
'                        sechgt = Val(arsec(0))
'                    ElseIf UBound(arsec) = 1 Then
'                        secwdt = Val(arsec(0))
'                        sechgt = Val(arsec(1))
'                        If secwdt > sechgt Then ' sechgt must be > secwdt
'                            Dim qwe As Double
'                            qwe = secwdt
'                            secwdt = sechgt
'                            sechgt = qwe
'                        End If
'                    Else
'                    End If
'                End If
'
'                ' ===== THICK =====
'                betthck = getDbl(Trim(ar(iWidthCol)))
'
'                '============
'                betrad = 0
'                If Len(Trim(ar(iCurvedCol))) > 0 Then
'                    If CBool(ar(iCurvedCol)) Then betrad = 1
'                End If
'
'                '============
'                betvol = getDbl(Trim(ar(iVolumeCol)))
'
'                '====================
'
'                If bSection Then
'                    strKey = catdefID & "-" & speedmatID & "-" & Format(sechgt, "0") & "-" & Format(secwdt, "0")
'                Else
'                    strKey = catdefID & "-" & speedmatID & "-" & Format(betthck, "0") & "-" & Format(betrad, "0")
'                End If
'
'                If cl.existsProperty(strKey) Then
'                    Set pr = cl(strKey)
'                Else
'                    Set pr = New clsProp
'                    pr.muID = catdefID
'                    pr.muSrtmID = speedmatID
'                    If bSection Then
'                        pr.propK = sechgt
'                        pr.iSortOrder = secwdt
'                    Else
'                        pr.propK = betthck
'                        pr.iSortOrder = betrad
'                    End If
'                    pr.propID = iLevel
'                    cl.AddSimple pr, strKey
'                End If
'
'                pr.propValue = pr.propValue + betvol
'
'                Set pr = Nothing
'
'            End If
'
'
'
'
'            cnt = cnt + 1
'
'        Next A
'
'    Else
'        Exit Sub
'    End If
    

    
    
    
    
    
    
    
    
    
'    MsgBox "Добавлено " & cnt & " позиций"
'
'
'    If cnt > 0 Then
'        tvParts_NodeClick nd
'        ctabCat.CurrTab = 3
'    End If
    
    
    Exit Sub
    
mnuCatsTreeBeton_Click_ERR:
    F1.SB.Panels("status").text = "mnuCatsTreeBeton_Click" & "() - " & err.Description
    
End Sub

'/******************************************************************************
Private Sub mnuPartApply_Click()
'/******************************************************************************

    On Error GoTo mnuPartApply_Click_ERR

    Dim cnt As Long

    Dim pdID As Long
    Dim ID As Long
    
    pdID = Val(mnuPartApply.Tag)
    
    Dim strIDs As String
    
    Dim nd As Node
    
    For Each nd In tvParts.Nodes
    
        If LCase(left(nd.KEY, Len("part"))) = "part" And nd.Image = "part0" And nd.Checked = True Then
        
            ID = Val(right(nd.KEY, Len(nd.KEY) - Len("part")))
            
            If Len(strIDs) > 0 Then strIDs = strIDs & ","
            
             strIDs = strIDs & ID
            
        End If
    Next
    
    
    If Len(strIDs) = 0 Then Exit Sub
    
    
    
    
    
    
    
    Dim RS As New ADODB.Recordset
    
    
    RS.Open "select * from part where partID in (" & strIDs & ")", cn_data, adOpenStatic, adLockBatchOptimistic
    
    If Not RS.EOF Then
    
        RS.MoveFirst
        Do
            If RS.fields("partStatusID").Value = pst.pstRazrabotka Then
                If RS.fields("partdefID").Value <> pdID Then
                    RS.fields("partdefID").Value = pdID
                    cnt = cnt + 1
                End If
                
            
            End If
            
            RS.MoveNext
        Loop Until RS.EOF
        
        If cnt > 0 Then RS.UpdateBatch
        
    
    End If
    

    RS.Close
    Set RS = Nothing
    
    F1.SB.Panels("status").text = "Изменено " & cnt & " изделий"


Exit Sub

mnuPartApply_Click_ERR:
    Set RS = Nothing
    F1.SB.Panels("status").text = "mnuPartApply_Click" & "() - " & err.Description

End Sub

Public Function wiseOpenModelDirect(strFileNetPath As String, strFileLocPath As String, strFTPmes As String) As Byte

On Error GoTo err

    If FileExists(strFileNetPath) Then

        If Not copyFile(strFileNetPath, strFileLocPath, True) Then

            err.Raise 100, , "не скопировать файл здания. Возможно, он в настоящее время открыт."

        End If
    Else
        err.Raise 100, , "нет доступа к файлу " & strFileNetPath
    End If


    wiseOpenModelDirect = 1


Exit Function
err:
    MsgBox "Ошибка при открытии файла - " & err.Description & vbNewLine & "Сообщение ошибки FTP: " & strFTPmes, vbCritical

End Function

Function DownloadFileHTTP(strURL As String, strDest As String) As Byte

    On Error GoTo err

'    strURL = "http://10.24.2.5/NavisworksFull/Hanhikivi/10GQA.nwd"
'    strURL = "http://" & strNavisFTPserv & "/" & strFtpFolder & "/" & projName & bldName & ".nwd"
    
    Dim WinHttpReq As Object
    Set WinHttpReq = CreateObject("Microsoft.XMLHTTP")
    WinHttpReq.Open "GET", strURL, False, "", ""
    WinHttpReq.send
    
    strURL = WinHttpReq.responseBody
    If WinHttpReq.Status = 200 Then
        Dim oStream As New ADODB.Stream
        oStream.Open
        oStream.Type = 1
        oStream.Write WinHttpReq.responseBody
        oStream.SaveToFile strDest, 2  ' 1 = no overwrite, 2 = overwrite
        oStream.Close
        Set oStream = Nothing
        DownloadFileHTTP = 1
    End If
    
    
    
    Exit Function
err:
    DownloadFileHTTP = 0

End Function

' NOT USING
Public Sub wiseOpenModel(n As Node, strFtpFolder As String, Optional bUseFtp As Boolean = False)

    On Error GoTo err

'    Dim hINetSession As Long
'    Dim hSession As Long
'    Dim strMes As String
'    Dim ret As Long
'    Dim strPathLoc As String
'    Dim bldName As String
'
'    bldName = n.text
'
'    strPathLoc = strNavisLocPath & bldName & ".nwd"
'
'
'    If n Is Nothing Then Exit Sub
'
'    If Dir(strNavisLocPath, vbDirectory) = "" Then MkDir strNavisLocPath
'
'    Dim ar() As String
'    Dim projName As String
'
'    ar = Split(n.FullPath, "\")
'    If UBound(ar) >= 0 Then
'        projName = ar(0)
'    End If
'
'
'    Dim bCopyOk As Byte
'
'    Me.MousePointer = 11
'
'
'
'    Dim strURL As String
'    strURL = "http://" & strNavisFTPserv & "/" & strFtpFolder & "/" & projName & "/" & bldName & ".nwd"
'
'
'    If FileExists(strPathLoc) Then
'        Kill strPathLoc
'    End If
'
'
'    If DownloadFileHTTP(strURL, strPathLoc) Then
'        bCopyOk = 1
'    Else
'    End If
    
    
    
'    If bCopyOk = 0 Then
'
'        hINetSession = InternetOpen("OftFTPClient", 0, vbNullString, vbNullString, 0)
'        If (hINetSession) Then
'            hSession = InternetConnect(hINetSession, strNavisFTPserv, strNavisFTPport, strNavisFTPuser, strNavisFTPpass, INTERNET_SERVICE_FTP, 0, 0)
'            If (hSession) Then
'                If FtpSetCurrentDirectory(hSession, strFtpFolder) Then
'                    If FtpSetCurrentDirectory(hSession, projName) Then
'                        bCopyOk = FtpGetFile(hSession, bldName & ".nwd", strPathLoc, False, 0, 1, 0)
'                        If bCopyOk = 0 Then strMes = "Не получить файл с FTP сервера"
'                    Else
'                        strMes = "Не открыть FTP директорию " & strNavisFTPbld & "/" & projName
'                    End If
'                Else
'                    strMes = "Не открыть FTP директорию " & strNavisFTPbld
'                End If
'                Call InternetCloseHandle(hSession)
'            Else
'                strMes = "Не открыть FTP подключение: " & strNavisFTPserv & ":" & strNavisFTPport
'            End If
'            Call InternetCloseHandle(hINetSession)
'        Else
'            strMes = "Не создать FTP подключение"
'        End If
'
'
'    End If ' bUseFtp



'    If bCopyOk = 0 Then
'
'        Dim strPathNet As String
'
'        strPathNet = strNavisPath & strFtpFolder & "/" & projName & "/" & bldName & ".nwd"
'
'        bCopyOk = wiseOpenModelDirect(strPathNet, strPathLoc, strMes)
'
'    End If
    
    
    
'    If bCopyOk Then
'
'        ret = ShellExecute(0, "open", strPathLoc, "", "", 1)
'
'        If ret <= 32 Then
'            MsgBox "Пhоблема с запуском Navisworks. Возможно он не установлен." & vbNewLine & _
'                "Сообщение в службу техподдержки об установке Navisworks сейчас будет сгенерировано автоматически."
'            ret = ShellExecute(0, "open", strNavisMsg, "", "", 1)
'        End If
'
'    Else
'
'        MsgBox "Проблемы при попытке получения файла " & bldName & ".nwd" & " с сервера..." & vbNewLine & _
'                "Попробовайте воспользоваться браузером для скачивания файла" & vbNewLine & _
'                "Директория Navisworks содержит модели строительно части" & vbNewLine & _
'                "Директория NavisworksFull содержит полные модели"
'
'
'        Call ShellExecute(0, "open", "http://" & strNavisFTPserv & "/", "", "", 1)
'
'
'    End If

    'Me.MousePointer = 0


Exit Sub
err:
    Me.MousePointer = 0
    MsgBox err.Description

End Sub



'/******************************************************************************
Private Sub tvWise_DblClick()
'/******************************************************************************

    On Error GoTo tvWise_DblClick_ERR
    
    Dim n As Node
    
    
    
'    If Len(Trim(strNavisPath)) = 0 Then Exit Sub
    
    Set n = Me.tvWise.SelectedItem
    
    If n Is Nothing Then Exit Sub
    
    'If Me.tbWise.Buttons("OpenModel").Value = tbrUnpressed Then Exit Sub
    
    
    If n.Image = "project" Then
    
'        Dim bCopyOk As Boolean
'        Dim iSize As Long
'        Dim ret As Long
'
'        Dim strNetPath As String
'        Dim strLocPath As String
'
'        strNetPath = strNavisPath & n.text & ".nwd"
'        strLocPath = strNavisLocPath & n.text & ".nwd"
'
'        If Not FileExists(strNetPath) Then
'            MsgBox ("Файл модели отсутствует на сервере" & vbNewLine & strNetPath)
'            Exit Sub
'        End If
'
'        iSize = FileLen(strNetPath) ' 500000000
'
'        If iSize > 200000000 Then
'            If MsgBox("Размер файла модели, который Вы хотите открыть, равен " & Format(iSize * 0.000001, "0") & " МБ." & vbNewLine & _
'                    "Копирование файла может занять несколько минут." & vbNewLine & "Продолжать?", vbOKCancel, "") = vbCancel Then Exit Sub
'        End If
'
'        Dim f As New frmNet
'        f.Show 0, Me
'
'        Me.MousePointer = 11
'
'        bCopyOk = wiseOpenModelDirect(strNetPath, strLocPath, "")
'
'        Unload f
'        Me.MousePointer = 0
'
'        If bCopyOk Then
'
'            ret = ShellExecute(0, "open", strLocPath, "", "", 1)
'
'            If ret <= 32 Then
'                MsgBox "Пhоблема с запуском Navisworks. Возможно он не установлен. Код ошибки: " & ret
'            End If
'
'        End If
        
        
        'If MsgBox("Сейчас Вам будет предложено скачать файл модели через браузер", vbOKCancel) = vbCancel Then Exit Sub
        
        'Call ShellExecute(0, "open", "http://" & strNavisFTPserv & "/" & n.text & ".nwd", "", "", 1)
    
    
    ElseIf n.Image = "building" Then
    
        
        'wiseOpenModel n, strNavisFTPbld
        
'        If Not bCopyOk Then
'
'            FileName = strNavisPath & projName & "/" & n.text & ".nwd"
'
'            If FileExists(FileName) Then
'
'                If copyFile(FileName, strNavisLocPath & n.text & ".nwd", True) Then
'
'                    bCopyOk = True
'
'                Else
'                    MsgBox "Невозможно скопировать файл здания. Возможно он сейчас открыт.", vbCritical
'
'                End If
'            Else
'                MsgBox "Нет доступа к файлу " & FileName, vbCritical
'            End If
'
'        End If
        
        
    End If
    
    



Exit Sub

tvWise_DblClick_ERR:
    Me.MousePointer = 0
    MsgBox err.Description, vbCritical, ""

End Sub

Private Sub tvWise_Expand(ByVal nd As MSComctlLib.Node)


    On Error GoTo tvWise_Expand_ERR


    If right(nd.Child.KEY, 1) = "+" Then
        tvWise.Visible = False
        tvWise.Nodes.Remove nd.Child.KEY
        
        If pwset.ispwdb Then
            loadTreeNodeWise nd
        Else
            loadTreeNodeTech nd
        End If
        
        tvWise.Visible = True
    End If

Exit Sub

tvWise_Expand_ERR:
    tvWise.Visible = True
    Me.SB.Panels("status").text = err.Description

End Sub

Private Sub tvWise_KeyDown_notusing(KeyCode As Integer, Shift As Integer)

    If tvWise.SelectedItem Is Nothing Then Exit Sub

    
    If KeyCode = 46 And pwset.canedit_tree Then


        If (tvWise.SelectedItem.Image = "folder" Or tvWise.SelectedItem.Image = "elem_1") And Val(tvWise.SelectedItem.Tag) > 0 Then
            mnuWiseTreeCmdInc.Tag = -1
            mnuWiseTreeCmdInc_Click
        ElseIf Not (tvWise.SelectedItem.parent.Image = "folder_out" Or tvWise.SelectedItem.parent.Image = "noelem") Then
            If tvWise.SelectedItem.Image = "folder_out" Or tvWise.SelectedItem.Image = "noelem" And Val(tvWise.SelectedItem.Tag) > 0 Then
                mnuWiseTreeCmdInc.Tag = 1
                mnuWiseTreeCmdInc_Click
            End If
        End If

    End If




End Sub

Private Sub tvWise_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)

On Error GoTo err

    
    
'    If Button = 2 And Me.tbWise.Buttons("OpenModel").Value = tbrPressed Then
'
'        Set tvWise.SelectedItem = tvWise.HitTest(X, Y)
'
'        If tvWise.SelectedItem Is Nothing Then Exit Sub
'
'        If tvWise.SelectedItem.Image = "project" Then
'            mnuWiseTreeOpenBld.Visible = False
'            mnuWiseTreeOpenTech.Visible = True
'            mnuWiseTreeOpenTech.Caption = "Скачать файл модели"
'            PopupMenu mnuWiseTree
'        ElseIf tvWise.SelectedItem.Image = "building" Then
'            mnuWiseTreeOpenBld.Visible = True
'            mnuWiseTreeOpenTech.Visible = True
'            mnuWiseTreeOpenTech.Caption = "Полная модель"
'            PopupMenu mnuWiseTree, , , , mnuWiseTreeOpenBld
'        End If
'
'    End If

    If Button = 2 And pwset.canedit_tree Then

        Set tvWise.SelectedItem = tvWise.HitTest(X, Y)

        If tvWise.SelectedItem Is Nothing Then Exit Sub
        
        If Val(tvWise.SelectedItem.Tag) <= 0 Then Exit Sub

        mnuWiseTreeCmdInc.Visible = False
        mnuWiseTreeCmdOut.Visible = False
        mnuWiseTreeCmdBack.Visible = False

        If tvWise.SelectedItem.Image = "folder" Then
            mnuWiseTreeCmdInc.Visible = True
            mnuWiseTreeCmdOut.Visible = True
        ElseIf tvWise.SelectedItem.Image = "elem_1" Then
            mnuWiseTreeCmdOut.Visible = True
        ElseIf tvWise.SelectedItem.Image = "elem_0" Then
            mnuWiseTreeCmdInc.Visible = True
        ElseIf tvWise.SelectedItem.Image = "folder_out" Then
            mnuWiseTreeCmdBack.Visible = True
        ElseIf tvWise.SelectedItem.Image = "folder_inc" Then
            mnuWiseTreeCmdBack.Visible = True
        ElseIf tvWise.SelectedItem.Image = "elem_out" Then
            mnuWiseTreeCmdBack.Visible = True
        ElseIf tvWise.SelectedItem.Image = "elem_inc" Then
            mnuWiseTreeCmdBack.Visible = True
        End If
        
        PopupMenu mnuWiseTree

    End If

Exit Sub
err:

End Sub

'/******************************************************************************
Private Sub tvWise_NodeClick(ByVal Node As MSComctlLib.Node)
'/******************************************************************************
    On Error GoTo tvWise_NodeClick_ERR

    Me.MousePointer = 11

    Dim cnpw As New ADODB.Connection

    cnpw.Open pwset.constring, pwset.login, pwset.login

    Dim i%
    If Not bWise Then
    For i = 0 To tbSimData.NumTabs - 1
        tbSimData.TabVisible(i) = False
    Next
    End If
    
    tbWise.Buttons("Excel").Enabled = False
    
    Dim strCnc As String
'    strCnc = Environ$("AEP_SAVRD_CONCRETE_DYNAMIC")

    If Not pwset.ispwdb Then
    
        tbSimData.CurrTab = 1
        tbSimData.TabVisible(1) = True
        loadTechData Node, cnpw
    
    Else
        If Node.Tag < pwset.glev Then ' ROOT LEVEL CONFIG !!!!!!!!!!!
            F1.SB.Panels("status").text = "level skipped, see config - xml parameter <glev>"
        ElseIf left(Node.KEY, 4) = "wise" Then
            tbSimData.CurrTab = 0
            tbSimData.TabVisible(0) = True
            loadWiseListNode Node, cnpw
            
        ElseIf left(Node.KEY, 4) = "cncf" Or left(Node.KEY, 4) = "clvl" And Val(strCnc) = 0 Then
            tbSimData.CurrTab = 1
            tbSimData.TabVisible(1) = True
            tbSimData.TabVisible(2) = True
            loadSimData Node, cnpw
            
    '    ElseIf left(Node.KEY, 4) = "embf" Then 'Or left(Node.KEY, 4) = "drsf"
    '        tbSimData.CurrTab = 1 '
    '        tbSimData.TabVisible(1) = True
    '        loadSimData Node, cnpw
            
        ElseIf left(Node.KEY, 4) = "room" Or left(Node.KEY, 4) = "cstr" Then ' ""
            tbSimData.CurrTab = 1
            tbSimData.TabVisible(1) = True
            tbSimData.TabCaption(1) = Node.text
            loadSimData Node, cnpw
        Else 'ez 2017-07-11 вывод данных по настройкам конфигурационного файла Offtake2.cfg
            loadSimDataTest Node, cnpw
        End If
    End If

    tbWise.Buttons("Update").Enabled = (tbSimData.CurrTab = 0)

    
    cnpw.Close
    Set cnpw = Nothing
    
    Me.MousePointer = 0
    
    Exit Sub

tvWise_NodeClick_ERR:
    Set cnpw = Nothing
    Me.MousePointer = 0
    F1.SB.Panels("status").text = "tvWise_NodeClick" & "() - " & err.Description

End Sub

Sub gogoRS_SPF(iStartRow As Integer, ByRef RS As ADODB.Recordset, ByRef oSheet As Object, ByRef n As Integer)
'Kulakov - add for Rooom to SPF (24/06/2017)
    Dim DataArray() As Variant
    ReDim DataArray(1 To scfgCmn.space_xls_rows, 0 To fgSim.cols - 1)
    Dim r As Integer
    Dim c As Integer
    Dim cc As Integer
    
    For r = 1 To scfgCmn.space_xls_rows
        
        If RS.EOF Then Exit For
        
        n = n + 1
        
        cc = 0
        
        For c = scfgCmn.space_xls_startcol To fgSim.cols - 1
            DataArray(r, cc) = RS.fields(c).Value
            If RS.fields(c).Name = "Number" Then DataArray(r, cc) = n
            cc = cc + 1
        Next c
    
        RS.MoveNext

    Next r
    
    If r > 1 Then oSheet.Range("B" & iStartRow).Resize(r - 1, cc).Value = DataArray
    
    


End Sub


'/******************************************************************************
Public Function getQueueCnt() As Long
'/******************************************************************************

    On Error GoTo getQueueCnt_ERR

    Dim cnpw As New ADODB.Connection
    cnpw.Open pwset.constring, pwset.login, pwset.login
    
    Dim RS As New ADODB.Recordset
    RS.Open "select count(*) as cnt from view_docdata where cs != last_state and counter < 6", cnpw, adOpenForwardOnly, adLockReadOnly
'    RS.Open "select count(*) as cnt from view_docdata where counter < 6", cnpw, adOpenForwardOnly, adLockReadOnly
    
    If Not RS.EOF Then getQueueCnt = RS.fields("cnt").Value
                
                
    RS.Close
    Set RS = Nothing
    
    cnpw.Close
    Set cnpw = Nothing


Exit Function

getQueueCnt_ERR:
    F1.SB.Panels("status").text = "getQueueCnt" & "() - " & err.Description

End Function


'/******************************************************************************
Public Function getSpecRowParams(ByRef dm As ModelReference, strRowTyoe As String, ByRef specconf As clsSCfg, ByRef sr As clsSpecRow) As Boolean
'/******************************************************************************
    
    On Error GoTo getSpecRowParams_ERR
    
    Dim i As Integer
    Dim lin As LineElement
    Dim txt As TextElement
    
    Dim tagname As TagElement
    Dim tagtype As TagElement
    Dim rowtype As TagElement
    

    
    Dim ts As TagSet
    Set ts = dm.DesignFile.TagSets("spec")
            
    Dim ele As Element
    
    Dim ptUpLoc As New clsSpecLine
    Dim ptDnLoc As New clsSpecLine
    
            
    Dim ee As ElementEnumerator
    Dim esc As ElementScanCriteria
    Set esc = New ElementScanCriteria
'    Set esc = GetObject(, "MicroStationDGN.ElementScanCriteria") ' New ElementScanCriteria
    esc.ExcludeNonGraphical
    
    
    Set ee = dm.Scan(esc)
    
    Dim bOk(1) As Boolean
    
    Do While ee.MoveNext
        
        Set ele = ee.Current
        
        If ele.HasAnyTags Then
            
            Set rowtype = ele.GetTag(ts, "rowtype")
            Set tagname = ele.GetTag(ts, "elemname")
            Set tagtype = ele.GetTag(ts, "elemtype")
            
            If strRowTyoe = rowtype.Value Then ' top, row, bottom
            
                If tagtype.Value = "point" And tagname.Value = "upleft" Then
                    Set lin = ele.AsLineElement
                    ptUpLoc.createFromMSLine lin, Nothing
                    bOk(0) = True
                End If
                
                If tagtype.Value = "point" And tagname.Value = "downleft" Then
                    Set lin = ele.AsLineElement
                    ptDnLoc.createFromMSLine lin, Nothing
                    bOk(1) = True
                End If
                
            
            End If
        End If
    Loop
    
    
    getSpecRowParams = bOk(0) And bOk(1)
    
    
    sr.dRowHeight = Abs(ptDnLoc.lin_endY - ptUpLoc.lin_endY)

    
    ee.Reset
    
    Dim ln As clsSpecLine
                
                
    Do While ee.MoveNext
        
        Set ele = ee.Current
        
        If ele.HasAnyTags Then
            
            Set rowtype = ele.GetTag(ts, "rowtype")
            Set tagname = ele.GetTag(ts, "elemname")
            Set tagtype = ele.GetTag(ts, "elemtype")
            
            
            If strRowTyoe = rowtype.Value Then ' top, row, bottom
                
                If tagtype.Value = "vertline" Then
                    
                    Set lin = ele.AsLineElement
                    
                    Set ln = New clsSpecLine
                    If ln.createFromMSLine(lin, sr, ptUpLoc) Then sr.vlines.Add ln
                    Set ln = Nothing
                    

                
                ElseIf tagtype.Value = "horline" Then
                    
                    Set lin = ele.AsLineElement
                    
                    Set ln = New clsSpecLine
                    If ln.createFromMSLine(lin, sr, ptUpLoc) Then sr.hlines.Add ln
                    Set ln = Nothing
                   

                
                ElseIf tagtype.Value = "field" Then
                
                    Dim st As New clsSpecText
                    
                    If tagname.Value = "num" Then st.bIsNumber = True
                    
                    st.sValueType = getTagElementValue(ts, ele, "valuetype")
                    st.sValueSource = getTagElementValue(ts, ele, "valuename")
                    st.sElemType = getTagElementValue(ts, ele, "elemname")
                    
                    st.sLevelDep = getTagElementValue(ts, ele, "leveldep")
                    st.sShiftDep = getTagElementValue(ts, ele, "shiftdep")
                    
                    If ele.Type = msdElementTypeText Then
                        st.createFromMSText ele, sr, ptUpLoc
                    ElseIf ele.Type = msdElementTypeTextNode Then
                        st.createFromMSTextNode ele, sr, ptUpLoc
                    End If
                    
                    'Debug.Print st.sValueType, st.sValueSource, st.sShiftDep, st.iMaxTextLength
                    
                    If st.sValueType = "sum" Then
                        Dim prp As New clsProp
                        spec.cSums.Add prp, st.sValueSource
                        Set prp = Nothing
                    End If
                    
                    If Not sr Is Nothing Then
                        sr.textfields.Add st
                    End If
                    
                    Set st = Nothing
                    
                ElseIf ele.IsTextElement Then
                
                    Dim stt As New clsSpecText
                
                    stt.createFromMSText ele, sr, ptUpLoc
                    
                    If Not sr Is Nothing Then
                        sr.textfields.Add stt
                    End If
                    
                    Set stt = Nothing
                    
                End If
                
            End If
            
        End If
        
    Loop
            
            

    
    
    
    
    Exit Function
    
getSpecRowParams_ERR:
    F1.SB.Panels("status").text = "getSpecRowParams" & "() - " & err.Description
    
End Function

'/******************************************************************************
Public Function getSpecParams(ByRef specconf As clsSCfg) As Boolean
'/******************************************************************************
    
    On Error GoTo goRoomSpec_ERR
    
    Dim i As Integer
    
    Dim msapp As Object
    
    
'                    scfg.iColCnt from dgn file
'                    scfg.spcfgHeadHeight from dgn file
'                    scfg.spcfgColWidths from dgn file
'                    scfg.spcfgRowHeight from dgn file
                        ' элементы таблицы + fields
    
    If Config.fgTabViews.exists(F1.tbSimData.CurrTab) Then
    
        Dim fgDyn As VSFlexGrid
        Set fgDyn = Config.fgTabs(F1.tbSimData.CurrTab)
        
        Dim oView As clsConfigSimView
        Set oView = Config.fgTabViews(F1.tbSimData.CurrTab)
        
        Set specconf = oView.MS_SpecConfig
        
        If FileExists(oView.MS_TemplatePath) Then
            
            Set msapp = getMS
            If msapp Is Nothing Then Exit Function

            
            Dim dfsource As DesignFile
            
            Set dfsource = msapp.OpenDesignFileForProgram(oView.MS_TemplatePath, True)
            
            If dfsource Is Nothing Then
                MsgBox "Error opening settings file '" & oView.MS_TemplatePath & "'"
                Exit Function
            End If
            
            
            Dim dm As ModelReference
            Set dm = dfsource.Models(oView.MS_SpecConfig.spcfgCapCell)
            
            
            ' get spec parameters
            '================
            Set specconf.rowTop = New clsSpecRow
            specconf.rowTop.bIsTop = True
            If getSpecRowParams(dm, "top", specconf, specconf.rowTop) Then
                specconf.spcfgHeadHeight = specconf.rowTop.dRowHeight
            Else
                Set specconf.rowTop = Nothing
            End If
            '================
            Set specconf.rowOrd = New clsSpecRow
            If getSpecRowParams(dm, "row", specconf, specconf.rowOrd) Then
                specconf.spcfgRowHeight = specconf.rowOrd.dRowHeight
                getSpecParams = True
            End If
            '================
            Set specconf.rowBot = New clsSpecRow
            specconf.rowBot.bIsBot = True
            If Not getSpecRowParams(dm, "bottom", specconf, specconf.rowBot) Then
                Set specconf.rowBot = Nothing
            End If
            '================
            
            
            
            
            '                MS_UpdateDependency
            dfsource.Close
            
            
            
        End If
        
    End If
    
    
    
    Set msapp = Nothing
    
    
    
    Exit Function
    
goRoomSpec_ERR:
    F1.SB.Panels("status").text = "goRoomSpec" & "() - " & err.Description
    Set msapp = Nothing
    
End Function


'/******************************************************************************
Public Sub reloadTech(Optional bBldFirst As Boolean = True)
'/******************************************************************************

    On Error GoTo reloadWise_ERR


    tvWise.Visible = False
    
    tvWise.Nodes.Clear


    Dim cn As New ADODB.Connection
    
    cn.Open pwset.constring, pwset.login, pwset.login

    Dim RS As New ADODB.Recordset
    Dim nd As Node
    Dim ndPlus As Node
    Dim strSQL As String
    
    If bBldFirst Then
    
        strSQL = "select distinct * from buildings order by bldCode"
        
        RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                Set nd = tvWise.Nodes.Add(, , RS.fields("bldCode").Value, RS.fields("bldCode").Value, "building")
    
                nd.Tag = -1 ' tree level
                nd.Expanded = isWiseNodeExpanded(nd.KEY)
    
                If nd.Expanded Then
                    loadTreeNodeTech nd
                Else
                    Call addTreeNode(tvWise, ndPlus, nd.KEY, tvwChild, nd.KEY & "+", "", "")
                End If
    
                RS.MoveNext
            Loop Until RS.EOF
    
        End If
    
    Else
        strSQL = "select top 1 * from elemtech order by path"
    
        RS.Open strSQL, cn, adOpenForwardOnly, adLockReadOnly
    
        If Not RS.EOF Then
            RS.MoveFirst
            Do
                Set nd = tvWise.Nodes.Add(, , RS.fields("path").Value, RS.fields("name").Value, "project")
    
                nd.Tag = 0 ' tree level
                nd.Expanded = isWiseNodeExpanded(nd.KEY)
    
                If nd.Expanded Then
                    loadTreeNodeTech nd
                Else
                    Call addTreeNode(tvWise, ndPlus, nd.KEY, tvwChild, nd.KEY & "+", "", "")
                End If
    
                RS.MoveNext
            Loop Until RS.EOF
    
        End If
    End If
    
    
    
    tvWise.Visible = True

    RS.Close
    Set RS = Nothing

    cn.Close
    Set cn = Nothing

Exit Sub

reloadWise_ERR:
    F1.SB.Panels("status").text = "reloadWise" & "() - " & err.Description
    tvWise.Visible = True

End Sub


'/******************************************************************************
Public Sub loadTreeNodeTech(nd As Node, Optional bLoadExpandSettings As Boolean = True, Optional bBldFirst As Boolean = True)
'/******************************************************************************


    On Error GoTo loadTreeNodeWise_ERR ' ec

    Dim RS As New ADODB.Recordset
    Dim RSS As New ADODB.Recordset
    Dim projID As Long
    Dim ndNew As Node
    Dim ndPlus As Node
    Dim strSQL As String
    Dim strguids As String
    Dim nRoom As Node
    Dim cnsim As ADODB.Connection
    Dim i As Integer
    Dim strBldCode As String

    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    

    Dim iLev As Integer
    iLev = nd.Tag
    
    Dim strKey As String
    
    If bBldFirst Then

        strBldCode = getPathPartial(nd.KEY, 0, 0)
        strKey = getPathPartial(nd.KEY, 1)
        
        If Len(strKey) = 0 Then
            strSQL = "select * from " & strTechViewName & " where bldCode = '" & strBldCode & "' and ilevel in (0,1) order by path"
        Else
            strSQL = "select * from " & strTechViewName & " where bldCode = '" & strBldCode & "' and path like '" & strKey & "\%' and ilevel in (" & iLev + 1 & "," & iLev + 2 & ") order by path"
        End If
        
    Else
        strKey = nd.KEY
        strSQL = "select * from " & strTechViewName & " where path like '" & strKey & "\%' and ilevel in (" & iLev + 1 & "," & iLev + 2 & ") order by path"
    End If
    
    ' в селекте где есть LIKE by path нужен обязательно \ ("\%'), чтобы он искал только входящие в него эелементы
    
    RS.Open strSQL, cnpw, adOpenForwardOnly, adLockReadOnly


    Dim bChack As Boolean

    If Not RS.EOF Then
        RS.MoveFirst
        Do
            
            Dim iLevel As Integer
            Dim strPath As String
            Dim strPathRep As String
            Dim strName As String
            
            strPath = RS![path]
            strPathRep = strPath
            strName = RS![Name]
            iLevel = Val(RS![iLevel])
            'strBldCode = RS![bldCode] & ""
            
'            If Len(strBldCode) = 5 Then
'                strPathRep = Replace(strPath, "HnhNPP\1", "HnhNPP\" & strBldCode, , , vbTextCompare)
'                If StrComp(strPathRep, strPath) And iLevel = 1 Then
'                    strName = strBldCode
'                End If
'            End If

            If bBldFirst Then
                strPathRep = strBldCode & "\" & strPath
            End If
            
            
            If iLevel = iLev + 1 Then
            
                Dim ing As String
                If RS![eltype] = 66 Then
                    ing = "folder"
                Else
                    ing = "elem_1"
               End If
            
            
                If addTreeNode(tvWise, ndNew, nd.KEY, tvwChild, strPathRep, strName, ing, , , , "\") Then
                
                    ndNew.Tag = iLevel ' tree level
                    
                    ndNew.Expanded = isWiseNodeExpanded(ndNew.KEY)
                    
                    If RS.fields("filter").Value > 0 Then ndNew.bOld = True
                    
                    'If RS.fields("fout").Value > 0 Or (ndNew.parent.Image = "folder_out" Or ndNew.parent.Image = "elem_out") Then
                    If RS.fields("fout").Value > 0 Then
                        If RS.fields("eltype").Value = 66 Then ndNew.Image = "folder_out"
                        If RS.fields("eltype").Value = 2 Then ndNew.Image = "elem_out"
                    End If
                    
                    If RS.fields("finc").Value > 0 Then
                        If RS.fields("eltype").Value = 66 Then ndNew.Image = "folder_inc"
                        If RS.fields("eltype").Value = 2 Then ndNew.Image = "elem_inc"
                    End If
                    
                    If RS.fields("fexist").Value = 0 Then
                        ndNew.Image = "elem_0"
                    End If
                    
                    
                    
                    bChack = True

                Else
                    Debug.Print ""
                    
                End If
                
            ElseIf iLevel = iLev + 2 And bChack Then ' если есть подпапки
            
                If ndNew.Expanded Then
                    loadTreeNodeTech ndNew
                Else
                    Call addTreeNode(tvWise, ndPlus, ndNew.KEY, tvwChild, ndNew.KEY & "+", "", "")
                End If
                
                bChack = False
            
            End If
                
                
            RS.MoveNext
        Loop Until RS.EOF
    End If


    RS.Close
    
    Set RS = Nothing

    cnpw.Close
    
    Set cnpw = Nothing
    
    
Exit Sub

loadTreeNodeWise_ERR:
    Set RS = Nothing
    Set cnpw = Nothing
    tvWise.Visible = True
    F1.SB.Panels("status").text = "loadTreeNodeWise" & "() - " & err.Description
    Resume




End Sub


Public Function getPathPartial(strPath As String, iFrs As Integer, Optional iScn As Integer = -1) As String


    If Trim(strPath) = "" Then Exit Function

    Dim strPart As String

    strPart = ""
    
    Dim ar() As String
    ar = Split(strPath, "\")
    
    If iScn = -1 Or iScn > UBound(ar) Then iScn = UBound(ar)
    If iScn = -2 Then iScn = UBound(ar) - 1
    If iFrs < LBound(ar) Then iFrs = LBound(ar)
    
    If iFrs < 0 Then Exit Function
    If iScn < 0 Then Exit Function
    
    Dim i As Integer
    
    For i = iFrs To iScn
        If Len(strPart) > 0 Then strPart = strPart & "\"
        strPart = strPart & ar(i)
    Next i
        
    getPathPartial = strPart


End Function



Public Sub loadTechData(nd As Node, ByRef cnpw As ADODB.Connection, Optional bBldFirst As Boolean = True)
    
    Dim RS As New ADODB.Recordset
    
    Dim strSQL As String
    Dim strKey As String
    Dim strBld As String
    
    If bBldFirst Then
        strBld = getPathPartial(nd.KEY, 0, 0) ' здание
        strKey = getPathPartial(nd.KEY, 1) ' выкусываем здание
    Else
        strKey = nd.KEY
    End If
    
    
    If Len(strKey) = 0 Then
        strSQL = "select"
    Else
        strSQL = "select ex,"
    End If
    
    strSQL = strSQL & " contname, safetyclass, section, isc from getContainers('" & strKey & "','" & strBld & "')"
    strSQL = strSQL & " group by ex, contname, safetyclass, section, isc"
    strSQL = strSQL & " order by contname, section, isc"
    
    RS.Open strSQL, cnpw, adOpenStatic, adLockReadOnly
    
    Set fgSim.DataSource = RS
    
    fgSim.ColHidden(fgSim.ColIndex("isc")) = True
    
    If Len(strKey) > 0 Then
        fgSim.ColDataType(0) = flexDTBoolean
        fgSim.Editable = flexEDKbdMouse
    Else
        fgSim.ColDataType(0) = flexDTString
        fgSim.Editable = flexEDNone
    End If
    
    fgSim.Tag = strBld & "|||" & strKey ' like in database table, no building



End Sub


Public Sub loadReinPositions(ByRef FG As VSFlexGrid, strImpKey As String)

    On Error GoTo err

    Dim i As Long
    Dim p As clsPos
    Dim prop As clsProp
    Dim Clmn As clsObj
    Dim cnt As Long
    Dim start_row As Long
    Dim head_row As Long
    
    Dim posnum As Long
    Dim srtmID As Long
    Dim dLength As Double


    Dim im As clsObj
    Set im = getColItem(imps, strImpKey)
    
    If im Is Nothing Then
        MsgBox "Что-то пошло не так", vbOKOnly, ""
        Exit Sub
    End If
    
    start_row = im.props("startrow").propValue
    head_row = start_row - 1
    
    ' индексы столюцов
    For i = 0 To FG.cols - 1
    
        Set Clmn = im.getKinder(FG.TextMatrix(head_row, i))
        If Not Clmn Is Nothing Then
            If Clmn.props.existsProperty("index") Then
                Clmn.props("index").propValue = i
            Else
                Call Clmn.props.AddProp("index", i)
            End If
        End If
    
    Next i
    
    
    Dim bReinCarUpdate As Boolean
    bReinCarUpdate = CBool(im.props("update").propValue)


    If bReinCarUpdate = False Then

        If colRein2.Count > 1 Then
            MsgBox "Каталог уже содержит позиции. Перед импортом они должны быть удалены", vbOKOnly, ""
            Exit Sub
        End If
    
    
        fgCatParts.Rows = 1
        
        Set colRein2 = New Collection
        
       
        
        For i = start_row To FG.Rows - 1
        
            posnum = 0
            srtmID = 0
        
            Set Clmn = im.getKinder("posnum")
            If Not Clmn Is Nothing Then posnum = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            Set Clmn = im.getKinder("srtmID")
            If Not Clmn Is Nothing Then srtmID = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            If posnum > 0 And srtmID > 0 Then
                cnt = cnt + 1
            End If
        
        Next i
        
        
        PB.Min = 0
        PB.Max = cnt
        
        cnt = 0
        
        For i = start_row To FG.Rows - 1
        
            posnum = 0
            srtmID = 0
        
            Set Clmn = im.getKinder("posnum")
            If Not Clmn Is Nothing Then posnum = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            Set Clmn = im.getKinder("srtmID")
            If Not Clmn Is Nothing Then srtmID = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            If posnum > 0 And srtmID > 0 Then
            
                Set p = New clsPos
                Set p.parentPart = New clsPart
                p.parentPart.partName = CStr(posnum)
                p.parentPart.catID = lngCurCatID
                p.setSrtm srtmID, False, True
                
                Set Clmn = im.getKinder("length")
                If Not Clmn Is Nothing Then
                    dLength = getDbl(FG.TextMatrix(i, Clmn.props("index").propValue))
                    If p.pos_props.existsProperty("length") Then
                        Set prop = p.pos_props("length")
                        prop.setValue dLength
                        Set prop = Nothing
                    End If
                End If
                
                Set Clmn = im.getKinder("quantity")
                If Not Clmn Is Nothing Then p.setQuantity getDbl(FG.TextMatrix(i, Clmn.props("index").propValue)), False
                
                Set Clmn = im.getKinder("sketch")
                If Not Clmn Is Nothing Then p.bSketch = CBool(Val(FG.TextMatrix(i, Clmn.props("index").propValue)))
                
                Set Clmn = im.getKinder("posnote")
                If Not Clmn Is Nothing Then p.posNote = Trim(FG.TextMatrix(i, Clmn.props("index").propValue))
                
                If im.props.existsProperty("matID") Then
                    p.setMaterial Val(im.props("matID").propValue), False
                End If
                
                p.savePos
                
                colRein2.Add p
                Set p = Nothing
                
                cnt = cnt + 1
                PB.Value = cnt
                PB.Refresh
                
            End If
        
            
        
        Next i
        
        PB.Value = 0
    
    Else ' bReinCarUpdate = true
    
        start_row = im.props("startrow").propValue
        
        For i = start_row To FG.Rows - 1
        
            posnum = 0
        
            Set Clmn = im.getKinder("posnum")
            If Not Clmn Is Nothing Then posnum = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            'Set Clmn = im.kinder("srtmID")
            'srtmID = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            If posnum > 0 Then
                cnt = cnt + 1
            End If
        
        Next i
    
    
        PB.Min = 0
        PB.Max = cnt
        
        cnt = 0
        
        For i = start_row To FG.Rows - 1
        
            posnum = 0
        
            Set Clmn = im.getKinder("posnum")
            If Not Clmn Is Nothing Then posnum = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            'Set Clmn = im.kinder("srtmID")
            'srtmID = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
            
            If posnum > 0 Then
            
                If getReinPos(posnum, p) Then
                
                    Set Clmn = im.getKinder("srtmID")
                    If Not Clmn Is Nothing Then
                        srtmID = Val(FG.TextMatrix(i, Clmn.props("index").propValue))
                        p.setSrtm srtmID, False, True
                    End If
                
                    Set Clmn = im.getKinder("length")
                    If Not Clmn Is Nothing Then
                        dLength = getDbl(FG.TextMatrix(i, Clmn.props("index").propValue))
                        If p.pos_props.existsProperty("length") Then
                            Set prop = p.pos_props("length")
                            prop.setValue dLength
                            Set prop = Nothing
                        End If
                    End If
                    
                    Set Clmn = im.getKinder("quantity")
                    If Not Clmn Is Nothing Then p.setQuantity getDbl(FG.TextMatrix(i, Clmn.props("index").propValue)), False
                    
                    Set Clmn = im.getKinder("sketch")
                    If Not Clmn Is Nothing Then p.bSketch = CBool(FG.TextMatrix(i, Clmn.props("index").propValue))
                    
                    'If im.props.existsProperty("matID") Then
                    '    p.setMaterial Val(im.props("matID").propValue), False
                    'End If
                
                    Set Clmn = im.getKinder("posnote")
                    If Not Clmn Is Nothing Then p.posNote = Trim(FG.TextMatrix(i, Clmn.props("index").propValue))
                
                End If
                
                If p.savePos Then
                    fgCatParts.RowData(posnum) = p.posNote
                End If
                
                Set p = Nothing
                
                cnt = cnt + 1
                PB.Value = cnt
                PB.Refresh
                
            End If
        
            
        
        Next i
        
        PB.Value = 0
    
    
    
    
    
    End If
    
    Exit Sub
    
err:
    F1.SB.Panels("status").text = "loadReinPositions" & "() - " & err.Description
    PB.Value = 0

End Sub

Private Sub mnuWiseTreeNodeReload_Click() ' NU

    On Error GoTo err
    
    Dim nd As Node
    
    Set nd = tvWise.SelectedItem
    
    If nd Is Nothing Then Exit Sub
    
    
    If nd.children > 0 Then
    
        tvRemoveChildNodes nd
        
        If pwset.ispwdb Then
            loadTreeNodeWise nd
        Else
            loadTreeNodeTech nd
        End If
        
    End If
    

    Exit Sub
err:


End Sub




Private Sub mnuWiseTreeCmdInc_Click()

On Error GoTo err

    If tvWise.SelectedItem Is Nothing Then Exit Sub
    If pwset Is Nothing Then Exit Sub

    Dim strSQL As String
    Dim i As Integer
    Dim strKey As String
    Dim strBldCode As String
    'Dim iLev As Integer
    Dim nd As Node
    Dim ndd As Node
    Dim ndx As Node
    Dim bldID As Long
    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    

    Set nd = tvWise.SelectedItem
    'iLev = nd.Tag
    
    

    strBldCode = getPathPartial(nd.KEY, 0, 0)
    strKey = getPathPartial(nd.KEY, 1)
    bldID = selectLongFromBase(cnpw, "buildings", "bldID", "bldCode", strBldCode)
    
    
    
    
    If bldID > 0 And Len(strKey) > 0 Then
    
    
        Dim RS As New ADODB.Recordset
        RS.Open "select * from filter_inc where bldID = " & bldID & " and fnPath = '" & strKey & "'", cnpw, adOpenStatic, adLockOptimistic
    
        If RS.EOF Then
    
            RS.AddNew
            RS.fields("bldID").Value = bldID
            RS.fields("fnPath").Value = strKey
            RS.fields("fnOnBy").Value = usrCurrent.strLogin
            RS.Update
        
        Else
            RS.MoveFirst
            RS.fields("ftOutBy").Value = usrCurrent.strLogin
            RS.Update
        End If
            
        RS.Close
        Set RS = Nothing
            
        'Call writeOperationS(operModify, "catalog", ID, "статус " & stts(st)) ' ID?
            
        If nd.Image = "folder" Then
            
            nd.Image = "folder_inc"
            
        ElseIf nd.Image = "elem_0" Then
            
            nd.Image = "elem_inc"
            
        End If
        
        
        
    
    
    End If
        
    cnpw.Close
    Set cnpw = Nothing
        

    Exit Sub
err:

    Set cnpw = Nothing


End Sub



Private Sub mnuWiseTreeCmdOut_Click()

On Error GoTo err

    If tvWise.SelectedItem Is Nothing Then Exit Sub
    If pwset Is Nothing Then Exit Sub

    Dim strSQL As String
    Dim i As Integer
    Dim strKey As String
    Dim strBldCode As String
    'Dim iLev As Integer
    Dim nd As Node
    Dim ndd As Node
    Dim ndx As Node
    Dim bldID As Long
    
    Dim cnpw As New ADODB.Connection
    
    cnpw.Open pwset.constring, pwset.login, pwset.login
    

    Set nd = tvWise.SelectedItem
    'iLev = nd.Tag
    
    

    strBldCode = getPathPartial(nd.KEY, 0, 0)
    strKey = getPathPartial(nd.KEY, 1)
    bldID = selectLongFromBase(cnpw, "buildings", "bldID", "bldCode", strBldCode)
    
    
    
    
    If bldID > 0 And Len(strKey) > 0 Then
    
    
        Dim RS As New ADODB.Recordset
        RS.Open "select * from filter_out where bldID = " & bldID & " and ftPath = '" & strKey & "'", cnpw, adOpenStatic, adLockOptimistic
        
        If RS.EOF Then
    
            RS.AddNew
            RS.fields("bldID").Value = bldID
            RS.fields("ftPath").Value = strKey
            RS.fields("ftOutBy").Value = usrCurrent.strLogin
            RS.Update
        
        Else
            RS.MoveFirst
            RS.fields("ftOutBy").Value = usrCurrent.strLogin
            RS.Update
        End If
            
        RS.Close
        Set RS = Nothing
        
        'Call writeOperationS(operModify, "catalog", ID, "статус " & stts(st)) ' ID?
        
        If nd.Image = "folder" Then
            
            nd.Image = "folder_out"
            
        ElseIf nd.Image = "elem_1" Then
            
            nd.Image = "elem_out"
            
        End If
        
            
    
    End If
        
    cnpw.Close
    Set cnpw = Nothing
        

    Exit Sub
err:

    Set cnpw = Nothing


End Sub


